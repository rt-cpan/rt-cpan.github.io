<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #1894 for libwww-perl: LWP::UserAgent can&#39;t reach https sites via proxy</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #1894 for libwww-perl: LWP::UserAgent can&#39;t reach https sites via proxy</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do I…?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=libwww-perl">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=libwww-perl">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=libwww-perl">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=libwww-perl">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libwww-perl">libwww-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">1894</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=libwww-perl">libwww-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
chs [...] newmail.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
DDUMONT [...] cpan.org

<br />
JGMYERS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-18330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.66    </td>
  </tr>
  <tr id="CF-18331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
6.06    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




libwww-perl-6.03-httpsproxy.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/989257/514980/libwww-perl-6.03-httpsproxy.patch">
Tue Oct 18 18:24:00 2011 (3.5k) by JGMYERS [...] cpan.org
</a>
</font></li>
</ul>


LWP-Protocol-https-6.02-httpsproxy.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/989257/514982/LWP-Protocol-https-6.02-httpsproxy.patch">
Tue Oct 18 18:24:00 2011 (1.3k) by JGMYERS [...] cpan.org
</a>
</font></li>
</ul>


lwp-ssl.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/823490/426650/lwp-ssl.patch">
Fri Aug 27 21:38:48 2010 (564b) by EWILHELM [...] cpan.org
</a>
</font></li>
</ul>


Net-HTTP-6.01-httpsproxy.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/989257/514981/Net-HTTP-6.01-httpsproxy.patch">
Tue Oct 18 18:24:00 2011 (1001b) by JGMYERS [...] cpan.org
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/871441/451297/signature.asc">
Mon Dec 20 15:39:41 2010 (900b) by dkg [...] fifthhorseman.net
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=1894">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-75712" href="/Public/Bug/Display.html?id=1894#txn-75712">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;27&nbsp;17:06:18&nbsp;2002</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> LWP::UserAgent can&#39;t reach https sites via proxy</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/75712/7204/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/7204">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 558b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Win98 + ActivePerl
libwwwperl 5.66
Crypt::SSLeay;

If now proxy connect to site successful, if proxy - no connection ti site.

#!/usr/bin/perl

use strict;

use LWP::UserAgent;
use HTTP::Request;

my $url = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.mts.ru/&#39;">https://www.mts.ru/&#39;</a></span>;
my $ua = new LWP::UserAgent;

$ua-&gt;proxy&#40;[&#39;http&#39;,&#39;https&#39;],&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://youproxy.com/&#39;&#41;">http://youproxy.com/&#39;&#41;</a></span>;

my $req = new HTTP::Request&#40;&#39;GET&#39;=&gt;$url&#41;;

my $res = $ua-&gt;request&#40;$req&#41;;


    if &#40;$res-&gt;is_success&#41; {
                open&#40;OUT,&#34;&gt; page.html&#34;&#41;;
       print OUT $res-&gt;content;
                close OUT;
    } else {
       print &#34;Error: &#34; . $res-&gt;status_line . &#34;\n&#34;;
    }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-75713" href="/Public/Bug/Display.html?id=1894#txn-75713">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;28&nbsp;11:30:27&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> sam [...] att.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/75713/26894/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/26894">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 806b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I get a negotiation failure on Solaris.  Have you found any work-around
or fix?
res.status_line=500 SSL negotiation failed:
--
thanks,
sam berman



[guest - Fri Dec 27 17:06:18 2002]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Win98 + ActivePerl
&gt; libwwwperl 5.66
&gt; Crypt::SSLeay;
&gt; 
&gt; If now proxy connect to site successful, if proxy - no connection ti site.
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use strict;
&gt; 
&gt; use LWP::UserAgent;
&gt; use HTTP::Request;
&gt; 
&gt; my $url = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.mts.ru/&#39;">https://www.mts.ru/&#39;</a></span>;
&gt; my $ua = new LWP::UserAgent;
&gt; 
&gt; $ua-&gt;proxy&#40;[&#39;http&#39;,&#39;https&#39;],&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://youproxy.com/&#39;&#41;">http://youproxy.com/&#39;&#41;</a></span>;
&gt; 
&gt; my $req = new HTTP::Request&#40;&#39;GET&#39;=&gt;$url&#41;;
&gt; 
&gt; my $res = $ua-&gt;request&#40;$req&#41;;
&gt; 
&gt; 
&gt;     if &#40;$res-&gt;is_success&#41; {
&gt;               open&#40;OUT,&#34;&gt; page.html&#34;&#41;;
&gt;        print OUT $res-&gt;content;
&gt;               close OUT;
&gt;     } else {
&gt;        print &#34;Error: &#34; . $res-&gt;status_line . &#34;\n&#34;;
&gt;     }
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-75714" href="/Public/Bug/Display.html?id=1894#txn-75714">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;29&nbsp;01:15:28&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/75714/26917/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/26917">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 156b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Tue Dec 28 11:30:27 2004]:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I get a negotiation failure on Solaris.  Have you found any 
</div>work-around
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; or fix?
</div>
No, may be your will more lucky.:&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-75715" href="/Public/Bug/Display.html?id=1894#txn-75715">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;13&nbsp;03:14:38&nbsp;2005</span>
    <span class="description">BULB [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bulb [...] ucw.cz</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/75715/28255/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/28255">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have found a workaround for this problem. 
 
The problem is, that when libwww sees proxy settings for https, it 
tries to handle it like it handles http proxy, which is bogus. I mean, 
when setting is: 
https =&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://proxy">https://proxy</a></span>:port 
it attempts a SSL connection to proxy:port and passes GET &lt;URI&gt; request 
there. The proxy usualy does not accept SSL connections. 
When the setting is: 
https =&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://proxy.port">http://proxy.port</a></span> 
it attempts a normal conenction to proxy:port, but it still passes GET 
&lt;URI&gt; request instead of a CONNECT request. Proxies generaly refuse to 
answer GET https://&lt;anything&gt; 
 
The workaround is, that the Crypt::SSLeay can do proxy connections on 
it&#39;s own. When it sees $ENV{https_proxy}, it issues the right CONNECT 
request to the proxy. Thus the workaround is to have https_proxy set, 
but for LWP it must be explicitely turned on. Ie: 
$ua-&gt;proxy&#40;https =&gt; undef&#41;; 
Then it works. 
 
It&#39;s not a good solution obviously. A good solution should be possible 
along the lines of: 
1&#41; LWP::Protocol::https shall override the request method. It should 
put the $proxy somewhere safe and dispatch to the parent with $proxy = 
undef 
2&#41; LWP::Protocol::https shall override _new_socket method. If there is 
no saved $proxy, it should dispatch to the parent. If there is, it 
should create a CONNECT request, dispatch it and have the socket 
upgraded to SSL. 
I have not, however, succeeded in actualy implementing it in the first 
take and, upon finding the workaround, gave up on further attempts. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-199154" href="/Public/Bug/Display.html?id=1894#txn-199154">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;24&nbsp;10:26:38&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jason Smith</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/199154/73904/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/73904">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 635b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 13 03:14:38 2005, BULB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have found a workaround for this problem. 
&gt;  
&gt; The workaround is, that the Crypt::SSLeay can do proxy connections on 
&gt; it&#39;s own. When it sees $ENV{https_proxy}, it issues the right CONNECT 
&gt; request to the proxy. Thus the workaround is to have https_proxy set, 
&gt; but for LWP it must be explicitely turned on. Ie: 
&gt; $ua-&gt;proxy&#40;https =&gt; undef&#41;; 
&gt; Then it works. 
</div>
Can this workaround at least be added to the pod documentation until a
correct fix is found?  It took a lot of debugging and searching for me
to figure out why it was not working and find this bug report.

Thanks,
~Jason
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-199155" href="/Public/Bug/Display.html?id=1894#txn-199155">#</a>      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;24&nbsp;10:26:40&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-294685" href="/Public/Bug/Display.html?id=1894#txn-294685">#</a>      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;01&nbsp;04:23:27&nbsp;2007</span>
    <span class="description">lars.eggert [...] gmx.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> lars.eggert [...] gmx.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/294685/133238/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/133238">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 294b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed May 24 10:26:38 2006, guest wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can this workaround at least be added to the pod documentation until a
&gt; correct fix is found?  It took a lot of debugging and searching for me
&gt; to figure out why it was not working and find this bug report.
</div>
FYI, the workaround doesn&#39;t work for me.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-823490" href="/Public/Bug/Display.html?id=1894#txn-823490">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;27&nbsp;21:38:47&nbsp;2010</span>
    <span class="description">EWILHELM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/823490/426649/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/426649">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 300b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

This patch at least localizes the $ENV{HTTPS_PROXY} variable by 
stripping and storing the proxy parameter on the way into 
LWP::Protocol::http::request&#40;&#41;, which is where the aforementioned 
bogusness happens.

So now you can have two user agents running through different proxies.

Thanks,
Eric
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> lwp-ssl.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/823490/426650/lwp-ssl.patch">Download lwp-ssl.patch</a><br />
<span class="downloadcontenttype">text/x-diff 564b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/lib/LWP/Protocol/https.pm b/lib/LWP/Protocol/https.pm
index 367c8f7..62cee8f 100644
--- a/lib/LWP/Protocol/https.pm
+++ b/lib/LWP/Protocol/https.pm
@@ -41,6 +41,15 @@ sub _get_sock_info
     }
 }
 
+sub request
+{
+    my $self = shift;
+    # if proxy option is set, remove it and temporarily stuff in the env
+    local $ENV{HTTPS_PROXY} = defined&#40;$_[1]&#41; ? $_[1] : $ENV{HTTPS_PROXY};
+    $_[1]=undef;
+    return $self-&gt;SUPER::request&#40;@_&#41;;
+}
+
 #-----------------------------------------------------------
 package LWP::Protocol::https::Socket;
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-849419" href="/Public/Bug/Display.html?id=1894#txn-849419">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;31&nbsp;03:55:09&nbsp;2010</span>
    <span class="description">oleg [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/849419/439750/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/439750">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 533b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Птн Авг 27 21:38:47 2010, EWILHELM писал:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; This patch at least localizes the $ENV{HTTPS_PROXY} variable by 
&gt; stripping and storing the proxy parameter on the way into 
&gt; LWP::Protocol::http::request&#40;&#41;, which is where the aforementioned 
&gt; bogusness happens.
&gt; 
&gt; So now you can have two user agents running through different proxies.
&gt; 
&gt; Thanks,
&gt; Eric
</div>
This patch works for me. I think this is the best way to get it worked 
for now without much modifications. Please include it to the mainstream 
or comment.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-871441" href="/Public/Bug/Display.html?id=1894#txn-871441">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;20&nbsp;15:39:41&nbsp;2010</span>
    <span class="description">dkg [...] fifthhorseman.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #1894] this is debian bug #503440</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 20 Dec 2010 15:39:26 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-libwww-perl [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Daniel Kahn Gillmor &lt;dkg [...] fifthhorseman.net&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/871441/451296/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/451296">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 405b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">rt.cpan.org&#39;s #1894 is the root cause of <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/503440">http://bugs.debian.org/503440</a></span>
which is causing problems for gpgkeys_hkpms &#40;from msva-perl&#41; when the
user has --keyserver-option http-proxy set:

 <span class="clickylink"><a target="new" rel="nofollow" href="https://labs.riseup.net/code/issues/2677">https://labs.riseup.net/code/issues/2677</a></span>

It&#39;s also referenced here:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.annocpan.org/~GAAS/libwww-perl-5.834/lib/LWP/UserAgent.pm#note_751">http://www.annocpan.org/~GAAS/libwww-perl-5.834/lib/LWP/UserAgent.pm#note_751</a></span>

any suggestions for how/when it might be resolved upstream?

        --dkg
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/871441/451297/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 900b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-989257" href="/Public/Bug/Display.html?id=1894#txn-989257">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;18:24:00&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/989257/514979/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/514979">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 108b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Proposed fix in the attached three patches. The fix affects this module,
LWP-Protocol-https, and Net-HTTP.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libwww-perl-6.03-httpsproxy.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/989257/514980/libwww-perl-6.03-httpsproxy.patch">Download libwww-perl-6.03-httpsproxy.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in .: blib
diff -ru ../libwww-perl-6.03-0orig/lib/LWP/Protocol/http.pm ./lib/LWP/Protocol/http.pm
--- ../libwww-perl-6.03-0orig/lib/LWP/Protocol/http.pm	2011-04-17 04:45:47.000000000 -0700
+++ ./lib/LWP/Protocol/http.pm	2011-10-18 15:08:58.000000000 -0700
@@ -15,7 +15,7 @@
 
 sub _new_socket
 {
-    my&#40;$self, $host, $port, $timeout&#41; = @_;
+    my&#40;$self, $host, $port, $timeout, $connectproxy&#41; = @_;
     my $conn_cache = $self-&gt;{ua}{conn_cache};
     if &#40;$conn_cache&#41; {
 	if &#40;my $sock = $conn_cache-&gt;withdraw&#40;$self-&gt;socket_type, &#34;$host:$port&#34;&#41;&#41; {
@@ -35,6 +35,7 @@
 					Timeout  =&gt; $timeout,
 					KeepAlive =&gt; !!$conn_cache,
 					SendTE    =&gt; 1,
+					ConnectProxy =&gt; $connectproxy,
 					$self-&gt;_extra_sock_opts&#40;$host, $port&#41;,
 				       &#41;;
 
@@ -88,18 +89,26 @@
 
 sub _fixup_header
 {
-    my&#40;$self, $h, $url, $proxy&#41; = @_;
+    my&#40;$self, $h, $url, $proxy, $method&#41; = @_;
 
     # Extract &#39;Host&#39; header
     my $hhost = $url-&gt;authority;
     if &#40;$hhost =~ s/^&#40;[^\@]*&#41;\@//&#41; {  # get rid of potential &#34;user:pass@&#34;
-	# add authorization header if we need them.  HTTP URLs do
-	# not really support specification of user and password, but
-	# we allow it.
-	if &#40;defined&#40;$1&#41; &#38;&#38; not $h-&gt;header&#40;&#39;Authorization&#39;&#41;&#41; {
-	    require URI::Escape;
-	    $h-&gt;authorization_basic&#40;map URI::Escape::uri_unescape&#40;$_&#41;,
-				    split&#40;&#34;:&#34;, $1, 2&#41;&#41;;
+	if &#40;$method eq &#34;CONNECT&#34;&#41; {
+	    if &#40;defined&#40;$1&#41;&#41; {
+		require URI::Escape;
+		$h-&gt;proxy_authorization_basic&#40;map URI::Escape::uri_unescape&#40;$_&#41;,
+					      split&#40;&#34;:&#34;, $1, 2&#41;&#41;;
+	    }
+	} else {
+	    # add authorization header if we need them.  HTTP URLs do
+	    # not really support specification of user and password, but
+	    # we allow it.
+	    if &#40;defined&#40;$1&#41; &#38;&#38; not $h-&gt;header&#40;&#39;Authorization&#39;&#41;&#41; {
+		require URI::Escape;
+		$h-&gt;authorization_basic&#40;map URI::Escape::uri_unescape&#40;$_&#41;,
+					split&#40;&#34;:&#34;, $1, 2&#41;&#41;;
+	    }
 	}
     }
     $h-&gt;init_header&#40;&#39;Host&#39; =&gt; $hhost&#41;;
@@ -140,9 +149,13 @@
     }
 
     my $url = $request-&gt;uri;
-    my&#40;$host, $port, $fullpath&#41;;
+    my&#40;$host, $port, $fullpath, $connectproxy&#41;;
 
     # Check if we&#39;re proxy&#39;ing
+    if &#40;defined $proxy &#38;&#38; $url-&gt;scheme&#40;&#41; eq &#39;https&#39;&#41; {
+	$connectproxy = $proxy;
+	undef $proxy;
+    }
     if &#40;defined $proxy&#41; {
 	# $proxy is an URL to an HTTP server which will proxy this request
 	$host = $proxy-&gt;host;
@@ -156,10 +169,11 @@
 	$port = $url-&gt;port;
 	$fullpath = $url-&gt;path_query;
 	$fullpath = &#34;/$fullpath&#34; unless $fullpath =~ m,^/,;
-    }
+ 	$fullpath =~ s,^/,, if $method eq &#34;CONNECT&#34;;
+     }
 
     # connect to remote site
-    my $socket = $self-&gt;_new_socket&#40;$host, $port, $timeout&#41;;
+    my $socket = $self-&gt;_new_socket&#40;$host, $port, $timeout, $connectproxy&#41;;
 
     my $http_version = &#34;&#34;;
     if &#40;my $proto = $request-&gt;protocol&#41; {
@@ -174,7 +188,7 @@
 
     my @h;
     my $request_headers = $request-&gt;headers-&gt;clone;
-    $self-&gt;_fixup_header&#40;$request_headers, $url, $proxy&#41;;
+    $self-&gt;_fixup_header&#40;$request_headers, $url, $proxy, $method&#41;;
 
     $request_headers-&gt;scan&#40;sub {
 			       my&#40;$k, $v&#41; = @_;
Only in ./lib/LWP/Protocol: http.pm~
Only in ./lib/LWP/Protocol: http.pm.rej
diff -ru ../libwww-perl-6.03-0orig/lib/LWP/UserAgent.pm ./lib/LWP/UserAgent.pm
--- ../libwww-perl-6.03-0orig/lib/LWP/UserAgent.pm	2011-10-15 06:30:33.000000000 -0700
+++ ./lib/LWP/UserAgent.pm	2011-10-18 15:06:59.000000000 -0700
@@ -166,7 +166,7 @@
 
         # Locate protocol to use
         my $proxy = $request-&gt;{proxy};
-        if &#40;$proxy&#41; {
+        if &#40;$proxy &#38;&#38; $scheme ne &#39;https&#39;&#41; {
             $scheme = $proxy-&gt;scheme;
         }
 
Only in ./lib/LWP: UserAgent.pm~
Only in .: Makefile
Only in .: pm_to_blib
Only in ./t: CAN_TALK_TO_OURSELF
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-HTTP-6.01-httpsproxy.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/989257/514981/Net-HTTP-6.01-httpsproxy.patch">Download Net-HTTP-6.01-httpsproxy.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1001b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in .: blib
diff -ru ../Net-HTTP-6.01-0orig/lib/Net/HTTP/Methods.pm ./lib/Net/HTTP/Methods.pm
--- ../Net-HTTP-6.01-0orig/lib/Net/HTTP/Methods.pm	2011-03-20 04:36:18.000000000 -0700
+++ ./lib/Net/HTTP/Methods.pm	2011-10-18 12:24:35.000000000 -0700
@@ -135,6 +135,7 @@
     push&#40;@{${*$self}{&#39;http_request_method&#39;}}, $method&#41;;
     my $ver = ${*$self}{&#39;http_version&#39;};
     my $peer_ver = ${*$self}{&#39;http_peer_http_version&#39;} || &#34;1.0&#34;;
+    $ver = &#39;1.0&#39; if $method eq &#39;CONNECT&#39;;
 
     my @h;
     my @connection;
@@ -162,7 +163,7 @@
     if &#40;$given{te}&#41; {
 	push&#40;@connection, &#34;TE&#34;&#41; unless grep lc&#40;$_&#41; eq &#34;te&#34;, @connection;
     }
-    elsif &#40;$self-&gt;send_te &#38;&#38; gunzip_ok&#40;&#41;&#41; {
+    elsif &#40;$self-&gt;send_te &#38;&#38; gunzip_ok&#40;&#41; &#38;&#38; $method ne &#39;CONNECT&#39;&#41; {
 	# gzip is less wanted since the IO::Uncompress::Gunzip interface for
 	# it does not really allow chunked decoding to take place easily.
 	push&#40;@h2, &#34;TE: deflate,gzip;q=0.3&#34;&#41;;
Only in ./lib/Net/HTTP: Methods.pm~
Only in .: Makefile
Only in .: pm_to_blib
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> LWP-Protocol-https-6.02-httpsproxy.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/989257/514982/LWP-Protocol-https-6.02-httpsproxy.patch">Download LWP-Protocol-https-6.02-httpsproxy.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in .: blib
diff -ru ../LWP-Protocol-https-6.02-0orig/lib/LWP/Protocol/https.pm ./lib/LWP/Protocol/https.pm
--- ../LWP-Protocol-https-6.02-0orig/lib/LWP/Protocol/https.pm	2011-03-27 04:54:01.000000000 -0700
+++ ./lib/LWP/Protocol/https.pm	2011-10-18 15:03:21.000000000 -0700
@@ -43,7 +43,7 @@
 	}
     }
     $self-&gt;{ssl_opts} = \%ssl_opts;
-    return &#40;%ssl_opts, $self-&gt;SUPER::_extra_sock_opts&#41;;
+    return &#40;%ssl_opts, UA =&gt; $self-&gt;{ua}, $self-&gt;SUPER::_extra_sock_opts&#41;;
 }
 
 sub _check_sock
@@ -86,6 +86,27 @@
 require Net::HTTPS;
 our @ISA = qw&#40;Net::HTTPS LWP::Protocol::http::SocketMethods&#41;;
 
+sub new
+{
+    my $self = shift&#40;&#41;;
+    my $arg_hash = { @_ };
+
+    my $proxy = delete $arg_hash-&gt;{ConnectProxy};
+    my $ua = delete $arg_hash-&gt;{UA};
+
+    if &#40;$proxy&#41; {
+	my $uri = $proxy-&gt;clone;
+	$uri-&gt;path&#40;$arg_hash-&gt;{PeerAddr}.&#39;:&#39;.$arg_hash-&gt;{PeerPort}&#41;;
+	my $response = $ua-&gt;request&#40;HTTP::Request-&gt;new&#40;&#39;CONNECT&#39;, $uri&#41;&#41;;
+	
+	return $self-&gt;error&#40;$response-&gt;status_line&#41; if $response-&gt;is_error;
+	eval { $response-&gt;{client_socket}-&gt;blocking&#40;1&#41;; };
+	return $self-&gt;start_SSL&#40;$response-&gt;{client_socket}, $arg_hash&#41;;
+    }
+
+    return $self-&gt;SUPER::new&#40;%$arg_hash&#41;;
+}
+
 1;
 
 __END__
Only in ./lib/LWP/Protocol: https.pm~
Only in .: Makefile
Only in ../LWP-Protocol-https-6.02-0orig: Makefile.old
Only in .: pm_to_blib
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-989260" href="/Public/Bug/Display.html?id=1894#txn-989260">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;18:26:33&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Cc JGMYERS added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-989261" href="/Public/Bug/Display.html?id=1894#txn-989261">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;18&nbsp;19:20:49&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/989261/514985/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/514985">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 272b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Arguably when the method is &#34;CONNECT&#34;,
Net::HTTP::Methods::format_request should filter out more of the passed
in headers, at least ignoring Connection and TE. We do want it to use
any passed-in User-Agent.

If requested by the maintainer, I will update the proposed fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013109" href="/Public/Bug/Display.html?id=1894#txn-1013109">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;06:59:36&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013109/528169/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528169">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Oct 18 18:24:00 2011, JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Proposed fix in the attached three patches. The fix affects this module,
&gt; LWP-Protocol-https, and Net-HTTP.
&gt; 
</div>

After going thru your solution I did the necessary changes in the perl
modules but the https requests are failing via proxy. My http request
runs fine with proxy even when the direct line is connected the https
code works fine it is only via proxy that it starts giving problems. 

This is what comes to https::new function
DEBUGing: https.pm
called:LWP::Protocol::https::Socket|PeerAddr|secure.lme.com|PeerPort|443|LocalAddr||Proto|tcp|Timeout|30|KeepAlive||SendTE|1|ConnectProxy|<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>|SSL_verifycn_scheme|www|SSL_ca_file|/usr/lib/perl5/site_perl/5.14.2/Mozilla/CA/cacert.pem|SSL_verify_mode|1|UA|LWP::UserAgent=HASH&#40;0x786360&#41;

The request object dumped out is :
$VAR1 = bless&#40; {
                 &#39;_content&#39; =&gt; &#39;&#39;,
                 &#39;_uri&#39; =&gt; bless&#40; do{\&#40;my $o =
&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080/secure.lme.com:443&#39;&#41;">http://196.1.1.14:8080/secure.lme.com:443&#39;&#41;</a></span>}, &#39;URI::        http&#39; &#41;,
                 &#39;_headers&#39; =&gt; bless&#40; {}, &#39;HTTP::Headers&#39; &#41;,
                 &#39;_method&#39; =&gt; &#39;CONNECT&#39;
               }, &#39;HTTP::Request&#39; &#41;;

Prepare request <span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080/secure.lme.com:443">http://196.1.1.14:8080/secure.lme.com:443</a></span>
LWP::UserAgent=HASH&#40;0x786360&#41;|request_preprepare|HTTP::Request=HASH&#40;0xf64b40&#41;
LWP::UserAgent=HASH&#40;0x786360&#41;|request_prepare|HTTP::Request=HASH&#40;0xf64b40&#41;
LWP::UserAgent=HASH&#40;0x786360&#41;|request_send|HTTP::Request=HASH&#40;0xf64b40&#41;
http request
LWP::Protocol::http=HASH&#40;0xdd50d8&#41;|HTTP::Request=HASH&#40;0xf64b40&#41;|<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>|||30
debugging: http.pm
called:LWP::Protocol::http=HASH&#40;0xdd50d8&#41;|196.1.1.14|8080|30|
LWP::UserAgent=HASH&#40;0x786360&#41;|response_done|HTTP::Response=HASH&#40;0x11c76b0&#41;

Response object dumped :

$VAR1 = bless&#40; {
                 &#39;_protocol&#39; =&gt; &#39;HTTP/1.0&#39;,
                 &#39;_content&#39; =&gt; &#39;&#39;,
                 &#39;client_socket&#39; =&gt; bless&#40; \*Symbol::GEN0,
&#39;LWP::Protocol::http::Socket&#39; &#41;,
                 &#39;_rc&#39; =&gt; &#39;403&#39;,
                 &#39;_headers&#39; =&gt; bless&#40; {
                 &#39;proxy-connection&#39; =&gt; &#39;close&#39;,
                 &#39;date&#39; =&gt; &#39;Mon, 19 Dec 2011 10:41:28 GMT&#39;,
                 &#39;x-squid-error&#39; =&gt; &#39;ERR_ACCESS_DENIED 0&#39;,
                 &#39;client-peer&#39; =&gt; &#39;196.1.1.14:8080&#39;,
                 &#39;content-length&#39; =&gt; &#39;445&#39;,
                 &#39;client-date&#39; =&gt; &#39;Mon, 19 Dec 2011 10:41:28 GMT&#39;,
                 &#39;via&#39; =&gt; &#39;1.0 none.local:3128 &#40;squid&#41;&#39;,
                 &#39;content-type&#39; =&gt; &#39;text/html&#39;,
                 &#39;server&#39; =&gt; &#39;squid&#39;,
                 &#39;x-cache&#39; =&gt; &#39;MISS from none.local&#39;,
                 &#39;x-cache-lookup&#39; =&gt; &#39;NONE from none.local:3128&#39;,
                 &#39;expires&#39; =&gt; &#39;Mon, 19 Dec 2011 10:41:28 GMT&#39;
                 }, &#39;HTTP::Headers&#39; &#41;,
                 &#39;_msg&#39; =&gt; &#39;Forbidden&#39;,
                 &#39;_request&#39; =&gt; bless&#40; {
                  &#39;_content&#39; =&gt; &#39;&#39;,
                  &#39;_uri&#39; =&gt; bless&#40; do{\&#40;my $o =
&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080/secure.lme.com:443&#39;&#41;">http://196.1.1.14:8080/secure.lme.com:443&#39;&#41;</a></span>}, &#39;URI::http&#39; &#41;,
                  &#39;_headers&#39; =&gt; bless&#40; {
                                        &#39;user-agent&#39; =&gt; &#39;MSIE/6.0&#39;
                                        }, &#39;HTTP::Headers&#39; &#41;,
                                        &#39;_method&#39; =&gt; &#39;CONNECT&#39;,
                                        &#39;_uri_canonical&#39; =&gt;
$VAR1-&gt;{&#39;_request&#39;}{&#39;_uri&#39;},
                                        &#39;proxy&#39; =&gt; bless&#40; do{\&#40;my $o =
&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;&#41;}, &#39;        URI::http&#39; &#41;
                                      }, &#39;HTTP::Request&#39; &#41;
               }, &#39;HTTP::Response&#39; &#41;;


Any further inputs in this regards shall be helpfull
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013182" href="/Public/Bug/Display.html?id=1894#txn-1013182">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;13:34:42&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013182/528213/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528213">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 321b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 19 06:59:36 2011, Yusuf wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After going thru your solution I did the necessary changes in the perl
&gt; modules but the https requests are failing via proxy.
</div>
I don&#39;t see the &#34;ConnectProxy&#34; and &#34;UA&#34; parameters added by the patch to
LWP-Protocol-https, so it doesn&#39;t look like you applied all of the patches.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013296" href="/Public/Bug/Display.html?id=1894#txn-1013296">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;01:50:40&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013296/528269/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528269">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 19 13:34:42 2011, JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Dec 19 06:59:36 2011, Yusuf wrote:
<div class="message-stanza open">&gt; &gt; After going thru your solution I did the necessary changes in the perl
&gt; &gt; modules but the https requests are failing via proxy.
</div>&gt; 
&gt; I don&#39;t see the &#34;ConnectProxy&#34; and &#34;UA&#34; parameters added by the patch to
&gt; LWP-Protocol-https, so it doesn&#39;t look like you applied all of the
</div>patches.


Thanks for your reply.

As suggested I have applied the following patches in the order given
below.

  1. lwp-ssl.patch
  2. Net-HTTP-6.01-httpsproxy.patch
  3. LWP-Protocol-https-6.02-httpsproxy.patch
  4. libwww-perl-6.03-httpsproxy.patch

But still I am not able to connect via proxy.

Thanks for your valued help.

Regards,




My test program is:

      #! /opt/bin/perl5 -w

      use LWP::UserAgent;
      $ua = LWP::UserAgent-&gt;new&#40;&#41;;
      $ua-&gt;proxy&#40;[&#39;https&#39;, &#39;http&#39;, &#39;ftp&#39;] =&gt; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#34;&#41;;
      $ua-&gt;protocols_allowed&#40;[ &#39;https&#39;, &#39;http&#39;, &#39;ftp&#39; ]&#41;;

      $req = new HTTP::Request &#39;GET&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.cmie.biz/updates/af/&#39;">https://www.cmie.biz/updates/af/&#39;</a></span>;
      $req-&gt;header&#40;&#39;Accept&#39; =&gt; &#39;*/*&#39;&#41;;

      # send request
      $res = $ua-&gt;request&#40;$req&#41;;

      # check the outcome
      if &#40;$res-&gt;is_success&#41; {
         print $res-&gt;content;
      } else {
         print &#34;Error: &#34; . $res-&gt;status_line . &#34;\n&#34;;
      }

Debug outputs:

Case 1: Comment subroutine &#34;_request&#34; in LWP/Protocol/https.pm
        with the following patched &#34;new&#34; in LWP/Protocol/https.pm &#40;patch
        is to enable debugging&#41;.
        Note: Squid Proxy Server reports the following in its access_log

            &#34;1324363103.407      0 196.1.1.28 TCP_DENIED/403 778 CONNECT
            196.1.1.14:8080 - NONE/- text/html&#34;

        sub new
        {
            my $self = shift&#40;&#41;;
            my $arg_hash = { @_ };

            print STDERR &#34;x&#34; x 80, &#34;\n&#34;;
            print STDERR &#34;LWP::Protocol::https new -&gt; value of arg_hash
            before assigning=&#34;, Dumper&#40;$arg_hash&#41;, &#34;\n&#34;;
            print STDERR &#34;x&#34; x 80, &#34;\n&#34;;

            my $proxy = delete $arg_hash-&gt;{ConnectProxy};
            my $ua = delete $arg_hash-&gt;{UA};

            if &#40;$proxy&#41; {
                my $uri = $proxy-&gt;clone;
                print STDERR &#34;uri=&#34;, Dumper&#40;$uri&#41;, &#34;\n&#34;;
                print STDERR &#34;x&#34; x 80, &#34;\n&#34;;
                $uri-&gt;path&#40;$arg_hash-&gt;{PeerAddr}.&#39;:&#39;.$arg_hash-&gt;{PeerPort}&#41;;
                my $response = $ua-&gt;request&#40;HTTP::Request-&gt;new&#40;&#39;CONNECT&#39;,
                $uri&#41;&#41;;

                return $self-&gt;error&#40;$response-&gt;status_line&#41; if
                $response-&gt;is_error;
                eval { $response-&gt;{client_socket}-&gt;blocking&#40;1&#41;; };
                return $self-&gt;start_SSL&#40;$response-&gt;{client_socket},
                $arg_hash&#41;;
            }
            return $self-&gt;SUPER::new&#40;%$arg_hash&#41;;
        }

Output of Case 1:

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
LWP::Protocol::https new -&gt; value of arg_hash before assigning=$VAR1 = {
          &#39;Proto&#39; =&gt; &#39;tcp&#39;,
          &#39;SSL_verifycn_scheme&#39; =&gt; &#39;www&#39;,
          &#39;PeerPort&#39; =&gt; 443,
          &#39;SSL_ca_path&#39; =&gt; &#39;/etc/ssl/certs&#39;,
          &#39;SSL_verify_mode&#39; =&gt; 1,
          &#39;LocalAddr&#39; =&gt; undef,
          &#39;KeepAlive&#39; =&gt; &#39;&#39;,
          &#39;PeerAddr&#39; =&gt; &#39;www.cmie.biz&#39;,
          &#39;SendTE&#39; =&gt; 1,
          &#39;UA&#39; =&gt; bless&#40; {
                           &#39;max_redirect&#39; =&gt; 7,
                           &#39;ssl_opts&#39; =&gt; {
                                           &#39;verify_hostname&#39; =&gt; 1
                                         },
                           &#39;protocols_forbidden&#39; =&gt; undef,
                           &#39;show_progress&#39; =&gt; undef,
                           &#39;handlers&#39; =&gt; {
                                           &#39;response_header&#39; =&gt; bless&#40; [
                                {
                                &#39;owner&#39; =&gt; &#39;LWP::UserAgent::parse_head&#39;,
                                &#39;callback&#39; =&gt; sub { &#34;DUMMY&#34; },
                                &#39;m_media_type&#39; =&gt; &#39;html&#39;,
                                &#39;line&#39; =&gt; &#39;LWP/UserAgent.pm:658&#39;
                                }
                                ], &#39;HTTP::Config&#39; &#41;,
                            &#39;request_preprepare&#39; =&gt; bless&#40; [
                            {
                                &#39;owner&#39; =&gt; &#39;LWP::UserAgent::proxy&#39;,
                                &#39;callback&#39; =&gt; sub { &#34;DUMMY&#34; },
                                &#39;line&#39; =&gt; &#39;LWP/UserAgent.pm:966&#39;
                            }
                            ], &#39;HTTP::Config&#39; &#41;
                                         },
                           &#39;no_proxy&#39; =&gt; [],
                           &#39;protocols_allowed&#39; =&gt; [
                                                    &#39;https&#39;,
                                                    &#39;http&#39;,
                                                    &#39;ftp&#39;
                                                  ],
                           &#39;local_address&#39; =&gt; undef,
                           &#39;use_eval&#39; =&gt; 1,
                           &#39;requests_redirectable&#39; =&gt; [
                                                        &#39;GET&#39;,
                                                        &#39;HEAD&#39;
                                                      ],
                           &#39;timeout&#39; =&gt; 180,
                           &#39;def_headers&#39; =&gt; bless&#40;
                           {
                            &#39;user-agent&#39; =&gt; &#39;libwww-perl/6.03&#39;
                        }, &#39;HTTP::Headers&#39; &#41;,
                           &#39;proxy&#39; =&gt; {
                                        &#39;ftp&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;,
                                        &#39;http&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;,
                                        &#39;https&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;
                                      },
                           &#39;max_size&#39; =&gt; undef
                         }, &#39;LWP::UserAgent&#39; &#41;,
          &#39;ConnectProxy&#39; =&gt;
          bless&#40; do{\&#40;my $o = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;&#41;}, &#39;URI::http&#39; &#41;,
          &#39;Timeout&#39; =&gt; 180
        };

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
uri=$VAR1 = bless&#40; do{\&#40;my $o = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;&#41;}, &#39;URI::http&#39; &#41;;

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Error: 500 Can&#39;t connect to www.cmie.biz:443


Case 2: With &#34;request&#34; in LWP/Protocol/https.pm

Output of Case 2:

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
LWP::Protocol::https new -&gt; value of arg_hash before assigning=$VAR1 = {
          &#39;Proto&#39; =&gt; &#39;tcp&#39;,
          &#39;SSL_verifycn_scheme&#39; =&gt; &#39;www&#39;,
          &#39;PeerPort&#39; =&gt; 443,
          &#39;SSL_ca_path&#39; =&gt; &#39;/etc/ssl/certs&#39;,
          &#39;SSL_verify_mode&#39; =&gt; 1,
          &#39;LocalAddr&#39; =&gt; undef,
          &#39;KeepAlive&#39; =&gt; &#39;&#39;,
          &#39;PeerAddr&#39; =&gt; &#39;www.cmie.biz&#39;,
          &#39;SendTE&#39; =&gt; 1,
          &#39;UA&#39; =&gt; bless&#40; {
                           &#39;max_redirect&#39; =&gt; 7,
                           &#39;ssl_opts&#39; =&gt; {
                                           &#39;verify_hostname&#39; =&gt; 1
                                         },
                           &#39;protocols_forbidden&#39; =&gt; undef,
                           &#39;show_progress&#39; =&gt; undef,
                           &#39;handlers&#39; =&gt; {
                                           &#39;response_header&#39; =&gt; bless&#40; [
                            {
                            &#39;owner&#39; =&gt; &#39;LWP::UserAgent::parse_head&#39;,
                            &#39;callback&#39; =&gt; sub { &#34;DUMMY&#34; },
                            &#39;m_media_type&#39; =&gt; &#39;html&#39;,
                            &#39;line&#39; =&gt; &#39;LWP/UserAgent.pm:658&#39;
                            }
                            ], &#39;HTTP::Config&#39; &#41;,
                            &#39;request_preprepare&#39; =&gt; bless&#40; [
                            {
                                &#39;owner&#39; =&gt; &#39;LWP::UserAgent::proxy&#39;,
                                &#39;callback&#39; =&gt; sub { &#34;DUMMY&#34; },
                                &#39;line&#39; =&gt; &#39;LWP/UserAgent.pm:966&#39;
                            }
                            ], &#39;HTTP::Config&#39; &#41;
                                         },
                           &#39;no_proxy&#39; =&gt; [],
                           &#39;protocols_allowed&#39; =&gt; [
                                                    &#39;https&#39;,
                                                    &#39;http&#39;,
                                                    &#39;ftp&#39;
                                                  ],
                           &#39;local_address&#39; =&gt; undef,
                           &#39;use_eval&#39; =&gt; 1,
                           &#39;requests_redirectable&#39; =&gt; [
                                                        &#39;GET&#39;,
                                                        &#39;HEAD&#39;
                                                      ],
                           &#39;timeout&#39; =&gt; 180,
                           &#39;def_headers&#39; =&gt; bless&#40; {
                                                     &#39;user-agent&#39; =&gt;
&#39;libwww-perl/6.03&#39;
                                                   }, &#39;HTTP::Headers&#39; &#41;,
                          &#39;proxy&#39; =&gt;
                           {
                            &#39;ftp&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;,
                            &#39;http&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;,
                            &#39;https&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#39;
                        },
                           &#39;max_size&#39; =&gt; undef
                         }, &#39;LWP::UserAgent&#39; &#41;,
          &#39;ConnectProxy&#39; =&gt; undef,
          &#39;Timeout&#39; =&gt; 180
        };

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Error: 500 Can&#39;t connect to www.cmie.biz:443 &#40;Connection timed out&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013313" href="/Public/Bug/Display.html?id=1894#txn-1013313">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;04:42:39&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013313/528280/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528280">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 802b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">hi

In continuation of the above i.e. after applying the given patches and
some minor change I am able to get the page.

This code works fine.


use Net::SSL;
$ua = new LWP::UserAgent&#40;ssl_opts =&gt; { verify_hostname =&gt; 0 }&#41;;

New Program :

#! /opt/bin/perl5 -w

use Net::SSL;
use LWP::UserAgent;

$ua = new LWP::UserAgent&#40;ssl_opts =&gt; { verify_hostname =&gt; 0 }&#41;;
$ua-&gt;proxy&#40;[&#39;https&#39;, &#39;http&#39;, &#39;ftp&#39;] =&gt; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#34;&#41;;
$ua-&gt;protocols_allowed&#40;[ &#39;https&#39;, &#39;http&#39;, &#39;ftp&#39; ]&#41;;

$req = new HTTP::Request &#39;GET&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.cmie.biz/updates/af/&#39;">https://www.cmie.biz/updates/af/&#39;</a></span>;
$req-&gt;header&#40;&#39;Accept&#39; =&gt; &#39;*/*&#39;&#41;;

# send request
$res = $ua-&gt;request&#40;$req&#41;;

# check the outcome
if &#40;$res-&gt;is_success&#41; {
   print $res-&gt;content;
} else {
   print &#34;Error: &#34; . $res-&gt;status_line . &#34;\n&#34;;
}

The only drawback being verify_hostname is off.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013372" href="/Public/Bug/Display.html?id=1894#txn-1013372">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;20&nbsp;11:11:59&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013372/528314/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528314">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 365b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 20 01:50:40 2011, Yusuf wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As suggested I have applied the following patches in the order given
&gt; below.
&gt; 
&gt;   1. lwp-ssl.patch
&gt;   2. Net-HTTP-6.01-httpsproxy.patch
&gt;   3. LWP-Protocol-https-6.02-httpsproxy.patch
&gt;   4. libwww-perl-6.03-httpsproxy.patch
</div>
You should not have applied lwp-ssl.patch. That is not from me and is
not part of the fix.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013691" href="/Public/Bug/Display.html?id=1894#txn-1013691">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;00:49:45&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013691/528511/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528511">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Dec 20 11:11:59 2011, JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Dec 20 01:50:40 2011, Yusuf wrote:
<div class="message-stanza open">&gt; &gt; As suggested I have applied the following patches in the order given
&gt; &gt; below.
&gt; &gt; 
&gt; &gt;   1. lwp-ssl.patch
&gt; &gt;   2. Net-HTTP-6.01-httpsproxy.patch
&gt; &gt;   3. LWP-Protocol-https-6.02-httpsproxy.patch
&gt; &gt;   4. libwww-perl-6.03-httpsproxy.patch
</div>&gt; 
&gt; You should not have applied lwp-ssl.patch. That is not from me and is
&gt; not part of the fix.
</div>
After applying your patch i.e. Net-HTTP-6.01-httpsproxy.patch,
LWP-Protocol-https-6.02-httpsproxy.patch,
libwww-perl-6.03-httpsproxy.patch In my program if I write the following
then things work

use Net::SSL; 
$ua = new LWP::UserAgent&#40;ssl_opts =&gt; { verify_hostname =&gt; 0 }&#41;; 

i.e. I have to switch of verify_hostname =&gt; 0 otherwise it gives an
error. Is this the correct way because hostname verification is lost.
Please advice. An a millions thanks for your prompt feedback and patch
they really have helped.

New Program :
#! /opt/bin/perl5 -w
use Net::SSL;
 use LWP::UserAgent; $ua = new LWP::UserAgent&#40;ssl_opts =&gt; {
verify_hostname =&gt; 0 }&#41;;
 $ua-&gt;proxy&#40;[&#39;https&#39;, &#39;http&#39;, &#39;ftp&#39;] =&gt; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#34;&#41;;
$ua-&gt;protocols_allowed&#40;[ &#39;https&#39;, &#39;http&#39;, &#39;ftp&#39; ]&#41;; $req = new
HTTP::Request &#39;GET&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.cmie.biz/updates/a">https://www.cmie.biz/updates/a</a></span> f/&#39;;
$req-&gt;header&#40;&#39;Accept&#39; =&gt; &#39;*/*&#39;&#41;;
# send request
$res = $ua-&gt;request&#40;$req&#41;;
# check the outcome
if &#40;$res-&gt;is_success&#41; { print $res-&gt;content; } else { print &#34;Error: &#34; .
$res-&gt;status_line . &#34;\n&#34;; }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1013891" href="/Public/Bug/Display.html?id=1894#txn-1013891">#</a>      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;21&nbsp;14:42:36&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1013891/528622/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/528622">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 190b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hostname verification has worked in the tests I have run. Your latest
comment is not a proper bug report, as it is missing detailed
reproduction steps, expected results, and actual results.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016501" href="/Public/Bug/Display.html?id=1894#txn-1016501">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;02:47:53&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016501/529951/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/529951">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Dec 21 14:42:36 2011, JGMYERS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hostname verification has worked in the tests I have run. Your latest
&gt; comment is not a proper bug report, as it is missing detailed
&gt; reproduction steps, expected results, and actual results.
</div>
The program is :

#! /opt/bin/perl5 -w

use Net::SSL;
use LWP::UserAgent;

$ua = new LWP::UserAgent&#40;ssl_opts =&gt; { verify_hostname =&gt; 1 }&#41;;

$ua-&gt;proxy&#40;[&#39;https&#39;, &#39;http&#39;, &#39;ftp&#39;] =&gt; &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://196.1.1.14:8080">http://196.1.1.14:8080</a></span>&#34;&#41;;

$ua-&gt;protocols_allowed&#40;[ &#39;https&#39;, &#39;http&#39;, &#39;ftp&#39; ]&#41;;

$req = new HTTP::Request &#39;GET&#39; =&gt; &#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://www.cmie.biz/updates/&#39;">https://www.cmie.biz/updates/&#39;</a></span>;

$req-&gt;header&#40;&#39;Accept&#39; =&gt; &#39;*/*&#39;&#41;;

# send request
$res = $ua-&gt;request&#40;$req&#41;;

# check the outcome
if &#40;$res-&gt;is_success&#41;
    {
    print $res-&gt;content;
    }
else
    {
    print &#34;Error: &#34; . $res-&gt;status_line . &#34;\n&#34;;
    };

Error statement :

Error: 500 Can&#39;t connect to www.cmie.biz:443 &#40;Crypt-SSLeay can&#39;t verify
hostnames&#41; 

But when I change the object creation statement to

$ua = new LWP::UserAgent&#40;ssl_opts =&gt; { verify_hostname =&gt; 0 }&#41;;

It successfully downloads the page.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016504" href="/Public/Bug/Display.html?id=1894#txn-1016504">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;02:57:39&nbsp;2011</span>
    <span class="description">yusufnulwala [...] indiatimes.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> yusufnulwala [...] indiatimes.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016504/529954/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/529954">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 715b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 02:47:53 2011, Yusuf wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wed Dec 21 14:42:36 2011, JGMYERS wrote:
<div class="message-stanza open">&gt; &gt; Hostname verification has worked in the tests I have run. Your latest
&gt; &gt; comment is not a proper bug report, as it is missing detailed
&gt; &gt; reproduction steps, expected results, and actual results.
</div>&gt; 
</div>I also tried it adding the following

use Mozilla::CA;

$ua = new LWP::UserAgent&#40; ssl_opts =&gt;
                            {
                            verify_hostname =&gt; 1,
                            SSL_ca_file =&gt; Mozilla::CA::SSL_ca_file&#40;&#41;
                            }
                        &#41;;

But it still give the same error.

[Error: 500 Can&#39;t connect to www.cmie.biz:443 &#40;Crypt-SSLeay can&#39;t verify
hostnames&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1016692" href="/Public/Bug/Display.html?id=1894#txn-1016692">#</a>      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;14:01:57&nbsp;2011</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1016692/530076/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/530076">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 370b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 30 02:47:53 2011, Yusuf wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Error: 500 Can&#39;t connect to www.cmie.biz:443 &#40;Crypt-SSLeay can&#39;t verify
&gt; hostnames&#41; 
</div>
Did you try without using a proxy, to determine whether the proxy
support is a contributing factor. If it doesn&#39;t work without proxy
support, then it&#39;s an unrelated problem.

Your problem might be that Crypt-SSLeay can&#39;t verify hostnames.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1166997" href="/Public/Bug/Display.html?id=1894#txn-1166997">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;06&nbsp;17:14:10&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> victor [...] vsespb.ru</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1166997/615332/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/615332">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 769b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Seems the following fix works for me &#40;found here
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=994683&#41;">http://www.perlmonks.org/?node_id=994683&#41;</a></span>


#!/usr/bin/perl

use MIME::Base64;
use Net::SSL &#40;&#41;; # From Crypt-SSLeay
use LWP::UserAgent;
$Net::HTTPS::SSL_SOCKET_CLASS = &#34;Net::SSL&#34;; # Force use of Net::SSL

for my $p &#40;qw!<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3128">http://127.0.0.1:3128</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3333">http://127.0.0.1:3333</a></span>!&#41; {#
<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3333">http://127.0.0.1:3333</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3128">http://127.0.0.1:3128</a></span>
        $ENV{HTTPS_PROXY} = $p;
        $ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 1;
        $ENV{&#34;HTTPS_PROXY_USERNAME&#34;} = &#39;puser&#39;;
        $ENV{&#34;HTTPS_PROXY_PASSWORD&#34;} = &#39;puser&#39;;
        
        
        my $ua = LWP::UserAgent-&gt;new&#40;&#41;;
        my $req = HTTP::Request-&gt;new&#40;&#39;GET&#39;,&#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://bing.com/&#39;&#41;">https://bing.com/&#39;&#41;</a></span>;
        my $res = $ua-&gt;request&#40;$req&#41;;
        print $res-&gt;dump&#40;&#41;;
        print &#34;\n&#34;;
}

&#40;it supports HTTPS proxy, password protected proxies, different proxies
for different requests&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1174445" href="/Public/Bug/Display.html?id=1894#txn-1174445">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;26&nbsp;14:22:38&nbsp;2013</span>
    <span class="description">victor [...] vsespb.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1174445/619415/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/619415">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Also, for one who testing this or who want to make sure their code
actually use the proxy &#40;in different environments&#41;:

you can verify that $response-&gt;header&#40;&#39;Client-Peer&#39;&#41; is actually points
to the proxy.

$response-&gt;header&#40;&#39;Client-Peer&#39;&#41; is actual IP address of the peer. Here
is the code from LWP:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; if &#40;defined&#40;my $peerhost = $sock-&gt;peerhost&#41;&#41; {
&gt;       $res-&gt;header&#40;&#34;Client-Peer&#34; =&gt; &#34;$peerhost:&#34; . $sock-&gt;peerport&#41;;
&gt; }
</div>
&#40;note that Clietn-Peer is only IP, not DNS name&#41;


On Mon Jan 07 02:14:10 2013, vsespb wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Seems the following fix works for me &#40;found here
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perlmonks.org/?node_id=994683&#41;">http://www.perlmonks.org/?node_id=994683&#41;</a></span>
&gt; 
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use MIME::Base64;
&gt; use Net::SSL &#40;&#41;; # From Crypt-SSLeay
&gt; use LWP::UserAgent;
&gt; $Net::HTTPS::SSL_SOCKET_CLASS = &#34;Net::SSL&#34;; # Force use of Net::SSL
&gt; 
&gt; for my $p &#40;qw!<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3128">http://127.0.0.1:3128</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3333">http://127.0.0.1:3333</a></span>!&#41; {#
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3333">http://127.0.0.1:3333</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:3128">http://127.0.0.1:3128</a></span>
&gt;       $ENV{HTTPS_PROXY} = $p;
&gt;       $ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 1;
&gt;       $ENV{&#34;HTTPS_PROXY_USERNAME&#34;} = &#39;puser&#39;;
&gt;       $ENV{&#34;HTTPS_PROXY_PASSWORD&#34;} = &#39;puser&#39;;
&gt;       
&gt;       
&gt;       my $ua = LWP::UserAgent-&gt;new&#40;&#41;;
&gt;       my $req = HTTP::Request-&gt;new&#40;&#39;GET&#39;,&#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://bing.com/&#39;&#41;">https://bing.com/&#39;&#41;</a></span>;
&gt;       my $res = $ua-&gt;request&#40;$req&#41;;
&gt;       print $res-&gt;dump&#40;&#41;;
&gt;       print &#34;\n&#34;;
&gt; }
&gt; 
&gt; &#40;it supports HTTPS proxy, password protected proxies, different proxies
&gt; for different requests&#41;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273735" href="/Public/Bug/Display.html?id=1894#txn-1273735">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;11&nbsp;14:00:22&nbsp;2013</span>
    <span class="description">DDUMONT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> dkg [...] fifthhorseman.net</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1273735/674620/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/674620">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ok. I&#39;m giving this a try. I&#39;ve applied the 3 patches from JGMYERS on my Debian/sid packages &#40;which are up-to-date compared to CPAN&#41;.

I&#39;m trying to connect to https servers using tinyproxy. This may not be the best proxy, but it&#39;s one I can install easily on my laptop so I can check the logs.

First of all, https request coming from Firefox ares accepted and generate the following tinyproxy logs:

CONNECT   Oct 11 19:47:50 [8443]: Connect &#40;file descriptor 6&#41;: localhost [127.0.0.1]
CONNECT   Oct 11 19:47:50 [8443]: Request &#40;file descriptor 6&#41;: CONNECT rt.cpan.org:443 HTTP/1.1
INFO      Oct 11 19:47:50 [8443]: No upstream proxy for rt.cpan.org

But the https connection coming from patched LWP::UserAgent fails:

CONNECT   Oct 11 19:38:10 [16212]: Connect &#40;file descriptor 6&#41;: localhost [127.0.0.1]
CONNECT   Oct 11 19:38:10 [16212]: Request &#40;file descriptor 6&#41;: CONNECT 127.0.0.1:8888 HTTP/1.0
INFO      Oct 11 19:38:10 [16212]: Refused CONNECT method on port 8888

I believe that doing CONNECT on the proxy itself &#40;127.0.0.1&#41; is wrong. I don&#39;t know how to fix that.

Turns out that tinyproxy rejection triggers error handling in  LWP::Protocol::https::Socket::new. I get the following message:

  500 Usage: IO::Handle::error&#40;handle&#41;

Looks like this line from Net-HTTP-6.01-httpsproxy.patch is not correct:

  return $self-&gt;error&#40;$response-&gt;status_line&#41; if $response-&gt;is_error;

But that another &#40;minor&#41; issue.

Feel free to get back to me to perform further test. I can test behind tinyproxy and behind a corporate firewall.

Once I have a working solution, I can upload patched packages in Debian/experimental to have more user feedback.

All the best
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1273851" href="/Public/Bug/Display.html?id=1894#txn-1273851">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;12&nbsp;03:35:29&nbsp;2013</span>
    <span class="description">DDUMONT [...] cpan.org -  Cc DDUMONT added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1279479" href="/Public/Bug/Display.html?id=1894#txn-1279479">#</a>      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;26&nbsp;14:35:28&nbsp;2013</span>
    <span class="description">DDUMONT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> LWP::UserAgent with JGMYERS patches *can* reach https sites via proxy</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1279479/677941/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/677941">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 546b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ok, I had a case of PEBKAC. The following program is working fine with
JGMYERS patches and a local tinyproxy setup :

#!/usr/bin/perl
use LWP::UserAgent; 
for my $p &#40;qw!<span class="clickylink"><a target="new" rel="nofollow" href="http://127.0.0.1:8888">http://127.0.0.1:8888</a></span>!&#41; {
    $ENV{HTTPS_PROXY} = $p; 
    $ENV{PERL_LWP_SSL_VERIFY_HOSTNAME} = 1; 
    my $ua = LWP::UserAgent-&gt;new&#40;&#41;; 
    my $req = HTTP::Request-&gt;new&#40;&#39;GET&#39;,&#39;<span class="clickylink"><a target="new" rel="nofollow" href="https://bing.com/&#39;&#41;">https://bing.com/&#39;&#41;</a></span>; 
    my $res = $ua-&gt;request&#40;$req&#41;; 
    print $res-&gt;dump&#40;&#41;; 
    print &#34;\n&#34;;
} 

Using this stuff cannot be simpler :-&#41;

JGMYERS, thanks a bunch for your patches 

All the best
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1279836" href="/Public/Bug/Display.html?id=1894#txn-1279836">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;27&nbsp;11:08:43&nbsp;2013</span>
    <span class="description">DDUMONT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1279836/678173/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/678173">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 957b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry about the previous message. I was wrong: the program I posted bypasses the proxy.

First of all, the URL suggested in the example above is a bad idea: <span class="clickylink"><a target="new" rel="nofollow" href="https://bing.com">https://bing.com</a></span> sends back a 301 and redirects toward an http url. This is really confusing when testing proxies. I&#39;m now doing tests with a repo url from github. &#40;no redirection&#41;

I&#39;ve tried again JGMYERS patches, but they work only when setting env_proxy to 0. Which does not bring obvious benefits compared to the solution suggested by Crypt::SSLeay man page &#40;&#34;PROXY SUPPORT&#34; section&#41;.

To get a LWP::UserAgent that work through a proxy with both http and https request &#40;with CONNECT&#41;, a simple solution is to modify LWP::UserAgent to avoid storing https_proxy. &#40;See <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/libwww-perl/pull/51&#41;">https://github.com/libwww-perl/libwww-perl/pull/51&#41;</a></span>

This should solve most of the use cases. 

On the other hand, calling $ua-&gt;proxy&#40;&#39;https&#39;,...&#41; will not use SSLeay so the proxy connection will not work with most proxies.


 
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1279902" href="/Public/Bug/Display.html?id=1894#txn-1279902">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;27&nbsp;12:28:36&nbsp;2013</span>
    <span class="description">JGMYERS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1279902/678224/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/678224">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 623b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 27 11:08:43 2013, DDUMONT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve tried again JGMYERS patches, but they work only when setting
&gt; env_proxy to 0.
</div>
My patches are not intended to be used with env_proxy.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Which does not bring obvious benefits compared to the
&gt; solution suggested by Crypt::SSLeay man page &#40;&#34;PROXY SUPPORT&#34;
&gt; section&#41;.
</div>
The Crypt::SSLeay solution is not thread safe, as the environment cannot be changed in a thread safe manner. Two different threads cannot have two different proxy configurations. The only safe approach with that solution is to either have all connections use the same proxy or none of them use a proxy. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1285617" href="/Public/Bug/Display.html?id=1894#txn-1285617">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;09&nbsp;15:05:03&nbsp;2013</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1285617/681274/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/681274">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 581b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
I&#39;ve added another way to patch the problem and added it as pull requests to libwww-perl and lwp-protocol-https repositories on github. My patches work with Net::SSL and IO::Socket::SSL backends, work with keep-alive, proxy-authorization etc. With IO::Socket::SSL backend one can even switch to SSL inside an already established socket, e.g. after some plain HTTP requests.
And, the change contains an extensiv test to make sure that all features work as intended. 

See  <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/libwww-perl/pull/52">https://github.com/libwww-perl/libwww-perl/pull/52</a></span>, <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/lwp-protocol-https/pull/7">https://github.com/libwww-perl/lwp-protocol-https/pull/7</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1285640" href="/Public/Bug/Display.html?id=1894#txn-1285640">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;09&nbsp;16:28:11&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1285640/681288/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/681288">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 803b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Nov 09 15:05:03 2013, SULLR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I&#39;ve added another way to patch the problem and added it as pull
&gt; requests to libwww-perl and lwp-protocol-https repositories on github.
&gt; My patches work with Net::SSL and IO::Socket::SSL backends, work with
&gt; keep-alive, proxy-authorization etc. With IO::Socket::SSL backend one
&gt; can even switch to SSL inside an already established socket, e.g.
&gt; after some plain HTTP requests.
&gt;  And, the change contains an extensiv test to make sure that all
&gt; features work as intended.
&gt; 
&gt; See  <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/libwww-perl/pull/52">https://github.com/libwww-perl/libwww-perl/pull/52</a></span>,
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/libwww-perl/lwp-protocol-https/pull/7">https://github.com/libwww-perl/lwp-protocol-https/pull/7</a></span>
</div>
That looked like a lot of work.  Thank you.  I hope it makes it in.  &#40;You don’t want to see the crazy workarounds my scripts have used up till now. :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1292257" href="/Public/Bug/Display.html?id=1894#txn-1292257">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;08:19:45&nbsp;2013</span>
    <span class="description">DDUMONT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1292257/684714/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/684714">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 197b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Sam 09 Nov 2013 22:28:11, SPROUT a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That looked like a lot of work.  Thank you.  I hope it makes it in.
</div>
Stephen patches are merged upstream. I hope a new release will be done soon.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1501981" href="/Public/Bug/Display.html?id=1894#txn-1501981">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;31&nbsp;04:46:53&nbsp;2015</span>
    <span class="description">DDUMONT [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1501981/800343/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/800343">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 279b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Sam 23 Nov 2013 14:19:45, DDUMONT a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Stephen patches are merged upstream. I hope a new release will be done soon.
</div>
Stephen patches were released with libwww-perl 6.06 and LWP::Protocol::https 6.06. https with proxy works fine now.

I think this bus can be closed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1502098" href="/Public/Bug/Display.html?id=1894#txn-1502098">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;31&nbsp;14:47:41&nbsp;2015</span>
    <span class="description">ether [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1502100" href="/Public/Bug/Display.html?id=1894#txn-1502100">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;31&nbsp;14:47:48&nbsp;2015</span>
    <span class="description">ether [...] cpan.org -  Fixed in 6.06 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.570226</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
