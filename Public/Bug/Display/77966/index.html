<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #77966 for Test-LongString: is_string reports incorrect position of first difference when performing comparison in numeric context</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #77966 for Test-LongString: is_string reports incorrect position of first difference when performing comparison in numeric context</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-LongString/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-LongString/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-LongString/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-LongString/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-LongString">Test-LongString CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">77966</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-LongString/Active/">Test-LongString</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">RGARCIA [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nick.pongratz [...] cdw.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-31474-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.12</li>
<li>
0.13</li>
<li>
0.14</li>
<li>
0.15</li>
</ul>
    </td>
  </tr>
  <tr id="CF-31475-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;22&nbsp;15:07:28&nbsp;2012</span>
    <span class="description">nick.pongratz [...] cdw.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> is_string reports incorrect position of first difference when
 performing comparison in numeric context</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Distribution: Test-LongString &#40;all versions&#41;
Perl version: 5.14.2 for darwin
Operating system: Mac OS X 10.6.8
% uname -a
Darwin zenyatta 10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:33:36
PDT 2011; root:xnu-1504.15.3~1/RELEASE_I386 i386


Abstract
================
_common_prefix_length sometimes compares arguments in numeric context,
which can cause Test::LongString subroutines such as is_string to report
an incorrect position of the first difference. 

_common_prefix_length should always perform a bitwise string XOR, rather
than the ambiguous XOR that sometimes executes in numeric context.


Bug reproduction and analysis
==============================
When $str1 and/or $str2 are passed to _common_prefix_length as numbers
&#40;rather than strings, as expected&#41;, $diff is constructed using a bitwise
numeric XOR rather than the desired bitwise string XOR. This has the
effect of presenting confusing error messages, as illustrated here:

#--- BEGIN BUG REPRODUCTION ---
% perl -e &#34;use Test::LongString; is_string&#40;0+&#39;123&#39;, &#39;124&#39;, &#39;123 is 124&#39;&#41;;&#34;
not ok 1 - 123 is 124
#   Failed test &#39;123 is 124&#39;
#   at -e line 1.
#          got: &#34;123&#34;
#       length: 3
#     expected: &#34;124&#34;
#       length: 3
#     strings begin to differ at char 1 &#40;line 1 column 1&#41;
# Tests were run but no plan was declared and done_testing&#40;&#41; was not seen.
#--- END BUG REPRODUCTION ---

Please note the claim that the &#34;strings begin to differ at char 1&#34;. It
would be accurate to report that the strings begin to differ at char 3.

Please also note that there is no indication that the arguments are
numbers. In the report, the values indicated by got: and expected: are
both surrounded by double-quotes, which &#40;to me, at least&#41; appears to
imply a string comparison was performed.


Patch
================
A fix for this is to force a bitwise string XOR in _common_prefix_length
per perldoc perlop [1]:

# --- BEGIN PATCH of Test/LongString.pm ---
@@ -62,7 +62,7 @@
 
 sub _common_prefix_length {
     my &#40;$str1, $str2&#41; = @_;
-    my $diff = $str1 ^ $str2;
+    my $diff = &#34;$str1&#34; ^ &#34;$str2&#34;;
     my &#40;$pre&#41; = $diff =~ /^&#40;\000*&#41;/;
     return length $pre;
 }

# --- END PATCH ---


Tests
================
Tests for this fix:

# --- BEGIN TESTS ---
test_out&#40;&#34;not ok 1 - &#39;123&#39; is &#39;124&#39;&#34;&#41;;test_fail&#40;6&#41;;
test_diag&#40;qq!         got: &#34;123&#34;
#       length: 3
#     expected: &#34;124&#34;
#       length: 3
#     strings begin to differ at char 3 &#40;line 1 column 3&#41;!&#41;;
is_string&#40;&#34;123&#34;, &#34;124&#34;, &#34;123 is 124&#34;&#41;;
test_test&#40;&#34;two small number strings different&#34;&#41;;

test_out&#40;&#34;not ok 1 - 0+&#39;123&#39; is 0+&#39;124&#39;&#34;&#41;;
test_fail&#40;6&#41;;
test_diag&#40;qq!         got: &#34;123&#34;
#       length: 3
#     expected: &#34;124&#34;
#       length: 3
#     strings begin to differ at char 3 &#40;line 1 column 3&#41;!&#41;;
is_string&#40;0+&#34;123&#34;, 0+&#34;124&#34;, &#34;123 is 124&#34;&#41;;
test_test&#40;&#34;two small numbers different&#34;&#41;;

test_out&#40;&#34;not ok 1 - 123 is 123xyz&#34;&#41;;
test_fail&#40;6&#41;;
test_diag&#40;qq!         got: &#34;123&#34;
#       length: 3
#     expected: &#34;123xyz&#34;
#       length: 6
#     strings begin to differ at char 4 &#40;line 1 column 4&#41;!&#41;;
is_string&#40;&#34;123&#34;, &#34;123xyz&#34;, &#34;123 is 123xyz&#34;&#41;;
test_test&#40;&#34;small number string different from small string&#34;&#41;;

test_out&#40;&#34;not ok 1 - 0+&#39;123&#39; is 123xyz&#34;&#41;;
test_fail&#40;6&#41;;
test_diag&#40;qq!         got: &#34;123&#34;
#       length: 3
#     expected: &#34;123xyz&#34;
#       length: 6
#     strings begin to differ at char 4 &#40;line 1 column 4&#41;!&#41;;
is_string&#40;0+&#34;123&#34;, &#34;123xyz&#34;, &#34;123 is 123xyz&#34;&#41;;
test_test&#40;&#34;small number different from small string&#34;&#41;;

# --- END TESTS ---

Notes
================
[1] <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlop.html#Bitwise-String-Operators">http://perldoc.perl.org/perlop.html#Bitwise-String-Operators</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;04:00:48&nbsp;2014</span>
    <span class="description">RGARCIA [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;04:04:14&nbsp;2014</span>
    <span class="description">RGARCIA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is fixed in 0.16.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;04:04:14&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;05&nbsp;04:04:15&nbsp;2014</span>
    <span class="description">RGARCIA [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
