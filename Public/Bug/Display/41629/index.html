<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #41629 for DateTime: DateTime performance</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #41629 for DateTime: DateTime performance</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DateTime/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DateTime/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DateTime/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DateTime/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/DateTime.pm/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/DateTime">DateTime CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">41629</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DateTime/Active/">DateTime</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlhackque [...] yahoo.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-9734-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-9735-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;11&nbsp;09:48:40&nbsp;2008</span>
    <span class="description">tlhackque [...] yahoo.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DateTime performance</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m using DateTime in a log file analyzer that consolidates log files 
across multiple time zones.  Performance was awful, and surprisingly 
turns out to be DateTime - sorta.

I know people have complained about DateTime performance before - but 
before you tune out, I have some analysis that points to some 
straightforward fixes.

Context:
For a small test case, I get about 12 seconds of elapsed time on an 
idle system.

If I simply read the file and count records, I spend about 2.5 seconds.

I call DateTime-&gt;new once per record with year, second, minute, hour, 
day, month, time_zone [pre calculated from DateTime::TimeZone-&gt;new] and 
locale [also pre-calculated from DateTime::Locale-&gt;load].  I then do a 
single compare with a &#34;recent&#34; filter.

Profile:
dprofpp says that about 50 percent of the elapsed time is in 
DateTime::new!

Finding # 1:
  Params::Validate is the biggest offender.  If I set 
Params::Validate::NO_VALIDATION=1 in the caller &#40;outside the main loop, 
of course&#41;, elapsed time in DateTime is cut in half.  Elapsed time 
drops to 9 secs - a 25% improvment.

Finding # 2:
   With NO_VALIDATION set, Params::Validate::_validate is still the 
dominant consumer of time!  29%.  DateTime::new uses 18%.  

Finding # 3:
   Since the majority of the records are rejected, I replaced the 
DateTime compare with sprintf and a string compare.  I also moved the 
DateTime::new so it&#39;s only called on the selected records &#40;to convert 
to a display timezone.&#41;  

This reduces runtime to 3 seconds, for a total 75% reduction in elapsed 
time.  And confirms the bottlenecks.  Excluding the time to read the 
file, processing is now essentially zero.

Request # 1:
   It would be useful if there were a DateTime &#34;no-validate&#34; function 
or global.  Hitting Params::Validate externally &#40;or even knowing to&#41; 
breaks modularity, and may cause effects elsewhere.  If you do nothing 
else, this is a big win.  Please document the call prominently.

Request # 2:
  Consider replacing Params::Validate with something more efficient -- 
or have a production flag that selects Params::Validate for development 
or a lightweight parameter fetcher/checker for production.

  This is a bit more work, but it&#39;s still a big win!

Here is the dprofpp profile for the case with 
Params::Validate::NO_VALIDATION=1:

Total Elapsed Time = 8.912796 Seconds
  User+System Time = 8.512796 Seconds
Exclusive Times
%Time ExclSec CumulS #Calls sec/call Csec/c  Name
 29.3   2.498  2.507   4817   0.0005 0.0005  Params::Validate::_validate
 18.0   1.536  5.700   4349   0.0004 0.0013  DateTime::new
 13.6   1.162  8.856      1   1.1620 8.8556  main::displayLog
 6.47   0.551  0.605   4367   0.0001 0.0001  
DateTime::_calc_local_components
 6.21   0.529  0.729  17380   0.0000 0.0000  DateTime::Helpers::can
 6.07   0.517  2.043     24   0.0215 0.0851  main::BEGIN
 6.01   0.512  1.775   4345   0.0001 0.0004  DateTime::_compare
 4.24   0.361  0.526   4366   0.0001 0.0001  
DateTime::_handle_offset_modifier
 4.17   0.355  0.355   8691   0.0000 0.0000  DateTime::utc_rd_values
 2.82   0.240  0.928   4367   0.0001 0.0002  DateTime::_calc_local_rd
 2.37   0.202  0.196   4352   0.0000 0.0000  DateTime::_calc_utc_rd
 2.23   0.190  0.869      7   0.0271 0.1241  DateTime::Locale::BEGIN
 2.17   0.185  0.182   4349   0.0000 0.0000  DateTime::_month_length
 1.63   0.139  0.139  17395   0.0000 0.0000  UNIVERSAL::can
 1.59   0.135  0.135   8693   0.0000 0.0000  DateTime::time_zone

I hope this analysis is useful and that it will enable you to make some 
improvements.

Thanks!

Oh, Fedora Core 4 &#40;Linux&#41;  2.6.17-1.2142_FC4 #1, perl 5.8.8, i686
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;15:37:26&nbsp;2008</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 11 09:48:40 2008, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m using DateTime in a log file analyzer that consolidates log files 
&gt; across multiple time zones.  Performance was awful, and surprisingly 
&gt; turns out to be DateTime - sorta.
&gt; 
&gt; I know people have complained about DateTime performance before - but 
&gt; before you tune out, I have some analysis that points to some 
&gt; straightforward fixes.
</div>
First of all, your proposed fixes aren&#39;t that straightfoward &#40;&#34;use
something faster than Params::Validate&#34; - it&#39;s in XS!&#41;

But firster, are you sure you have the XS version of Params::Validate
&#40;and DateTime&#41; installed. To check PV, run this code:

  perl -MParams::Validate -MParams::ValidateXS -le &#39;print &#34;OK&#34;&#39;

If that doesn&#39;t print OK, then you&#39;re using the way slower pure Perl
implementation.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;15:37:27&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;12&nbsp;19:51:49&nbsp;2008</span>
    <span class="description">tlhackque [...] yahoo.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> tlhackque [...] yahoo.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the quick reply.

$ perl -MParams::Validate -MParams::ValidateXS -le &#39;print &#34;OK&#34;&#39;
OK
So yes, I&#39;m running the XS version.

OK, so &#34;straightforward&#34; is somewhat misleading.  What I meant is that 
at least we know where the time is going; it&#39;s not fundamental 
algorithmic complexity of the conversions -- which seems to be the main 
explanation used in the past.  It&#39;s an interface wrapper issue.  

Suggestion 1 really is straightforward and easy: add a package 
variable &#34;DT_Dont_Validate&#34; &#38; a method to set it.  If it&#39;s set, on 
function entry just do 

{
  local Params::Validate::NO_VALIDATION = DT_Dont_Validate;  

  Params::Validate::validate&#40; this argument list &#41;;
}

That should be have a substantial ROI.

On the second suggestion - perhaps Params::Validate::Dummy is 
lightweight enough to help.  It allegedly just passes argument lists 
thru, though it may not be quite heavy enough - perhaps some ||= 
defaulting is required too.

I don&#39;t know the internals of DateTime well enough to know how much 
would be involved in making suitable changes.  But the performance data 
that I gathered does say that there&#39;s benefit there.  

I&#39;m not against parameter validation - in fact, I use DateTime&#39;s to 
catch user input errors.  It&#39;s wonderful.  But not in an inner loop 
that&#39;s handling machine-generated data!

There may of course be a middle performance ground, where argument 
checks are in-line &#40;rather that Param::Validate&#39;s heavy table-driven 
but very general mechanism.&#41;  But that&#39;s obviously the most work.

In any case, I appreciate your consideration.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Dec&nbsp;27&nbsp;10:05:30&nbsp;2008</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Dec 12 19:51:49 2008, tlhackque wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the quick reply.
&gt; 
&gt; $ perl -MParams::Validate -MParams::ValidateXS -le &#39;print &#34;OK&#34;&#39;
&gt; OK
&gt; So yes, I&#39;m running the XS version.
&gt; 
&gt; OK, so &#34;straightforward&#34; is somewhat misleading.  What I meant is that 
&gt; at least we know where the time is going; it&#39;s not fundamental 
&gt; algorithmic complexity of the conversions -- which seems to be the main 
&gt; explanation used in the past.  It&#39;s an interface wrapper issue.  
&gt; 
&gt; Suggestion 1 really is straightforward and easy: add a package 
&gt; variable &#34;DT_Dont_Validate&#34; &#38; a method to set it.  If it&#39;s set, on 
&gt; function entry just do 
&gt; 
&gt; {
&gt;   local Params::Validate::NO_VALIDATION = DT_Dont_Validate;  
&gt; 
&gt;   Params::Validate::validate&#40; this argument list &#41;;
&gt; }
&gt; 
&gt; That should be have a substantial ROI.
&gt; 
&gt; On the second suggestion - perhaps Params::Validate::Dummy is 
&gt; lightweight enough to help.  It allegedly just passes argument lists 
&gt; thru, though it may not be quite heavy enough - perhaps some ||= 
&gt; defaulting is required too.
&gt; 
&gt; I don&#39;t know the internals of DateTime well enough to know how much 
&gt; would be involved in making suitable changes.  But the performance data 
&gt; that I gathered does say that there&#39;s benefit there.  
&gt; 
&gt; I&#39;m not against parameter validation - in fact, I use DateTime&#39;s to 
&gt; catch user input errors.  It&#39;s wonderful.  But not in an inner loop 
&gt; that&#39;s handling machine-generated data!
&gt; 
&gt; There may of course be a middle performance ground, where argument 
&gt; checks are in-line &#40;rather that Param::Validate&#39;s heavy table-driven 
&gt; but very general mechanism.&#41;  But that&#39;s obviously the most work.
&gt; 
&gt; In any case, I appreciate your consideration.
</div>
I&#39;d be interested in seeing replacement validation code that did all the
validation that PV is doing, but was faster. I don&#39;t know if that&#39;s
possible.

You suggest simply skipping validation, but in your case that wouldn&#39;t
help, since you say that a majority of the data you pass is getting
rejected.

Also, that seriously skews the profile, since if the majority is getting
rejected, then you&#39;d expect that to be highest in the profile, since you
never make it past Params::Validate into DateTime itself.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;24&nbsp;15:05:12&nbsp;2009</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
