<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #92514 for RT-Authen-ExternalAuth: DBI plugin doesn&#39;t normalize case</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #92514 for RT-Authen-ExternalAuth: DBI plugin doesn&#39;t normalize case</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/RT-Authen-ExternalAuth/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/RT-Authen-ExternalAuth/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/RT-Authen-ExternalAuth/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/RT-Authen-ExternalAuth/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/RT-Authen-ExternalAuth">RT-Authen-ExternalAuth CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">92514</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/RT-Authen-ExternalAuth/Active/">RT-Authen-ExternalAuth</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cbrandt [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-221202-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.17    </td>
  </tr>
  <tr id="CF-221203-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;27&nbsp;14:38:03&nbsp;2014</span>
    <span class="description">cbrandt [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> DBI plugin doesn&#39;t normalize case</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Using the DBI plugin to authenticate against a database, if you try to create a user with a mixed case email address like User1@example.com, the DB can return data in a datastructure keyed by user1@example.com. This will fail to match, key fields like Name won&#39;t be set, and RT will fail to create a new user account.

It works if the provided username gets the casing right and it matches.

The correct fix is that RT-Authen-ExternalAuth needs to normalize data. One attempt is attached, but this didn&#39;t quite solve it.

More investigation needed.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Work-in-progress.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From e00eb8ad529742a6aacf2d11b17f56679edeb330 Mon Sep 17 00:00:00 2001
From: Kevin Falcone &lt;falcone@bestpractical.com&gt;
Date: Mon, 27 Jan 2014 12:25:51 -0500
Subject: [PATCH] Work in progress.

Start using NAME_lc to force the hashref to come back with a predictable
key.  This isn&#39;t working locally, may be DBD::Sqlite, may be me
misreading DBI.pm.  It may actually be easier to just switch to the
arrayref syntax.
---
 lib/RT/Authen/ExternalAuth/DBI.pm | 29 ++++++++++++++++++++++++++---
 xt/sqlite.t                       |  4 ++--
 2 files changed, 28 insertions&#40;+&#41;, 5 deletions&#40;-&#41;

diff --git a/lib/RT/Authen/ExternalAuth/DBI.pm b/lib/RT/Authen/ExternalAuth/DBI.pm
index 235c3a4..9039dfb 100644
--- a/lib/RT/Authen/ExternalAuth/DBI.pm
+++ b/lib/RT/Authen/ExternalAuth/DBI.pm
@@ -175,6 +175,12 @@ sub GetAuth {
     my $dbh = _GetBoundDBIObj&#40;$config&#41;;
     return 0 unless $dbh;
     
+    RT-&gt;Logger-&gt;debug&#40;&#34;DBI Search &#34;,
+                      &#34;== Query:&#34;, 
+                      $query,
+                      &#34;== Params:&#34;, 
+                      join&#40;&#39;,&#39;,@params&#41;&#41;;
+
     my $results_hashref = $dbh-&gt;selectall_hashref&#40;$query,$db_u_field,{},@params&#41;;
     $dbh-&gt;disconnect&#40;&#41;;
 
@@ -201,7 +207,7 @@ sub GetAuth {
     }
     
     # Get the user&#39;s password from the database query result
-    my $pass_from_db = $results_hashref-&gt;{$username}-&gt;{$db_p_field};        
+    my $pass_from_db = $results_hashref-&gt;{lc $username}-&gt;{$db_p_field};        
 
     if &#40; $db_p_check &#41; {
         unless &#40; ref $db_p_check eq &#39;CODE&#39; &#41; {
@@ -330,11 +336,19 @@ sub CanonicalizeUserInfo {
     my $query = &#34;SELECT $fields FROM $table WHERE $where_key=?&#34;;
     my @bind_params = &#40;$where_value&#41;;
 
+    RT-&gt;Logger-&gt;debug&#40;&#34;DBI Search &#34;,
+                      &#34;== Query:&#34;,
+                      $query,
+                      &#34;== Params:&#34;,
+                      join&#40;&#39;,&#39;,@bind_params&#41;&#41;;
+
     # Uncomment this to trace basic DBI throughput in a log
     # DBI-&gt;trace&#40;1,&#39;/tmp/dbi.log&#39;&#41;;
     my $dbh = _GetBoundDBIObj&#40;$config&#41;;
     my $results_hashref = $dbh-&gt;selectall_hashref&#40;$query,$key,{},@bind_params&#41;;
     $dbh-&gt;disconnect&#40;&#41;;
+    use Data::Dumper; RT-&gt;Logger-&gt;debug&#40;Dumper $results_hashref&#41;;
+
 
     if &#40;&#40;scalar keys %$results_hashref&#41; != 1&#41; {
         # If returned users &lt;&gt; 1, we have no single unique user, so prepare to die
@@ -363,7 +377,8 @@ sub CanonicalizeUserInfo {
 
     # We haven&#39;t dropped out, so DB search must have succeeded with 
     # exactly 1 result. Get the result and set $found to 1
-    my $result = $results_hashref-&gt;{$value};
+    my $result = $results_hashref-&gt;{lc $value};
+    use Data::Dumper; RT-&gt;Logger-&gt;debug&#40;Dumper $result&#41;;
  
     # Use the result to populate %params for every key we&#39;re given in the config
     foreach my $key &#40;keys&#40;%{$config-&gt;{&#39;attr_map&#39;}}&#41;&#41; {
@@ -371,6 +386,7 @@ sub CanonicalizeUserInfo {
     }
     
     $found = 1;
+    use Data::Dumper; RT-&gt;Logger-&gt;debug&#40;Dumper \%params&#41;;
   
     return &#40;$found, %params&#41;;
 }
@@ -476,7 +492,7 @@ sub UserDisabled {
         # otherwise all should be well
         
         # $user_db_disable_value = The value for &#34;disabled&#34; returned from the DB
-        my $user_db_disable_value = $results_hashref-&gt;{$username}-&gt;{$disable_field};
+        my $user_db_disable_value = $results_hashref-&gt;{lc $username}-&gt;{$disable_field};
         
         # For each of the values in the &#40;list of values that we consider to mean the user is disabled&#41;..
         foreach my $disable_value &#40;@{$disable_values_list}&#41;{
@@ -619,6 +635,13 @@ sub _GetBoundDBIObj {
     my $dbh = DBI-&gt;connect&#40;$dsn, $db_user, $db_pass,{RaiseError =&gt; 1, AutoCommit =&gt; 0 }&#41;
             or die $DBI::errstr;
 
+
+    # We love using selectall_hashref, which uses a columnkey which comes back in
+    # the case the database is stored in.  On a case insensitive database, we
+    # have no guarantee that this will match the user supplied input, so we force
+    # it all to lowercase.  This might break if you were relying on an external
+    # database source with two users named user1 and User1 who were distcint.
+    $dbh-&gt;{FetchHashKeyName} = &#39;NAME_lc&#39;;
     # If we didn&#39;t die, return the DBI object handle 
     # and hope it&#39;s treated sensibly and correctly 
     # destroyed by the calling code
diff --git a/xt/sqlite.t b/xt/sqlite.t
index 179861f..50a93a1 100644
--- a/xt/sqlite.t
+++ b/xt/sqlite.t
@@ -18,14 +18,14 @@ my $dbh = DBI-&gt;connect&#40;&#34;dbi:SQLite:$dbname&#34;&#41;;
 my $password = Digest::MD5::md5_hex&#40;&#39;password&#39;&#41;;
 my $schema = &lt;&lt;&#34;EOF&#34;;
 CREATE TABLE users &#40;
-  username varchar&#40;200&#41; NOT NULL,
+  username varchar&#40;200&#41; NOT NULL collate nocase,
   password varchar&#40;40&#41; NULL,
   email varchar&#40;16&#41; NULL
 &#41;;
 EOF
 $dbh-&gt;do&#40; $schema &#41;;
 $dbh-&gt;do&#40;
-&#34;INSERT INTO $table VALUES &#40; &#39;testuser&#39;, &#39;$password&#39;, &#39;testuser\@invalid.tld&#39;&#41;&#34;
+&#34;INSERT INTO $table VALUES &#40; &#39;Testuser&#39;, &#39;$password&#39;, &#39;testuser\@invalid.tld&#39;&#41;&#34;
 &#41;;
 
 RT-&gt;Config-&gt;Set&#40; ExternalAuthPriority        =&gt; [&#39;My_SQLite&#39;] &#41;;
-- 
1.8.2.3

</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
