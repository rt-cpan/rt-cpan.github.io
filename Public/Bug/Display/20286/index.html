<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #20286 for DBD-SQLite: DBD::SQLite leaks file descriptors</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #20286 for DBD-SQLite: DBD::SQLite leaks file descriptors</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">20286</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MUIR [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.11</li>
<li>
1.12</li>
<li>
1.13</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;21:48:34&nbsp;2006</span>
    <span class="description">MUIR [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">DBD::SQLite fails the regression tests for my OOPS module.  Normally
when this happens, I go digging for the problem in my code.  This time
I&#39;m not because DBD::SQLite2 passes my regression tests.

How to repeat:
Download OOPS 0.1004 from CPAN.

You&#39;ll also need: a recent Data::Compare, Time::HiRes, Test::MultiFork,
Clone::PP.

The your OOPSTEST_DSN environment variable to:
 DBI:SQLite2:dbname=/tmp/sqlite2.$$.db&#34;

Run the tests.  See that they work fine.

Set your OOPSTEST_DSN environment variable to:
 DBI:SQLite:dbname=/tmp/sqlite.$$.db&#34;

Run the tests again. My guess is that they&#39;ll fail.

The tests that will fail:

  t/blobsize.t around test #9499
  t/slowtest.t around test #9792
  t/db-slowtest.t around test #9832
  t/nulls.t around test #11711

The failure message is &#34;unable to open database file&#40;1&#41; at dbdimp.c&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;04&nbsp;22:03:09&nbsp;2006</span>
    <span class="description">MUIR [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;DBD::SQLite can&#39;t do what DBD::SQLite2 can&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;18:43:11&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m sorry, I can&#39;t fix a bug based on &#34;My app breaks when I use this&#34;. Please feel free to file a 
bug report with a reasonable &#40;small&#41; example attached. Meanwhile I&#39;m rejecting this bug.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;18:43:12&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;18:43:12&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;18:47:40&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 Sep 2006 15:47:30 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I do not have a small example.   If I did, I would give it to you.
What I do have is a repeatable test case that you can run yourself.  I
believe I provided instructions on how to reproduce it.

If there is some sort of logging or debugging that I could turn on
that would allow you to see what the problem is, I would be happy to
do so.

-Dave

On 9/7/06, via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=20286">http://rt.cpan.org/Ticket/Display.html?id=20286</a></span> &gt;
&gt;
&gt; I&#39;m sorry, I can&#39;t fix a bug based on &#34;My app breaks when I use this&#34;. Please feel free to file a
&gt; bug report with a reasonable &#40;small&#41; example attached. Meanwhile I&#39;m rejecting this bug.
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;18:47:43&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:01:11&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You don&#39;t have a test case nor any idea of what is broken, just a potentially very large 
application that I have no idea what it&#39;s supposed to do, that may or may not have its own bugs. 
I&#39;m sorry, but I&#39;m just not going to dive into this.

Closing as rejected. Please do not reply to this bug unless you have a test case and a statement 
of what is broken.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:01:12&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:38:12&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 7 Sep 2006 16:37:58 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I must sincerely disagree.   Each of us needs to debug our own application.
You are asking that I debug yours.  I do have a test case.  Your module
always fails when I run the same set of queries against it.  I have no idea if
the problem is with your module or with SQLite.

If DBI had a way to record all calls to DBI and write them
out in a linear file, I am quite sure that the linear file of calls to
DBD::SQLite
would fail and that the same calls to DBD::SQLite2 would succeed.

The DBI tracing capability isn&#39;t good enough for what we need.  I can well
imagine writing a debug module that would instrument another module to
do exactly what I&#39;m suggesting.  I don&#39;t have the time to write such a
debugging module.

I apologize that you&#39;ll need to go change it to &#34;rejected&#34; again.

-Dave
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;19:38:13&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;02:28:40&nbsp;2006</span>
    <span class="description">ask [...] develooper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> ask [...] develooper.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Sep 07 19:38:12 2006, muir@idiom.com wrote:


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The DBI tracing capability isn&#39;t good enough for what we need.  I can
&gt; well
&gt; imagine writing a debug module that would instrument another module to
&gt; do exactly what I&#39;m suggesting.  I don&#39;t have the time to write such a
&gt; debugging module.
</div>
Huh?   How can you not make your test suite tell you where it fails and thus reproduce it?

&#40;or at least get some hints as to where to look&#41;.


 - ask
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;14:50:04&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Sep 2006 11:49:30 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 9/7/06, ask@develooper.com via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=20286">http://rt.cpan.org/Ticket/Display.html?id=20286</a></span> &gt;
&gt;
&gt; On Thu Sep 07 19:38:12 2006, muir@idiom.com wrote:
&gt;
&gt;
<div class="message-stanza open">&gt; &gt; The DBI tracing capability isn&#39;t good enough for what we need.  I can
&gt; &gt; well
&gt; &gt; imagine writing a debug module that would instrument another module to
&gt; &gt; do exactly what I&#39;m suggesting.  I don&#39;t have the time to write such a
&gt; &gt; debugging module.
</div>&gt;
&gt; Huh?   How can you not make your test suite tell you where it fails and thus reproduce it?
&gt;
&gt; &#40;or at least get some hints as to where to look&#41;.
&gt;
&gt;
&gt;  - ask
&gt;
&gt;
</div>
My test suite is testing a cross-product of operations.   I took
one of my tests that fails with DBI::SQLite and tried to shorten it.
After removing a bunch of tests, the remaining cross-product cannot
be shortened any more and still provode the DBI::SQLite failure.

On my system, today, my revised suite always fails after test # 6377
and before # 6378.

Interestingly, the values that I&#39;m testing with don&#39;t seem to matter.
What does seem to matter is the number of iterations through my test.
My suite can skip any number of initial tests to start in the middle.
If I do that, the failure point also moves.

Each cycle through my test suite I&#39;m probably making 150 calls to
the DBI layer.   I do know something about where it fails.  When I try
to do:

UPDATE charm1attribute
        SET pval = ?, ptype = ?
        WHERE id = ? AND pkey = ?

With values: 105, R, 104, nopkey

It fails with:

unable to open database file&#40;1&#41; at dbdimp.c line 398

To make debugging easier, I&#39;ve added code to my test suite so that
DBI tracing can be turned on not long before the failure rather than
at the beginning.

The revised suite is below.

-Dave

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">------------------------ cut here ---------------------
#!/usr/bin/perl -I../lib -I./..

my $dbi_trace_turnon = 6377;
my $dbi_trace_level = 4;

#
# Revised version of nulls.t from OOPS 1.005 cut down to
# show the DBI::SQLite problem.
#
# DBI::SQLite fails this after test # 6377
#

BEGIN {
        if &#40;$ENV{HARNESS_ACTIVE} &#38;&#38; ! $ENV{OOPSTEST_SLOW}&#41; {
                print &#34;1..0 # Skipped: run this by hand or set \$ENV{OOPSTEST_SLOW}\n&#34;;
                exit;
        }

        $OOPS::SelfFilter::defeat = 1
                unless defined $OOPS::SelfFilter::defeat;

        for my $m &#40;qw&#40;Data::Dumper Clone::PP&#41;&#41; {
                unless &#40; eval &#34; require $m &#34; &#41; {
                        print &#34;1..0 # Skipped: this test requires the $m module\n&#34;;
                        exit;
                }
                $m-&gt;import&#40;&#41;;
        }
}

use OOPS;
require Carp::Heavy;
use Carp qw&#40;confess&#41;;
use Scalar::Util qw&#40;reftype&#41;;
use strict;
use warnings;

use OOPS::TestCommon;

BEGIN   {
        unless &#40;$dbms eq &#39;sqlite&#39;&#41; {
                print &#34;1..0 # Skipped: this test is for DBD::SQLite only\n&#34;;
                exit;
        }
}

modern_data_compare&#40;&#41;;

import Clone::PP qw&#40;clone&#41;;

my $skipto = 0; # go directly to test number...

print &#34;1..7356\n&#34;;
my $debug2 = 0;
my $debug3 = 0;

resetall; # --------------------------------------------------
{
        my $realdebug = $debug;
        my $failures = &lt;&lt;&#39;END&#39;;
END
        #
        # flags:
        #
        #       V - try with virtual object and regular object
        #       h - set $key to various keys a hash might use
        #       a - set $key to various index an array might use
        #       v - replace $pval with potential values
        #
        my $tests = &lt;&lt;&#39;END&#39;;
                Vhv- $root-&gt;{$key} = $pval

END
        my %failures;
        for my $failure &#40;split&#40;/\n/, $failures&#41;&#41; {
                $failure =~ s/^\s+//;
                $failure =~ s/\s+$//;
                $failures{$failure} = 1;
                print &#34;# adding &#39;$failure&#39;\n&#34; if $debug2;
        }
        for my $test &#40;split&#40;/^\s*$/m, $tests&#41;&#41; {
                $test =~ s/\s*&#40;\S*&#41;-\s//s;
                my $flag = $1;

                my &#40;@virt&#41; = $flag =~ /V/
                        ? &#40;qw&#40;
                                virtual
                        &#41;&#41;
                        : &#40;0&#41;;
                my &#40;@key&#41; = &#40;0&#41;;

                if &#40;$flag =~ /h/&#41; {
                        @key = &#40;qw&#40;
                                &#39;x&#39;
                                &#39;x&#39;
                                &#39;x&#39;
                                &#39;x&#39;
                                &#39;x&#39;
                                &#39;x&#39;
                                &#39;x&#39;
                        &#41;&#41;;
                } elsif &#40;$flag =~ /a/&#41; {
                        @key = &#40;0..7&#41;;
                }


                no warnings qw&#40;syntax&#41;;
                my &#40;@val&#41; = $flag =~ /v/
                        ? &#40;qw&#40;
                                &#39;y&#39;
                                &#39;y&#39;
                                &#39;y&#39;
                                &#39;y&#39;
                                &#39;y&#39;
                                &#39;y&#39;
                                &#39;y&#39;
                        &#41;&#41;
                        : &#40; &#39;1&#39; &#41;;
                use warnings;

                my @skips = &#40;qw&#40;10 00 01 11&#41;&#41;;
                my @groups = &#40;&#39;onegroup&#39;, &#39;&#39;, &#39;manygroups&#39;&#41;;

                my $nodata_per_loop = count&#40;grep&#40;! /root/, @val&#41;&#41; / scalar&#40;@val&#41;;
                my $skippre_per_loop = count&#40;grep&#40;substr&#40;$_, 0, 1&#41;, @skips&#41;&#41; / scalar&#40;@skips&#41;;
                my $skippost_per_loop = 2 * count&#40;grep&#40;substr&#40;$_, 1, 1&#41;, @skips&#41;&#41; /
scalar&#40;@skips&#41;;
                my $loops = scalar&#40;@val&#41; * scalar&#40;@key&#41; * scalar&#40;@groups&#41; *
scalar&#40;@virt&#41; * scalar&#40;@skips&#41;;
                my $base_per_loop =
                        3                                       # resetall
                        + 2 * 2                                 # rcon
                        + &#40;&#40;$flag =~ /V/&#41; ? 1 : 0&#41;              # test vobj
                        + 1                                     # test unconditional
                        + 1                                     # notied
                        ;
                my $per_loop = $base_per_loop + $skippre_per_loop + $skippost_per_loop;
#               printf &#34;# per_loop = %d &#40; 9 + flag:%s + pre:%s + post:%s + nodata:%s &#41;\n&#34;,
#                       $per_loop,
#                       &#40;&#40;$flag =~ /V/&#41; ? 1 : 0&#41;,
#                       $skippre_per_loop,
#                       $skippost_per_loop,
#                       $nodata_per_loop;
                my $expected = $okay + $loops * &#40;$per_loop + $nodata_per_loop&#41;;
                if &#40;$expected &lt; $skipto&#41; {
                        $okay = $expected;
                        next;
                }

                for my $val &#40;@val&#41; {
                        $nodata_per_loop = &#40;$val =~ /root/&#41; ? 0 : 1;
                        my $loops = scalar&#40;@key&#41; * scalar&#40;@groups&#41; * scalar&#40;@virt&#41; * scalar&#40;@skips&#41;;
                        my $expected2 = $okay + $loops * &#40;$per_loop + $nodata_per_loop&#41;;
                        if &#40;$expected2 &lt; $skipto&#41; {
                                $okay = $expected2;
                                next;
                        }

                        for my $key &#40;@key&#41; {
                                my $loops = scalar&#40;@groups&#41; * scalar&#40;@virt&#41; * scalar&#40;@skips&#41;;
                                my $expected3 = $okay + $loops * &#40;$per_loop + $nodata_per_loop&#41;;
                                if &#40;$expected3 &lt; $skipto&#41; {
                                        $okay = $expected3;
                                        next;
                                }

                                my $sub;
                                my $e = &lt;&lt;END;
                                        \$sub = sub {
                                                my \$z = &#39;ov09&#39;x&#40;$ocut/4+1&#41;;
                                                my \$root = shift;
                                                my \$pval = $val;
                                                my \$key = $key;
                                                no warnings;
                                                $test
                                        }
END

                                eval $e;
                                die &#34;on $test/$val/$key ... &lt;&lt;$e&gt;&gt; ... $@&#34; if $@;

                                for my $skips &#40;@skips&#41; {
                                        my $skippre = substr&#40;$skips, 0, 1&#41;;
                                        my $skippost = substr&#40;$skips, 1, 1&#41;;

                                        my $loops = scalar&#40;@groups&#41; * scalar&#40;@virt&#41;;
                                        my $per_loop2 = $base_per_loop + $nodata_per_loop
                                                + &#40;$skippre ? 0 : 1&#41;
                                                + &#40;$skippost ? 0 : 2&#41;;
                                        my $expected4 = $okay + $loops * $per_loop2;
                                        if &#40;$expected4 &lt; $skipto&#41; {
                                                $okay = $expected4;
                                                next;
                                        }

                                        for my $groupmangle &#40;@groups&#41; {

                                                my $loops = scalar&#40;@virt&#41;;
                                                my $expected5 = $okay + $loops * $per_loop2;
                                                if &#40;$expected5 &lt; $skipto&#41; {
                                                        $okay = $expected5;
                                                        next;
                                                }

                                                for my $vobj &#40;@virt&#41; {

                                                        my $expected6 = $okay + $per_loop2;
                                                        if &#40;$expected6 &lt; $skipto&#41; {
                                                                $okay = $expected6;
                                                                next;
                                                        }
                                                        if &#40;$expected6 &gt;= $dbi_trace_turnon&#41; {
                                                                $OOPS::debug_dbi = $dbi_trace_level;
                                                        }
                                                        my $preok = $okay;

                                                        resetall;

                                                        die if $debug &#38;&#38; $okay != $preok + 3;

                                                        my $desc = &#34;$flag- $test: key=$key val=$val
V$vobj.S$skippre$skippost.G$groupmangle&#34;;
                                                        $desc =~ s/\A\s*&#40;.*?&#41;\s*\Z/$1/s;
                                                        $desc =~ s/\n\s*/\\n /g;
                                                        $debug = $failures{$desc}
                                                                ? 0
                                                                : $realdebug;
                                                        print &#34;# desc=&#39;$desc&#39; debug=$debug\n&#34;;

                                                        print &#34;# $desc\n&#34; if $debug;

                                                        my $rv = &#34;x\000x&#34;;
                                                        my $x = chr&#40;0&#41;x&#40;$ocut+1&#41;;
                                                        my $mroot = {
                                                                # the length of this array should match the flag =~ /a/ array
size of @key &#40;above&#41;.
                                                                &#39;&#39; =&gt; { skey2 =&gt; &#39;sval2&#39; },
                                                                undef =&gt; &#34;0 but true&#34;,
                                                                &#34;0&#34; =&gt; [ qw&#40;
                                                                        &#39;&#39;
                                                                        undef
                                                                        &#34;0\000&#34;
                                                                        &#34;0&#34;
                                                                        chr&#40;0&#41;
                                                                        &#34;With\000inside&#34;
                                                                        &#34;with\\back&#34;
                                                                        &#41;, &#39;&#34;0 but true&#34;&#39; ],
                                                                &#34;0 but true&#34; =&gt; \$rv,
                                                                &#34;0\000&#34; =&gt; \[ undef, &#34;0&#34;, chr&#40;0&#41; ],
                                                                chr&#40;0&#41; =&gt; \{ chr&#40;0&#41; =&gt; undef},
#                                                               &#34;With\000inside&#34; =&gt; \ &#40;scalar&#40;chr&#40;0&#41;x&#40;$ocut+1&#41;&#41;&#41;,
#XXX                                                            &#34;with\\back&#34; =&gt; \$x,
#XXX                                                            &#34;witH\\back&#34; =&gt; \$x,
                                                        };

                                                        $r1-&gt;{named_objects}{root} = clone&#40;$mroot&#41;;
                                                        $r1-&gt;virtual_object&#40;$r1-&gt;{named_objects}{root}, $vobj&#41; if $vobj;
                                                        $r1-&gt;commit;
                                                        nocon;
                                                        if &#40;$groupmangle&#41; {
                                                                groupmangle&#40;$groupmangle&#41;;
                                                        }
                                                        rcon;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2;

                                                        print &#34;#PROGRESS: BEFORE $desc\n&#34; if $debug2;

                                                        my $proot = $r1-&gt;{named_objects}{root};

                                                        test&#40;docompare&#40;$mroot, $proot&#41;, $desc&#41; unless $skippre;

                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41;;

                                                        print &#34;mroot before: &#34;.Dumper&#40;$mroot&#41;.&#34;\n&#34; if $debug3;

                                                        &#38;$sub&#40;$mroot&#41;;

                                                        print &#34;mroot after: &#34;.Dumper&#40;$mroot&#41;.&#34;\n&#34; if $debug3;
                                                        print &#34;#PROGRESS: PRE CHANGES: $desc\n&#34; if $debug2;
                                                        print &#34;proot before: &#34;.Dumper&#40;$proot&#41;.&#34;\n&#34; if $debug3;

                                                        print &#34;# EXECUTING: $desc\n&#34; if $debug;

                                                        &#38;$sub&#40;$proot&#41;;

                                                        print &#34;#PROGRESS: POST CHANGES: $desc\n&#34; if $debug2;
                                                        print &#34;proot after: &#34;.Dumper&#40;$proot&#41;.&#34;\n&#34; if $debug3;
                                                        print &#34;#PROGRESS: PRE COMPARE: $desc\n&#34; if $debug2;

                                                        test&#40;docompare&#40;$mroot, $proot&#41;, $desc&#41; unless $skippost;

                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 1&#41;;

                                                        print &#34;#PROGRESS: POST COMPARE, PRE COMMIT: $desc\n&#34; if $debug2;

                                                        $r1-&gt;commit;

                                                        print &#34;#PROGRESS: POST COMMIT, PRE COMPARE#2: $desc\n&#34; if $debug2;

                                                        test&#40;docompare&#40;$mroot, $proot&#41;, $desc&#41; unless $skippost;

                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41;;

                                                        print &#34;#PROGRESS: POST COMPARE#2, PRE RECONNECT: $desc\n&#34; if $debug2;

                                                        undef $proot;
                                                        rcon;
# our $xy = 1;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41; + 2;

                                                        my $qroot = $r1-&gt;{named_objects}{root};

                                                        print &#34;#PROGRESS: POST RECONNECT, PRE COMPARE #3: $desc\n&#34; if $debug2;

                                                        test&#40;docompare&#40;$mroot, $qroot&#41;, $desc&#41;;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41; + 2 +1;

                                                        print &#34;#PROGRESS: POST COMPARE #3, PRE DELETES: $desc\n&#34; if $debug2;

                                                        test&#40;!$vobj == !$r1-&gt;virtual_object&#40;$qroot&#41;, $desc&#41; if $flag =~ /V/;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41; + 2 + 1 + &#40;&#40;$flag =~ /V/&#41; ? 1 : 0&#41;;

                                                        nukevar&#40;$qroot, $mroot&#41;;
                                                        delete $r1-&gt;{named_objects}{root};

                                                        print &#34;#PROGRESS: POST DELETES, PRE COMMIT: $desc\n&#34; if $debug2;

                                                        $r1-&gt;commit;

                                                        print &#34;#PROGRESS: FINAL COMMIT DONE: $desc\n&#34; if $debug2;

                                                        undef $qroot;
                                                        nocon;

                                                        nodata unless $val =~ /root/;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41; + 2 + 1 + &#40;$flag =~ /V/ ? 1 : 0&#41; + &#40;&#40;$val =~
/root/&#41; ? 0 : 1&#41;;
                                                        notied&#40;$desc&#41;;
                                                        die if $debug &#38;&#38; $okay != $preok + 3 + 2 + &#40;$skippre ? 0 : 1&#41; +
&#40;$skippost ? 0 : 2&#41; + 2 + 1 + &#40;$flag =~ /V/ ? 1 : 0&#41; + &#40;&#40;$val =~
/root/&#41; ? 0 : 1&#41; + 1;

                                                        print &#34;#PROGRESS: DONE WITH TEST: $desc\n&#34; if $debug2;

                                                        print &#34;# okay: $okay expected6: $expected6\n&#34;;
                                                        die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected6;
                                                }
                                                print &#34;# okay: $okay expected5: $expected5\n&#34;;
                                                die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected5;
                                        }
                                        print &#34;# okay: $okay expected4: $expected4\n&#34;;
                                        die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected4;
                                }
                                print &#34;# okay: $okay expected3: $expected3\n&#34;;
                                die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected3;
                        }
                        print &#34;# okay: $okay expected2: $expected2\n&#34;;
                        die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected2;
                }
                print &#34;# okay: $okay expected: $expected\n&#34;;
                die &#34;bad prediction&#34; if $debug &#38;&#38; $okay != $expected;

        }
        $debug = $realdebug;
}

resetall; # --------------------------------------------------
print &#34;# ---------------------------- done
---------------------------\n&#34; if $debug;
$okay--;
print &#34;# tests: $okay\n&#34; if $debug;

exit 0; # ----------------------------------------------------

sub count
{
        return scalar&#40;@_&#41;;
}

1;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;15:19:29&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> MSERGEANT [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Perhaps it would help if I explained my dilemma in terms of how I read your bug report:

&#34;My application works fine if I use DBIx::Class for persistent storage, but fails if I use Class::DBI 
- download my application [here] and find the bug for me&#34;

It&#39;s HIGHLY likely given your report that this is a bug in how you&#39;re using DBI/DBD::SQLite rather 
than a bug in the library itself. But how would I know? I&#39;d have to delve right into the guts of 
OOPS to figure it out - and that&#39;s not a fair use of my time. I do this for free you know.

Figure out a small test case using just the DBI &#40;no OOPS&#41;, and it&#39;ll get fixed. Meanwhile I&#39;ll once 
again mark this as rejected :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;15:19:41&nbsp;2006</span>
    <span class="description">msergeant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;16:44:02&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Sep 2006 13:43:50 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No, it&#39;s not a bug in how I&#39;m using DBI.  OOPS works with
DBI::SQLite2, DBD::Pg, and DBD::mysql.  There is only a tiny bit of
OOPS that is different between the databases.

The test that is failing is essentialy:

    while&#40;1..10000&#41; {
      do static linear set of DBI calls
    }

With DBI::SQLIte only, it fails after 6377 iterations.

OOPS doesn&#39;t do anything fancy with DBI or SQL.   OOPS is pure perl.
OOPS stress the perl interpreter in various ways, so I have to admit
there is a possibility of the problem being a bug in perl rather than
DBD::SQLite.   OOPS has a very extensive test suite and in the process
of developing OOPS, I&#39;ve found a bunch of bugs in perl, memory leaks
in DBD::SQLite and DBD::SQLite2, and a deadlock detection bug in
mysql.

The particular problem that prompted this is a bug in DBD::SQLite or
the underling sqlite library.

-Dave

On 9/8/06, via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=20286">http://rt.cpan.org/Ticket/Display.html?id=20286</a></span> &gt;
&gt;
&gt; Perhaps it would help if I explained my dilemma in terms of how I read your bug report:
&gt;
&gt; &#34;My application works fine if I use DBIx::Class for persistent storage, but fails if I use Class::DBI
&gt; - download my application [here] and find the bug for me&#34;
&gt;
&gt; It&#39;s HIGHLY likely given your report that this is a bug in how you&#39;re using DBI/DBD::SQLite rather
&gt; than a bug in the library itself. But how would I know? I&#39;d have to delve right into the guts of
&gt; OOPS to figure it out - and that&#39;s not a fair use of my time. I do this for free you know.
&gt;
&gt; Figure out a small test case using just the DBI &#40;no OOPS&#41;, and it&#39;ll get fixed. Meanwhile I&#39;ll once
&gt; again mark this as rejected :-&#41;
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;16:44:03&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;rejected&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;17:39:22&nbsp;2006</span>
    <span class="description">link [...] redbrick.dcu.ie -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 08 16:44:02 2006, muir@idiom.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, it&#39;s not a bug in how I&#39;m using DBI.  OOPS works with
&gt; DBI::SQLite2, DBD::Pg, and DBD::mysql.  There is only a tiny bit of
&gt; OOPS that is different between the databases.
&gt; 
&gt; The test that is failing is essentialy:
&gt; 
&gt;     while&#40;1..10000&#41; {
&gt;       do static linear set of DBI calls
&gt;     }
&gt; 
</div>
If you reduced the test case to a small loop that did a few DBI calls
Matt would probably be a lot more interested in looking at it.


It looks like sqlite3pager_opentemp is leaking file handles &#40;well maybe
not leaking,my c is kinda weak but I asume if they were closed properly
they wouldn&#39;t cause the system per process limit to be hit&#41;. If you
increase your open files per process limit the tests will start passing.
There are several hundred closing dbh with active statement handles at
OOPS/TestCommon.pm line 600. warnings when I run t/scalarhash.t , maybe
they are related.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;17:44:08&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 8 Sep 2006 14:43:55 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">That&#39;s a great thought.   I think you&#39;ve found the bug.

I lowered my descriptor limit from 1024 to 300 and the test failed much sooner.

Thank you!

Meanwhile, I&#39;m part-way through writing an API tracing package so that
it&#39;s easy to turn any program that uses DBI into a list of calls to
DBI functions.

-Dave

On 9/8/06, Peter Sinnott via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=20286">http://rt.cpan.org/Ticket/Display.html?id=20286</a></span> &gt;
&gt;
&gt; On Fri Sep 08 16:44:02 2006, muir@idiom.com wrote:
<div class="message-stanza open">&gt; &gt; No, it&#39;s not a bug in how I&#39;m using DBI.  OOPS works with
&gt; &gt; DBI::SQLite2, DBD::Pg, and DBD::mysql.  There is only a tiny bit of
&gt; &gt; OOPS that is different between the databases.
&gt; &gt;
&gt; &gt; The test that is failing is essentialy:
&gt; &gt;
&gt; &gt;     while&#40;1..10000&#41; {
&gt; &gt;       do static linear set of DBI calls
&gt; &gt;     }
&gt; &gt;
</div>&gt;
&gt; If you reduced the test case to a small loop that did a few DBI calls
&gt; Matt would probably be a lot more interested in looking at it.
&gt;
&gt;
&gt; It looks like sqlite3pager_opentemp is leaking file handles &#40;well maybe
&gt; not leaking,my c is kinda weak but I asume if they were closed properly
&gt; they wouldn&#39;t cause the system per process limit to be hit&#41;. If you
&gt; increase your open files per process limit the tests will start passing.
&gt; There are several hundred closing dbh with active statement handles at
&gt; OOPS/TestCommon.pm line 600. warnings when I run t/scalarhash.t , maybe
&gt; they are related.
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;11&nbsp;17:45:19&nbsp;2006</span>
    <span class="description">link [...] redbrick.dcu.ie -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">If you add to OOPS::TestCommon inside check_refcount

        $actual = undef;
        $recorded = undef;

just before you disconnect then the tests pass. It looks like
calling finish does not correctly finish the statement. I presume
if the statements went out of scope before the dbh disconnected things
would get cleaned up properly. 

Looks like a new problem with 1.13 as my test program &#40;below&#41; works with
1.12.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">sqlite&gt; .schema
</div>CREATE TABLE whatever &#40; id int, something int &#41;;


use strict;
use warnings;

use DBI;

my %args = &#40;    &#34;dbi_dsn&#34;       =&gt; &#34;DBI:SQLite:dbname=stuff.db&#34;,
                &#34;user&#34;          =&gt; &#34;fake&#34;,
                &#34;password&#34;      =&gt; &#34;fake&#34;,
        &#41;;

my $database = $args{&#34;dbi_dsn&#34;};
my $user = $args{&#34;user&#34;};
my $password = $args{&#34;password&#34;};

foreach &#40; 1 .. 1000 &#41;
{
        foo&#40;&#41;;
}

sub foo
{
        my $dbh = DBI-&gt;connect&#40; $database , $user , $password , { Taint
=&gt; 0, PrintError =&gt; 0, RaiseError =&gt; 0, AutoCommit =&gt; 0} &#41;;
        unless&#40;$dbh&#41;
        {
                die $DBI::errstr;
        }

        my $sql = &#34;select id,count&#40;1&#41; from whatever where something = 1&#34;;
        my $actual = $dbh-&gt;prepare&#40;$sql&#41; || die $dbh-&gt;errstr;
        $actual-&gt;execute&#40;&#41; || die $actual-&gt;errstr;
        my &#40;%actual, %recorded&#41;;
        my &#40;$id, $count&#41;;

        while &#40;&#40;$id, $count&#41; = $actual-&gt;fetchrow_array&#40;&#41;&#41; {
                $id = &#34;1&#34; unless defined $id;
                $actual{$id} = $count;
        }

        $actual-&gt;finish;

#       $actual = undef;
        $dbh-&gt;disconnect;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;12&nbsp;14:10:14&nbsp;2006</span>
    <span class="description">muir [...] idiom.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #20286] DBD::SQLite can&#39;t do what DBD::SQLite2 can</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 12 Sep 2006 11:10:00 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;David Muir Sharnoff&#34; &lt;muir [...] idiom.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I did as you suggested and undef&#39;ed $actual and $recorded.  I don&#39;t
see any difference.  I&#39;ve set my file descriptor limit to just 100 and
my tests fail in eactly the same place with the undef and without it.

The problem is definately a file descriptor leak.  DBD::SQLite2
doesn&#39;t leak file descriptors but DBD::SQLite does.

-Dave

On 9/11/06, Peter Sinnott via RT &lt;bug-DBD-SQLite@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=20286">http://rt.cpan.org/Ticket/Display.html?id=20286</a></span> &gt;
&gt;
&gt; If you add to OOPS::TestCommon inside check_refcount
&gt;
&gt;         $actual = undef;
&gt;         $recorded = undef;
&gt;
&gt; just before you disconnect then the tests pass. It looks like
&gt; calling finish does not correctly finish the statement. I presume
&gt; if the statements went out of scope before the dbh disconnected things
&gt; would get cleaned up properly.
&gt;
&gt; Looks like a new problem with 1.13 as my test program &#40;below&#41; works with
&gt; 1.12.
&gt;
&gt;
<div class="message-stanza open">&gt; sqlite&gt; .schema
</div>&gt; CREATE TABLE whatever &#40; id int, something int &#41;;
&gt;
&gt;
&gt; use strict;
&gt; use warnings;
&gt;
&gt; use DBI;
&gt;
&gt; my %args = &#40;    &#34;dbi_dsn&#34;       =&gt; &#34;DBI:SQLite:dbname=stuff.db&#34;,
&gt;                 &#34;user&#34;          =&gt; &#34;fake&#34;,
&gt;                 &#34;password&#34;      =&gt; &#34;fake&#34;,
&gt;         &#41;;
&gt;
&gt; my $database = $args{&#34;dbi_dsn&#34;};
&gt; my $user = $args{&#34;user&#34;};
&gt; my $password = $args{&#34;password&#34;};
&gt;
&gt; foreach &#40; 1 .. 1000 &#41;
&gt; {
&gt;         foo&#40;&#41;;
&gt; }
&gt;
&gt; sub foo
&gt; {
&gt;         my $dbh = DBI-&gt;connect&#40; $database , $user , $password , { Taint
&gt; =&gt; 0, PrintError =&gt; 0, RaiseError =&gt; 0, AutoCommit =&gt; 0} &#41;;
&gt;         unless&#40;$dbh&#41;
&gt;         {
&gt;                 die $DBI::errstr;
&gt;         }
&gt;
&gt;         my $sql = &#34;select id,count&#40;1&#41; from whatever where something = 1&#34;;
&gt;         my $actual = $dbh-&gt;prepare&#40;$sql&#41; || die $dbh-&gt;errstr;
&gt;         $actual-&gt;execute&#40;&#41; || die $actual-&gt;errstr;
&gt;         my &#40;%actual, %recorded&#41;;
&gt;         my &#40;$id, $count&#41;;
&gt;
&gt;         while &#40;&#40;$id, $count&#41; = $actual-&gt;fetchrow_array&#40;&#41;&#41; {
&gt;                 $id = &#34;1&#34; unless defined $id;
&gt;                 $actual{$id} = $count;
&gt;         }
&gt;
&gt;         $actual-&gt;finish;
&gt;
&gt; #       $actual = undef;
&gt;         $dbh-&gt;disconnect;
&gt; }
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;03&nbsp;14:45:49&nbsp;2007</span>
    <span class="description">MUIR [...] cpan.org -  Subject changed from &#39;DBD::SQLite can&#39;t do what DBD::SQLite2 can&#39; to &#39;DBD::SQLite leaks file descriptors&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;11&nbsp;15:36:14&nbsp;2007</span>
    <span class="description">jmitchell [...] frb.gov -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jmitchell [...] frb.gov</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here is some more debug info &#40;using lsof&#41; regarding this problem:

1&#41;  Even if you $sth-&gt;finish handle and $dbh-&gt;disconnect, you get an
error message on the disconnect and the file remains open.

2&#41;  If you don&#39;t $sth-&gt;finish, you get an additional error message, and
the file stays open.

3&#41;  If the statement handle goes out of scope before the database
handle, everything seems to work as you&#39;d expect.

I doubt this is helpful, since I see from the correspondence that there
is no problem in 1.12, but there is no problem in 1.09 for me.

--Jeff Mitchell
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is the output from test.pl as written:

1: before connect
1: after connect
perl    28136 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
closing dbh with active statement handles at /tmp/test.pl line 40.
1: after disconnect
perl    28136 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3

2: before connect
perl    28136 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
2: after connect
perl    28136 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
perl    28136 [xxxxx]    4r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
closing dbh with active statement handles at /tmp/test.pl line 40.
2: after disconnect
perl    28136 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
perl    28136 [xxxxx]    4r   REG    8,5     2048     561 /tmp/test.sqlite3


This is the output with the $sth-&gt;finish on line 36 commented out:

1: before connect
1: after connect
perl    28267 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
DBI::db=HASH&#40;0x81b7490&#41;-&gt;disconnect invalidates 1 active statement handle &#40;either destroy statement handles or call finish on them before disconnecting&#41; at /tmp/test.pl line 40.
closing dbh with active statement handles at /tmp/test.pl line 40.
1: after disconnect
perl    28267 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3

2: before connect
perl    28267 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
2: after connect
perl    28267 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
perl    28267 [xxxxx]    4r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
DBI::db=HASH&#40;0x81ba6fc&#41;-&gt;disconnect invalidates 1 active statement handle &#40;either destroy statement handles or call finish on them before disconnecting&#41; at /tmp/test.pl line 40.
closing dbh with active statement handles at /tmp/test.pl line 40.
2: after disconnect
perl    28267 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
perl    28267 [xxxxx]    4r   REG    8,5     2048     561 /tmp/test.sqlite3


This is the output with the braces on lines 30 and 38 uncommented:

1: before connect
1: after connect
perl    28318 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
1: after disconnect

2: before connect
2: after connect
perl    28318 [xxxxx]    3r   REG    8,5     2048     561 /tmp/test.sqlite3
count: 5
2: after disconnect
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/opt/local/bin/perl

use strict;
use warnings;

use DBI;

my $file = &#34;/tmp/test.sqlite3&#34;;
$ENV{PATH} = &#34;/bin:/usr/sbin&#34;;

my $dbh = DBI-&gt;connect&#40;&#34;DBI:SQLite:dbname=$file&#34;, &#34;&#34;, &#34;&#34;&#41;;
{
  my $sth = $dbh-&gt;do&#40;q{DROP TABLE IF EXISTS t1}&#41;;
  my $sth2 = $dbh-&gt;do&#40;q{CREATE TABLE t1 &#40;c1 text&#41;}&#41;;
  my $sth3 = $dbh-&gt;prepare&#40;q{INSERT INTO t1 VALUES &#40;?&#41;}&#41;;
  for my $i &#40;1 .. 5&#41; {
    $sth3-&gt;execute&#40;$i&#41;;
  }
  $sth3-&gt;finish&#40;&#41;;
}
$dbh-&gt;disconnect&#40;&#41;;

my @dbh;
for my $i &#40;1 .. 2&#41; {
  print &#34;$i: before connect\n&#34;;
  print `lsof -p $$|grep test`;
  $dbh[$i] = DBI-&gt;connect&#40;&#34;DBI:SQLite:dbname=$file&#34;, &#34;&#34;, &#34;&#34;&#41;;
  print &#34;$i: after connect\n&#34;;
  print `lsof -p $$|grep test`;
#  {

    my $sth = $dbh[$i]-&gt;prepare&#40;q{SELECT count&#40;1&#41; from t1}&#41;;
    $sth-&gt;execute&#40;&#41;;
    my &#40;$count&#41; = $sth-&gt;fetchrow_array;
    print &#34;count: $count\n&#34;;
    $sth-&gt;finish&#40;&#41;;

#  }
  $dbh[$i]-&gt;disconnect&#40;&#41;;
  print &#34;$i: after disconnect\n&#34;;
  print `lsof -p $$|grep test`, &#34;\n&#34;;
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;11&nbsp;17:03:34&nbsp;2007</span>
    <span class="description">MUIR [...] cpan.org -  Fixed in 0.31 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;11&nbsp;17:03:34&nbsp;2007</span>
    <span class="description">MUIR [...] cpan.org -  Broken in 1.13 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;11&nbsp;17:06:31&nbsp;2007</span>
    <span class="description">MUIR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m not sure what you mean about there being no problem in 1.09 and
1.13.  I just tried 1.13 and it leaks like a seive.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;18:05:31&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve checked the final attached test case.

To the best of my knowledge, DBD::SQLite no longer leaks file handles.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;03&nbsp;18:05:44&nbsp;2009</span>
    <span class="description">adamk [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
