<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69743 for AnyEvent-HTTPD: Headers with default values misbehave when unexpected case is used</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69743 for AnyEvent-HTTPD: Headers with default values misbehave when unexpected case is used</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=AnyEvent-HTTPD">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=AnyEvent-HTTPD">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=AnyEvent-HTTPD">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=AnyEvent-HTTPD">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/AnyEvent-HTTPD">AnyEvent-HTTPD CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69743</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=AnyEvent-HTTPD">AnyEvent-HTTPD</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
encryptio [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-221730-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.92    </td>
  </tr>
  <tr id="CF-221731-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Handle-header-overrides-flexibly-including-removal.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/959955/499487/Handle-header-overrides-flexibly-including-removal.patch">
Mon Jul 25 06:41:51 2011 (8.5k) by encryptio [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=69743">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959596" href="/Public/Bug/Display.html?id=69743#txn-959596">#</a>      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;24&nbsp;21:25:13&nbsp;2011</span>
    <span class="description">encryptio [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Headers with default values misbehave when unexpected case is used</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/959596/499322/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499322">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 431b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Responding with headers whose case differ from the ones in the source 
for AnyEvent::HTTPD::HTTPConnection-&gt;response get duplicated.

Example:
$request-&gt;respond&#40;[200, &#39;OK&#39;, { &#39;cache-control&#39; =&gt; &#39;max-age=3600&#39; }, 
&#39;content&#39;]&#41;

Creates the response:
HTTP/1.0 200 OK
...
cache-control: max-age=3600
Cache-Control: max-age=0
...

This happens with all the headers with default values: Date, Expires, 
Cache-Control, and Content-Length.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959859" href="/Public/Bug/Display.html?id=69743#txn-959859">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;02:08:29&nbsp;2011</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69743] Headers with default values misbehave when unexpected case is used</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 25 Jul 2011 08:10:13 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Chris Kastorff via RT &lt;bug-AnyEvent-HTTPD [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Redeker &lt;elmex [...] ta-sa.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/959859/499433/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499433">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

On Sun, Jul 24, 2011 at 09:25:14PM -0400, Chris Kastorff via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sun Jul 24 21:25:13 2011: Request 69743 was acted upon.
&gt; Transaction: Ticket created by ENCRYPTIO
&gt;        Queue: AnyEvent-HTTPD
&gt;      Subject: Headers with default values misbehave when unexpected case is used
&gt;    Broken in: 0.92
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: encryptio@gmail.com
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=69743">https://rt.cpan.org/Ticket/Display.html?id=69743</a></span> &gt;
&gt; 
&gt; 
&gt; Responding with headers whose case differ from the ones in the source 
&gt; for AnyEvent::HTTPD::HTTPConnection-&gt;response get duplicated.
&gt; 
&gt; Example:
&gt; $request-&gt;respond&#40;[200, &#39;OK&#39;, { &#39;cache-control&#39; =&gt; &#39;max-age=3600&#39; }, 
&gt; &#39;content&#39;]&#41;
&gt; 
&gt; Creates the response:
&gt; HTTP/1.0 200 OK
&gt; ...
&gt; cache-control: max-age=3600
&gt; Cache-Control: max-age=0
&gt; ...
&gt; 
&gt; This happens with all the headers with default values: Date, Expires, 
&gt; Cache-Control, and Content-Length.
</div>
Oh, that seems to be quite bugged, yes. Can you make a patch? I&#39;m currently on
vacation, and if there is a patch when I can back, I can quickly apply it and
release a new version.

Thanks for the report!

Greetings,
   Robin

-- 
Robin Redeker                         | Deliantra, the free code+content MORPG
elmex@ta-sa.org / r.redeker@gmail.com | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ta-sa.org/">http://www.ta-sa.org/</a></span>                 |
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959861" href="/Public/Bug/Display.html?id=69743#txn-959861">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;02:08:30&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959955" href="/Public/Bug/Display.html?id=69743#txn-959955">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;06:41:51&nbsp;2011</span>
    <span class="description">encryptio [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/959955/499486/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499486">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 712b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I couldn&#39;t figure out a nice way to fix this and [rt #69744] in separate 
patches, so I did them both at once.

Code, POD, and regression tests included in this patch.

It doesn&#39;t seem to me like a final way to fix the problems performance-
wise, but it does fix the issues reliably. &#40;Each header_* operation in 
HTTPD::Util is O&#40;n&#41; on the number of headers, best possible is O&#40;1&#41; as 
implemented e.g. by LWP&#39;s HTTP::Headers&#41;

Also, there&#39;s a small semantic difference added: when the Content-Length 
header is removed, force Connection: close. I don&#39;t think this was a 
reachable glitch before. &#40;This is also tested, including an update to the 
test_connect routine in HTTPD::Util to time out after 15 seconds.&#41;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Handle-header-overrides-flexibly-including-removal.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/959955/499487/Handle-header-overrides-flexibly-including-removal.patch">Download Handle-header-overrides-flexibly-including-removal.patch</a><br />
<span class="downloadcontenttype">text/x-diff 8.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 561d01710448ba7b6287f1bc76bbb8b7454862c2 Mon Sep 17 00:00:00 2001
From: Chris Kastorff &lt;encryptio@gmail.com&gt;
Date: Mon, 25 Jul 2011 03:15:49 -0700
Subject: [PATCH] Handle header overrides flexibly, including removal

Fixes [rt #69744] [rt #69743]

Also adds support for tests failing due to timeout in
AnyEvent::HTTPD::Util &#40;needed for the tests to fail in previous
versions&#41;
---
 lib/AnyEvent/HTTPD.pm                |    5 ++-
 lib/AnyEvent/HTTPD/HTTPConnection.pm |   27 ++++++++-------
 lib/AnyEvent/HTTPD/Request.pm        |   10 ++++++
 lib/AnyEvent/HTTPD/Util.pm           |   53 +++++++++++++++++++++++++++++-
 t/14_header_unset.t                  |   59 ++++++++++++++++++++++++++++++++++
 5 files changed, 138 insertions&#40;+&#41;, 16 deletions&#40;-&#41;
 create mode 100644 t/14_header_unset.t

diff --git a/lib/AnyEvent/HTTPD.pm b/lib/AnyEvent/HTTPD.pm
index 5c9664c..3e2f60f 100644
--- a/lib/AnyEvent/HTTPD.pm
+++ b/lib/AnyEvent/HTTPD.pm
@@ -406,8 +406,9 @@ to your server or is disconnected from it.
 Any response from the HTTP server will have C&lt;Cache-Control&gt; set to C&lt;max-age=0&gt; and
 also the C&lt;Expires&gt; header set to the C&lt;Date&gt; header. Meaning: Caching is disabled.
 
-You can of course set those headers yourself in the response, but keep in mind
-that the default for those headers are like mentioned above.
+You can of course set those headers yourself in the response, or remove them by
+setting them to undef, but keep in mind that the default for those headers are
+like mentioned above.
 
 If you need more support here you can send me a mail or even better: a patch :&#41;
 
diff --git a/lib/AnyEvent/HTTPD/HTTPConnection.pm b/lib/AnyEvent/HTTPD/HTTPConnection.pm
index db99f62..3226930 100644
--- a/lib/AnyEvent/HTTPD/HTTPConnection.pm
+++ b/lib/AnyEvent/HTTPD/HTTPConnection.pm
@@ -110,23 +110,26 @@ sub response {
    return unless $self-&gt;{hdl};
 
    my $res = &#34;HTTP/1.0 $code $msg\015\012&#34;;
-   $hdr-&gt;{&#39;Date&#39;} = _time_to_http_date time
-      unless defined $hdr-&gt;{&#39;Date&#39;};
-   $hdr-&gt;{&#39;Expires&#39;} = $hdr-&gt;{&#39;Date&#39;}
-       unless defined $hdr-&gt;{&#39;Expires&#39;};
-   $hdr-&gt;{&#39;Cache-Control&#39;}  = &#34;max-age=0&#34;
-       unless defined $hdr-&gt;{&#39;Cache-Control&#39;};
-   $hdr-&gt;{&#39;Connection&#39;}     = $self-&gt;{keep_alive} ? &#39;Keep-Alive&#39; : &#39;close&#39;;
-
-   $hdr-&gt;{&#39;Content-Length&#39;} = length &#34;$content&#34;
-      if not &#40;defined $hdr-&gt;{&#39;Content-Length&#39;}&#41; &#38;&#38; not ref $content;
-
-   unless &#40;defined $hdr-&gt;{&#39;Content-Length&#39;}&#41; {
+   header_set $hdr, &#39;Date&#39; =&gt; _time_to_http_date time
+       unless header_exists $hdr, &#39;Date&#39;;
+   header_set $hdr, &#39;Expires&#39; =&gt; header_get $hdr, &#39;Date&#39;
+       unless header_exists $hdr, &#39;Expires&#39;;
+   header_set $hdr, &#39;Cache-Control&#39; =&gt; &#34;max-age=0&#34;
+       unless header_exists $hdr, &#39;Cache-Control&#39;;
+   header_set $hdr, &#39;Connection&#39; =&gt;
+                    &#40;$self-&gt;{keep_alive} ? &#39;Keep-Alive&#39; : &#39;close&#39;&#41;;
+
+   header_set $hdr, &#39;Content-Length&#39; =&gt; length &#34;$content&#34;
+      if not header_exists&#40;$hdr, &#39;Content-Length&#39;&#41; &#38;&#38; not ref $content;
+
+   unless &#40;defined header_get&#40;$hdr, &#39;Content-Length&#39;&#41;&#41; {
       # keep alive with no content length will NOT work.
       delete $self-&gt;{keep_alive};
+      header_set $hdr, &#39;Connection&#39; =&gt; &#39;close&#39;;
    }
 
    while &#40;my &#40;$h, $v&#41; = each %$hdr&#41; {
+      next if not defined $v;
       $res .= &#34;$h: $v\015\012&#34;;
    }
 
diff --git a/lib/AnyEvent/HTTPD/Request.pm b/lib/AnyEvent/HTTPD/Request.pm
index b41c9b5..215b3a6 100644
--- a/lib/AnyEvent/HTTPD/Request.pm
+++ b/lib/AnyEvent/HTTPD/Request.pm
@@ -49,6 +49,16 @@ Then the array reference has these elements:
    my &#40;$code, $message, $header_hash, $content&#41; =
          [200, &#39;ok&#39;, { &#39;Content-Type&#39; =&gt; &#39;text/html&#39; }, &#39;&lt;h1&gt;Test&lt;/h1&gt;&#39; }]
 
+You can remove most headers added by default &#40;like C&lt;Cache-Control&gt;, C&lt;Expires&gt;, and C&lt;Content-Length&gt;&#41; by setting them to undef, like so:
+
+   $req-&gt;respond&#40;[200, &#39;OK&#39;, {
+          &#39;Content-Type&#39; =&gt; &#39;text/html&#39;,
+          &#39;Cache-Control&#39; =&gt; &#39;max-age=3600&#39;,
+          &#39;Expires&#39; =&gt; undef,
+       },
+       &#39;This data will be cached for one hour.&#39;
+   ]&#41;;
+
 =item * a hash reference
 
 If it was a hash reference the hash is first searched for the C&lt;redirect&gt;
diff --git a/lib/AnyEvent/HTTPD/Util.pm b/lib/AnyEvent/HTTPD/Util.pm
index ec984f2..cf9029d 100644
--- a/lib/AnyEvent/HTTPD/Util.pm
+++ b/lib/AnyEvent/HTTPD/Util.pm
@@ -6,7 +6,7 @@ use common::sense;
 require Exporter;
 our @ISA = qw/Exporter/;
 
-our @EXPORT = qw/parse_urlencoded url_unescape/;
+our @EXPORT = qw/parse_urlencoded url_unescape header_set header_get header_exists/;
 
 =head1 NAME
 
@@ -59,7 +59,17 @@ sub test_connect {
 
          $hdl =
             AnyEvent::Handle-&gt;new &#40;
-               fh =&gt; $fh, on_eof =&gt; sub { $c-&gt;send &#40;$buf&#41; },
+               fh =&gt; $fh,
+               timeout =&gt; 15,
+               on_eof =&gt; sub {
+                   $c-&gt;send&#40;$buf&#41;;
+                   undef $hdl;
+               },
+               on_timeout =&gt; sub {
+                   warn &#34;test_connect timed out&#34;;
+                   $c-&gt;send&#40;$buf&#41;;
+                   undef $hdl;
+               },
                on_read =&gt; sub {
                   $buf .= $hdl-&gt;rbuf;
                   $hdl-&gt;rbuf = &#39;&#39;;
@@ -71,6 +81,45 @@ sub test_connect {
    $c
 }
 
+###
+# these functions set/get/check existence of a header name:value pair while
+# ignoring the case of the name
+#
+# quick hack, does not scale to large hashes. however, it&#39;s not expected to be
+# run on large hashes.
+#
+# a more performant alternative would be to keep two hashes for each set of
+# headers, one for the headers in the case they like, and one a mapping of
+# names from some consistent form &#40;say, all lowercase&#41; to the name in the other
+# hash, including capitalization. &#40;this style is used in HTTP::Headers&#41;
+
+sub header_set {
+    my &#40;$hdrs, $name, $value&#41; = @_;
+
+    my $lname = lc $name;
+    my &#40;$match_name&#41; = grep { lc eq $lname } keys %$hdrs;
+
+    $hdrs-&gt;{defined $match_name ? $match_name : $name} = $value;
+}
+
+sub header_get {
+    my &#40;$hdrs, $name&#41; = @_;
+
+    $name = lc $name;
+    my &#40;$match_name&#41; = grep { lc eq $name } keys %$hdrs;
+
+    return defined $match_name ? $hdrs-&gt;{$match_name} : undef;
+}
+
+sub header_exists {
+    my &#40;$hdrs, $name&#41; = @_;
+
+    $name = lc $name;
+    my &#40;$match_name&#41; = grep { lc eq $name } keys %$hdrs;
+
+    # NB: even if the value is undefined, return true
+    return defined $match_name;
+}
 
 =back
 
diff --git a/t/14_header_unset.t b/t/14_header_unset.t
new file mode 100644
index 0000000..8a9fa15
--- /dev/null
+++ b/t/14_header_unset.t
@@ -0,0 +1,59 @@
+#!perl
+use common::sense;
+use Test::More tests =&gt; 8;
+use AnyEvent::Impl::Perl;
+use AnyEvent;
+use AnyEvent::HTTPD;
+
+my $h = AnyEvent::HTTPD-&gt;new &#40;port =&gt; 19090&#41;;
+
+$h-&gt;reg_cb &#40;
+   &#39;/header-unset&#39; =&gt; sub {
+      my &#40;$httpd, $req&#41; = @_;
+      $req-&gt;respond &#40;[200, &#39;OK&#39;, {
+                        &#39;Cache-Control&#39; =&gt; undef,
+                        &#39;Expires&#39; =&gt; undef,
+                        &#39;Content-Length&#39; =&gt; undef,
+                    }, &#34;Test response&#34;]&#41;;
+   },
+   &#39;/header-override-lowercase&#39; =&gt; sub {
+      my &#40;$httpd, $req&#41; = @_;
+      $req-&gt;respond &#40;[200, &#39;OK&#39;, {
+                        &#39;cache-control&#39; =&gt; &#34;nonsensical&#34;,
+                    }, &#34;Test response&#34;]&#41;;
+   },
+   &#39;/header-override-uppercase&#39; =&gt; sub {
+      my &#40;$httpd, $req&#41; = @_;
+      $req-&gt;respond &#40;[200, &#39;OK&#39;, {
+                        &#39;CACHE-CONTROL&#39; =&gt; &#34;nonsensical&#34;,
+                    }, &#34;Test response&#34;]&#41;;
+   },
+&#41;;
+
+
+my $c1 = AnyEvent::HTTPD::Util::test_connect &#40;&#39;127.0.0.1&#39;, $h-&gt;port,
+            &#34;GET\040/header-unset\040HTTP/1.0\015\012Connection: Keep-Alive\015\012\015\012&#34;&#41;;
+my $c2 = AnyEvent::HTTPD::Util::test_connect &#40;&#39;127.0.0.1&#39;, $h-&gt;port,
+            &#34;GET\040/header-override-lowercase\040HTTP/1.0\015\012\015\012&#34;&#41;;
+my $c3 = AnyEvent::HTTPD::Util::test_connect &#40;&#39;127.0.0.1&#39;, $h-&gt;port,
+            &#34;GET\040/header-override-uppercase\040HTTP/1.0\015\012\015\012&#34;&#41;;
+my $r1 = $c1-&gt;recv;
+my $r2 = $c2-&gt;recv;
+my $r3 = $c3-&gt;recv;
+
+unlike&#40;$r1, qr/^expires:/im,        &#34;Can unset Expires header&#34;&#41;;
+unlike&#40;$r1, qr/^cache-control:/im,  &#34;Can unset Cache-Control header&#34;&#41;;
+unlike&#40;$r1, qr/^content-length:/im, &#34;Can unset Content-Length header&#34;&#41;;
+unlike&#40;$r1, qr/^connection:\s*close$/im,
+    &#34;Unsetting Content-Length implies no keep-alive&#34;&#41;;
+
+like&#40;$r2, qr/^cache-control:\s*nonsensical/im,
+    &#34;Cache-Control set with lowercase gets through&#34;&#41;;
+unlike&#40;$r2, qr/^cache-control:\s*max-age/im,
+    &#34;Cache-Control set with lowercase removes default header&#34;&#41;;
+
+like&#40;$r3, qr/^cache-control:\s*nonsensical/im,
+    &#34;Cache-Control set with uppercase gets through&#34;&#41;;
+unlike&#40;$r3, qr/^cache-control:\s*max-age/im,
+    &#34;Cache-Control set with uppercase removes default header&#34;&#41;;
+
-- 
1.7.6

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959957" href="/Public/Bug/Display.html?id=69743#txn-959957">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;06:41:52&nbsp;2011</span>
    <span class="description">encryptio [...] gmail.com -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-963527" href="/Public/Bug/Display.html?id=69743#txn-963527">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:47:16&nbsp;2011</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69743] Headers with default values misbehave when unexpected case is used</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 4 Aug 2011 10:49:38 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Chris Kastorff via RT &lt;bug-AnyEvent-HTTPD [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Robin Redeker &lt;elmex [...] ta-sa.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/963527/501411/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/501411">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Chris!

On Mon, Jul 25, 2011 at 06:41:51AM -0400, Chris Kastorff via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: AnyEvent-HTTPD
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=69743">https://rt.cpan.org/Ticket/Display.html?id=69743</a></span> &gt;
&gt; 
&gt; I couldn&#39;t figure out a nice way to fix this and [rt #69744] in separate 
&gt; patches, so I did them both at once.
&gt; 
&gt; Code, POD, and regression tests included in this patch.
&gt; 
&gt; It doesn&#39;t seem to me like a final way to fix the problems performance-
&gt; wise, but it does fix the issues reliably. &#40;Each header_* operation in 
&gt; HTTPD::Util is O&#40;n&#41; on the number of headers, best possible is O&#40;1&#41; as 
&gt; implemented e.g. by LWP&#39;s HTTP::Headers&#41;
</div>
I think thats ok for now. Sometimes, linear search of O&#40;n&#41; can be in fact
faster than a O&#40;1&#41; with a high overhead. But lets leave that benchmarking
for people where this really turns out to be a bottleneck.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also, there&#39;s a small semantic difference added: when the Content-Length 
&gt; header is removed, force Connection: close. I don&#39;t think this was a 
&gt; reachable glitch before. &#40;This is also tested, including an update to the 
&gt; test_connect routine in HTTPD::Util to time out after 15 seconds.&#41;
</div>
Sounds good to me. Just applied the patch &#40;with some minor code formatting
changes&#41; and pushed out a release. Version 0.93 is now on it&#39;s way
to cpan.


Thanks for the patch!

Greetings,
   Robin

-- 
Robin Redeker                         | Deliantra, the free code+content MORPG
elmex@ta-sa.org / r.redeker@gmail.com | <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.ta-sa.org/">http://www.ta-sa.org/</a></span>                 |
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-963529" href="/Public/Bug/Display.html?id=69743#txn-963529">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:47:17&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-963534" href="/Public/Bug/Display.html?id=69743#txn-963534">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:48:46&nbsp;2011</span>
    <span class="description">elmex [...] ta-sa.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/963534/501416/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/501416">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 82b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in version 0.93, which is on it&#39;s way to CPAN.

Thanks &#38; Greetings,
   Robin
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-963536" href="/Public/Bug/Display.html?id=69743#txn-963536">#</a>      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;04&nbsp;04:48:46&nbsp;2011</span>
    <span class="description">elmex [...] ta-sa.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.418472</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
