<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #15064 for HTML-TagFilter: Added feature: tag closure</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #15064 for HTML-TagFilter: Added feature: tag closure</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTML-TagFilter/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTML-TagFilter/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTML-TagFilter/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTML-TagFilter/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTML-TagFilter">HTML-TagFilter CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">15064</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">3 hours (180 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTML-TagFilter/Active/">HTML-TagFilter</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
miko [...] idocs.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-16044-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.091    </td>
  </tr>
  <tr id="CF-16045-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;16:25:59&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Added feature</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for HTML::TagFilter.  It&#39;s just what I need for a web application I&#39;m developing.

I&#39;ve modified the code to add a feature I need for the web app.  I wanted the ability to have the filter add end tags to the HTML where the end tags weren&#39;t originally in the code.  So, for example, if the following string is fed to the filter:

  &lt;i&gt;&lt;b&gt;my comment&lt;/b&gt;

&#40;notice lack of closing &lt;/i&gt;&#41; and if the require_end setting is set to true &#40;it isn&#39;t by default&#41; then the filter spits out the following output:

  &lt;i&gt;&lt;b&gt;my comment&lt;/b&gt;&lt;/i&gt;

I&#39;ve documented the code changes and the new feature.  I&#39;d like to submit my changes to see if you would like to include them in the next release.  Feel free to contact me if I can help in any way.  :-&#41;

-Miko
</div></div>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;18:21:29&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[guest - Fri Oct 14 16:25:59 2005]:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for HTML::TagFilter.  It&#39;s just what I need for a web
&gt;    application I&#39;m developing.
&gt; 
&gt; I&#39;ve modified the code to add a feature I need for the web app.  I
&gt;    wanted the ability to have the filter add end tags to the HTML
</div>
Thanks for this. I&#39;m very open to including this kind of functionality, but I don&#39;t think I can 
use the code you&#39;ve sent through. There&#39;s nothing wrong with the solution at all: it&#39;s just that 
it&#39;s not compatible with other work I&#39;ve been doing to try and create a filter that will work 
with tag pairs as well as single tags. 

Also, I think there&#39;s a better way. If I add a few simple hooks - probably in the form of 
triggers, so that subclassing is possible but not necessary - your code will factor out nicely, 
giving you a subclass with four subs roughly like this:

* on_start_document: initialise tag stack
* on_open_tag: push tag onto stack, unless closure isn&#39;t required
* on_close_tag: pull tag off stack, also closing any tags that have since been opened
* on_finish_document: close remaining unclosed tags

and perhaps a few more for configuration and reporting. Note that this will also close tags in 
roughly the right place, rather than waiting until the end of the document. 

How does that sound? I could do this in the next few days. &#40;Unlike tagfilter 2, which will be 
more like months.&#41;

best

will

ps. If I were you I would also try running your html through HTML::Tidy after &#40;or before&#41; it 
has been filtered. That ought to give you text that&#39;s both clean and correct.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;18:21:30&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;18:22:50&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Severity Wishlist added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;14&nbsp;18:22:50&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Subject changed from &#39;Added feature&#39; to &#39;Added feature: tag closure&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;16&nbsp;09:53:38&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">120 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve uploaded a new version of HTML::TagFilter. I&#39;ve used your tag-closing requirement as the 
main test case for the new trigger points, but with some minor improvements :&#41;

&#40;it now closes outstanding tags when it meets a close tag that was opened before they were, 
and omits a close tag that has not been opened, which should between them give you proper 
tag nesting&#41;

See what you think: sample code is attached here. Unless any glitches show up, I&#39;ll probably end 
up making this part of the normal functionality of the filter.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use HTML::TagFilter;

my $filter = HTML::TagFilter-&gt;new&#40;
	log_rejects =&gt; 0,
	strip_comments =&gt; 1,
	on_start_document =&gt; \&#38;on_start_document,
	on_open_tag =&gt; \&#38;on_open_tag,
	on_close_tag =&gt; \&#38;on_close_tag,
	on_finish_document =&gt; \&#38;on_finish,
&#41;;

print $filter-&gt;filter&#40;qq|&lt;p&gt;Mother, &lt;strong&gt;I can feel the &lt;b&gt;&lt;i&gt;soil&lt;/i&gt;&lt;/b&gt; falling over my &lt;em&gt;head&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;|&#41; . &#34;\n\n&#34;;

sub on_start {
	my &#40;$self, $rawtext&#41; = @_;
	$self-&gt;{_tag_stack} = [];
	return;
}

sub on_open_tag {
	my &#40;$self, $tag, $attributes, $sequence&#41; = @_;
	push @{ $self-&gt;{_tag_stack} }, $$tag unless grep {$_ eq $$tag} qw&#40;img br hr meta link&#41;;
	return;
}

sub on_close_tag {
	my &#40;$self, $tag&#41; = @_;
	unless &#40;@{ $self-&gt;{_tag_stack} } &#38;&#38; grep {$_ eq $$tag} @{ $self-&gt;{_tag_stack} }&#41; {
		undef ${ $tag };
		return;
	}
	my @unclosed;
	while &#40;my $lasttag = pop @{ $self-&gt;{_tag_stack} }&#41;  {
		return join &#39;&#39;, map &#34;&lt;/$_&gt;&#34;, @unclosed if $lasttag eq $$tag;
		push @unclosed, $lasttag;
	}
}

sub on_finish {
	my $self = shift;
	return unless @{ $self-&gt;{_tag_stack} };
	return join &#39;&#39;, map &#34;&lt;/$_&gt;&#34;, reverse @{ $self-&gt;{_tag_stack} };
}</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;10:19:13&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">60 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">[following further conversation by email]

Version 1.02 of the tagfilter, which I&#39;ve just uploaded, allows trigger functionality to be supplied 
either as coderefs during construction or as subroutines in subclass. A minimal subclass of 
HTML::TagFilter is attached that will repair tag closure and ordering. This bug is therefore 
closed, I hope?

will
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">package MyFilter;
use strict;

use base qw&#40;HTML::TagFilter&#41;;

# on_start_document adds a tag stack to the object hashref, ie a list of tags encountered.

sub on_start_document {
	my &#40;$self, $rawtext&#41; = @_;
	$self-&gt;{_tag_stack} = [];
	return;
};

# on_open_tag pushes the tag name onto the tag stack

sub on_open_tag {
	my &#40;$self, $tag, $attributes, $sequence&#41; = @_;
	push @{ $self-&gt;{_tag_stack} }, $$tag unless grep {$_ eq $$tag} qw&#40;img br hr meta link&#41;;
	return;
};

# on_close_tag checks the tag stack. If this tag is open, it closes any other tags that have been opened since this one was. If it is not open, the present tag is made undef: it will not be closed.

sub on_close_tag {
	my &#40;$self, $tag&#41; = @_;
	unless &#40;@{ $self-&gt;{_tag_stack} } &#38;&#38; grep {$_ eq $$tag} @{ $self-&gt;{_tag_stack} }&#41; {
		undef ${ $tag };
		return;
	}
	my @unclosed;
	while &#40;my $lasttag = pop @{ $self-&gt;{_tag_stack} }&#41;  {
		return join &#39;&#39;, map &#34;&lt;/$_&gt;&#34;, @unclosed if $lasttag eq $$tag;
		push @unclosed, $lasttag;
	}
};

# on_finish_document closes any tags that remain on the stack in the proper order.

sub on_finish_document {
	my &#40;$self, $cleantext&#41; = @_;
	return join &#39;&#39;, map &#34;&lt;/$_&gt;&#34;, reverse @{ $self-&gt;{_tag_stack} };
};</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;07&nbsp;10:19:14&nbsp;2005</span>
    <span class="description">wross [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
