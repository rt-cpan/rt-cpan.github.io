<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #129918 for IO-Async: Enhancement suggestion: simple priority for IO::Async::Function calls</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #129918 for IO-Async: Enhancement suggestion: simple priority for IO::Async::Function calls</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Async">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Async">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Async">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Async">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Async">IO-Async CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">129918</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Async">IO-Async</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
futuramedium [...] yandex.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-42614-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-42615-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.74    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




priority.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1853778/995970/priority.patch">
Wed Jun 26 06:47:56 2019 (2k) by futuramedium [...] yandex.ru
</a>
</font></li>
</ul>


rt129918.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1853878/996017/rt129918.patch">
Thu Jun 27 13:38:44 2019 (3.5k) by leonerd-cpan [...] leonerd.org.uk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=129918">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853778" href="/Public/Bug/Display.html?id=129918#txn-1853778">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;26&nbsp;06:47:56&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Enhancement suggestion: simple priority for IO::Async::Function calls</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853778/995969/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/995969">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 61b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Very simple, 2-level priority control, please see patch file.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> priority.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853778/995970/priority.patch">Download priority.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Function.pm.orig	Wed Jun 12 18:57:20 2019
+++ Function.pm	Wed Jun 26 13:19:58 2019
@@ -55,10 +55,11 @@
 The object represents the function code itself, rather than one specific
 invocation of it. It can be called multiple times, by the C&lt;call&gt; method.
 Multiple outstanding invocations can be called; they will be dispatched in
-the order they were queued. If only one worker process is used then results
-will be returned in the order they were called. If multiple are used, then
-each request will be sent in the order called, but timing differences between
-each worker may mean results are returned in a different order.
+the order they were queued; C&lt;urgent&gt; parameter, if supplied, determines call 
+placement at start or end of queue. If only one worker process is used then 
+results will be returned in the order they were queued. If multiple are used, 
+then each request will be sent in the order queued, but timing differences 
+between each worker may mean results are returned in a different order. 
 
 Since the code block will be called multiple times within the same child
 process, it must take care not to modify any of its state that might affect
@@ -329,6 +330,10 @@
 
 A reference to the array of arguments to pass to the code.
 
+=item urgent =&gt; BOOL
+
+Optional. If true, call is placed at start of queue.
+
 =back
 
 If the function body returns normally the list of results are provided as the
@@ -403,6 +408,8 @@
 
    my $args = delete $params{args};
    ref $args eq &#34;ARRAY&#34; or croak &#34;Expected &#39;args&#39; to be an array&#34;;
+   
+   my $urgent = delete $params{urgent};
 
    my &#40; $on_done, $on_fail &#41;;
    if&#40; defined $params{on_result} &#41; {
@@ -440,7 +447,9 @@
    }
    else {
       $self-&gt;debug_printf&#40; &#34;QUEUE&#34; &#41;;
-      push @{ $self-&gt;{pending_queue} }, my $wait_f = $self-&gt;loop-&gt;new_future;
+      my $wait_f = $self-&gt;loop-&gt;new_future;
+      $urgent ? unshift @{ $self-&gt;{pending_queue} }, $wait_f
+              : push @{ $self-&gt;{pending_queue} }, $wait_f;
 
       $future = $wait_f-&gt;then&#40; sub {
          my &#40; $self, $worker &#41; = @_;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853781" href="/Public/Bug/Display.html?id=129918#txn-1853781">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;26&nbsp;07:07:00&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853781/995973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/995973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 988b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 26 06:47:56 2019, vadimr wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Very simple, 2-level priority control, please see patch file.
</div>
Mm, an exciting idea.

One thought though, is that this implementation `unshift`s the urgent items, meaning that if you make a few urgent calls in sequence, they&#39;ll be invoked in the reverse order to how you submitted them.

Perhaps it would be better to store the urgent flag in the queue as well, and insert new urgent calls just before the first non-urgent one, so a sequence of a few urgent ones will go in the right order.

At which point it&#39;s not much of a stretch of imagination to extend this to more than two levels - just have a &#34;priority&#34; field that&#39;s compared numerically; defaults to zero. Any new calls get inserted just before the first call of numerically-lower value.

I keep meaning to move such logic into a more abstract &#34;Future::Queue&#34; and have IaFunction just use that actually.

See also

  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=124774">https://rt.cpan.org/Ticket/Display.html?id=124774</a></span>

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853782" href="/Public/Bug/Display.html?id=129918#txn-1853782">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;26&nbsp;07:07:00&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853789" href="/Public/Bug/Display.html?id=129918#txn-1853789">#</a>      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;26&nbsp;10:17:25&nbsp;2019</span>
    <span class="description">futuramedium [...] yandex.ru -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853789/995976/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/995976">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 748b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I was looking at <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/List::PriorityQueue">https://metacpan.org/pod/List::PriorityQueue</a></span> to &#34;steal&#34; implementation, but overhead of added code can be unwelcome by those who don&#39;t need the feature, and hardly ever more than 3 levels of priority are required. Then I thought about 3 different queues, push into appropriate array according to supplied &#34;priority&#34; parameter 0,1,2 or default, and dequeue simply as

my $next = shift @{ $self-&gt;{pending_queue_0} } or
           shift @{ $self-&gt;{pending_queue_1} } or
           shift @{ $self-&gt;{pending_queue_2} }
           
or similar, simple and minimal overhead. Then thought it too clunky and suggested patch as above. But with issue you pointed at &#40;urgent calls getting &#34;stale&#34;&#41;, perhaps 2 or 3 arrays would still be better.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853858" href="/Public/Bug/Display.html?id=129918#txn-1853858">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;27&nbsp;08:13:23&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853858/996007/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/996007">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 303b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">You wouldn&#39;t need anything too fancy. An application of `List::Util::first` would find the insert point:

  my $queue = $self-&gt;{queue};

  my $idx = first { $queue-&gt;[$_]-&gt;{prio} &lt; $prio } 0 .. $#$queue;
  splice @$queue, $idx // scalar @$queue, 0, &#40; $newitem &#41;;

This is a sorted insert

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853878" href="/Public/Bug/Display.html?id=129918#txn-1853878">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;27&nbsp;13:38:44&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853878/996016/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/996016">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 347b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Actually, having looked again at the code it doesn&#39;t seem very easy to turn it into a Future::Queue, even if such module did exist, but just adding the priority logic didn&#39;t seem too hard.

Patch attached.

You can implement your existing `urgent` logic by just providing some positive value for `priority` - even just 1 would do.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt129918.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1853878/996017/rt129918.patch">Download rt129918.patch</a><br />
<span class="downloadcontenttype">text/x-diff 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;Build.PL&#39;
--- Build.PL	2018-04-02 18:45:51 +0000
+++ Build.PL	2019-06-27 17:38:03 +0000
@@ -11,6 +11,7 @@
       &#39;Exporter&#39; =&gt; &#39;5.57&#39;,
       &#39;File::stat&#39; =&gt; 0,
       &#39;IO::Poll&#39; =&gt; 0,
+      &#39;List::Util&#39; =&gt; 0,
       &#39;Socket&#39; =&gt; &#39;2.007&#39;,
       &#39;Storable&#39; =&gt; 0,
       &#39;Struct::Dumb&#39; =&gt; 0,

=== modified file &#39;lib/IO/Async/Function.pm&#39;
--- lib/IO/Async/Function.pm	2019-06-12 15:52:23 +0000
+++ lib/IO/Async/Function.pm	2019-06-27 17:38:03 +0000
@@ -1,7 +1,7 @@
 #  You may distribute under the terms of either the GNU General Public License
 #  or the Artistic License &#40;the same terms as Perl itself&#41;
 #
-#  &#40;C&#41; Paul Evans, 2011-2016 -- leonerd@leonerd.org.uk
+#  &#40;C&#41; Paul Evans, 2011-2019 -- leonerd@leonerd.org.uk
 
 package IO::Async::Function;
 
@@ -15,6 +15,12 @@
 
 use Carp;
 
+use List::Util qw&#40; first &#41;;
+
+use Struct::Dumb qw&#40; readonly_struct &#41;;
+
+readonly_struct Pending =&gt; [qw&#40; priority f &#41;];
+
 =head1 NAME
 
 C&lt;IO::Async::Function&gt; - call a function asynchronously
@@ -329,6 +335,15 @@
 
 A reference to the array of arguments to pass to the code.
 
+=item priority =&gt; NUM
+
+Optional. Defines the sorting order when no workers are available and calls
+must be queued for later. A default of zero will apply if not provided.
+
+Higher values cause the call to be considered more important, and will be
+placed earlier in the queue than calls with a smaller value. Calls of equal
+priority are still handled in FIFO order.
+
 =back
 
 If the function body returns normally the list of results are provided as the
@@ -440,7 +455,20 @@
    }
    else {
       $self-&gt;debug_printf&#40; &#34;QUEUE&#34; &#41;;
-      push @{ $self-&gt;{pending_queue} }, my $wait_f = $self-&gt;loop-&gt;new_future;
+      my $queue = $self-&gt;{pending_queue};
+
+      my $next = Pending&#40;
+         my $priority = $params{priority} || 0,
+         my $wait_f = $self-&gt;loop-&gt;new_future,
+      &#41;;
+
+      if&#40; $priority &#41; {
+         my $idx = first { $queue-&gt;[$_]-&gt;priority &lt; $priority } 0 .. $#$queue;
+         splice @$queue, $idx // $#$queue+1, 0, &#40; $next &#41;;
+      }
+      else {
+         push @$queue, $next;
+      }
 
       $future = $wait_f-&gt;then&#40; sub {
          my &#40; $self, $worker &#41; = @_;
@@ -576,10 +604,12 @@
    while&#40; my $next = shift @{ $self-&gt;{pending_queue} } &#41; {
       my $worker = $self-&gt;_get_worker or return;
 
-      next if $next-&gt;is_cancelled;
+      my $f = $next-&gt;f;
+
+      next if $f-&gt;is_cancelled;
 
       $self-&gt;debug_printf&#40; &#34;UNQUEUE&#34; &#41;;
-      $next-&gt;done&#40; $self, $worker &#41;;
+      $f-&gt;done&#40; $self, $worker &#41;;
       return;
    }
 

=== modified file &#39;t/42function.t&#39;
--- t/42function.t	2015-07-31 19:02:02 +0000
+++ t/42function.t	2019-06-27 17:38:03 +0000
@@ -131,6 +131,34 @@
    $loop-&gt;remove&#40; $function &#41;;
 }
 
+# Queue priority
+{
+   my $serial = 0;
+   my $function = IO::Async::Function-&gt;new&#40;
+      # Keep exactly 1 process so captured lexical works for testing
+      min_workers =&gt; 1,
+      max_workers =&gt; 1,
+      code =&gt; sub { return $serial++ },
+   &#41;;
+
+   $loop-&gt;add&#40; $function &#41;;
+
+   # Push something just to make the function busy first
+   $function-&gt;call&#40; args =&gt; [], on_return =&gt; sub {}, on_error =&gt; sub {} &#41;;
+
+   my $f = Future-&gt;needs_all&#40;
+      $function-&gt;call&#40; args =&gt; [] &#41;, # no priority
+      $function-&gt;call&#40; args =&gt; [], priority =&gt; 1 &#41;,
+      $function-&gt;call&#40; args =&gt; [], priority =&gt; 1 &#41;,
+      $function-&gt;call&#40; args =&gt; [], priority =&gt; 2 &#41;,
+   &#41;;
+
+   is_deeply&#40; [ &#40; wait_for_future $f &#41;-&gt;get ],
+      [ 4, 2, 3, 1 ], &#39;$function-&gt;call with priority enqueues correctly&#39; &#41;;
+
+   $loop-&gt;remove&#40; $function &#41;;
+}
+
 # References
 {
    my $function = IO::Async::Function-&gt;new&#40;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1853880" href="/Public/Bug/Display.html?id=129918#txn-1853880">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;27&nbsp;13:38:45&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1872529" href="/Public/Bug/Display.html?id=129918#txn-1872529">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:41:21&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1872529/1005299/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/1005299">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 42b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was released in 0.74

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1872531" href="/Public/Bug/Display.html?id=129918#txn-1872531">#</a>      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:41:21&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1872533" href="/Public/Bug/Display.html?id=129918#txn-1872533">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;23&nbsp;12:41:21&nbsp;2019</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.74 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.48586</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
