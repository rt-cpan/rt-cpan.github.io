<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #85013 for Log-Dispatch: Log::Dispatch::Syslog is not thread-safe</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #85013 for Log-Dispatch: Log::Dispatch::Syslog is not thread-safe</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Log-Dispatch">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Log-Dispatch">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Log-Dispatch">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Log-Dispatch">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/houseabsolute/Log-Dispatch/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Log-Dispatch">Log-Dispatch CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">85013</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Log-Dispatch">Log-Dispatch</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
cedric.carree [...] mancalanetworks.com

<br />
fry [...] open.ch

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-19400-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.35</li>
<li>
2.36</li>
<li>
2.37</li>
<li>
2.38</li>
<li>
2.39</li>
</ul>
    </td>
  </tr>
  <tr id="CF-19401-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.42    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




Log-Dispatch-2.39.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1207788/637690/Log-Dispatch-2.39.patch">
Fri May 03 03:29:15 2013 (902b) by daa [...] open.ch
</a>
</font></li>
</ul>


syslog-thread.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/931633/483571/syslog-thread.pl">
Fri May 06 08:36:24 2011 (673b) by cedric.carree [...] mancalanetworks.com
</a>
</font></li>
</ul>


Syslog.pm.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/931633/483570/Syslog.pm.patch">
Fri May 06 08:36:24 2011 (690b) by cedric.carree [...] mancalanetworks.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=85013">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931633" href="/Public/Bug/Display.html?id=85013#txn-931633">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;08:36:24&nbsp;2011</span>
    <span class="description">cedric.carree [...] mancalanetworks.com - Ticket #67988:  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Log::Dispatch::Syslog isn&#39;t thread-safe</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 6 May 2011 14:36:06 +0200 &#40;CEST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Log-Dispatch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Cedric Carree &lt;cedric.carree [...] mancalanetworks.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/931633/483568/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483568">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 9.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi. 


Using Perl 5.6.0 threads, the Log::Dispatch::Syslog may SEGV. This is maybe a bug on Sys::Syslog rather than Log::Dispatch::Syslog 
I think this is because Sys::Syslog tries to open and/or close twice the connection to syslog &#40;in two differents threads&#41;. 


Here are the traces I got running my test script &#40;attached&#41; 
cedric.carree@me:~$ perl syslog-thread.pl 
Attempt to free unreferenced scalar: SV 0x916ed78, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Thread 3 terminated abnormally: The following parameter was passed in the call to Log::Dispatch::Output::log but was not listed in the validation options: log4p_level 
at /usr/share/perl5/Log/Dispatch/Output.pm line 30 thread 3 
Log::Dispatch::Output::log&#40;undef, &#39;level&#39;, 1, &#39;name&#39;, &#39;app001&#39;, &#39;message&#39;, &#39;INFO - In thread 3\x{a}&#39;, &#39;log4p_category&#39;, &#39;thread-test&#39;, ...&#41; called at /usr/share/perl5/Log/Log4perl/Appender.pm line 212 thread 3 
Log::Log4perl::Appender::log&#40;&#39;Log::Log4perl::Appender=HASH&#40;0xb6cd93c8&#41;&#39;, &#39;HASH&#40;0x91d0668&#41;&#39;, &#39;thread-test&#39;, &#39;INFO&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 301 thread 3 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0xb6cd8f68&#41;&#39;, &#39;In thread 3&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 782 thread 3 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0xb6cd8f68&#41;&#39;, &#39;In thread 3&#39;&#41; called at syslog-thread.pl line 34 thread 3 
main::log_me&#40;3&#41; called at syslog-thread.pl line 22 thread 3 
eval {...} called at syslog-thread.pl line 22 thread 3 
Attempt to free unreferenced scalar: SV 0x916ef08, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x91dd898, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 30. 
Attempt to free unreferenced scalar: SV 0x93be410, Perl interpreter: 0x91de938 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x9754128, Perl interpreter: 0x916fc98 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x916ecb8, Perl interpreter: 0x937c2e0 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x916e9c8, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0xb6b83d20, Perl interpreter: 0x937c2e0 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0xb6b83d20, Perl interpreter: 0x937c2e0 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x916ec88, Perl interpreter: 0x91de938 at /usr/share/perl5/Log/Dispatch/Output.pm line 30. 
Thread 4 terminated abnormally: The following parameter was passed in the call to Log::Dispatch::Output::log but was not listed in the validation options: log4p_level 
at /usr/share/perl5/Log/Dispatch/Output.pm line 30 thread 4 
Log::Dispatch::Output::log&#40;undef, &#39;level&#39;, 1, &#39;name&#39;, &#39;app001&#39;, &#39;message&#39;, &#39;INFO - In thread 4\x{a}&#39;, &#39;log4p_category&#39;, &#39;thread-test&#39;, ...&#41; called at /usr/share/perl5/Log/Log4perl/Appender.pm line 212 thread 4 
Log::Log4perl::Appender::log&#40;&#39;Log::Log4perl::Appender=HASH&#40;0x9308828&#41;&#39;, &#39;HASH&#40;0x93be1a0&#41;&#39;, &#39;thread-test&#39;, &#39;INFO&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 301 thread 4 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0x93083c8&#41;&#39;, &#39;In thread 4&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 782 thread 4 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0x93083c8&#41;&#39;, &#39;In thread 4&#39;&#41; called at syslog-thread.pl line 34 thread 4 
main::log_me&#40;4&#41; called at syslog-thread.pl line 22 thread 4 
eval {...} called at syslog-thread.pl line 22 thread 4 
Attempt to free unreferenced scalar: SV 0xb6b83c40, Perl interpreter: 0x916fc98 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0x9584b50, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 34. 
Attempt to free unreferenced scalar: SV 0xb6b83d60, Perl interpreter: 0x8eb2c68 at /usr/share/perl5/Log/Dispatch/Output.pm line 30. 
Attempt to free unreferenced scalar: SV 0xb6b83ef0, Perl interpreter: 0x916fc98 at /usr/share/perl5/Log/Dispatch/Output.pm line 30. 
Thread 1 terminated abnormally: The following parameter was passed in the call to Log::Dispatch::Output::log but was not listed in the validation options: log4p_level 
at /usr/share/perl5/Log/Dispatch/Output.pm line 30 thread 1 
Log::Dispatch::Output::log&#40;undef, &#39;level&#39;, 1, &#39;name&#39;, &#39;app001&#39;, &#39;message&#39;, &#39;INFO - In thread 1\x{a}&#39;, &#39;log4p_category&#39;, &#39;thread-test&#39;, ...&#41; called at /usr/share/perl5/Log/Log4perl/Appender.pm line 212 thread 1 
Log::Log4perl::Appender::log&#40;&#39;Log::Log4perl::Appender=HASH&#40;0x90d9070&#41;&#39;, &#39;HASH&#40;0x916e8a8&#41;&#39;, &#39;thread-test&#39;, &#39;INFO&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 301 thread 1 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0x90d8c10&#41;&#39;, &#39;In thread 1&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 782 thread 1 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0x90d8c10&#41;&#39;, &#39;In thread 1&#39;&#41; called at syslog-thread.pl line 34 thread 1 
main::log_me&#40;1&#41; called at syslog-thread.pl line 22 thread 1 
eval {...} called at syslog-thread.pl line 22 thread 1 
Thread 2 terminated abnormally: The following parameter was passed in the call to Log::Dispatch::Output::log but was not listed in the validation options: log4p_level 
at /usr/share/perl5/Log/Dispatch/Output.pm line 30 thread 2 
Log::Dispatch::Output::log&#40;undef, &#39;level&#39;, 1, &#39;name&#39;, &#39;app001&#39;, &#39;message&#39;, &#39;INFO - In thread 2\x{a}&#39;, &#39;log4p_category&#39;, &#39;thread-test&#39;, ...&#41; called at /usr/share/perl5/Log/Log4perl/Appender.pm line 212 thread 2 
Log::Log4perl::Appender::log&#40;&#39;Log::Log4perl::Appender=HASH&#40;0xb6dee720&#41;&#39;, &#39;HASH&#40;0xb6b83990&#41;&#39;, &#39;thread-test&#39;, &#39;INFO&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 301 thread 2 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0xb6dee2c0&#41;&#39;, &#39;In thread 2&#39;&#41; called at /usr/share/perl5/Log/Log4perl/Logger.pm line 782 thread 2 
Log::Log4perl::Logger::__ANON__&#40;&#39;Log::Log4perl::Logger=HASH&#40;0xb6dee2c0&#41;&#39;, &#39;In thread 2&#39;&#41; called at syslog-thread.pl line 34 thread 2 
main::log_me&#40;2&#41; called at syslog-thread.pl line 22 thread 2 
eval {...} called at syslog-thread.pl line 22 thread 2 
Segmentation fault 


my system is &#40;uname -a&#41; 

Linux lindesktop21 2.6.32-31-generic #61-Ubuntu SMP Fri Apr 8 18:24:35 UTC 2011 i686 GNU/Linux 


My Perl version is 

Summary of my perl5 &#40;revision 5 version 10 subversion 1&#41; configuration: 

Platform: 
osname=linux, osvers=2.6.24-28-server, archname=i486-linux-gnu-thread-multi 
uname=&#39;linux roseapple 2.6.24-28-server #1 smp wed aug 18 21:17:51 utc 2010 i686 gnulinux &#39; 
config_args=&#39;-Dusethreads -Duselargefiles -Dccflags=-DDEBIAN -Dcccdlflags=-fPIC -Darchname=i486-linux-gnu -Dprefix=/usr -Dprivlib=/usr/share/perl/5.10 -Darchlib=/usr/lib/perl/5.10 -Dvendorprefix=/usr -Dvendorlib=/usr/share/perl5 -Dvendorarch=/usr/lib/perl5 -Dsiteprefix=/usr/local -Dsitelib=/usr/local/share/perl/5.10.1 -Dsitearch=/usr/local/lib/perl/5.10.1 -Dman1dir=/usr/share/man/man1 -Dman3dir=/usr/share/man/man3 -Dsiteman1dir=/usr/local/man/man1 -Dsiteman3dir=/usr/local/man/man3 -Dman1ext=1 -Dman3ext=3perl -Dpager=/usr/bin/sensible-pager -Uafs -Ud_csh -Ud_ualarm -Uusesfio -Uusenm -DDEBUGGING=-g -Doptimize=-O2 -Duseshrplib -Dlibperl=libperl.so.5.10.1 -Dd_dosuid -des&#39; 
hint=recommended, useposix=true, d_sigaction=define 
useithreads=define, usemultiplicity=define 
useperlio=define, d_sfio=undef, uselargefiles=define, usesocks=undef 
use64bitint=undef, use64bitall=undef, uselongdouble=undef 
usemymalloc=n, bincompat5005=undef 
Compiler: 
cc=&#39;cc&#39;, ccflags =&#39;-D_REENTRANT -D_GNU_SOURCE -DDEBIAN -fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64&#39;, 
optimize=&#39;-O2 -g&#39;, 
cppflags=&#39;-D_REENTRANT -D_GNU_SOURCE -DDEBIAN -fno-strict-aliasing -pipe -fstack-protector -I/usr/local/include&#39; 
ccversion=&#39;&#39;, gccversion=&#39;4.4.3&#39;, gccosandvers=&#39;&#39; 
intsize=4, longsize=4, ptrsize=4, doublesize=8, byteorder=1234 
d_longlong=define, longlongsize=8, d_longdbl=define, longdblsize=12 
ivtype=&#39;long&#39;, ivsize=4, nvtype=&#39;double&#39;, nvsize=8, Off_t=&#39;off_t&#39;, lseeksize=8 
alignbytes=4, prototype=define 
Linker and Libraries: 
ld=&#39;cc&#39;, ldflags =&#39; -fstack-protector -L/usr/local/lib&#39; 
libpth=/usr/local/lib /lib /usr/lib /usr/lib64 
libs=-lgdbm -lgdbm_compat -ldb -ldl -lm -lpthread -lc -lcrypt 
perllibs=-ldl -lm -lpthread -lc -lcrypt 
libc=/lib/libc-2.11.1.so, so=so, useshrplib=true, libperl=libperl.so.5.10.1 
gnulibc_version=&#39;2.11.1&#39; 
Dynamic Linking: 
dlsrc=dl_dlopen.xs, dlext=so, d_dlsymun=undef, ccdlflags=&#39;-Wl,-E&#39; 
cccdlflags=&#39;-fPIC&#39;, lddlflags=&#39;-shared -O2 -g -L/usr/local/lib -fstack-protector&#39; 




Characteristics of this binary &#40;from libperl&#41;: 
Compile-time options: MULTIPLICITY PERL_DONT_CREATE_GVSV 
PERL_IMPLICIT_CONTEXT PERL_MALLOC_WRAP USE_ITHREADS 
USE_LARGE_FILES USE_PERLIO USE_REENTRANT_API 
Built under linux 
Compiled at Apr 22 2011 18:17:20 
@INC: 
/etc/perl 
/usr/local/lib/perl/5.10.1 
/usr/local/share/perl/5.10.1 
/usr/lib/perl5 
/usr/share/perl5 
/usr/lib/perl/5.10 
/usr/share/perl/5.10 
/usr/local/lib/site_perl 





I attached a patch. It loads the threads module if Perl was compiled with the ithreads options, then it locks before openning connection to syslog. 


Best regards 
Cedric 
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931633/483569/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483569">with headers</a>
<br />
<span class="downloadcontenttype">text/html 13.2k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931633/483570/Syslog.pm.patch">Download Syslog.pm.patch</a><br />
<span class="downloadcontenttype">text/x-diff 690b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931633/483571/syslog-thread.pl">Download syslog-thread.pl</a><br />
<span class="downloadcontenttype">text/x-perl 673b</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931687" href="/Public/Bug/Display.html?id=85013#txn-931687">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;11:08:40&nbsp;2011</span>
    <span class="description">autarch [...] urth.org - Ticket #67988:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67988] Log::Dispatch::Syslog isn&#39;t thread-safe </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 6 May 2011 10:08:31 -0500 &#40;CDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Cedric Carree via RT &lt;bug-Log-Dispatch [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Dave Rolsky &lt;autarch [...] urth.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931687/483613/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483613">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 636b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 6 May 2011, Cedric Carree via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Using Perl 5.6.0 threads, the Log::Dispatch::Syslog may SEGV. This is maybe a bug on Sys::Syslog rather than Log::Dispatch::Syslog
&gt; I think this is because Sys::Syslog tries to open and/or close twice the connection to syslog &#40;in two differents threads&#41;.
</div>
You say 5.6.0 but you&#39;re using Perl 5.10.1. I assume you don&#39;t mean 5.6.0.


-dave

/*============================================================
<span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span>               <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
Your guide to all that&#39;s veg      House Absolute&#40;ly Pointless&#41;
============================================================*/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931690" href="/Public/Bug/Display.html?id=85013#txn-931690">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;11:08:41&nbsp;2011</span>
    <span class="description">The RT System itself - Ticket #67988:  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-931701" href="/Public/Bug/Display.html?id=85013#txn-931701">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;06&nbsp;11:38:10&nbsp;2011</span>
    <span class="description">cedric.carree [...] mancalanetworks.com - Ticket #67988:  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #67988] Log::Dispatch::Syslog isn&#39;t thread-safe</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 6 May 2011 17:37:53 +0200 &#40;CEST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Log-Dispatch [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Cedric Carree &lt;cedric.carree [...] mancalanetworks.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/931701/483620/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/483620">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 946b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I would say &#34;perl threads as defined since Perl 5.6.0, not perl threads as defined in Perl 5.005&#34;

Otherwise I should have say that I&#39;m using rsyslog 4.2.0-2ubuntu8.1 and Log::Dispatch::Syslog 2.29.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">----- Original Message -----
<div class="message-stanza open">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=67988">http://rt.cpan.org/Ticket/Display.html?id=67988</a></span> &gt;
&gt; 
&gt; On Fri, 6 May 2011, Cedric Carree via RT wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; Using Perl 5.6.0 threads, the Log::Dispatch::Syslog may SEGV. This
&gt; &gt; is maybe a bug on Sys::Syslog rather than Log::Dispatch::Syslog
&gt; &gt; I think this is because Sys::Syslog tries to open and/or close twice
&gt; &gt; the connection to syslog &#40;in two differents threads&#41;.
</div>&gt; 
&gt; You say 5.6.0 but you&#39;re using Perl 5.10.1. I assume you don&#39;t mean
&gt; 5.6.0.
&gt; 
&gt; 
&gt; -dave
&gt; 
&gt; /*============================================================
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://VegGuide.org">http://VegGuide.org</a></span> <span class="clickylink"><a target="new" rel="nofollow" href="http://blog.urth.org">http://blog.urth.org</a></span>
&gt; Your guide to all that&#39;s veg House Absolute&#40;ly Pointless&#41;
&gt; ============================================================*/
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1207788" href="/Public/Bug/Display.html?id=85013#txn-1207788">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;03&nbsp;03:29:15&nbsp;2013</span>
    <span class="description">daa [...] open.ch -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Log::Dispatch::Syslog is not thread-safe</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1207788/637689/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/637689">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Dear Log-Dispatch maintainers,

Recently, I have encountered several problems with a multi-threading application using logging mechanisms through Log::Any inside my worker threads. Log::Any will be dispatched through Log::Dispatch::Syslog to write to UNIX syslog.

The parallel logging caused various errors and warnings such as:

    - Segmentation faults,
    - Scalars leaked warnings,
    - and various memory leaks.

Here is an example of an error-context under valgrind:
==23949== Invalid read of size 1
==23949==    at 0x4128C7A: _IO_default_xsputn &#40;genops.c:479&#41;
==23949==    by 0x4125A7A: fputs_unlocked &#40;iofputs_u.c:40&#41;
==23949==    by 0x418AC83: __vsyslog_chk &#40;syslog.c:207&#41;
==23949==    by 0x418B165: syslog &#40;syslog.c:119&#41;
==23949==    by 0x5AB0D3E: XS_Sys__Syslog_syslog_xs &#40;in /.../lib/5.14.0/i686-linux-thread-multi/auto/Sys/Syslog/Syslog.so&#41;
==23949==    by 0x80E2C40: Perl_pp_entersub &#40;in /.../bin/perl&#41;
==23949==    by 0x80D9F97: Perl_runops_standard &#40;in /.../bin/perl&#41;
==23949==    by 0x807372B: Perl_call_sv &#40;in /.../bin/perl&#41;
==23949==    by 0x4E42AB3: S_ithread_run &#40;in /.../lib/5.14.0/i686-linux-thread-multi/auto/threads/threads.so&#41;
==23949==    by 0x40ADEED: start_thread &#40;pthread_create.c:301&#41;
==23949==    by 0x418EB1D: clone &#40;clone.S:133&#41;
==23949==  Address 0x5d5b852 is 2 bytes inside a block of size 20 free&#39;d
==23949==    at 0x4024953: free &#40;in /.../valgrind/lib/valgrind/vgpreload_memcheck-x86-linux.so&#41;
==23949==    by 0x80E8E09: Perl_sv_clear &#40;in /.../bin/perl&#41;
==23949==    by 0x80E96A9: Perl_sv_free2 &#40;in /.../bin/perl&#41;
==23949==    by 0x5AAFFBD: XS_Sys__Syslog_closelog_xs &#40;in /.../lib/5.14.0/i686-linux-thread-multi/auto/Sys/Syslog/Syslog.so&#41;
==23949==    by 0x80E2C40: Perl_pp_entersub &#40;in /.../bin/perl&#41;
==23949==    by 0x80D9F97: Perl_runops_standard &#40;in /.../bin/perl&#41;
==23949==    by 0x80792EB: perl_run &#40;in /.../bin/perl&#41;
==23949==    by 0x805CB5C: main &#40;in /.../bin/perl&#41;
&#40;Note: I shortened the lib path for convenience&#41;.

The segmentation fault errors differ from a run to another, same holds for leaked scalars, however, memory leaks &#40;analyzed with Valgrind&#41; are happening in every run.

I encountered the issue when dispatching Log::Any to Log::Dispatch::Syslog. However, when dispatching to Log::Dispatch::Screen, every run is error-free and warning-free.

I came across an old ticket, never closed, which faced the same issue as I am &#40;id=67988&#41;: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=67988">https://rt.cpan.org/Public/Bug/Display.html?id=67988</a></span> .
The author of the ticket, Cedric Caree, proposed a patch &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Attachment/931633/483570/Syslog.pm.patch&#41;">https://rt.cpan.org/Ticket/Attachment/931633/483570/Syslog.pm.patch&#41;</a></span> that fixed my issue. Quoting Cedric, the patch &#34;loads the threads module if Perl was compiled with the ithreads options, then it locks before opening connection to syslog.&#34;. Cedric also provides some testing script to reproduce the issue.
To my understanding, the error is being caused when concurrent log_message happen in Log::Dispatch::Syslog. No concurrency mechanism would prevent these concurrent calls to happen. Therefore, a locking of log_message sounds reasonable.

I am using following perl version: Perl v5.14.0 built for i686-linux-thread-multi.
I am using following version of Log::Dispatch: v2.35.
I am using following version of Sys::Syslog: v0.27.

At the moment, I maintain this patch for Log-Dispatch-2.35. However, it would be much easier to me in the future if you could integrate this fix to the current version of the module and release a new one.

If you have any further question, don&#39;t hesitate to contact me.

Kind regards,
Franck

--
franck youssef
junior engineer
open systems ag

fry@open.ch
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.ch">http://www.open.ch</a></span>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Log-Dispatch-2.39.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1207788/637690/Log-Dispatch-2.39.patch">Download Log-Dispatch-2.39.patch</a><br />
<span class="downloadcontenttype">text/x-diff 902b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -rupN Log-Dispatch-2.39.orig/lib/Log/Dispatch/Syslog.pm Log-Dispatch-2.39.patched/lib/Log/Dispatch/Syslog.pm
--- Log-Dispatch-2.39.orig/lib/Log/Dispatch/Syslog.pm	2013-04-21 16:40:14.000000000 +0200
+++ Log-Dispatch-2.39.patched/lib/Log/Dispatch/Syslog.pm	2013-05-02 16:09:12.000000000 +0200
@@ -15,6 +15,17 @@ Params::Validate::validation_options&#40; al
 
 use Sys::Syslog 0.25 &#40;&#41;;
 
+use Config;
+
+my $locker; #thread locker
+BEGIN {
+    if &#40; $Config{useithreads} &#41; {
+        use threads;
+        use threads::shared;
+        share&#40;$locker&#41;;
+    }
+}
+
 sub new {
     my $proto = shift;
     my $class = ref $proto || $proto;
@@ -83,6 +94,8 @@ sub log_message {
     my $pri = $self-&gt;_level_as_number&#40; $p{level} &#41;;
 
     eval {
+        lock&#40;$locker&#41; if &#40; $Config{useithreads} &#41;;
+
         Sys::Syslog::openlog&#40;
             $self-&gt;{ident}, $self-&gt;{logopt},
             $self-&gt;{facility}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397724" href="/Public/Bug/Display.html?id=85013#txn-1397724">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;12:43:29&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org - Ticket #67988:  Merged into ticket #85013</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397725" href="/Public/Bug/Display.html?id=85013#txn-1397725">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;12:43:29&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org -  Merged into ticket #85013</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397726" href="/Public/Bug/Display.html?id=85013#txn-1397726">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;12:45:15&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397726/742066/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/742066">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 03 03:29:15 2013, daa wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Dear Log-Dispatch maintainers,
&gt; 
&gt; Recently, I have encountered several problems with a multi-threading
&gt; application using logging mechanisms through Log::Any inside my worker
&gt; threads. Log::Any will be dispatched through Log::Dispatch::Syslog to
&gt; write to UNIX syslog.
&gt; 
&gt; The parallel logging caused various errors and warnings such as:
&gt; 
&gt; - Segmentation faults,
&gt; - Scalars leaked warnings,
&gt; - and various memory leaks.
&gt; 
&gt; Here is an example of an error-context under valgrind:
&gt; ==23949== Invalid read of size 1
&gt; ==23949==    at 0x4128C7A: _IO_default_xsputn &#40;genops.c:479&#41;
&gt; ==23949==    by 0x4125A7A: fputs_unlocked &#40;iofputs_u.c:40&#41;
&gt; ==23949==    by 0x418AC83: __vsyslog_chk &#40;syslog.c:207&#41;
&gt; ==23949==    by 0x418B165: syslog &#40;syslog.c:119&#41;
&gt; ==23949==    by 0x5AB0D3E: XS_Sys__Syslog_syslog_xs &#40;in
&gt; /.../lib/5.14.0/i686-linux-thread-multi/auto/Sys/Syslog/Syslog.so&#41;
&gt; ==23949==    by 0x80E2C40: Perl_pp_entersub &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x80D9F97: Perl_runops_standard &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x807372B: Perl_call_sv &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x4E42AB3: S_ithread_run &#40;in /.../lib/5.14.0/i686-
&gt; linux-thread-multi/auto/threads/threads.so&#41;
&gt; ==23949==    by 0x40ADEED: start_thread &#40;pthread_create.c:301&#41;
&gt; ==23949==    by 0x418EB1D: clone &#40;clone.S:133&#41;
&gt; ==23949==  Address 0x5d5b852 is 2 bytes inside a block of size 20
&gt; free&#39;d
&gt; ==23949==    at 0x4024953: free &#40;in
&gt; /.../valgrind/lib/valgrind/vgpreload_memcheck-x86-linux.so&#41;
&gt; ==23949==    by 0x80E8E09: Perl_sv_clear &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x80E96A9: Perl_sv_free2 &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x5AAFFBD: XS_Sys__Syslog_closelog_xs &#40;in
&gt; /.../lib/5.14.0/i686-linux-thread-multi/auto/Sys/Syslog/Syslog.so&#41;
&gt; ==23949==    by 0x80E2C40: Perl_pp_entersub &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x80D9F97: Perl_runops_standard &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x80792EB: perl_run &#40;in /.../bin/perl&#41;
&gt; ==23949==    by 0x805CB5C: main &#40;in /.../bin/perl&#41;
&gt; &#40;Note: I shortened the lib path for convenience&#41;.
&gt; 
&gt; The segmentation fault errors differ from a run to another, same holds
&gt; for leaked scalars, however, memory leaks &#40;analyzed with Valgrind&#41; are
&gt; happening in every run.
&gt; 
&gt; I encountered the issue when dispatching Log::Any to
&gt; Log::Dispatch::Syslog. However, when dispatching to
&gt; Log::Dispatch::Screen, every run is error-free and warning-free.
&gt; 
&gt; I came across an old ticket, never closed, which faced the same issue
&gt; as I am &#40;id=67988&#41;:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=67988">https://rt.cpan.org/Public/Bug/Display.html?id=67988</a></span> .
&gt; The author of the ticket, Cedric Caree, proposed a patch
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Attachment/931633/483570/Syslog.pm.patch&#41;">https://rt.cpan.org/Ticket/Attachment/931633/483570/Syslog.pm.patch&#41;</a></span>
&gt; that fixed my issue. Quoting Cedric, the patch &#34;loads the threads
&gt; module if Perl was compiled with the ithreads options, then it locks
&gt; before opening connection to syslog.&#34;. Cedric also provides some
&gt; testing script to reproduce the issue.
&gt; To my understanding, the error is being caused when concurrent
&gt; log_message happen in Log::Dispatch::Syslog. No concurrency mechanism
&gt; would prevent these concurrent calls to happen. Therefore, a locking
&gt; of log_message sounds reasonable.
&gt; 
&gt; I am using following perl version: Perl v5.14.0 built for i686-linux-
&gt; thread-multi.
&gt; I am using following version of Log::Dispatch: v2.35.
&gt; I am using following version of Sys::Syslog: v0.27.
&gt; 
&gt; At the moment, I maintain this patch for Log-Dispatch-2.35. However,
&gt; it would be much easier to me in the future if you could integrate
&gt; this fix to the current version of the module and release a new one.
&gt; 
&gt; If you have any further question, don&#39;t hesitate to contact me.
</div>
Franck, thanks for the bug report, and sorry it&#39;s taken so long for me to respond.

I don&#39;t think this patch is a good idea, since it loads threads even in programs that are not using them. I think it might be better to simply add a thread option to the syslog logger output constructor params so it only locks when requested to.

I&#39;ll add this for the next release.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397727" href="/Public/Bug/Display.html?id=85013#txn-1397727">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;12:45:16&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397730" href="/Public/Bug/Display.html?id=85013#txn-1397730">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;12:55:22&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #85013] Log::Dispatch::Syslog is not thread-safe</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 12 Aug 2014 09:55:14 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Dave Rolsky via RT &lt;bug-Log-Dispatch [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Karen Etheridge &lt;ether [...] cpan.org&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397730/742069/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/742069">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 612b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Aug 12, 2014 at 12:45:16PM -0400, Dave Rolsky via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t think this patch is a good idea, since it loads threads even in programs that are not using them. I think it might be better to simply add a thread option to the syslog logger output constructor params so it only locks when requested to.
&gt; 
&gt; I&#39;ll add this for the next release.
</div>
Isn&#39;t the problem simply that one logger object is being used across
multiple threads? In that case, simply create a new one in each thread.
&#40;I ran into similar issues myself, which is how
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Object::ForkAware">https://metacpan.org/pod/Object::ForkAware</a></span> came to be written.&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1397748" href="/Public/Bug/Display.html?id=85013#txn-1397748">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;12&nbsp;13:52:40&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1397748/742078/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/742078">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 838b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Aug 12 12:55:22 2014, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, Aug 12, 2014 at 12:45:16PM -0400, Dave Rolsky via RT wrote:
<div class="message-stanza open">&gt; &gt; I don&#39;t think this patch is a good idea, since it loads threads even
&gt; &gt; in programs that are not using them. I think it might be better to
&gt; &gt; simply add a thread option to the syslog logger output constructor
&gt; &gt; params so it only locks when requested to.
&gt; &gt;
&gt; &gt; I&#39;ll add this for the next release.
</div>&gt; 
&gt; Isn&#39;t the problem simply that one logger object is being used across
&gt; multiple threads? In that case, simply create a new one in each
&gt; thread.
&gt; &#40;I ran into similar issues myself, which is how
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Object::ForkAware">https://metacpan.org/pod/Object::ForkAware</a></span> came to be written.&#41;
</div>
Karen, the issue is the calls to openlog, syslog, and closelog. These aren&#39;t scoped to an object, they&#39;re global &#40;syslog just has a very old school API&#41;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1402908" href="/Public/Bug/Display.html?id=85013#txn-1402908">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;24&nbsp;12:14:07&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1402910" href="/Public/Bug/Display.html?id=85013#txn-1402910">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;24&nbsp;12:14:07&nbsp;2014</span>
    <span class="description">DROLSKY [...] cpan.org -  Fixed in 2.42 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.696918</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
