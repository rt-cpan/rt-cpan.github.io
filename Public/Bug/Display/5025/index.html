<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #5025 for Mail-Thread: Two bugs in &#34;_group_set_bysubject&#34;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #5025 for Mail-Thread: Two bugs in &#34;_group_set_bysubject&#34;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Mail-Thread/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Mail-Thread/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Mail-Thread/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Mail-Thread/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Mail-Thread">Mail-Thread CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">5025</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Mail-Thread/Active/">Mail-Thread</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jonas [...] truls.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-20146-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.41    </td>
  </tr>
  <tr id="CF-20147-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;25&nbsp;17:33:18&nbsp;2004</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Two bugs in &#34;_group_set_bysubject&#34;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Two bugs found in Mail::Thread&#39;s &#34;_group_set_bysubject&#34;. I&#39;ve attached a patch with my &#34;fixes&#34;.

1: &#34;_group_set_bysubject&#34; would crash when all messages in a thread didn&#39;t have the same subject. This happened because when populating a hash with subjects, only the &#34;topmost&#34; subject for each container in the rootset was included. This lead to &#34;_group_set_bysubject&#34; trying to work on undefined objects because it fetches objects from the poorly populated subject hash. My fix is simply a recursive collection of *all* subjects into the hash instead of just the topmost ones. To do this, I created Mail::Thread::Container-&gt;_populate_hash_with_subjects&#40;&#41; wich expects a hash reference as parameter.

2: &#34;_group_set_bysubject&#34; sometimes misplaces containers. This happens when it is &#34;removing the &#34;second&#34; message from the root set&#34;. I really don&#39;t know why this happens, so I put an ugly workaround int the code. Actually fixing the bug would of course be better, but I don&#39;t know what it is.

3: Not a bug at all. Just a change that suits me. I&#39;ve made Mail::Thread::Container-&gt;simple_subject&#40;&#41; be a bit more brutal in order to be able to thread by subject for mailing lists and messges created by software where the &#34;Re:&#34; has been localized &#40;for example, some swedish translations of Lookout Express uses &#34;Sv:&#34; instead of &#34;Re:&#34;.

Notes:

I started programming perl just a few months ago. My fixes seems to work for me, but I might well have introduced memory leaks in my workaround for bug 2 above. I haven&#39;t really come to grips with when perls GC works and when it doesn&#39;t yet.

A, yes. Including info that should be included:

Distribution: Mail::Thread 2.41 installed from CPAN
Perl Version: 5.8.2
OS: FreeBSD 4.9 RELEASE, Generic i386

Regards
/Jonas Eckerman
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Thread.pm	Sun Jan 25 23:08:32 2004
+++ Thread.pm.jonas	Sun Jan 25 23:08:21 2004
@@ -66,32 +66,45 @@
     my $self = shift;
     my $root = $self-&gt;_container_class-&gt;new&#40; &#39;fakeroot&#39; &#41;;
     $root-&gt;set_children&#40; $self-&gt;rootset &#41;;
-
     my %subject;
-    for &#40;my $walk = $root-&gt;child; $walk; $walk = $walk-&gt;next&#41; {
-        my $sub = $walk-&gt;topmost-&gt;simple_subject or next;
-        # Add this container to the hash if:
-        # - There is no container in the hash with this subject, or
-        # - This one is a dummy container and the old one is not: the dummy
-        #   one is more interesting as a root, so put it in the hash instead.
-        # - The container in the table has a &#34;Re:&#34; version of this subject,
-        #   and this container has a non-&#34;Re:&#34; version of this subject.
-        #   The non-re version is the more interesting of the two.
-
-        my $old = $subject{$sub};
-        if &#40;!$old ||
-            &#40;!$walk-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
-            &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
-             $walk-&gt;message &#38;&#38; !$walk-&gt;isreply&#41;&#41; {
-            $subject{$sub} = $walk;
-        }
-    }
+
+    # Poupulate the hash with *all* subjects!
+    # /Jonas Eckerman, 2004-01-25
+    $root-&gt;_populate_hash_with_subjects&#40;\%subject&#41;;
+  
+    # This code took for granted that all posts in the same thread
+    # has the same subject. It didn&#39;t live in reality!
+    # /Jonas Eckerman, 2004-01-25
+    #for &#40;my $walk = $root-&gt;child; $walk; $walk = $walk-&gt;next&#41; {
+    #    my $sub = $walk-&gt;topmost-&gt;simple_subject or next;
+    #    # Add this container to the hash if:
+    #    # - There is no container in the hash with this subject, or
+    #    # - This one is a dummy container and the old one is not: the dummy
+    #    #   one is more interesting as a root, so put it in the hash instead.
+    #    # - The container in the table has a &#34;Re:&#34; version of this subject,
+    #    #   and this container has a non-&#34;Re:&#34; version of this subject.
+    #    #   The non-re version is the more interesting of the two.
+    #
+    #    my $old = $subject{$sub};
+    #    if &#40;!$old ||
+    #        &#40;!$walk-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
+    #        &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
+    #         $walk-&gt;message &#38;&#38; !$walk-&gt;isreply&#41;&#41; {
+    #        $subject{$sub} = $walk;
+    #    }
+    #}
+
     return unless %subject;
 
     # %subject is now populated with one entry for each subject which
     # occurs in the root set.  Now iterate over the root set, and
     # gather together the difference.
 
+    # Work around _group_set_bysubject tendency to misplace containers...
+    # /Jonas Eckerman 2004-01-25
+    my @all = &#40;&#41;;
+    $root-&gt;_collect_to_list&#40;\@all&#41;;
+
     my &#40;$prev, $walk, $rest&#41;;
     for &#40;$walk = $root-&gt;child, $rest = eval{ $walk-&gt;next };
          $walk;
@@ -99,12 +112,14 @@
         my $subj = $walk-&gt;topmost-&gt;simple_subject or next;
         my $old = $subject{$subj};
         next if $old == $walk;
-
         # Remove the &#34;second&#34; message from the root set
-        if &#40;!$prev&#41; { $root-&gt;child&#40; $walk-&gt;next &#41; }
-        else        { $prev-&gt;next&#40; $walk-&gt;next &#41; }
+        if &#40;!$prev&#41; {
+            $root-&gt;child&#40; $walk-&gt;next &#41; 
+        }
+        else {
+            $prev-&gt;next&#40; $walk-&gt;next &#41;
+        }
         $walk-&gt;next&#40;undef&#41;;
-
         if &#40;!$old-&gt;message &#38;&#38; !$walk-&gt;message&#41; {
             # They&#39;re both dummies; merge them.
             $old-&gt;add_child&#40; $_ &#41; for $walk-&gt;children;
@@ -126,16 +141,51 @@
             $new-&gt;add_child&#40; $_ &#41; for $old-&gt;children;
             $old-&gt;add_child&#40; $walk &#41;;
             $old-&gt;add_child&#40; $new &#41;;
+            # Work around _group_set_bysubject tendency to misplace containers...
+            # /Jonas Eckerman 2004-01-25
+            push @all, $new;
         }
         # we&#39;ve done a merge, so keep the same `prev&#39; next time around.
         $walk = $prev;
     }
 
+    # Work around _group_set_bysubject tendency to misplace containers...
+    # /Jonas Eckerman 2004-01-25
+    my %left = &#40;&#41;;
+    $root-&gt;_collect_to_hash&#40;\%left&#41;;
+    foreach my $cont &#40;@all&#41; {
+        if &#40;$cont-&gt;message &#38;&#38; !$left{$cont}&#41; {
+            $cont-&gt;child&#40; undef &#41;;
+            $root-&gt;add_child&#40; $cont &#41;;
+        }
+    }
+
     # repopulate the rootset from our fake one
     @{$self-&gt;{rootset}} = $root-&gt;children;
     $root-&gt;remove_child&#40;$_&#41; for $self-&gt;rootset;
 }
 
+# Collect all containers with messages to a list
+sub _collect_to_list {
+    my $self = shift;
+    my @list = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_to_list&#40;\@list&#41;;
+    }
+    return @list;
+}
+
+# Collect all containers with messages to a list
+sub _collect_to_hash {
+    my $self = shift;
+    my %hash = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_to_hash&#40;\%hash&#41;;
+    }
+    return %hash;
+
+}
+
 sub thread {
     my $self = shift;
     $self-&gt;_setup&#40;&#41;;
@@ -317,7 +367,6 @@
 sub subject { $_[0]-&gt;header&#40;&#34;subject&#34;&#41; }
 sub header { eval { my $s = $_[0]-&gt;message-&gt;head-&gt;get&#40; $_[1] &#41; || &#39;&#39;; chomp $s; $s; } }
 
-
 sub topmost {
     my $self = shift;
 
@@ -335,11 +384,63 @@
     $subject =~ m{^re:\s+}i;
 }
 
+# Collect containers with messages to an array
+sub _collect_to_list {
+    my $self = shift;
+    my $list = shift;
+    while &#40;$self&#41; {
+        push @$list, $self if &#40;$self-&gt;message&#41;;
+        _collect_to_list&#40;$self-&gt;child,$list&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Collect containers with messages to a hash
+sub _collect_to_hash {
+    my $self = shift;
+    my $hash = shift;
+    while &#40;$self&#41; {
+        ${$hash}{$self} = 1 if &#40;$self-&gt;message&#41;;
+        _collect_to_hash&#40;$self-&gt;child,$hash&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Poupulate the hash with *all* subjects!
+# /Jonas Eckerman, 2004-01-25
+sub _populate_hash_with_subjects {
+    my $self = shift;
+    return if &#40;!$self&#41;;
+    my $hash = shift;
+    my $subj;
+    while &#40;$self&#41; {
+        $subj = $self-&gt;simple_subject;
+        if &#40;$subj&#41; {
+            my $old = ${$hash}{$subj};
+            if &#40;!$old ||
+                &#40;!$self-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
+                &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
+                 $self-&gt;message &#38;&#38; !$self-&gt;isreply&#41;&#41; {
+                ${$hash}{$subj} = $self;
+            }
+        }
+        _populate_hash_with_subjects&#40;$self-&gt;child,$hash&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# re: changed because I want this to work with
+# stupidly localized software as well as mailinglists...
+# /Jonas Eckerman, 2004-01-25
 sub simple_subject {
     my $self = shift;
     my $subject = $self-&gt;subject;
-    $subject =~ s/^re:\s+//gi;
-    $subject;
+    $subject =~ s/^\s+//;
+    1 while $subject =~ s/^&#40;[a-z]{1,3}|\[[-a-z]+\]&#41;&#40;\s*\[\d*\]&#41;?[:-;]\s*//gi;
+    $subject =~ s/\s+/ /g;
+    $subject =~ s/\s+$//;
+    #$subject =~ s/^re:\s+//gi;
+    return lc&#40;$subject&#41;;
 }
 
 sub add_child {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;02&nbsp;09:38:57&nbsp;2004</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jonas [...] truls.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have attached a diff between the code I&#39;m using in a production system
and version 2.41. The diff seems to work fine against 2.5 as well.

This patch fixes the problems Mail::Thread has with subjects, and should
fix some memory leaks as well.

It&#39;s not much different from the previuous patch, but this time it&#39;s
code that has been working perfectly fine on a server here for the last
6 months.

Regards
/Jonas
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Thread.pm.org	Sun Jan 25 18:38:31 2004
+++ Thread.pm	Mon Jan 26 18:11:58 2004
@@ -66,32 +66,45 @@
     my $self = shift;
     my $root = $self-&gt;_container_class-&gt;new&#40; &#39;fakeroot&#39; &#41;;
     $root-&gt;set_children&#40; $self-&gt;rootset &#41;;
-
     my %subject;
-    for &#40;my $walk = $root-&gt;child; $walk; $walk = $walk-&gt;next&#41; {
-        my $sub = $walk-&gt;topmost-&gt;simple_subject or next;
-        # Add this container to the hash if:
-        # - There is no container in the hash with this subject, or
-        # - This one is a dummy container and the old one is not: the dummy
-        #   one is more interesting as a root, so put it in the hash instead.
-        # - The container in the table has a &#34;Re:&#34; version of this subject,
-        #   and this container has a non-&#34;Re:&#34; version of this subject.
-        #   The non-re version is the more interesting of the two.
-
-        my $old = $subject{$sub};
-        if &#40;!$old ||
-            &#40;!$walk-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
-            &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
-             $walk-&gt;message &#38;&#38; !$walk-&gt;isreply&#41;&#41; {
-            $subject{$sub} = $walk;
-        }
-    }
+
+    # Poupulate the hash with *all* subjects!
+    # /Jonas Eckerman, 2004-01-25
+    $root-&gt;_populate_hash_with_subjects&#40;\%subject&#41;;
+  
+    # This code took for granted that all posts in the same thread
+    # has the same subject. It didn&#39;t live in reality!
+    # /Jonas Eckerman, 2004-01-25
+    #for &#40;my $walk = $root-&gt;child; $walk; $walk = $walk-&gt;next&#41; {
+    #    my $sub = $walk-&gt;topmost-&gt;simple_subject or next;
+    #    # Add this container to the hash if:
+    #    # - There is no container in the hash with this subject, or
+    #    # - This one is a dummy container and the old one is not: the dummy
+    #    #   one is more interesting as a root, so put it in the hash instead.
+    #    # - The container in the table has a &#34;Re:&#34; version of this subject,
+    #    #   and this container has a non-&#34;Re:&#34; version of this subject.
+    #    #   The non-re version is the more interesting of the two.
+    #
+    #    my $old = $subject{$sub};
+    #    if &#40;!$old ||
+    #        &#40;!$walk-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
+    #        &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
+    #         $walk-&gt;message &#38;&#38; !$walk-&gt;isreply&#41;&#41; {
+    #        $subject{$sub} = $walk;
+    #    }
+    #}
+
     return unless %subject;
 
     # %subject is now populated with one entry for each subject which
     # occurs in the root set.  Now iterate over the root set, and
     # gather together the difference.
 
+    # Work around _group_set_bysubject tendency to misplace containers...
+    # /Jonas Eckerman 2004-01-25
+    my @all = &#40;&#41;;
+    $root-&gt;_collect_to_list&#40;\@all&#41;;
+
     my &#40;$prev, $walk, $rest&#41;;
     for &#40;$walk = $root-&gt;child, $rest = eval{ $walk-&gt;next };
          $walk;
@@ -99,12 +112,14 @@
         my $subj = $walk-&gt;topmost-&gt;simple_subject or next;
         my $old = $subject{$subj};
         next if $old == $walk;
-
         # Remove the &#34;second&#34; message from the root set
-        if &#40;!$prev&#41; { $root-&gt;child&#40; $walk-&gt;next &#41; }
-        else        { $prev-&gt;next&#40; $walk-&gt;next &#41; }
+        if &#40;!$prev&#41; {
+            $root-&gt;child&#40; $walk-&gt;next &#41; 
+        }
+        else {
+            $prev-&gt;next&#40; $walk-&gt;next &#41;
+        }
         $walk-&gt;next&#40;undef&#41;;
-
         if &#40;!$old-&gt;message &#38;&#38; !$walk-&gt;message&#41; {
             # They&#39;re both dummies; merge them.
             $old-&gt;add_child&#40; $_ &#41; for $walk-&gt;children;
@@ -126,16 +141,76 @@
             $new-&gt;add_child&#40; $_ &#41; for $old-&gt;children;
             $old-&gt;add_child&#40; $walk &#41;;
             $old-&gt;add_child&#40; $new &#41;;
+            # Work around _group_set_bysubject tendency to misplace containers...
+            # /Jonas Eckerman 2004-01-25
+            push @all, $new;
         }
         # we&#39;ve done a merge, so keep the same `prev&#39; next time around.
         $walk = $prev;
     }
 
+    # Work around _group_set_bysubject tendency to misplace containers...
+    # /Jonas Eckerman 2004-01-25
+    my %left = &#40;&#41;;
+    $root-&gt;_collect_to_hash&#40;\%left&#41;;
+    foreach my $cont &#40;@all&#41; {
+        if &#40;$cont-&gt;message &#38;&#38; !$left{$cont}&#41; {
+            $cont-&gt;child&#40; undef &#41;;
+            $cont-&gt;next&#40; undef &#41;;
+            $root-&gt;add_child&#40; $cont &#41;;
+            $left{$cont} = 1;
+        }
+    }
+
     # repopulate the rootset from our fake one
     @{$self-&gt;{rootset}} = $root-&gt;children;
     $root-&gt;remove_child&#40;$_&#41; for $self-&gt;rootset;
 }
 
+# Collect all message-ids to list
+sub _collect_msgid_to_list {
+    my $self = shift;
+    my $all = shift;
+    my @list = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_msgid_to_list&#40;\@list,$all&#41;;
+    }
+    return @list;
+}
+
+# Collect all message-ids to a hash
+sub _collect_msgid_to_hash {
+    my $self = shift;
+    my $all = shift;
+    my %hash = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_msgid_to_hash&#40;\%hash,$all&#41;;
+    }
+    return %hash;
+}
+
+# Collect all containers &#40;with messages unless $all&#41; to a list
+sub _collect_to_list {
+    my $self = shift;
+    my $all = shift;
+    my @list = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_to_list&#40;\@list,$all&#41;;
+    }
+    return @list;
+}
+
+# Collect all containers &#40;with messages unless $all&#41; to a hash
+sub _collect_to_hash {
+    my $self = shift;
+    my $all = shift;
+    my %hash = &#40;&#41;;
+    foreach my $cont &#40;@{$self-&gt;{rootset}}&#41; {
+        $cont-&gt;_collect_to_hash&#40;\%hash,$all&#41;;
+    }
+    return %hash;
+}
+
 sub thread {
     my $self = shift;
     $self-&gt;_setup&#40;&#41;;
@@ -304,6 +379,25 @@
     $root-&gt;remove_child&#40;$_&#41; for @kids;
 }
 
+# We don&#39;t like all the circular references eating
+# memory until something bad happens.
+# Jonas Eckerman, 2004-01-26
+sub DESTROY {
+    my $self = shift;
+    my @conts = $self-&gt;_collect_to_list&#40;1&#41;;
+    delete $self-&gt;{seen} if &#40;$self-&gt;{seen}&#41;;
+    delete $self-&gt;{id_table} if &#40;$self-&gt;{id_table}&#41;;
+    delete $self-&gt;{messages};
+    delete $self-&gt;{rootset};
+    for &#40;my $i=0; $i&lt;@conts; $i++&#41; {
+        $conts[$i]-&gt;child&#40; undef &#41;;
+        $conts[$i]-&gt;parent&#40; undef &#41;;
+        $conts[$i]-&gt;next&#40; undef &#41;;
+        $conts[$i] = undef;
+    }
+    @conts = &#40;&#41;;
+}
+
 package Mail::Thread::Container;
 use Carp qw&#40;carp confess croak cluck&#41;;
 
@@ -317,7 +411,6 @@
 sub subject { $_[0]-&gt;header&#40;&#34;subject&#34;&#41; }
 sub header { eval { my $s = $_[0]-&gt;message-&gt;head-&gt;get&#40; $_[1] &#41; || &#39;&#39;; chomp $s; $s; } }
 
-
 sub topmost {
     my $self = shift;
 
@@ -332,14 +425,92 @@
 sub isreply {
     my $self = shift;
     my $subject = $self-&gt;subject or return;
-    $subject =~ m{^re:\s+}i;
+    $subject =~ m{^\w\w\w?:\s+}i;
 }
 
+# Collect messaage-ids to array
+sub _collect_msgid_to_list {
+    my $self = shift;
+    my $list = shift;
+    my $all = shift;
+    while &#40;$self&#41; {
+        push @$list, $self-&gt;messageid if &#40;$self-&gt;messageid &#38;&#38; &#40;$all || $self-&gt;message&#41;&#41;;
+        _collect_msgid_to_list&#40;$self-&gt;child,$list&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Collect message-ids to hash
+sub _collect_msgid_to_hash {
+    my $self = shift;
+    my $hash = shift;
+    my $all = shift;
+    while &#40;$self&#41; {
+        ${$hash}{$self-&gt;messageid} = 1 if &#40;$self-&gt;messageid &#38;&#38; &#40;$all || $self-&gt;message&#41;&#41;;
+        _collect_msgid_to_hash&#40;$self-&gt;child,$hash&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Collect containers &#40;with messages unless $all&#41; to an array
+sub _collect_to_list {
+    my $self = shift;
+    my $list = shift;
+    my $all = shift;
+    while &#40;$self&#41; {
+        push @$list, $self if &#40;$all || $self-&gt;message&#41;;
+        _collect_to_list&#40;$self-&gt;child,$list&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Collect containers &#40;with messages unless $all&#41; to a hash
+sub _collect_to_hash {
+    my $self = shift;
+    my $hash = shift;
+    my $all = shift;
+    while &#40;$self&#41; {
+        ${$hash}{$self} = 1 if &#40;$all || $self-&gt;message&#41;;
+        _collect_to_hash&#40;$self-&gt;child,$hash&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# Poupulate the hash with *all* subjects!
+# /Jonas Eckerman, 2004-01-25
+sub _populate_hash_with_subjects {
+    my $self = shift;
+    return if &#40;!$self&#41;;
+    my $hash = shift;
+    my $subj;
+    while &#40;$self&#41; {
+        $subj = $self-&gt;simple_subject;
+        if &#40;$subj&#41; {
+            my $old = ${$hash}{$subj};
+            if &#40;!$old ||
+                &#40;!$self-&gt;message &#38;&#38; !$old-&gt;message&#41; ||
+                &#40;$old-&gt;message &#38;&#38; $old-&gt;isreply &#38;&#38;
+                 $self-&gt;message &#38;&#38; !$self-&gt;isreply&#41;&#41; {
+                ${$hash}{$subj} = $self;
+            }
+        }
+        _populate_hash_with_subjects&#40;$self-&gt;child,$hash&#41;;
+        $self = $self-&gt;next;
+    }
+}
+
+# re: changed because I want this to work with
+# stupidly localized software as well as mailinglists...
+# /Jonas Eckerman, 2004-01-25
 sub simple_subject {
     my $self = shift;
     my $subject = $self-&gt;subject;
-    $subject =~ s/^re:\s+//gi;
-    $subject;
+    $subject =~ s/^\s+//;
+    1 while $subject =~ s/^&#40;[a-z]{2,3}|\[[-a-z]+\]&#41;&#40;\s*\[\d*\]&#41;?[:-;]\s*//gi;
+    $subject =~ s/\s+/ /g;
+    $subject =~ s/\s+$//;
+    #$subject =~ s/^re:\s+//gi;
+    return lc&#40;$subject&#41;;
 }
 
 sub add_child {
@@ -481,6 +652,17 @@
     }
     return unless $after;
     while &#40;@visited&#41; { $after-&gt;&#40;@{ pop @visited }&#41; }
+}
+
+# We don&#39;t like all the circular references eating
+# memory until something bad happens.
+# Jonas Eckerman, 2004-01-26
+sub DESTROY {
+    my $self = shift;
+    $self-&gt;child&#40; undef &#41;;
+    $self-&gt;parent&#40; undef &#41;;
+    $self-&gt;next&#40; undef &#41;;
+    $self-&gt;message &#40; undef &#41;;
 }
 
 1;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
