<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #94892 for JSON-MaybeXS: Add JSON::XS support to MaybeXS</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #94892 for JSON-MaybeXS: Add JSON::XS support to MaybeXS</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/JSON-MaybeXS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/JSON-MaybeXS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/JSON-MaybeXS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/JSON-MaybeXS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/JSON-MaybeXS">JSON-MaybeXS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">94892</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/JSON-MaybeXS/Active/">JSON-MaybeXS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
develop [...] traveljury.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249998-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-249999-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;20&nbsp;07:36:06&nbsp;2014</span>
    <span class="description">develop [...] traveljury.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Add JSON::XS support to MaybeXS</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch adds fallback support for JSON::XS.  It first checks to see whether Cpanel::JSON::XS or JSON::XS is already loaded and if so, uses that module. Failing that, it tries to load Cpanel::JSON::XS, then JSON::XS then JSON::PP.

Currently this module requires Cpanel::JSON::XS and JSON::PP.  This should be changed to requiring JSON::PP and recommending Cpanel::JSON::XS and JSON::XS instead &#40;imo&#41;.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> with_JSON_XS.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN JSON-MaybeXS-1.001000/lib/JSON/MaybeXS.pm JSON-MaybeXS-with-JSON-XS/lib/JSON/MaybeXS.pm
--- JSON-MaybeXS-1.001000/lib/JSON/MaybeXS.pm	2013-12-11 02:56:45.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/lib/JSON/MaybeXS.pm	2014-04-20 13:10:16.000000000 +0200
@@ -6,25 +6,28 @@
 
 our $VERSION = &#39;1.001000&#39;;
 
-BEGIN {
-  our $JSON_Class;
+sub _choose_json_module {
+    return &#39;Cpanel::JSON::XS&#39; if $INC{&#39;Cpanel/JSON/XS.pm&#39;};
+    return &#39;JSON::XS&#39;         if $INC{&#39;JSON/XS.pm&#39;};
 
-  our @err;
+    my @err;
 
-  if &#40;eval { require Cpanel::JSON::XS; 1; }&#41; {
-    $JSON_Class = &#39;Cpanel::JSON::XS&#39;;
-  } else {
+    return &#39;Cpanel::JSON::XS&#39; if eval { require Cpanel::JSON::XS; 1; };
     push @err, &#34;Error loading Cpanel::JSON::XS: $@&#34;;
-    if &#40;eval { require JSON::PP; 1; }&#41; {
-      $JSON_Class = &#39;JSON::PP&#39;;
-    } else {
-      push @err, &#34;Error loading JSON::PP: $@&#34;;
-    }
-  }
-  unless &#40;$JSON_Class&#41; {
-    die join&#40;&#34;\n&#34;, &#34;Couldn&#39;t load a JSON module:&#34;, @err&#41;;
-  }
-  $JSON_Class-&gt;import&#40;qw&#40;encode_json decode_json&#41;&#41;;
+
+    return &#39;JSON::XS&#39; if eval { require JSON::XS; 1; };
+    push @err, &#34;Error loading JSON::XS: $@&#34;;
+
+    return &#39;JSON::PP&#39; if eval { require JSON::PP; 1 };
+    push @err, &#34;Error loading JSON::PP: $@&#34;;
+
+    die join&#40; &#34;\n&#34;, &#34;Couldn&#39;t load a JSON module:&#34;, @err &#41;;
+
+}
+
+BEGIN {
+    our $JSON_Class = _choose_json_module&#40;&#41;;
+    $JSON_Class-&gt;import&#40;qw&#40;encode_json decode_json&#41;&#41;;
 }
 
 our @EXPORT = qw&#40;encode_json decode_json JSON&#41;;
@@ -43,7 +46,7 @@
 
 =head1 NAME
 
-JSON::MaybeXS - use L&lt;Cpanel::JSON::XS&gt; with a fallback to L&lt;JSON::PP&gt;
+JSON::MaybeXS - use L&lt;Cpanel::JSON::XS&gt; with a fallback to L&lt;JSON::XS&gt; and L&lt;JSON::PP&gt;
 
 =head1 SYNOPSIS
 
@@ -59,9 +62,10 @@
 
 =head1 DESCRIPTION
 
-This module tries to load L&lt;Cpanel::JSON::XS&gt;, and if that fails instead
-tries to load L&lt;JSON::PP&gt;. If neither is available, an exception will be
-thrown.
+This module first checks to see if either L&lt;Cpanel::JSON::XS&gt; or
+L&lt;JSON::XS&gt; is already loaded, in which case it uses that module. Otherwise
+it tries to load L&lt;Cpanel::JSON::XS&gt;, then L&lt;JSON::XS&gt;, then L&lt;JSON::PP&gt;
+in order, and either uses the first module it finds or throws an error.
 
 It then exports the C&lt;encode_json&gt; and C&lt;decode_json&gt; functions from the
 loaded module, along with a C&lt;JSON&gt; constant that returns the class name
@@ -110,8 +114,8 @@
 
 =head2 new
 
-With L&lt;JSON::PP&gt; and L&lt;Cpanel::JSON::XS&gt; you are required to call mutators
-to set options, i.e.
+With L&lt;JSON::PP&gt;, L&lt;JSON::XS&gt; and L&lt;Cpanel::JSON::XS&gt; you are required to call
+mutators to set options, i.e.
 
   my $json = $class-&gt;new-&gt;utf8&#40;1&#41;-&gt;pretty&#40;1&#41;;
 
diff -ruN JSON-MaybeXS-1.001000/t/cpanel.t JSON-MaybeXS-with-JSON-XS/t/cpanel.t
--- JSON-MaybeXS-1.001000/t/cpanel.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/cpanel.t	2014-04-20 13:28:10.000000000 +0200
@@ -0,0 +1,24 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+unless &#40; eval { require Cpanel::JSON::XS; 1 } &#41; {
+    plan skip_all =&gt; &#39;Cpanel::JSON::XS not installed&#39;;
+    done_testing;
+    exit;
+}
+
+is&#40; JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
+
+is&#40; \&#38;encode_json,
+    \&#38;Cpanel::JSON::XS::encode_json,
+    &#39;Correct encode_json function&#39;
+&#41;;
+
+is&#40; \&#38;decode_json,
+    \&#38;Cpanel::JSON::XS::decode_json,
+    &#39;Correct encode_json function&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/neither.t JSON-MaybeXS-with-JSON-XS/t/neither.t
--- JSON-MaybeXS-1.001000/t/neither.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/neither.t	1970-01-01 01:00:00.000000000 +0100
@@ -1,16 +0,0 @@
-use strict;
-use warnings FATAL =&gt; &#39;all&#39;;
-use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
-use Test::Without::Module &#39;JSON::PP&#39;;
-use Test::More;
-
-ok&#40;!eval { require JSON::MaybeXS; 1 }, &#39;Class failed to load&#39;&#41;;
-
-# Test::Without::Module always causes &#39;did not return a true value&#39; errors
-
-like&#40;
-  $@, qr{Cpanel/JSON/XS.pm did not.*JSON/PP.pm did not}s,
-  &#39;Both errors reported&#39;
-&#41;;
-
-done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/none.t JSON-MaybeXS-with-JSON-XS/t/none.t
--- JSON-MaybeXS-1.001000/t/none.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/none.t	2014-04-20 13:30:50.000000000 +0200
@@ -0,0 +1,17 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
+use Test::Without::Module &#39;JSON::XS&#39;;
+use Test::Without::Module &#39;JSON::PP&#39;;
+use Test::More;
+
+ok&#40;!eval { require JSON::MaybeXS; 1 }, &#39;Class failed to load&#39;&#41;;
+
+# Test::Without::Module always causes &#39;did not return a true value&#39; errors
+
+like&#40;
+  $@, qr{Cpanel/JSON/XS.pm did not.*JSON/XS.pm did not.*JSON/PP.pm did not}s,
+  &#39;All errors reported&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/pp.t JSON-MaybeXS-with-JSON-XS/t/pp.t
--- JSON-MaybeXS-1.001000/t/pp.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/pp.t	2014-04-20 13:19:29.000000000 +0200
@@ -1,6 +1,6 @@
 use strict;
 use warnings FATAL =&gt; &#39;all&#39;;
-use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;, &#39;JSON::XS&#39;;
 use if !do { require JSON::PP; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No JSON::PP&#39;;
 use Test::More;
 use JSON::MaybeXS;
diff -ruN JSON-MaybeXS-1.001000/t/preload_cpanel.t JSON-MaybeXS-with-JSON-XS/t/preload_cpanel.t
--- JSON-MaybeXS-1.001000/t/preload_cpanel.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/preload_cpanel.t	2013-12-11 02:44:43.000000000 +0100
@@ -0,0 +1,19 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use if !do { require Cpanel::JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No Cpanel::JSON::XS&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+is&#40;JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39;&#41;;
+
+is&#40;
+  \&#38;encode_json, \&#38;Cpanel::JSON::XS::encode_json,
+  &#39;Correct encode_json function&#39;
+&#41;;
+
+is&#40;
+  \&#38;decode_json, \&#38;Cpanel::JSON::XS::decode_json,
+  &#39;Correct encode_json function&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/preload_xs.t JSON-MaybeXS-with-JSON-XS/t/preload_xs.t
--- JSON-MaybeXS-1.001000/t/preload_xs.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/preload_xs.t	2014-04-20 13:27:56.000000000 +0200
@@ -0,0 +1,12 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use if !do { require JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No JSON::XS&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+is&#40; JSON, &#39;JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
+
+is&#40; \&#38;encode_json, \&#38;JSON::XS::encode_json, &#39;Correct encode_json function&#39; &#41;;
+is&#40; \&#38;decode_json, \&#38;JSON::XS::decode_json, &#39;Correct encode_json function&#39; &#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/xs.t JSON-MaybeXS-with-JSON-XS/t/xs.t
--- JSON-MaybeXS-1.001000/t/xs.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/xs.t	2014-04-20 13:24:48.000000000 +0200
@@ -1,19 +1,19 @@
 use strict;
 use warnings FATAL =&gt; &#39;all&#39;;
-use if !do { require Cpanel::JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No Cpanel::JSON::XS&#39;;
+
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
 use Test::More;
 use JSON::MaybeXS;
 
-is&#40;JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39;&#41;;
+unless &#40; eval { require JSON::XS; 1 } &#41; {
+    plan skip_all =&gt; &#39;JSON::XS not installed&#39;;
+    done_testing;
+    exit;
+}
 
-is&#40;
-  \&#38;encode_json, \&#38;Cpanel::JSON::XS::encode_json,
-  &#39;Correct encode_json function&#39;
-&#41;;
+is&#40; JSON, &#39;JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
 
-is&#40;
-  \&#38;decode_json, \&#38;Cpanel::JSON::XS::decode_json,
-  &#39;Correct encode_json function&#39;
-&#41;;
+is&#40; \&#38;encode_json, \&#38;JSON::XS::encode_json, &#39;Correct encode_json function&#39; &#41;;
+is&#40; \&#38;decode_json, \&#38;JSON::XS::decode_json, &#39;Correct encode_json function&#39; &#41;;
 
 done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;20&nbsp;13:15:54&nbsp;2014</span>
    <span class="description">rt-cpan [...] trout.me.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Code-wise, the patch seems excellent. Guess I need to write some verbiage explaining the preference order before it ships.

On Sun Apr 20 07:36:06 2014, DRTECH wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Currently this module requires Cpanel::JSON::XS and JSON::PP.  This
&gt; should be changed to requiring JSON::PP and recommending
&gt; Cpanel::JSON::XS and JSON::XS instead &#40;imo&#41;.
</div>
That&#39;s not quite accurate.

What it does is, if it sees a compiler, adds Cpanel::JSON::XS to &#39;requires&#39;, otherwise it only puts a hard dep on JSON::PP.

I would be totally happy with an updated version of this patch that changes that behaviour to &#34;if I see a compiler, add Cpanel::JSON::XS to &#39;requires&#39;, unless JSON::XS is already installed, in which case add it to &#39;recommends&#39;&#34;. Too many toolchain setups regard &#39;recommends&#39; as human-oriented only to want to rely on that for &#34;getting an XS module at all&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Apr&nbsp;20&nbsp;13:15:54&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;21&nbsp;07:50:23&nbsp;2014</span>
    <span class="description">develop [...] traveljury.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What it does is, if it sees a compiler, adds Cpanel::JSON::XS to
&gt; &#39;requires&#39;, otherwise it only puts a hard dep on JSON::PP.
&gt; 
&gt; I would be totally happy with an updated version of this patch that
&gt; changes that behaviour to &#34;if I see a compiler, add Cpanel::JSON::XS
&gt; to &#39;requires&#39;, unless JSON::XS is already installed, in which case add
&gt; it to &#39;recommends&#39;&#34;. Too many toolchain setups regard &#39;recommends&#39; as
&gt; human-oriented only to want to rely on that for &#34;getting an XS module
&gt; at all&#34;
</div>
EU::MM is a bit of a black box to me. From my brief reading of the docs, the &#34;recommends&#34; section in the META files is fixed when you generate the dist, which is too early to figure out whether the end user will have a compiler or JSON::XS installed. 

So instead I&#39;ve kept your existing logic &#40;requiring Cpanel::JSON::XS if a compiler is available&#41; and just added a clause to check whether JSON::XS is installed already, in which case it remos Cpanel from the required list.  
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> with_JSON_XS_v2.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ruN JSON-MaybeXS-1.001000/lib/JSON/MaybeXS.pm JSON-MaybeXS-with-JSON-XS/lib/JSON/MaybeXS.pm
--- JSON-MaybeXS-1.001000/lib/JSON/MaybeXS.pm	2013-12-11 02:56:45.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/lib/JSON/MaybeXS.pm	2014-04-20 13:10:16.000000000 +0200
@@ -6,25 +6,28 @@
 
 our $VERSION = &#39;1.001000&#39;;
 
-BEGIN {
-  our $JSON_Class;
+sub _choose_json_module {
+    return &#39;Cpanel::JSON::XS&#39; if $INC{&#39;Cpanel/JSON/XS.pm&#39;};
+    return &#39;JSON::XS&#39;         if $INC{&#39;JSON/XS.pm&#39;};
 
-  our @err;
+    my @err;
 
-  if &#40;eval { require Cpanel::JSON::XS; 1; }&#41; {
-    $JSON_Class = &#39;Cpanel::JSON::XS&#39;;
-  } else {
+    return &#39;Cpanel::JSON::XS&#39; if eval { require Cpanel::JSON::XS; 1; };
     push @err, &#34;Error loading Cpanel::JSON::XS: $@&#34;;
-    if &#40;eval { require JSON::PP; 1; }&#41; {
-      $JSON_Class = &#39;JSON::PP&#39;;
-    } else {
-      push @err, &#34;Error loading JSON::PP: $@&#34;;
-    }
-  }
-  unless &#40;$JSON_Class&#41; {
-    die join&#40;&#34;\n&#34;, &#34;Couldn&#39;t load a JSON module:&#34;, @err&#41;;
-  }
-  $JSON_Class-&gt;import&#40;qw&#40;encode_json decode_json&#41;&#41;;
+
+    return &#39;JSON::XS&#39; if eval { require JSON::XS; 1; };
+    push @err, &#34;Error loading JSON::XS: $@&#34;;
+
+    return &#39;JSON::PP&#39; if eval { require JSON::PP; 1 };
+    push @err, &#34;Error loading JSON::PP: $@&#34;;
+
+    die join&#40; &#34;\n&#34;, &#34;Couldn&#39;t load a JSON module:&#34;, @err &#41;;
+
+}
+
+BEGIN {
+    our $JSON_Class = _choose_json_module&#40;&#41;;
+    $JSON_Class-&gt;import&#40;qw&#40;encode_json decode_json&#41;&#41;;
 }
 
 our @EXPORT = qw&#40;encode_json decode_json JSON&#41;;
@@ -43,7 +46,7 @@
 
 =head1 NAME
 
-JSON::MaybeXS - use L&lt;Cpanel::JSON::XS&gt; with a fallback to L&lt;JSON::PP&gt;
+JSON::MaybeXS - use L&lt;Cpanel::JSON::XS&gt; with a fallback to L&lt;JSON::XS&gt; and L&lt;JSON::PP&gt;
 
 =head1 SYNOPSIS
 
@@ -59,9 +62,10 @@
 
 =head1 DESCRIPTION
 
-This module tries to load L&lt;Cpanel::JSON::XS&gt;, and if that fails instead
-tries to load L&lt;JSON::PP&gt;. If neither is available, an exception will be
-thrown.
+This module first checks to see if either L&lt;Cpanel::JSON::XS&gt; or
+L&lt;JSON::XS&gt; is already loaded, in which case it uses that module. Otherwise
+it tries to load L&lt;Cpanel::JSON::XS&gt;, then L&lt;JSON::XS&gt;, then L&lt;JSON::PP&gt;
+in order, and either uses the first module it finds or throws an error.
 
 It then exports the C&lt;encode_json&gt; and C&lt;decode_json&gt; functions from the
 loaded module, along with a C&lt;JSON&gt; constant that returns the class name
@@ -110,8 +114,8 @@
 
 =head2 new
 
-With L&lt;JSON::PP&gt; and L&lt;Cpanel::JSON::XS&gt; you are required to call mutators
-to set options, i.e.
+With L&lt;JSON::PP&gt;, L&lt;JSON::XS&gt; and L&lt;Cpanel::JSON::XS&gt; you are required to call
+mutators to set options, i.e.
 
   my $json = $class-&gt;new-&gt;utf8&#40;1&#41;-&gt;pretty&#40;1&#41;;
 
diff -ruN JSON-MaybeXS-1.001000/t/cpanel.t JSON-MaybeXS-with-JSON-XS/t/cpanel.t
--- JSON-MaybeXS-1.001000/t/cpanel.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/cpanel.t	2014-04-20 13:28:10.000000000 +0200
@@ -0,0 +1,24 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+unless &#40; eval { require Cpanel::JSON::XS; 1 } &#41; {
+    plan skip_all =&gt; &#39;Cpanel::JSON::XS not installed&#39;;
+    done_testing;
+    exit;
+}
+
+is&#40; JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
+
+is&#40; \&#38;encode_json,
+    \&#38;Cpanel::JSON::XS::encode_json,
+    &#39;Correct encode_json function&#39;
+&#41;;
+
+is&#40; \&#38;decode_json,
+    \&#38;Cpanel::JSON::XS::decode_json,
+    &#39;Correct encode_json function&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/neither.t JSON-MaybeXS-with-JSON-XS/t/neither.t
--- JSON-MaybeXS-1.001000/t/neither.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/neither.t	1970-01-01 01:00:00.000000000 +0100
@@ -1,16 +0,0 @@
-use strict;
-use warnings FATAL =&gt; &#39;all&#39;;
-use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
-use Test::Without::Module &#39;JSON::PP&#39;;
-use Test::More;
-
-ok&#40;!eval { require JSON::MaybeXS; 1 }, &#39;Class failed to load&#39;&#41;;
-
-# Test::Without::Module always causes &#39;did not return a true value&#39; errors
-
-like&#40;
-  $@, qr{Cpanel/JSON/XS.pm did not.*JSON/PP.pm did not}s,
-  &#39;Both errors reported&#39;
-&#41;;
-
-done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/none.t JSON-MaybeXS-with-JSON-XS/t/none.t
--- JSON-MaybeXS-1.001000/t/none.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/none.t	2014-04-20 13:30:50.000000000 +0200
@@ -0,0 +1,17 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
+use Test::Without::Module &#39;JSON::XS&#39;;
+use Test::Without::Module &#39;JSON::PP&#39;;
+use Test::More;
+
+ok&#40;!eval { require JSON::MaybeXS; 1 }, &#39;Class failed to load&#39;&#41;;
+
+# Test::Without::Module always causes &#39;did not return a true value&#39; errors
+
+like&#40;
+  $@, qr{Cpanel/JSON/XS.pm did not.*JSON/XS.pm did not.*JSON/PP.pm did not}s,
+  &#39;All errors reported&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/pp.t JSON-MaybeXS-with-JSON-XS/t/pp.t
--- JSON-MaybeXS-1.001000/t/pp.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/pp.t	2014-04-20 13:19:29.000000000 +0200
@@ -1,6 +1,6 @@
 use strict;
 use warnings FATAL =&gt; &#39;all&#39;;
-use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;, &#39;JSON::XS&#39;;
 use if !do { require JSON::PP; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No JSON::PP&#39;;
 use Test::More;
 use JSON::MaybeXS;
diff -ruN JSON-MaybeXS-1.001000/t/preload_cpanel.t JSON-MaybeXS-with-JSON-XS/t/preload_cpanel.t
--- JSON-MaybeXS-1.001000/t/preload_cpanel.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/preload_cpanel.t	2013-12-11 02:44:43.000000000 +0100
@@ -0,0 +1,19 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use if !do { require Cpanel::JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No Cpanel::JSON::XS&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+is&#40;JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39;&#41;;
+
+is&#40;
+  \&#38;encode_json, \&#38;Cpanel::JSON::XS::encode_json,
+  &#39;Correct encode_json function&#39;
+&#41;;
+
+is&#40;
+  \&#38;decode_json, \&#38;Cpanel::JSON::XS::decode_json,
+  &#39;Correct encode_json function&#39;
+&#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/preload_xs.t JSON-MaybeXS-with-JSON-XS/t/preload_xs.t
--- JSON-MaybeXS-1.001000/t/preload_xs.t	1970-01-01 01:00:00.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/preload_xs.t	2014-04-20 13:27:56.000000000 +0200
@@ -0,0 +1,12 @@
+use strict;
+use warnings FATAL =&gt; &#39;all&#39;;
+use if !do { require JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No JSON::XS&#39;;
+use Test::More;
+use JSON::MaybeXS;
+
+is&#40; JSON, &#39;JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
+
+is&#40; \&#38;encode_json, \&#38;JSON::XS::encode_json, &#39;Correct encode_json function&#39; &#41;;
+is&#40; \&#38;decode_json, \&#38;JSON::XS::decode_json, &#39;Correct encode_json function&#39; &#41;;
+
+done_testing;
diff -ruN JSON-MaybeXS-1.001000/t/xs.t JSON-MaybeXS-with-JSON-XS/t/xs.t
--- JSON-MaybeXS-1.001000/t/xs.t	2013-12-11 02:44:43.000000000 +0100
+++ JSON-MaybeXS-with-JSON-XS/t/xs.t	2014-04-20 13:24:48.000000000 +0200
@@ -1,19 +1,19 @@
 use strict;
 use warnings FATAL =&gt; &#39;all&#39;;
-use if !do { require Cpanel::JSON::XS; 1; }, &#39;Test::More&#39;, skip_all =&gt; &#39;No Cpanel::JSON::XS&#39;;
+
+use Test::Without::Module &#39;Cpanel::JSON::XS&#39;;
 use Test::More;
 use JSON::MaybeXS;
 
-is&#40;JSON, &#39;Cpanel::JSON::XS&#39;, &#39;Correct JSON class&#39;&#41;;
+unless &#40; eval { require JSON::XS; 1 } &#41; {
+    plan skip_all =&gt; &#39;JSON::XS not installed&#39;;
+    done_testing;
+    exit;
+}
 
-is&#40;
-  \&#38;encode_json, \&#38;Cpanel::JSON::XS::encode_json,
-  &#39;Correct encode_json function&#39;
-&#41;;
+is&#40; JSON, &#39;JSON::XS&#39;, &#39;Correct JSON class&#39; &#41;;
 
-is&#40;
-  \&#38;decode_json, \&#38;Cpanel::JSON::XS::decode_json,
-  &#39;Correct encode_json function&#39;
-&#41;;
+is&#40; \&#38;encode_json, \&#38;JSON::XS::encode_json, &#39;Correct encode_json function&#39; &#41;;
+is&#40; \&#38;decode_json, \&#38;JSON::XS::decode_json, &#39;Correct encode_json function&#39; &#41;;
 
 done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;13:46:30&nbsp;2014</span>
    <span class="description">develop [...] traveljury.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Matt

Any news on this? I&#39;m waiting on a new release of MaybeXS before releasing a new Elasticsearch version.

ta
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;22&nbsp;14:02:56&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #94892] Add JSON::XS support to MaybeXS</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 22 Apr 2014 11:02:42 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Clinton Gormley via RT &lt;bug-JSON-MaybeXS [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Karen Etheridge &lt;ether [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Apr 22, 2014 at 01:46:30PM -0400, Clinton Gormley via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Matt
&gt; Any news on this? I&#39;m waiting on a new release of MaybeXS before releasing a new Elasticsearch version.
</div>
If mst asks nicely I could possibly do a release tonight &#40;that&#39;s ~7 hours
from now&#41; ;&#41; -- I just need a decision on how to structure the logic.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;01:48:58&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2014-04-21 04:50:23, DRTECH wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So instead I&#39;ve kept your existing logic &#40;requiring Cpanel::JSON::XS
&gt; if a compiler is available&#41; and just added a clause to check whether
&gt; JSON::XS is installed already, in which case it remos Cpanel from the
&gt; required list.
</div>
BTW, the two patches are identical. But I can fix it to do what you describe here, and add to the &#39;recommends&#39; prereq list as well.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;02:22:13&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">1.002000 is released. Thanks Clinton!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;02:22:14&nbsp;2014</span>
    <span class="description">ether [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;23&nbsp;06:01:12&nbsp;2014</span>
    <span class="description">develop [...] traveljury.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Apr 23 02:22:13 2014, ETHER wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1.002000 is released. Thanks Clinton!
</div>
And many thanks to you Karen
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
