<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #95784 for POE-Component-SNMP: Unresponsive SNMP agents cause PoCo::SNMP to leak memory</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #95784 for POE-Component-SNMP: Unresponsive SNMP agents cause PoCo::SNMP to leak memory</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE-Component-SNMP/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE-Component-SNMP/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE-Component-SNMP/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE-Component-SNMP/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE-Component-SNMP">POE-Component-SNMP CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">95784</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE-Component-SNMP/Active/">POE-Component-SNMP</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
matthias [...] towiski.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26660-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.1006    </td>
  </tr>
  <tr id="CF-26661-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;19&nbsp;13:33:17&nbsp;2014</span>
    <span class="description">matthias [...] towiski.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unresponsive SNMP agents cause PoCo::SNMP to leak memory</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m debuggin an SNMP collector I wrote that queries several dozen devices for a rather large number of OIDs. On some installations &#40;Fedora, Perl 5.18.2; CentOS 5, Perl 5.8.8 and CentOS 6, Perl 5.10.1&#41; I noticed the process had grown to an obscene size after a day while on others it chugged along happily at roughly its initial size. The problem turned out to be a HA installation where of two firewalls only the currently active one responds to SNMP while the other one keeps quiet.

The attached code shows the problem in isolation using Devel::Gladiator. It sends one query a second, and once every ten seconds it prints its current process size &#40;Linux specific but easily disabled&#41; and an overview of all objects whose number has changed since the last time the stats were shown. If you point $host to a device that responds to a sysUptime query, after a while there will be no changes in the number of objects allocated by Perl. If the device doesn&#39;t repond however, you gets something like this:

   Abs Count   Difference Data Type
       36064          317 SCALAR
        1706          104 REF
        3610           72 ARRAY
         259           32 REF-ARRAY
        1956           16 CODE
         518           16 HASH
          32            8 Net::SNMP::PDU
          32            8 POE::Session::AnonEvent
         136           16 REF-CODE
         135           16 REF-HASH
          34            8 REF-Net::SNMP::PDU
          34            8 REF-Net::SNMP::Security::Community
          35            8 REF-Net::SNMP::Transport::IPv4::UDP
          33            8 REF-POE::Net::SNMP
          32            8 REF-POE::Session::AnonEvent

The module seems to be leaking PDUs that are either not correctly timed out or not properly cleaned up afterwards due to some circular references. It&#39;s definitely the POE part because an equivalent program sing plain Net::SNMP does not show this behavior even though Devel::Cycle shows circular structures like this:

$Net::SNMP::A-&gt;{&#39;_pdu&#39;} =&gt; \%Net::SNMP::PDU::DH
$Net::SNMP::PDU::DH-&gt;{&#39;_callback&#39;} =&gt; \&#38;DI
                $DI variable $this =&gt; \$DJ
                              $$DJ =&gt; \%Net::SNMP::A


The same cycle is visible in the POE version:

              $POE::Kernel::A-&gt;[5] =&gt; \@POE::Queue::Array::IG
     $POE::Queue::Array::IG-&gt;[447] =&gt; \@AOD
                         $AOD-&gt;[2] =&gt; \@AOE
                         $AOE-&gt;[0] =&gt; \@POE::Session::HC
            $POE::Session::HC-&gt;[0] =&gt; \%HD
             $HD-&gt;{&#39;snmp_session&#39;} =&gt; \%POE::Net::SNMP::HE
     $POE::Net::SNMP::HE-&gt;{&#39;_pdu&#39;} =&gt; \%Net::SNMP::PDU::HF
$Net::SNMP::PDU::HF-&gt;{&#39;_callback&#39;} =&gt; \&#38;HG
                $HG variable $this =&gt; \$HH
                              $$HH =&gt; \%POE::Net::SNMP::HE

My guess is that the Net::SNMP dispatcher upon timeout actively breaks this cycle but I haven&#39;t had time to track it down.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> poe-snmptest.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use POE qw/ Component::SNMP /;
use Data::Dumper;
use Devel::Gladiator qw/ arena_ref_counts /;

my $host = &#39;localhost&#39;;
my $testoid = &#39;.1.3.6.1.2.1.1.3.0&#39;;

my $count = 0;

POE::Session-&gt;create&#40;
    inline_states =&gt; {
        snmp_response   =&gt; sub { my $r=$_[ARG1]-&gt;[0]; print ref $r ? $r-&gt;{$testoid} : $r, &#34;\n&#34;; },
        snmp_query      =&gt; \&#38;_snmp_query,
        _start          =&gt; \&#38;_start,
        debug_meminfo   =&gt; \&#38;_debug_meminfo,
    },
&#41;;
POE::Kernel-&gt;run;

sub _start {
	my &#40;$kernel, $heap&#41; = @_[KERNEL, HEAP];

    POE::Component::SNMP-&gt;create&#40;
        hostname    =&gt;  $host,
        retries     =&gt; 0,
        debug       =&gt; 0,
    &#41;;
    $kernel-&gt;yield&#40;&#39;snmp_query&#39;&#41;;
}

sub _snmp_query {
    my &#40;$kernel&#41; = @_[KERNEL, ARG0];

    $kernel-&gt;post&#40;&#39;snmp&#39;, &#39;get&#39;, &#39;snmp_response&#39;, -varbindlist =&gt; [ $testoid ] &#41;;
    $kernel-&gt;delay&#40;&#34;snmp_query&#34;, 1&#41;;
    _debug_meminfo&#40;$kernel&#41; unless $count = &#40;$count+1&#41; % 10;
}

my %arena_stats;
sub _debug_meminfo {
	my &#40;$kernel&#41; = @_;

    # Determine our RSS
    open my $fh, &#39;&lt;&#39;, &#34;/proc/$$/status&#34; or do {
        $kernel-&gt;post&#40;&#39;logger&#39;, &#39;info&#39;, &#34;Can&#39;t open /proc/$$/status: $!&#34;&#41;;
        return;
    };
    my $rss;
    while&#40;&lt;$fh&gt;&#41; { &#40;$rss&#41; = /^VmRSS:\s*&#40;\d+&#41;/ and last }
    if&#40;defined $rss&#41; {
        print &#34;Current RSS size: $rss KB; event queue: &#34;.$kernel-&gt;[5]-&gt;get_item_count.&#34; elements\n&#34;;
    } else {
        print &#34;Can&#39;t find RSS size in /proc/$$/status; event queue: &#34;.$kernel-&gt;[5]-&gt;get_item_count.&#34; elements\n&#34;;
    }
    close $fh;

    # Print object counts in the arena that have changed
    my $ar = arena_ref_counts;
    my %stats;
    while&#40;my &#40;$k, $v&#41; = each %$ar&#41; {
        my $diff = $v - &#40;$arena_stats{$k} || 0&#41;;
        $stats{$k} = $diff if $diff;
        $arena_stats{$k} = $v;
    }

    printf &#34;%12s %12s %s\n&#34;, &#34;Abs Count&#34;, &#34;Difference&#34;, &#34;Data Type&#34;;
    foreach&#40;qw/ SCALAR REF ARRAY REF-ARRAY GLOB CODE /&#41; {
        printf &#34;%12d %12d %s\n&#34;, $ar-&gt;{$_}, $stats{$_}, $_ if $stats{$_};
        delete $stats{$_};
    }
    foreach&#40;sort keys %stats&#41; {
        printf &#34;%12d %12d %s\n&#34;, $ar-&gt;{$_}, $stats{$_}, $_;
    }
}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> snmptest.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use Net::SNMP;
use Data::Dumper;
use Devel::Gladiator qw/ arena_ref_counts /;
use Devel::Cycle;
use Time::HiRes &#39;sleep&#39;;

my $host = &#39;localhost&#39;;
my $testoid = &#39;.1.3.6.1.2.1.1.3.0&#39;;

my $cycl0r=0;

my &#40;$sess, $err&#41; = Net::SNMP-&gt;session&#40;
    -hostname =&gt; $host,
    -nonblocking =&gt; 1,
    -debug =&gt; 1,
&#41;;
die $err if $err;

while&#40;1&#41; {
    next_request&#40;&#41;;
    $sess-&gt;snmp_dispatcher;
    print &#34;restart\n&#34;;
    find_cycle&#40;$sess&#41;;
    debug_meminfo&#40;&#41;;
}

sub next_request {
    sleep&#40;0.5&#41;;
    unless&#40;$cycl0r = &#40;$cycl0r + 1&#41; % 10&#41; {
        find_cycle&#40;$sess&#41;;
        debug_meminfo&#40;&#41;;
    }
    $sess-&gt;get_request&#40;-callback =&gt; \&#38;result_cb, -varbindlist =&gt; [ $testoid ]&#41;	or print &#34;req fail\n&#34;;
}

sub result_cb {
    my $o = shift;
    print &#34;result: &#34;,$o-&gt;var_bind_list-&gt;{$testoid},&#34;\n&#34;;
    next_request&#40;&#41;;
}

my %arena_stats;
sub debug_meminfo {
    # Print object counts in the arena that have changed
    my $ar = arena_ref_counts;
    my %stats;
    while&#40;my &#40;$k, $v&#41; = each %$ar&#41; {
        my $diff = $v - &#40;$arena_stats{$k} || 0&#41;;
        $stats{$k} = $diff if $diff;
        $arena_stats{$k} = $v;
    }

    printf &#34;%12s %12s %s\n&#34;, &#34;Abs Count&#34;, &#34;Difference&#34;, &#34;Data Type&#34;;
    foreach&#40;qw/ SCALAR REF ARRAY REF-ARRAY GLOB CODE /&#41; {
        printf &#34;%12d %12d %s\n&#34;, $ar-&gt;{$_}, $stats{$_}, $_ if $stats{$_};
        delete $stats{$_};
    }
    foreach&#40;sort keys %stats&#41; {
        printf &#34;%12d %12d %s\n&#34;, $ar-&gt;{$_}, $stats{$_}, $_;
    }
}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;25&nbsp;19:19:46&nbsp;2014</span>
    <span class="description">rdb [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">So, I&#39;ve been unable to reproduce this, using your test scripts. After setting the $host parameter to an unresponsive IP and running both scripts for days on end, the POE script grows a *little* during the first, oh, 10 minutes or so, then is stable, and the non-POE version doesn&#39;t grow at all.

In fact, I made a mistake at first and forgot to update the $host for the non-POE version &#40;so it WAS getting replies&#41; and in that case the script continued to consume additional memory &#40;starting at about 52MB and I stopped it at 113MB, after 2 days&#41;.

I&#39;ve made no attempt to update the logic in the test scripts.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;25&nbsp;19:19:46&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;08&nbsp;13:15:25&nbsp;2014</span>
    <span class="description">MBETHKE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 25 19:19:46 2014, RDB wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, I&#39;ve been unable to reproduce this, using your test scripts. After
&gt; setting the $host parameter to an unresponsive IP and running both
&gt; scripts for days on end, the POE script grows a *little* during the
&gt; first, oh, 10 minutes or so, then is stable, and the non-POE version
&gt; doesn&#39;t grow at all.
</div>
Strange, I&#39;m getting the same behavior on half a dozen systems including various CentOS versions, Gentoo with Perl 5.16, Debian with 5.14 and Fedora with 5.18.2.
To make sure it&#39;s not something weird in my setup I just whipped up a fresh Debian Wheezy, installed Perlbrew with 5.18.2 and as many modules as possible of the required ones via cpanminus to make sure they&#39;re in their latest versions. Same thing: snmptest.pl doesn&#39;t grow, poe-snmptest.pl does.

I have packed the VM as a raw disk image with external kernel, initrd and XEN config file as
<span class="clickylink"><a target="new" rel="nofollow" href="http://bodega.towiski.de/poetest.tar.xz">http://bodega.towiski.de/poetest.tar.xz</a></span>
If you want to try it: login is root:changethis, and both test scripts are in root&#39;s home.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
