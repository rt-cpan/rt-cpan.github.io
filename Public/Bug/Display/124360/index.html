<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #124360 for Net-SSLeay: Adding support for generating OCSP responses</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #124360 for Net-SSLeay: Adding support for generating OCSP responses</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">124360</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
sludin [...] ludin.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.84    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;07&nbsp;12:37:14&nbsp;2018</span>
    <span class="description">sludin [...] ludin.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Adding support for generating OCSP responses</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Currently Net::SSLeay cannot be used to create an OCSP responder &#40;at least as far as I can tell&#41;.  I would to enhance it to be able to do that.  When finished my plan is to submit a patch for potential inclusion.  I have a horrible hack working now, which though functional would not &#40;should not?&#41; meet the bar for inclusion.  Before I clean it up though I wanted to get some opinions for the maintainers.

Essentially I want to replicate the functionality of make_ocsp_request in apps/ocsp.c.  The first directional question is do I drop that call &#40;and all of its dependencies&#41; as a helper function into SSLeay.xs, or do I implement the 15 or so calls that it uses that are not already in Net::SSLeay and write make_ocsp_request in perl.  The former has a bit junky on the inside, provides less flexibility, but makes the smallest change to the interface.  The latter will add a bunch of calls that will then need to be documented and maintained, but provides tons of flexibility and expands the capabilities of Net::SSLeay beyond just OCSP responses &#40;possibly&#41;.

What is the preferred direction?

By the way, is there a best practice for XS calls that need to allocate memory?  I may need an OPENSSL_malloc, but I see that nowhere else in SSLeay.xs is a malloc made which leads me to think that may be something to avoid.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;07&nbsp;16:15:52&nbsp;2018</span>
    <span class="description">mikem [...] airspayce.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #124360] Adding support for generating OCSP responses</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 08 Feb 2018 06:51:14 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] airspayce.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Stephen,

On Thursday, 8 February 2018 03:37:15 AEST you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Wed Feb 07 12:37:14 2018: Request 124360 was acted upon.
&gt; Transaction: Ticket created by SLUDIN
&gt;        Queue: Net-SSLeay
&gt;      Subject: Adding support for generating OCSP responses
&gt;    Broken in: 1.84
&gt;     Severity: Normal
&gt;        Owner: Nobody
&gt;   Requestors: sludin@ludin.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=124360">https://rt.cpan.org/Ticket/Display.html?id=124360</a></span> &gt;
&gt; 
&gt; 
&gt; Currently Net::SSLeay cannot be used to create an OCSP responder &#40;at least
&gt; as far as I can tell&#41;.  I would to enhance it to be able to do that.  When
&gt; finished my plan is to submit a patch for potential inclusion.  I have a
&gt; horrible hack working now, which though functional would not &#40;should not?&#41;
&gt; meet the bar for inclusion.  Before I clean it up though I wanted to get
&gt; some opinions for the maintainers.
&gt; 
&gt; Essentially I want to replicate the functionality of make_ocsp_request in
&gt; apps/ocsp.c.  The first directional question is do I drop that call &#40;and
&gt; all of its dependencies&#41; as a helper function into SSLeay.xs, or do I
&gt; implement the 15 or so calls that it uses that are not already in
&gt; Net::SSLeay and write make_ocsp_request in perl.  The former has a bit
&gt; junky on the inside, provides less flexibility, but makes the smallest
&gt; change to the interface.  The latter will add a bunch of calls that will
&gt; then need to be documented and maintained, but provides tons of flexibility
&gt; and expands the capabilities of Net::SSLeay beyond just OCSP responses
&gt; &#40;possibly&#41;.
&gt; 
&gt; What is the preferred direction?
</div>
I think most people would prefer to see the latter approach, though you are 
correct that it is more work.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; By the way, is there a best practice for XS calls that need to allocate
&gt; memory?  I may need an OPENSSL_malloc, but I see that nowhere else in
&gt; SSLeay.xs is a malloc made which leads me to think that may be something to
&gt; avoid.
</div>
No, thats fine: if you need mem you prob should use OPENSSL_malloc and friends.


-- 
Mike McCauley           VK4AMM                   mikem@airspayce.com
Airspayce Pty Ltd 9 Bulbul Place Currumbin Waters QLD 4223 Australia   
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.airspayce.com">http://www.airspayce.com</a></span>
Phone +61 7 5598-7474
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;07&nbsp;16:15:54&nbsp;2018</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;07&nbsp;18:55:39&nbsp;2018</span>
    <span class="description">sludin [...] ludin.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 07 16:15:52 2018, mikem@airspayce.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello Stephen,
&gt; 
&gt; On Thursday, 8 February 2018 03:37:15 AEST you wrote:
<div class="message-stanza open">&gt; &gt; Wed Feb 07 12:37:14 2018: Request 124360 was acted upon.
&gt; &gt; Transaction: Ticket created by SLUDIN
&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;      Subject: Adding support for generating OCSP responses
&gt; &gt;    Broken in: 1.84
&gt; &gt;     Severity: Normal
&gt; &gt;        Owner: Nobody
&gt; &gt;   Requestors: sludin@ludin.org
&gt; &gt;       Status: new
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=124360">https://rt.cpan.org/Ticket/Display.html?id=124360</a></span> &gt;
&gt; &gt;
&gt; &gt;
&gt; &gt; Currently Net::SSLeay cannot be used to create an OCSP responder &#40;at
&gt; &gt; least
&gt; &gt; as far as I can tell&#41;.  I would to enhance it to be able to do that.
&gt; &gt; When
&gt; &gt; finished my plan is to submit a patch for potential inclusion.  I
&gt; &gt; have a
&gt; &gt; horrible hack working now, which though functional would not &#40;should
&gt; &gt; not?&#41;
&gt; &gt; meet the bar for inclusion.  Before I clean it up though I wanted to
&gt; &gt; get
&gt; &gt; some opinions for the maintainers.
&gt; &gt;
&gt; &gt; Essentially I want to replicate the functionality of
&gt; &gt; make_ocsp_request in
&gt; &gt; apps/ocsp.c.  The first directional question is do I drop that call
&gt; &gt; &#40;and
&gt; &gt; all of its dependencies&#41; as a helper function into SSLeay.xs, or do I
&gt; &gt; implement the 15 or so calls that it uses that are not already in
&gt; &gt; Net::SSLeay and write make_ocsp_request in perl.  The former has a
&gt; &gt; bit
&gt; &gt; junky on the inside, provides less flexibility, but makes the
&gt; &gt; smallest
&gt; &gt; change to the interface.  The latter will add a bunch of calls that
&gt; &gt; will
&gt; &gt; then need to be documented and maintained, but provides tons of
&gt; &gt; flexibility
&gt; &gt; and expands the capabilities of Net::SSLeay beyond just OCSP
&gt; &gt; responses
&gt; &gt; &#40;possibly&#41;.
&gt; &gt;
&gt; &gt; What is the preferred direction?
</div>&gt; 
&gt; I think most people would prefer to see the latter approach, though
&gt; you are
&gt; correct that it is more work.
</div>
I will try and do some variant of that.  Digging in it looks like it would be good to spend some time to &#39;perlify&#39; it rather than a literal translation.  For example, making STACK_OFs into AV * or returning a hash from things like OCSP_id_get0_info.  I&#39;ll come up with something and then let the experts kick it around.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; By the way, is there a best practice for XS calls that need to
&gt; &gt; allocate
&gt; &gt; memory?  I may need an OPENSSL_malloc, but I see that nowhere else in
&gt; &gt; SSLeay.xs is a malloc made which leads me to think that may be
&gt; &gt; something to
&gt; &gt; avoid.
</div>&gt; 
&gt; No, thats fine: if you need mem you prob should use OPENSSL_malloc and
&gt; friends.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;08&nbsp;23:21:15&nbsp;2018</span>
    <span class="description">sludin [...] ludin.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an almost direct perl translation of make_ocsp_response from apps/ocsp.c.  I would love feedback on the general look and feel.  My concern is that as it stands it requires a ton of openssl knowledge to understand and properly use, but then I suppose that is no different than the rest of Net::SSLeay.  Everything works and is implemented on the XS side.

Is there a general guideline for when to return opaque openssl pointers vs. when to return perl objects.  For example, I have Net::SSLeay::OCSP_id_get0_inf returning a hash ref but just about everything else returning internal pointers.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> responder.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Devel::Hide qw&#40; Net/SSLeay.pm &#41;;
use strict;
use warnings;
use lib &#39;./blib/lib&#39;;
use lib &#39;./blib/arch&#39;;
use Net::SSLeay qw&#40; die_now &#41;;
use Data::Dumper;
use IO::File;
use File::Slurp;
use Devel::Peek;

Net::SSLeay::load_error_strings&#40;&#41;;
Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
Net::SSLeay::randomize&#40;&#41;;

my $content = read_file&#40; &#34;req2.der&#34; &#41;;

my $req = Net::SSLeay::d2i_OCSP_REQUEST&#40; $content &#41;;


my $index = Net::SSLeay::load_index&#40; &#34;index.txt&#34;, 0 &#41;;

my $cert = load_cert&#40; &#34;servercert.pem&#34; &#41; || die;
my $ca   = load_cert&#40; &#34;intermediatecert.pem&#34; &#41; || die;
my $rkey = load_key&#40; &#34;intermediatekey.pem&#34; &#41; || die;

my $resp = make_ocsp_response&#40; $req, $index, $ca, $ca, $rkey, &#34;sha1&#34;, [ $cert ], 0, 30, 3, 0 &#41;;

my $der = Net::SSLeay::i2d_OCSP_RESPONSE&#40; $resp &#41;;

write_file&#40; &#34;resp.der&#34;, $der &#41;;

sub load_cert
{
  my $filename = shift;

  $bio = Net::SSLeay::BIO_new_file&#40; $filename, &#39;r&#39; &#41; || die_now&#40; &#34;BIO_new_file &#40;$!&#41;&#34; &#41;;
  my $der = Net::SSLeay::PEM_read_bio_X509&#40;$bio&#41;     || die_now&#40; &#34;BIO_read_bio_X509 &#40;$!&#41;&#34; &#41;;;
  Net::SSLeay::BIO_free&#40;$bio&#41;;

  return $der;
}

sub load_key
{
  my $filename = shift;

  $bio = Net::SSLeay::BIO_new_file&#40; $filename, &#39;r&#39; &#41;   || die_now&#40; &#34;BIO_new_file &#40;$!&#41;&#34; &#41;;
  my $der = Net::SSLeay::PEM_read_bio_PrivateKey&#40;$bio&#41; || die_now&#40; &#34;BIO_read_bio_PrivateKey &#40;$!&#41;&#34; &#41;;;
  Net::SSLeay::BIO_free&#40;$bio&#41;;

  return $der;
}


sub make_ocsp_response
{
  my $req    = shift;
  my $db     = shift;
  my $ca     = shift;
  my $rcert  = shift;
  my $rkey   = shift;
  my $md     = shift || &#34;sha1&#34;;
  my $rother = shift;
  my $flags  = shift;
  my $nmin   = shift;
  my $ndays  = shift;
  my $badsig = shift;

  my $resp;
  my $i;

  # Load the digest hash from openssl
  my $rmd = Net::SSLeay::EVP_get_digestbyname&#40; $md &#41; || die_now&#40; &#34;EVP_get_digestbyname &#40;$!&#41;&#34; &#41;;

  # get the count of certs to check from the request
  my $id_count = Net::SSLeay::OCSP_request_onereq_count&#40; $req &#41;;

  if &#40; $id_count &lt;= 0 &#41;
  {
    $resp = Net::SSLeay::OCSP_response_create&#40; Net::SSLeay::OCSP_RESPONSE_STATUS_MALFORMEDREQUEST&#40;&#41;, 0 &#41;;
    return $resp;
  }

  # BASICRESP is where we will build the respone. The signed version of it will
  # constitute the final response
  my $bs = Net::SSLeay::OCSP_BASICRESP_new&#40;&#41;;

  # create the thisUpdate and nextUpdate fields
  my $nextupd;
  my $thisupd = Net::SSLeay::X509_gmtime_adj&#40; 0, 0 &#41;;
  if &#40; $ndays != -1 &#41;
  {
    $nextupd = Net::SSLeay::X509_time_adj_ex&#40; 0, $ndays, $nmin * 60, 0 &#41;;
  }

  # handle each cert in the request
  for my $i &#40; 0 .. $id_count - 1 &#41;
  {
    # ONEREQ is the &#39;Request&#39; structure from the ASN.1 &#40; RFC 6960 &#41;
    my $one = Net::SSLeay::OCSP_request_onereq_get0&#40; $req, $i &#41;;
    # the CertID contains the hashAlgorithm, issuerNameHash, issuerKeyHash, and the serialNumber
    # this three-tuple uniquely identifies the certificate
    my $cid = Net::SSLeay::OCSP_onereq_get0_id&#40; $one &#41;;

    # $info is a hash of the CertID data
    my $info = Net::SSLeay::OCSP_id_get0_info&#40; $cid &#41;;

    my $cert_id_md = Net::SSLeay::EVP_get_digestbyobj&#40; $info-&gt;{hashAlgorithm} &#41;;

    if &#40; ! $cert_id_md &#41;
    {
      $resp = Net::SSLeay::OCSP_response_create&#40; OCSP_RESPONSE_STATUS_INTERNALERROR&#40;&#41;, 0 &#41;;
      print &#34;No message digest\n&#34;;
      return $resp;
    }

    # extract the CertID from the issuing cert
    my $ca_id = Net::SSLeay::OCSP_cert_to_id&#40; $cert_id_md, 0, $ca &#41;;

    # if the CertID from the request and the CertID from the issuer do not match
    # respond saying as much.
    if &#40; Net::SSLeay::OCSP_id_issuer_cmp&#40; $ca_id, $cid &#41; &#41;
    {
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                             Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                             0, 0, $thisupd, $nextupd&#41;;
      print &#34;Here\n&#34;;
      next;
    }

    # Lookup the serial in the CA index
    my $inf = Net::SSLeay::lookup_serial&#40; $db, $info-&gt;{serialNumber} &#41;;

    if &#40; ! $inf &#41;
    {
      # Can&#39;t find it.  Respond as unkonwn
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                          Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
    }
    # TODO: replace with constants DB_type and DB_TYPE_
    elsif &#40; $inf-&gt;[0] eq &#34;V&#34; &#41;
    {
      # Found it and it is good
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_GOOD&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
    }
    # TODO: replace with constants DB_type and DB_TYPE_REV
    elsif&#40; $inf-&gt;[0] eq &#34;R&#34; &#41;
    {
      # Found it and it is revoked
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                          Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
        #     unpack_revinfo&#40;&#38;revtm, &#38;reason, &#38;inst, &#38;invtm, inf[DB_rev_date]&#41;;
        #     single = OCSP_basic_add1_status&#40;bs, cid,
        #                                     V_OCSP_CERTSTATUS_REVOKED,
        #                                     reason, revtm, thisupd, nextupd&#41;;
        #     if &#40;invtm&#41;
        #         OCSP_SINGLERESP_add1_ext_i2d&#40;single, NID_invalidity_date,
        #                                      invtm, 0, 0&#41;;
        #     else if &#40;inst&#41;
        #         OCSP_SINGLERESP_add1_ext_i2d&#40;single,
        #                                      NID_hold_instruction_code, inst,
        #                                      0, 0&#41;;
        #     ASN1_OBJECT_free&#40;inst&#41;;
        #     ASN1_TIME_free&#40;revtm&#41;;
        #     ASN1_GENERALIZEDTIME_free&#40;invtm&#41;;
        # }
    }
    else
    {
      # An unexpected status.  Respond and Unknown;
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
    }

    # TODO: Oh, there are probably a bunch lf leaks right now.
    Net::SSLeay::OCSP_CERTID_free&#40; $ca_id &#41;;

  }

  # If the request had a nonce, copy it into the response
  Net::SSLeay::OCSP_copy_nonce&#40; $bs, $req &#41;;

  # Sign the BASICRESP
  # TODO: describe $rother
  Net::SSLeay::OCSP_basic_sign&#40; $bs, $rcert, $rkey, $rmd, $rother, $flags &#41;;

  # Purposely corrupt the signature if asked to.  This is in the openssl
  # make_ocsp_response in apps/ocsp.c
  if &#40; $badsig &#41;
  {
    my $sig = Net::SSLeay::OCSP_resp_get0_signature&#40; $bs &#41;;
    Net:SSLeay::corrupt_signature&#40; $sig &#41;;
  }

  # create the successful response from the signed BASICRESP
  $resp = Net::SSLeay::OCSP_response_create&#40; Net::SSLeay::OCSP_RESPONSE_STATUS_SUCCESSFUL&#40;&#41;, $bs &#41;;

  return $resp;

}
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;05&nbsp;13:37:46&nbsp;2018</span>
    <span class="description">sludin [...] ludin.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Finally getting back to this.  Code is written but needs some style work.  One of the things I need is access to the structures in crypto/ocsp/ocsp_lcl.h.  These structures are not put into the public include files.  What is the best way to deal with this?  Copy/Pasting them into SSLeay.xs work, but seems heavy handed.  Any guidance is welcome.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;08&nbsp;20:06:19&nbsp;2018</span>
    <span class="description">sludin [...] ludin.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an initial diff.  This provides the basic needed functionality, attempts to conform to style, compiles and passes test on 0.9.8 &#40;not functional&#41;, 1.0.2, and 1.1.0.  It is a rather large patch.  I am also attacking a test file.

There is still a bit more work needed to finish it up, but I&#39;d like to get feedback before I start the fine polish.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 70_ocsp_responder.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;
use Test::More;
use Socket;
use File::Spec;
use Symbol qw&#40;gensym&#41;;
use Net::SSLeay;
use Config;

BEGIN {
  plan skip_all =&gt; &#34;openssl 1.0.2 required&#34; unless Net::SSLeay::SSLeay &gt;= 0x10002000;
}

plan tests =&gt; 10;

my $sock;
my $pid;

my $port = 40000+int&#40;rand&#40;9999&#41;&#41;;
my $ip = &#34;\x7F\0\0\x01&#34;;
my $serv_params  = sockaddr_in&#40;$port, $ip&#41;;

my $msg = &#39;ssleay-ocsp-responder-test&#39;;
my $intermediate_cert_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_intermediate.crt.pem&#39;&#41;;
#my $intermediate_key_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_intermediate.key.pem&#39;&#41;;
my $intermediate_ocsp_cert_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_intermediate_ocsp.crt.pem&#39;&#41;;
my $intermediate_ocsp_key_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_intermediate_ocsp.key.pem&#39;&#41;;
#my $server_cert_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_server.crt.pem&#39;&#41;;
#my $server_key_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_server.key.pem&#39;&#41;;
#my $root_cert_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_root.crt.pem&#39;&#41;;
#my $root_key_pem = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_root.key.pem&#39;&#41;;
my $ca_index = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_index.txt&#39;&#41;;


my @results;
Net::SSLeay::initialize&#40;&#41;;


{
  my $reqfile = File::Spec-&gt;catfile&#40;&#39;t&#39;, &#39;data&#39;, &#39;ocsptest_req_nononce.der&#39;&#41;;
  ok&#40; $reqfile &#41;;

  my $content = slurp&#40; $reqfile &#41;;
  ok&#40; $content &#41;;

  my $req = Net::SSLeay::d2i_OCSP_REQUEST&#40; $content &#41;;
  ok&#40; $req &#41;;

  my $index = Net::SSLeay::load_index&#40; $ca_index, 0 &#41;;
  ok &#40; $index &#41;;

  my $intermediate_cert = load_cert&#40; $intermediate_cert_pem &#41; || die;
  ok&#40; $intermediate_cert &#41;;

#  my $intermediate_key = load_key&#40; $intermediate_key_pem &#41;    || die;
#  ok&#40; $intermediate_key &#41;;

  my $ocsp_key = load_key&#40; $intermediate_ocsp_key_pem &#41;    || die;
  ok&#40; $ocsp_key &#41;;

  my $ocsp_cert = load_cert&#40; $intermediate_ocsp_cert_pem &#41;    || die;
  ok&#40; $ocsp_cert &#41;;

#  my $server_cert = load_cert&#40; $server_cert_pem &#41; || die;
#  ok&#40; $server_cert &#41;;

  my $resp = make_ocsp_response&#40; $req, $index, $intermediate_cert, $ocsp_cert, $ocsp_key, &#34;sha1&#34;, [ ], 0, 30, 3, 0 &#41;;
  ok&#40; $resp &#41;;

  my $der = Net::SSLeay::i2d_OCSP_RESPONSE&#40; $resp &#41;;
  ok&#40; $der &#41;;

  open&#40; FILE, &#34;&gt;&#34;, &#34;resp.der&#34; &#41;;
  print FILE $der;
  close&#40; FILE &#41;;
  
}

push @results, [$? == 0, &#39;server exited with 0&#39;];
END {
#  Test::More-&gt;builder-&gt;current_test&#40;3&#41;;
#  ok&#40; $_-&gt;[0], $_-&gt;[1] &#41; for &#40;@results&#41;;
}

sub load_cert
{
  my $filename = shift;

  my $bio = Net::SSLeay::BIO_new_file&#40; $filename, &#39;r&#39; &#41; || die_now&#40; &#34;BIO_new_file &#40;$!&#41;&#34; &#41;;
  my $der = Net::SSLeay::PEM_read_bio_X509&#40;$bio&#41;     || die_now&#40; &#34;BIO_read_bio_X509 &#40;$!&#41;&#34; &#41;;;
  Net::SSLeay::BIO_free&#40;$bio&#41;;

  return $der;
}

sub load_key
{
  my $filename = shift;

  my $bio = Net::SSLeay::BIO_new_file&#40; $filename, &#39;r&#39; &#41;   || die_now&#40; &#34;BIO_new_file &#40;$!&#41;&#34; &#41;;
  my $der = Net::SSLeay::PEM_read_bio_PrivateKey&#40;$bio&#41; || die_now&#40; &#34;BIO_read_bio_PrivateKey &#40;$!&#41;&#34; &#41;;;
  Net::SSLeay::BIO_free&#40;$bio&#41;;

  return $der;
}

sub slurp
{
  my $filename = shift;
  local $/;
  open&#40; my $fh, &#39;&lt;&#39;, $filename &#41;;
  my $text   = &lt;$fh&gt;;
  return $text;
}

sub make_ocsp_response
{
  my $req    = shift;
  my $db     = shift;
  my $ca     = shift;
  my $rcert  = shift;
  my $rkey   = shift;
  my $md     = shift || &#34;sha1&#34;;
  my $rother = shift;
  my $flags  = shift;
  my $nmin   = shift;
  my $ndays  = shift;
  my $badsig = shift || 0;

  my $resp;
  my $i;

  # Load the digest hash from openssl
  my $rmd = Net::SSLeay::EVP_get_digestbyname&#40; $md &#41; || die_now&#40; &#34;EVP_get_digestbyname &#40;$!&#41;&#34; &#41;;

  # get the count of certs to check from the request
  my $id_count = Net::SSLeay::OCSP_request_onereq_count&#40; $req &#41;;

  if &#40; $id_count &lt;= 0 &#41;
  {
    $resp = Net::SSLeay::OCSP_response_create&#40; Net::SSLeay::OCSP_RESPONSE_STATUS_MALFORMEDREQUEST&#40;&#41;, 0 &#41;;
    return $resp;
  }

  # BASICRESP is where we will build the respone. The signed version of it will
  # constitute the final response
  my $bs = Net::SSLeay::OCSP_BASICRESP_new&#40;&#41;;

  # create the thisUpdate and nextUpdate fields
  my $nextupd;
  my $thisupd = Net::SSLeay::X509_gmtime_adj&#40; 0, 0 &#41;;
  if &#40; $ndays != -1 &#41;
  {
    $nextupd = Net::SSLeay::X509_time_adj_ex&#40; 0, $ndays, $nmin * 60, 0 &#41;;
  }

  # handle each cert in the request
  for my $i &#40; 0 .. $id_count - 1 &#41;
  {
    # ONEREQ is the &#39;Request&#39; structure from the ASN.1 &#40; RFC 6960 &#41;
    my $one = Net::SSLeay::OCSP_request_onereq_get0&#40; $req, $i &#41;;
    # the CertID contains the hashAlgorithm, issuerNameHash, issuerKeyHash, and the serialNumber
    # this three-tuple uniquely identifies the certificate
    my $cid = Net::SSLeay::OCSP_onereq_get0_id&#40; $one &#41;;

    # $info is a hash of the CertID data
    my $info = Net::SSLeay::OCSP_id_get0_info&#40; $cid &#41;;

    my $cert_id_md = Net::SSLeay::EVP_get_digestbyobj&#40; $info-&gt;{hashAlgorithm} &#41;;

    if &#40; ! $cert_id_md &#41;
    {
      $resp = Net::SSLeay::OCSP_response_create&#40; OCSP_RESPONSE_STATUS_INTERNALERROR&#40;&#41;, 0 &#41;;
      return $resp;
    }

    # extract the CertID from the issuing cert
    my $ca_id = Net::SSLeay::OCSP_cert_to_id&#40; $cert_id_md, 0, $ca &#41;;

    # if the CertID from the request and the CertID from the issuer do not match
    # respond saying as much.
    if &#40; Net::SSLeay::OCSP_id_issuer_cmp&#40; $ca_id, $cid &#41; &#41;
    {
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                             Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                             0, 0, $thisupd, $nextupd&#41;;
      next;
    }

    # Lookup the serial in the CA index
    my $inf = Net::SSLeay::lookup_serial&#40; $db, $info-&gt;{serialNumber} &#41;;

    if &#40; ! $inf &#41;
    {
      # Can&#39;t find it.  Respond as unkonwn
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
    }
    # TODO: replace with constants DB_type and DB_TYPE_
    elsif &#40; $inf-&gt;[0] eq &#34;V&#34; &#41;
    {
      # Found it and it is good
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_GOOD&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;
    }
    # TODO: replace with constants DB_type and DB_TYPE_REV
    elsif&#40; $inf-&gt;[0] eq &#34;R&#34; &#41;
    {
      # Found it and it is revoked
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;

      my $arr = Net::SSLeay::unpack_revinfo&#40; $inf-&gt;[2] &#41;;
      Dump&#40; $arr, 10 &#41;;
      #     unpack_revinfo&#40;&#38;revtm, &#38;reason, &#38;inst, &#38;invtm, inf[DB_rev_date]&#41;;
      my $single = Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                                        Net::SSLeay::V_OCSP_CERTSTATUS_REVOKED&#40;&#41;,
                                                        $arr-&gt;[1], $arr-&gt;[0], $thisupd, $nextupd&#41;;

      # TODO: Not 100% certain this is all working properly
      if &#40; $arr-&gt;[3] &#41;
      {
        Net::SSLeay::OCSP_SINGLERESP_add1_ext_i2d&#40; $single, Net::SSLeay::NID_invalidity_date&#40;&#41;,
                                                   $arr-&gt;[3], 0, 0&#41;;
      }
      elsif &#40; $arr-&gt;[2] &#41;
      {
        Net::SSLeay::OCSP_SINGLERESP_add1_ext_i2d&#40; $single,
                                                   Net::SSLeay::NID_hold_instruction_code&#40;&#41;, $arr-&gt;[2],
                                                   0, 0&#41;;
      }

      # TODO: Free $arr
    }
    else
    {
      # An unexpected status.  Respond and Unknown;
      Net::SSLeay::OCSP_basic_add1_status&#40; $bs, $cid,
                                           Net::SSLeay::V_OCSP_CERTSTATUS_UNKNOWN&#40;&#41;,
                                           0, 0, $thisupd, $nextupd&#41;;

      print &#34;No status match\n&#34;;
    }

    # TODO: Oh, there are probably a bunch lf leaks right now.
    Net::SSLeay::OCSP_CERTID_free&#40; $ca_id &#41;;

  }

  # If the request had a nonce, copy it into the response
  Net::SSLeay::OCSP_copy_nonce&#40; $bs, $req &#41;;

  # Sign the BASICRESP
  # TODO: describe $rother
  Net::SSLeay::OCSP_basic_sign&#40; $bs, $rcert, $rkey, $rmd, $rother, $flags &#41;;

  # Purposely corrupt the signature if asked to.  This is in the openssl
  # make_ocsp_response in apps/ocsp.c
  if &#40; $badsig &#41;
  {
    my $sig = Net::SSLeay::OCSP_resp_get0_signature&#40; $bs &#41;;
    Net:SSLeay::corrupt_signature&#40; $sig &#41;;
  }

  # create the successful response from the signed BASICRESP
  $resp = Net::SSLeay::OCSP_response_create&#40; Net::SSLeay::OCSP_RESPONSE_STATUS_SUCCESSFUL&#40;&#41;, $bs &#41;;

  return $resp;

}
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ocsp_responder.diff</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;16&nbsp;16:35:32&nbsp;2019</span>
    <span class="description">RADIATOR [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 08 20:06:19 2018, SLUDIN wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There is still a bit more work needed to finish it up, but I&#39;d like to
&gt; get feedback before I start the fine polish.
</div>
Would you be interested in continuing the work? Now that we have a stable release behind us, it&#39;s a good time to look at new features.

The patch still applies but because the attachments did not include the certificates, the test fails to run. If you still have the certs, could you attach the certs to this ticket?

We could next look at topics such as function naming &#40;/4 under naming conventions in SSLeay.xs&#41; and how to handle special functionality such as corrupt_signature&#40;&#41;.

-- 
Heikki Vatiainen
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
