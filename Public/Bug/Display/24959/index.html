<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #24959 for Class-DBI: [PATCH] Change the iterator to fetch on demand.</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #24959 for Class-DBI: [PATCH] Change the iterator to fetch on demand.</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Class-DBI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Class-DBI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Class-DBI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Class-DBI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-DBI">Class-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">24959</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Class-DBI">Class-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mschwern [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-6690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-6691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




iterator.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/292697/132147/iterator.patch">
Wed Feb 21 21:58:18 2007 (47.2k) by mschwern [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/292689/132131/iterator.patch">
Wed Feb 21 21:11:04 2007 (40.6k) by mschwern [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/290988/131177/iterator.patch">
Wed Feb 14 18:33:47 2007 (9.3k) by mschwern [...] cpan.org
</a>
</font></li>
</ul>


ondemand2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/291940/131712/ondemand2.patch">
Sun Feb 18 16:43:57 2007 (30.3k) by mschwern [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=24959">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-290988" href="/Public/Bug/Display.html?id=24959#txn-290988">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;14&nbsp;18:33:47&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Change the iterator to fetch on demand.</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/290988/131174/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/131174">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The attached patch changes Class::DBI::Iterator to take an active
statement handle and fetch the rows on demand rather than working from a
pre-fetched list.  This can drastically improve the performance of
iterators when the whole list is not iterated through.  In particular
the common idiom of, search-&gt;first when search might return a lot of rows.

There&#39;s still some work and tweaks to be done, but I wanted to post it
here so it can be evaluated.

Notes:
* All the existing methods still function the same.

* The Iterator will still accept a data list.

* In order to support reset&#40;&#41; and count&#40;&#41; it is necessary for the
iterator to store the data being fetched.  This wastes some memory.

* count&#40;&#41; remains as inefficient as before.  The statement handle must
fetch all the data to count it up.

* CDBI-&gt;sth_to_objects&#40;&#41; has been altered to pass in the statement
  handle to the iterator.  This will break any existing CDBI::Iterator
  subclasses as it uses a new interface.

* Because sth_to_objects&#40;&#41; was tweaked this has a much wider performance
effect than just search&#40;&#41;.  It should effect any search-like
functionality including CDBI::AbstractSearch.

* Its worth considering if CDBI::Iterator should be split into
CDBI::Iterator::FromList and CDBI::Iterator::FromSth with CDBI::Iterator
becoming abstract.

* I had to turn off all cached statements or else DBI will bitch that a
cached handle is being reused.  This is not ideal.  There is an option
to DBI-&gt;prepare_cached&#40;&#41; to make it do the right thing &#40;ie. silently
prepare a new handle if the cached one is still active&#41; but it requires
A&#41; an Ima::DBI patch and B&#41; Ima::DBI requiring DBI 1.40.  I&#39;ll do it if
that&#39;s ok.  It would, in general, make set_sql&#40;&#41; behave better.

* The deprecated delete&#40;@search&#41; had to be deleted because of locking
issues in SQLite.

* Now that iterators contain active statement handles they may hold read
locks open.  This could cause new locking issues in existing
applications.  SQLite, for example, does not allow you to delete a row
which is read locked.  Note that this is no worse than having an active
statement handle open and deleting the rows as you fetch them.

* As a further performance tweak the execution of the statement handle
can be delayed until the first fetch.  This would also allow unused
iterators to be safely created and passed around without worrying about
holding locks open.  Or even created opportunistically and then tossed
away if they&#39;re not needed.  I haven&#39;t implemented this.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iterator.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/290988/131177/iterator.patch">Download iterator.patch</a><br />
<span class="downloadcontenttype">text/x-diff 9.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Auto-merging &#40;0, 27397&#41; /local/Class-DBI to /vendor/Class-DBI &#40;base /vendor/Class-DBI:27388&#41;.
U   t/02-Film.t
U   lib/Class/DBI.pm
U   lib/Class/DBI/Iterator.pm
==== Patch &lt;-&gt; level 1
Source: 9c88509d-e914-0410-b01c-b9530614cbfe:/local/Class-DBI:27397
Target: 9c88509d-e914-0410-b01c-b9530614cbfe:/vendor/Class-DBI:27388
Log:
Efficient iterator patch take 1
=== t/02-Film.t
==================================================================
--- t/02-Film.t	&#40;revision 27388&#41;
+++ t/02-Film.t	&#40;patch - level 1&#41;
@@ -4,7 +4,7 @@
 
 BEGIN {
 	eval &#34;use DBD::SQLite&#34;;
-	plan $@ ? &#40;skip_all =&gt; &#39;needs DBD::SQLite for testing&#39;&#41; : &#40;tests =&gt; 91&#41;;
+	plan $@ ? &#40;skip_all =&gt; &#39;needs DBD::SQLite for testing&#39;&#41; : &#40;tests =&gt; 88&#41;;
 }
 
 INIT {
@@ -158,17 +158,6 @@
 	ok&#40;Film-&gt;retrieve&#40;&#39;Ishtar&#39;&#41;-&gt;delete,
 		&#34;Ishtar doesn&#39;t deserve an entry any more&#34;&#41;;
 	ok&#40;!Film-&gt;retrieve&#40;&#39;Ishtar&#39;&#41;, &#39;Ishtar no longer there&#39;&#41;;
-	{
-		my $deprecated = 0;
-		local $SIG{__WARN__} = sub { $deprecated++ if $_[0] =~ /deprecated/ };
-		ok&#40;
-			Film-&gt;delete&#40;Director =&gt; &#39;Elaine May&#39;&#41;,
-			&#34;In fact, delete all films by Elaine May&#34;
-		&#41;;
-		is&#40;Film-&gt;search&#40;Director =&gt; &#39;Elaine May&#39;&#41;-&gt;count,
-			0, &#34;0 Films by Elaine May&#34;&#41;;
-		is $deprecated, 1, &#34;Got a deprecated warning&#34;;
-	}
 };
 is $@, &#39;&#39;, &#34;No problems with deletes&#34;;
 
=== lib/Class/DBI.pm
==================================================================
--- lib/Class/DBI.pm	&#40;revision 27388&#41;
+++ lib/Class/DBI.pm	&#40;patch - level 1&#41;
@@ -7,7 +7,7 @@
 
 package Class::DBI;
 
-use version; $VERSION = qv&#40;&#39;3.0.16&#39;&#41;;
+use version; $VERSION = qv&#40;&#39;3.0.16.1&#39;&#41;;
 
 use strict;
 use warnings;
@@ -730,7 +730,7 @@
 
 sub delete {
 	my $self = shift;
-	return $self-&gt;_search_delete&#40;@_&#41; if not ref $self;
+
 	$self-&gt;remove_from_object_index;
 	$self-&gt;call_trigger&#40;&#39;before_delete&#39;&#41;;
 
@@ -748,16 +748,6 @@
 	return 1;
 }
 
-sub _search_delete {
-	my &#40;$class, @args&#41; = @_;
-	$class-&gt;_carp&#40;
-		&#34;Delete as class method is deprecated. Use search and delete_all instead.&#34;
-	&#41;;
-	my $it = $class-&gt;search_like&#40;@args&#41;;
-	while &#40;my $obj = $it-&gt;next&#41; { $obj-&gt;delete }
-	return 1;
-}
-
 # Return the placeholder to be used in UPDATE and INSERT queries.
 # Overriding this is deprecated in favour of
 #   __PACKAGE__-&gt;find_column&#40;&#39;entered&#39;&#41;-&gt;placeholder&#40;&#39;IF&#40;1, CURDATE&#40;&#41;, ?&#41;&#41;;
@@ -930,6 +920,7 @@
 sub set_sql {
 	my &#40;$class, $name, $sql, $db, @others&#41; = @_;
 	$db ||= &#39;Main&#39;;
+	@others = 0;
 	$class-&gt;SUPER::set_sql&#40;$name, $sql, $db, @others&#41;;
 	$class-&gt;_generate_search_sql&#40;$name&#41; if $sql =~ /select/i;
 	return 1;
@@ -1130,19 +1121,19 @@
 sub sth_to_objects {
 	my &#40;$class, $sth, $args&#41; = @_;
 	$class-&gt;_croak&#40;&#34;sth_to_objects needs a statement handle&#34;&#41; unless $sth;
+
 	unless &#40;UNIVERSAL::isa&#40;$sth =&gt; &#34;DBI::st&#34;&#41;&#41; {
 		my $meth = &#34;sql_$sth&#34;;
 		$sth = $class-&gt;$meth&#40;&#41;;
 	}
-	my &#40;%data, @rows&#41;;
+
 	eval {
 		$sth-&gt;execute&#40;@$args&#41; unless $sth-&gt;{Active};
-		$sth-&gt;bind_columns&#40;\&#40;@data{ @{ $sth-&gt;{NAME_lc} } }&#41;&#41;;
-		push @rows, {%data} while $sth-&gt;fetch;
 	};
 	return $class-&gt;_croak&#40;&#34;$class can&#39;t $sth-&gt;{Statement}: $@&#34;, err =&gt; $@&#41;
 		if $@;
-	return $class-&gt;_ids_to_objects&#40;\@rows&#41;;
+
+	return $class-&gt;_sth_to_iterator&#40;$sth&#41;;
 }
 *_sth_to_objects = \&#38;sth_to_objects;
 
@@ -1153,9 +1144,36 @@
 	return $class;
 }
 
+sub _sth_to_iterator {
+	my&#40;$class, $sth&#41; = @_;
+
+	return unless defined wantarray;
+	return $class-&gt;_objects_from_sth&#40;$sth&#41; if wantarray;
+	
+	my $iterator = $class-&gt;_my_iterator-&gt;new&#40;$class&#41;;
+	$iterator-&gt;sth&#40;$sth&#41;;
+	return $iterator;
+}
+
+sub _data_from_sth {
+	my&#40;$class, $sth&#41; = @_;
+	
+	my&#40; @rows, %data &#41;;
+	$sth-&gt;bind_columns&#40;\&#40;@data{ @{ $sth-&gt;{NAME_lc} } }&#41;&#41;;
+	push @rows, {%data} while $sth-&gt;fetch;
+	
+	return \@rows;
+}
+
+sub _objects_from_sth {
+	my&#40;$class, $sth&#41; = @_;
+	
+	return map $class-&gt;construct&#40;$_&#41;, @{$class-&gt;_data_from_sth&#40;$sth&#41;};
+}
+
 sub _ids_to_objects {
 	my &#40;$class, $data&#41; = @_;
-	return $#$data + 1 unless defined wantarray;
+	return unless defined wantarray;
 	return map $class-&gt;construct&#40;$_&#41;, @$data if wantarray;
 	return $class-&gt;_my_iterator-&gt;new&#40;$class =&gt; $data&#41;;
 }
=== lib/Class/DBI/Iterator.pm
==================================================================
--- lib/Class/DBI/Iterator.pm	&#40;revision 27388&#41;
+++ lib/Class/DBI/Iterator.pm	&#40;patch - level 1&#41;
@@ -30,6 +30,17 @@
 can fetch them one at a time, potentially saving a considerable amount
 of processing time and memory.
 
+=head1 EFFICIENCY
+
+The iterator has two modes of operation.  One is to work off of a list of data handed into new&#40;&#41;.  This can be very wasteful if the entire data list is not iterated through, for example:  C&lt;&lt; Class-&gt;search&#40;...&#41;-&gt;first &gt;&gt;.
+
+The other mode is to pass in no data and instead give it an active, executed statement handle.
+
+	my $iterator = CDBI::Iterator-&gt;new&#40;$cdbi_class&#41;;
+	$iterator-&gt;sth&#40;$search_sth&#41;;
+
+In this mode, the iterator will only read from the statement handle on demand.  This can reduce a lot of overhead for large queries where you are only iterating through a small amount.  Note that in this mode the statement handle is kept active until all the data is fetched or the iterator is destroyed.
+
 =head1 CAVEAT
 
 Note that there is no provision for the data changing &#40;or even being
@@ -50,10 +61,20 @@
 		_data   =&gt; $data,
 		_mapper =&gt; [@mapper],
 		_place  =&gt; 0,
+		_sth	=&gt; undef,
 		},
 		ref $me || $me;
 }
 
+sub sth {
+	my $self = shift;
+	
+	if&#40; @_ &#41; {
+		$self-&gt;{_sth} = shift;
+	}
+	return $self-&gt;{_sth};
+}
+
 sub set_mapping_method {
 	my &#40;$self, @mapper&#41; = @_;
 	$self-&gt;{_mapper} = [@mapper];
@@ -61,9 +82,53 @@
 }
 
 sub class  { shift-&gt;{_class} }
-sub data   { @{ shift-&gt;{_data} } }
 sub mapper { @{ shift-&gt;{_mapper} } }
 
+sub next_data {
+	my $self = shift;
+	my $place = $self-&gt;{_place}++;
+
+	if&#40; !defined $self-&gt;{_data}[$place]
+	 	and &#40;my $sth = $self-&gt;{_sth}&#41; &#41; 
+	{
+		$self-&gt;_fill_in_data_from_sth&#40;$place&#41;;		
+		return $self-&gt;{_data}[$place];
+	}
+	
+	return $self-&gt;{_data}[$place]; 
+}
+
+sub _sth_next {
+	my $self = shift;
+	
+	my $sth = $self-&gt;{_sth};
+	return unless $sth-&gt;{Active};
+	
+	my $row = $sth-&gt;fetchrow_hashref;
+	return unless $row;
+
+	push @{$self-&gt;{_data}}, $row;
+	return $row;
+}
+
+sub _fill_in_data_from_sth {
+	my&#40;$self, $place&#41; = @_;
+
+	while&#40; $#{$self-&gt;{_data}} &lt; $place &#41; {
+		last unless defined $self-&gt;_sth_next;
+	}
+}
+
+sub data {
+	my $self = shift;
+	
+	if&#40; my $sth = $self-&gt;{_sth} &#41; {
+		$self-&gt;_fill_in_data_from_sth&#40;&#34;Inf&#34;&#41;;
+	}
+	
+	return @{$self-&gt;{_data} || []};
+}
+
 sub count {
 	my $self = shift;
 	$self-&gt;{_count} ||= scalar $self-&gt;data;
@@ -71,7 +136,7 @@
 
 sub next {
 	my $self = shift;
-	my $use  = $self-&gt;{_data}-&gt;[ $self-&gt;{_place}++ ] or return;
+	my $use  = $self-&gt;next_data or return;
 	my @obj  = &#40;$self-&gt;class-&gt;construct&#40;$use&#41;&#41;;
 	foreach my $meth &#40;$self-&gt;mapper&#41; {
 		@obj = map $_-&gt;$meth&#40;&#41;, @obj;
@@ -107,7 +172,10 @@
 	while &#40;my $obj = $self-&gt;next&#41; {
 		$obj-&gt;delete;
 	}
+	
 	$self-&gt;{_data} = [];
+	$self-&gt;{_sth}  = undef;
+	
 	1;
 }
 

==== BEGIN SVK PATCH BLOCK ====
Version: svk v2.0.0 &#40;darwin&#41;

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
==== END SVK PATCH BLOCK ====
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-291940" href="/Public/Bug/Display.html?id=24959#txn-291940">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;18&nbsp;16:43:56&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/291940/131709/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/131709">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 803b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s the next iteration of the iterator class.  The last one had
performance problems and only allowed one iterator.  This one creates
two iterators: PreFetch, which is the current iterator; and OnDemand
which fetches on demand.  PreFetch remains the default.

The iterator interface has changed, but only undocumented portions.

* new&#40;&#41; now takes a hash
* mapper&#40;&#41; is now mappers&#40;&#41; and set_mapping_method&#40;&#41; is now
set_mapping_methods&#40;&#41; to reflect that they take multiple mappers.

Class::DBI now gives an iterator a prepared but inactive statement
handle, plus the bind params, to give the iterator maximum flexibility.
 Iterators can also accept a list of already fetched rows.

Performance of the OnDemand iterator is now approaching PreFetch when
fetching all rows, I&#39;m working on closing the gap.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/291940/131712/ondemand2.patch">Download ondemand2.patch</a><br />
<span class="downloadcontenttype">text/x-diff 30.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-291942" href="/Public/Bug/Display.html?id=24959#txn-291942">#</a>      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;18&nbsp;16:44:00&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction links AddLink even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-292685" href="/Public/Bug/Display.html?id=24959#txn-292685">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;20:58:59&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Dependency on ticket #25073 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-292689" href="/Public/Bug/Display.html?id=24959#txn-292689">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:11:04&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/292689/132128/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/132128">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This should be the final version of the iterator patch.  The performance
of the OnDemand iterator has been improved to where its only 10-20%
slower than the default PreFetch when fetching all objects.  The
OnDemand iterator caches and will turn itself into a PreFetch iterator
in situations where its going to have to fetch all the rows anyway &#40;such
as count&#40;&#41;&#41;.

A new iterator was added, OnDemand::Opportunistic &#40;yeah, not the best
name&#41;.  This starts as an OnDemand iterator and then after fetching 100
&#40;default&#41; rows it turns itself into a PreFetch iterator.  This allows it
to have the performance of OnDemand when you only fetch out a few rows
from a large query but also the performance of PreFetch when you fetch
out lots.  It should match or beat PreFetch&#39;s performance in all cases.
 Its worth considering using this as the CDBI default iterator.

Finally, taking advantage on changes to statement handle caching in
Ima::DBI &#40;see 24959&#41; statement handle caching has been turned back on
for all statements.  Only the individual call to sql_* to get the handle
passed to the iterator is not cached to avoid two iterators having the
same handle.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/292689/132131/iterator.patch">Download iterator.patch</a><br />
<span class="downloadcontenttype">text/x-diff 40.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-292691" href="/Public/Bug/Display.html?id=24959#txn-292691">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:11:36&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/292691/132133/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/132133">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 21 21:11:04 2007, MSCHWERN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Finally, taking advantage on changes to statement handle caching in
&gt; Ima::DBI &#40;see 24959&#41;
</div>
Make that 25073.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-292697" href="/Public/Bug/Display.html?id=24959#txn-292697">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;21&nbsp;21:58:17&nbsp;2007</span>
    <span class="description">mschwern [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/292697/132144/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/132144">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 365b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">One last revision.  This one makes two changes.

* All three iterators are tested by 21-iterator.t
* The iterators take care to finish their statement handles on DESTROY
to avoid leaving an active statement handle around maybe cached
somewhere.  This probably isn&#39;t necessary as these statement handles are
not cached by DBI any more, but I&#39;m not taking the chance.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/292697/132147/iterator.patch">Download iterator.patch</a><br />
<span class="downloadcontenttype">text/x-diff 47.2k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.691227</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
