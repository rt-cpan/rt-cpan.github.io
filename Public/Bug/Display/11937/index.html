<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #11937 for WWW-Mediawiki-Client: Error handling fixes</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #11937 for WWW-Mediawiki-Client: Error handling fixes</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/WWW-Mediawiki-Client/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/WWW-Mediawiki-Client/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/WWW-Mediawiki-Client/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/WWW-Mediawiki-Client/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/WWW-Mediawiki-Client">WWW-Mediawiki-Client CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">11937</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/WWW-Mediawiki-Client/Active/">WWW-Mediawiki-Client</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">markj [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bkaindl [...] ffii.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-36256-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.23    </td>
  </tr>
  <tr id="CF-36257-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;19&nbsp;00:37:59&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Error handling fixes</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached a patch to fix a number or error handling issues where I ran into
while trying the script on a custom mediawiki install.

Issue 1 was that the error message one gets when he forgets to prefix
the hostname with &#34;http://&#34; is misleading the messages generated were:

Use of uninitialized value in pattern match &#40;m//&#41; at /usr/lib/perl5/vendor_perl/5.8.5/HTTP/Cookies.pm line 45.
Saving cookie jar.

The cause is that Cookies.pm looks at the URI&#39;s scheme and without the http:// prefix, URI-&gt;scheme is uninitilized. Other functions require it
too. Since Cookies.pm does not support https://, http:// could be automatically prepended, but for now, I just changed the error reporting:

Use of uninitialized value in pattern match &#40;m//&#41; at /usr/lib/perl5/vendor_perl/5.8.5/HTTP/Cookies.pm line 45.
Login to bernhard.a11.private/mw/wiki.phtml?action=submit&#38;title=Special:Userlogin failed
Error code: 400 URL must be absolute
Tip: If the hostname didn&#39;t start with &#39;http://&#39; add it.

Issue 2: If a different problem prevented login &#40;wrong user name, login path or password&#41;, no indication of an error was given, with the patch this error is given:

Logging in as WikiSysop
Login did not work, please check host, login path, user and password.

If another error, eg. one caused a mispelled URI scheme in the hostname occurs, then just the error message from the perl libary is reported to the user:

Login to htp://bernhard.a11.private/mw/wiki.phtml?action=submit&#38;title=Special:Userlogin failed
Error code: 501 Protocol scheme &#39;htp&#39; is not supported

Issue 3: Just beautified an error message:

0.23:
Couldn&#39;t fetch Main Page.wiki from the server.HTTP get failed with: 501 at /usr/bin/mvs line 83

with patch:
Couldn&#39;t fetch &#34;Main Page.wiki&#34; from the server.
HTTP get failed with: 501 Protocol scheme &#39;htp&#39; is not supported at /usr/bin/mvs line 83

Detail about Issue 1-3:

In all the above cases, the login info was written, despite the
login was not successful, the patch fixes this too, &#40;the info is
not useful without the login cookie&#41;.

Issue 4: If the server requires login for editing and a working .mediawiki file, but a failed login &#40;no cookie&#41; in .mediawiki_cookies.dat, the mvs update message looked like this:

mvs up &#39;Main Page.wiki&#39;
Updating: Main Page.wiki
Fetching <span class="clickylink"><a target="new" rel="nofollow" href="http://bernhard.a11.private/mw/wiki.phtml?action=edit&#38;title=Main">http://bernhard.a11.private/mw/wiki.phtml?action=edit&#38;title=Main</a></span> Page
Loading Main Page.wiki
Loading ./.Main Page.ref.wiki
A Main Page.wiki

So there was no error message, just the &#34;A&#34; flag looks strange because 
the page exists on the server, but it could not be retrieved since
there is no login cookie.

With the patch, the messages look like this:

mvs up &#39;Main Page.wiki&#39;
Updating: Main Page.wiki
Fetching <span class="clickylink"><a target="new" rel="nofollow" href="http://bernhard.a11.private/mw/wiki.phtml?action=edit&#38;title=Main">http://bernhard.a11.private/mw/wiki.phtml?action=edit&#38;title=Main</a></span> Page
Error message from the server: Login required to edit

If the error message from the wikipedia server cannot be parsed, 
the content of the server&#39;s answer is shown and the last message is:

Unknown error, the above is I got from the server.

I also did a update of the docmentation in the mvs script.

I also did a spelling fix, copyright notice expansion to 2004-2005
and added me as contributor, but these are only hints, I don&#39;t require
to be listed, I just added it for completeness.
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/WWW/Mediawiki/Client.pm	2005/03/19 03:43:37	1.1
+++ lib/WWW/Mediawiki/Client.pm	2005/03/19 05:20:22
@@ -345,7 +345,7 @@
     croak &#34;Must have username and password to login.&#34;
             unless $self-&gt;{username} &#38;&#38; $self-&gt;{password};
     print { $self-&gt;{info_fh} } 
-            &#34;Loging in as &#34; . $self-&gt;{username} . &#34;\n&#34;;
+            &#34;Logging in as &#34; . $self-&gt;{username} . &#34;\n&#34;;
     my $url = $self-&gt;{site_url} . &#39;/&#39; . $self-&gt;{login_path};
     my $username_tag = USERNAME_NAME;
     my $password_tag = PASSWORD_NAME;
@@ -360,6 +360,19 @@
             $submit_tag     =&gt; $submitval,
         ]
     &#41;;
+
+    if &#40;$res-&gt;is_success&#41; {
+	print STDERR &#34;Login did not work, please check host, login path, user and password.\n&#34;;
+        return $self;
+    }
+    if &#40;$res-&gt;code != 302&#41; {
+        print STDERR &#34;Login to &#34;, $url, &#34; failed\n&#34;;
+        print STDERR &#34;Error code: &#34;, $res-&gt;status_line, &#34;\n&#34;;
+        if &#40;$res-&gt;code == 400&#41; {
+		print STDERR &#34;Tip: If the hostname didn&#39;t start with &#39;http://&#39; add it.\n&#34;;
+        }
+        return $self;
+    }
     print { $self-&gt;{debug_fh} } &#34;Saving cookie jar.\n&#34;;
     $self-&gt;{ua}-&gt;cookie_jar-&gt;save
             or croak &#34;Could not save cookie jar.&#34;;
@@ -618,20 +631,27 @@
     my $url = $self-&gt;_filename_to_edit_url&#40;$filename&#41;;
     print { $self-&gt;{debug_fh} }&#34;Fetching $url\n&#34;;
     my $res = $self-&gt;{ua}-&gt;get&#40;$url&#41;;
-    croak &#34;Couldn&#39;t fetch $filename from the server.&#34;
-            . &#34;HTTP get failed with: &#34; . $res-&gt;code
+    croak &#34;Couldn&#39;t fetch \&#34;$filename\&#34; from the server.&#34;
+            . &#34;\nHTTP get failed with: &#34; . $res-&gt;status_line
             unless $res-&gt;is_success;
     my $doc = $res-&gt;content;
-    my $text = $self-&gt;_get_wiki_text&#40;$doc&#41;;
+    my $text = $self-&gt;_get_wiki_tag&#40;$doc, &#34;textarea&#34;&#41;;
     $self-&gt;{server_date} = $self-&gt;_get_edit_date&#40;$doc&#41;;
     $self-&gt;{server_token} = $self-&gt;_get_edit_token&#40;$doc&#41;;
+    if &#40;!$self-&gt;{server_date}&#41; {
+    	my $headline1 = $self-&gt;_get_wiki_tag&#40;$doc, &#34;h1&#34;&#41;;
+	die &#34;Error message from the server: &#34;, $headline1, &#34;\n&#34;
+        	if &#40;$headline1&#41;;
+	die &#34;Could not identify the error, this is what I got:\n&#34; . $res-&gt;content
+		. &#34;Unknown error, the above is I got from the server.\n&#34;;
+    }
     return $text;
 }
 
-sub _get_wiki_text {
-    my &#40;$self, $doc&#41; = @_;
+sub _get_wiki_tag {
+    my &#40;$self, $doc, $tag&#41; = @_;
     my $p = HTML::TokeParser-&gt;new&#40;\$doc&#41;;
-    $p-&gt;get_tag&#40;&#34;textarea&#34;&#41;;
+    $p-&gt;get_tag&#40;$tag&#41;;
     my $text = $p-&gt;get_text;
     $text =~ s///gs;                      # convert endlines
     return $text;
--- bin/mvs	2005/03/19 03:31:33	1.1
+++ bin/mvs	2005/03/19 03:55:17
@@ -112,11 +112,17 @@
 
   mvs [-q|-v] [-d &lt;wikihost&gt;] [-u &lt;username&gt;] [-p &lt;password&gt; ] login
 
+   If your mediawiki install uses a nonstandard login path, speciy
+   it on login:
+      -l &#39;mw/wiki.phtml?action=submit&#38;title=Special:Userlogin&#39;
+   You can change the edit and action paths in the created .mediawiki
+   file after successful login accordingly.
+
   mvs [-q|-v] update [&lt;file&gt; ..]
   mvs [-q|-v] up [&lt;file&gt; ..]
 
-  mvs [-q|-v] commit [&lt;file&gt; ..]
-  mvs [-q|-v] com [&lt;file&gt; ..]
+  mvs [-q|-v] -m &#34;commit message&#34; commit [&lt;file&gt; ..]
+  mvs [-q|-v] -m &#34;commit message&#34; com [&lt;file&gt; ..]
 
 =head1 DESCRIPTION
 
@@ -397,10 +403,11 @@
 =head1 AUTHORS
 
 Mark Jaroski &lt;mark@geekhive.net&gt;
+Minor contributions &#40;error handing&#41; from Bernhard Kaindl &lt;bkaindl@ffii.org&gt;
 
 =head1 COPYRIGHT
 
-Â© Copyright 2004, Mark Jaroski
+Â© Copyright 2004-2005, Mark Jaroski
 
 All rights reserved. This program is free software; you can redistribute it
 and/or modify it under the same terms as Perl itself.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;19&nbsp;01:28:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Bernhard Kaindl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just to mention explictly: The patch &#40;the download button for it is on
the right side on the bottom, you might have to scroll the page right to
see it&#41;  for Version 0.23.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;22&nbsp;10:11:32&nbsp;2005</span>
    <span class="description">markj [...] cpan.org -  Given to MARKJ</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;May&nbsp;22&nbsp;10:11:32&nbsp;2005</span>
    <span class="description">markj [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
