<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #104247 for Filesys-Notify-KQueue: Timeout implementation doesn&#39;t match IO::KQueue</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #104247 for Filesys-Notify-KQueue: Timeout implementation doesn&#39;t match IO::KQueue</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Filesys-Notify-KQueue/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Filesys-Notify-KQueue/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Filesys-Notify-KQueue/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Filesys-Notify-KQueue/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/karupanerura/p5-Filesys-Notify-KQueue/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Filesys-Notify-KQueue">Filesys-Notify-KQueue CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">104247</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Filesys-Notify-KQueue/Active/">Filesys-Notify-KQueue</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
tlinden [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-240474-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-240475-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;06&nbsp;03:31:21&nbsp;2015</span>
    <span class="description">tlinden [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Timeout implementation doesn&#39;t match IO::KQueue</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

the IO::KQueue pod says about the kevent&#40;&#41; timeout parameter:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Timeout is in milliseconds. If timeout is ommitted then we wait
&gt; forever until there are events to read. If timeout is zero then
&gt; we return immediately.
</div>
So I used a timeout of 0 like:

  my $notify = Filesys::Notify::KQueue-&gt;new&#40;
                                            path    =&gt; [$dir],
                                            timeout =&gt; 0,
                                           &#41;;

However, the wait&#40;&#41; call never returned. The problem was, that the parameter was ignored if 0:

  $self-&gt;timeout&#40;$args-&gt;{timeout} || $class-&gt;default_timeout&#41;;

But after changing this, it still didn&#39;t work because of this:

  sub wait {
    my &#40;$self, $cb&#41; = @_;

    my $events = $self-&gt;get_events;
    until &#40;@$events&#41; {
        $events = $self-&gt;get_events;
    }
  [..]

It runs endless til some event occurs, which is not what I wanted.

So, the attached patch fixes both issues and allows to use a timeout of 0, which causes wait&#40;&#41; to return immediately, with or without events.

However, there&#39;s still an issue with the timeout. Because, according to the mentioned kevent&#40;&#41; documentation I&#39;d expect wait&#40;&#41; to return after the given timeout has been reached, or to return immediately if set to 0, or to never return if no timeout was given.

The current implementation does never return, with the supplied patch it at least implements timeout zero, but this needs to be reworked, I think, as a whole. In short, this is what I would expect:

 timeout =&gt; 0     # return immediately
 timeout =&gt; &gt;1    # return after timeout
 timeout =&gt; undef # never return


best regards,
Tom
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> p5-filesys-notify-kqueue.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">*** /localdisk/work/usr/ports/devel/p5-Filesys-Notify-KQueue/work/Filesys-Notify-KQueue-0.08/lib/Filesys/Notify/KQueue.pm       Tue Dec 13 16:24:34 2011
--- /usr/local/lib/perl5/site_perl/5.10.1/Filesys/Notify/KQueue.pm      Wed May  6 09:15:49 2015
***************
*** 13,19 ****
      my $args  = &#40;@_ == 1&#41; ? $_[0] : +{ @_ };
      my $self  = bless&#40;+{} =&gt; $class&#41;;
  
!     $self-&gt;timeout&#40;$args-&gt;{timeout} || $class-&gt;default_timeout&#41;;
      $self-&gt;{_kqueue} = $args-&gt;{kqueue} if exists&#40;$args-&gt;{kqueue}&#41;;
      $self-&gt;add&#40;@{$args-&gt;{path}}&#41;       if exists&#40;$args-&gt;{path}&#41;;
  
--- 13,19 ----
      my $args  = &#40;@_ == 1&#41; ? $_[0] : +{ @_ };
      my $self  = bless&#40;+{} =&gt; $class&#41;;
  
!     $self-&gt;timeout&#40;exists $args-&gt;{timeout} ? $args-&gt;{timeout} : $class-&gt;default_timeout&#41;;
      $self-&gt;{_kqueue} = $args-&gt;{kqueue} if exists&#40;$args-&gt;{kqueue}&#41;;
      $self-&gt;add&#40;@{$args-&gt;{path}}&#41;       if exists&#40;$args-&gt;{path}&#41;;
  
***************
*** 99,106 ****
      my &#40;$self, $cb&#41; = @_;
  
      my $events = $self-&gt;get_events;
!     until &#40;@$events&#41; {
!         $events = $self-&gt;get_events;
      }
  
      $cb-&gt;&#40;@$events&#41;;
--- 99,109 ----
      my &#40;$self, $cb&#41; = @_;
  
      my $events = $self-&gt;get_events;
! 
!     if&#40;$self-&gt;timeout&#41; {
!         until &#40;@$events&#41; {
!             $events = $self-&gt;get_events;
!         }
      }
  
      $cb-&gt;&#40;@$events&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;21:31:23&nbsp;2015</span>
    <span class="description">karupa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thank you for reporting.

I applied your patch, and released it as version 0.10.
 Many thanks!

Kenta SATO

On 2015-5月-06 水 03:31:21, TLINDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; the IO::KQueue pod says about the kevent&#40;&#41; timeout parameter:
&gt; 
<div class="message-stanza open">&gt; &gt; Timeout is in milliseconds. If timeout is ommitted then we wait
&gt; &gt; forever until there are events to read. If timeout is zero then
&gt; &gt; we return immediately.
</div>&gt; 
&gt; So I used a timeout of 0 like:
&gt; 
&gt; my $notify = Filesys::Notify::KQueue-&gt;new&#40;
&gt;                                           path    =&gt; [$dir],
&gt;                                           timeout =&gt; 0,
&gt;                                          &#41;;
&gt; 
&gt; However, the wait&#40;&#41; call never returned. The problem was, that the
&gt; parameter was ignored if 0:
&gt; 
&gt; $self-&gt;timeout&#40;$args-&gt;{timeout} || $class-&gt;default_timeout&#41;;
&gt; 
&gt; But after changing this, it still didn&#39;t work because of this:
&gt; 
&gt; sub wait {
&gt;   my &#40;$self, $cb&#41; = @_;
&gt; 
&gt; my $events = $self-&gt;get_events;
&gt; until &#40;@$events&#41; {
&gt;     $events = $self-&gt;get_events;
&gt; }
&gt; [..]
&gt; 
&gt; It runs endless til some event occurs, which is not what I wanted.
&gt; 
&gt; So, the attached patch fixes both issues and allows to use a timeout
&gt; of 0, which causes wait&#40;&#41; to return immediately, with or without
&gt; events.
&gt; 
&gt; However, there&#39;s still an issue with the timeout. Because, according
&gt; to the mentioned kevent&#40;&#41; documentation I&#39;d expect wait&#40;&#41; to return
&gt; after the given timeout has been reached, or to return immediately if
&gt; set to 0, or to never return if no timeout was given.
&gt; 
&gt; The current implementation does never return, with the supplied patch
&gt; it at least implements timeout zero, but this needs to be reworked, I
&gt; think, as a whole. In short, this is what I would expect:
&gt; 
&gt; timeout =&gt; 0     # return immediately
&gt; timeout =&gt; &gt;1    # return after timeout
&gt; timeout =&gt; undef # never return
&gt; 
&gt; 
&gt; best regards,
&gt; Tom
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;21:31:24&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;05&nbsp;21:31:25&nbsp;2015</span>
    <span class="description">karupa [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
