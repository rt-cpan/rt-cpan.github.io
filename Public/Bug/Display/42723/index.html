<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42723 for DBD-mysql: Binding server side integer parameters results in corrupt data</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42723 for DBD-mysql: Binding server side integer parameters results in corrupt data</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-mysql/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-mysql/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42723</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-mysql/Active/">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CAPTTOFU [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
andreas.stahlbauer [...] tngtech.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;09:57:40&nbsp;2009</span>
    <span class="description">andreas.stahlbauer [...] tngtech.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Binding server side integer parameters results in corrupt data</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 23 Jan 2009 15:55:01 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-mysql [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Andreas Stahlbauer &lt;andreas.stahlbauer [...] tngtech.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Server side prepared statements do not work in version 4.010 of
DBD::mysql correctly. Binded integer-parameters are not passed correctly
to the database if mysql_server_prepare is enabled &#40;see below&#41;. Version
4.007 of the module works fine. Version 4.008 and 4.009 have not been
tested.

Thanks

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">---------- Environment infos -----------
   DBD::mysql, version 4.010
   DBI, version 1.607
   perl, v5.10.0 built for i486-linux-gnu-thread-multi
   Linux myhost 2.6.27-7-generic #1 SMP Tue Nov 4 19:33:20 UTC 2008 i686
GNU/Linux


<div class="message-stanza open">---------- Steps to reproduce ----------

Create the following table &#40;used for testing&#41;:

CREATE TABLE `inttest` &#40;
  `fld_integer` int&#40;11&#41; DEFAULT NULL,
  `fld_smallint` smallint&#40;6&#41; DEFAULT NULL,
  `fld_tinyint` tinyint&#40;4&#41; DEFAULT NULL,
  `fld_bigint` bigint&#40;20&#41; DEFAULT NULL
&#41; ENGINE=InnoDB DEFAULT CHARSET=utf8

Script that results in wrong data:

use strict;
use DBI;
use DBI qw&#40;:sql_types&#41;;

# Using mysql_server_prepare!!!
my $dbh =
DBI-&gt;connect&#40;&#34;DBI:mysql:dbname=testdb;host=127.0.0.1;port=3306;mysql_server_prepare=1&#34;,
&#34;root&#34;, &#34;&#34;&#41; or die $!;
my $sth = $dbh-&gt;prepare&#40;&#34;INSERT INTO inttest VALUES &#40;?,?,?,?&#41;&#34;&#41;;

$sth-&gt;bind_param&#40;1, 101, SQL_INTEGER&#41;;
$sth-&gt;bind_param&#40;2, 102, SQL_SMALLINT&#41;;
$sth-&gt;bind_param&#40;3, 103, SQL_TINYINT&#41;;
$sth-&gt;bind_param&#40;4, 104, SQL_BIGINT&#41;;

# This execute works fine, but does not insert the desired values!
# &#40;using version 4.010 of the DBD::mysql; version 4.007 works fine in
this case!!!!&#41;
#
#  3223601 is inserted instead of 101 &#40;sql type INTEGER&#41;
#  32767 is inserted instead of 102 &#40;sql type SMALLINT&#41;
#  127 is inserted instead of 103 &#40;sql type TINYINT&#41;
#   3420209 is inserted instead of 104 &#40;sql type BIGINT&#41;
#
$sth-&gt;execute&#40;&#41; or die $!;
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;13:07:20&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;13:08:29&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 23 09:57:40 2009, andreas.stahlbauer@tngtech.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; Server side prepared statements do not work in version 4.010 of
&gt; DBD::mysql correctly. Binded integer-parameters are not passed
&gt; correctly
&gt; to the database if mysql_server_prepare is enabled &#40;see below&#41;.
&gt; Version
&gt; 4.007 of the module works fine. Version 4.008 and 4.009 have not been
&gt; tested.
&gt; 
&gt; Thanks
&gt; 
&gt; ---------- Environment infos -----------
&gt;    DBD::mysql, version 4.010
&gt;    DBI, version 1.607
&gt;    perl, v5.10.0 built for i486-linux-gnu-thread-multi
&gt;    Linux myhost 2.6.27-7-generic #1 SMP Tue Nov 4 19:33:20 UTC 2008
&gt; i686
&gt; GNU/Linux
&gt; 
&gt; 
&gt; ---------- Steps to reproduce ----------
&gt; 
&gt; Create the following table &#40;used for testing&#41;:
&gt; 
&gt; CREATE TABLE `inttest` &#40;
&gt;   `fld_integer` int&#40;11&#41; DEFAULT NULL,
&gt;   `fld_smallint` smallint&#40;6&#41; DEFAULT NULL,
&gt;   `fld_tinyint` tinyint&#40;4&#41; DEFAULT NULL,
&gt;   `fld_bigint` bigint&#40;20&#41; DEFAULT NULL
&gt; &#41; ENGINE=InnoDB DEFAULT CHARSET=utf8
&gt; 
&gt; Script that results in wrong data:
&gt; 
&gt; use strict;
&gt; use DBI;
&gt; use DBI qw&#40;:sql_types&#41;;
&gt; 
&gt; # Using mysql_server_prepare!!!
&gt; my $dbh =
&gt; DBI-
&gt;
&gt;connect&#40;&#34;DBI:mysql:dbname=testdb;host=127.0.0.1;port=3306;mysql_server_prepare=1&#34;,
&gt; &#34;root&#34;, &#34;&#34;&#41; or die $!;
&gt; my $sth = $dbh-&gt;prepare&#40;&#34;INSERT INTO inttest VALUES &#40;?,?,?,?&#41;&#34;&#41;;
&gt; 
&gt; $sth-&gt;bind_param&#40;1, 101, SQL_INTEGER&#41;;
&gt; $sth-&gt;bind_param&#40;2, 102, SQL_SMALLINT&#41;;
&gt; $sth-&gt;bind_param&#40;3, 103, SQL_TINYINT&#41;;
&gt; $sth-&gt;bind_param&#40;4, 104, SQL_BIGINT&#41;;
&gt; 
&gt; # This execute works fine, but does not insert the desired values!
&gt; # &#40;using version 4.010 of the DBD::mysql; version 4.007 works fine in
&gt; this case!!!!&#41;
&gt; #
&gt; #  3223601 is inserted instead of 101 &#40;sql type INTEGER&#41;
&gt; #  32767 is inserted instead of 102 &#40;sql type SMALLINT&#41;
&gt; #  127 is inserted instead of 103 &#40;sql type TINYINT&#41;
&gt; #   3420209 is inserted instead of 104 &#40;sql type BIGINT&#41;
&gt; #
&gt; $sth-&gt;execute&#40;&#41; or die $!;
&gt; 
</div>

Hi, and thank you for this report. I&#39;ll look into this.

regards,

Patrick
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;23&nbsp;13:08:29&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;00:00:38&nbsp;2009</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jan 23 13:08:29 2009, CAPTTOFU wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jan 23 09:57:40 2009, andreas.stahlbauer@tngtech.com wrote:
<div class="message-stanza open">&gt; &gt; Hi,
&gt; &gt;
&gt; &gt; Server side prepared statements do not work in version 4.010 of
&gt; &gt; DBD::mysql correctly. Binded integer-parameters are not passed
&gt; &gt; correctly
&gt; &gt; to the database if mysql_server_prepare is enabled &#40;see below&#41;.
&gt; &gt; Version
&gt; &gt; 4.007 of the module works fine. Version 4.008 and 4.009 have not
</div>&gt; been
<div class="message-stanza open">&gt; &gt; tested.
&gt; &gt;
&gt; &gt; Thanks
&gt; &gt;
&gt; &gt; ---------- Environment infos -----------
&gt; &gt;    DBD::mysql, version 4.010
&gt; &gt;    DBI, version 1.607
&gt; &gt;    perl, v5.10.0 built for i486-linux-gnu-thread-multi
&gt; &gt;    Linux myhost 2.6.27-7-generic #1 SMP Tue Nov 4 19:33:20 UTC 2008
&gt; &gt; i686
&gt; &gt; GNU/Linux
&gt; &gt;
&gt; &gt;
&gt; &gt; ---------- Steps to reproduce ----------
&gt; &gt;
&gt; &gt; Create the following table &#40;used for testing&#41;:
&gt; &gt;
&gt; &gt; CREATE TABLE `inttest` &#40;
&gt; &gt;   `fld_integer` int&#40;11&#41; DEFAULT NULL,
&gt; &gt;   `fld_smallint` smallint&#40;6&#41; DEFAULT NULL,
&gt; &gt;   `fld_tinyint` tinyint&#40;4&#41; DEFAULT NULL,
&gt; &gt;   `fld_bigint` bigint&#40;20&#41; DEFAULT NULL
&gt; &gt; &#41; ENGINE=InnoDB DEFAULT CHARSET=utf8
&gt; &gt;
&gt; &gt; Script that results in wrong data:
&gt; &gt;
&gt; &gt; use strict;
&gt; &gt; use DBI;
&gt; &gt; use DBI qw&#40;:sql_types&#41;;
&gt; &gt;
&gt; &gt; # Using mysql_server_prepare!!!
&gt; &gt; my $dbh =
&gt; &gt; DBI-
&gt; &gt;
</div>&gt;
&gt;connect&#40;&#34;DBI:mysql:dbname=testdb;host=127.0.0.1;port=3306;mysql_server_prepare=1&#34;,
<div class="message-stanza open">&gt; &gt; &#34;root&#34;, &#34;&#34;&#41; or die $!;
&gt; &gt; my $sth = $dbh-&gt;prepare&#40;&#34;INSERT INTO inttest VALUES &#40;?,?,?,?&#41;&#34;&#41;;
&gt; &gt;
&gt; &gt; $sth-&gt;bind_param&#40;1, 101, SQL_INTEGER&#41;;
&gt; &gt; $sth-&gt;bind_param&#40;2, 102, SQL_SMALLINT&#41;;
&gt; &gt; $sth-&gt;bind_param&#40;3, 103, SQL_TINYINT&#41;;
&gt; &gt; $sth-&gt;bind_param&#40;4, 104, SQL_BIGINT&#41;;
&gt; &gt;
&gt; &gt; # This execute works fine, but does not insert the desired values!
&gt; &gt; # &#40;using version 4.010 of the DBD::mysql; version 4.007 works fine
</div>&gt; in
<div class="message-stanza open">&gt; &gt; this case!!!!&#41;
&gt; &gt; #
&gt; &gt; #  3223601 is inserted instead of 101 &#40;sql type INTEGER&#41;
&gt; &gt; #  32767 is inserted instead of 102 &#40;sql type SMALLINT&#41;
&gt; &gt; #  127 is inserted instead of 103 &#40;sql type TINYINT&#41;
&gt; &gt; #   3420209 is inserted instead of 104 &#40;sql type BIGINT&#41;
&gt; &gt; #
&gt; &gt; $sth-&gt;execute&#40;&#41; or die $!;
&gt; &gt;
</div>&gt; 
&gt; 
&gt; Hi, and thank you for this report. I&#39;ll look into this.
&gt; 
&gt; regards,
&gt; 
&gt; Patrick
</div>
Here&#39;s a patch to fix this issue, I also included the supplied test.

This issue was introduced with svn rev 11997.
The revision got rid of a test that would only set the buffer length to
the length of the supplied string when it was a blob type. Without that
test the buffer length for integers and floats was being set to the
string length of the passed in value.

This code was originally in the patch submitted for bug #40278
&#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=40278&#41;">http://rt.cpan.org/Public/Bug/Display.html?id=40278&#41;</a></span>, it must have
gotten lost in cleaning up the patch before submitting it to svn.

-Daniel Frett
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: dbdimp.c
===================================================================
--- dbdimp.c	&#40;revision 12683&#41;
+++ dbdimp.c	&#40;working copy&#41;
@@ -4322,8 +4322,15 @@
           break;
       }
 
-      buffer= SvPV&#40;imp_sth-&gt;params[idx].value, slen&#41;;
-      buffer_length= slen;
+      if &#40;buffer_type == MYSQL_TYPE_STRING || buffer_type == MYSQL_TYPE_BLOB&#41;
+      {
+        buffer= SvPV&#40;imp_sth-&gt;params[idx].value, slen&#41;;
+        buffer_length= slen;
+        if &#40;DBIc_TRACE_LEVEL&#40;imp_xxh&#41; &gt;= 2&#41;
+          PerlIO_printf&#40;DBILOGFP,
+                        &#34; SCALAR type %d -&gt;length %d&lt;- IS A STRING or BLOB\n&#34;,
+                        sql_type, buffer_length&#41;;
+      }
     }
     else
     {
Index: t/40server_prepare.t
===================================================================
--- t/40server_prepare.t	&#40;revision 12683&#41;
+++ t/40server_prepare.t	&#40;working copy&#41;
@@ -19,7 +19,7 @@
 if &#40;$@&#41; {
     plan skip_all =&gt; &#34;ERROR: $@. Can&#39;t continue test&#34;;
 }
-plan tests =&gt; 10; 
+plan tests =&gt; 20; 
 
 ok&#40;defined $dbh, &#34;connecting&#34;&#41;;
 
@@ -45,4 +45,26 @@
 
 ok &#40;$dbh-&gt;do&#40;qq{DROP TABLE t1}&#41;, &#34;cleaning up&#34;&#41;;
 
+#
+# Bug #42723: Binding server side integer parameters results in corrupt data
+#
+ok&#40;$dbh-&gt;do&#40;qq{DROP TABLE IF EXISTS t2}&#41;, &#34;making slate clean&#34;&#41;;
+
+ok&#40;$dbh-&gt;do&#40;q{CREATE TABLE `t2` &#40;`i` int,`si` smallint,`ti` tinyint,`bi` bigint&#41;}&#41;, &#34;creating test table&#34;&#41;;
+
+my $sth2;
+ok&#40;$sth2 = $dbh-&gt;prepare&#40;&#39;INSERT INTO t2 VALUES &#40;?,?,?,?&#41;&#39;&#41;&#41;;
+
+#bind test values
+ok&#40;$sth2-&gt;bind_param&#40;1, 101, DBI::SQL_INTEGER&#41;, &#34;binding int&#34;&#41;;
+ok&#40;$sth2-&gt;bind_param&#40;2, 102, DBI::SQL_SMALLINT&#41;, &#34;binding smallint&#34;&#41;;
+ok&#40;$sth2-&gt;bind_param&#40;3, 103, DBI::SQL_TINYINT&#41;, &#34;binding tinyint&#34;&#41;;
+ok&#40;$sth2-&gt;bind_param&#40;4, 104, DBI::SQL_BIGINT&#41;, &#34;binding bigint&#34;&#41;;
+
+ok&#40;$sth2-&gt;execute&#40;&#41;, &#34;inserting data&#34;&#41;;
+
+is_deeply&#40;$dbh-&gt;selectall_arrayref&#40;&#39;SELECT * FROM t2&#39;&#41;, [[101, 102, 103, 104]]&#41;;
+
+ok &#40;$dbh-&gt;do&#40;qq{DROP TABLE t2}&#41;, &#34;cleaning up&#34;&#41;;
+
 $dbh-&gt;disconnect&#40;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;09:44:50&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">ugh, sorry I didn&#39;t get to this. Just finished my book, so I&#39;ll get this
patch in this week - thankyou!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;10:58:21&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Daniel,

could you please send me something to deal with:

t/40server_prepare..........Bareword &#34;DBI::SQL_BIGINT&#34; not allowed while
&#34;strict subs&#34; in use at t/40server_prepare.t line 62.


If you look at DBI.pm:

These constants are defined by SQL/CLI, ODBC or both.
C&lt;SQL_BIGINT&gt; is &#40;currently&#41; omitted, because SQL/CLI and ODBC provide
conflicting codes.


Thanks!

On Sat Apr 11 00:00:38 2009, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri Jan 23 13:08:29 2009, CAPTTOFU wrote:
<div class="message-stanza open">&gt; &gt; On Fri Jan 23 09:57:40 2009, andreas.stahlbauer@tngtech.com wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi,
&gt; &gt; &gt;
&gt; &gt; &gt; Server side prepared statements do not work in version 4.010 of
&gt; &gt; &gt; DBD::mysql correctly. Binded integer-parameters are not passed
&gt; &gt; &gt; correctly
&gt; &gt; &gt; to the database if mysql_server_prepare is enabled &#40;see below&#41;.
&gt; &gt; &gt; Version
&gt; &gt; &gt; 4.007 of the module works fine. Version 4.008 and 4.009 have not
</div>&gt; &gt; been
<div class="message-stanza open">&gt; &gt; &gt; tested.
&gt; &gt; &gt;
&gt; &gt; &gt; Thanks
&gt; &gt; &gt;
&gt; &gt; &gt; ---------- Environment infos -----------
&gt; &gt; &gt;    DBD::mysql, version 4.010
&gt; &gt; &gt;    DBI, version 1.607
&gt; &gt; &gt;    perl, v5.10.0 built for i486-linux-gnu-thread-multi
&gt; &gt; &gt;    Linux myhost 2.6.27-7-generic #1 SMP Tue Nov 4 19:33:20 UTC
</div></div>&gt; 2008
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; i686
&gt; &gt; &gt; GNU/Linux
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; ---------- Steps to reproduce ----------
&gt; &gt; &gt;
&gt; &gt; &gt; Create the following table &#40;used for testing&#41;:
&gt; &gt; &gt;
&gt; &gt; &gt; CREATE TABLE `inttest` &#40;
&gt; &gt; &gt;   `fld_integer` int&#40;11&#41; DEFAULT NULL,
&gt; &gt; &gt;   `fld_smallint` smallint&#40;6&#41; DEFAULT NULL,
&gt; &gt; &gt;   `fld_tinyint` tinyint&#40;4&#41; DEFAULT NULL,
&gt; &gt; &gt;   `fld_bigint` bigint&#40;20&#41; DEFAULT NULL
&gt; &gt; &gt; &#41; ENGINE=InnoDB DEFAULT CHARSET=utf8
&gt; &gt; &gt;
&gt; &gt; &gt; Script that results in wrong data:
&gt; &gt; &gt;
&gt; &gt; &gt; use strict;
&gt; &gt; &gt; use DBI;
&gt; &gt; &gt; use DBI qw&#40;:sql_types&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; # Using mysql_server_prepare!!!
&gt; &gt; &gt; my $dbh =
&gt; &gt; &gt; DBI-
&gt; &gt; &gt;
</div>&gt; &gt;
</div>&gt;
&gt;connect&#40;&#34;DBI:mysql:dbname=testdb;host=127.0.0.1;port=3306;mysql_server_prepare=1&#34;,
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &#34;root&#34;, &#34;&#34;&#41; or die $!;
&gt; &gt; &gt; my $sth = $dbh-&gt;prepare&#40;&#34;INSERT INTO inttest VALUES &#40;?,?,?,?&#41;&#34;&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; $sth-&gt;bind_param&#40;1, 101, SQL_INTEGER&#41;;
&gt; &gt; &gt; $sth-&gt;bind_param&#40;2, 102, SQL_SMALLINT&#41;;
&gt; &gt; &gt; $sth-&gt;bind_param&#40;3, 103, SQL_TINYINT&#41;;
&gt; &gt; &gt; $sth-&gt;bind_param&#40;4, 104, SQL_BIGINT&#41;;
&gt; &gt; &gt;
&gt; &gt; &gt; # This execute works fine, but does not insert the desired values!
&gt; &gt; &gt; # &#40;using version 4.010 of the DBD::mysql; version 4.007 works fine
</div>&gt; &gt; in
<div class="message-stanza open">&gt; &gt; &gt; this case!!!!&#41;
&gt; &gt; &gt; #
&gt; &gt; &gt; #  3223601 is inserted instead of 101 &#40;sql type INTEGER&#41;
&gt; &gt; &gt; #  32767 is inserted instead of 102 &#40;sql type SMALLINT&#41;
&gt; &gt; &gt; #  127 is inserted instead of 103 &#40;sql type TINYINT&#41;
&gt; &gt; &gt; #   3420209 is inserted instead of 104 &#40;sql type BIGINT&#41;
&gt; &gt; &gt; #
&gt; &gt; &gt; $sth-&gt;execute&#40;&#41; or die $!;
&gt; &gt; &gt;
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; Hi, and thank you for this report. I&#39;ll look into this.
&gt; &gt;
&gt; &gt; regards,
&gt; &gt;
&gt; &gt; Patrick
</div>&gt; 
&gt; Here&#39;s a patch to fix this issue, I also included the supplied test.
&gt; 
&gt; This issue was introduced with svn rev 11997.
&gt; The revision got rid of a test that would only set the buffer length
&gt; to
&gt; the length of the supplied string when it was a blob type. Without
&gt; that
&gt; test the buffer length for integers and floats was being set to the
&gt; string length of the passed in value.
&gt; 
&gt; This code was originally in the patch submitted for bug #40278
&gt; &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=40278&#41;">http://rt.cpan.org/Public/Bug/Display.html?id=40278&#41;</a></span>, it must have
&gt; gotten lost in cleaning up the patch before submitting it to svn.
&gt; 
&gt; -Daniel Frett
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;12:49:25&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please try out latest <span class="clickylink"><a target="new" rel="nofollow" href="http://svn.perl.org/modules/DBD-mysql/trunk">http://svn.perl.org/modules/DBD-mysql/trunk</a></span>


I will be releasing this, this week
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;12:49:26&nbsp;2009</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
