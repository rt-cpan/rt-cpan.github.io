<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #44747 for PDF-API2: [PATCH] Reduce PDF::API2 memory consumption</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #44747 for PDF-API2: [PATCH] Reduce PDF::API2 memory consumption</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">44747</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
NWELLNHOF [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;02&nbsp;09:35:26&nbsp;2009</span>
    <span class="description">NWELLNHOF [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Reduce PDF::API2 memory consumption</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m using PDF:API2 to generate PDFs on the fly on a web server.
Recently, I ran into the 32MB memory limit of a shared hosting provider.
So I had a look at the memory consumption of PDF::API2. After creating a
PDF::API2 object and loading some fonts, memory usage was about 25MB.
With the following fixes I managed to reduce that to about 15MB.

Most of the savings can be obtained if you only &#34;require&#34; some of the
PDF::API2 packages when needed. See the attached patch
pdf-api2-require-packages.diff.

I could also save about three additional MB by rewriting the code for
glyph name initialization. See the attached patch
pdf-api2-glyph-names.diff. Note that this patch breaks the function
initNameTable in PDF/API2 Util.pm. It doesn&#39;t seem to be part of the
public API, though, and it isn&#39;t used internally.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdf-api2-require-packages.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN -x fonts -x &#39;CJKFont*&#39; -x CMap PDF-API2-0.73/lib/PDF/API2.pm ../htdocs/cgi-bin/lib/PDF/API2.pm
--- PDF-API2-0.73/lib/PDF/API2.pm	2008-01-18 01:11:38.000000000 +0100
+++ ../htdocs/cgi-bin/lib/PDF/API2.pm	2009-02-11 15:27:54.000000000 +0100
@@ -53,46 +53,8 @@
     use PDF::API2::Util;
     use PDF::API2::Page;
 
-    use PDF::API2::Outlines;
-    use PDF::API2::NamedDestination;
-
     use PDF::API2::Version;
 
-    use PDF::API2::Resource::ExtGState;
-    use PDF::API2::Resource::Pattern;
-    use PDF::API2::Resource::Shading;
-
-    use PDF::API2::Resource::Font::CoreFont;
-    use PDF::API2::Resource::Font::Postscript;
-    use PDF::API2::Resource::Font::BdFont;
-    use PDF::API2::Resource::Font::SynFont;
-    use PDF::API2::Resource::Font::neTrueType;
-    use PDF::API2::Resource::CIDFont::TrueType;
-    use PDF::API2::Resource::CIDFont::CJKFont;
-    use PDF::API2::Resource::UniFont;
-
-    use PDF::API2::Resource::XObject::Image::JPEG;
-    use PDF::API2::Resource::XObject::Image::TIFF;
-    use PDF::API2::Resource::XObject::Image::PNM;
-    use PDF::API2::Resource::XObject::Image::PNG;
-    use PDF::API2::Resource::XObject::Image::GIF;
-    use PDF::API2::Resource::XObject::Image::GD;
-
-    use PDF::API2::Resource::XObject::Form::Hybrid;
-
-    use PDF::API2::Resource::XObject::Form::BarCode::int2of5;
-    use PDF::API2::Resource::XObject::Form::BarCode::codabar;
-    use PDF::API2::Resource::XObject::Form::BarCode::code128;
-    use PDF::API2::Resource::XObject::Form::BarCode::code3of9;
-    use PDF::API2::Resource::XObject::Form::BarCode::ean13;
-
-    use PDF::API2::Resource::ColorSpace::Indexed::ACTFile;
-    use PDF::API2::Resource::ColorSpace::Indexed::Hue;
-    use PDF::API2::Resource::ColorSpace::Indexed::WebColor;
-
-    use PDF::API2::Resource::ColorSpace::Separation;
-    use PDF::API2::Resource::ColorSpace::DeviceN;
-    
     use Compress::Zlib;
 
     use Math::Trig;
@@ -1644,6 +1606,7 @@
 
 sub corefont {
     my &#40;$self,$name,@opts&#41;=@_;
+    require PDF::API2::Resource::Font::CoreFont;
     my $obj=PDF::API2::Resource::Font::CoreFont-&gt;new_api&#40;$self,$name,@opts&#41;;
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj&#41;;
     $self-&gt;{pdf}-&gt;out_obj&#40;$self-&gt;{pages}&#41;;
@@ -1689,6 +1652,7 @@
         $opts{$o}=_findFont&#40;$opts{$o}&#41;;
     }
     $psf=_findFont&#40;$psf&#41;;
+    require PDF::API2::Resource::Font::Postscript;
     my $obj=PDF::API2::Resource::Font::Postscript-&gt;new_api&#40;$self,$psf,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1730,6 +1694,7 @@
     my &#40;$self,$file,%opts&#41;=@_;
 
     $file=_findFont&#40;$file&#41;;
+    require PDF::API2::Resource::CIDFont::TrueType;
     my $obj=PDF::API2::Resource::CIDFont::TrueType-&gt;new_api&#40;$self,$file,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1743,6 +1708,7 @@
     my &#40;$self,$file,%opts&#41;=@_;
 
     $file=_findFont&#40;$file&#41;;
+    require PDF::API2::Resource::Font::neTrueType;
     my $obj=PDF::API2::Resource::Font::neTrueType-&gt;new_api&#40;$self,$file,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1776,6 +1742,7 @@
 sub cjkfont {
     my &#40;$self,$name,%opts&#41;=@_;
 
+    require PDF::API2::Resource::CIDFont::CJKFont;
     my $obj=PDF::API2::Resource::CIDFont::CJKFont-&gt;new_api&#40;$self,$name,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1821,6 +1788,7 @@
 sub synfont {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::Font::SynFont;
     my $obj=PDF::API2::Resource::Font::SynFont-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1845,6 +1813,7 @@
 sub bdfont {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::Font::BdFont;
     my $obj=PDF::API2::Resource::Font::BdFont-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;Font&#39;,$obj-&gt;name,$obj,$self-&gt;{reopened}&#41;;
@@ -1875,6 +1844,7 @@
 sub unifont {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::UniFont;
     my $obj=PDF::API2::Resource::UniFont-&gt;new_api&#40;$self,@opts&#41;;
 
     return&#40;$obj&#41;;
@@ -1895,6 +1865,7 @@
 sub image_jpeg {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::JPEG;
     my $obj=PDF::API2::Resource::XObject::Image::JPEG-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -1912,6 +1883,7 @@
 sub image_tiff {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::TIFF;
     my $obj=PDF::API2::Resource::XObject::Image::TIFF-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -1929,6 +1901,7 @@
 sub image_pnm {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::PNM;
     my $obj=PDF::API2::Resource::XObject::Image::PNM-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -1946,6 +1919,7 @@
 sub image_png {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::PNG;
     my $obj=PDF::API2::Resource::XObject::Image::PNG-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -1963,6 +1937,7 @@
 sub image_gif {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::GIF;
     my $obj=PDF::API2::Resource::XObject::Image::GIF-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -1982,6 +1957,7 @@
 sub image_gd {
     my &#40;$self,$gd,%opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Image::GD;
     my $obj=PDF::API2::Resource::XObject::Image::GD-&gt;new_api&#40;$self,$gd,undef,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2136,6 +2112,7 @@
 sub colorspace_act {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::ColorSpace::Indexed::ACTFile;
     my $obj=PDF::API2::Resource::ColorSpace::Indexed::ACTFile-&gt;new_api&#40;$self,$file&#41;;
 
     $self-&gt;resource&#40;&#39;ColorSpace&#39;,$obj-&gt;name,$obj&#41;;
@@ -2159,6 +2136,7 @@
 sub colorspace_web {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::ColorSpace::Indexed::WebColor;
     my $obj=PDF::API2::Resource::ColorSpace::Indexed::WebColor-&gt;new_api&#40;$self&#41;;
 
     $self-&gt;resource&#40;&#39;ColorSpace&#39;,$obj-&gt;name,$obj&#41;;
@@ -2182,6 +2160,7 @@
 sub colorspace_hue {
     my &#40;$self,$file,%opts&#41;=@_;
 
+    require PDF::API2::Resource::ColorSpace::Indexed::Hue;
     my $obj=PDF::API2::Resource::ColorSpace::Indexed::Hue-&gt;new_api&#40;$self&#41;;
 
     $self-&gt;resource&#40;&#39;ColorSpace&#39;,$obj-&gt;name,$obj&#41;;
@@ -2210,6 +2189,7 @@
 
 sub colorspace_separation {
     my &#40;$self,$name,@clr&#41;=@_;
+    require PDF::API2::Resource::ColorSpace::Separation;
     my $obj=PDF::API2::Resource::ColorSpace::Separation-&gt;new_api&#40;$self,$name,@clr&#41;;
 
     $self-&gt;resource&#40;&#39;ColorSpace&#39;,$obj-&gt;name,$obj&#41;;
@@ -2244,6 +2224,7 @@
     my &#40;$self,$clrs,$samples&#41;=@_;
     $samples||=2;
     
+    require PDF::API2::Resource::ColorSpace::DeviceN;
     my $obj=PDF::API2::Resource::ColorSpace::DeviceN-&gt;new_api&#40;$self,$clrs,$samples&#41;;
 
     $self-&gt;resource&#40;&#39;ColorSpace&#39;,$obj-&gt;name,$obj&#41;;
@@ -2275,6 +2256,7 @@
 sub xo_code128 {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::BarCode::code128;
     my $obj=PDF::API2::Resource::XObject::Form::BarCode::code128-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2286,6 +2268,7 @@
 sub xo_codabar {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::BarCode::codabar;
     my $obj=PDF::API2::Resource::XObject::Form::BarCode::codabar-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2297,6 +2280,7 @@
 sub xo_2of5int {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::BarCode::int2of5;
     my $obj=PDF::API2::Resource::XObject::Form::BarCode::int2of5-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2308,6 +2292,7 @@
 sub xo_3of9 {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::BarCode::code3of9;
     my $obj=PDF::API2::Resource::XObject::Form::BarCode::code3of9-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2319,6 +2304,7 @@
 sub xo_ean13 {
     my &#40;$self,@opts&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::BarCode::ean13;
     my $obj=PDF::API2::Resource::XObject::Form::BarCode::ean13-&gt;new_api&#40;$self,@opts&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2346,6 +2332,7 @@
 sub xo_form {
     my &#40;$self&#41;=@_;
 
+    require PDF::API2::Resource::XObject::Form::Hybrid;
     my $obj=PDF::API2::Resource::XObject::Form::Hybrid-&gt;new_api&#40;$self&#41;;
 
     $self-&gt;resource&#40;&#39;XObject&#39;,$obj-&gt;name,$obj&#41;;
@@ -2367,6 +2354,7 @@
 sub egstate {
     my &#40;$self&#41;=@_;
 
+    require PDF::API2::Resource::ExtGState;
     my $obj=PDF::API2::Resource::ExtGState-&gt;new_api&#40;$self,pdfkey&#40;&#41;&#41;;
 
     $self-&gt;resource&#40;&#39;ExtGState&#39;,$obj-&gt;name,$obj&#41;;
@@ -2384,6 +2372,7 @@
 sub pattern {
     my &#40;$self,%opts&#41;=@_;
 
+    require PDF::API2::Resource::Pattern;
     my $obj=PDF::API2::Resource::Pattern-&gt;new_api&#40;$self,undef,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Pattern&#39;,$obj-&gt;name,$obj&#41;;
@@ -2401,6 +2390,7 @@
 sub shading {
     my &#40;$self,%opts&#41;=@_;
 
+    require PDF::API2::Resource::Shading;
     my $obj=PDF::API2::Resource::Shading-&gt;new_api&#40;$self,undef,%opts&#41;;
 
     $self-&gt;resource&#40;&#39;Shading&#39;,$obj-&gt;name,$obj&#41;;
@@ -2418,6 +2408,7 @@
 sub outlines {
     my &#40;$self&#41;=@_;
 
+    require PDF::API2::Outlines;
     $self-&gt;{pdf}-&gt;{Root}-&gt;{Outlines}||=PDF::API2::Outlines-&gt;new&#40;$self&#41;;
 
     my $obj=$self-&gt;{pdf}-&gt;{Root}-&gt;{Outlines};
@@ -2449,6 +2440,7 @@
     
     unless&#40;defined $obj&#41;
     {
+        require PDF::API2::NamedDestination;
         $obj=PDF::API2::NamedDestination-&gt;new_api&#40;$self&#41;;
     }
     $root-&gt;{Names}-&gt;{$cat}-&gt;{-vals}-&gt;{$name}=$obj;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pdf-api2-glyph-names.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN -x fonts -x &#39;CJKFont*&#39; -x CMap PDF-API2-0.73/lib/PDF/API2/Util.pm ../htdocs/cgi-bin/lib/PDF/API2/Util.pm
--- PDF-API2-0.73/lib/PDF/API2/Util.pm	2005-11-16 03:16:00.000000000 +0100
+++ ../htdocs/cgi-bin/lib/PDF/API2/Util.pm	2009-04-02 15:15:16.000000000 +0200
@@ -49,10 +49,8 @@
         $key_var2 
         %u2n 
         %n2u 
-        %u2n_o 
-        %n2u_o 
         $pua
-        $uuu
+        %prio
         %PaperSizes
     &#41;;
     use Math::Trig;
@@ -118,10 +116,6 @@
 
     $pua=0xE000;
 
-    %u2n_o=&#40;&#41;;
-    %n2u_o=&#40;&#41;;
-
-    $uuu={g=&gt;{},u=&gt;{}};
     foreach my $dir &#40;@INC&#41; {
         if&#40;-f &#34;$dir/PDF/API2/Resource/uniglyph.txt&#34;&#41;
         {
@@ -134,28 +128,18 @@
                 $line=~s|\s+\#.+$||go;
                 my &#40;$uni,$name,$prio&#41;=split&#40;/\s+;\s+/,$line&#41;;
                 $uni=hex&#40;$uni&#41;;
-                $uuu-&gt;{u}-&gt;{$uni}||=[];
-                $uuu-&gt;{g}-&gt;{$name}||=[];
-                push @{$uuu-&gt;{u}-&gt;{$uni}},{uni=&gt;$uni,name=&gt;$name,prio=&gt;$prio};    
-                push @{$uuu-&gt;{g}-&gt;{$name}},{uni=&gt;$uni,name=&gt;$name,prio=&gt;$prio};    
+		$u2n{$uni}||=$name;
+		if&#40;!defined&#40;$prio{$name}&#41; || $prio &lt; $prio{$name}&#41;
+		{
+		    $n2u{$name}=$uni;
+		    $prio{$name}=$prio;
+		}
             }
             close&#40;$fh&#41;;
+            %prio=&#40;&#41;;
             last;
         }
     }
-    foreach my $k &#40;sort {$a&lt;=&gt;$b} keys %{$uuu-&gt;{u}}&#41;
-    {
-        $u2n_o{$k}=$uuu-&gt;{u}-&gt;{$k}-&gt;[0]-&gt;{name};
-    }
-    foreach my $k &#40;keys %{$uuu-&gt;{g}}&#41;
-    {
-        my&#40;$r&#41;=sort {$a-&gt;{prio}&lt;=&gt;$b-&gt;{prio}} @{$uuu-&gt;{g}-&gt;{$k}};
-        $n2u_o{$k}=$r-&gt;{uni};
-    }
-    $uuu=undef;
-
-    %u2n=%u2n_o;
-    %n2u=%n2u_o;
 
     %colors=&#40;&#41;;
     foreach my $dir &#40;@INC&#41; {
@@ -706,8 +690,7 @@
 }
 
 sub initNameTable {
-    %u2n=&#40;&#41;; %u2n=%u2n_o;
-    %n2u=&#40;&#41;; %n2u=%n2u_o;
+    die&#40;&#34;not implemented&#34;&#41;;
     $pua=0xE000;
     1;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;27&nbsp;14:17:29&nbsp;2009</span>
    <span class="description">otto.hirr [...] olabinc.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">carried to PDF::API3 as <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=45475">https://rt.cpan.org/Ticket/Display.html?id=45475</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;27&nbsp;14:17:30&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;20:43:50&nbsp;2011</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 02 09:35:26 2009, NWELLNHOF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m using PDF:API2 to generate PDFs on the fly on a web server.
&gt; Recently, I ran into the 32MB memory limit of a shared hosting provider.
&gt; So I had a look at the memory consumption of PDF::API2. After creating a
&gt; PDF::API2 object and loading some fonts, memory usage was about 25MB.
&gt; With the following fixes I managed to reduce that to about 15MB.
&gt; 
&gt; Most of the savings can be obtained if you only &#34;require&#34; some of the
&gt; PDF::API2 packages when needed. See the attached patch
&gt; pdf-api2-require-packages.diff.
&gt; 
&gt; I could also save about three additional MB by rewriting the code for
&gt; glyph name initialization. See the attached patch
&gt; pdf-api2-glyph-names.diff. Note that this patch breaks the function
&gt; initNameTable in PDF/API2 Util.pm. It doesn&#39;t seem to be part of the
&gt; public API, though, and it isn&#39;t used internally.
</div>
I&#39;ve just started maintaining PDF::API2, and released version 2.016,
which has some optimizations that lower the memory requirements by
roughly 8MB according to my not-very-scientific tests.

It includes a rewrite of the way the glyphs are parsed in Util.pm
&#40;different than the one you wrote -- I did the release before looking at
this ticket&#41;, which lowers the startup memory requirements pretty
significantly.

As far as using &#34;require&#34; instead of &#34;use&#34;, I&#39;ll see about making those
changes, but I&#39;m wary of doing so until the test suite covers more of
the code, just in case there are unintended side effects.  Instead, I&#39;ll
probably do them one at a time as tests start covering each section of
the code.

Thanks for the patch!  I&#39;m marking this ticket as rejected, but will
definitely plan to make very similar changes in future releases.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;24&nbsp;20:43:51&nbsp;2011</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
