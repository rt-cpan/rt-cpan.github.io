<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35970 for Perl-Critic: Variables::ProhibitPunctuationVars - ignores variables in interpolated strings</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35970 for Perl-Critic: Variables::ProhibitPunctuationVars - ignores variables in interpolated strings</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Perl-Critic/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Perl-Critic/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Perl-Critic/Perl-Critic/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Perl-Critic">Perl-Critic CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35970</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Perl-Critic/Active/">Perl-Critic</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
amir.aharoni [...] mail.huji.ac.il

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-25198-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.082    </td>
  </tr>
  <tr id="CF-25199-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.082    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;17&nbsp;10:16:07&nbsp;2008</span>
    <span class="description">amir.aharoni [...] mail.huji.ac.il -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Variables::ProhibitPunctuationVars - ignores variables in
 interpolated strings</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Magic punctuation variables are ignored if they are a part of an
interpolated string:

This would be reported:
say &#39;the pid is &#39;, $$;

This would be ignored:
say &#34;the pid is $$&#34;;

A simple testcase is attached.

I am working with Perl 5.10 on Cygwin and Windows Vista.

Thanks.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> test_punct_02.pl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use 5.010;

use strict;
use warnings;

our $VERSION = 0.1;

say &#39;the pid is &#39;, $$;  # reported
say &#34;the pid is $$&#34;;    # ignored

say &#39;the OS is &#39;, $^O;  # reported
say &#34;the OS is $^O&#34;;    # ignored

exit;

__END__
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;17&nbsp;10:37:24&nbsp;2008</span>
    <span class="description">amir.aharoni [...] mail.huji.ac.il -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> amir.aharoni [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Marked by mistake as &#34;fixed in 1.082&#34;.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;17&nbsp;13:27:32&nbsp;2008</span>
    <span class="description">perl [...] galumph.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #35970] Variables::ProhibitPunctuationVars - ignores variables in interpolated strings</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 17 May 2008 12:27:21 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Perl-Critic [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Elliot Shank &lt;perl [...] galumph.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Amir E. Aharoni via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Magic punctuation variables are ignored if they are a part of an
&gt; interpolated string:
</div>
Added as a TODO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;17&nbsp;13:27:33&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;13&nbsp;16:45:09&nbsp;2009</span>
    <span class="description">perl-rt [...] misterwhipple.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> perl-rt [...] misterwhipple.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a patch against perlcritic/distributions/Perl-Critic, svn
revision 3108. It extends PCP::Variables::ProhibitPunctuationVars to
handle interpolated strings, adding the following classes to applies_to&#40;&#41;:
    PPI::Token::Quote::Double
    PPI::Token::Quote::Interpolate
    PPI::Token::QuoteLike::Command
    PPI::Token::QuoteLike::Backtick
    PPI::Token::QuoteLike::Regexp
    PPI::Token::QuoteLike::Readline. 

A number of new tests in t/...ProhibitPunctuationVars.run handle the
straightforward cases and various combinations of _allowed_ variables
and/or backslashing. 

I have not implemented handling for PPI::Token::HereDoc . I believe the
next step in that regard will be to enhance that class to indicate its
quoting mode. If it did so by adding a child object from one of the
classes I listed above, PCPV::ProhibitPunctuationVars would almost
certainly Just Work&#40;tm&#41; without further modification.

clonezone tells me that he may be enhancing PPI with variable extraction
from interpolated contexts, which would likely render this patch
obsolete. Not that I mind; it&#39;s probably a better approach.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/Variables/ProhibitPunctuationVars.run
===================================================================
--- t/Variables/ProhibitPunctuationVars.run	&#40;revision 3108&#41;
+++ t/Variables/ProhibitPunctuationVars.run	&#40;working copy&#41;
@@ -43,16 +43,52 @@
 
 #-----------------------------------------------------------------------------
 
-## name Strings
-## failures 4
-## TODO We don&#39;t look into strings.
+## name Strings Interpolation
+## parms { allow =&gt; &#39;$@ $!&#39; }
+## failures 12
 ## cut
 
+# Commented numbers in parens indicate expected violations in that section
+# The module under test doesn&#39;t use them, they&#39;re just for reader&#39;s convenience
+
+# PPI::Token::Quote::Double &#40;5&#41;
 print &#34;$+&#34;;
-print qq&lt;$+&gt;;
-print qx&lt;$+&gt;;
-print qr&lt;$+&gt;;
+print &#34;This is my $+; is it not nifty?&#34;;
+print &#34;This is my $+; is it not $@?&#34;;
+print &#34;this \n should $+\n violate&#34;;
+print &#34;as \n$+ should this&#34;;
 
+	# should pass &#40;0&#41;
+print &#34;\$+&#34;;
+print &#34;$@&#34;;
+print &#34;$!&#34;;
+print &#34;no magic here&#34;;
+print &#34;This is my $@; is it not nifty?&#34;
+print &#34;but not \n\$+ this&#34;;
+
+# PPI::Token::Quote::Interpolate &#40;3&#41;
+print qq&lt;$+&gt;;     #should violate
+print qq&lt;\$+&gt;;    #should pass
+print qq&lt;\\$+&gt;;   #should violate
+print qq&lt;\\\$+&gt;;  #should pass
+print qq&lt;\\\\$+&gt;; #should violate
+
+# PPI::Token::QuoteLike::Command &#40;1&#41;
+print qx&lt;$+&gt;;     #should violate
+print qx&lt;\$+&gt;;	  #should pass
+
+# PPI::Token::QuoteLike::Backtick &#40;1&#41;
+print `$+`;       #should violate
+print `\$+`;	  #should pass
+
+# PPI::Token::QuoteLike::Regexp &#40;1&#41;
+print qr&lt;$+&gt;;     #should violate
+print qr&lt;\$+&gt;;    #should pass
+
+# PPI::Token::QuoteLike::Readline &#40;1&#41;
+while &#40;&lt;$+&gt;&#41; { 1; }    #should violate
+while &#40;&lt;\$+&gt;&#41; { 1; }   #should pass
+
 #-----------------------------------------------------------------------------
 
 ##############################################################################
Index: lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm
===================================================================
--- lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm	&#40;revision 3108&#41;
+++ lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm	&#40;working copy&#41;
@@ -39,16 +39,84 @@
 
 sub default_severity { return $SEVERITY_LOW         }
 sub default_themes   { return qw&#40;core pbp cosmetic&#41; }
-sub applies_to       { return &#39;PPI::Token::Magic&#39;   }
 
+sub applies_to {
+    return qw&#40; PPI::Token::Magic
+        PPI::Token::Quote::Double
+        PPI::Token::Quote::Interpolate
+        PPI::Token::QuoteLike::Command
+        PPI::Token::QuoteLike::Backtick
+        PPI::Token::QuoteLike::Regexp
+        PPI::Token::QuoteLike::Readline
+    &#41;;
+}
+
 #-----------------------------------------------------------------------------
+my $_magic_regexp;
 
+INIT {
+    my %_magic_vars;
+
+    # Magic variables taken from perlvar.
+    # Several things added separately to avoid warnings.
+    # adapted from ADAMK&#39;s PPI::Token::Magic.pm
+    foreach &#40;
+        qw{
+        $1 $2 $3 $4 $5 $6 $7 $8 $9
+        $_ $&#38; $` $&#39; $+ @+ %+ $* $. $/ $|
+        $\\ $&#34; $; $% $= $- @- %- $&#41;
+        $~ $^ $: $? $! %! $@ $$ $&lt; $&gt;
+        $&#40; $0 $[ $] @_ @*
+
+        $^L $^A $^E $^C $^D $^F $^H
+        $^I $^M $^N $^O $^P $^R $^S
+        $^T $^V $^W $^X %^H
+
+        $::|
+        }, &#39;$}&#39;, &#39;$,&#39;, &#39;$#&#39;, &#39;$#+&#39;, &#39;$#-&#39;
+        &#41;
+    {
+        $_magic_vars{$_} = $_;
+        $_magic_vars{$_} =~ 
+            s{ &#40; [[:punct:]] &#41; }{\\$1}gox; # add \ before all punctuation
+    }
+
+    $_magic_regexp = join q&#40;|&#41;, values %_magic_vars;
+}
+
+
 sub violates {
     my &#40; $self, $elem, undef &#41; = @_;
-    if &#40; !exists $self-&gt;{_allow}-&gt;{$elem} &#41; {
-        return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
+
+    if &#40; $elem-&gt;isa&#40;&#39;PPI::Token::Magic&#39;&#41; &#41; {
+        if &#40; !exists $self-&gt;{_allow}-&gt;{$elem} &#41; {
+            return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
+        }
     }
-    return;  #ok!
+    else {
+        #the remaining applies_to&#40;&#41; classes are all interpolated strings
+
+        my @raw_matches = &#40;
+            $elem =~ 
+            m/
+                &#40;?: \A | [^\\] &#41;   # beginning-of-string or any non-backslash 
+                &#40;?: \\\\ &#41;*        # zero or more double-backslashes
+                &#40; $_magic_regexp &#41; # any magic punctuation variable
+            /goxs
+        &#41;;
+
+        my %matches;
+        @matches{@raw_matches} = 1;
+
+        my %allow = %{ $self-&gt;{_allow} };
+        delete @matches{ keys %allow };
+
+        if &#40;%matches&#41; {
+            return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
+        }
+    }
+
+    return;    #ok!
 }
 
 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;15&nbsp;10:30:46&nbsp;2009</span>
    <span class="description">perl-rt [...] misterwhipple.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> perl-rt [...] misterwhipple.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a revised patch against SVN rev 3113. It adds support for
here-documents, and has a better overall design than my previous patch.
It also conforms better to Perl::Critic standards, specifically in
placing startup code in initialize_if_enabled&#40;&#41;.

I expanded the tests for interpolated strings to cover every one of the
punctuation variables listed in PPI/Token/Magic.pm. A few of them cause
problems, apparently because of parsing difficulties in PPI. I commented
out those tests, but I believe those issues cannot be repaired within
Perl::Critic. 

The problem vars include, perhaps not surprisingly, $&#34; and $\. I will
open a ticket in PPI for this if there isn&#39;t one already.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/Variables/ProhibitPunctuationVars.run
===================================================================
--- t/Variables/ProhibitPunctuationVars.run	&#40;revision 3113&#41;
+++ t/Variables/ProhibitPunctuationVars.run	&#40;working copy&#41;
@@ -43,18 +43,188 @@
 
 #-----------------------------------------------------------------------------
 
-## name Strings
-## failures 4
-## TODO We don&#39;t look into strings.
+## name Quoted String Interpolation - basic functional tests
+## parms { allow =&gt; &#39;$@ $!&#39; }
+## failures 12
 ## cut
 
+# Commented numbers in parens indicate expected violations in that section
+# The module under test doesn&#39;t use them, they&#39;re just for reader&#39;s convenience
+
+# PPI::Token::Quote::Double &#40;5&#41;
 print &#34;$+&#34;;
-print qq&lt;$+&gt;;
-print qx&lt;$+&gt;;
-print qr&lt;$+&gt;;
+print &#34;This is my $+. is it not nifty?&#34;;
+print &#34;This is my $+. is it not $@?&#34;;
+print &#34;this \n should $+\n violate&#34;;
+print &#34;as \n$+ should this&#34;;
 
+	# should pass &#40;0&#41;
+print &#34;\$+&#34;;
+print &#34;$@&#34;;
+print &#34;$!&#34;;
+print &#34;no magic here&#34;;
+print &#34;This is my $@; is it not nifty?&#34;
+print &#34;but not \n\$+ this&#34;;
+
+# PPI::Token::Quote::Interpolate &#40;3&#41;
+print qq&lt;$+&gt;;     #should violate
+print qq&lt;\$+&gt;;    #should pass
+print qq&lt;\\$+&gt;;   #should violate
+print qq&lt;\\\$+&gt;;  #should pass
+print qq&lt;\\\\$+&gt;; #should violate
+
+# PPI::Token::QuoteLike::Command &#40;1&#41;
+print qx&lt;$+&gt;;     #should violate
+print qx&lt;\$+&gt;;	  #should pass
+
+# PPI::Token::QuoteLike::Backtick &#40;1&#41;
+print `$+`;       #should violate
+print `\$+`;	  #should pass
+
+# PPI::Token::QuoteLike::Regexp &#40;1&#41;
+print qr&lt;$+&gt;;     #should violate
+print qr&lt;\$+&gt;;    #should pass
+
+# PPI::Token::QuoteLike::Readline &#40;1&#41;
+while &#40;&lt;$+&gt;&#41; { 1; }    #should violate
+while &#40;&lt;\$+&gt;&#41; { 1; }   #should pass
+
 #-----------------------------------------------------------------------------
 
+## name Heredoc Interpolation
+## parms { allow =&gt; &#39;$@ $!&#39; }
+## failures 8
+## cut
+
+print &lt;&lt;DEFAULT # default, implied &#34;&#34; context; should violate
+$+
+DEFAULT
+
+print &lt;&lt;DEFAULT # default, implied &#34;&#34; context; should violate
+$+
+fred
+wilma
+DEFAULT
+
+print &lt;&lt;DEFAULT # default, implied &#34;&#34; context; should violate
+barney
+$+
+betty
+DEFAULT
+
+print &lt;&lt;DEFAULT # default, implied &#34;&#34; context; should violate
+$+
+pebbles
+bambam
+DEFAULT
+
+print &lt;&lt;&#34;DOUBLE_QUOTE&#34; # explicit &#34;&#34; context; should violate
+$$
+DOUBLE_QUOTE
+
+print &lt;&lt;&#34;DQ_VERYVERYVERY_LONG_HEREDOC_EOT_IDENTIFIER&#34; # explicit &#34;&#34; context; should violate
+$+
+DQ_VERYVERYVERY_LONG_HEREDOC_EOT_IDENTIFIER
+
+
+print &lt;&lt;&#34;MULTI_MATCHES&#34; # explicit &#34;&#34; context; should violate
+$$
+$+
+$\
+$^A
+MULTI_MATCHES
+
+print &lt;&lt;DEFAULT_ALLOWED # default, implied &#34;&#34; but allowed var; should pass
+$@
+DEFAULT_ALLOWED
+
+print &lt;&lt;&#39;SINGLE_QUOTE&#39; # &#39;&#39; context; should pass
+$@
+SINGLE_QUOTE
+
+print &lt;&lt;`BACKTICK` # backtick context; should violate
+$+
+BACKTICK
+
+#-----------------------------------------------------------------------------
+
+## name Quoted String Interpolation wart cases
+## TODO debug wart cases from String Interpolation exhaustive
+## failures 0
+## cut
+
+#print &#34;$&#34;&#34;;      # 2 of 59
+#print &#34;$\&#34;;      # 28 of 59 
+
+#-----------------------------------------------------------------------------
+
+## name Quoted String Interpolation - exhaustive tests
+## failures 57
+## cut
+
+print &#34;$!&#34;;      # 1 of 59 
+#print &#34;$&#34;&#34;;      # 2 of 59  BROKEN, copied to TODO
+print &#34;$#&#34;;      # 3 of 59 
+print &#34;$#+&#34;;     # 4 of 59 
+print &#34;$#-&#34;;     # 5 of 59 
+print &#34;$$&#34;;      # 6 of 59 
+print &#34;$%&#34;;      # 7 of 59 
+print &#34;$&#38;&#34;;      # 8 of 59 
+print &#34;$&#39;&#34;;      # 9 of 59 
+print &#34;$&#40;&#34;;      # 10 of 59 
+print &#34;$&#41;&#34;;      # 11 of 59 
+print &#34;$*&#34;;      # 12 of 59 
+print &#34;$+&#34;;      # 13 of 59 
+print &#34;$,&#34;;      # 14 of 59 
+print &#34;$-&#34;;      # 15 of 59 
+print &#34;$.&#34;;      # 16 of 59 
+print &#34;$/&#34;;      # 17 of 59 
+print &#34;$0&#34;;      # 18 of 59 
+print &#34;$:&#34;;      # 19 of 59 
+print &#34;$::|&#34;;    # 20 of 59 
+print &#34;$;&#34;;      # 21 of 59 
+print &#34;$&lt;&#34;;      # 22 of 59 
+print &#34;$=&#34;;      # 23 of 59 
+print &#34;$&gt;&#34;;      # 24 of 59 
+print &#34;$?&#34;;      # 25 of 59 
+print &#34;$@&#34;;      # 26 of 59 
+print &#34;$[&#34;;      # 27 of 59 
+#print &#34;$\&#34;;      # 28 of 59  BROKEN, copied to TODO
+print &#34;$]&#34;;      # 29 of 59 
+print &#34;$^&#34;;      # 30 of 59 
+print &#34;$^A&#34;;     # 31 of 59 
+print &#34;$^C&#34;;     # 32 of 59 
+print &#34;$^D&#34;;     # 33 of 59 
+print &#34;$^E&#34;;     # 34 of 59 
+print &#34;$^F&#34;;     # 35 of 59 
+print &#34;$^H&#34;;     # 36 of 59 
+print &#34;$^I&#34;;     # 37 of 59 
+print &#34;$^L&#34;;     # 38 of 59 
+print &#34;$^M&#34;;     # 39 of 59 
+print &#34;$^N&#34;;     # 40 of 59 
+print &#34;$^O&#34;;     # 41 of 59 
+print &#34;$^P&#34;;     # 42 of 59 
+print &#34;$^R&#34;;     # 43 of 59 
+print &#34;$^S&#34;;     # 44 of 59 
+print &#34;$^T&#34;;     # 45 of 59 
+print &#34;$^V&#34;;     # 46 of 59 
+print &#34;$^W&#34;;     # 47 of 59 
+print &#34;$^X&#34;;     # 48 of 59 
+print &#34;$`&#34;;      # 49 of 59 
+print &#34;$|&#34;;      # 50 of 59 
+print &#34;$}&#34;;      # 51 of 59 
+print &#34;$~&#34;;      # 52 of 59 
+print &#34;%!&#34;;      # 53 of 59 
+print &#34;%+&#34;;      # 54 of 59 
+print &#34;%-&#34;;      # 55 of 59 
+print &#34;%^H&#34;;     # 56 of 59 
+print &#34;@*&#34;;      # 57 of 59 
+print &#34;@+&#34;;      # 58 of 59 
+print &#34;@-&#34;;      # 59 of 59 
+
+
+#-----------------------------------------------------------------------------
+
 ##############################################################################
 #      $URL$
 #     $Date$
Index: lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm
===================================================================
--- lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm	&#40;revision 3113&#41;
+++ lib/Perl/Critic/Policy/Variables/ProhibitPunctuationVars.pm	&#40;working copy&#41;
@@ -12,7 +12,7 @@
 use warnings;
 use Readonly;
 
-use Perl::Critic::Utils qw{ :characters :severities :data_conversion };
+use Perl::Critic::Utils qw{ :characters :severities :data_conversion :booleans };
 use base &#39;Perl::Critic::Policy&#39;;
 
 our $VERSION = &#39;1.096&#39;;
@@ -39,18 +39,153 @@
 
 sub default_severity { return $SEVERITY_LOW         }
 sub default_themes   { return qw&#40;core pbp cosmetic&#41; }
-sub applies_to       { return &#39;PPI::Token::Magic&#39;   }
 
+sub applies_to {
+    return qw&#40; PPI::Token::Magic
+        PPI::Token::Quote::Double
+        PPI::Token::Quote::Interpolate
+        PPI::Token::QuoteLike::Command
+        PPI::Token::QuoteLike::Backtick
+        PPI::Token::QuoteLike::Regexp
+        PPI::Token::QuoteLike::Readline
+        PPI::Token::HereDoc
+    &#41;;        
+}
+
 #-----------------------------------------------------------------------------
 
+# package state
+my $_magic_regexp;
+
+# private functions
+my $_violates_magic;
+my $_violates_string;
+my $_violates_heredoc;
+my $_strings_helper;
+
+#-----------------------------------------------------------------------------
+
+sub initialize_if_enabled{
+    # my $config = shift; # policy $config not needed at present
+    
+    my %_magic_vars;
+
+    # Magic variables taken from perlvar.
+    # Several things added separately to avoid warnings.
+    # adapted from ADAMK&#39;s PPI::Token::Magic.pm
+    foreach &#40;
+        qw{
+            $1 $2 $3 $4 $5 $6 $7 $8 $9
+            $_ $&#38; $` $&#39; $+ @+ %+ $* $. $/ $|
+            $\\ $&#34; $; $% $= $- @- %- $&#41;
+            $~ $^ $: $? $! %! $@ $$ $&lt; $&gt;
+            $&#40; $0 $[ $] @_ @*
+    
+            $^L $^A $^E $^C $^D $^F $^H
+            $^I $^M $^N $^O $^P $^R $^S
+            $^T $^V $^W $^X %^H
+    
+            $::|
+        }, &#39;$}&#39;, &#39;$,&#39;, &#39;$#&#39;, &#39;$#+&#39;, &#39;$#-&#39;
+    &#41; {
+        $_magic_vars{$_} = $_;
+        $_magic_vars{$_} =~ 
+            s{ &#40; [[:punct:]] &#41; }{\\$1}gox; # add \ before all punctuation
+    }
+
+    delete @_magic_vars{ @{supported_parameters&#40;&#41;-&gt;{list_always_present_values}} };
+
+    $_magic_regexp = join q&#40;|&#41;, values %_magic_vars;
+    
+    return $TRUE;
+}
+
 sub violates {
     my &#40; $self, $elem, undef &#41; = @_;
+
+    if &#40; $elem-&gt;isa&#40;&#39;PPI::Token::Magic&#39;&#41; &#41; {
+        return $_violates_magic-&gt;&#40;@_&#41;;
+    }
+    elsif &#40; $elem-&gt;isa&#40;&#39;PPI::Token::HereDoc&#39;&#41; &#41;{
+        return $_violates_heredoc-&gt;&#40;@_&#41;;
+    }
+    else { 
+        #the remaining applies_to&#40;&#41; classes are all interpolated strings
+        return $_violates_string-&gt;&#40;@_&#41;;
+    }
+
+    die &#39;Impossible! fall-through error in method violates&#40;&#41;&#39;;
+}
+
+#-----------------------------------------------------------------------------
+
+$_violates_magic = sub { 
+    my &#40; $self, $elem, undef &#41; = @_;
+    
     if &#40; !exists $self-&gt;{_allow}-&gt;{$elem} &#41; {
+
         return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
     }
-    return;  #ok!
-}
+        
+    return;        
+};
 
+$_violates_string = sub {
+    my &#40; $self, $elem, undef &#41; = @_;
+
+    my %matches = $_strings_helper-&gt;&#40;$elem-&gt;content&#40;&#41;, $self-&gt;{_allow} &#41;;
+    
+    if &#40;%matches&#41; {
+        my $DESC = qq{$DESC in interpolated string};
+        
+        return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
+    }
+    
+    return;
+    
+};
+
+$_violates_heredoc = sub{
+    my &#40;$self, $elem, undef&#41; = @_;
+
+    if &#40;$elem-&gt;{_mode} eq &#39;interpolate&#39; or $elem-&gt;{_mode} eq &#39;command&#39;&#41;{
+        
+        my $heredoc_string = join qq{\n}, $elem-&gt;heredoc&#40;&#41; ; 
+        my %matches = $_strings_helper-&gt;&#40;$heredoc_string, $self-&gt;{_allow}&#41;;
+    
+        if &#40;%matches&#41; {
+            my $DESC = qq{$DESC in interpolated here-document};  
+    
+            return $self-&gt;violation&#40; $DESC, $EXPL, $elem &#41;;
+        }
+    }
+    
+    return;
+};
+
+$_strings_helper = sub{
+    my &#40;$target_string, $allow_ref, undef&#41; = @_;
+
+    my @raw_matches = &#40;
+        $target_string =~ 
+        m/
+            &#40;?: \A | [^\\] &#41;   # beginning-of-string or any non-backslash 
+            &#40;?: \\\\ &#41;*        # zero or more double-backslashes
+            &#40; $_magic_regexp &#41; # any magic punctuation variable
+        /goxs
+    &#41;;
+
+    my %matches;
+    @matches{@raw_matches} = 1;
+    delete @matches{ keys %{$allow_ref} };
+
+    return %matches
+        if &#40;%matches&#41;;
+        
+    return; #no matches
+};
+
+
 1;
 
 __END__
@@ -102,17 +237,21 @@
 
 =head1 BUGS
 
-This doesn&#39;t find punctuation variables in strings.  RT #35970.
+Punctuation variables that confuse PPI&#39;s document parsing may not be
+detected correctly or at all, and may prevent detection of subsequent
+ones.
 
 
 =head1 AUTHOR
 
 Jeffrey Ryan Thalhammer &lt;thaljef@cpan.org&gt;
+Edgar Whipple &lt;perlmonk at misterwhipple dot com&gt;
 
 
 =head1 COPYRIGHT
 
 Copyright &#40;c&#41; 2005-2009 Jeffrey Ryan Thalhammer.  All rights reserved.
+Additions for interpolated strings &#40;c&#41; 2009 Edgar Whipple. All rights reserved.
 
 This program is free software; you can redistribute it and/or modify
 it under the same terms as Perl itself.  The full text of this license
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;09&nbsp;17:53:51&nbsp;2010</span>
    <span class="description">wyant [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This appears to me to be resolved. At any rate, the tests are in place
and pass.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;09&nbsp;17:53:52&nbsp;2010</span>
    <span class="description">wyant [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
