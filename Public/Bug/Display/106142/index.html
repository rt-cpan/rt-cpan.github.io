<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #106142 for Module-ScanDeps: [Patch] Preload dependencies for PDL and PDL::NiceSlice</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #106142 for Module-ScanDeps: [Patch] Preload dependencies for PDL and PDL::NiceSlice</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-ScanDeps/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-ScanDeps/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-ScanDeps/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-ScanDeps/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-ScanDeps">Module-ScanDeps CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">106142</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-ScanDeps/Active/">Module-ScanDeps</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SLAFFAN [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21736-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21737-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;07:50:35&nbsp;2015</span>
    <span class="description">SLAFFAN [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [Patch] Preload dependencies for PDL and PDL::NiceSlice</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a patch to add preloads for PDL and PDL::NiceSlice.  

Without the preloads the code below fails after being packed using pp &#40;unless the -x option is specified&#41;.

Regards,
Shawn.


use PDL;
use PDL::NiceSlice;
my $x = pdl [[2,3,4],[1,2,3]]; 
print $x&#40;1,&#41;;
print $x;
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ScanDeps.pm.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/Module/ScanDeps.pm
===================================================================
--- lib/Module/ScanDeps.pm	&#40;revision 1595&#41;
+++ lib/Module/ScanDeps.pm	&#40;working copy&#41;
@@ -430,6 +430,12 @@
         _glob_in_inc&#40;&#39;PDF/API2/Basic/TTF&#39;, 1&#41;;
     },
     &#39;PDF/Writer.pm&#39;                 =&gt; &#39;sub&#39;,
+    &#39;PDL.pm&#39; =&gt; sub { @{ _get_preload&#40;&#39;utf8.pm&#39;&#41; } },
+    &#39;PDL/NiceSlice.pm&#39;              =&gt; [
+        &#39;PDL/NiceSlice/FilterUtilCall.pm&#39;,
+        &#39;PDL/NiceSlice/FilterSimple.pm&#39;,
+        &#39;PDL/NiceSlice/ModuleCompile.pm&#39;,
+    ],
     &#39;Perl/Critic.pm&#39;                =&gt; &#39;sub&#39;, #not only Perl/Critic/Policy
     &#39;PerlIO.pm&#39;                     =&gt; [ &#39;PerlIO/scalar.pm&#39; ],
     &#39;Pod/Usage.pm&#39;                  =&gt; sub {  # from Pod::Usage &#40;as of 1.61&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;11:23:33&nbsp;2015</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2015-07-29 07:50:35, SLAFFAN wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; use PDL;
&gt; use PDL::NiceSlice;
&gt;  my $x = pdl [[2,3,4],[1,2,3]];
&gt; print $x&#40;1,&#41;;
&gt; print $x;
</div>

I agree on the %Preload rule for PDL/NiceSlice.pm, it can be made more robust as

  &#39;PDL/NiceSlice.pm&#39; =&gt; &#39;sub&#39;,

but the rule for PDL.pm needs further investigation. Somehow utf8_heavy.pl is
needed... Maybe this was caused by rev 1501 in <span class="clickylink"><a target="new" rel="nofollow" href="https://www.openfoundry.org/svn/par">https://www.openfoundry.org/svn/par</a></span>
when I removed the scan rule that says 

   Foo::Bar::quux&#40;...&#41;   

or

   Foo::Bar-&gt;quux&#40;...&#41;

implies we should add a dependency on Foo::Bar. 

Cheers, Roderich
 
   
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;11:23:34&nbsp;2015</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;17:50:53&nbsp;2015</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks.  The PDL::NiceSlice approach is much simpler.

If I can get a chance I&#39;ll look into the PDL code to see what sort of calls are used.  

Regards,
Shawn.


On Wed Jul 29 11:23:33 2015, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2015-07-29 07:50:35, SLAFFAN wrote:
&gt; 
<div class="message-stanza open">&gt; &gt; use PDL;
&gt; &gt; use PDL::NiceSlice;
&gt; &gt;  my $x = pdl [[2,3,4],[1,2,3]];
&gt; &gt; print $x&#40;1,&#41;;
&gt; &gt; print $x;
</div>&gt; 
&gt; 
&gt; I agree on the %Preload rule for PDL/NiceSlice.pm, it can be made more
&gt; robust as
&gt; 
&gt; &#39;PDL/NiceSlice.pm&#39; =&gt; &#39;sub&#39;,
&gt; 
&gt; but the rule for PDL.pm needs further investigation. Somehow
&gt; utf8_heavy.pl is
&gt; needed... Maybe this was caused by rev 1501 in
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.openfoundry.org/svn/par">https://www.openfoundry.org/svn/par</a></span>
&gt;  when I removed the scan rule that says
&gt; 
&gt; Foo::Bar::quux&#40;...&#41;
&gt; 
&gt; or
&gt; 
&gt; Foo::Bar-&gt;quux&#40;...&#41;
&gt; 
&gt; implies we should add a dependency on Foo::Bar.
&gt; 
&gt; Cheers, Roderich
&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;02&nbsp;00:48:42&nbsp;2015</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jul 29 17:50:53 2015, SLAFFAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks.  The PDL::NiceSlice approach is much simpler.
&gt; 
&gt; If I can get a chance I&#39;ll look into the PDL code to see what sort of
&gt; calls are used.
&gt; 
&gt; Regards,
&gt; Shawn.
&gt; 
&gt; 
&gt; On Wed Jul 29 11:23:33 2015, RSCHUPP wrote:
<div class="message-stanza open">&gt; &gt; On 2015-07-29 07:50:35, SLAFFAN wrote:
&gt; &gt;
<div class="message-stanza open">&gt; &gt; &gt; use PDL;
&gt; &gt; &gt; use PDL::NiceSlice;
&gt; &gt; &gt;  my $x = pdl [[2,3,4],[1,2,3]];
&gt; &gt; &gt; print $x&#40;1,&#41;;
&gt; &gt; &gt; print $x;
</div>&gt; &gt;
&gt; &gt;
&gt; &gt; I agree on the %Preload rule for PDL/NiceSlice.pm, it can be made
&gt; &gt; more
&gt; &gt; robust as
&gt; &gt;
&gt; &gt; &#39;PDL/NiceSlice.pm&#39; =&gt; &#39;sub&#39;,
&gt; &gt;
&gt; &gt; but the rule for PDL.pm needs further investigation. Somehow
&gt; &gt; utf8_heavy.pl is
&gt; &gt; needed... Maybe this was caused by rev 1501 in
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://www.openfoundry.org/svn/par">https://www.openfoundry.org/svn/par</a></span>
&gt; &gt;  when I removed the scan rule that says
&gt; &gt;
&gt; &gt; Foo::Bar::quux&#40;...&#41;
&gt; &gt;
&gt; &gt; or
&gt; &gt;
&gt; &gt; Foo::Bar-&gt;quux&#40;...&#41;
&gt; &gt;
&gt; &gt; implies we should add a dependency on Foo::Bar.
&gt; &gt;
&gt; &gt; Cheers, Roderich
&gt; &gt;
&gt; &gt;
</div></div>

It looks like the change in rev 1501 is not the cause.  I modified the regexp to use a negative lookbehind to avoid false positives on $foo-&gt;bar-&gt;baz, and added it into scan_chunk, but utf8_heavy.pl was not packed.  I did not check for Foo::Bar::baz&#40;&#41;, though.

return $1 if &#40;/&#40;?&lt;!\W&#41; \b &#40;\w+&#40;?:::\w+&#41;*&#41; \s* &#40;?:-&gt;&#41;/x and $1 ne &#39;Tk&#39; and $1 ne &#39;shift&#39; and $1 ne &#39;__PACKAGE__&#39;&#41;;

A bit of further searching through the PDL code indicated File::Map was a pinch-point, so I added some more Preload rules as a check &#40;see below&#41;.  These seem to work, but need further investigation since they are not generalised.

File::Map is loaded in PDL::Core, PDL::IO::FlexRaw and PDL::IO::FastRaw using a string eval.   From PDL::Core:

eval &#39;use File::Map 0.47 qw&#40;:all&#41;&#39;;


As a quick experiment, I added the following preload rules to Module::ScanDeps.  The explicit listing of unicore/Heavy.pl is needed because it is not found through the utf8.pm preload sub.  I am sure there is a better way, but maybe this helps locate the source of the problem?


    &#39;File/Map.pm&#39; =&gt; [&#39;utf8.pm&#39;, &#39;unicore/Heavy.pl&#39;],
    &#39;PDL&#39;         =&gt; [&#39;PDL/Core.pm&#39;],
    &#39;PDL/Core.pm&#39; =&gt; [&#39;File/Map.pm&#39;],


When I then run pp on the script below, explicitly loading File:Map, the packed executable works.

use PDL;
use File::Map;
my $x = pdl [[2,3,4],[1, 2, 3]]; 
print $x;


However, if I comment out the &#39;use File::Map&#39; line it does not pack utf8_heavy.pl, so the preload rules above are clearly wrong.

Instrumenting _glob_in_inc to print to stdout whenever unico[rd]e is passed as the subdir argument has no effect, so I assume the utf8.pm preload sub is not being run for the above preload rules.


Hopefully the above is helpful.  

Regards,
Shawn.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;02&nbsp;18:02:33&nbsp;2015</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2015-08-02 00:48:42, SLAFFAN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Instrumenting _glob_in_inc to print to stdout whenever unico[rd]e is
&gt; passed as the subdir argument has no effect, so I assume the utf8.pm
&gt; preload sub is not being run for the above preload rules.
</div>
Thanks for investigating. I tried to figure out at what point utf8_heavy.pl
comes into play. For that I prepended this to your sample script

BEGIN
{
    # insert spy CODE into require&#39;s module lookup
    unshift @INC, sub 
    {
        my &#40;$self, $pm&#41; = @_;
        print STDERR &#34;# require $pm\n&#34;;
        &#40;$package, $filename, $line&#41; = caller;
        print STDERR &#34;#   from $package &#40;$filename:$line&#41;\n&#34;;
        return;         # i.e. take a pass
    };
}

This intercepts any &#40;explicit or implicit&#41; &#34;require&#34;, prints out what is required
and from where and then resumes &#34;normal&#34; processing. Here&#39;s the output

# require PDL.pm
#   from main &#40;/home/roderich/todo/PAR/Module-ScanDeps/shawn.pl:15&#41;
# require PDL/Core.pm
#   from main &#40;&#40;eval 1&#41;:6&#41;
# require PDL/Types.pm
#   from PDL::Core &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/PDL/Core.pm:223&#41;
# require Carp.pm
#   from PDL::Types &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/PDL/Types.pm:6&#41;
# require strict.pm
#   from Carp &#40;/usr/share/perl/5.22/Carp.pm:4&#41;
# require warnings.pm
#   from Carp &#40;/usr/share/perl/5.22/Carp.pm:5&#41;
# require Exporter.pm
#   from Carp &#40;/usr/share/perl/5.22/Carp.pm:99&#41;
# require overload.pm
#   from PDL::Type &#40;/usr/lib/x86_64-linux-gnu/perl5/5.22/PDL/Types.pm:428&#41;
# require overloading.pm
#   from overload &#40;/usr/share/perl/5.22/overload.pm:83&#41;
# require warnings/register.pm
#   from overload &#40;/usr/share/perl/5.22/overload.pm:144&#41;
# require Exporter/Heavy.pm
#   from Exporter &#40;/usr/share/perl/5.22/Exporter.pm:16&#41;
# require PDL/Exporter.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:314&#41;
# require DynaLoader.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:315&#41;
# require Config.pm
#   from DynaLoader &#40;/usr/lib/x86_64-linux-gnu/perl/5.22/DynaLoader.pm:21&#41;
# require vars.pm
#   from Config &#40;/usr/lib/x86_64-linux-gnu/perl/5.22/Config.pm:11&#41;
# require Scalar/Util.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:1000&#41;
# require List/Util.pm
#   from Scalar::Util &#40;/usr/lib/x86_64-linux-gnu/perl/5.22/Scalar/Util.pm:11&#41;
# require XSLoader.pm
#   from List::Util &#40;/usr/lib/x86_64-linux-gnu/perl/5.22/List/Util.pm:21&#41;
# require utf8.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:1028&#41;
# require utf8_heavy.pl
#   from utf8 &#40;/usr/share/perl/5.22/utf8.pm:16&#41;
# require re.pm
#   from utf8 &#40;/usr/share/perl/5.22/utf8_heavy.pl:4&#41;
# require unicore/Heavy.pl
#   from utf8 &#40;/usr/share/perl/5.22/utf8_heavy.pl:185&#41;
# require unicore/lib/Alpha/Y.pl
# require PDL/Options.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:3288&#41;
# require Fcntl.pm
#   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:4167&#41;
...

utf8.pm and the utf8_heavy.pl are actually loaded from PDL::Core.pm
The funny &#34;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;&#34; is caused by the fact
that PDL/Core.pm is a generated file with some 

# line 123 &#34;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;&#34;

lines in it. And the offending line is

      if $value =~ /e\p{IsAlpha}/ or $value =~ /\p{IsAlpha}e/;

There&#39;s no explicit mention of utf8.pm here - the code uses a Unicode property
in a regular expression. utf8.pm &#40;at least in Perl 5.22&#41; doesn&#39;t do anything
except setting up a AUTOLOAD sub that will require utf8_heavy.pl when being run.
&#40;If you check $utf8::AUTOLOAD when our @INC spy is called, it&#39;s value is &#34;utf8::SWASHNEW&#34;.&#41;

So the whole utf8_heavy.pl + unico[dr]e shebang is triggered on demand whenever
some Unicode feature of Perl is requested, e.g. a Unicode property in a regex,
probably lots of others.

I don&#39;t think it&#39;s feasible to try to detect this by statical analysis.
Should we just add this stuff &#40;at least 4 MB speread over more than 400 files&#41;
to _every_ packed executable?

Cheers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;02&nbsp;20:04:00&nbsp;2015</span>
    <span class="description">SLAFFAN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Aug 02 18:02:33 2015, RSCHUPP wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 2015-08-02 00:48:42, SLAFFAN wrote:
<div class="message-stanza open">&gt; &gt; Instrumenting _glob_in_inc to print to stdout whenever unico[rd]e is
&gt; &gt; passed as the subdir argument has no effect, so I assume the utf8.pm
&gt; &gt; preload sub is not being run for the above preload rules.
</div>&gt; 
&gt; Thanks for investigating. I tried to figure out at what point
&gt; utf8_heavy.pl
&gt; comes into play. For that I prepended this to your sample script
&gt; 
&gt; BEGIN
&gt; {
&gt;     # insert spy CODE into require&#39;s module lookup
&gt;      unshift @INC, sub
&gt;     {
&gt;         my &#40;$self, $pm&#41; = @_;
&gt;         print STDERR &#34;# require $pm\n&#34;;
&gt;         &#40;$package, $filename, $line&#41; = caller;
&gt;         print STDERR &#34;#   from $package &#40;$filename:$line&#41;\n&#34;;
&gt;         return;         # i.e. take a pass
&gt;     };
&gt; }
&gt; 
&gt; This intercepts any &#40;explicit or implicit&#41; &#34;require&#34;, prints out what
&gt; is required
&gt; and from where and then resumes &#34;normal&#34; processing. Here&#39;s the output
&gt; 
&gt; # require PDL.pm
&gt; #   from main &#40;/home/roderich/todo/PAR/Module-ScanDeps/shawn.pl:15&#41;
&gt; # require PDL/Core.pm
&gt; #   from main &#40;&#40;eval 1&#41;:6&#41;
&gt; # require PDL/Types.pm
&gt; #   from PDL::Core &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl5/5.22/PDL/Core.pm:223&#41;
&gt; # require Carp.pm
&gt; #   from PDL::Types &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl5/5.22/PDL/Types.pm:6&#41;
&gt; # require strict.pm
&gt; #   from Carp &#40;/usr/share/perl/5.22/Carp.pm:4&#41;
&gt; # require warnings.pm
&gt; #   from Carp &#40;/usr/share/perl/5.22/Carp.pm:5&#41;
&gt; # require Exporter.pm
&gt; #   from Carp &#40;/usr/share/perl/5.22/Carp.pm:99&#41;
&gt; # require overload.pm
&gt; #   from PDL::Type &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl5/5.22/PDL/Types.pm:428&#41;
&gt; # require overloading.pm
&gt; #   from overload &#40;/usr/share/perl/5.22/overload.pm:83&#41;
&gt; # require warnings/register.pm
&gt; #   from overload &#40;/usr/share/perl/5.22/overload.pm:144&#41;
&gt; # require Exporter/Heavy.pm
&gt; #   from Exporter &#40;/usr/share/perl/5.22/Exporter.pm:16&#41;
&gt; # require PDL/Exporter.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:314&#41;
&gt; # require DynaLoader.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:315&#41;
&gt; # require Config.pm
&gt; #   from DynaLoader &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl/5.22/DynaLoader.pm:21&#41;
&gt; # require vars.pm
&gt; #   from Config &#40;/usr/lib/x86_64-linux-gnu/perl/5.22/Config.pm:11&#41;
&gt; # require Scalar/Util.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:1000&#41;
&gt; # require List/Util.pm
&gt; #   from Scalar::Util &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl/5.22/Scalar/Util.pm:11&#41;
&gt; # require XSLoader.pm
&gt; #   from List::Util &#40;/usr/lib/x86_64-linux-
&gt; gnu/perl/5.22/List/Util.pm:21&#41;
&gt; # require utf8.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:1028&#41;
&gt; # require utf8_heavy.pl
&gt; #   from utf8 &#40;/usr/share/perl/5.22/utf8.pm:16&#41;
&gt; # require re.pm
&gt; #   from utf8 &#40;/usr/share/perl/5.22/utf8_heavy.pl:4&#41;
&gt; # require unicore/Heavy.pl
&gt; #   from utf8 &#40;/usr/share/perl/5.22/utf8_heavy.pl:185&#41;
&gt; # require unicore/lib/Alpha/Y.pl
&gt; # require PDL/Options.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:3288&#41;
&gt; # require Fcntl.pm
&gt; #   from PDL::Core &#40;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;:4167&#41;
&gt; ...
&gt; 
&gt; utf8.pm and the utf8_heavy.pl are actually loaded from PDL::Core.pm
&gt; The funny &#34;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;&#34; is caused by the
&gt; fact
&gt;  that PDL/Core.pm is a generated file with some
&gt; 
&gt; # line 123 &#34;Basic/Core/Core.pm.PL &#40;i.e. PDL::Core.pm&#41;&#34;
&gt; 
&gt; lines in it. And the offending line is
&gt; 
&gt; if $value =~ /e\p{IsAlpha}/ or $value =~ /\p{IsAlpha}e/;
&gt; 
&gt; There&#39;s no explicit mention of utf8.pm here - the code uses a Unicode
&gt; property
&gt; in a regular expression. utf8.pm &#40;at least in Perl 5.22&#41; doesn&#39;t do
&gt; anything
&gt; except setting up a AUTOLOAD sub that will require utf8_heavy.pl when
&gt; being run.
&gt; &#40;If you check $utf8::AUTOLOAD when our @INC spy is called, it&#39;s value
&gt; is &#34;utf8::SWASHNEW&#34;.&#41;
&gt; 
&gt; So the whole utf8_heavy.pl + unico[dr]e shebang is triggered on demand
&gt; whenever
&gt; some Unicode feature of Perl is requested, e.g. a Unicode property in
&gt; a regex,
&gt; probably lots of others.
&gt; 
&gt; I don&#39;t think it&#39;s feasible to try to detect this by statical
&gt; analysis.
&gt; Should we just add this stuff &#40;at least 4 MB speread over more than
&gt; 400 files&#41;
&gt; to _every_ packed executable?
&gt; 
&gt; Cheers, Roderich
</div>
Thanks Roderich,

The size issue rears its head once more...

It would also be a Herculean task to get static scanning to detect all such cases &#40;although maybe PPI could be leveraged if someone ever has the tuits - <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/PPI::Token::Regexp">https://metacpan.org/pod/PPI::Token::Regexp</a></span> &#41;.  

Perhaps another flag could be added to pp for the cases where the code does not explicitly call for unicode, but it is needed for a packed executable to work.  pp --unicode?


I also now think that this is the root cause of an issue I&#39;ve been working around for a while using the code below.  I use the pp -x flag when building, and set an environment variable in my script before calling pp.

if &#40;$ENV{BDV_PP_BUILDING}&#41; {
    use 5.016;
    use feature &#39;unicode_strings&#39;;
    my $string = &#34;sp_self_only&#40;&#41; and \N{WHITE SMILING FACE}&#34;;
    $string =~ /\bsp_self_only\b/;
}

Given that, it should be possible to statically scan for the various permutations of /use feature &#39;unicode_/ to detect unicode_strings and unicode_eval.  If someone is using those features in their code then they need the extra libraries.
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/feature#The-unicode_strings-feature">https://metacpan.org/pod/feature#The-unicode_strings-feature</a></span>

Such scanning would not detect multiline chunks, as per the documentation caveats.  A &#34;pp -unicode&#34; style flag would still be needed in such cases.
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Module::ScanDeps#CAVEATS">https://metacpan.org/pod/Module::ScanDeps#CAVEATS</a></span>


WRT the pp flag, maybe a more general approach would be something that parallels the feature pragma, e.g.
pp --feature=unicode_strings,unicode_eval
pp --feature=&#34;:5.12&#34;


Regards,
Shawn.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;08:35:35&nbsp;2016</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Better late than never...

The %Preload rule for PDL::NiceSlice was added in Module::ScanDeps 1.20.
The --unicode option for pp was added in PAR::Packer 1.29.


Chers, Roderich
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;08:35:51&nbsp;2016</span>
    <span class="description">RSCHUPP [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
