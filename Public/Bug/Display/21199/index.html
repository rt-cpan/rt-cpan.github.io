<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #21199 for Class-DBI: Construct throws away data if object is in LiveObjects index</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #21199 for Class-DBI: Construct throws away data if object is in LiveObjects index</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Class-DBI">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Class-DBI">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Class-DBI">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Class-DBI">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Class-DBI">Class-DBI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">21199</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Class-DBI">Class-DBI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ryantate [...] ryantate.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-6690-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-6691-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




28-essential.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/316005/143982/28-essential.t">
Tue May 01 15:38:24 2007 (1.2k) by jon [...] burdge.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=21199">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-235806" href="/Public/Bug/Display.html?id=21199#txn-235806">#</a>      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;27&nbsp;20:01:51&nbsp;2006</span>
    <span class="description">ryantate [...] ryantate.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Construct throws away data if object is in LiveObjects index</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 27 Aug 2006 13:01:28 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bugs-Class-DBI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ryan Tate&#34; &lt;ryantate [...] ryantate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/235806/99139/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/99139">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 821b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">If a row is retrieved via SQL, then turned into an object via CDBI&#39;s &#34;construct&#34; method, any columns retrieved for that row will be thrown away if the object is in the LiveObject index, since in that case the indexed version of the object is used with no attempt to add in new columns retrieved from the database. 

If the original object had only the id column, then only that column will be present in the &#34;construc&#34;ed object.

A great way to fix this problem is to patch _init:

sub _init {
        my $class = shift;
        my $data  = shift || {};
        my $key   = $class-&gt;_live_object_key&#40;$data&#41;;
        my $obj;
        if &#40;$obj = $Live_Objects{$key}&#41; {
          $obj-&gt;_attribute_store&#40;%$data&#41;;
        }
        else {
          $obj = $class-&gt;_fresh_init&#40;$key =&gt; $data&#41;;
        }
        return $obj;
}
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-235846" href="/Public/Bug/Display.html?id=21199#txn-235846">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;28&nbsp;05:07:31&nbsp;2006</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21199] Construct throws away data if object is in LiveObjects index</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Aug 2006 10:07:12 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;ryantate [...] ryantate.com via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/235846/99157/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/99157">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 390b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Aug 27, 2006 at 08:01:51PM -0400, ryantate@ryantate.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If the original object had only the id column, then only that column will be present in the &#34;construc&#34;ed object.
</div>
Thanks for the report. You wouldn&#39;t happen to have a test case would
you? I can probably put one together easier enough but it would be
quicker if you already had one lying around!

Thanks,

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-235847" href="/Public/Bug/Display.html?id=21199#txn-235847">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;28&nbsp;05:07:32&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-235887" href="/Public/Bug/Display.html?id=21199#txn-235887">#</a>      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;28&nbsp;12:01:24&nbsp;2006</span>
    <span class="description">ryantate [...] ryantate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21199] Construct throws away data if object is in LiveObjects index</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 28 Aug 2006 09:01:09 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Tony Bowden via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ryan Tate&#34; &lt;ryantate [...] ryantate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/235887/99185/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/99185">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 767b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have enough code to put one together, shouldn&#39;t take more than ~24 hours...


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">-----Original Message-----
From: Tony Bowden via RT &lt;bug-Class-DBI@rt.cpan.org&gt;
Sent: Mon, August 28, 2006 2:07 am
To: ryantate@ryantate.com
Subject: Re: [rt.cpan.org #21199] Construct throws away data if object is in LiveObjects index


&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=21199">http://rt.cpan.org/Ticket/Display.html?id=21199</a></span> &gt;

On Sun, Aug 27, 2006 at 08:01:51PM -0400, ryantate@ryantate.com via RT wrote:
<div class="message-stanza open">&gt; If the original object had only the id column, then only that column will be present in the &#34;construc&#34;ed object.
</div>
Thanks for the report. You wouldn&#39;t happen to have a test case would
you? I can probably put one together easier enough but it would be
quicker if you already had one lying around!

Thanks,

Tony
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-236208" href="/Public/Bug/Display.html?id=21199#txn-236208">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;30&nbsp;02:08:15&nbsp;2006</span>
    <span class="description">ryantate [...] ryantate.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21199] Construct throws away data if object is in LiveObjects index</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 29 Aug 2006 23:07:59 -0700 &#40;PDT&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Tony Bowden via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Ryan Tate&#34; &lt;ryantate [...] ryantate.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/236208/99400/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/99400">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Mon, August 28, 2006 2:07 am, Tony Bowden via RT &lt;bug-Class-DBI@rt.cpan.org&gt; said:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You wouldn&#39;t happen to have a test case would
&gt; you? 
</div>
A test case follows.

In fact, two test cases follow. The second addresses a concern, apparently historical based on some list discussion, about what this amendment to -&gt;construct will do to changed  columns that have not yet been saved back to the database. There is a feeling the code should check for changed-but-unsaved columns and recognize cases where fresh data from the database sent to -&gt;construct differs from in-memory data added to the object but not yet saved in the database.

There was some discussion on whether the proper thing to do in such a case is to die or to preserve the unsaved data silently. I have come around to preserving unsaved data silently, since this is what Class::DBI does now -- -&gt;construct ignored any new data from the database differing from the in-memory data &#40;since it ignores *everything* from the database when there is in-memory data&#41;. It is more important to preseve existing behavior than to be &#34;correct,&#34; and in this case there is debate over what&#39;s correct anyway.

However, I do think CDBI should emit a warning in these cases.

My second test, then, checks to make sure that if you change an object column, do not save the new data to the database, then try and -&gt;construct that object with new, conflicting data for that column, CDBI will preservbe the changed, unsaved column  value. This passes at the moment since this is how CDBI works now.

Finally, my test is probably a little more complicated than strictly neccesary because it mirrors the real-world scenario where this emerged for me, which was fastest for me to code.

Here are the tests:

use strict;
use warnings;


package Project;
use base &#39;Class::DBI::Test::SQLite&#39;;
__PACKAGE__-&gt;set_table&#40;&#39;project&#39;&#41;;
__PACKAGE__-&gt;columns&#40;Primary =&gt; qw&#40;id&#41;&#41;;
__PACKAGE__-&gt;columns&#40;Essential =&gt; qw&#40;title size latest_event_id&#41;&#41;;
__PACKAGE__-&gt;has_a&#40;latest_event_id =&gt; &#39;Event&#39;&#41;;
__PACKAGE__-&gt;has_many&#40;events =&gt; [&#39;Project::Event&#39; =&gt; &#39;event_id&#39;]&#41;;

sub create_sql{
  return q{
           id INT PRIMARY KEY,
           title VARCHAR&#40;255&#41;,
           size INT,
           latest_event_id INT
          }
}


__PACKAGE__-&gt;set_sql&#40;&#39;events_with_project_events&#39;, 
                     q{
                       SELECT event.id, event.title,
                       project_event.occured_on
                       FROM event, project_event
                       WHERE event.id=project_event.event_id
                       AND project_event.project_id=?
                      }&#41;;

sub events_with_project_events{
  my $self = shift;
  
  my $sth = $self-&gt;sql_events_with_project_events;
  $sth-&gt;execute&#40;$self-&gt;id&#41;;
  my @events_with_project_events;
  while &#40;my $row = $sth-&gt;fetchrow_arrayref&#41; {
    my $i = 0;
    my %event = map { $_ =&gt; $row-&gt;[ $i++ ] } qw&#40;id title&#41;;
    my %project_event = map { $_ =&gt; $row-&gt;[ $i++ ] } qw&#40;occured_on&#41;;
    my $event = Event-&gt;construct&#40;\%event&#41;;
    my $project_event = Project::Event-&gt;construct&#40;\%project_event&#41;;
    push @events_with_project_events, [$event, $project_event];
  }
  $sth-&gt;finish;
  return @events_with_project_events;
}


package Event;
use base &#39;Class::DBI::Test::SQLite&#39;;
__PACKAGE__-&gt;set_table&#40;&#39;event&#39;&#41;;
__PACKAGE__-&gt;autoupdate&#40;0&#41;;
__PACKAGE__-&gt;columns&#40;Primary =&gt; qw&#40;id&#41;&#41;;
__PACKAGE__-&gt;columns&#40;Essential =&gt; qw&#40;title&#41;&#41;;
__PACKAGE__-&gt;has_many&#40;projects =&gt; [&#39;Project::Event&#39; =&gt; &#39;project_id&#39;]&#41;;

sub create_sql{
  return q{
           id INT PRIMARY KEY,
           title VARCHAR&#40;255&#41;
          }
}

package Project::Event;
use base &#39;Class::DBI::Test::SQLite&#39;;
__PACKAGE__-&gt;set_table&#40;&#39;project_event&#39;&#41;;
__PACKAGE__-&gt;columns&#40;Primary =&gt; qw&#40;project_id event_id&#41;&#41;;
__PACKAGE__-&gt;columns&#40;Essential =&gt; qw&#40;occured_on&#41;&#41;;

sub create_sql{
  return q{
           project_id INT,
           event_id INT,
           occured_on INT,
           to_occur_on INT
          }
}

package main;

use Test::More;

plan tests =&gt; 2;

Event-&gt;insert&#40;{id =&gt; 1, title =&gt; &#39;Conception&#39;}&#41;;
Event-&gt;insert&#40;{id =&gt; 2, title =&gt; &#39;Completion&#39;}&#41;;

Project-&gt;insert&#40;{id =&gt; 1, title =&gt; &#39;Cafe Julep&#39;, 
                 size =&gt; &#39;1000&#39;, latest_event_id =&gt; 2}&#41;;

Project::Event-&gt;insert&#40;{project_id =&gt; 1, event_id =&gt; 1,
                        occured_on =&gt; 1156915321}&#41;;
Project::Event-&gt;insert&#40;{project_id =&gt; 1, event_id =&gt; 2,
                        occured_on =&gt; 1156915322}&#41;;

my $project = Project-&gt;retrieve&#40;1&#41;;

my &#40;$event_with_project_event&#41; = grep { $_-&gt;[0]-&gt;id == 2 } $project-&gt;events_with_project_events;
my &#40;$event, $project_event&#41; = @$event_with_project_event;

ok&#40;&#40;$event-&gt;_attr&#40;&#39;title&#39;&#41;&#41;[0] eq &#39;Completion&#39;, &#39;construct can add data to objects in LiveObject index&#39;&#41;;

$event-&gt;title&#40;&#39;Finished&#39;&#41;;
$project-&gt;events_with_project_events;
ok&#40;&#40;$event-&gt;_attr&#40;&#39;title&#39;&#41;&#41;[0] eq &#39;Finished&#39;, &#39;construct preserves value of changed but unsaved columns of objects in LiveObject index&#39;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-237595" href="/Public/Bug/Display.html?id=21199#txn-237595">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;03&nbsp;17:47:08&nbsp;2006</span>
    <span class="description">tony [...] kasei.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #21199] Construct throws away data if object is in LiveObjects index</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 3 Sep 2006 22:46:51 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;ryantate [...] ryantate.com via RT&#34; &lt;bug-Class-DBI [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tony Bowden &lt;tony [...] kasei.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/237595/100164/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/100164">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 213b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Aug 30, 2006 at 02:08:16AM -0400, ryantate@ryantate.com via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; A test case follows.
</div>
Thanks. I&#39;m just back from YAPC::Europe, so I&#39;ll have a look at this in
more detail once I&#39;ve caught up.

Tony
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-316005" href="/Public/Bug/Display.html?id=21199#txn-316005">#</a>      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;01&nbsp;15:38:23&nbsp;2007</span>
    <span class="description">jon [...] burdge.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jon [...] burdge.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/316005/143979/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/143979">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 402b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;m hitting this problem as well.  I created a test case based on the
existing .t files in the distribution and have attached it here.

I tried to copy what you had done in another tests and make a local
version of *Ima::DBI::st:execute which would fail if  the database was
accessed, but this didn&#39;t seem to work as I expected and I&#39;m not very
familiar with Ima::DBI so I went with something simpler.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/316005/143982/28-essential.t">Download 28-essential.t</a><br />
<span class="downloadcontenttype">text/x-perl 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use Test::More;
use Data::Dumper;

BEGIN {
	eval &#34;use DBD::SQLite&#34;;
	plan $@ ? &#40;skip_all =&gt; &#39;needs DBD::SQLite for testing&#39;&#41; : &#40;tests =&gt; 9&#41;;
}

use lib &#39;t/testlib&#39;;
use Film;
use Director;

# finish Film configuration
ok&#40;
    Film-&gt;columns&#40;Essential =&gt; qw/Title Director/&#41;, 
    &#34;set essential film columns&#34;
&#41;;
ok&#40;Film-&gt;has_a&#40;&#39;director&#39; =&gt; &#39;Director&#39;&#41;, &#34;Link Director table&#34;&#41;;
Film-&gt;create_test_film;

# finish Directory configuration
ok&#40;
    Director-&gt;columns&#40;Essential =&gt; qw/Name Birthday IsInsane/&#41;, 
    &#34;set essential director columns&#34;
&#41;;
ok&#40;
	Director-&gt;insert&#40;
		{
			Name     =&gt; &#39;Peter Jackson&#39;,
			Birthday =&gt; -300000000,
			IsInsane =&gt; 1
		}
	&#41;,
	&#39;insert Director&#39;
&#41;;

# verify that retrieving a director populates essential fields
{
    ok my $pj = Director-&gt;retrieve&#40;Name =&gt; &#39;Peter Jackson&#39;&#41;, &#34;found pj&#34;;
    ok defined $pj-&gt;{birthday}, &#34;essential birthday column is loaded&#34;;
}

# verify that retrieving a director populates essential fields after the
# stub director object has already been created by retrieving the movie
ok my $btaste = Film-&gt;retrieve&#40;&#39;Bad Taste&#39;&#41;, &#34;We have Bad Taste&#34;;
ok my $pj = Director-&gt;retrieve&#40;Name =&gt; &#39;Peter Jackson&#39;&#41;, &#34;found pj again&#34;;
ok defined $pj-&gt;{birthday}, &#34;essential birthday column is loaded&#34;;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.493676</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
