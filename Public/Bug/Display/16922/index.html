<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #16922 for Module-Signature: Should be able to specify ID of signing key to use</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #16922 for Module-Signature: Should be able to specify ID of signing key to use</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Module-Signature/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Module-Signature/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Module-Signature/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Module-Signature/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Module-Signature">Module-Signature CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">16922</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Module-Signature/Active/">Module-Signature</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
julian [...] mehnle.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
rotkraut [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-21740-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21741-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;05&nbsp;08:01:56&nbsp;2006</span>
    <span class="description">JMEHNLE [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Should be able to specify ID of signing key to use</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It should be possible to specify the ID of the key that is to be used for signing modules.  AFAICT it currently just uses the gpg default key, which is not always the key one wants to use.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;04:46:47&nbsp;2010</span>
    <span class="description">rotkraut [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Do 05. Jan 2006, 08:01:56, JMEHNLE schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It should be possible to specify the ID of the key that is to be used
&gt; for signing modules.  AFAICT it currently just uses the gpg default
&gt; key, which is not always the key one wants to use.
</div>
I prepared a patch that implements this feature.  The key ID to use may
be set in the new module variable $SigningKey or the environment
variable MODULE_SIGNATURE_SIGNINGKEY. If this variable is set to a false
value &#40;which is the default&#41; the behavior of Module::Signature is not
changed.

In the patched version, the following invocation should work as expected:
$ export MODULE_SIGNATURE_SIGNINGKEY=0xFDCF7486
$ cpansign -s

The attached patch is made against Module::Signature version 0.63 as
found in CPAN.

Please note that i use the gpg back-end and did not test the code for
the Crypt::OpenPGP back-end in sub _sign_crypt_openpgp.  But i hope it
is working nevertheless.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> signingkey.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/Module/Signature.pm.orig	2010-03-28 04:46:01.000000000 +0200
+++ lib/Module/Signature.pm	2010-04-03 21:35:50.000000000 +0200
@@ -4,7 +4,7 @@
 use 5.005;
 use strict;
 use vars qw&#40;$VERSION $SIGNATURE @ISA @EXPORT_OK&#41;;
-use vars qw&#40;$Preamble $Cipher $Debug $Verbose $Timeout&#41;;
+use vars qw&#40;$Preamble $Cipher $Debug $Verbose $Timeout $SigningKey&#41;;
 use vars qw&#40;$KeyServer $KeyServerPort $AutoKeyRetrieve $CanKeyRetrieve&#41;; 
 
 use constant CANNOT_VERIFY       =&gt; &#39;0E0&#39;;
@@ -29,6 +29,7 @@
 $SIGNATURE      = &#39;SIGNATURE&#39;;
 $Timeout        = $ENV{MODULE_SIGNATURE_TIMEOUT} || 3;
 $Verbose        = $ENV{MODULE_SIGNATURE_VERBOSE} || 0;
+$SigningKey     = $ENV{MODULE_SIGNATURE_SIGNINGKEY} || 0;
 $KeyServer      = $ENV{MODULE_SIGNATURE_KEYSERVER} || &#39;pool.sks-keyservers.net&#39;;
 $KeyServerPort  = $ENV{MODULE_SIGNATURE_KEYSERVERPORT} || &#39;11371&#39;;
 $Cipher         = $ENV{MODULE_SIGNATURE_CIPHER} || &#39;SHA1&#39;;
@@ -353,12 +354,13 @@
 
 sub _sign_gpg {
     my &#40;$sigfile, $plaintext, $version&#41; = @_;
+    my $signerarg = $SigningKey ? &#34;-u $SigningKey&#34; : &#34;&#34;;
 
     die &#34;Could not write to $sigfile&#34;
         if -e $sigfile and &#40;-d $sigfile or not -w $sigfile&#41;;
 
     local *D;
-    open D, &#34;| gpg --clearsign &gt;&gt; $sigfile.tmp&#34; or die &#34;Could not call gpg: $!&#34;;
+    open D, &#34;| gpg $signerarg --clearsign &gt;&gt; $sigfile.tmp&#34; or die &#34;Could not call gpg: $!&#34;;
     print D $plaintext;
     close D;
 
@@ -432,8 +434,15 @@
     my $ring = Crypt::OpenPGP::KeyRing-&gt;new&#40;
         Filename =&gt; $pgp-&gt;{cfg}-&gt;get&#40;&#39;SecRing&#39;&#41;
     &#41; or die $pgp-&gt;error&#40;Crypt::OpenPGP::KeyRing-&gt;errstr&#41;;
-    my $kb = $ring-&gt;find_keyblock_by_index&#40;-1&#41;
-        or die $pgp-&gt;error&#40;&#39;Can\&#39;t find last keyblock: &#39; . $ring-&gt;errstr&#41;;
+    my $kb;
+    if &#40;$SigningKey&#41; {
+	$kb = $ring-&gt;find_keyblock_by_keyid&#40;pack &#39;H*&#39;, $SigningKey&#41;
+	    or die $pgp-&gt;error&#40;&#34;Can\&#39;t find keyblock $SigningKey: &#34; . $ring-&gt;errstr&#41;;
+    }
+    else {
+	$kb = $ring-&gt;find_keyblock_by_index&#40;-1&#41;
+	    or die $pgp-&gt;error&#40;&#39;Can\&#39;t find last keyblock: &#39; . $ring-&gt;errstr&#41;;
+    }
 
     my $cert = $kb-&gt;signing_key;
     my $uid = $cert-&gt;uid&#40;$kb-&gt;primary_uid&#41;;
@@ -631,6 +640,12 @@
 The filename for a distribution&#39;s signature file.  Defaults to
 C&lt;SIGNATURE&gt;.
 
+=item $SigningKey
+
+The id of the key to be used for signing.  If set to a false value, a
+default key depending on the back-end &#40;C&lt;gpg&gt; or C&lt;Crypt::OpenPGP&gt;&#41; is
+used.  Defaults to C&lt;0&gt;.
+
 =item $KeyServer
 
 The OpenPGP key server for fetching the author&#39;s public key
@@ -686,6 +701,10 @@
 
 Works like C&lt;$Verbose&gt;.
 
+=item MODULE_SIGNATURE_SIGNINGKEY
+
+Works like C&lt;$SigningKey&gt;.
+
 =item MODULE_SIGNATURE_KEYSERVER
 
 Works like C&lt;$KeyServer&gt;.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;04:46:48&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;14&nbsp;04:50:39&nbsp;2010</span>
    <span class="description">rotkraut [...] cpan.org -  Cc ROTKRAUT added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;24&nbsp;12:43:30&nbsp;2011</span>
    <span class="description">my.roges [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> my.roges [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 05 08:01:56 2006, JMEHNLE wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It should be possible to specify the ID of the key that is to be used
&gt; for signing modules.  AFAICT it currently just uses the gpg default
&gt; key, which is not always the key one wants to use.
</div>
#or we could pull the key from the AUTHOR in the Makefile.PL with this
patch:

--- a/usr/local/share/perl/5.10.0/Module/Signature.pm
+++ b/usr/local/share/perl/5.10.0/Module/Signature.pm
@@ -348,8 +348,17 @@ sub sign {
         return unless &lt;STDIN&gt; =~ /[Yy]/;
     }
 
+    #dirty hack to let the user chose the key
+    my $AUTHOR = &#39;&#39;;
+    $AUTHOR = `grep AUTHOR Makefile.PL` if&#40;-f &#34;Makefile.PL&#34;&#41;;
+    #$AUTHOR = `grep AUTHOR Makefile.PL|sed -e &#39;s/.*{//&#39; -e &#39;s/}.*//&#39;`
if&#40;-f &#34;Makefile.PL&#34;&#41;;
+    $AUTHOR = &#39;&#39; unless $AUTHOR=~s/.*&lt;&#40;.+\@.+&#41;\&gt;.*/$1/; 
+    #$AUTHOR=~s/.*\{&#40;.+&#41;\}.*/$1/;
+    chomp&#40;$AUTHOR&#41;;
+    $AUTHOR=~s/\s*\n$//;
+
     if &#40;my $version = _has_gpg&#40;&#41;&#41; {
-        _sign_gpg&#40;$SIGNATURE, $plaintext, $version&#41;;
+        _sign_gpg&#40;$SIGNATURE, $plaintext, $version, $AUTHOR&#41;;
     }
     elsif &#40;eval {require Crypt::OpenPGP; 1}&#41; {
         _sign_crypt_openpgp&#40;$SIGNATURE, $plaintext&#41;;
@@ -363,13 +372,15 @@ sub sign {
 }
 
 sub _sign_gpg {
-    my &#40;$sigfile, $plaintext, $version&#41; = @_;
+    my &#40;$sigfile, $plaintext, $version, $AUTHOR&#41; = @_;
 
     die &#34;Could not write to $sigfile&#34;
         if -e $sigfile and &#40;-d $sigfile or not -w $sigfile&#41;;
 
     local *D;
-    open D, &#34;| gpg --clearsign &gt;&gt; $sigfile.tmp&#34; or die &#34;Could not call
gpg: $!&#34;;
+    my $set_key =&#39;&#39;;
+     $set_key = &#34;--default-key $AUTHOR&#34; if $AUTHOR;
+    open D, &#34;| gpg $set_key --clearsign &gt;&gt; $sigfile.tmp&#34; or die &#34;Could
not call gpg: $!&#34;;
     print D $plaintext;
     close D;
 

# grep VERSION /usr/local/share/perl/5.10.0/Module/Signature.pm
# $Module::Signature::VERSION = &#39;0.66&#39;;
# works for me &#40;and I agree, this did bug me as I have lots of keys and
lots of addresses.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
