<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #40308 for MediaWiki-API: rollback is dangerously broken</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #40308 for MediaWiki-API: rollback is dangerously broken</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=MediaWiki-API">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=MediaWiki-API">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=MediaWiki-API">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=MediaWiki-API">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MediaWiki-API">MediaWiki-API CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">40308</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=MediaWiki-API">MediaWiki-API</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
steve.sanbeg [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-222716-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.16    </td>
  </tr>
  <tr id="CF-222717-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




rollback2.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/523359/261381/rollback2.patch">
Thu Oct 23 13:06:04 2008 (1.1k) by steve.sanbeg [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=40308">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523359" href="/Public/Bug/Display.html?id=40308#txn-523359">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;13:06:04&nbsp;2008</span>
    <span class="description">steve.sanbeg [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rollback is dangerously broken</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/523359/261378/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261378">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I think this problem is more difficult to describe than to fix, but here
goes.

Rollback is a quick way of removing vandalism; you just specify the page
and the user, and that user&#39;s edits are reverted, if they still have the
top edit.  Currently, the module silently replaced the specified user
with the last editor to the page, which defeats the safety check.  This
means the rollback would always happen, but it&#39;s as likely to replace
vandalism that was reverted as it is to revert it, pretty much defeating
the purpose.  I&#39;ll mark the severity high, since someone who tries to
use this function could get blocked for misuse of it due to this problem.

There&#39;s a similar problem with the timestamp for the first edit.  The
script should keep the timestamp when the page is retrieved, and pass it
back when saving, so the API can detect edit conflicts, but the module
also replaces that with the most recent available timestamp at the time
of the submit, thus disabling any conflicts that could happen during the
processing.  This is only done for the first edit, which is the main
reason I removed that part entirely, so it could be more consistent.

Neither of these overwritten parameters was documented; I only noticed
it when I found that a required parameter wasn&#39;t used in the rollback
example.  Since the documentation is somewhat thin as most parameters
are simply passed through to the server, it may be better to document
exceptions to that.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rollback2.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/523359/261381/rollback2.patch">Download rollback2.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/local/lib/perl5/site_perl/5.10.0/MediaWiki/API.pm	2008-10-16 16:52:28.000000000 -0400
+++ MediaWiki/API.pm	2008-10-23 12:53:47.000000000 -0400
@@ -364,7 +364,7 @@
 
   # rollback a page edit
   $mw-&gt;edit&#40; {
-    action =&gt; &#39;rollback&#39;, title =&gt; &#39;Sandbox&#39; } &#41;
+    action =&gt; &#39;rollback&#39;, title =&gt; &#39;Sandbox&#39;, user =&gt; &#39;Vandal&#39; } &#41;
     || die $mw-&gt;{error}-&gt;{code} . &#39;: &#39; . $mw-&gt;{error}-&gt;{details};
 
 =cut
@@ -663,16 +663,10 @@
 
   if &#40; $action eq &#39;rollback&#39; &#41; {
     $query-&gt;{token} = @{ $pageref-&gt;{revisions} }[0]-&gt;{$action.&#39;token&#39;};
-    $query-&gt;{user}  = @{ $pageref-&gt;{revisions} }[0]-&gt;{user};
   } else {
     $query-&gt;{token} = $pageref-&gt;{$action.&#39;token&#39;};
   }
 
-  # need timestamp of last revision for edits to avoid edit conflicts &#40;if there are previous revisions&#41;
-  if &#40; $action eq &#39;edit&#39; &#38;&#38; defined $pageref-&gt;{revisions} &#41; {
-    $query-&gt;{basetimestamp} = @{ $pageref-&gt;{revisions} }[0]-&gt;{timestamp};
-  }
-
   return $self-&gt;_error&#40; ERR_EDIT, &#39;Unable to get an edit token &#40;$page&#41;.&#39; &#41; unless &#40; defined $query-&gt;{token} &#41;;
 
   # cache the token. rollback tokens are specific for the page name and last edited user so can not be cached.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523363" href="/Public/Bug/Display.html?id=40308#txn-523363">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;13:25:50&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/523363/261384/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261384">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 905b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I will look into this and your patch. I think I may have misunderstood
the mediawiki api documentation &#40;which is limited&#41;.

For example it says

&#34;To edit a page, an edit token is required. This token is the same for
all pages, but changes at every login. If you want to protect against
edit conflicts &#40;which is wise&#41;, you also need to get the timestamp of
the last revision. You can obtain these as follows:&#34;

which I misunderstood I guess. So for an edit, we need some kind of call
to /getset the timestamp along with the page contents, after which we do
the edit. I&#39;ll see what I can do.

The rollback stuff was partly untested, and I guess I misunderstood
their documentation again. The documentation said &#34;user: The author of
the last revision.&#34; so I got the last revision. So you mean it should
rollback a specific requested user instead? makes sense I guess. I&#39;ll
need to experiment with this a bit
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523364" href="/Public/Bug/Display.html?id=40308#txn-523364">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;13:25:52&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523366" href="/Public/Bug/Display.html?id=40308#txn-523366">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;13:31:48&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/523366/261386/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261386">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 192b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;This is only done for the first edit, which is the main
&gt;reason I removed that part entirely, so it could be more consistent.
</div>
Yeh this was a bug anyway despite it seems badly implemented. :/
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523368" href="/Public/Bug/Display.html?id=40308#txn-523368">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;13:39:08&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/523368/261388/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261388">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 397b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I could leave the timestamp handling out like you have said. the person
using my script can then handle it themselves. But some helper functions
might be useful.

I apologise for any inconvenience these problems might have caused you.
I have never really used the rollback function and Just did some quick
tests. And for editing, the wiki I use my module on is too quiet to have
edit conflicts.. 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523397" href="/Public/Bug/Display.html?id=40308#txn-523397">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;14:59:24&nbsp;2008</span>
    <span class="description">steve.sanbeg [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40308] rollback is dangerously broken</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 23 Oct 2008 14:59:10 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MediaWiki-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steve Sanbeg&#34; &lt;steve.sanbeg [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/523397/261411/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261411">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Oct 23, 2008 at 1:39 PM, Jools Smyth via RT &lt;
bug-MediaWiki-API@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=40308">http://rt.cpan.org/Ticket/Display.html?id=40308</a></span> &gt;
&gt;
&gt; I could leave the timestamp handling out like you have said. the person
&gt; using my script can then handle it themselves. But some helper functions
&gt; might be useful.
&gt;
</div>
For the bots I&#39;ve been working on lately, I&#39;ve been writing a higher level
framework, which is basically just helper functions that call yours, but
simplify the API somewhat for common functionality.  In my framework, the
method to get a page returns a blessed reference which stores the contents &#38;
timestamp, so they can be used when the page is saved.  Although I started
it partly to simplify porting a script from a different framework, it seems
to work pretty well for what I&#39;m doing, to have a lower-level complete API,
and a higher level more convenient layer

<span class="clickylink"><a target="new" rel="nofollow" href="http://mediawiki-tools.cvs.sourceforge.net/viewvc/mediawiki-tools/perl/FrameworkAPI.pm?view=log">http://mediawiki-tools.cvs.sourceforge.net/viewvc/mediawiki-tools/perl/FrameworkAPI.pm?view=log</a></span>

That&#39;s still a work in progress, though.  Maybe there is a better way to
structure that.

I think the idea of the timestamp is to see if anyone else edited the page
since you started.  If not, the new content can simply replace the old.  If
so, then the software can try and merge the edits, or raise an edit conflict
if it can&#39;t.  So assuming the operation is to get text, modify it, and send
it back, the timestamp should match the text that was retrieved.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I apologise for any inconvenience these problems might have caused you.
&gt; I have never really used the rollback function and Just did some quick
&gt; tests. And for editing, the wiki I use my module on is too quiet to have
&gt; edit conflicts..
&gt;
&gt;
</div>No problem.  I was just thinking that I could write a script that would do
rollback, but since the documentation didn&#39;t look right, I read the code and
realized it wouldn&#39;t work.  So no harm done.

The classic example of a simple rollback script would be to discover someone
messed up a lot of pages, and run a script that would parse their
contributions and roll back all of their edits.   If someone else already
reverted an edit, then there&#39;s nothing to roll back, and it should do
nothing on that page.  But if the user parameter is overwritten this way,
the revert would get rolled back, thus restoring the vandalism.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/523397/261412/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261412">with headers</a>
<br />
<span class="downloadcontenttype">text/html 3k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-523474" href="/Public/Bug/Display.html?id=40308#txn-523474">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;23&nbsp;18:39:44&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/523474/261453/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/261453">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please give this new version a try

<span class="clickylink"><a target="new" rel="nofollow" href="http://malus.exotica.org.uk/~buzz/cpan/MediaWiki-API-0.17.tar.gz">http://malus.exotica.org.uk/~buzz/cpan/MediaWiki-API-0.17.tar.gz</a></span>

Now when you specify a user for the rollback, if the last edit wasn&#39;t
from that user an error is returned &#40;functions returns undef - and can
be dealt with as you wish&#41;. If no user was given, it will rollback
whoever was the last editor. I&#39;m not sure this is useful, but there
might be some case for it ? My alternatives would have been to return an
error.

I have removed that broken timestamp code, and have changed the edit
example showing how to pass a timestamp. Hopefully this will work.

let me know how you get on. If this seems to work for you, I will make
it a release.

Maybe I should incorporate a easy to use page object, but as you and
others are doing higher level frameworks, perhaps I should just
concentrate on the communication with the api part. I will check out
your code.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That&#39;s still a work in progress, though.  Maybe there is a better way
&gt; to
&gt; structure that.
</div>
I&#39;ll have a read.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If
&gt; so, then the software can try and merge the edits, or raise an edit
&gt; conflict
&gt; if it can&#39;t.  So assuming the operation is to get text, modify it, and
&gt; send
&gt; it back, the timestamp should match the text that was retrieved.
</div>
from what I have read today on the mailinglist, it seems it might always
return a conflict if there is a newer revision timestamp than the one
you have, so perhaps it doesn&#39;t even try to merge via the api ?
&#40;i could have misunderstood though&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-524032" href="/Public/Bug/Display.html?id=40308#txn-524032">#</a>      
    </span>
    <span class="date">Fri&nbsp;Oct&nbsp;24&nbsp;19:10:20&nbsp;2008</span>
    <span class="description">steve.sanbeg [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #40308] rollback is dangerously broken</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 24 Oct 2008 19:08:59 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-MediaWiki-API [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Steve Sanbeg&#34; &lt;steve.sanbeg [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/524032/262056/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/262056">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, Oct 23, 2008 at 6:39 PM, Jools Smyth via RT &lt;
bug-MediaWiki-API@rt.cpan.org&gt; wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=40308">http://rt.cpan.org/Ticket/Display.html?id=40308</a></span> &gt;
&gt;
&gt; Please give this new version a try
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://malus.exotica.org.uk/~buzz/cpan/MediaWiki-API-0.17.tar.gz">http://malus.exotica.org.uk/~buzz/cpan/MediaWiki-API-0.17.tar.gz</a></span>&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://malus.exotica.org.uk/%7Ebuzz/cpan/MediaWiki-API-0.17.tar.gz">http://malus.exotica.org.uk/%7Ebuzz/cpan/MediaWiki-API-0.17.tar.gz</a></span>&gt;
&gt;
</div>
OK, I&#39;ll take a look at it.  The primary bot I&#39;m working on now is one that
runs once a month to archive a discussion page, so that wouldn&#39;t be a
thorough test, but I&#39;ll try this out.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; Now when you specify a user for the rollback, if the last edit wasn&#39;t
&gt; from that user an error is returned &#40;functions returns undef - and can
&gt; be dealt with as you wish&#41;. If no user was given, it will rollback
&gt; whoever was the last editor. I&#39;m not sure this is useful, but there
&gt; might be some case for it ? My alternatives would have been to return an
&gt; error.
&gt;
</div>
My thinking was that forgetting to pass the user would be unusual enough
that it should trigger an error, although if there is a use to fill it in
automatically, maybe passing some special username may work; i.e. user=&gt;&#39;*&#39;
would trigger a replacement,.  Returning undef seems reasonable; mostly it
wouldn&#39;t matter whether the revert happened by you or someone else so that
can be ignored, but it could be useful to see which rollbacks resulted in
some action.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; I have removed that broken timestamp code, and have changed the edit
&gt; example showing how to pass a timestamp. Hopefully this will work.
&gt;
&gt; let me know how you get on. If this seems to work for you, I will make
&gt; it a release.
&gt;
&gt; Maybe I should incorporate a easy to use page object, but as you and
&gt; others are doing higher level frameworks, perhaps I should just
&gt; concentrate on the communication with the api part. I will check out
&gt; your code.
&gt;
</div>
What I&#39;m trying to do with my framework is  to create a simple api, similar
to a classic pywikipedia style, without worrying too much about the
communication with the api.   Some of what I&#39;m working on, i.e. logins that
are reliable despite the throttled login method &#38; expiring cookies, or the
built in test mode, may be out of the scope of what you want to do.  It is
useful, but I&#39;m not sure whether or not some of that could be merged in
without making things too confusing.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
<div class="message-stanza open">&gt; &gt; That&#39;s still a work in progress, though.  Maybe there is a better way
&gt; &gt; to
&gt; &gt; structure that.
</div>&gt;
&gt; I&#39;ll have a read.
&gt;
<div class="message-stanza open">&gt; &gt; If
&gt; &gt; so, then the software can try and merge the edits, or raise an edit
&gt; &gt; conflict
&gt; &gt; if it can&#39;t.  So assuming the operation is to get text, modify it, and
&gt; &gt; send
&gt; &gt; it back, the timestamp should match the text that was retrieved.
</div>&gt;
&gt; from what I have read today on the mailinglist, it seems it might always
&gt; return a conflict if there is a newer revision timestamp than the one
&gt; you have, so perhaps it doesn&#39;t even try to merge via the api ?
&gt; &#40;i could have misunderstood though&#41;
&gt;
</div>
I just found that discussion on the web archive.  It looks like there was
eventually a more detailed description of the merge, so it seems like it
does happen, but since it doesn&#39;t usually work &#40;unless you use section=new&#41;
it doesn&#39;t get much emphasis.
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/524032/262057/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/262057">with headers</a>
<br />
<span class="downloadcontenttype">text/html 4.2k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-526699" href="/Public/Bug/Display.html?id=40308#txn-526699">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;30&nbsp;14:42:35&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/526699/263527/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/263527">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 206b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am marking this as resolved as the problems are fixed in the latest
0.17 upload which will appear shortly. If you have any problems with the
new version please do let me know via this bugtracker.

Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-526701" href="/Public/Bug/Display.html?id=40308#txn-526701">#</a>      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;30&nbsp;14:42:38&nbsp;2008</span>
    <span class="description">buzz [...] exotica.org.uk -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.630449</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
