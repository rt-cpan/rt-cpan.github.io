<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73624 for DBD-Sybase: Uncaught error &#34;cs_convert failed &#40;to_numeric&#40;%&#41;&#41;&#34; under certain circumstances</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73624 for DBD-Sybase: Uncaught error &#34;cs_convert failed &#40;to_numeric&#40;%&#41;&#41;&#34; under certain circumstances</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-Sybase/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-Sybase/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-Sybase/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-Sybase/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-Sybase">DBD-Sybase CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73624</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">new</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-Sybase/Active/">DBD-Sybase</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dlewis [...] mindbrix.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10262-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10263-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;30&nbsp;14:02:00&nbsp;2011</span>
    <span class="description">dlewis [...] mindbrix.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Uncaught error &#34;cs_convert failed &#40;to_numeric&#40;%&#41;&#41;&#34; under certain
 circumstances</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Environment:
perl version: 5.12.4
DBI version: 1.616
DBD::Sybase version: 1.14

Steps to recreate:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">1&gt; Create a table with a NUMERIC field &#40;not an integer, tinyint, etc&#41;.
</div><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">2&gt; Set $dbh-&gt;{PrintError} to 0 and $dbh-&gt;{HandleError} and $dbh-&gt;
</div>{syb_err_handler} to appropriate values.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">3&gt; Generate a prepared statement with the numeric field as one of the 
</div>where clause selection criteria, e.g. SELECT * FROM test_table WHERE 
id=?
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">4&gt; execute this prepared statement with a string value, e.g. $sth-
</div><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;execute&#40;&#39;WILL FAIL&#39;&#41;
</div>
This causes an error &#39;cs_convert failed &#40;to_numeric&#40;WILL FAIL&#41;&#41; at ...&#39; 
to be printed to STDERR.  This does not occur with other data types that 
I have been able to find, though my search has been far from exhaustive.  
I believe this should trigger the error handler, and prevent the 
prepared statement from being executed.  Instead the statement is 
executed using a &#39;0&#39; for the bound value, which would be a silent error 
if this were to occur within an unmonitored application, such as a web 
server.

I&#39;ve tried using $dbh-&gt;{HandleSetError} as well as 
DBD::Sybase::syb_set_cslib_cb; neither catch the error.

Sample code is attached.  Please let me know if you need any further 
information in order to be able to reproduce or troubleshoot this issue.

Thank you very much for all the work you do; we&#39;ve been using ctLib, et 
al for years and are working to convert to DBD::Sybase now.


David
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbitest.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/home/lewisd/dev/utils/mbxperl -I /home/lewisd/code/
use strict;
use Data::Dumper;
use Carp;

use DBI;


my $dbh = DBI-&gt;connect&#40;&#39;DBI:Sybase:server=test;database=test&#39;, &#39;sa&#39;, &#39;&#39;&#41;;
$dbh-&gt;{HandleError} = \&#38;dbi_error_handler;
$dbh-&gt;{PrintError} = 0;
$dbh-&gt;{syb_err_handler} = \&#38;sybase_error_handler;

my $create_table = qq{
  CREATE TABLE test&#40;
    OrderID NUMERIC&#40;5, 0&#41; IDENTITY NOT NULL,
    Name VARCHAR&#40;10&#41; NULL
  &#41;
};

$dbh-&gt;do&#40;$create_table&#41;;

$dbh-&gt;do&#40;qq{INSERT INTO test&#40;Name&#41; VALUES&#40;&#39;my name&#39;&#41;}&#41;;

#my $sql = qq{SELECT COUNT&#40;*&#41; FROM master..sysprocesses WHERE spid &gt;= ?};
my $sql = qq{SELECT COUNT&#40;*&#41; FROM test WHERE OrderID &gt;= ?};
my $sth = $dbh-&gt;prepare&#40;$sql&#41;;

# This works as expected.
my $value = 7;
$sth-&gt;execute&#40;$value&#41;;
my $array_ref = $sth-&gt;fetchall_arrayref&#40;{}&#41;;
$sth-&gt;finish&#40;&#41;;
print &#34;sql: $sql\nvalue: $value\n&#34;, Dumper&#40;$array_ref&#41;, &#34;\n\n&#34;;

# This fails, but the error is uncaught.
# Additionally, the prepared statement is then executed in Sybase, which returns unwanted and invalid results.
# Effectively, it appears to pass in a &#39;0&#39; where the bound value placeholder is located.
$value = &#39;fail!!&#39;;
$sth-&gt;execute&#40;$value&#41;;
$array_ref = $sth-&gt;fetchall_arrayref&#40;{}&#41;;
$sth-&gt;finish&#40;&#41;;
print &#34;sql: $sql\nvalue: $value\n&#34;, Dumper&#40;$array_ref&#41;, &#34;\n\n&#34;;

$sth = undef;

$dbh-&gt;do&#40;qq{DROP TABLE test}&#41;;



sub dbi_error_handler {
  confess&#40;shift&#41;;
  print STDERR &#34;\n\n&#34;;
  return undef;
}

sub sybase_error_handler {
  my &#40;$error_code, $severity_level, $state, $line, $server, $procedure, $message, $sql, $error_type&#41; = @_;
  chomp&#40;$message&#41;;
  my $log_stamp = &#38;get_stamp&#40;&#41;;
  print STDERR &#34;In sybase_error_handler:\n&#34;;
  print STDERR qq{$log_stamp $server - Error:
    SevLvl:     $severity_level
    Number:     $error_code
    State:      $state
    Procedure:  $procedure
    Error Type: $error_type
    Line:       $line
    MSG:        $message
    SQL:        $sql
  };
  print STDERR Carp::longmess&#40;&#34;\n\nTRACE INFO ON PID $$:\n&#34;&#41;, &#34;\n\n&#34;;
  return 0;
}
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
