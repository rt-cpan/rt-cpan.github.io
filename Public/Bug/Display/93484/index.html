<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #93484 for Sereal-Encoder: arity check fault breaks static method resolution</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #93484 for Sereal-Encoder: arity check fault breaks static method resolution</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sereal-Encoder/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sereal-Encoder/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="https://github.com/Sereal/Sereal/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sereal-Encoder">Sereal-Encoder CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">93484</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sereal-Encoder/Active/">Sereal-Encoder</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zefram [...] fysh.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245624-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-245625-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;03&nbsp;06:13:37&nbsp;2014</span>
    <span class="description">zefram [...] fysh.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 3 Mar 2014 11:13:23 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In attempting to eke out a bit of extra performance by statically
resolving a critical method call, I found this breakage:

$ perl -MSereal::Encoder -lwe &#39;$s=Sereal::Encoder-&gt;new; print length&#40;$s-&gt;encode&#40;{}&#41;&#41;; print length&#40;$s-&gt;can&#40;&#34;encode&#34;&#41;-&gt;&#40;$s, {}&#41;&#41;;&#39;
9
Found type 13 CODE&#40;0x1e9c060&#41;, but it is not representable by the Sereal encoding format at -e line 1.

This call with the separately-resolved method ought to be entirely
equivalent to calling the method normally.  It&#39;s very strange that
it&#39;s not.  Turns out that Sereal::Encoder::encode screws up an arity
check and can look beyond its arguments on the stack.  Whether the bug
shows up therefore depends on accidents of the surrounding expression
that determine what the invalid stack slot actually contains.  Attached
patch fixes.

-zefram
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;03&nbsp;06:37:38&nbsp;2014</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93484] arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 3 Mar 2014 12:36:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 3 March 2014 12:13, Zefram via RT &lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Mon Mar 03 06:13:37 2014: Request 93484 was acted upon.
&gt; Transaction: Ticket created by zefram@fysh.org
&gt;        Queue: Sereal-Encoder
&gt;      Subject: arity check fault breaks static method resolution
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: zefram@fysh.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93484">https://rt.cpan.org/Ticket/Display.html?id=93484</a></span> &gt;
&gt;
&gt;
&gt; In attempting to eke out a bit of extra performance by statically
&gt; resolving a critical method call, I found this breakage:
&gt;
&gt; $ perl -MSereal::Encoder -lwe &#39;$s=Sereal::Encoder-&gt;new; print length&#40;$s-&gt;encode&#40;{}&#41;&#41;; print length&#40;$s-&gt;can&#40;&#34;encode&#34;&#41;-&gt;&#40;$s, {}&#41;&#41;;&#39;
&gt; 9
&gt; Found type 13 CODE&#40;0x1e9c060&#41;, but it is not representable by the Sereal encoding format at -e line 1.
&gt;
&gt; This call with the separately-resolved method ought to be entirely
&gt; equivalent to calling the method normally.  It&#39;s very strange that
&gt; it&#39;s not.  Turns out that Sereal::Encoder::encode screws up an arity
&gt; check and can look beyond its arguments on the stack.  Whether the bug
&gt; shows up therefore depends on accidents of the surrounding expression
&gt; that determine what the invalid stack slot actually contains.  Attached
&gt; patch fixes.
</div>
Thanks, patch applied as:

commit 568df18be6acbbcaaa049c38198d53be2986ceca
Author: Zefram &lt;zefram@fysh.org&gt;
Date:   Mon Mar 3 12:33:02 2014 +0100

    Fix rt.cpan.org #93484 - fencepost error in Encoder.xs

    In attempting to eke out a bit of extra performance by statically
    resolving a critical method call, I found this breakage:

    $ perl -MSereal::Encoder -lwe &#39;$s=Sereal::Encoder-&gt;new; print
length&#40;$s-&gt;encode&#40;{}&#41;&#41;; print length&#40;$s-&gt;can&#40;&#34;encode&#34;&#41;-&gt;&#40;$s, {}&#41;&#41;;&#39;
    9
    Found type 13 CODE&#40;0x1e9c060&#41;, but it is not representable by the
Sereal encoding format at -e line 1.

    This call with the separately-resolved method ought to be entirely
    equivalent to calling the method normally.  It&#39;s very strange that
    it&#39;s not.  Turns out that Sereal::Encoder::encode screws up an arity
    check and can look beyond its arguments on the stack.  Whether the bug
    shows up therefore depends on accidents of the surrounding expression
    that determine what the invalid stack slot actually contains.



-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;03&nbsp;06:37:39&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;03&nbsp;08:10:20&nbsp;2014</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93484] arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 3 Mar 2014 13:10:09 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;Thanks, patch applied as:
</div>
I suggest that you also add a test.

FYI, the formulation that I&#39;ve ended up using to minimise overhead is

        use Memoize::Lift qw&#40;lift&#41;;
        use Scalar::Construct qw&#40;constant&#41;;
        use Sereal::Encoder &#40;&#41;;
        use Lexical::Var &#39;$sereal_encoder&#39; =&gt; constant&#40;Sereal::Encoder-&gt;new&#41;;

        # $ser = $sereal_encoder-&gt;encode&#40;$data&#41;
        $ser = lift&#40;$sereal_encoder-&gt;can&#40;&#34;encode&#34;&#41;&#41;-&gt;&#40;$sereal_encoder, $data&#41;;

and similarly for decoding.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;12:37:42&nbsp;2014</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Version 2.04 of encoder and decoder were just uploaded to PAUSE and they have your fix. Thank you very much for diagnosing the issue and reporting it. Sorry for getting it wrong in the first place &#40;that was most certainly me&#41;.

Best regards,
Steffen
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;12:37:43&nbsp;2014</span>
    <span class="description">smueller [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;14:41:07&nbsp;2014</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93484] arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 5 Mar 2014 20:40:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 3 March 2014 14:10, Zefram via RT &lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sereal-Encoder
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93484">https://rt.cpan.org/Ticket/Display.html?id=93484</a></span> &gt;
&gt;
&gt; demerphq via RT wrote:
<div class="message-stanza open">&gt;&gt;Thanks, patch applied as:
</div>&gt;
&gt; I suggest that you also add a test.
&gt;
&gt; FYI, the formulation that I&#39;ve ended up using to minimise overhead is
&gt;
&gt;         use Memoize::Lift qw&#40;lift&#41;;
&gt;         use Scalar::Construct qw&#40;constant&#41;;
&gt;         use Sereal::Encoder &#40;&#41;;
&gt;         use Lexical::Var &#39;$sereal_encoder&#39; =&gt; constant&#40;Sereal::Encoder-&gt;new&#41;;
&gt;
&gt;         # $ser = $sereal_encoder-&gt;encode&#40;$data&#41;
&gt;         $ser = lift&#40;$sereal_encoder-&gt;can&#40;&#34;encode&#34;&#41;&#41;-&gt;&#40;$sereal_encoder, $data&#41;;
&gt;
&gt; and similarly for decoding.
</div>
How much difference does that make? Do you have timing data available?

Yves


-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;05&nbsp;15:33:42&nbsp;2014</span>
    <span class="description">zefram [...] fysh.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93484] arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 5 Mar 2014 20:33:29 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> demerphq via RT &lt;bug-Sereal-Encoder [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Zefram &lt;zefram [...] fysh.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">demerphq via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;How much difference does that make?
</div>
Fractional.  It was about 1% in my timing test; for comparison, Sereal
was faster than Storable by a factor of around 1.5 to 2, depending on
the test data.  The static method resolution doesn&#39;t reduce the number
of ops executed, but means that one op is of a cheaper type, a const op
instead of a method_named op.

As the Sereal::{En,De}coder modules don&#39;t use polymorphism, either as an
API feature or as an implementation strategy, you&#39;re really not gaining
anything by using a method call interface.  It makes greater logical
sense, and is fractionally more efficient, to view the {en,de}coder
operation as a static subroutine that takes an {en,de}coder object ref
as its first argument.  That&#39;s essentially what I&#39;m doing with my -&gt;can
formulation; you could make it easier by exposing and documenting the
existing Sereal::Encoder::encode and Sereal::Decoder::decode subs as
being callable in that way &#40;possibly under other names&#41;.

I&#39;ve been wondering what gain could be made by turning Sereal&#39;s
{en,de}code subs into custom ops.  Removing the sub call overhead
is potentially worthwhile in cases like this; it&#39;ll win more than
avoiding the method resolution overhead.  Static resolution of the
subroutine is a prerequisite for the transformation into custom ops.
It would also be possible to dispense with a pushmark op if the static
subs have appropriate prototypes, rather than imitating method calls.
I&#39;m intending to try this out soonish.

-zefram
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;06&nbsp;02:07:54&nbsp;2014</span>
    <span class="description">demerphq [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #93484] arity check fault breaks static method resolution</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 6 Mar 2014 08:07:45 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sereal-Encoder [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> demerphq &lt;demerphq [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 5 March 2014 21:33, Zefram via RT &lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Sereal-Encoder
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93484">https://rt.cpan.org/Ticket/Display.html?id=93484</a></span> &gt;
&gt;
&gt; demerphq via RT wrote:
<div class="message-stanza open">&gt;&gt;How much difference does that make?
</div>&gt;
&gt; Fractional.  It was about 1% in my timing test; for comparison, Sereal
&gt; was faster than Storable by a factor of around 1.5 to 2, depending on
&gt; the test data.  The static method resolution doesn&#39;t reduce the number
&gt; of ops executed, but means that one op is of a cheaper type, a const op
&gt; instead of a method_named op.
&gt;
&gt; As the Sereal::{En,De}coder modules don&#39;t use polymorphism, either as an
&gt; API feature or as an implementation strategy, you&#39;re really not gaining
&gt; anything by using a method call interface.  It makes greater logical
&gt; sense, and is fractionally more efficient, to view the {en,de}coder
&gt; operation as a static subroutine that takes an {en,de}coder object ref
&gt; as its first argument.  That&#39;s essentially what I&#39;m doing with my -&gt;can
&gt; formulation; you could make it easier by exposing and documenting the
&gt; existing Sereal::Encoder::encode and Sereal::Decoder::decode subs as
&gt; being callable in that way &#40;possibly under other names&#41;.
&gt;
&gt; I&#39;ve been wondering what gain could be made by turning Sereal&#39;s
&gt; {en,de}code subs into custom ops.  Removing the sub call overhead
&gt; is potentially worthwhile in cases like this; it&#39;ll win more than
&gt; avoiding the method resolution overhead.  Static resolution of the
&gt; subroutine is a prerequisite for the transformation into custom ops.
&gt; It would also be possible to dispense with a pushmark op if the static
&gt; subs have appropriate prototypes, rather than imitating method calls.
&gt; I&#39;m intending to try this out soonish.
</div>
Thanks a lot, this is very interesting. Please keep us posted.

Yves


-- 
perl -Mre=debug -e &#34;/just|another|perl|hacker/&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;07&nbsp;01:12:07&nbsp;2014</span>
    <span class="description">smueller [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 06 02:07:54 2014, demerphq@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On 5 March 2014 21:33, Zefram via RT &lt;bug-Sereal-Encoder@rt.cpan.org&gt; wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Sereal-Encoder
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=93484">https://rt.cpan.org/Ticket/Display.html?id=93484</a></span> &gt;
&gt; &gt;
&gt; &gt; demerphq via RT wrote:
<div class="message-stanza open">&gt; &gt;&gt;How much difference does that make?
</div>&gt; &gt;
&gt; &gt; Fractional.  It was about 1% in my timing test; for comparison, Sereal
&gt; &gt; was faster than Storable by a factor of around 1.5 to 2, depending on
&gt; &gt; the test data.  The static method resolution doesn&#39;t reduce the number
&gt; &gt; of ops executed, but means that one op is of a cheaper type, a const op
&gt; &gt; instead of a method_named op.
&gt; &gt;
&gt; &gt; As the Sereal::{En,De}coder modules don&#39;t use polymorphism, either as an
&gt; &gt; API feature or as an implementation strategy, you&#39;re really not gaining
&gt; &gt; anything by using a method call interface.  It makes greater logical
&gt; &gt; sense, and is fractionally more efficient, to view the {en,de}coder
&gt; &gt; operation as a static subroutine that takes an {en,de}coder object ref
&gt; &gt; as its first argument.  That&#39;s essentially what I&#39;m doing with my -&gt;can
&gt; &gt; formulation; you could make it easier by exposing and documenting the
&gt; &gt; existing Sereal::Encoder::encode and Sereal::Decoder::decode subs as
&gt; &gt; being callable in that way &#40;possibly under other names&#41;.
&gt; &gt;
&gt; &gt; I&#39;ve been wondering what gain could be made by turning Sereal&#39;s
&gt; &gt; {en,de}code subs into custom ops.  Removing the sub call overhead
&gt; &gt; is potentially worthwhile in cases like this; it&#39;ll win more than
&gt; &gt; avoiding the method resolution overhead.  Static resolution of the
&gt; &gt; subroutine is a prerequisite for the transformation into custom ops.
&gt; &gt; It would also be possible to dispense with a pushmark op if the static
&gt; &gt; subs have appropriate prototypes, rather than imitating method calls.
&gt; &gt; I&#39;m intending to try this out soonish.
</div>&gt; 
&gt; Thanks a lot, this is very interesting. Please keep us posted.
&gt; 
&gt; Yves
&gt; 
&gt; 
</div>
Just some data:

                       Rate function method function_state
function       478548+-35/s       -- -39.2%         -46.1%
method         786838+-94/s    64.4%     --         -11.4%
function_state 888076+-61/s    85.6%  12.9%             --


#!perl
use Sereal qw&#40;:all&#41;;
my $e = Sereal::Encoder-&gt;new;

my $in = {};
my $out = $e-&gt;encode&#40;$in&#41;;

use Benchmark::Dumb qw&#40;:all&#41;;

cmpthese&#40;
  10000.001,
  {
      method =&gt; sub {$out = $e-&gt;encode&#40;$in&#41;},
      function =&gt; sub {$out = encode_sereal&#40;$in&#41;},
      function_state
        =&gt; sub {$out = Sereal::Encoder::encode&#40;$e, $in&#41;},
  },
&#41;;
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
