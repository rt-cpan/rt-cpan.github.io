<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50456 for BerkeleyDB: Several important environmental parameters unsettable</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50456 for BerkeleyDB: Several important environmental parameters unsettable</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/BerkeleyDB/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/BerkeleyDB/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/BerkeleyDB">BerkeleyDB CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50456</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/BerkeleyDB/Active/">BerkeleyDB</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mdorman [...] ironicdesign.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-3650-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.39    </td>
  </tr>
  <tr id="CF-3651-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;12:37:24&nbsp;2009</span>
    <span class="description">mdorman [...] ironicdesign.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Several important environmental parameters unsettable</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">In trying to write a transactional BDB back-end for SpamAssassin&#39;s Bayes
storage, I&#39;ve run into the need to set several parameters that are only
available after the DB_ENV is created, but before it is open&#40;&#41;&#39;ed.  In
the SA environment, requiring the user to create and/or maintain a
DB_CONFIG file is sub-optimal.

I recognize that willy-nilly adding more parameters to BerkeleyDB::Env&#39;s
-&gt;new&#40;&#41; is probably sub-optimal, but short of significant surgery &#40;to
allow a flexible way to specify all post-create-pre-new parameters&#41; that
I didn&#39;t feel comfortable undertaking, adding the necessary parameters
seemed the best route.

I also &#34;fixed&#34; the existing set_tx_max and get_tx_max functions, insofar
as I don&#39;t see how they could have ever worked, but set_tx_max is still
an academic exercise since we have no way to invoke it at the right
time, and it should likely be eliminated.

Please note that this patch would also allow the resolution of RT#44907.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.diff</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -uNr --exclude=&#39;debian*&#39; BerkeleyDB-0.39/BerkeleyDB.pm libberkeleydb-perl-0.39/BerkeleyDB.pm
--- BerkeleyDB-0.39/BerkeleyDB.pm	2009-06-03 18:50:39.000000000 -0400
+++ libberkeleydb-perl-0.39/BerkeleyDB.pm	2009-10-13 09:33:48.000000000 -0400
@@ -807,6 +807,11 @@
 					SetFlags     	=&gt; 0,
 					Cachesize     	=&gt; 0,
 					LockDetect     	=&gt; 0,
+					TxMax     	=&gt; 0,
+					LogConfig     	=&gt; 0,
+					MaxLockers     	=&gt; 0,
+					MaxLocks     	=&gt; 0,
+					MaxObjects     	=&gt; 0,
 					Verbose		=&gt; 0,
 					Config		=&gt; undef,
 					Encrypt		=&gt; undef,
diff -uNr --exclude=&#39;debian*&#39; BerkeleyDB-0.39/BerkeleyDB.pod.P libberkeleydb-perl-0.39/BerkeleyDB.pod.P
--- BerkeleyDB-0.39/BerkeleyDB.pod.P	2009-06-02 18:23:20.000000000 -0400
+++ libberkeleydb-perl-0.39/BerkeleyDB.pod.P	2009-10-13 12:34:47.000000000 -0400
@@ -161,6 +161,11 @@
              [ -Flags        =&gt; number, ]
              [ -SetFlags     =&gt; bitmask, ]
              [ -LockDetect   =&gt; number, ]
+             [ -TxMax        =&gt; number, ]
+             [ -LogConfig    =&gt; number, ]
+             [ -MaxLockers   =&gt; number, ]
+             [ -MaxLocks     =&gt; number, ]
+             [ -MaxObjects   =&gt; number, ]
              [ -SharedMemKey =&gt; number, ]
              [ -Verbose      =&gt; boolean, ]
              [ -Encrypt      =&gt; { Password =&gt; &#34;string&#34;,
@@ -218,6 +223,31 @@
 If present, this parameter sets the size of the environments shared memory
 buffer pool.
 
+=item -TxMax
+
+If present, this parameter sets the number of simultaneous
+transactions that are allowed.  Default 100.  This default is
+definitely too low for programs using the MVCC capabilities.
+
+=item -LogConfig
+
+If present, this parameter is used to configure log options.
+
+=item -MaxLockers
+
+If present, this parameter is used to configure the maximum number of
+processes doing locking on the database.  Default 1000.
+
+=item -MaxLocks
+
+If present, this parameter is used to configure the maximum number of
+locks on the database.  Default 1000.  This is often lower than required.
+
+=item -MaxObjects
+
+If present, this parameter is used to configure the maximum number of
+locked objects.  Default 1000.  This is often lower than required.
+
 =item -SharedMemKey
 
 If present, this parameter sets the base segment ID for the shared memory
diff -uNr --exclude=&#39;debian*&#39; BerkeleyDB-0.39/BerkeleyDB.xs libberkeleydb-perl-0.39/BerkeleyDB.xs
--- BerkeleyDB-0.39/BerkeleyDB.xs	2009-06-03 18:50:39.000000000 -0400
+++ libberkeleydb-perl-0.39/BerkeleyDB.xs	2009-10-13 09:33:26.000000000 -0400
@@ -2346,6 +2346,11 @@
 	    int		setflags = 0 ;
 	    int		cachesize = 0 ;
 	    int		lk_detect = 0 ;
+            int		tx_max = 0 ;
+            int		log_config = 0 ;
+            int		max_lockers = 0 ;
+            int		max_locks = 0 ;
+            int		max_objects = 0 ;
 	    long	shm_key = 0 ;
 	    char*	data_dir = 0;
 	    char*	log_dir = 0;
@@ -2368,6 +2373,11 @@
 	    SetValue_pv&#40;server,    &#34;Server&#34;, char *&#41; ;
 	    SetValue_iv&#40;cachesize, &#34;Cachesize&#34;&#41; ;
 	    SetValue_iv&#40;lk_detect, &#34;LockDetect&#34;&#41; ;
+	    SetValue_iv&#40;tx_max,    &#34;TxMax&#34;&#41; ;
+	    SetValue_iv&#40;log_config,&#34;LogConfig&#34;&#41; ;
+	    SetValue_iv&#40;max_lockers,&#34;MaxLockers&#34;&#41; ;
+	    SetValue_iv&#40;max_locks, &#34;MaxLocks&#34;&#41; ;
+	    SetValue_iv&#40;max_objects,&#34;MaxObjects&#34;&#41; ;
 	    SetValue_iv&#40;shm_key,   &#34;SharedMemKey&#34;&#41; ;
 		SetValue_iv&#40;thread_count,   &#34;ThreadCount&#34;&#41; ;
 	    SetValue_pv&#40;data_dir,   &#34;DB_DATA_DIR&#34;, char*&#41; ;
@@ -2510,6 +2520,36 @@
 	      Trace&#40;&#40;&#34;set_lk_detect [%d] returned %s\n&#34;,
 	              lk_detect, my_db_strerror&#40;status&#41;&#41;&#41;;
 	  }
+
+	  if &#40;status == 0 &#38;&#38; tx_max&#41; {
+	      status = env-&gt;set_tx_max&#40;env, tx_max&#41; ;
+	      Trace&#40;&#40;&#34;set_tx_max [%d] returned %s\n&#34;,
+	              tx_max, my_db_strerror&#40;status&#41;&#41;&#41;;
+	  }
+
+	  if &#40;status == 0 &#38;&#38; log_config&#41; {
+	      status = env-&gt;log_set_config&#40;env, log_config, 1&#41; ;
+	      Trace&#40;&#40;&#34;log_set_config [%d] returned %s\n&#34;,
+	              log_config, my_db_strerror&#40;status&#41;&#41;&#41;;
+	  }
+
+	  if &#40;status == 0 &#38;&#38; max_lockers&#41; {
+	      status = env-&gt;set_lk_max_lockers&#40;env, max_lockers&#41; ;
+	      Trace&#40;&#40;&#34;set_lk_max_lockers [%d] returned %s\n&#34;,
+	              max_lockers, my_db_strerror&#40;status&#41;&#41;&#41;;
+	  }
+
+	  if &#40;status == 0 &#38;&#38; max_locks&#41; {
+	      status = env-&gt;set_lk_max_locks&#40;env, max_locks&#41; ;
+	      Trace&#40;&#40;&#34;set_lk_max_locks [%d] returned %s\n&#34;,
+	              max_locks, my_db_strerror&#40;status&#41;&#41;&#41;;
+	  }
+
+	  if &#40;status == 0 &#38;&#38; max_objects&#41; {
+	      status = env-&gt;set_lk_max_objects&#40;env, max_objects&#41; ;
+	      Trace&#40;&#40;&#34;set_lk_max_objects [%d] returned %s\n&#34;,
+	              max_objects, my_db_strerror&#40;status&#41;&#41;&#41;;
+	  }
 #ifdef AT_LEAST_DB_4_1
 	  /* set encryption */
 	  if &#40;enc_passwd &#38;&#38; status == 0&#41;
@@ -4932,35 +4972,36 @@
 	    RETVAL
 
 int
-set_tx_max&#40;txn, max&#41;
-        BerkeleyDB::Txn txn
+set_tx_max&#40;env, max&#41;
+        BerkeleyDB::Env env
 	u_int32_t	 max
 	PREINIT:
 	  dMY_CXT;
 	INIT:
-	    ckActive_Transaction&#40;txn-&gt;active&#41; ;
+	    ckActive_Database&#40;env-&gt;active&#41; ;
 	CODE:
 #ifndef AT_LEAST_DB_2_3
 	    softCrash&#40;&#34;$env-&gt;set_tx_max needs Berkeley DB 2_3.x or better&#34;&#41; ;
 #else
-	    RETVAL = txn-&gt;Status = txn-&gt;txn-&gt;set_tx_max&#40;txn-&gt;txn, max&#41;;
+            dieIfEnvOpened&#40;env, &#34;set_tx_max&#34;&#41;;
+	    RETVAL = env-&gt;Status = env-&gt;Env-&gt;set_tx_max&#40;env-&gt;Env, max&#41;;
 #endif
 	OUTPUT:
 	    RETVAL
 
 int
-get_tx_max&#40;txn, max&#41;
-        BerkeleyDB::Txn txn
+get_tx_max&#40;env, max&#41;
+        BerkeleyDB::Env env
 	u_int32_t	 max = NO_INIT
 	PREINIT:
 	  dMY_CXT;
 	INIT:
-	    ckActive_Transaction&#40;txn-&gt;active&#41; ;
+	    ckActive_Database&#40;env-&gt;active&#41; ;
 	CODE:
 #ifndef AT_LEAST_DB_2_3
 	    softCrash&#40;&#34;$env-&gt;get_tx_max needs Berkeley DB 2_3.x or better&#34;&#41; ;
 #else
-	    RETVAL = txn-&gt;Status = txn-&gt;txn-&gt;get_tx_max&#40;txn-&gt;txn, &#38;max&#41;;
+	    RETVAL = env-&gt;Status = env-&gt;Env-&gt;get_tx_max&#40;env-&gt;Env, &#38;max&#41;;
 #endif
 	OUTPUT:
 	    RETVAL
@@ -5415,7 +5456,7 @@
     &#40;void&#41;db_version&#40;&#38;Major, &#38;Minor, &#38;Patch&#41; ;
     /* Check that the versions of db.h and libdb.a are the same */
     if &#40;Major != DB_VERSION_MAJOR || Minor != DB_VERSION_MINOR
-                || Patch != DB_VERSION_PATCH&#41;
+		&#41;
         croak&#40;&#34;\nBerkeleyDB needs compatible versions of libdb &#38; db.h\n\tyou have db.h version %d.%d.%d and libdb version %d.%d.%d\n&#34;,
                 DB_VERSION_MAJOR, DB_VERSION_MINOR, DB_VERSION_PATCH,
                 Major, Minor, Patch&#41; ;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;18:35:43&nbsp;2009</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the patch Michael.

A few minor issues with it - log_set_config needs BDB 4.7 or better and
set_lk_max_lockers,set_lk_max_locks and set_lk_max_objects all need BDB
3.2.9 or better. 

I&#39;ve added pre-processor conditionals to sort that out. After fixing
that BerkeleyDB with your patch included passed my regression run with
all official versions of BDB since 2.6.

Regarding adding extra stuff to BerkeleyDB::Env-&gt;new&#40;&#41; I&#39;ve been
thinking for a while that I really need an alternative interface that
matches the BDB interface more closely. That would make adding new
methods like this *much* easier. 

Finding the time to do that isn&#39;t going to happen soon though.

Paul
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;13&nbsp;18:35:44&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;07&nbsp;08:21:14&nbsp;2010</span>
    <span class="description">pmqs [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">Uploaded fixed version to CPAN (version 0.40) with this change.<br>

<br>

Paul<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;07&nbsp;08:21:15&nbsp;2010</span>
    <span class="description">pmqs [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
