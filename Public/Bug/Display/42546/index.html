<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #42546 for HTTP-Server-Simple: t/04cgi.t  fails test 20-21 on Windows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #42546 for HTTP-Server-Simple: t/04cgi.t  fails test 20-21 on Windows</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/HTTP-Server-Simple/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/HTTP-Server-Simple/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/HTTP-Server-Simple/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/HTTP-Server-Simple/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/HTTP-Server-Simple">HTTP-Server-Simple CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">42546</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/HTTP-Server-Simple/Active/">HTTP-Server-Simple</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
JDB [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-16414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.38    </td>
  </tr>
  <tr id="CF-16415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




04cgi.t<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/589345/298342/04cgi.t">
Thu Apr 09 17:53:13 2009 (4.7k) by BARTL [...] cpan.org
</a>
</font></li>
</ul>


HTTP-Server-Simple-0.38_03patch.diff.gz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/642094/328272/HTTP-Server-Simple-0.38_03patch.diff.gz">
Thu Jul 30 15:39:17 2009 (2.5k) by kmx [...] cpan.org
</a>
</font></li>
</ul>


HTTP-Server-Simple-0.38_03patch.tgz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/645266/330092/HTTP-Server-Simple-0.38_03patch.tgz">
Sat Aug 08 14:57:17 2009 (25.5k) by kmx [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;19&nbsp;19:14:38&nbsp;2009</span>
    <span class="description">JDB [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Happens with both 5.8.9 and 5.10.0:

t/04cgi............ok 17/22
#   Failed test &#39;Didn&#39;t decode already&#39;
#   at t/04cgi.t line 63.
#                   &#39;&#39;
#     doesn&#39;t match &#39;&#40;?-xism:foo%3Fbar&#41;&#39;
t/04cgi............NOK 21/22
#   Failed test &#39;Did decode already&#39;
#   at t/04cgi.t line 68.
#                   &#39;&#39;
#     doesn&#39;t match &#39;&#40;?-xism:foo/bar&#41;&#39;
# Looks like you failed 2 tests of 22.
t/04cgi............dubious
        Test returned status 2 &#40;wstat 512, 0x200&#41;
DIED. FAILED tests 20-21
        Failed 2/22 tests, 90.91% okay
Failed Test Stat Wstat Total Fail  List of Failed
--------------------------------------------------------------
t/04cgi.t      2   512    22    2  20-21
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;20&nbsp;10:13:00&nbsp;2009</span>
    <span class="description">raherh [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I answered the similar problem in ticket #38011. But there was no 
response from the maintainer.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;20&nbsp;10:13:00&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;20&nbsp;11:43:43&nbsp;2009</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 20 Jan 2009 11:43:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Radek via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> jesse &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Radek,

I missed your reply. I&#39;m sorry about that. I&#39;ve queued it for
dealing-with. Please keep prodding me if I don&#39;t deal in the next week
or two.

Best,
Jesse
On Tue, Jan 20, 2009 at 10:13:00AM -0500, Radek via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: HTTP-Server-Simple
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42546">https://rt.cpan.org/Ticket/Display.html?id=42546</a></span> &gt;
&gt; 
&gt; I answered the similar problem in ticket #38011. But there was no 
&gt; response from the maintainer.
&gt; 
</div>
-- 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;09&nbsp;17:53:13&nbsp;2009</span>
    <span class="description">BARTL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I had the same problem and found the cause was errors in the tests.

I could produce a patch, but it&#39;s simpler for me to just attach the
fixed test file...

The problem is on lines 63 and 69, which read: 

       fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;,&#34;&#34;&#41;,

       fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO&#34;,&#34;&#34;&#41;,


while it should have been

       fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar HTTP/1.1&#34;,&#34;&#34;&#41;,

       fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO HTTP/1.1&#34;,&#34;&#34;&#41;,


With this fixed, the tests all pass.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">use Test::More;
use Socket;
use strict;

plan tests =&gt; 22;
my $PORT = 8000 + $$;

my $host = gethostbyaddr&#40;inet_aton&#40;&#39;localhost&#39;&#41;, AF_INET&#41;;

my %methods=&#40;
              url =&gt; &#34;url: http://$host:&#34;.$PORT,
              path_info =&gt; &#39;path_info: /cgitest/path_info&#39;,
              server_name =&gt; &#34;server_name: $host&#34;,
              server_port =&gt; &#39;server_port: &#39;.$PORT,
              server_software =&gt; &#39;server_software: HTTP::Server::Simple/\d+.\d+&#39;,
              request_method =&gt; &#39;request_method: GET&#39;,
            &#41;;

my %envvars=&#40;
              SERVER_URL =&gt; &#34;SERVER_URL: http://$host:&#34;.$PORT.&#39;/&#39;,
              SERVER_PORT =&gt; &#39;SERVER_PORT: &#39;.$PORT,
              REQUEST_METHOD =&gt; &#39;REQUEST_METHOD: GET&#39;,
              REQUEST_URI =&gt; &#39;REQUEST_URI: /cgitest/REQUEST_URI&#39;,
              SERVER_PROTOCOL =&gt; &#39;SERVER_PROTOCOL: HTTP/1.1&#39;,
              SERVER_NAME =&gt; &#34;SERVER_NAME: $host&#34;,
              SERVER_SOFTWARE =&gt; &#39;SERVER_SOFTWARE: HTTP::Server::Simple/\d+.\d+&#39;,
              REMOTE_ADDR =&gt; &#39;REMOTE_ADDR: 127.0.0.1&#39;,
              QUERY_STRING =&gt; &#39;QUERY_STRING: &#39;,
              PATH_INFO =&gt; &#39;PATH_INFO: /cgitest/PATH_INFO&#39;,
            &#41;;

{
  my $server=CGIServer-&gt;new&#40;$PORT&#41;;
  is&#40;$server-&gt;port&#40;&#41;,$PORT,&#39;Constructor set port correctly&#39;&#41;;
  sleep&#40;3&#41;; # wait just a moment

  my $pid=$server-&gt;background;

  like&#40;$pid, &#39;/^-?\d+$/&#39;, &#39;pid is numeric&#39;&#41;;

  select&#40;undef,undef,undef,0.2&#41;; # wait a sec
  like&#40;fetch&#40;&#34;GET / HTTP/1.1&#34;,&#34;&#34;&#41;, &#39;/NOFILE/&#39;, &#39;no file&#39;&#41;;

  foreach my $method &#40;keys&#40;%methods&#41;&#41; {
    like&#40;
          fetch&#40;&#34;GET /cgitest/$method HTTP/1.1&#34;,&#34;&#34;&#41;,
          &#34;/$methods{$method}/&#34;,
          &#34;method - $method&#34;
        &#41;;
    select&#40;undef,undef,undef,0.2&#41;; # wait a sec
  }

  foreach my $envvar &#40;keys&#40;%envvars&#41;&#41; {
    like&#40;
          fetch&#40;&#34;GET /cgitest/$envvar HTTP/1.1&#34;,&#34;&#34;&#41;,
          &#34;/$envvars{$envvar}/&#34;,
          &#34;Environment - $envvar&#34;
        &#41;;
    select&#40;undef,undef,undef,0.2&#41;; # wait a sec
  }

  like&#40;
       fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar HTTP/1.1&#34;,&#34;&#34;&#41;,
       qr/foo%3Fbar/,
       &#34;Didn&#39;t decode already&#34;
      &#41;;

  like&#40;
       fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO HTTP/1.1&#34;,&#34;&#34;&#41;,
       qr|foo/bar|,
       &#34;Did decode already&#34;
      &#41;;


  is&#40;kill&#40;9,$pid&#41;,1,&#39;Signaled 1 process successfully&#39;&#41;;
  wait or die &#34;counldn&#39;t wait for sub-process completion&#34;;
}


sub fetch {

    my @response;
    my $alarm = 0;
    my $stage = &#34;init&#34;;

    my %messages =
	&#40; &#34;init&#34; =&gt; &#34;inner contemplation&#34;,
	  &#34;lookup&#34; =&gt; &#40;&#34;lookup of `localhost&#39; - may be caused by a &#34;
		       .&#34;missing hosts entry or broken resolver&#34;&#41;,
	  &#34;sockaddr&#34; =&gt; &#34;call to sockaddr_in&#40;&#41; - ?&#34;,
	  &#34;proto&#34; =&gt; &#40;&#34;call to getprotobyname&#40;&#41; - may be caused by &#34;
		      .&#34;bizarre NSS configurations&#34;&#41;,
	  &#34;socket&#34; =&gt; &#34;socket creation&#34;,
	  &#34;connect&#34; =&gt; &#40;&#34;connect&#40;&#41; - may be caused by a missing or &#34;
			.&#34;broken loopback interface, or firewalling&#34;&#41;,
	  &#34;send&#34; =&gt; &#34;network send&#40;&#41;&#34;,
	  &#34;recv&#34; =&gt; &#34;collection of response&#34;,
	  &#34;close&#34; =&gt; &#34;closing socket&#34;
	&#41;;

    $SIG{ALRM} = sub {
	@response = &#34;timed out during $messages{$stage}&#34;;
	$alarm = 1;
    };

    my &#40;$iaddr, $paddr, $proto, $message&#41;;

    $message = join &#34;&#34;, map { &#34;$_\015\012&#34; } @_;

    my %states =
	&#40; &#39;init&#39;     =&gt; sub { &#34;lookup&#34;; },
	  &#34;lookup&#34;   =&gt; sub { &#40;$iaddr = inet_aton&#40;&#34;localhost&#34;&#41;&#41;
				  &#38;&#38; &#34;sockaddr&#34;			    },
	  &#34;sockaddr&#34; =&gt; sub { &#40;$paddr = sockaddr_in&#40;$PORT, $iaddr&#41;&#41;
				  &#38;&#38; &#34;proto&#34;			    },
	  &#34;proto&#34;    =&gt; sub { &#40;$proto = getprotobyname&#40;&#39;tcp&#39;&#41;&#41;
				  &#38;&#38; &#34;socket&#34;			    },
	  &#34;socket&#34;   =&gt; sub { socket&#40;SOCK, PF_INET, SOCK_STREAM, $proto&#41;
				  &#38;&#38; &#34;connect&#34;			    },
	  &#34;connect&#34;  =&gt; sub { connect&#40;SOCK, $paddr&#41; &#38;&#38; &#34;send&#34;	    },
	  &#34;send&#34;     =&gt; sub { &#40;send SOCK, $message, 0&#41; &#38;&#38; &#34;recv&#34;    },
	  &#34;recv&#34;     =&gt; sub {
	      my $line;
	      while &#40;!$alarm and defined&#40;$line = &lt;SOCK&gt;&#41;&#41; {
		  push @response, $line;
	      }
	      &#40;$alarm ? undef : &#34;close&#34;&#41;;
	  },
	  &#34;close&#34;    =&gt; sub { close SOCK; &#34;done&#34;; },
	&#41;;

    # this entire cycle should finish way before this timer expires
    alarm&#40;5&#41;;

    my $next;
    $stage = $next
	while &#40;!$alarm &#38;&#38; $stage ne &#34;done&#34;
	       &#38;&#38; &#40;$next = $states{$stage}-&gt;&#40;&#41;&#41;&#41;;

    warn &#34;early exit from `$stage&#39; stage; $!&#34; unless $next;

    # bank on the test testing for something in the response.
    return join &#34;&#34;, @response;


}

{
  package CGIServer;
  use base qw&#40;HTTP::Server::Simple::CGI&#41;;
  use Env;

  sub handle_request {
    my $self=shift;
    my $cgi=shift;


    my $file=&#40;split&#40;&#39;/&#39;,$cgi-&gt;path_info&#41;&#41;[-1]||&#39;NOFILE&#39;;
    $file=~s/\s+//g;
    $file||=&#39;NOFILE&#39;;
    print &#34;HTTP/1.0 200 OK\r\n&#34;;    # probably OK by now
    print &#34;Content-Type: text/html\r\nContent-Length: &#34;;
    my $response;
    if&#40;$methods{$file}&#41; {
      $response = &#34;$file: &#34;.$cgi-&gt;$file&#40;&#41;;
    } elsif&#40;$envvars{$file}&#41; {
      $response=&#34;$file: $ENV{$file}&#34;;
    } else {
      $response=$file;
    }
    print length&#40;$response&#41;, &#34;\r\n\r\n&#34;, $response;
  }
}

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;09&nbsp;19:16:58&nbsp;2009</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 9 Apr 2009 19:16:47 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> BARTL via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bart,

Can you explain the _why_ of the change? HSS isn&#39;t an HTTP/1.1 server -
it should work just fine with 0.9 or 1.0 requests.


On Thu  9.Apr&#39;09 at 17:53:14 -0400, BARTL via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: HTTP-Server-Simple
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42546">https://rt.cpan.org/Ticket/Display.html?id=42546</a></span> &gt;
&gt; 
&gt; I had the same problem and found the cause was errors in the tests.
&gt; 
&gt; I could produce a patch, but it&#39;s simpler for me to just attach the
&gt; fixed test file...
&gt; 
&gt; The problem is on lines 63 and 69, which read: 
&gt; 
&gt;        fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;,&#34;&#34;&#41;,
&gt; 
&gt;        fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO&#34;,&#34;&#34;&#41;,
&gt; 
&gt; 
&gt; while it should have been
&gt; 
&gt;        fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar HTTP/1.1&#34;,&#34;&#34;&#41;,
&gt; 
&gt;        fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO HTTP/1.1&#34;,&#34;&#34;&#41;,
&gt; 
&gt; 
&gt; With this fixed, the tests all pass.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Apr&nbsp;11&nbsp;05:15:40&nbsp;2009</span>
    <span class="description">raherh [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> jesse [...] fsck.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Apr 09 19:16:58 2009, jesse@fsck.com wrote:

Why not to change tests as I described Jan 05 in a ticket #38011?

Copied from the ticket correspondence:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________

When fetching with 0.9 protocol the line should read:

fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;&#41;, not

fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;,&#34;&#34;&#41; and

the same for:
fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO&#34;&#41;.

The second parameter is intended for optional entity-body with http 1.0 
and should be missing for http 0.9.
The message is being composed like this:
$message = join &#34;&#34;, map { &#34;$_\015\012&#34; } @_;
So there&#39;s another obligatory crlf for http 1.0.
<div class="message-stanza open">________________________________________

Radek
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;07&nbsp;02:27:04&nbsp;2009</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 07 May 2009 08:26:40 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-HTTP-Server-Simple [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I agree with Radek - the following simple patch to 04cgi.t will solve it:

...
  like&#40;
-       fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;,&#34;&#34;&#41;,
+       fetch&#40;&#34;GET /cgitest/REQUEST_URI?foo%3Fbar&#34;&#41;,
       qr/foo%3Fbar/,
       &#34;Didn&#39;t decode already&#34;
      &#41;;

  like&#40;
-       fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO&#34;,&#34;&#34;&#41;,
+       fetch&#40;&#34;GET /cgitest/foo%2Fbar/PATH_INFO&#34;&#41;,
       qr|foo/bar|,
       &#34;Did decode already&#34;
      &#41;;
...

Tested with HTTP-Server-Simple-0.38 + strawberry perl 5.10.0 &#40;all tests
passed&#41;.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;27&nbsp;16:09:30&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Could you please consider applying the simple patch to 04cgi.t from
previous post of this RT?

I does not harm anything and according my tests &#40;current stable v0.38 +
the mentioned patch&#41; on win32 strawberry perl 5.8.9 and 5.10.0 it makes
this module installable on win32 without failing tests.

I can prepare for you a PAUSE-ready-to-upload tar.gz archive with this
patch applied or help in other way. 

Thanks.

--
kmx

P.S. IMPORTANT NOTICE: latest dev release 0.38_03 does not do well on
Win32 &#40;tests hang up&#41;; therefore I recommend reverting back to 0.38
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;28&nbsp;16:00:36&nbsp;2009</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 28 Jul 2009 15:59:37 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> K MX via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please test 0.38_03, now on its way to cpan. thanks.


On Mon 27.Jul&#39;09 at 16:09:31 -0400, K MX via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: HTTP-Server-Simple
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42546">https://rt.cpan.org/Ticket/Display.html?id=42546</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; Could you please consider applying the simple patch to 04cgi.t from
&gt; previous post of this RT?
&gt; 
&gt; I does not harm anything and according my tests &#40;current stable v0.38 +
&gt; the mentioned patch&#41; on win32 strawberry perl 5.8.9 and 5.10.0 it makes
&gt; this module installable on win32 without failing tests.
&gt; 
&gt; I can prepare for you a PAUSE-ready-to-upload tar.gz archive with this
&gt; patch applied or help in other way. 
&gt; 
&gt; Thanks.
&gt; 
&gt; --
&gt; kmx
&gt; 
&gt; P.S. IMPORTANT NOTICE: latest dev release 0.38_03 does not do well on
&gt; Win32 &#40;tests hang up&#41;; therefore I recommend reverting back to 0.38
&gt; 
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/641149/327656/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 194b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;29&nbsp;02:02:14&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please test 0.38_03, now on its way to cpan. thanks.
</div>
0.38_03 does not work well for me neither on win32 straberry perl 5.8.9
nor on 5.10.0 - 01live.t hangs up

please do not release it yet, I will try to investigate further details

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;30&nbsp;15:39:17&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I am back with my further analysis of Win32 issues.

1&#41; Changes in background&#40;&#41; introduced in 0.38_02/03

The implementation on background &#40;the hack with temporary filehandle,
sleeping etc.&#41; simply hangs up on Win32. Firstly it uses some tricks
that does not work on windows &#40;like unlinking an open filehandle&#41;, next
it tries to implement a sort of interprocess communication in a very
unusual way - IPC was invented for this purpose and finally I I am not
sure if we really need to wait till the child starts listening &#40;yes, it
might be a little trouble during tests where we want to connect to
server immediately after calling background&#40;&#41; but in a real program it
will not happen so often&#41;.

To sum up: I ask you to revert this changes.

The minor change I propose in background&#40;&#41; is to add &#34;exit&#34; after &#34;run&#34;
- I know that run should never return, it is just to be sure.

2&#41; fetch&#40;&#41; function in 04cgi.t 01live.t

The problem of these tests on Win32 was fetch&#40;&#41; function using some
SIGALRM stuff that works differently on UNIX and Windows. Generally it
is good to know that on Win32 there are no native signals and perl on
Win32 has just a sort of emulation &#40;not all but just 4 basic trappable
signals are emulated&#41;. SIGALRM is somehow emulated on Win32 but keep in
mind, that the implementation is just on a perl level therefore for
example using blocking tcp socket waiting for data somewhere in Windows
kernel syscall cannot be interrupted by perl&#39;s $SIG{ALRM} trap.

To solve this issue I have reimplemented fetch&#40;&#41; function in 01live.t
and 04cgi.t &#40;it is not nice to duplicate the same function on two
places; however I did not want to make too big changes&#41;. The new
implementation uses non-blocking socket + select call for handling
timeout; I have tried to keep a detailed diagnostics as in your previous
version.

Together with a little patch discussed in RT #48249 I put all changes to
enclosed patch &#40;it is against 0.38_03&#41;. For me it works on
- win32/strawberry 5.8.9 and 5.10.0
- win32/cygwin 5.10.0

I propose:
1&#41; apply this patch and release a a new dev release 0.38_04
2&#41; we can ask all people submitting Win32-related RTs to test it
3&#41; then it will be probably ready for release

The only open question remains about whether we really need the
background&#40;&#41; to guarantee that when it returns the child is ready to
accept request. I guess not, but if otherwise I would prefer some Win32
compliant way.

--
kmx
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/642094/328272/HTTP-Server-Simple-0.38_03patch.diff.gz">Download HTTP-Server-Simple-0.38_03patch.diff.gz</a><br />
<span class="downloadcontenttype">application/x-gzip 2.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;03&nbsp;10:40:27&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> jesse [...] fsck.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jesse,

do you have any feedback to my previous post with patch proposal?

Thanks.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;03&nbsp;11:27:55&nbsp;2009</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 3 Aug 2009 16:27:50 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> kmx via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, I&#39;ve been traveling to YAPC EU and have been crazy busy. I&#39;m
hoping to get to look at it this week.

-j


On Mon  3.Aug&#39;09 at 10:40:29 -0400, kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42546">https://rt.cpan.org/Ticket/Display.html?id=42546</a></span> &gt;
&gt; 
&gt; Hi Jesse,
&gt; 
&gt; do you have any feedback to my previous post with patch proposal?
&gt; 
&gt; Thanks.
&gt; 
&gt; --
&gt; kmx
&gt; 
</div></div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/643244/328962/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 194b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;08&nbsp;11:25:46&nbsp;2009</span>
    <span class="description">jesse [...] fsck.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #42546] t/04cgi.t  fails test 20-21 on Windows</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 8 Aug 2009 16:25:35 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> kmx via RT &lt;bug-HTTP-Server-Simple [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jesse Vincent &lt;jesse [...] fsck.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch isn&#39;t applying on my 0.38_03 sources. Is there a chance it
was generated unproperly?


On Thu 30.Jul&#39;09 at 15:39:18 -0400, kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: HTTP-Server-Simple
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=42546">https://rt.cpan.org/Ticket/Display.html?id=42546</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; I am back with my further analysis of Win32 issues.
&gt; 
&gt; 1&#41; Changes in background&#40;&#41; introduced in 0.38_02/03
&gt; 
&gt; The implementation on background &#40;the hack with temporary filehandle,
&gt; sleeping etc.&#41; simply hangs up on Win32. Firstly it uses some tricks
&gt; that does not work on windows &#40;like unlinking an open filehandle&#41;, next
&gt; it tries to implement a sort of interprocess communication in a very
&gt; unusual way - IPC was invented for this purpose and finally I I am not
&gt; sure if we really need to wait till the child starts listening &#40;yes, it
&gt; might be a little trouble during tests where we want to connect to
&gt; server immediately after calling background&#40;&#41; but in a real program it
&gt; will not happen so often&#41;.
&gt; 
&gt; To sum up: I ask you to revert this changes.
&gt; 
&gt; The minor change I propose in background&#40;&#41; is to add &#34;exit&#34; after &#34;run&#34;
&gt; - I know that run should never return, it is just to be sure.
&gt; 
&gt; 2&#41; fetch&#40;&#41; function in 04cgi.t 01live.t
&gt; 
&gt; The problem of these tests on Win32 was fetch&#40;&#41; function using some
&gt; SIGALRM stuff that works differently on UNIX and Windows. Generally it
&gt; is good to know that on Win32 there are no native signals and perl on
&gt; Win32 has just a sort of emulation &#40;not all but just 4 basic trappable
&gt; signals are emulated&#41;. SIGALRM is somehow emulated on Win32 but keep in
&gt; mind, that the implementation is just on a perl level therefore for
&gt; example using blocking tcp socket waiting for data somewhere in Windows
&gt; kernel syscall cannot be interrupted by perl&#39;s $SIG{ALRM} trap.
&gt; 
&gt; To solve this issue I have reimplemented fetch&#40;&#41; function in 01live.t
&gt; and 04cgi.t &#40;it is not nice to duplicate the same function on two
&gt; places; however I did not want to make too big changes&#41;. The new
&gt; implementation uses non-blocking socket + select call for handling
&gt; timeout; I have tried to keep a detailed diagnostics as in your previous
&gt; version.
&gt; 
&gt; Together with a little patch discussed in RT #48249 I put all changes to
&gt; enclosed patch &#40;it is against 0.38_03&#41;. For me it works on
&gt; - win32/strawberry 5.8.9 and 5.10.0
&gt; - win32/cygwin 5.10.0
&gt; 
&gt; I propose:
&gt; 1&#41; apply this patch and release a a new dev release 0.38_04
&gt; 2&#41; we can ask all people submitting Win32-related RTs to test it
&gt; 3&#41; then it will be probably ready for release
&gt; 
&gt; The only open question remains about whether we really need the
&gt; background&#40;&#41; to guarantee that when it returns the child is ready to
&gt; accept request. I guess not, but if otherwise I would prefer some Win32
&gt; compliant way.
&gt; 
&gt; --
&gt; kmx
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;08&nbsp;14:53:34&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This patch isn&#39;t applying on my 0.38_03 sources. Is there a chance it
&gt; was generated unproperly?
</div>
I have used as a baseline this archive
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/CPAN/authors/id/J/JE/JESSE/HTTP-Server-Simple-0.38_03.tar.gz">http://search.cpan.org/CPAN/authors/id/J/JE/JESSE/HTTP-Server-Simple-0.38_03.tar.gz</a></span>

let us have decompressed targz in:
.../workdir/HTTP-Server-Simple-0.38_03/...
let us have the diff:
.../workdir/HTTP-Server-Simple-0.38_03patch.diff

for me works this:
.../workdir/HTTP-Server-Simple-0.38_03&gt; patch  -p 1 -i
..\HTTP-Server-Simple-0.38_03patch.diff
patching file lib/HTTP/Server/Simple.pm
patching file t/01live.t
patching file t/04cgi.t

Note: my diff file has CRLF as a newlines

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;08&nbsp;14:57:17&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching the whole patched module targz.

--
kmx
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/645266/330092/HTTP-Server-Simple-0.38_03patch.tgz">Download HTTP-Server-Simple-0.38_03patch.tgz</a><br />
<span class="downloadcontenttype">application/x-compressed 25.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Aug&nbsp;13&nbsp;06:08:49&nbsp;2009</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Jesse,

the currently released devel version HTTP-Server-Simple-0.38_04 installs
fine &#40;no failing tests&#41; on Win32/strawberry perl - I have tested both
5.8.9 and 5.10.0

Thanks

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;17&nbsp;05:19:41&nbsp;2009</span>
    <span class="description">dolmen [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Sam. Aoû. 08 14:53:34 2009, KMX a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Note: my diff file has CRLF as a newlines
</div>
This should be avoided. 

I&#39;m using &#39;makepatch&#39; &#40;CPAN distrib JV/makepatch-2.04.tar.gz&#41; to create
patches for CPAN distribs on Win32.

Here are some tips to make it work on Win32:
* put GNUWin32 patch.exe and diff.exe in your %PATH%.
* my %HOME%\.makepatchrc:
   -diff &#34;diff -urp --binary&#34;
* my %HOME%\.applypatchrc:
   -patch &#34;patch -p0 -N --binary&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;02&nbsp;11:06:04&nbsp;2015</span>
    <span class="description">cpan [...] jibsheet.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
