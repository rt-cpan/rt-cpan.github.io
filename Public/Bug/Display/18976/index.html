<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18976 for DBD-mysql: Negative values for SQL_INTEGER rejected by bind_param&#40;&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18976 for DBD-mysql: Negative values for SQL_INTEGER rejected by bind_param&#40;&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-mysql">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-mysql">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-mysql">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-mysql">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-mysql">DBD-mysql CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18976</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-mysql">DBD-mysql</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">CAPTTOFU [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MSCHILLI [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10170-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.0002_5    </td>
  </tr>
  <tr id="CF-10171-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




patch.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/190944/69158/patch.txt">
Fri Apr 28 18:33:37 2006 (4.5k) by MSCHILLI [...] cpan.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/190918/69132/patch.txt">
Fri Apr 28 17:26:42 2006 (4.1k) by MSCHILLI [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=18976">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-190918" href="/Public/Bug/Display.html?id=18976#txn-190918">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;28&nbsp;17:26:42&nbsp;2006</span>
    <span class="description">MSCHILLI [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Negative values for SQL_INTEGER rejected by bind_param&#40;&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/190918/69129/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69129">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 804b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi DBD::mysql maintainers,

the latest DBD::mysql on CPAN, 3.0002_5, has the following problem: 

If you specify a negative integer on a column marked as SQL_INTEGER, as in 

    $sth-&gt;bind_param&#40;1,undef,SQL_INTEGER&#41;;
    $sth-&gt;execute&#40;-1&#41; or die $DBI::errstr;

then the integer doesn&#39;t make it into the resulting SQL, resulting in a
syntax error. It works fine for positive integers. Negative integers
used to work in the 2.9008 series, and stopped working in 3.2.x.

Reason is that dbdimp.c only accepts digits as numbers ignoring minus
signs &#40;-&#41; and floating points &#40;.&#41;.

I&#39;ve attached a patch that puts the number parser, employing some of the
logic of a previous patch by dragonchild, into a subroutine. 

I&#39;ve also added a test case.

Would be great if you could apply it. Thanks!

-- Mike Schilli
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/190918/69132/patch.txt">Download patch.txt</a><br />
<span class="downloadcontenttype">text/plain 4.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -Naur DBD-mysql-3.0002_5/dbdimp.c DBD-mysql-3.0002_5.patched/dbdimp.c
--- DBD-mysql-3.0002_5/dbdimp.c	Wed Feb  1 14:49:02 2006
+++ DBD-mysql-3.0002_5.patched/dbdimp.c	Fri Apr 28 13:30:49 2006
@@ -418,9 +418,10 @@
                           bool bind_type_guessing&#41;
 {
 
-  bool seen_neg, seen_dec;
+  int rc;
   char *salloc, *statement_ptr;
   char *statement_ptr_end, testchar, *ptr, *valbuf;
+  char *cp, *end;
   int alen, i, j;
   int slen= *slen_ptr;
   int limit_flag= 0;
@@ -467,40 +468,9 @@
           valbuf= SvPV&#40;ph-&gt;value, vallen&#41;;
           ph-&gt;type= SQL_INTEGER;
 
-          /* patch from Dragonchild */
-          seen_neg= 0;
-          seen_dec= 0;
-          for &#40;j= 0; j &lt; &#40;int&#41;vallen; ++j&#41;
+          if&#40;parse_number&#40;valbuf, vallen, &#38;end&#41; != 0&#41;
           {
-            testchar= *&#40;valbuf+j&#41;;
-            if &#40;&#39;-&#39; == testchar&#41;
-            {
-              if &#40;seen_neg&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              else if &#40;j&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              seen_neg= 1;
-            }
-            else if &#40;&#39;.&#39; == testchar&#41;
-            {
-              if &#40;seen_dec&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              seen_dec= 1;
-            }
-            else if &#40;!isdigit&#40;testchar&#41;&#41;
-            {
               ph-&gt;type= SQL_VARCHAR;
-              break;
-            }
           }
         }
         else if &#40;bind_type_guessing&#41;
@@ -616,13 +586,9 @@
             }
             else
             {
-              while &#40;vallen--&#41;
-              {
-		c = *valbuf++;
-		if &#40;&#40;c &lt; &#39;0&#39; || c &gt; &#39;9&#39;&#41; &#38;&#38; c != &#39; &#39;&#41;
-		  break;
-		*ptr++= c;
-              }
+              parse_number&#40;valbuf, vallen, &#38;end&#41;;
+              for&#40;cp = valbuf; cp &lt; end; cp++&#41;
+                  *ptr++ = *cp;
             }
           }
         }
@@ -4277,3 +4243,61 @@
   return sv_2mortal&#40;my_ulonglong2str&#40;mysql_insert_id&#40;&#38;&#40;&#40;imp_dbh_t*&#41;imp_dbh&#41;-&gt;mysql&#41;&#41;&#41;;
 }
 #endif
+
+int parse_number&#40;
+    char    *string,
+    STRLEN   len,
+    char   **end
+&#41; {
+    int seen_neg;
+    int seen_dec;
+    char *cp;
+
+    seen_neg= 0;
+    seen_dec= 0;
+
+    if&#40;len &lt;= 0&#41; {
+        len = strlen&#40;string&#41;;
+    }
+
+    cp = string;
+    
+    for&#40;cp = string; *cp; cp++&#41; 
+    {
+        if &#40;&#39;-&#39; == *cp&#41;
+        {   
+            if &#40;seen_neg&#41;
+             {
+                /* second &#39;-&#39; */
+                break;
+              }
+              else if &#40;cp &gt; string&#41;
+              {
+                /* &#39;-&#39; after digit&#40;s&#41; */
+                break;
+              }
+              seen_neg= 1;
+        }
+        else if &#40;&#39;.&#39; == *cp&#41;
+        {
+            if &#40;seen_dec&#41;
+            {
+                /* second &#39;.&#39; */
+                break;
+            }
+            seen_dec= 1;
+        }
+        else if &#40;!isdigit&#40;*cp&#41;&#41;
+        {
+            break;
+        }
+    }
+
+    *end = cp;
+
+    if&#40;cp - string &lt; len&#41; {
+        return -1;
+    }
+
+    return 0;
+}
diff -Naur DBD-mysql-3.0002_5/t/40bindparam.t DBD-mysql-3.0002_5.patched/t/40bindparam.t
--- DBD-mysql-3.0002_5/t/40bindparam.t	Wed Feb  1 10:52:23 2006
+++ DBD-mysql-3.0002_5.patched/t/40bindparam.t	Fri Apr 28 13:32:50 2006
@@ -130,6 +130,14 @@
 	    or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
     }
 
+    # Testing bugfix for negative integers
+    Test&#40;$state or $cursor-&gt;bind_param&#40;1, undef, SQL_INTEGER&#40;&#41;&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+    Test&#40;$state or $cursor-&gt;bind_param&#40;2, undef&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+    Test&#40;$state or $cursor-&gt;execute&#40;-1, &#34;abc&#34;&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+
     Test&#40;$state or undef $cursor  ||  1&#41;;
 
     #
@@ -144,6 +152,11 @@
 
     Test&#40;$state or $cursor-&gt;bind_columns&#40;undef, \$id, \$name&#41;&#41;
 	   or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+
+    Test&#40;$state or &#40;$ref = $cursor-&gt;fetch&#41;  &#38;&#38;  $id == -1  &#38;&#38;
+	 $name eq &#39;abc&#39;&#41;
+	or printf&#40;&#34;Query returned id = %s, name = %s, ref = %s, %d\n&#34;,
+		  $id, $name, $ref, scalar&#40;@$ref&#41;&#41;;
 
     Test&#40;$state or &#40;$ref = $cursor-&gt;fetch&#41;  &#38;&#38;  $id == 1  &#38;&#38;
 	 $name eq &#39;Alligator Descartes&#39;&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-190944" href="/Public/Bug/Display.html?id=18976#txn-190944">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;28&nbsp;18:33:37&nbsp;2006</span>
    <span class="description">MSCHILLI [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/190944/69155/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/69155">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 196b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Apr 28 17:26:42 2006, MSCHILLI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve also added a test case.
</div>
Just found that my previous patch didn&#39;t allow for leading whitespace.
Fixed, new patched attached.

-- Mike Schilli
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/190944/69158/patch.txt">Download patch.txt</a><br />
<span class="downloadcontenttype">text/plain 4.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- dbdimp.c	Wed Feb  1 14:49:02 2006
+++ /dbdimp.c	Fri Apr 28 15:24:32 2006
@@ -25,8 +25,6 @@
 typedef short WORD;
 #endif
 
-
-
 DBISTATE_DECLARE;
 
 typedef struct sql_type_info_s
@@ -418,9 +416,10 @@
                           bool bind_type_guessing&#41;
 {
 
-  bool seen_neg, seen_dec;
+  int rc;
   char *salloc, *statement_ptr;
   char *statement_ptr_end, testchar, *ptr, *valbuf;
+  char *cp, *end;
   int alen, i, j;
   int slen= *slen_ptr;
   int limit_flag= 0;
@@ -467,40 +466,9 @@
           valbuf= SvPV&#40;ph-&gt;value, vallen&#41;;
           ph-&gt;type= SQL_INTEGER;
 
-          /* patch from Dragonchild */
-          seen_neg= 0;
-          seen_dec= 0;
-          for &#40;j= 0; j &lt; &#40;int&#41;vallen; ++j&#41;
+          if&#40;parse_number&#40;valbuf, vallen, &#38;end&#41; != 0&#41;
           {
-            testchar= *&#40;valbuf+j&#41;;
-            if &#40;&#39;-&#39; == testchar&#41;
-            {
-              if &#40;seen_neg&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              else if &#40;j&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              seen_neg= 1;
-            }
-            else if &#40;&#39;.&#39; == testchar&#41;
-            {
-              if &#40;seen_dec&#41;
-              {
-                ph-&gt;type= SQL_VARCHAR;
-                break;
-              }
-              seen_dec= 1;
-            }
-            else if &#40;!isdigit&#40;testchar&#41;&#41;
-            {
               ph-&gt;type= SQL_VARCHAR;
-              break;
-            }
           }
         }
         else if &#40;bind_type_guessing&#41;
@@ -616,13 +584,9 @@
             }
             else
             {
-              while &#40;vallen--&#41;
-              {
-		c = *valbuf++;
-		if &#40;&#40;c &lt; &#39;0&#39; || c &gt; &#39;9&#39;&#41; &#38;&#38; c != &#39; &#39;&#41;
-		  break;
-		*ptr++= c;
-              }
+              parse_number&#40;valbuf, vallen, &#38;end&#41;;
+              for&#40;cp = valbuf; cp &lt; end; cp++&#41;
+                  *ptr++ = *cp;
             }
           }
         }
@@ -2520,6 +2484,7 @@
 {
   D_imp_dbh_from_sth;
 
+  int num_fields;
   int use_mysql_use_result=imp_sth-&gt;use_mysql_use_result;
   int next_result_return_code, i;
   MYSQL_RES** result= &#38;imp_sth-&gt;result;
@@ -2620,7 +2585,7 @@
 
     /** Store the result in the current statement handle */
     DBIc_ACTIVE_on&#40;imp_sth&#41;;
-    int num_fields=mysql_num_fields&#40;imp_sth-&gt;result&#41;;
+    num_fields=mysql_num_fields&#40;imp_sth-&gt;result&#41;;
 
     DBIc_NUM_FIELDS&#40;imp_sth&#41; = num_fields;
 
@@ -4277,3 +4242,65 @@
   return sv_2mortal&#40;my_ulonglong2str&#40;mysql_insert_id&#40;&#38;&#40;&#40;imp_dbh_t*&#41;imp_dbh&#41;-&gt;mysql&#41;&#41;&#41;;
 }
 #endif
+
+int parse_number&#40;
+    char    *string,
+    STRLEN   len,
+    char   **end
+&#41; {
+    int seen_neg;
+    int seen_dec;
+    char *cp;
+
+    seen_neg= 0;
+    seen_dec= 0;
+
+    if&#40;len &lt;= 0&#41; {
+        len = strlen&#40;string&#41;;
+    }
+
+    cp = string;
+
+        /* Skip leading whitespace */
+    while&#40;*cp &#38;&#38; isspace&#40;*cp&#41;&#41;
+        cp++;
+
+    for&#40;; *cp; cp++&#41; 
+    {
+        if &#40;&#39;-&#39; == *cp&#41;
+        {   
+            if &#40;seen_neg&#41;
+             {
+                /* second &#39;-&#39; */
+                break;
+              }
+              else if &#40;cp &gt; string&#41;
+              {
+                /* &#39;-&#39; after digit&#40;s&#41; */
+                break;
+              }
+              seen_neg= 1;
+        }
+        else if &#40;&#39;.&#39; == *cp&#41;
+        {
+            if &#40;seen_dec&#41;
+            {
+                /* second &#39;.&#39; */
+                break;
+            }
+            seen_dec= 1;
+        }
+        else if &#40;!isdigit&#40;*cp&#41;&#41;
+        {
+            break;
+        }
+    }
+
+    *end = cp;
+
+    if&#40;cp - string &lt; len&#41; {
+        return -1;
+    }
+
+    return 0;
+}
--- t/40bindparam.t	Wed Feb  1 10:52:23 2006
+++ t/40bindparam.t	Fri Apr 28 14:30:05 2006
@@ -130,6 +130,14 @@
 	    or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
     }
 
+    # Testing bugfix for negative integers
+    Test&#40;$state or $cursor-&gt;bind_param&#40;1, undef, SQL_INTEGER&#40;&#41;&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+    Test&#40;$state or $cursor-&gt;bind_param&#40;2, undef&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+    Test&#40;$state or $cursor-&gt;execute&#40;-1, &#34;abc&#34;&#41;&#41;
+       or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+
     Test&#40;$state or undef $cursor  ||  1&#41;;
 
     #
@@ -144,6 +152,11 @@
 
     Test&#40;$state or $cursor-&gt;bind_columns&#40;undef, \$id, \$name&#41;&#41;
 	   or DbiError&#40;$dbh-&gt;err, $dbh-&gt;errstr&#41;;
+
+    Test&#40;$state or &#40;$ref = $cursor-&gt;fetch&#41;  &#38;&#38;  $id == -1  &#38;&#38;
+	 $name eq &#39;abc&#39;&#41;
+	or printf&#40;&#34;Query returned id = %s, name = %s, ref = %s, %d\n&#34;,
+		  $id, $name, $ref, scalar&#40;@$ref&#41;&#41;;
 
     Test&#40;$state or &#40;$ref = $cursor-&gt;fetch&#41;  &#38;&#38;  $id == 1  &#38;&#38;
 	 $name eq &#39;Alligator Descartes&#39;&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-190946" href="/Public/Bug/Display.html?id=18976#txn-190946">#</a>      
    </span>
    <span class="date">Fri&nbsp;Apr&nbsp;28&nbsp;18:33:40&nbsp;2006</span>
    <span class="description">MSCHILLI [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-210738" href="/Public/Bug/Display.html?id=18976#txn-210738">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;19&nbsp;13:52:24&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Brad Lanam &lt;bll [...] gentoo.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/210738/82284/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/82284">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 44b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I also have this bug in DBD-mysql-3.0006.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-241419" href="/Public/Bug/Display.html?id=18976#txn-241419">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;15&nbsp;14:28:36&nbsp;2006</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/241419/102469/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/102469">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 83b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry I missed this great patch - I will put this in my queue for 3.0008
next week.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-241422" href="/Public/Bug/Display.html?id=18976#txn-241422">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;15&nbsp;14:29:10&nbsp;2006</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-279488" href="/Public/Bug/Display.html?id=18976#txn-279488">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;28&nbsp;16:37:20&nbsp;2006</span>
    <span class="description">jimw-removetoemail [...] trainedmonkey.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/279488/125019/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/125019">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 136b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This fix has been applied to the DBD::mysql repository, and will be included in the next release 
&#40;probably 4.01&#41;. Thanks for the patch!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-279491" href="/Public/Bug/Display.html?id=18976#txn-279491">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;28&nbsp;16:37:22&nbsp;2006</span>
    <span class="description">jimw-removetoemail [...] trainedmonkey.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-281212" href="/Public/Bug/Display.html?id=18976#txn-281212">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;04&nbsp;20:07:23&nbsp;2007</span>
    <span class="description">m [...] perlmeister.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> MSCHILLI [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #18976] Negative values for SQL_INTEGER rejected by bind_param&#40;&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 4 Jan 2007 17:06:56 -0800 &#40;PST&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Jim Winstead via RT &lt;bug-DBD-mysql [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike Schilli &lt;m [...] perlmeister.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/281212/126029/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/126029">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 246b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu, 28 Dec 2006, Jim Winstead via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This fix has been applied to the DBD::mysql repository, and will be
&gt; included in the next release &#40;probably 4.01&#41;. Thanks for the patch!
</div>
Sweet, thanks!

-- Mike

Mike Schilli
m@perlmeister.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-281213" href="/Public/Bug/Display.html?id=18976#txn-281213">#</a>      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;04&nbsp;20:07:25&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-281549" href="/Public/Bug/Display.html?id=18976#txn-281549">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;06&nbsp;12:08:08&nbsp;2007</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/281549/126224/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/126224">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 44b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch has been in the code since 3.0004
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-281552" href="/Public/Bug/Display.html?id=18976#txn-281552">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;06&nbsp;12:08:09&nbsp;2007</span>
    <span class="description">CAPTTOFU [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.633179</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
