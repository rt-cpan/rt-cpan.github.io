<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118806 for Tangence: t/10message.t passes only with perl 5.22.x</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118806 for Tangence: t/10message.t passes only with perl 5.22.x</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Tangence/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Tangence/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Tangence/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Tangence/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Tangence">Tangence CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118806</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Tangence/Active/">Tangence</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-232358-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.22    </td>
  </tr>
  <tr id="CF-232359-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.23    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;02:18:03&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> t/10message.t passes only with perl 5.22.x</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">t/10message.t passes only with perl 5.22.x and fails for older or newer perls, see <span class="clickylink"><a target="new" rel="nofollow" href="http://fast-matrix.cpantesters.org/?dist=Tangence%200.22">http://fast-matrix.cpantesters.org/?dist=Tangence%200.22</a></span>

Test log output with 5.20.x:

#   Failed test &#39;$type-&gt;unpack_value float16 NaN&#39;
#   at t/10message.t line 220.
#          got: &#39;nan&#39;
#     expected: &#39;NaN&#39;

#   Failed test &#39;$type-&gt;unpack_value float16 oversize&#39;
#   at t/10message.t line 220.
#          got: &#39;inf&#39;
#     expected: &#39;Inf&#39;

#   Failed test &#39;$type-&gt;unpack_value float32 NaN&#39;
#   at t/10message.t line 220.
#          got: &#39;nan&#39;
#     expected: &#39;NaN&#39;

#   Failed test &#39;$type-&gt;unpack_value float64 NaN&#39;
#   at t/10message.t line 220.
#          got: &#39;nan&#39;
#     expected: &#39;NaN&#39;
# Looks like you failed 4 tests of 216.
t/10message.t .......... 
Dubious, test returned 4 &#40;wstat 1024, 0x400&#41;
Failed 4/216 subtests 


Test log output with perl 5.25.6 &#40;freebsd 10&#41;:

#   Failed test &#39;pack typed float16 NaN&#39;
#   at t/10message.t line 205.
#   at bytes 0-0xf &#40;0-15&#41;
#   got: | 10 fe 00 .. .. .. .. .. .. .. .. .. .. .. .. .. |...             |
#   exp: | 10 7e 00 .. .. .. .. .. .. .. .. .. .. .. .. .. |.~.             |

#   Failed test &#39;pack typed float32 NaN&#39;
#   at t/10message.t line 205.
#   at bytes 0-0xf &#40;0-15&#41;
#   got: | 11 ff c0 00 00 .. .. .. .. .. .. .. .. .. .. .. |.....           |
#   exp: | 11 7f c0 00 00 .. .. .. .. .. .. .. .. .. .. .. |.....           |

#   Failed test &#39;pack typed float64 NaN&#39;
#   at t/10message.t line 205.
#   at bytes 0-0xf &#40;0-15&#41;
#   got: | 12 ff f8 00 00 00 00 00 00 .. .. .. .. .. .. .. |.........       |
#   exp: | 12 7f f8 00 00 00 00 00 00 .. .. .. .. .. .. .. |.........       |

#   Failed test &#39;pack typed any &#40;NaN&#41;&#39;
#   at t/10message.t line 205.
#   at bytes 0-0xf &#40;0-15&#41;
#   got: | 10 fe 00 .. .. .. .. .. .. .. .. .. .. .. .. .. |...             |
#   exp: | 10 7e 00 .. .. .. .. .. .. .. .. .. .. .. .. .. |.~.             |
# Looks like you failed 4 tests of 216.
t/10message.t .......... 
Dubious, test returned 4 &#40;wstat 1024, 0x400&#41;
Failed 4/216 subtests 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;17:32:07&nbsp;2016</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 02:18:03 2016, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/10message.t passes only with perl 5.22.x and fails for older or
&gt; newer perls, see <span class="clickylink"><a target="new" rel="nofollow" href="http://fast">http://fast</a></span>-
&gt; matrix.cpantesters.org/?dist=Tangence%200.22
</div>
Ohhh, perl. :&#40;

Looks like I&#39;ll have to apply some stronger numification canonicalisation in the tests then.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;17&nbsp;17:32:07&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;15:48:15&nbsp;2016</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Nov 17 17:32:07 2016, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Thu Nov 17 02:18:03 2016, SREZIC wrote:
<div class="message-stanza open">&gt; &gt; t/10message.t passes only with perl 5.22.x and fails for older or
&gt; &gt; newer perls, see <span class="clickylink"><a target="new" rel="nofollow" href="http://fast">http://fast</a></span>-
&gt; &gt; matrix.cpantesters.org/?dist=Tangence%200.22
</div>&gt; 
&gt; Ohhh, perl. :&#40;
&gt; 
&gt; Looks like I&#39;ll have to apply some stronger numification
&gt; canonicalisation in the tests then.
</div>
Turned out to be two separate bugs.

Perls older than 5.22 had inconsistent stringification of NaN and Inf, requiring more canonicalisation in tests.

Perls newer than 5.22 have changed the rules about NaN byte packing, always setting the sign bit.

-- 

Paul Evans
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> rt118806.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">=== modified file &#39;doc/Tangence.txt&#39;
--- doc/Tangence.txt	2016-11-16 22:23:25 +0000
+++ doc/Tangence.txt	2016-11-18 20:39:16 +0000
@@ -350,7 +350,7 @@
 maximum allowed value. If the mantissa is zero this represents an infinity of
 the given sign, and if the mantissa is non-zero, it is a not-a-number value.
 For canonical identity, the non-zero mantissa should have only its top bit
-set.
+set, and the sign bit should be clear.
 
  Subtype              Exponent   Mantissa
 

=== modified file &#39;lib/Tangence/Type/Primitive.pm&#39;
--- lib/Tangence/Type/Primitive.pm	2016-11-16 16:17:02 +0000
+++ lib/Tangence/Type/Primitive.pm	2016-11-18 20:39:16 +0000
@@ -170,8 +170,9 @@
 
 {
    my %format = &#40;
-      DATANUM_FLOAT32, [ &#34;f&gt;&#34;, 4 ],
-      DATANUM_FLOAT64, [ &#34;d&gt;&#34;, 8 ],
+                     #   pack, bytes, NaN
+      DATANUM_FLOAT32, [ &#34;f&gt;&#34;, 4,     &#34;\x7f\xc0\x00\x00&#34; ],
+      DATANUM_FLOAT64, [ &#34;d&gt;&#34;, 8,     &#34;\x7f\xf8\x00\x00\x00\x00\x00\x00&#34; ],
    &#41;;
 
    sub _best_type_for
@@ -218,7 +219,9 @@
       return Tangence::Type::Primitive::float16-&gt;pack_value&#40; $message, $value &#41; if $subtype == DATANUM_FLOAT16;
 
       $message-&gt;_pack_leader&#40; DATA_NUMBER, $subtype &#41;;
-      $message-&gt;_pack&#40; pack&#40; $format{$subtype}[0], $value &#41; &#41;;
+      $message-&gt;_pack&#40; $value == $value ?
+         pack&#40; $format{$subtype}[0], $value &#41; : $format{$subtype}[2]
+      &#41;;
    }
 
    sub unpack_value
@@ -278,6 +281,7 @@
       # special value - Inf or NaN
       $exp = 16;
       $mant16 = $mant32 ? &#40;1 &lt;&lt; 9&#41; : 0;
+      $sign = 0 if $mant16;
    }
    elsif&#40; $exp &gt; 15 &#41; {
       # Too large - become Inf

=== modified file &#39;t/10message.t&#39;
--- t/10message.t	2016-11-16 15:18:11 +0000
+++ t/10message.t	2016-11-18 19:58:25 +0000
@@ -211,7 +211,7 @@
       # Approximate comparison for floats
       $_ = sprintf &#34;%.5f&#34;, $_ for $expect, $value;
    }
-   elsif&#40; defined $expect and $expect =~ m/^[+-]inf$/i &#41; {
+   elsif&#40; defined $expect and $expect =~ m/^&#40;?:[+-]inf|nan&#41;$/i &#41; {
       # Canonicalise infinities
       $value  = 0+$value;
       $expect = 0+$expect;
@@ -343,7 +343,7 @@
    sig    =&gt; &#34;float16&#34;,
    data   =&gt; 1E12,
    stream =&gt; &#34;\x10\x7c\x00&#34;,
-   retdata =&gt; &#34;Inf&#34;;
+   retdata =&gt; &#34;+Inf&#34;;
 
 test_typed &#34;float32 zero&#34;,
    sig    =&gt; &#34;float32&#34;,

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Nov&nbsp;18&nbsp;15:48:20&nbsp;2016</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;10&nbsp;12:54:42&nbsp;2017</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Should be fixed by 0.23

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;10&nbsp;12:54:48&nbsp;2017</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;10&nbsp;12:54:48&nbsp;2017</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 0.23 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;17:24:05&nbsp;2017</span>
    <span class="description">SREZIC [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2017-01-10 12:54:42, PEVANS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Should be fixed by 0.23
</div>
Yes, the matrix looks much better now.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
