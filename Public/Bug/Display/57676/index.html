<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #57676 for IO-Socket-INET6: problems with multihomed and family order &#40;patch included&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #57676 for IO-Socket-INET6: problems with multihomed and family order &#40;patch included&#41;</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IO-Socket-INET6">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IO-Socket-INET6">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IO-Socket-INET6">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IO-Socket-INET6">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IO-Socket-INET6">IO-Socket-INET6 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">57676</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IO-Socket-INET6">IO-Socket-INET6</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Steffen_Ullrich [...] genua.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-17210-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.61    </td>
  </tr>
  <tr id="CF-17211-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




IO-Socket-INET6-2.62-t-io_multihomed6.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/781499/404745/IO-Socket-INET6-2.62-t-io_multihomed6.patch">
Mon May 24 08:39:56 2010 (853b) by paul [...] city-fan.org
</a>
</font></li>
</ul>


io-socket-inet6-t-io_multihomed6.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/780238/404091/io-socket-inet6-t-io_multihomed6.patch">
Fri May 21 06:38:05 2010 (980b) by Steffen_Ullrich [...] genua.de
</a>
</font></li>
</ul>


io-socket-inet6.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/779843/403888/io-socket-inet6.patch">
Thu May 20 15:41:37 2010 (5.9k) by Steffen_Ullrich [...] genua.de
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=57676">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779843" href="/Public/Bug/Display.html?id=57676#txn-779843">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;15:41:37&nbsp;2010</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> problems with multihomed and family order &#40;patch included&#41;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/779843/403887/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/403887">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Due to &#40;my&#41; last fixes on IO::Socket::INET6 multihomed got broken.
Additionally it could happen, that it preferred inet6 even if the 
host usually prefers inet6.
This was not detected because the io_multihomed test was assumes
that it will try to connect to inet6 first w/o checking it.
Because the default on OpenBSD is to prefer IPv4 it was detected
by a friend.

The attached patch &#40;against 2.61&#41; contains the following:
- rewrite of io_multihomed test so that it tests the right thing
  regardless if the host prefers inet or inet6
- fix for IO::Socket::INET6:

       for&#40; my $r=0;$r&lt;@rres;$r+=5 &#41; {
-         next if $rres[0] != $fam_listen; # must be same family
+         next if $rres[$r] != $fam_listen; # must be same family
                       ^^^^

- change to the algorithm for finding out the combinations of
  [family,localaddr,peeraddr] so that the order is driven by @rres,
  eg the order given by getaddrinfo&#40;peeraddr,AF_UNSPEC&#41;.
  The problem with the older approach was, that 
  getaddrinfo&#40;&#39;&#39;,AF_UNSPEC,AI_PASSIVE&#41; returns on Linux &#40;at least on
  my system&#41; inet before inet6, even if the system prefers inet6
  before inet.

patch was tested with per5.8.8 and perl5.10.1 on ubuntu10.04 with
inet6 prefered to inet and also the other way.

Regards,
Steffen
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> io-socket-inet6.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/779843/403888/io-socket-inet6.patch">Download io-socket-inet6.patch</a><br />
<span class="downloadcontenttype">text/x-diff 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru IO-Socket-INET6-2.61/lib/IO/Socket/INET6.pm IO-Socket-INET6-2.61.new/lib/IO/Socket/INET6.pm
--- IO-Socket-INET6-2.61/lib/IO/Socket/INET6.pm	2010-03-25 09:45:16.000000000 +0100
+++ IO-Socket-INET6-2.61.new/lib/IO/Socket/INET6.pm	2010-05-20 21:21:33.000000000 +0200
@@ -177,20 +177,25 @@
     }
 
     my @flr;
-    for&#40; my $l=0;$l&lt;@lres;$l+=5&#41; {
-        my $fam_listen = $lres[$l];
-        my $lsockaddr = $lres[$l+3];
-        if &#40;@rres&#41; {
-            # collect all combinations whith the same family in lres and rres
-            for&#40; my $r=0;$r&lt;@rres;$r+=5 &#41; {
-                next if $rres[0] != $fam_listen; # must be same family
-                push @flr,[ $fam_listen,$lsockaddr,$rres[$r+3] ];
-            }
-        } else {
-            # collect only the binding side
-            push @flr,[ $fam_listen,$lsockaddr ];
-        }
-    }
+	if &#40;@rres&#41; {
+		# collect all combinations whith the same family in lres and rres
+		# the order we search should be defined by the order of @rres, 
+		# not @lres!
+		for&#40; my $r=0;$r&lt;@rres;$r+=5 &#41; {
+    		for&#40; my $l=0;$l&lt;@lres;$l+=5&#41; {
+        		my $fam_listen = $lres[$l];
+				next if $rres[$r] != $fam_listen; # must be same family
+				push @flr,[ $fam_listen,$lres[$l+3],$rres[$r+3] ];
+			}
+		}
+	} else {
+		for&#40; my $l=0;$l&lt;@lres;$l+=5&#41; {
+			my $fam_listen = $lres[$l];
+			my $lsockaddr = $lres[$l+3];
+			# collect only the binding side
+			push @flr,[ $fam_listen,$lsockaddr ];
+		}
+	}
 
     # try to bind and maybe connect
     # if multihomed try all combinations until success
diff -ru IO-Socket-INET6-2.61/t/io_multihomed6.t IO-Socket-INET6-2.61.new/t/io_multihomed6.t
--- IO-Socket-INET6-2.61/t/io_multihomed6.t	2010-03-25 09:45:16.000000000 +0100
+++ IO-Socket-INET6-2.61.new/t/io_multihomed6.t	2010-05-20 21:24:16.000000000 +0200
@@ -1,9 +1,11 @@
 #!./perl
+use strict;
+use warnings;
 
 BEGIN {
     unless&#40;grep /blib/, @INC&#41; {
 	chdir &#39;t&#39; if -d &#39;t&#39;;
-	@INC = &#39;../lib&#39;;
+	unshift @INC,&#39;../lib&#39;;
     }
 }
 
@@ -25,79 +27,118 @@
 	    $reason = &#39;IO extension unavailable&#39;;
 	}
 	if &#40;$reason&#41; {
-	    print &#34;1..0 # Skip: $reason\n&#34;;
+	    print &#34;1..0 # SKIP $reason\n&#34;;
 	    exit 0;
         }
     }
     if &#40;$^O eq &#39;MSWin32&#39;&#41; {
-        print &#34;1..0 # Skip: accept&#40;&#41; fails for IPv6 under MSWin32\n&#34;;
+        print &#34;1..0 # SKIP accept&#40;&#41; fails for IPv6 under MSWin32\n&#34;;
         exit 0;
     }
 }
 
-$| = 1;
+use IO::Socket::INET6;
 
-print &#34;1..5\n&#34;;
+$| = 1;
+print &#34;1..8\n&#34;;
 
 eval {
     $SIG{ALRM} = sub { die; };
     alarm 60;
 };
 
-# Okey:
-# To check the Multihome strategy, let&#39;s try the next :
-# Open a IPv4 server on a given port.
-# then, try a client on unspecified family -AF_UNSPEC-
-# The multihomed socket will try then firstly IPv6, fail,
-# and then IPv4.
-package main;
-
-use IO::Socket::INET6;
-
-$listen = IO::Socket::INET6-&gt;new&#40;Listen =&gt; 2,
-				# 8080 is a commonly used port
-                # so we&#39;re using a more obscure port
-                # instead.
-				LocalPort =&gt; 28083,
-				Family =&gt; AF_INET,
-				Proto =&gt; &#39;tcp&#39;,
-				Timeout =&gt; 5,
-			       &#41; or die &#34;$@&#34;;
+# find out if the host prefers inet or inet6 by offering
+# both and checking where it connects
+my &#40;$port,@srv&#41;;
+for my $addr &#40; &#39;127.0.0.1&#39;,&#39;::1&#39; &#41; {
+    push @srv, IO::Socket::INET6-&gt;new&#40;
+    	Listen =&gt; 2,
+	LocalAddr =&gt; $addr,
+	LocalPort =&gt; $port,
+    &#41; or die &#34;listen on $addr port $port: $!&#34;;
+    $port ||= $srv[-1]-&gt;sockport;
+}
 
 print &#34;ok 1\n&#34;;
 
-$port = $listen-&gt;sockport;
-
-if&#40;$pid = fork&#40;&#41;&#41; {
-
-    $sock = $listen-&gt;accept&#40;&#41; or die &#34;$!&#34;;
-    print &#34;ok 2\n&#34;;
-
-    print $sock-&gt;getline&#40;&#41;;
-    print $sock &#34;ok 4\n&#34;;
+if &#40;my $pid = fork&#40;&#41;&#41; {
+    my $vec = &#39;&#39;;
+    vec&#40;$vec,fileno&#40;$_&#41;,1&#41; = 1 for&#40;@srv&#41;;
+    select&#40;$vec,undef,undef,5&#41; or die $!;
+
+    # connected to first, not second
+    my &#40;$first,$second&#41; = vec&#40;$vec,fileno&#40;$srv[0]&#41;,1&#41; ? @srv[0,1]:@srv[1,0];
+    my $cl = $first-&gt;accept or die $!;
+
+    # listener should not work for next connect
+    # so it needs to try second
+    close&#40;$first&#41;; 
+
+    # make sure established connection works
+    my $fam0 = &#40; $cl-&gt;sockdomain == AF_INET &#41; ? &#39;inet&#39;:&#39;inet6&#39;;
+    print $cl &#34;ok 2 # $fam0\n&#34;;
+    print $cl-&gt;getline&#40;&#41;; # ok 3
+    close&#40;$cl&#41;;
+
+    # ... ok 4 comes when client fails to connect to first
+
+    # wait for connect on second and make sure it works
+    $vec = &#39;&#39;;
+    vec&#40;$vec,fileno&#40;$second&#41;,1&#41; = 1;
+    if &#40; select&#40;$vec,undef,undef,5&#41;&#41; {
+    	my $cl2 = $second-&gt;accept or die $!;
+    	my $fam1 = &#40; $cl2-&gt;sockdomain == AF_INET &#41; ? &#39;inet&#39;:&#39;inet6&#39;;
+	print $cl2 &#34;ok 5 # $fam1\n&#34;;
+	print $cl2-&gt;getline&#40;&#41;; # ok 6
+	close&#40;$cl2&#41;;
+
+	# should be different families
+	print &#34;not &#34; if $fam0 eq $fam1;
+	print &#34;ok 7\n&#34;;
+    }
 
     waitpid&#40;$pid,0&#41;;
+    print &#34;ok 8\n&#34;;
 
-    $sock-&gt;close;
-
-    print &#34;ok 5\n&#34;;
-
-} elsif&#40;defined $pid&#41; {
-
-    $sock = IO::Socket::INET6-&gt;new&#40;PeerPort =&gt; $port,
-		       Proto =&gt; &#39;tcp&#39;,
-		       PeerAddr =&gt; &#39;localhost&#39;,
-		       MultiHomed =&gt; 1,
-		       Timeout =&gt; 1,
-		      &#41; or die &#34;$@&#34;;
-
-    print $sock &#34;ok 3\n&#34;;
-    sleep&#40;1&#41;; # race condition
-    print $sock-&gt;getline&#40;&#41;;
-
-    $sock-&gt;close;
+} elsif &#40;defined $pid&#41; {
+    close&#40;$_&#41; for &#40;@srv&#41;;
+    # should work because server is listening on inet and inet6
+    my $cl = IO::Socket::INET6-&gt;new&#40;
+    	PeerPort =&gt; $port,
+	PeerAddr =&gt; &#39;localhost&#39;,
+	Timeout =&gt; 5,
+    &#41; or die &#34;$@&#34;;
+
+    print $cl-&gt;getline&#40;&#41;; # ok 2
+    print $cl &#34;ok 3\n&#34;;
+    close&#40;$cl&#41;;
+
+    # this should not work because listener is closed
+    if &#40; $cl = IO::Socket::INET6-&gt;new&#40;
+    	PeerPort =&gt; $port,
+	PeerAddr =&gt; &#39;localhost&#39;,
+	Timeout =&gt; 5,
+    &#41;&#41; {
+    	print &#34;not ok 4\n&#34;;
+	exit
+    }
+    print &#34;ok 4\n&#34;;
 
+    # but same thing with multihoming should work because server
+    # is still listening on the other family
+    $cl = IO::Socket::INET6-&gt;new&#40;
+    	PeerPort =&gt; $port,
+	PeerAddr =&gt; &#39;localhost&#39;,
+	Timeout =&gt; 5,
+	MultiHomed =&gt; 1,
+    &#41; or do {
+    	print &#34;not ok 5\n&#34;;
+	exit
+    };
+    print $cl-&gt;getline&#40;&#41;; # ok 5
+    print $cl &#34;ok 6\n&#34;;
     exit;
+
 } else {
-    die;
+    die $!; # fork failed
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779888" href="/Public/Bug/Display.html?id=57676#txn-779888">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;16:55:13&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/779888/403912/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/403912">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 274b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the patch! I applied it after reviewing it and correcting
these things:

1. Make sure that one does not use tabs &#40;\t&#41; for indentation but rather
4-ws indentation.

2. print $socket &#34;Message&#34; should be print {$socket} &#34;Message&#34; - see PBP.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779891" href="/Public/Bug/Display.html?id=57676#txn-779891">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;16:55:16&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-779892" href="/Public/Bug/Display.html?id=57676#txn-779892">#</a>      
    </span>
    <span class="date">Thu&nbsp;May&nbsp;20&nbsp;16:55:16&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-780185" href="/Public/Bug/Display.html?id=57676#txn-780185">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;21&nbsp;05:30:09&nbsp;2010</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/780185/404055/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404055">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu May 20 16:55:13 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Thanks for the patch! I applied it after reviewing it and correcting
&gt; these things:
&gt; 
&gt; 1. Make sure that one does not use tabs &#40;\t&#41; for indentation but rather
&gt; 4-ws indentation.
&gt; 
&gt; 2. print $socket &#34;Message&#34; should be print {$socket} &#34;Message&#34; - see PBP.
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
I&#39;ve built this release successfully for every Fedora Linux release and
also Red Hat Enterprise Linux 3, 4, 5, and 6&#40;beta&#41; - except that is for
Fedora 10 &#40;i386 and x86_64&#41;, where I get this failure:

Use of uninitialized value in print at t/io_multihomed6.t line 140.
t/io_multihomed6.t ....
1..8
ok 1
ok 2 # inet
ok 3
ok 4
ok 8
Failed 3/8 subtests
...
Test Summary Report
-------------------
t/io_multihomed6.t  &#40;Wstat: 0 Tests: 5 Failed: 0&#41;
  Parse errors: Tests out of sequence.  Found &#40;8&#41; but expected &#40;5&#41;
                Bad plan.  You planned 8 tests but ran 5

That&#39;s with perl 5.10.0. And it&#39;s not just me; see also this cpantesters
report:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.cpantesters.org/cpan/report/07294053-b19f-3f77-b713-d32bba55d77f">http://www.cpantesters.org/cpan/report/07294053-b19f-3f77-b713-d32bba55d77f</a></span>
That&#39;s on perl 5.13.0.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-780188" href="/Public/Bug/Display.html?id=57676#txn-780188">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;21&nbsp;05:30:15&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-780238" href="/Public/Bug/Display.html?id=57676#txn-780238">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;21&nbsp;06:38:05&nbsp;2010</span>
    <span class="description">Steffen_Ullrich [...] genua.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/780238/404090/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404090">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 730b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
The test t/io_multihomed6.t assumes that localhost resolves so 127.0.0.1
and ::1. Looks like that on these systems this is not the case, e.g.
getaddrinfo gives only 127.0.0.1, not ::1.

Attached patch fixes the test in that it skips the test, if localhost
does not resolv to both 127.0.0.1 and ::1.

Thanks for reporting the problem.

Regards,
Steffen


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve built this release successfully for every Fedora Linux release and
&gt; also Red Hat Enterprise Linux 3, 4, 5, and 6&#40;beta&#41; - except that is for
&gt; Fedora 10 &#40;i386 and x86_64&#41;, where I get this failure:
&gt; 
&gt; Use of uninitialized value in print at t/io_multihomed6.t line 140.
&gt; t/io_multihomed6.t ....
&gt; 1..8
&gt; ok 1
&gt; ok 2 # inet
&gt; ok 3
&gt; ok 4
&gt; ok 8
&gt; Failed 3/8 subtests
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> io-socket-inet6-t-io_multihomed6.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/780238/404091/io-socket-inet6-t-io_multihomed6.patch">Download io-socket-inet6-t-io_multihomed6.patch</a><br />
<span class="downloadcontenttype">text/x-diff 980b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Only in IO-Socket-INET6-2.62.new/: blib
Only in IO-Socket-INET6-2.62.new/: Makefile
Only in IO-Socket-INET6-2.62.new/: pm_to_blib
diff -ur IO-Socket-INET6-2.62/t/io_multihomed6.t IO-Socket-INET6-2.62.new/t/io_multihomed6.t
--- IO-Socket-INET6-2.62/t/io_multihomed6.t	2010-05-20 22:42:31.000000000 +0200
+++ IO-Socket-INET6-2.62.new/t/io_multihomed6.t	2010-05-21 12:31:30.000000000 +0200
@@ -38,6 +38,24 @@
     }
 }
 
+# check that localhost resolves to 127.0.0.1 and ::1
+# otherwise the test will not work
+use Socket;
+use Socket6;
+my %addr;
+my @r = getaddrinfo&#40;&#39;localhost&#39;,1&#41;;
+while &#40;@r&#41; {
+    my &#40;$fam,$addr&#41; = &#40;splice&#40;@r,0,5&#41;&#41;[0,3];
+    $addr = $fam == AF_INET 
+        ? &#40;unpack_sockaddr_in&#40;$addr&#41;&#41;[1]
+        : &#40;unpack_sockaddr_in6&#40;$addr&#41;&#41;[1];
+    $addr{inet_ntop&#40;$fam,$addr&#41;}++;
+}
+if &#40;! $addr{&#39;127.0.0.1&#39;} || ! $addr{&#39;::1&#39;}&#41; {
+    print &#34;1..0 # SKIP localhost does not resolve to both 127.0.0.1 and ::1\n&#34;;
+    exit 0;
+}
+
 use IO::Socket::INET6;
 
 $| = 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-780467" href="/Public/Bug/Display.html?id=57676#txn-780467">#</a>      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;21&nbsp;11:41:09&nbsp;2010</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/780467/404193/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404193">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri May 21 06:38:05 2010, SULLR wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; The test t/io_multihomed6.t assumes that localhost resolves so 127.0.0.1
&gt; and ::1. Looks like that on these systems this is not the case, e.g.
&gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; 
&gt; Attached patch fixes the test in that it skips the test, if localhost
&gt; does not resolv to both 127.0.0.1 and ::1.
</div>
Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:

t/io_multihomed6......Possible unintended interpolation of @srv in
string at t/io_multihomed6.t line 50.
Possible unintended interpolation of @srv in string at
t/io_multihomed6.t line 50.
Global symbol &#34;$port&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;@srv&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;@srv&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;$port&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;$port&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;$port&#34; requires explicit package name at
t/io_multihomed6.t line 50.
Global symbol &#34;@srv&#34; requires explicit package name at
t/io_multihomed6.t line 50.
syntax error at t/io_multihomed6.t line 50, near &#34;-&gt;sockport;&#34;
Unmatched right curly bracket at t/io_multihomed6.t line 51, within pattern
syntax error at t/io_multihomed6.t line 51, near &#34;;
}
print &#34;ok 1\n&#34;;
if &#40;my &#34;
t/io_multihomed6.t has too many errors.
dubious
        Test returned status 2 &#40;wstat 512, 0x200&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781251" href="/Public/Bug/Display.html?id=57676#txn-781251">#</a>      
    </span>
    <span class="date">Sun&nbsp;May&nbsp;23&nbsp;14:28:01&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/781251/404619/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404619">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 777b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi!

On Fri May 21 11:41:09 2010, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Fri May 21 06:38:05 2010, SULLR wrote:
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; The test t/io_multihomed6.t assumes that localhost resolves so 127.0.0.1
&gt; &gt; and ::1. Looks like that on these systems this is not the case, e.g.
&gt; &gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; &gt; 
&gt; &gt; Attached patch fixes the test in that it skips the test, if localhost
&gt; &gt; does not resolv to both 127.0.0.1 and ::1.
</div>&gt; 
&gt; Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:
&gt; 
</div>
I&#39;ve tried to apply a modify version of the patch, and the test script
in question &#40; &#34;t/io_multihomed6.t&#34;&#41; works fine. Which earlier perls do
you refer to? I&#39;m now building perl-5.8.9 and will try it with that. But
any information would be welcome.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781447" href="/Public/Bug/Display.html?id=57676#txn-781447">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;05:04:34&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/781447/404715/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404715">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 961b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun May 23 14:28:01 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi!
&gt; 
&gt; On Fri May 21 11:41:09 2010, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; On Fri May 21 06:38:05 2010, SULLR wrote:
<div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; The test t/io_multihomed6.t assumes that localhost resolves so
</div></div></div>127.0.0.1
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; and ::1. Looks like that on these systems this is not the case, e.g.
&gt; &gt; &gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; &gt; &gt; 
&gt; &gt; &gt; Attached patch fixes the test in that it skips the test, if localhost
&gt; &gt; &gt; does not resolv to both 127.0.0.1 and ::1.
</div>&gt; &gt; 
&gt; &gt; Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:
&gt; &gt; 
</div>&gt; 
&gt; I&#39;ve tried to apply a modify version of the patch, and the test script
&gt; in question &#40; &#34;t/io_multihomed6.t&#34;&#41; works fine. Which earlier perls do
&gt; you refer to? I&#39;m now building perl-5.8.9 and will try it with that. But
&gt; any information would be welcome.
&gt; 
</div>
Hi!

I&#39;ve now tried it with perl-5.8.9 and t/io_multihomed6.t works fine -
how earlier must I go?

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781499" href="/Public/Bug/Display.html?id=57676#txn-781499">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;08:39:56&nbsp;2010</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/781499/404744/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404744">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 05:04:34 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun May 23 14:28:01 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; Hi!
&gt; &gt; 
&gt; &gt; On Fri May 21 11:41:09 2010, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Fri May 21 06:38:05 2010, SULLR wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; The test t/io_multihomed6.t assumes that localhost resolves so
</div></div></div>&gt; 127.0.0.1
<div class="message-stanza open">&gt; &gt; &gt; &gt; and ::1. Looks like that on these systems this is not the case, e.g.
&gt; &gt; &gt; &gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Attached patch fixes the test in that it skips the test, if
</div></div>localhost
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; does not resolv to both 127.0.0.1 and ::1.
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:
&gt; &gt; &gt; 
</div>&gt; &gt; 
&gt; &gt; I&#39;ve tried to apply a modify version of the patch, and the test script
&gt; &gt; in question &#40; &#34;t/io_multihomed6.t&#34;&#41; works fine. Which earlier perls do
&gt; &gt; you refer to? I&#39;m now building perl-5.8.9 and will try it with that. But
&gt; &gt; any information would be welcome.
&gt; &gt; 
</div>&gt; 
&gt; Hi!
&gt; 
&gt; I&#39;ve now tried it with perl-5.8.9 and t/io_multihomed6.t works fine -
&gt; how earlier must I go?
</div>
It breaks with the same symptoms on 5.8.8 and earlier. It&#39;s a similar
issue to that in RT#54656, and is resolved by the addition of
parentheses around the first operand of the ternary operator, as in the
attached amended patch.

However, I&#39;m still getting problems at runtime with 5.8.3 and earlier:

t/io_multihomed6......Use of uninitialized value in subroutine entry at
t/io_multihomed6.t line 49.
Bad arg length for Socket6::unpack_sockaddr_in6, length is 0, should be
28 at t/io_multihomed6.t line 49.
dubious
        Test returned status 255 &#40;wstat 65280, 0xff00&#41;
Scalar found where operator expected at &#40;eval 152&#41; line 1, near &#34;&#39;int&#39; 
$__val&#34;
        &#40;Missing operator before   $__val?&#41;

I&#39;m seeing this same error with 5.8.0 and 5.8.3.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> IO-Socket-INET6-2.62-t-io_multihomed6.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/781499/404745/IO-Socket-INET6-2.62-t-io_multihomed6.patch">Download IO-Socket-INET6-2.62-t-io_multihomed6.patch</a><br />
<span class="downloadcontenttype">text/x-diff 853b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ur IO-Socket-INET6-2.62/t/io_multihomed6.t IO-Socket-INET6-2.62.new/t/io_multihomed6.t
--- IO-Socket-INET6-2.62/t/io_multihomed6.t	2010-05-20 22:42:31.000000000 +0200
+++ IO-Socket-INET6-2.62.new/t/io_multihomed6.t	2010-05-21 12:31:30.000000000 +0200
@@ -38,6 +38,24 @@
     }
 }
 
+# check that localhost resolves to 127.0.0.1 and ::1
+# otherwise the test will not work
+use Socket;
+use Socket6;
+my %addr;
+my @r = getaddrinfo&#40;&#39;localhost&#39;,1&#41;;
+while &#40;@r&#41; {
+    my &#40;$fam,$addr&#41; = &#40;splice&#40;@r,0,5&#41;&#41;[0,3];
+    $addr = &#40; $fam == AF_INET &#41;
+        ? &#40;unpack_sockaddr_in&#40;$addr&#41;&#41;[1]
+        : &#40;unpack_sockaddr_in6&#40;$addr&#41;&#41;[1];
+    $addr{inet_ntop&#40;$fam,$addr&#41;}++;
+}
+if &#40;! $addr{&#39;127.0.0.1&#39;} || ! $addr{&#39;::1&#39;}&#41; {
+    print &#34;1..0 # SKIP localhost does not resolve to both 127.0.0.1 and ::1\n&#34;;
+    exit 0;
+}
+
 use IO::Socket::INET6;
 
 $| = 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781509" href="/Public/Bug/Display.html?id=57676#txn-781509">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;10:27:09&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/781509/404753/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404753">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 08:39:56 2010, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon May 24 05:04:34 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; On Sun May 23 14:28:01 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; &gt; Hi!
&gt; &gt; &gt; 
&gt; &gt; &gt; On Fri May 21 11:41:09 2010, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; On Fri May 21 06:38:05 2010, SULLR wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; The test t/io_multihomed6.t assumes that localhost resolves so
</div></div></div>&gt; &gt; 127.0.0.1
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; and ::1. Looks like that on these systems this is not the
</div></div></div>case, e.g.
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Attached patch fixes the test in that it skips the test, if
</div></div>&gt; localhost
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; does not resolv to both 127.0.0.1 and ::1.
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:
&gt; &gt; &gt; &gt; 
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; I&#39;ve tried to apply a modify version of the patch, and the test script
&gt; &gt; &gt; in question &#40; &#34;t/io_multihomed6.t&#34;&#41; works fine. Which earlier perls do
&gt; &gt; &gt; you refer to? I&#39;m now building perl-5.8.9 and will try it with
</div></div>that. But
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; any information would be welcome.
&gt; &gt; &gt; 
</div>&gt; &gt; 
&gt; &gt; Hi!
&gt; &gt; 
&gt; &gt; I&#39;ve now tried it with perl-5.8.9 and t/io_multihomed6.t works fine -
&gt; &gt; how earlier must I go?
</div>&gt; 
&gt; It breaks with the same symptoms on 5.8.8 and earlier. It&#39;s a similar
&gt; issue to that in RT#54656, and is resolved by the addition of
&gt; parentheses around the first operand of the ternary operator, as in the
&gt; attached amended patch.
</div>
Thanks!

I already had a similar bracketing solution in place in the repository
due to style issues.  

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; However, I&#39;m still getting problems at runtime with 5.8.3 and earlier:
&gt; 
&gt; t/io_multihomed6......Use of uninitialized value in subroutine entry at
&gt; t/io_multihomed6.t line 49.
&gt; Bad arg length for Socket6::unpack_sockaddr_in6, length is 0, should be
&gt; 28 at t/io_multihomed6.t line 49.
&gt; dubious
&gt;         Test returned status 255 &#40;wstat 65280, 0xff00&#41;
&gt; Scalar found where operator expected at &#40;eval 152&#41; line 1, near &#34;&#39;int&#39; 
&gt; $__val&#34;
&gt;         &#40;Missing operator before   $__val?&#41;
&gt; 
&gt; I&#39;m seeing this same error with 5.8.0 and 5.8.3.
</div>
I&#39;ll try to test and correct that, though perl-5.8.7 and below are
really ancient and supporting them is not a high priority.

Regards,

-- Shlomi Fish
 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781529" href="/Public/Bug/Display.html?id=57676#txn-781529">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;11:23:19&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/781529/404763/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404763">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 10:27:09 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon May 24 08:39:56 2010, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; On Mon May 24 05:04:34 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; &gt; On Sun May 23 14:28:01 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; Hi!
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Fri May 21 11:41:09 2010, paul@city-fan.org wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; On Fri May 21 06:38:05 2010, SULLR wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; The test t/io_multihomed6.t assumes that localhost resolves so
</div></div></div>&gt; &gt; &gt; 127.0.0.1
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; and ::1. Looks like that on these systems this is not the
</div></div></div>&gt; case, e.g.
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; getaddrinfo gives only 127.0.0.1, not ::1.
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; Attached patch fixes the test in that it skips the test, if
</div></div>&gt; &gt; localhost
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; does not resolv to both 127.0.0.1 and ::1.
</div>&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Thanks; that&#39;s fixed Fedora 10 but breaks with earlier perls:
&gt; &gt; &gt; &gt; &gt; 
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I&#39;ve tried to apply a modify version of the patch, and the test
</div></div></div>script
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; &gt; &gt; in question &#40; &#34;t/io_multihomed6.t&#34;&#41; works fine. Which earlier
</div></div>perls do
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; you refer to? I&#39;m now building perl-5.8.9 and will try it with
</div></div>&gt; that. But
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; any information would be welcome.
&gt; &gt; &gt; &gt; 
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Hi!
&gt; &gt; &gt; 
&gt; &gt; &gt; I&#39;ve now tried it with perl-5.8.9 and t/io_multihomed6.t works fine -
&gt; &gt; &gt; how earlier must I go?
</div>&gt; &gt; 
&gt; &gt; It breaks with the same symptoms on 5.8.8 and earlier. It&#39;s a similar
&gt; &gt; issue to that in RT#54656, and is resolved by the addition of
&gt; &gt; parentheses around the first operand of the ternary operator, as in the
&gt; &gt; attached amended patch.
</div>&gt; 
&gt; Thanks!
&gt; 
&gt; I already had a similar bracketing solution in place in the repository
&gt; due to style issues.  
&gt; 
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; However, I&#39;m still getting problems at runtime with 5.8.3 and earlier:
&gt; &gt; 
&gt; &gt; t/io_multihomed6......Use of uninitialized value in subroutine entry at
&gt; &gt; t/io_multihomed6.t line 49.
&gt; &gt; Bad arg length for Socket6::unpack_sockaddr_in6, length is 0, should be
&gt; &gt; 28 at t/io_multihomed6.t line 49.
&gt; &gt; dubious
&gt; &gt;         Test returned status 255 &#40;wstat 65280, 0xff00&#41;
&gt; &gt; Scalar found where operator expected at &#40;eval 152&#41; line 1, near &#34;&#39;int&#39; 
&gt; &gt; $__val&#34;
&gt; &gt;         &#40;Missing operator before   $__val?&#41;
&gt; &gt; 
&gt; &gt; I&#39;m seeing this same error with 5.8.0 and 5.8.3.
</div>&gt; 
&gt; I&#39;ll try to test and correct that, though perl-5.8.7 and below are
&gt; really ancient and supporting them is not a high priority.
&gt; 
</div>
After some time of getting perl-5.8.0 to build on a recent Mandriva
Linux Cooker, the test appears to work fine:

[quote]
shlomi[inet6]:$module$ ~/apps/perl/5.8.0-debug/bin/perl -Ilib
t/io_multihomed6.t
1..8
ok 1
ok 2 # inet6
ok 3
ok 4
ok 5 # inet
ok 6
ok 7
ok 8
[/quote]

Where did you run into that problem with perl-5.8.0? Where there any
vendor patches? Can you provide a patch against the svn repository:

<span class="clickylink"><a target="new" rel="nofollow" href="http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/">http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/</a></span>

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-781616" href="/Public/Bug/Display.html?id=57676#txn-781616">#</a>      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;24&nbsp;15:56:41&nbsp;2010</span>
    <span class="description">paul [...] city-fan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> paul [...] city-fan.org</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/781616/404802/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/404802">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 11:23:19 2010, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; After some time of getting perl-5.8.0 to build on a recent Mandriva
&gt; Linux Cooker, the test appears to work fine:
&gt; 
&gt; [quote]
&gt; shlomi[inet6]:$module$ ~/apps/perl/5.8.0-debug/bin/perl -Ilib
&gt; t/io_multihomed6.t
&gt; 1..8
&gt; ok 1
&gt; ok 2 # inet6
&gt; ok 3
&gt; ok 4
&gt; ok 5 # inet
&gt; ok 6
&gt; ok 7
&gt; ok 8
&gt; [/quote]
&gt; 
&gt; Where did you run into that problem with perl-5.8.0? Where there any
&gt; vendor patches? Can you provide a patch against the svn repository:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/">http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/</a></span>
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
I&#39;m doing the builds in chroots, installing old distributions into the
chroot and building RPM packages that way. The problematic builds are
for Red Hat Linux 9, Fedora Core 1 and Red Hat Enterprise Linux 3. The
former two of these are &#34;dead&#34; and the latter will join them in around 6
months but I&#39;ll see what I can do to debug the issue. It&#39;s possible that
it&#39;s a side effect of my build system as well as possibly being a
peculiarity of the perl builds &#40;which were more heavily patched back
then than they are now&#41;.

Paul.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-783911" href="/Public/Bug/Display.html?id=57676#txn-783911">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;29&nbsp;07:19:32&nbsp;2010</span>
    <span class="description">batailic [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> batailic [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/783911/406096/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/406096">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 266b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">There is a simple solution to this, just add the following to /etc/hosts:
# For loopbacking.
127.0.0.1               localhost
::1                     localhost
I your host support inet6 it should work, otherwise what is the point of
installing IO::Socket::INET6 ;&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-783914" href="/Public/Bug/Display.html?id=57676#txn-783914">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;29&nbsp;07:38:28&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/783914/406099/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/406099">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon May 24 15:56:41 2010, paul@city-fan.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon May 24 11:23:19 2010, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; After some time of getting perl-5.8.0 to build on a recent Mandriva
&gt; &gt; Linux Cooker, the test appears to work fine:
&gt; &gt; 
&gt; &gt; [quote]
&gt; &gt; shlomi[inet6]:$module$ ~/apps/perl/5.8.0-debug/bin/perl -Ilib
&gt; &gt; t/io_multihomed6.t
&gt; &gt; 1..8
&gt; &gt; ok 1
&gt; &gt; ok 2 # inet6
&gt; &gt; ok 3
&gt; &gt; ok 4
&gt; &gt; ok 5 # inet
&gt; &gt; ok 6
&gt; &gt; ok 7
&gt; &gt; ok 8
&gt; &gt; [/quote]
&gt; &gt; 
&gt; &gt; Where did you run into that problem with perl-5.8.0? Where there any
&gt; &gt; vendor patches? Can you provide a patch against the svn repository:
&gt; &gt; 
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/">http://svn.berlios.de/svnroot/repos/web-cpan/IO-Socket-INET6/trunk/</a></span>
&gt; &gt; 
&gt; &gt; Regards,
&gt; &gt; 
&gt; &gt; -- Shlomi Fish
</div>&gt; 
&gt; I&#39;m doing the builds in chroots, installing old distributions into the
&gt; chroot and building RPM packages that way. The problematic builds are
&gt; for Red Hat Linux 9, Fedora Core 1 and Red Hat Enterprise Linux 3. The
&gt; former two of these are &#34;dead&#34; and the latter will join them in around 6
&gt; months but I&#39;ll see what I can do to debug the issue. It&#39;s possible that
&gt; it&#39;s a side effect of my build system as well as possibly being a
&gt; peculiarity of the perl builds &#40;which were more heavily patched back
&gt; then than they are now&#41;.
&gt; 
</div>
Well, I&#39;m closing this bug because it appears to be fixed. I&#39;ll upload a
new version to CPAN soon. Please open a new bug if you have a more
concrete problem &#40;hopefully with a fix&#41;.

Regards,

-- Shlomi Fish

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Paul.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-783917" href="/Public/Bug/Display.html?id=57676#txn-783917">#</a>      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;29&nbsp;07:38:29&nbsp;2010</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.935315</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
