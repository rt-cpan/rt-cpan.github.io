<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73138 for accessors: Prohibit &#34;class accessors&#34;?</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73138 for accessors: Prohibit &#34;class accessors&#34;?</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/accessors/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/accessors/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/accessors/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/accessors/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/accessors">accessors CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73138</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/accessors/Active/">accessors</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-26-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.01    </td>
  </tr>
  <tr id="CF-27-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Dec&nbsp;09&nbsp;12:43:31&nbsp;2011</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Prohibit &#34;class accessors&#34;?</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Currently it is possible to define some kind of &#34;class accessors&#34; with
accessors.pm. See the following script:

#!/usr/bin/perl

use strict;
use warnings;

{
    package Foo;
    use accessors qw&#40;bla&#41;;
}

Foo-&gt;bla&#40;2&#41;;
print Foo-&gt;bla, &#34;\n&#34;;

# or

my $object = &#39;Foo&#39;; # an accident!
print $object-&gt;bla, &#34;\n&#34;; # does not die!

__END__

I wonder if such a use should be forbidden. If you think it should be
forbidden, then you can apply the attached patch &#40;which has also
additional test cases&#41;.

Regards,
    Slaven
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> accessors-strict-refs.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git c/lib/accessors.pm w/lib/accessors.pm
index 203ee72..9b0fdf0 100644
--- c/lib/accessors.pm
+++ w/lib/accessors.pm
@@ -68,12 +68,13 @@ sub create_accessor {
     $property = &#34;-$property&#34;;
     # set/get is slightly faster if we eval instead of using a closure + anon
     # sub, but the difference is marginal &#40;~5%&#41;, and this uses less memory...
-    no strict &#39;refs&#39;;
-    *{$accessor} = sub {
+    my $sub = sub {
 	&#40;@_ &gt; 1&#41;
 	  ? &#40;$_[0]-&gt;{$property} = $_[1], return $_[0]&#41;
 	  : $_[0]-&gt;{$property};
     };
+    no strict &#39;refs&#39;;
+    *{$accessor} = $sub;
 }
 
 sub isa_valid_name {
diff --git c/lib/accessors/classic.pm w/lib/accessors/classic.pm
index add9025..0c105b8 100644
--- c/lib/accessors/classic.pm
+++ w/lib/accessors/classic.pm
@@ -31,10 +31,11 @@ sub create_accessor {
     my &#40;$class, $accessor, $property&#41; = @_;
     # set/get is slightly faster if we eval instead of using a closure + anon
     # sub, but the difference is marginal &#40;~5%&#41;, and this uses less memory...
-    no strict &#39;refs&#39;;
-    *{$accessor} = sub {
+    my $sub = sub {
 	&#40;@_ &gt; 1&#41; ? $_[0]-&gt;{$property} = $_[1] : $_[0]-&gt;{$property};
-    }
+    };
+    no strict &#39;refs&#39;;
+    *{$accessor} = $sub;
 }
 
 1;
diff --git c/lib/accessors/ro.pm w/lib/accessors/ro.pm
index 8ca1bfb..369f86f 100755
--- c/lib/accessors/ro.pm
+++ w/lib/accessors/ro.pm
@@ -37,8 +37,9 @@ sub create_accessor {
     my &#40;$class, $accessor, $property&#41; = @_;
     # get is slightly faster if we eval instead of using a closure + anon
     # sub, but the difference is marginal &#40;~5%&#41;, and this uses less memory...
+    my $sub = sub { return $_[0]-&gt;{$property} };
     no strict &#39;refs&#39;;
-    *{$accessor} = sub { return $_[0]-&gt;{$property} };
+    *{$accessor} = $sub;
 }
 
 1;
diff --git c/t/02__chaining.t w/t/02__chaining.t
index fd10b25..f9935a4 100644
--- c/t/02__chaining.t
+++ w/t/02__chaining.t
@@ -7,7 +7,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 12;
+use Test::More tests =&gt; 13;
 use Carp;
 
 BEGIN { use_ok&#40; &#34;accessors::chained&#34; &#41; };
@@ -22,6 +22,12 @@ is&#40; $foo-&gt;bar&#40; &#39;set&#39; &#41;-&gt;baz&#40; 2 &#41;, $foo, &#39;set foo-&gt;bar-&gt;baz&#39; &#41;;
 is&#40; $foo-&gt;bar, &#39;set&#39;,   &#39;get foo-&gt;bar&#39; &#41;;
 is&#40; $foo-&gt;baz, &#39;2&#39;,     &#39;get foo-&gt;baz&#39; &#41;;
 
+eval {
+    my $class = &#39;Foo&#39;;
+    $class-&gt;bar&#40; &#39;set&#39; &#41;-&gt;baz&#40; 2 &#41;;
+};
+isnt&#40; $@, &#39;&#39;, &#39;class accessor is an error&#39; &#41;;
+
 SKIP: {
     skip &#39;$ENV{BENCHMARK_ACCESSORS} not set&#39;, 6 unless &#40;$ENV{BENCHMARK_ACCESSORS}&#41;;
     eval &#34;use Benchmark qw&#40; timestr countit &#41;&#34;; # ya never know...
diff --git c/t/03__classic.t w/t/03__classic.t
index 7396af0..93ecfa1 100644
--- c/t/03__classic.t
+++ w/t/03__classic.t
@@ -7,7 +7,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 12;
+use Test::More tests =&gt; 13;
 use Carp;
 
 BEGIN { use_ok&#40; &#34;accessors::classic&#34; &#41; };
@@ -22,6 +22,13 @@ is&#40; $foo-&gt;bar&#40; &#39;set&#39; &#41;, &#39;set&#39;, &#39;set foo-&gt;bar&#39; &#41;;
 is&#40; $foo-&gt;baz&#40; 2 &#41;, 2,         &#39;set foo-&gt;baz&#39; &#41;;
 is&#40; $foo-&gt;bar, &#39;set&#39;,          &#39;get foo-&gt;bar&#39; &#41;;
 
+eval {
+    my $class = &#39;Foo&#39;;
+    $class-&gt;bar&#40; &#39;set&#39; &#41;;
+    $class-&gt;bar;
+};
+isnt&#40; $@, &#39;&#39;, &#39;class accessor is an error&#39; &#41;;
+
 SKIP: {
     skip &#39;$ENV{BENCHMARK_ACCESSORS} not set&#39;, 6 unless &#40;$ENV{BENCHMARK_ACCESSORS}&#41;;
     eval &#34;use Benchmark qw&#40; timestr countit &#41;&#34;; # ya never know...
diff --git c/t/05__default.t w/t/05__default.t
index fad10aa..75993d5 100644
--- c/t/05__default.t
+++ w/t/05__default.t
@@ -7,7 +7,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 6;
+use Test::More tests =&gt; 7;
 use Carp;
 
 BEGIN { use_ok&#40; &#34;accessors&#34; &#41; };
@@ -21,5 +21,12 @@ ok&#40; $foo-&gt;bar&#40; 1 &#41;, &#39;set default&#39; &#41;;
 is&#40; $foo-&gt;bar, 1 ,  &#39;get default&#39; &#41;;
 ok&#40; !$foo-&gt;baz,     &#39;get default&#39;&#41;;
 
+eval {
+    my $class = &#39;Foo&#39;;
+    $class-&gt;bar&#40; 1 &#41;;
+    $class-&gt;bar;
+};
+isnt&#40; $@, &#39;&#39;, &#39;class accessor is an error&#39; &#41;;
+
 package Foo;
 use accessors qw&#40; bar baz &#41;;
diff --git c/t/06__rw.t w/t/06__rw.t
index ea77cc0..3b37170 100644
--- c/t/06__rw.t
+++ w/t/06__rw.t
@@ -7,7 +7,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 6;
+use Test::More tests =&gt; 7;
 use Carp;
 
 BEGIN { use_ok&#40; &#34;accessors::rw&#34; &#41; };
@@ -22,6 +22,13 @@ is&#40; $foo-&gt;bar&#40; &#39;set&#39; &#41;, &#39;set&#39;, &#39;set foo-&gt;bar&#39; &#41;;
 is&#40; $foo-&gt;baz&#40; 2 &#41;, 2,         &#39;set foo-&gt;baz&#39; &#41;;
 is&#40; $foo-&gt;bar, &#39;set&#39;,          &#39;get foo-&gt;bar&#39; &#41;;
 
+eval {
+    my $class = &#39;Foo&#39;;
+    $class-&gt;bar&#40; 1 &#41;;
+    $class-&gt;bar;
+};
+isnt&#40; $@, &#39;&#39;, &#39;class accessor is an error&#39; &#41;;
+
 # no sense benchmarking this as it inherits from accessors::classic.
 
 package Foo;
diff --git c/t/07__ro.t w/t/07__ro.t
index dc43390..133910a 100644
--- c/t/07__ro.t
+++ w/t/07__ro.t
@@ -7,7 +7,7 @@
 use strict;
 use warnings;
 
-use Test::More tests =&gt; 13;
+use Test::More tests =&gt; 14;
 use Carp;
 
 BEGIN { use_ok&#40; &#34;accessors::ro&#34; &#41; };
@@ -24,6 +24,12 @@ is&#40; $foo-&gt;baz, undef,       &#39;get foo-&gt;baz&#39; &#41;;
 $foo-&gt;{baz} = &#39;set&#39;;
 is&#40; $foo-&gt;baz, &#39;set&#39;,       &#39;get foo-&gt;baz&#39; &#41;;
 
+eval {
+    my $class = &#39;Foo&#39;;
+    $class-&gt;bar;
+};
+isnt&#40; $@, &#39;&#39;, &#39;class accessor is an error&#39; &#41;;
+
 SKIP: {
     skip &#39;$ENV{BENCHMARK_ACCESSORS} not set&#39;, 6 unless &#40;$ENV{BENCHMARK_ACCESSORS}&#41;;
     eval &#34;use Benchmark qw&#40; timestr countit &#41;&#34;; # ya never know...
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;24&nbsp;10:30:14&nbsp;2012</span>
    <span class="description">steve [...] purkis.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Slaven,

On Fri Dec 09 12:43:31 2011, SREZIC wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Currently it is possible to define some kind of &#34;class accessors&#34; with
&gt; accessors.pm. See the following script: [snip!]
</div>
Thanks, I agree it&#39;s a good idea to block this and also a bug -- I never intended for people to 
create random hashes in the accessors:: namespace!

I&#39;ve benchmarked your patch vs current module several times, and have seen no big 
performance hit &#40;see below&#41;.

My only other concerns:
1. The error message isn&#39;t great:
  Can&#39;t use string &#40;&#34;Foo&#34;&#41; as a HASH ref while &#34;strict refs&#34; in use at lib/accessors.pm line 72.

Ideally it&#39;d say something like:
  accessors::$class can&#39;t set a property &#40;$property&#41; on a class &#40;$class&#41;: use an instance instead 
at $caller_info

So: what&#39;s the performance cost of adding in some error checking, and is it worth it?  If not, 
the docs need to be updated to mention the above error in the event that this release breaks 
someones&#39; unintentional class-accessor usage.

2. &#39;no&#39; is compile-time...
I wonder if it will revert to original behaviour &#40;ie: apply to the whole block&#41; in an older version 
of Perl?  CPAN testers should catch this, if so we can throw another block around it.

Cheers,
-Steve

-----------------
Performance testing
-----------------
t/01__basic.t ...
  Patched: ok 8 - generates 38836 accessors/sec &#40;&gt; 100&#41;
  Current: ok 7 - generates 38836 accessors/sec &#40;&gt; 100&#41;

t/03__classic.t ...
  Patched: ok 8 - generates 38836 accessors/sec &#40;&gt; 100&#41;
  Current: ok 7 - generates 38836 accessors/sec &#40;&gt; 100&#41;

t/07__ro.t ........ 
  Patched 2 runs: ok 9 - generates 35101 accessors/sec &#40;&gt; 100&#41;
  Patched 3rd run: ok 9 - generates 34439 accessors/sec &#40;&gt; 100&#41;
  Patched 4th run: ok 9 - generates 38027 accessors/sec &#40;&gt; 100&#41;
  Current 3 runs: ok 8 - generates 35790 accessors/sec &#40;&gt; 100&#41;
  Current 4th run: ok 8 - generates 39680 accessors/sec &#40;&gt; 100&#41;

Difference is small, so I&#39;d say not worth investigating further.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;24&nbsp;10:30:15&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
