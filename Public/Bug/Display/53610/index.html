<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #53610 for Net-DNS: TSIG validation support</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #53610 for Net-DNS: TSIG validation support</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-DNS/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-DNS/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-DNS">Net-DNS CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">53610</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-DNS/Active/">Net-DNS</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">OLAF [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
bitcard [...] antibozo.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-22454-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-22455-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;11&nbsp;18:36:09&nbsp;2010</span>
    <span class="description">bitcard [...] antibozo.net -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> TSIG validation support</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The design of Net::DNS::Packet makes it impossible to validate TSIG
signatures. A patch to fix this and to add validation support to
Net::DNS is attached.

Rationale: with people deploying DNSSEC, the ability to perform
validated zone transfers via TSIG is useful since some people are using
this as a secure method to ship zone files to a central signing
repository. Net::DNS would be a useful part of this process, but,
although it can currently sign AXFR requests, it cannot validate the
responses. An attacker thus may substitute alternate zone data as a
response to the AXFR.

This patch was also provided via email to the listed package maintainers
MFURH and OLAF. The patch is a unified diff against current trunk in
SVN, Net-DNS 0.66, SVN revision 846.

A summary of the changes in this patch:

- If a parsed DNS message contains a TSIG RR, save the segment of the
original DNS message data that will later be used to validate the TSIG.
This is everything from the beginning of the header &#40;with the arcount
decremented&#41; up to but not including the last RR &#40;the TSIG&#41;.

- Add a sig_data&#40;&#41; method that is used by Net::DNS::RR::TSIG to acquire
the data from a packet to be used for computing a signature. For a
parsed message, this returns the data saved as described above. For a
constructed packet, this performs the fake clone and serialization that
used to be coded in Net::DNS::RR::TSIG-&gt;rr_rdata&#40;&#41;.

- Add a validate_tsig&#40;&#41; method that takes a reference Net::DNS::RR::TSIG
&#40;from which the key and algorithm are used&#41;, and a boolean indicating
whether the message is an answer &#40;if so, the request MAC, also drawn
from the supplied Net::DNS::RR::TSIG is prepended to the data before
signing&#41;. validate_tsig&#40;&#41; returns an RCODE that may include one of the
extended values added to %Net::DNS::rcodesbyvalue earlier.

In DNS/RR/TSIG.pm:

- Add a mac_binary&#40;&#41; method that returns the packed length+MAC structure
used for signing.

- Modify the sig_data&#40;&#41; method to rely on Net::DNS::Packet-&gt;sig_data&#40;&#41;
instead of cloning and serializing the packet data.

- Remove the stub implementation that adds a member {&#34;request_mac&#34;} to
the data before signing; this does not appear to be supported by any
other code or documented in the API. Hopefully no one is relying on it.

- Add a sign_data&#40;&#41; method to invoke the signing function. This is
invoked by Net::DNS::Packet-&gt;validate_tsig&#40;&#41; to generate the final
signature for comparison.

- Modify rr_rdata&#40;&#41; to use sign_data&#40;&#41; instead of directly invoking the
signing function.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net-DNS-tsig-validation.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/Net/DNS.pm
===================================================================
--- lib/Net/DNS.pm	&#40;revision 846&#41;
+++ lib/Net/DNS.pm	&#40;working copy&#41;
@@ -330,6 +330,9 @@
     &#39;NXRRSET&#39;   =&gt; 8,       # RFC 2136
     &#39;NOTAUTH&#39;   =&gt; 9,       # RFC 2136
     &#39;NOTZONE&#39;   =&gt; 10,      # RFC 2136
+    &#39;BADSIG&#39;    =&gt; 16,      # RFC 2845 &#40;only valid in TSIG error&#41;
+    &#39;BADKEY&#39;    =&gt; 17,      # RFC 2845 &#40;only valid in TSIG error&#41;
+    &#39;BADTIME&#39;   =&gt; 18,      # RFC 2845 &#40;only valid in TSIG error&#41;
 &#41;;
 %rcodesbyval = reverse %rcodesbyname;
 
Index: lib/Net/DNS/Packet.pm
===================================================================
--- lib/Net/DNS/Packet.pm	&#40;revision 846&#41;
+++ lib/Net/DNS/Packet.pm	&#40;working copy&#41;
@@ -311,14 +311,71 @@
 	undef $self-&gt;{offset};
 	my $arcount = $self-&gt;{header}-&gt;arcount;
 	my $rr;
+	my $lastoffset;
 	while &#40; $arcount-- &#41; {
+		$lastoffset = $offset;
 		&#40;$rr, $offset&#41; = Net::DNS::RR-&gt;parse&#40;$data, $offset&#41;;
 		push&#40;@rr, $rr&#41;;
 	}
+	# If last RR is a TSIG, save the portion of the original data
+	# that would be needed for validation. It is not generally
+	# possible to reconstruct this from the parsed packet because
+	# different DNS implementations do DNS label compression
+	# differently.
+	if &#40;defined &#40;$rr&#41; &#38;&#38; &#40;$rr-&gt;type eq &#39;TSIG&#39;&#41;&#41; {
+		my &#40;$fakeheader, $headeroffset&#41; = Net::DNS::Header-&gt;parse&#40;$data&#41;;
+		$fakeheader-&gt;arcount&#40;$fakeheader-&gt;arcount - 1&#41;;
+		my $sigdata = $fakeheader-&gt;data;
+		$sigdata .= substr &#40;$$data, $headeroffset, $lastoffset - $headeroffset&#41;;
+		$self-&gt;{sig_data} = $sigdata;
+		$self-&gt;{tsig_rr} = $rr;
+	} else {
+		undef $self-&gt;{sig_data};
+		undef $self-&gt;{tsig_rr};
+	}
+
 	@{$self-&gt;{additional}} = @rr;
 }
 
 
+=head2 sigdata
+
+    $sigdata = $packet-&gt;sig_data;
+
+Returns the data that would be used to compute a TSIG signature for this
+packet. For a query packet, this is simply the serialized data, without any
+associated TSIG RR. For an answer we received from a nameserver, this is the
+original packet data, with the TSIG RR removed.
+
+=cut
+
+sub sig_data {
+	my &#40;$self&#41; = @_;
+	my $newpacket;
+
+	# If this was an answer with TSIG, we already have it.
+	return $self-&gt;{sig_data} if &#40;exists &#40;$self-&gt;{tsig_rr}&#41; &#38;&#38; exists &#40;$self-&gt;{sig_data}&#41;&#41;;
+
+	# If there&#39;s no TSIG on this packet, easy.
+	my @additional = @{$self-&gt;{additional}};
+	return $self-&gt;data unless &#40;scalar &#40;@additional&#41; &#38;&#38; &#40;$additional[$#additional]-&gt;type eq &#39;TSIG&#39;&#41;&#41;;
+
+	# Fake up a copy of the packet without the TSIG and serialize that.
+	# Note: this code was originally in RR/TSIG.pm. It belonged here.
+	bless&#40;$newpacket = {},&#34;Net::DNS::Packet&#34;&#41;;
+	%{$newpacket} = %{$self};
+	bless&#40;$newpacket-&gt;{&#34;header&#34;} = {},&#34;Net::DNS::Header&#34;&#41;;
+	$newpacket-&gt;{&#34;additional&#34;} = [];
+	%{$newpacket-&gt;{&#34;header&#34;}} = %{$self-&gt;{&#34;header&#34;}};
+	@{$newpacket-&gt;{&#34;additional&#34;}} = @{$self-&gt;{&#34;additional&#34;}};
+	shift&#40;@{$newpacket-&gt;{&#34;additional&#34;}}&#41;;
+	$newpacket-&gt;{&#34;header&#34;}{&#34;arcount&#34;}--;
+	$newpacket-&gt;{&#34;compnames&#34;} = {};
+
+	return $newpacket-&gt;data;
+}
+
+
 =head2 print
 
     $packet-&gt;print;
@@ -672,6 +729,56 @@
 
 
 
+=head2 validate_tsig
+
+    $tsig_rcode = $packet-&gt;validate_tsig&#40;$tsig_rr, $isanswer&#41;;
+
+Validates the TSIG RR on a packet, using the provided TSIG. The provided
+TSIG name and algorithm must match the TSIG on the packet being validated.
+The validity period of TSIG on the packet must include the current time.
+If the packet is an answer packet, the validating TSIG must be from the
+corresponding query, since the query TSIG MAC must be included in the
+validation stream. The second argument is a boolean indicating whether the
+packet to be validated is an answer.
+
+Returns a TSIG RCODE indicating validation result. For a successful
+validation, this will be NOERROR. Otherwise, the result will be FORMERR,
+BADKEY, BADSIG, or BADTIME.
+
+=cut
+
+sub validate_tsig {
+	my &#40;$self, $tsig, $isanswer&#41; = @_;
+
+	# Force parsing of the packet.
+	$self-&gt;additional;
+
+	return $Net::DNS::rcodesbyname{FORMERR} unless &#40;exists &#40;$self-&gt;{tsig_rr}&#41; &#38;&#38; defined &#40;$tsig&#41;&#41;;
+
+	my $a = $self-&gt;{tsig_rr};
+
+	return $Net::DNS::rcodesbyname{BADKEY} unless &#40;lc&#40;$a-&gt;name&#41; eq lc&#40;$tsig-&gt;name&#41;&#41;;
+	return $Net::DNS::rcodesbyname{BADKEY} unless &#40;lc&#40;$a-&gt;algorithm&#41; eq lc&#40;$tsig-&gt;algorithm&#41;&#41;;
+
+	my $now = time;
+	return $Net::DNS::rcodesbyname{BADTIME} unless &#40;&#40;$a-&gt;time_signed + $a-&gt;fudge &gt;= $now&#41; &#38;&#38; &#40;$a-&gt;time_signed - $a-&gt;fudge &lt;= $now&#41;&#41;;
+
+	my $sigdata = &#39;&#39;;
+
+	# If this is an answer, include the MAC from the original TSIG.
+	$sigdata .= $tsig-&gt;mac_binary if &#40;$isanswer&#41;;
+
+	$sigdata .= $a-&gt;sig_data &#40;$self&#41;;
+
+	my $sig = $tsig-&gt;sign_data&#40;$sigdata&#41;;
+
+	return $Net::DNS::rcodesbyname{BADSIG} if &#40;$sig ne pack&#40;&#39;H*&#39;, $a-&gt;mac&#41;&#41;;
+
+	return $Net::DNS::rcodesbyname{NOERROR};
+}
+
+
+
 =head2 sign_sig0
 
 SIG0 support is provided through the Net::DNS::RR::SIG class. This class is not part
Index: lib/Net/DNS/RR/TSIG.pm
===================================================================
--- lib/Net/DNS/RR/TSIG.pm	&#40;revision 846&#41;
+++ lib/Net/DNS/RR/TSIG.pm	&#40;working copy&#41;
@@ -105,6 +105,12 @@
 	my $mac = unpack&#40;&#34;H*&#34;, $self-&gt;{&#34;mac&#34;}&#41; if defined&#40;$self-&gt;{&#34;mac&#34;}&#41;;
 	return $mac;
 }
+ 
+sub mac_binary {
+	my $self = shift;
+	return undef unless defined&#40;$self-&gt;{&#34;mac&#34;}&#41;;
+	return pack &#40;&#39;n&#39;, length&#40;$self-&gt;{&#34;mac&#34;}&#41;&#41; . $self-&gt;{&#34;mac&#34;};
+}
 
 sub rdatastr {
 	my $self = shift;
@@ -127,28 +133,14 @@
 }
 
 # return the data that needs to be signed/verified. This is useful for
-# external TSIG verification routines
+# external TSIG verification routines. This does not include any request
+# MAC prefix.
 sub sig_data {
 	my &#40;$self, $packet&#41; = @_;
-	my &#40;$newpacket, $sigdata&#41;;
 
-	# XXX this is horrible.  $pkt = Net::DNS::Packet-&gt;clone&#40;$packet&#41;; maybe?
-	bless&#40;$newpacket = {},&#34;Net::DNS::Packet&#34;&#41;;
-	%{$newpacket} = %{$packet};
-	bless&#40;$newpacket-&gt;{&#34;header&#34;} = {},&#34;Net::DNS::Header&#34;&#41;;
-	$newpacket-&gt;{&#34;additional&#34;} = [];
-	%{$newpacket-&gt;{&#34;header&#34;}} = %{$packet-&gt;{&#34;header&#34;}};
-	@{$newpacket-&gt;{&#34;additional&#34;}} = @{$packet-&gt;{&#34;additional&#34;}};
-	shift&#40;@{$newpacket-&gt;{&#34;additional&#34;}}&#41;;
-	$newpacket-&gt;{&#34;header&#34;}{&#34;arcount&#34;}--;
-	$newpacket-&gt;{&#34;compnames&#34;} = {};
+	my $sigdata = &#39;&#39;;
+	$sigdata .= $packet-&gt;sig_data;
 
-	# Add the request MAC if present &#40;used to validate responses&#41;.
-	$sigdata .= pack&#40;&#34;H*&#34;, $self-&gt;{&#34;request_mac&#34;}&#41;
-	    if $self-&gt;{&#34;request_mac&#34;};
-
-	$sigdata .= $newpacket-&gt;data;
-
 	# Don&#39;t compress the record &#40;key&#41; name.
 	my $tmppacket = Net::DNS::Packet-&gt;new&#40;&#34;&#34;&#41;;
 	$sigdata .= $tmppacket-&gt;dn_comp&#40;lc&#40;$self-&gt;{&#34;name&#34;}&#41;, 0&#41;;
@@ -169,7 +161,14 @@
 	
 	return $sigdata;
 }
+ 
+sub sign_data {
+	my &#40;$self, $data&#41; = @_;
 
+	return &#38;{$self-&gt;{&#34;sign_func&#34;}}&#40;$self-&gt;{&#34;key&#34;}, $data&#41; if &#40;exists $self-&gt;{&#34;key&#34;}&#41;;
+	return &#39;&#39;;
+}
+
 sub rr_rdata {
 	my &#40;$self, $packet, $offset&#41; = @_;
 	my $rdata = &#34;&#34;;
@@ -179,7 +178,7 @@
 		my $sigdata = $self-&gt;sig_data&#40;$packet&#41;;
 
 		# and call the signing function
-		$self-&gt;{&#34;mac&#34;} = &#38;{$self-&gt;{&#34;sign_func&#34;}}&#40;$self-&gt;{&#34;key&#34;}, $sigdata&#41;;
+		$self-&gt;{&#34;mac&#34;} = $self-&gt;sign_data &#40;$sigdata&#41;;
 		$self-&gt;{&#34;mac_size&#34;} = length&#40;$self-&gt;{&#34;mac&#34;}&#41;;
 
 		# construct the signed TSIG record
@@ -261,7 +260,14 @@
 Returns the message authentication code &#40;MAC&#41; as a string of hex
 characters.  The programmer must call a Net::DNS::Packet object&#39;s
 data method before this will return anything meaningful.
+ 
+=head2 mac_binary
 
+    &#40;$length, $mac&#41; = unpack &#40;&#39;nH*&#39;, $rr-&gt;mac_binary&#41;;
+
+Returns the serialized MAC length and data, as would be used for
+encoding the MAC in a signature computation.
+
 =head2 original_id
 
     $rr-&gt;original_id&#40;12345&#41;;
@@ -298,7 +304,13 @@
 Returns the packet packed according to RFC2845 in a form for signing. This
 is only needed if you want to supply an external signing function, such as is 
 needed for TSIG-GSS. 
+ 
+=head2 sign_data
 
+     my $mac = $tsig-&gt;sign_data&#40;$bytes&#41;;
+
+Returns the MAC computed using the TSIG&#39;s signing algorithm and key.
+
 =head2 sign_func
 
      sub my_sign_fn&#40;$$&#41; {
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;11&nbsp;23:19:12&nbsp;2010</span>
    <span class="description">bitcard [...] antibozo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] antibozo.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 11 18:36:09 2010, antibozo wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - Add a validate_tsig&#40;&#41; method that takes a reference Net::DNS::RR::TSIG
&gt; &#40;from which the key and algorithm are used&#41;, and a boolean indicating
&gt; whether the message is an answer &#40;if so, the request MAC, also drawn
&gt; from the supplied Net::DNS::RR::TSIG is prepended to the data before
&gt; signing&#41;. validate_tsig&#40;&#41; returns an RCODE that may include one of the
&gt; extended values added to %Net::DNS::rcodesbyvalue earlier.
</div>
It occurs to me now that the answer boolean is unnecessary. The answer
status can be retrieved from $packet-&gt;header-&gt;qr.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;13&nbsp;23:52:08&nbsp;2010</span>
    <span class="description">bitcard [...] antibozo.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bitcard [...] antibozo.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am working on improving the patch to incorporate the previous
observation and to include automatic TSIG validation within
Resolver/Base.pm. This adds additional complexity within
Resolver-&gt;axfr&#40;&#41; because this method parses multiple envelopes. The TSIG
validation algorithm on multiple envelopes is somewhat more complex.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;14&nbsp;02:21:07&nbsp;2010</span>
    <span class="description">OLAF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

Thank you for working on this. Glancing over the patch it seems to be more than useful. I am 
looking forward to your improvements and will then assess the patches in more detail.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;14&nbsp;02:21:10&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;14&nbsp;02:21:13&nbsp;2010</span>
    <span class="description">OLAF [...] cpan.org -  Given to OLAF</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;24&nbsp;21:55:24&nbsp;2013</span>
    <span class="description">rwfranks [...] acm.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> rwfranks [...] acm.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Implementation on SVN trunk and will appear in 0.73.

Assuming your local BIND is configured for the shared key, you should be able to do this:

   $query = new Net::DNS::Packet&#40; &#39;foo.example&#39;, &#39;A&#39; &#41;;

   $query-&gt;sign_tsig&#40; &#39;Khmac-sha512.example.+165+01018.key&#39; &#41;;

   $reply = $resolver-&gt;send&#40; $query &#41;;

   $verified = $reply-&gt;verify&#40; $query &#41;;
   die $reply-&gt;verifyerr unless $verified;



On Mon Jan 11 18:36:09 2010, antibozo wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The design of Net::DNS::Packet makes it impossible to validate TSIG
&gt; signatures.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;13&nbsp;09:21:20&nbsp;2013</span>
    <span class="description">NLNETLABS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 0.73
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;13&nbsp;09:21:21&nbsp;2013</span>
    <span class="description">NLNETLABS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
