<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #75841 for Net-SSLeay: libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #75841 for Net-SSLeay: libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Net-SSLeay">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Net-SSLeay">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Net-SSLeay">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Net-SSLeay">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">75841</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">13.3 hours (800 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Net-SSLeay">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MIKEM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
carnil [...] debian.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
kmx [...] cpan.org

<br />
info [...] maximka.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




debug+pthreads_self_hack_r321.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1052985/550703/debug%2Bpthreads_self_hack_r321.diff">
Wed Mar 21 07:45:42 2012 (2.3k) by kmx [...] volny.cz
</a>
</font></li>
</ul>


debug_messages_r321.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1052958/550678/debug_messages_r321.diff">
Wed Mar 21 05:19:43 2012 (1.8k) by kmx [...] volny.cz
</a>
</font></li>
</ul>


more_xs_debug_diagnostics_r331.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1055904/552447/more_xs_debug_diagnostics_r331.diff">
Wed Mar 28 08:02:23 2012 (1.8k) by kmx [...] volny.cz
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1056917/552958/signature.asc">
Sat Mar 31 03:19:02 2012 (836b) by carnil [...] debian.org
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/1052911/550647/signature.asc">
Wed Mar 21 02:36:44 2012 (836b) by carnil [...] debian.org
</a>
</font></li>
</ul>


threading_fix_UNTESTED_r316.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1052012/550126/threading_fix_UNTESTED_r316.diff">
Mon Mar 19 08:51:02 2012 (3.9k) by kmx [...] volny.cz
</a>
</font></li>
</ul>


threading_no_cleanup_r316.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1052174/550225/threading_no_cleanup_r316.diff">
Mon Mar 19 15:30:24 2012 (4.8k) by kmx [...] volny.cz
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=75841">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051404" href="/Public/Bug/Display.html?id=75841#txn-1051404">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;17&nbsp;07:46:03&nbsp;2012</span>
    <span class="description">CARNIL [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> CARNIL [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl
 process</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051404/549759/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549759">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi

This bug has been forwarded from <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/661566">http://bugs.debian.org/661566</a></span>

Package: libnet-ssleay-perl
Version: 1.45-1
Severity: important

Apache segfaults when this module is included in a mod_perl application and
mod_ssl is enabled.  I am using the prefork MPM.

To reproduce:
a2enmod ssl
a2enmod perl
echo &#34;PerlModule Net::SSLeay&#34; &gt;/etc/apache2/conf.d/sslbug.conf
service apache2 restart

1.43-1 is also broken in this regard.
1.42-1+b1 works.

-- System Information:
Debian Release: wheezy/sid
  APT prefers unstable
  APT policy: &#40;500, &#39;unstable&#39;&#41;, &#40;500, &#39;testing&#39;&#41;
Architecture: amd64 &#40;x86_64&#41;

Kernel: Linux 3.2.0-1-amd64 &#40;SMP w/2 CPU cores&#41;
Locale: LANG=en_US.UTF-8, LC_CTYPE=en_US.UTF-8 &#40;charmap=UTF-8&#41;
Shell: /bin/sh linked to /bin/bash

Versions of packages libnet-ssleay-perl depends on:
ii  libc6                       2.13-26
ii  libssl1.0.0                 1.0.0g-1
ii  perl                        5.14.2-7
ii  perl-base [perlapi-5.14.2]  5.14.2-7

libnet-ssleay-perl recommends no packages.

Versions of packages libnet-ssleay-perl suggests:
ii  perl [libmime-base64-perl]  5.14.2-7

-- no debconf information

-- 
_ivan


This was easily reproducible for me installing on a Debian sid system
apache2-mpm-prefork, libapache2-mod-perl2 and libnet-ssleay-perl &#40;in
Version 1.45&#41;. Then

echo &#34;PerlModule Net::SSLeay&#34; &gt;/etc/apache2/conf.d/sslbug.conf

Restarting now apache2, let it segfault. Niko Tyni has posted some more
information on
<span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=661566#26">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=661566#26</a></span>

Thanks in advance,
Salvatore Bonaccorso, Debian Perl Group
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051586" href="/Public/Bug/Display.html?id=75841#txn-1051586">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;02:50:51&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl  process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 18 Mar 2012 16:49:51 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051586/549879/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/549879">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">kmx, are you listening in on this one?

It appears that in the tst situation described below, the CLONE&#40;...&#41; and 
END&#40;...&#41; functions are called multiple times during web server startup. 

Your END code calls  
MUTEX_DESTROY&#40;&#38;LIB_init_mutex&#41;;
and
openssl_threads_cleanup&#40;&#41;;

And I dont think thats right. If END is called at the end of a thread as 
opposed to the end of the nterpreter &#40;is that when its called? couldnt find 
any clear doc on that&#41;, I dont think LIB_init_mutex should be destroyed then.

Further, 
openssl_threads_cleanup
has code like this:

    if &#40;!GLOBAL_openssl_mutex&#41; return;
    .....
   Safefree&#40;GLOBAL_openssl_mutex&#41;;

and nothing ion the code ever clears GLOBAL_openssl_mutex.

so if it is called multiple times, Safefree&#40;GLOBAL_openssl_mutex&#41; will be 
called multiple times, and that is the cause of the crash reported below.

So, perhaps the END function is not required at all?
And openssl_threads_cleanup should protect itself against multiple calls?
And openssl_threads_cleanup should only be called when the whole interpreter 
exits &#40;how can we catch that?&#41;


Cheers.

On Saturday, March 17, 2012 07:46:05 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sat Mar 17 07:46:03 2012: Request 75841 was acted upon.
&gt; Transaction: Ticket created by CARNIL
&gt;        Queue: Net-SSLeay
&gt;      Subject: libnet-ssleay-perl: Segfault when lniked into an
&gt; Apache/mod_ssl/mod_perl process
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: &#40;no value&#41;
&gt;        Owner: Nobody
&gt;   Requestors: carnil@debian.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; 
&gt; Hi
&gt; 
&gt; This bug has been forwarded from <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/661566">http://bugs.debian.org/661566</a></span>
&gt; 
&gt; Package: libnet-ssleay-perl
&gt; Version: 1.45-1
&gt; Severity: important
&gt; 
&gt; Apache segfaults when this module is included in a mod_perl application and
&gt; mod_ssl is enabled.  I am using the prefork MPM.
&gt; 
&gt; To reproduce:
&gt; a2enmod ssl
&gt; a2enmod perl
&gt; echo &#34;PerlModule Net::SSLeay&#34; &gt;/etc/apache2/conf.d/sslbug.conf
&gt; service apache2 restart
&gt; 
&gt; 1.43-1 is also broken in this regard.
&gt; 1.42-1+b1 works.
&gt; 
&gt; -- System Information:
&gt; Debian Release: wheezy/sid
&gt;   APT prefers unstable
&gt;   APT policy: &#40;500, &#39;unstable&#39;&#41;, &#40;500, &#39;testing&#39;&#41;
&gt; Architecture: amd64 &#40;x86_64&#41;
&gt; 
&gt; Kernel: Linux 3.2.0-1-amd64 &#40;SMP w/2 CPU cores&#41;
&gt; Locale: LANG=en_US.UTF-8, LC_CTYPE=en_US.UTF-8 &#40;charmap=UTF-8&#41;
&gt; Shell: /bin/sh linked to /bin/bash
&gt; 
&gt; Versions of packages libnet-ssleay-perl depends on:
&gt; ii  libc6                       2.13-26
&gt; ii  libssl1.0.0                 1.0.0g-1
&gt; ii  perl                        5.14.2-7
&gt; ii  perl-base [perlapi-5.14.2]  5.14.2-7
&gt; 
&gt; libnet-ssleay-perl recommends no packages.
&gt; 
&gt; Versions of packages libnet-ssleay-perl suggests:
&gt; ii  perl [libmime-base64-perl]  5.14.2-7
&gt; 
&gt; -- no debconf information
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051589" href="/Public/Bug/Display.html?id=75841#txn-1051589">#</a>      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;02:50:54&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051958" href="/Public/Bug/Display.html?id=75841#txn-1051958">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;04:21:12&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Cc KMX added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051961" href="/Public/Bug/Display.html?id=75841#txn-1051961">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;05:31:40&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051961/550092/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550092">with headers</a>
<br />
<span class="downloadcontenttype">text/html 5.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; kmx, are you listening in on this one?<br>
</div><br>

Yes I have added myself to cc:<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It appears that in the tst situation described below, the<br>

&gt; CLONE(...) and END(...) functions are called multiple times<br>

&gt; during web server startup.<br>
</div><br>

Multiple calls of CLONE() of IMHO OK (it is called for every new thread) and should not cause a crash, however multiple calls to END() should not happen - and as far as I have tested (I really spend some time on this) the END() is called only once when perl interpret is finished (with one exception related to perl's fork() emulation on MS Windows platform - but we have a workaround for this).<br>

<br>

Anyhow, I do not a reason why END(...) should be called at webserver startup (I expect it to be called at shutdown)<br>

<br>

See <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlmod.html">http://perldoc.perl.org/perlmod.html</a></span> - quote:<br>

<br>

&quot;An END code block is executed as late as possible, that is, after perl has finished running the program and just before the interpreter is being exited, even if it is exiting as a result of a die() function.&quot;<br>

<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ...<br>

&gt;<br>

&gt; Further,<br>

&gt; openssl_threads_cleanup<br>

&gt; has code like this:<br>

&gt;<br>

&gt; if (!GLOBAL_openssl_mutex) return;<br>

&gt; .....<br>

&gt; Safefree(GLOBAL_openssl_mutex);<br>

&gt;<br>

&gt; and nothing ion the code ever clears GLOBAL_openssl_mutex.<br>

&gt;<br>

&gt; so if it is called multiple times, Safefree(GLOBAL_openssl_mutex)<br>

&gt; will be called multiple times, and that is the cause of the crash<br>

&gt; reported below.<br>
</div><br>

Well, to play safe we can add after each Safefree a line like this:<br>

<br>

Safefree(any_pointer);<br>

any_pointer = NULL;<br>

<br>

It should go to 2 places where we call Safefree(...):<br>

- openssl_dynlocking_destroy_function()<br>

- openssl_threads_cleanup()<br>

(IMHO you can add&amp;commit this as it make things only better)<br>

<br>

But in my opinion it is not the core of the problem.<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So, perhaps the END function is not required at all?<br>
</div><br>

I do not thik so, maybe the END() is not the best place but we should call openssl_threads_cleanup somewhere.<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And openssl_threads_cleanup should protect itself against multiple<br>

&gt; calls?<br>
</div><br>

Yes this is correct.<br>

<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; And openssl_threads_cleanup should only be called when the whole<br>

&gt; interpreter exits (how can we catch that?)<br>
</div><br>

Yes this is correct, normally using END() should assure that we call it just once just before perl interpreter is being exited.<br>

<br>

However there are some gotchas connected to mod_perl mode of operation.<br>

<br>

Here is my theory (I have not Linux+Apache+mod_perl+mod_ssl+net-ssleay enviroment to test it right now):<br>

<br>

1/ The biggest problem is that we have double openssl initialization issue<br>

- one from Apache's mod_ssl - see httpd-2.2.22\modules\ssl\ssl_util.c - functions ssl_util_thread_setup/ssl_util_thread_cleanup<br>

- the second from Net::SSleay<br>

<br>

I am not sure what initialization happes first but I guess that mod_ssl is loaded before mod_perl+net-ssleay.<br>

<br>

Double initialization is an issue with:<br>

- multitreading related stuff<br>

- multiple &quot;SSLeay_add_ssl_algorithms()&quot; calls (you perhaps remember that one)<br>

<br>

I think this is the reason why it crashes - simmply:<br>

- mod_ssl initializes openssl library (with all thread related mutexes and callbacks)<br>

- Net::SSLeay does openssl initialization in its way again<br>

- this should inevitably crash<br>

<br>

2/ I am not an expert on mod_perl but according to <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.apache.org/docs/2.0/user/intro/overview.html#Threads_Support">http://perl.apache.org/docs/2.0/user/intro/overview.html#Threads_Support</a></span> it is hard to guess how Apache with threaded MPMs works with Net::SSLeay.<br>

<br>

According to link above it seems that each Apache thread creates it own perl interpret within the same Apache process. I am not sure what exactly happens when you load Net::SSleay into it.<br>

<br>

Current Net::SSLeay implementation is ready for scenario like this:<br>

a/ perl starts (as a new process)<br>

b/ via &quot;use Net::SSLeay&quot; (with one perl interpret is running) we invoke BOOT: section of SSLeay.sx<br>

c/ Boot: section calls openssl_threads_init()<br>

d/ shortly after &quot;use Net::SSLeay&quot; we usually call &quot;SSLeay_add_ssl_algorithms()&quot;<br>

e/ later in the perl code we create some new threads via &quot;threads-&gt;new(\&amp;do_the_job)&quot;<br>

<br>

Whereas mod_perl scenario is IMHO something like this (not sure about the order)<br>

a/ Apache starts (as a new process)<br>

b/ Apache loads mod_ssl module (which does all necessary openssl initialization)<br>

c/ Apache creates a couple of MPM threads + starts couple of perl interprets<br>

d/ Then you try to load Net::SSleay<br>

e/ Net::SSleay is not aware about the fact that openssl library was already initialized and call initialization again<br>

f/ Note that at this point we have multiple perl interprets - I am not sure how many times Net::SSLeay's BOOT: section is gonna be called<br>

g/ An you are right as there are multiple perl interprets the END(...) section is called for each perl interpret (but it should happen IMHO at Apache shutdown)<br>

<br>

My conclusion:<br>

<br>

1/ If we can somehow detect that thread related setup of openssl lib was already done we can simply skip our initialization<br>

<br>

2/ As mod_ssl calls itself SSL_library_init() which is an alias for &quot;SSLeay_add_ssl_algorithms()&quot; I am not sure what happens when you call it again from perl via Net::SSLeay::SSL_library_init() - I expect a crash<br>

<br>

<br>

--<br>

kmx<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051964" href="/Public/Bug/Display.html?id=75841#txn-1051964">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;05:51:55&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Mar 2012 19:50:32 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051964/550095/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550095">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Monday, March 19, 2012 05:31:42 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; kmx, are you listening in on this one?
</div>&gt; 
&gt; Yes I have added myself to cc:
</div>
Thanks!
Value your feedback.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; It appears that in the tst situation described below, the
&gt; &gt; CLONE&#40;...&#41; and END&#40;...&#41; functions are called multiple times
&gt; &gt; during web server startup.
</div>&gt; 
&gt; Multiple calls of CLONE&#40;&#41; of IMHO OK &#40;it is called for every new thread&#41; and
&gt; should not cause a crash, however multiple calls to END&#40;&#41; should not happen
&gt; - and as far as I have tested &#40;I really spend some time on this&#41; the END&#40;&#41;
&gt; is called only once when perl interpret is finished &#40;with one exception
&gt; related to perl&#39;s fork&#40;&#41; emulation on MS Windows platform - but we have a
&gt; workaround for this&#41;.
</div>
Yes, I saw that.

But, according to 

<span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/threads.html">http://perldoc.perl.org/threads.html</a></span>

&#34;These END blocks will then be executed when the thread&#39;s interpreter is 
destroyed &#40;i.e., either during a -&gt;join&#40;&#41; call, or at program termination&#41;.&#34;

I havent been able to generate double END calls in my simple sample code, but 
I have proved that Apach2  mod_perl certainly does call END multiple times

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Anyhow, I do not a reason why END&#40;...&#41; should be called at webserver startup
&gt; &#40;I expect it to be called at shutdown&#41;
&gt; 
&gt; See <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlmod.html">http://perldoc.perl.org/perlmod.html</a></span> - quote:
&gt; 
&gt; &#34;An END code block is executed as late as possible, that is, after perl has
&gt; finished running the program and just before the interpreter is being
&gt; exited, even if it is exiting as a result of a die&#40;&#41; function.&#34;
&gt; 
<div class="message-stanza open">&gt; &gt; ...
&gt; &gt; 
&gt; &gt; Further,
&gt; &gt; openssl_threads_cleanup
&gt; &gt; has code like this:
&gt; &gt; 
&gt; &gt; if &#40;!GLOBAL_openssl_mutex&#41; return;
&gt; &gt; .....
&gt; &gt; Safefree&#40;GLOBAL_openssl_mutex&#41;;
&gt; &gt; 
&gt; &gt; and nothing ion the code ever clears GLOBAL_openssl_mutex.
&gt; &gt; 
&gt; &gt; so if it is called multiple times, Safefree&#40;GLOBAL_openssl_mutex&#41;
&gt; &gt; will be called multiple times, and that is the cause of the crash
&gt; &gt; reported below.
</div>&gt; 
&gt; Well, to play safe we can add after each Safefree a line like this:
&gt; 
&gt; Safefree&#40;any_pointer&#41;;
&gt; any_pointer = NULL;
&gt; 
&gt; It should go to 2 places where we call Safefree&#40;...&#41;:
&gt; - openssl_dynlocking_destroy_function&#40;&#41;
&gt; - openssl_threads_cleanup&#40;&#41;
&gt; &#40;IMHO you can add&#38;commit this as it make things only better&#41;
&gt; 
&gt; But in my opinion it is not the core of the problem.
</div>
I agree. I think if there can be &#40;and there are&#41; multiple calls to END within 
a process, then we need to make sure that END is not really the end of 
Net::SSLeay. If it can be called multiple times within a single process, even 
during startup, then it should not call

MUTEX_DESTROY&#40;&#38;LIB_init_mutex&#41;;

and it should not call openssl_threads_cleanup&#40;&#41;;

Therefore, I dont think we should have END at all.
Then, you might ask, how will openssl_threads_cleanup&#40;&#41; get called? I cant see 
a way to call it &#34;just before the process &#40;as opposed to a thread&#41; really 
exits&#34;. But what would be the problem if we did not call it? A little leak 
that is only evident at exit time? There would not be a per-thread leak, and 
there are no per-thread resources that we need to free.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; So, perhaps the END function is not required at all?
</div>&gt; 
&gt; I do not thik so, maybe the END&#40;&#41; is not the best place but we should call
&gt; openssl_threads_cleanup somewhere.
&gt; 
<div class="message-stanza open">&gt; &gt; And openssl_threads_cleanup should protect itself against multiple
&gt; &gt; calls?
</div>&gt; 
&gt; Yes this is correct.
&gt; 
<div class="message-stanza open">&gt; &gt; And openssl_threads_cleanup should only be called when the whole
&gt; &gt; interpreter exits &#40;how can we catch that?&#41;
</div>&gt; 
&gt; Yes this is correct, normally using END&#40;&#41; should assure that we call it just
&gt; once just before perl interpreter is being exited.
</div>
I used to think so too, but based on the above I now know and have observed 
that not to be the case.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; However there are some gotchas connected to mod_perl mode of operation.
&gt; 
&gt; Here is my theory &#40;I have not Linux+Apache+mod_perl+mod_ssl+net-ssleay
&gt; enviroment to test it right now&#41;:
&gt; 
&gt; 1/ The biggest problem is that we have double openssl initialization issue
&gt; - one from Apache&#39;s mod_ssl - see httpd-2.2.22\modules\ssl\ssl_util.c -
&gt; functions ssl_util_thread_setup/ssl_util_thread_cleanup
&gt; - the second from Net::SSleay
&gt; 
&gt; I am not sure what initialization happes first but I guess that mod_ssl is
&gt; loaded before mod_perl+net-ssleay.
&gt; 
&gt; Double initialization is an issue with:
&gt; - multitreading related stuff
&gt; - multiple &#34;SSLeay_add_ssl_algorithms&#40;&#41;&#34; calls &#40;you perhaps remember that
&gt; one&#41;
</div>
but only when called simultaneously by 2 threads, I think.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I think this is the reason why it crashes - simmply:
&gt; - mod_ssl initializes openssl library &#40;with all thread related mutexes and
&gt; callbacks&#41;
&gt; - Net::SSLeay does openssl initialization in its way again
&gt; - this should inevitably crash
</div>
Disagree, the immediate cause of the crash is double free of 
GLOBAL_openssl_mutex in openssl_threads_init
I have proved that is what happens, and that if I comment out the 
Safefree&#40;GLOBAL_openssl_mutex&#41;;
it does not crash.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 2/ I am not an expert on mod_perl but according to
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.apache.org/docs/2.0/user/intro/overview.html#Threads_Support">http://perl.apache.org/docs/2.0/user/intro/overview.html#Threads_Support</a></span> it
&gt; is hard to guess how Apache with threaded MPMs works with Net::SSLeay.
&gt; 
&gt; According to link above it seems that each Apache thread creates it own perl
&gt; interpret within the same Apache process. I am not sure what exactly
&gt; happens when you load Net::SSleay into it.
&gt; 
&gt; Current Net::SSLeay implementation is ready for scenario like this:
&gt; a/ perl starts &#40;as a new process&#41;
&gt; b/ via &#34;use Net::SSLeay&#34; &#40;with one perl interpret is running&#41; we invoke
&gt; BOOT: section of SSLeay.sx
&gt; c/ Boot: section calls openssl_threads_init&#40;&#41;
&gt; d/ shortly after &#34;use Net::SSLeay&#34; we usually call
&gt; &#34;SSLeay_add_ssl_algorithms&#40;&#41;&#34;
&gt; e/ later in the perl code we create some new threads via
&gt; &#34;threads-&gt;new&#40;\&#38;do_the_job&#41;&#34;
&gt; 
&gt; Whereas mod_perl scenario is IMHO something like this &#40;not sure about the
&gt; order&#41;
&gt; a/ Apache starts &#40;as a new process&#41;
&gt; b/ Apache loads mod_ssl module &#40;which does all necessary openssl
&gt; initialization&#41;
&gt; c/ Apache creates a couple of MPM threads + starts couple of perl interprets
&gt; d/ Then you try to load Net::SSleay
&gt; e/ Net::SSleay is not aware about the fact that openssl library was already
&gt; initialized and call initialization again
&gt; f/ Note that at this point we have multiple perl interprets - I am not sure
&gt; how many times Net::SSLeay&#39;s BOOT: section is gonna be called
&gt; g/ An you are right as there are multiple perl interprets the END&#40;...&#41;
&gt; section is called for each perl interpret &#40;but it should happen IMHO at
&gt; Apache shutdown&#41;
&gt; 
&gt; My conclusion:
&gt; 
&gt; 1/ If we can somehow detect that thread related setup of openssl lib was
&gt; already done we can simply skip our initialization
</div>
I dont believe that is possible, and in any case would not solve the crash we 
are seeing now.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 2/ As mod_ssl calls itself SSL_library_init&#40;&#41; which is an alias for
&gt; &#34;SSLeay_add_ssl_algorithms&#40;&#41;&#34; I am not sure what happens when you call it
&gt; again from perl via Net::SSLeay::SSL_library_init&#40;&#41; - I expect a crash
</div>

I think we should remove END and openssl_threads_cleanup&#40;&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1051968" href="/Public/Bug/Display.html?id=75841#txn-1051968">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;06:48:17&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Mar 2012 11:48:00 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1051968/550098/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550098">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; It appears that in the tst situation described below, the
&gt;&gt;&gt; CLONE&#40;...&#41; and END&#40;...&#41; functions are called multiple times
&gt;&gt;&gt; during web server startup.
&gt;&gt;&gt;        
</div>&gt;&gt; Multiple calls of CLONE&#40;&#41; of IMHO OK &#40;it is called for every new thread&#41; and
&gt;&gt; should not cause a crash, however multiple calls to END&#40;&#41; should not happen
&gt;&gt; - and as far as I have tested &#40;I really spend some time on this&#41; the END&#40;&#41;
&gt;&gt; is called only once when perl interpret is finished &#40;with one exception
&gt;&gt; related to perl&#39;s fork&#40;&#41; emulation on MS Windows platform - but we have a
&gt;&gt; workaround for this&#41;.
&gt;&gt;      
</div>&gt; Yes, I saw that.
&gt;
&gt; But, according to
&gt;
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/threads.html">http://perldoc.perl.org/threads.html</a></span>
&gt;
&gt; &#34;These END blocks will then be executed when the thread&#39;s interpreter is
&gt; destroyed &#40;i.e., either during a -&gt;join&#40;&#41; call, or at program termination&#41;.&#34;
&gt;
&gt; I havent been able to generate double END calls in my simple sample code, but
&gt; I have proved that Apach2  mod_perl certainly does call END multiple times
&gt;    
</div>
Hmm, I am starting to feel that you are right, END&#40;...&#41; is probably not 
gonna do correctly what we need to be done.

Although I still do not understand that during _startup_ the _END_ is 
called &#40;but it not important at the moment&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; ...
&gt;&gt;&gt;
&gt;&gt;&gt; Further,
&gt;&gt;&gt; openssl_threads_cleanup
&gt;&gt;&gt; has code like this:
&gt;&gt;&gt;
&gt;&gt;&gt; if &#40;!GLOBAL_openssl_mutex&#41; return;
&gt;&gt;&gt; .....
&gt;&gt;&gt; Safefree&#40;GLOBAL_openssl_mutex&#41;;
&gt;&gt;&gt;
&gt;&gt;&gt; and nothing ion the code ever clears GLOBAL_openssl_mutex.
&gt;&gt;&gt;
&gt;&gt;&gt; so if it is called multiple times, Safefree&#40;GLOBAL_openssl_mutex&#41;
&gt;&gt;&gt; will be called multiple times, and that is the cause of the crash
&gt;&gt;&gt; reported below.
&gt;&gt;&gt;        
</div>&gt;&gt; Well, to play safe we can add after each Safefree a line like this:
&gt;&gt;
&gt;&gt; Safefree&#40;any_pointer&#41;;
&gt;&gt; any_pointer = NULL;
&gt;&gt;
&gt;&gt; It should go to 2 places where we call Safefree&#40;...&#41;:
&gt;&gt; - openssl_dynlocking_destroy_function&#40;&#41;
&gt;&gt; - openssl_threads_cleanup&#40;&#41;
&gt;&gt; &#40;IMHO you can add&#38;commit this as it make things only better&#41;
&gt;&gt;
&gt;&gt; But in my opinion it is not the core of the problem.
&gt;&gt;      
</div>&gt; I agree. I think if there can be &#40;and there are&#41; multiple calls to END within
&gt; a process, then we need to make sure that END is not really the end of
&gt; Net::SSLeay. If it can be called multiple times within a single process, even
&gt; during startup, then it should not call
&gt;
&gt; MUTEX_DESTROY&#40;&#38;LIB_init_mutex&#41;;
&gt;
&gt; and it should not call openssl_threads_cleanup&#40;&#41;;
&gt;
&gt; Therefore, I dont think we should have END at all.
&gt; Then, you might ask, how will openssl_threads_cleanup&#40;&#41; get called? I cant see
&gt; a way to call it &#34;just before the process &#40;as opposed to a thread&#41; really
&gt; exits&#34;. But what would be the problem if we did not call it? A little leak
&gt; that is only evident at exit time? There would not be a per-thread leak, and
&gt; there are no per-thread resources that we need to free.
&gt;    
</div>
Definitely a call to MUTEX_DESTROY&#40;&#38;LIB_init_mutex&#41;; inside END&#40;&#41; is 
currently not ready to handle multiple calls.

Commenting out all we have now inside END&#40;...&#41; can probably be the 
easiest way to fix this. There are no significant leaks we should be 
worried about - we are only leaving openssl library in an unstable state 
as it might have some callbacks/mutexes pointed to a memory location&#40;s&#41; 
that will go away.

Or we can &#40;just idea not insisting on that&#41; do a similar thing to Win32 
END&#40;&#41; workaround - which means to allow to destroy/clean openssl 
threading only to the thread that has done the initialization &#40;check for 
GLOBAL_openssl_mutex_creator variable in SSLeay.xs&#41;.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; I think this is the reason why it crashes - simmply:
&gt;&gt; - mod_ssl initializes openssl library &#40;with all thread related mutexes and
&gt;&gt; callbacks&#41;
&gt;&gt; - Net::SSLeay does openssl initialization in its way again
&gt;&gt; - this should inevitably crash
&gt;&gt;      
</div>&gt; Disagree, the immediate cause of the crash is double free of
&gt; GLOBAL_openssl_mutex in openssl_threads_init
&gt; I have proved that is what happens, and that if I comment out the
&gt; Safefree&#40;GLOBAL_openssl_mutex&#41;;
&gt; it does not crash.
&gt;    
</div>
You are right &#40;assuming that you mean openssl_threads_cleanup not 
openssl_threads_init&#41;, maybe adding
   GLOBAL_openssl_mutex = NULL;
after Safefree&#40;GLOBAL_openssl_mutex&#41; could also work


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; 1/ If we can somehow detect that thread related setup of openssl lib was
&gt;&gt; already done we can simply skip our initialization
&gt;&gt;      
</div>&gt; I dont believe that is possible, and in any case would not solve the crash we
&gt; are seeing now.
&gt;    
</div>
Yes, it is not related to the END-crash discussed above but it seems to 
be possible as CRYPTO_get_locking_callback&#40;&#41; exists


My summary:

1/ Safefree&#40;GLOBAL_openssl_mutex&#41; in openssl_threads_cleanup should be 
followed by
GLOBAL_openssl_mutex = NULL;

2/ the way we &#40;well I put that in&#41; call MUTEX_DESTROY&#40;&#38;LIB_init_mutex&#41;; 
in END is buggy &#40;quick&#38;dirty fix is to comment out MUTEX_DESTROY&#40;&#41; from END&#41;

3/ the multiple END&#40;&#41; call prevention is currently implemented only for 
Win32 &#40;search for GLOBAL_openssl_mutex_creator&#41; - we can implement this 
also for pthreads or again quick&#38;dirty fix is to comment out 
openssl_threads_cleanup&#40;&#41; from END

In other words removing END&#40;&#41; completely will fix all of 1/,  2/,  3/

4/ We can try to add some kind of detection whether openssl library has 
already setup threading stuff or not &#40;via CRYPTO_get_locking_callback &#38; co.&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052012" href="/Public/Bug/Display.html?id=75841#txn-1052012">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;08:51:01&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Mar 2012 13:50:49 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052012/550125/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550125">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 656b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it 
is the best way to go.

But to be honest it is starting to become overcomplicated - so perhaps 
simply removing END&#40;&#41; + adding simple test for &#34;already initialized 
threading&#34; in openssl_threads_init&#40;&#41; would be enough.

It would really help me if you could put some debug warnings into
a/ BOOT: section
b/ END&#40;&#41;
c/ CLONE&#40;&#41;
and start apache+mod_perl+mod_ssl+net-ssleay

e.g.
warn&#40;&#34;inside BOOT pthread=%p deinit=%d\n&#34;, pthread_self&#40;&#41;, 
openssl_locking_should_be_deinitialized&#41;;

Just to have some idea about the order how perl interprets are 
loaded/cloned/ended under mod_perl

--
kmx
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052012/550126/threading_fix_UNTESTED_r316.diff">Download threading_fix_UNTESTED_r316.diff</a><br />
<span class="downloadcontenttype">text/x-diff 3.9k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052027" href="/Public/Bug/Display.html?id=75841#txn-1052027">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;09:30:52&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Mar 2012 14:30:31 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052027/550138/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550138">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 272b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; warn&#40;&#34;inside BOOT pthread=%p deinit=%d\n&#34;, pthread_self&#40;&#41;, openssl_locking_should_be_deinitialized&#41;;
&gt;    
</div>
or better:
warn&#40;&#34;inside BOOT tid=%d myperl=%p pthread=%p deinit=%d\n&#34;, 
get_my_thread_id&#40;&#41;, my_perl, pthread_self&#40;&#41;, 
openssl_locking_should_be_deinitialized&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052122" href="/Public/Bug/Display.html?id=75841#txn-1052122">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;13:20:48&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052122/550194/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550194">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 964b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it 
&gt; is the best way to go.
</div>
I got segfault on new installed wheezy, apache2-mpm-worker 2.2.22-2
with patched r316 too.

regards,
palik


On Mon Mar 19 08:51:01 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it 
&gt; is the best way to go.
&gt; 
&gt; But to be honest it is starting to become overcomplicated - so perhaps 
&gt; simply removing END&#40;&#41; + adding simple test for &#34;already initialized 
&gt; threading&#34; in openssl_threads_init&#40;&#41; would be enough.
&gt; 
&gt; It would really help me if you could put some debug warnings into
&gt; a/ BOOT: section
&gt; b/ END&#40;&#41;
&gt; c/ CLONE&#40;&#41;
&gt; and start apache+mod_perl+mod_ssl+net-ssleay
&gt; 
&gt; e.g.
&gt; warn&#40;&#34;inside BOOT pthread=%p deinit=%d\n&#34;, pthread_self&#40;&#41;, 
&gt; openssl_locking_should_be_deinitialized&#41;;
&gt; 
&gt; Just to have some idea about the order how perl interprets are 
&gt; loaded/cloned/ended under mod_perl
&gt; 
&gt; --
&gt; kmx
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052174" href="/Public/Bug/Display.html?id=75841#txn-1052174">#</a>      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;19&nbsp;15:30:24&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> carnil [...] debian.org, kmx [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 19 Mar 2012 20:30:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052174/550224/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550224">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 352b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it
&gt;&gt; is the best way to go.
&gt;&gt;      
</div>&gt; I got segfault on new installed wheezy, apache2-mpm-worker 2.2.22-2
&gt; with patched r316 too.
&gt;    
</div>
OK, let&#39;s try Mike&#39;s &#34;no-END/no-cleanup&#34; approach.

palik, could you please test enclosed threading_no_cleanup_r316.diff ?

Thanks.

--
kmx
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052174/550225/threading_no_cleanup_r316.diff">Download threading_no_cleanup_r316.diff</a><br />
<span class="downloadcontenttype">text/x-diff 4.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052757" href="/Public/Bug/Display.html?id=75841#txn-1052757">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;18:26:52&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">200 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052757/550529/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550529">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 648b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello All,

We have now posted an update to net-ssleay svn, commit 318 that should
fix this problem.

If the OP and another can please confirm this fixes the reported crash,
we will release a new dist.

Cheers.


On Mon Mar 19 15:30:24 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it
&gt; &gt;&gt; is the best way to go.
&gt; &gt;&gt;      
</div>&gt; &gt; I got segfault on new installed wheezy, apache2-mpm-worker 2.2.22-2
&gt; &gt; with patched r316 too.
&gt; &gt;    
</div>&gt; 
&gt; OK, let&#39;s try Mike&#39;s &#34;no-END/no-cleanup&#34; approach.
&gt; 
&gt; palik, could you please test enclosed threading_no_cleanup_r316.diff ?
&gt; 
&gt; Thanks.
&gt; 
&gt; --
&gt; kmx
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052760" href="/Public/Bug/Display.html?id=75841#txn-1052760">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;20&nbsp;18:27:00&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052911" href="/Public/Bug/Display.html?id=75841#txn-1052911">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;02:36:44&nbsp;2012</span>
    <span class="description">carnil [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> kmx [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 07:36:32 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> MIKEM via RT &lt;bug-Net-SSLeay [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Salvatore Bonaccorso &lt;carnil [...] debian.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052911/550646/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550646">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 482b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hey

On Tue, Mar 20, 2012 at 06:26:53PM -0400, MIKEM via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Hello All,
&gt; 
&gt; We have now posted an update to net-ssleay svn, commit 318 that should
&gt; fix this problem.
&gt; 
&gt; If the OP and another can please confirm this fixes the reported crash,
&gt; we will release a new dist.
</div>
I&#39;m not sure if I find time today, but I will try to check this today!

Many thanks for your fast reaction on that!

Regards,
Salvatore
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052911/550647/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 836b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052938" href="/Public/Bug/Display.html?id=75841#txn-1052938">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;04:24:03&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052938/550659/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550659">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 840b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

the module in r318 or current r321 enforce still segfault on apache start.

palik

On Tue Mar 20 18:26:52 2012, MIKEM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hello All,
&gt; 
&gt; We have now posted an update to net-ssleay svn, commit 318 that should
&gt; fix this problem.
&gt; 
&gt; If the OP and another can please confirm this fixes the reported crash,
&gt; we will release a new dist.
&gt; 
&gt; Cheers.
&gt; 
&gt; 
&gt; On Mon Mar 19 15:30:24 2012, kmx@volny.cz wrote:
<div class="message-stanza open">&gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it
&gt; &gt; &gt;&gt; is the best way to go.
&gt; &gt; &gt;&gt;      
</div>&gt; &gt; &gt; I got segfault on new installed wheezy, apache2-mpm-worker 2.2.22-2
&gt; &gt; &gt; with patched r316 too.
&gt; &gt; &gt;    
</div>&gt; &gt; 
&gt; &gt; OK, let&#39;s try Mike&#39;s &#34;no-END/no-cleanup&#34; approach.
&gt; &gt; 
&gt; &gt; palik, could you please test enclosed threading_no_cleanup_r316.diff ?
&gt; &gt; 
&gt; &gt; Thanks.
&gt; &gt; 
&gt; &gt; --
&gt; &gt; kmx
</div>&gt; 
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052941" href="/Public/Bug/Display.html?id=75841#txn-1052941">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;04:32:09&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052941/550662/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550662">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 634b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; palik, could you please test enclosed threading_no_cleanup_r316.diff ?
</div>my response is surely to late, but I&#39;ve tested r316 with threading_no_cleanup_r316.diff patch 
and got again segfault.

palik

On Mon Mar 19 15:30:24 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; check threading_fix_UNTESTED_r316.diff  - just an idea, not sure if it
&gt; &gt;&gt; is the best way to go.
&gt; &gt;&gt;      
</div>&gt; &gt; I got segfault on new installed wheezy, apache2-mpm-worker 2.2.22-2
&gt; &gt; with patched r316 too.
&gt; &gt;    
</div>&gt; 
&gt; OK, let&#39;s try Mike&#39;s &#34;no-END/no-cleanup&#34; approach.
&gt; 
&gt; palik, could you please test enclosed threading_no_cleanup_r316.diff ?
&gt; 
&gt; Thanks.
&gt; 
&gt; --
&gt; kmx
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052944" href="/Public/Bug/Display.html?id=75841#txn-1052944">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;04:33:34&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Cc palik added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052945" href="/Public/Bug/Display.html?id=75841#txn-1052945">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;04:45:06&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 09:44:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052945/550665/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550665">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 202b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; the module in r318 or current r321 enforce still segfault on apache start.
&gt;    
</div>
Could you please try to comment out the line with 
&#34;openssl_threads_init&#40;&#41;;&#34; in BOOT section and try again?

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052948" href="/Public/Bug/Display.html?id=75841#txn-1052948">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;04:53:25&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052948/550668/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550668">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 155b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Could you please try to comment out the line with 
&gt; &#34;openssl_threads_init&#40;&#41;;&#34; in BOOT section and try again?
</div>
apache start produced no segfault.

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052958" href="/Public/Bug/Display.html?id=75841#txn-1052958">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;05:19:43&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 10:19:30 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052958/550677/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550677">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 303b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; apache start produced no segfault.
&gt;    
</div>
Could you please revert back to rev321 + apply enclosed patch

Then run:
1/ with openssl_threads_init&#40;&#41;; in BOOT section
2/ without openssl_threads_init&#40;&#41;; in BOOT section

And could you please post more details about your Apache+mod_perl+... setup?

--
kmx
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052958/550678/debug_messages_r321.diff">Download debug_messages_r321.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052963" href="/Public/Bug/Display.html?id=75841#txn-1052963">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;05:36:40&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052963/550681/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550681">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 516b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1/ with openssl_threads_init&#40;&#41;; in BOOT section
</div># service apache2 start
Starting web server: apache2DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
Segmentation fault
Action &#39;start&#39; failed.
The Apache error log may have more information.
 failed!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2/ without openssl_threads_init&#40;&#41;; in BOOT section
</div># service apache2 start
Starting web server: apache2DEBUG: BOOT start
DEBUG: BOOT done: tid=0 my_perl=0

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052966" href="/Public/Bug/Display.html?id=75841#txn-1052966">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;05:42:52&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 10:42:41 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052966/550684/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550684">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 778b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; 1/ with openssl_threads_init&#40;&#41;; in BOOT section
&gt;&gt;      
</div>&gt; # service apache2 start
&gt; Starting web server: apache2DEBUG: BOOT start
&gt; DEBUG: init - begin
&gt; DEBUG: setting static locking
&gt; DEBUG: setting dynamic locking
&gt; DEBUG: init - end
&gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; Segmentation fault
&gt; Action &#39;start&#39; failed.
&gt; The Apache error log may have more information.
&gt;   failed!
&gt;    
</div>
I would also expect some &#34;DEBUG: CLONE...&#34; messages.

Do you have mod_ssl loaded or not?

To sort out whether static/dymanic locking is the problem - could you 
please:
1/ keep openssl_threads_init&#40;&#41;; in BOOT section
2/ comment out these 3 lines
         CRYPTO_set_dynlock_create_callback
         CRYPTO_set_dynlock_lock_callback
         CRYPTO_set_dynlock_destroy_callback

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052969" href="/Public/Bug/Display.html?id=75841#txn-1052969">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;05:59:59&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052969/550687/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550687">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I would also expect some &#34;DEBUG: CLONE...&#34; messages.
</div>
My previous message contains complete STRERR-messages.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Do you have mod_ssl loaded or not?
</div>
yes


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To sort out whether static/dymanic locking is the problem - could you 
&gt; please:
&gt; 1/ keep openssl_threads_init&#40;&#41;; in BOOT section
</div>Restored &#39;SSLeay.xs&#39;
At revision 321.
patch SSLeay.xs ../../debug_messages_r321.diff 
...
# service apache2 start
Starting web server: apache2DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
Segmentation fault
Action &#39;start&#39; failed.
The Apache error log may have more information.
 failed!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2/ comment out these 3 lines
&gt;          CRYPTO_set_dynlock_create_callback
&gt;          CRYPTO_set_dynlock_lock_callback
&gt;          CRYPTO_set_dynlock_destroy_callback
</div>
# grep -A2 CRYPTO_set_dynlock_create_callback SSLeay.xs 
/*        CRYPTO_set_dynlock_create_callback&#40;openssl_dynlocking_create_function&#41;;
        CRYPTO_set_dynlock_lock_callback&#40;openssl_dynlocking_lock_function&#41;;
        CRYPTO_set_dynlock_destroy_callback&#40;openssl_dynlocking_destroy_function&#41;;*/
...
service apache2 start
Starting web server: apache2DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
Segmentation fault
Action &#39;start&#39; failed.
The Apache error log may have more information.
 failed!

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052972" href="/Public/Bug/Display.html?id=75841#txn-1052972">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;06:23:20&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 11:23:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052972/550690/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550690">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 914b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, so now if you
1/ put back all 3 lines:  CRYPTO_set_dynlock_*
2/ comment out lines
         CRYPTO_set_locking_callback&#40;&#40;void &#40;*&#41;&#40;int,int,const char 
*,int&#41;&#41;openssl_locking_function&#41;;
         CRYPTO_set_id_callback&#40;openssl_threadid_func&#41;;
         CRYPTO_THREADID_set_callback&#40;openssl_threadid_func&#41;;
it probably will not segfault, right?

As for mod_ssl do you have any idea whether it is loaded before 
mod_perl+net-ssleay or after?

My theory is:
- when net-ssleay is loaded &#40;BOOT section executed&#41; mod_ssl is not 
loaded yet
- net-ssleay detects that openssl threading was not setup yet and will 
setup all necessary callbacks
- later mod_ssl got loaded and forces re-setup of the openssl threading 
which probably causes inconsistency/crash
If my guess is correct, I do not now what we can do on net-ssleay side 
&#40;perhaps just document, that mod_ssl has to be loaded before 
mod_perl+net-ssleay&#41;.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052975" href="/Public/Bug/Display.html?id=75841#txn-1052975">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;07:11:23&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052975/550693/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550693">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Mar 21 06:23:20 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OK, so now if you
&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
&gt; 2/ comment out lines
&gt;          CRYPTO_set_locking_callback&#40;&#40;void &#40;*&#41;&#40;int,int,const char 
&gt; *,int&#41;&#41;openssl_locking_function&#41;;
&gt;          CRYPTO_set_id_callback&#40;openssl_threadid_func&#41;;
&gt;          CRYPTO_THREADID_set_callback&#40;openssl_threadid_func&#41;;
&gt; it probably will not segfault, right?
</div>
Yes.
# service apache2 start
Starting web server: apache2
DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
[Tue Mar 20 01:08:18 2012] [notice] Apache/2.2.22 &#40;Debian&#41; mod_ssl/2.2.22 OpenSSL/1.0.0h 
mod_perl/2.0.5 Perl/v5.14.2 configured -- resuming normal operations


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As for mod_ssl do you have any idea whether it is loaded before 
&gt; mod_perl+net-ssleay or after?
</div>
No idea, but I think apache load the modules in alphabetical order
/etc/apache2/mods-enabled/perl.load
/etc/apache2/mods-enabled/ssl.load


I&#39;ve tried to change the order and set it as follow:
LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
Include mods-available/ssl.conf
LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so

in this case is the situation is same as in
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div>
palik

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; My theory is:
&gt; - when net-ssleay is loaded &#40;BOOT section executed&#41; mod_ssl is not 
&gt; loaded yet
&gt; - net-ssleay detects that openssl threading was not setup yet and will 
&gt; setup all necessary callbacks
&gt; - later mod_ssl got loaded and forces re-setup of the openssl threading 
&gt; which probably causes inconsistency/crash
&gt; If my guess is correct, I do not now what we can do on net-ssleay side 
&gt; &#40;perhaps just document, that mod_ssl has to be loaded before 
&gt; mod_perl+net-ssleay&#41;.
&gt; 
&gt; --
&gt; kmx
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1052985" href="/Public/Bug/Display.html?id=75841#txn-1052985">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;07:45:42&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 21 Mar 2012 12:45:28 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052985/550702/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550702">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;ve tried to change the order and set it as follow:
&gt; LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
&gt; Include mods-available/ssl.conf
&gt; LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so
&gt;
&gt; in this case is the situation is same as in
&gt;    
<div class="message-stanza open">&gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
&gt;&gt;      
</div></div>
It crahses, right?



What I consider strange is that I do not see any &#34;DEBUG CLONE&#34; message 
in your output - it means that there is just one perl interpreter runnig 
&#40;just perl&#39;s main tread tid=0&#41;; while at the same time there are 
probable couple of other Apache threads within the same process.

In such a situation our simple implementation of openssl_threadid_func&#40;&#41; 
obviously cannot not work correctly.

We can:
1/ try to arrange things to make sure that mod_ssl initializes openssl 
threading before mod_perl+net-ssleay is loaded &#40;which we should detect 
in openssl_threads_init&#41;
2/ try put some heavier implementation of openssl_threadid_func&#40;&#41; in 
net-ssleay

To test idea 2/ could you please revert to rev321 + apply enclosed 
debug+pthreads_self_hack_r321.diff ?

--
kmx
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1052985/550703/debug%2Bpthreads_self_hack_r321.diff">Download debug+pthreads_self_hack_r321.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2.3k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1053008" href="/Public/Bug/Display.html?id=75841#txn-1053008">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;21&nbsp;08:25:23&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1053008/550723/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/550723">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">first of all a new very interesting fact:
on debian squeeze 6.0.4
apache2-mpm-prefork          2.2.16-6+squeeze6            
r321+debug_messages_r321.diff work well

# service apache2 restart
Restarting web server: apache2 ... waiting [Wed Mar 21 13:23:05 2012] [notice] caught 
DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
[Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41; mod_ssl/2.2.16 
OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured -- resuming normal operations

I&#39;ve expected segfault too.
Are we sure segfault on wheezy is caused by net-ssleay?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; Include mods-available/ssl.conf
&gt; &gt; LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so
&gt; &gt;
&gt; &gt; in this case is the situation is same as in
&gt; &gt;    
<div class="message-stanza open">&gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
&gt; &gt;&gt;      
</div></div>&gt; 
&gt; It crahses, right?
</div>
Yes

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; What I consider strange is that I do not see any &#34;DEBUG CLONE&#34; message 
&gt; in your output - it means that there is just one perl interpreter runnig 
&gt; &#40;just perl&#39;s main tread tid=0&#41;; while at the same time there are 
&gt; probable couple of other Apache threads within the same process.
&gt; 
&gt; In such a situation our simple implementation of openssl_threadid_func&#40;&#41; 
&gt; obviously cannot not work correctly.
&gt; 
&gt; We can:
&gt; 1/ try to arrange things to make sure that mod_ssl initializes openssl 
&gt; threading before mod_perl+net-ssleay is loaded &#40;which we should detect 
&gt; in openssl_threads_init&#41;
&gt; 2/ try put some heavier implementation of openssl_threadid_func&#40;&#41; in 
&gt; net-ssleay
&gt; 
&gt; To test idea 2/ could you please revert to rev321 + apply enclosed 
&gt; debug+pthreads_self_hack_r321.diff ?
</div>
probably you are expected any other result:
# service apache2 restart
Restarting web server: apache2DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
Segmentation fault
Action &#39;start&#39; failed.
The Apache error log may have more information.
 failed!


palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055137" href="/Public/Bug/Display.html?id=75841#txn-1055137">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;04:14:52&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Mar 2012 18:14:51 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055137/551966/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/551966">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

So I now have a Wheezy/Sid test environment. 

After following the instructions to reproduce, but using the latest net-ssleay 
from svn, there is still a crash, but it is not the same crash as was first 
reported &#40;and which I believe was fixed&#41;

This crash has the trace:

#0  0xb6671c70 in ?? &#40;&#41;
#1  0xb7054f59 in CRYPTO_THREADID_current &#40;&#41;
   from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
#2  0xb70cf80c in ERR_remove_thread_state &#40;&#41;
   from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
#3  0xb70cf8ab in ERR_remove_state &#40;&#41;
   from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
#4  0xb67d4531 in ?? &#40;&#41; from /usr/lib/apache2/modules/mod_ssl.so
#5  0xb7f50b6e in apr_pool_clear &#40;&#41; from /usr/lib/libapr-1.so.0
#6  0x80023445 in main &#40;&#41;


this is crashing inside openssl as called by mod_ssl.

however the crash does not occur with just the apache mod_ssl or just the 
apache mod_perl enabled. ONly with them both enabled. 

Now, what appears to happen is that mod_perl loads, loading Net-SSLeay, which 
initialises openssl, and calls CRYPTO_THREADID_set_callback to set the 
callback to Net::SSLeays openssl_threadid_func
OK so far.

Then openssl functions are called, CRYPTO_THREADID_current calls 
openssl_threadid_func and openssl_threadid_func ruturns a sensible thread id.
OK so far.

Then sometime later during apache2 startup &#40;after about 20 successful calls to 
openssl_threadid_func , the callback call by CRYPTO_THREADID_current crashes. 
At this stage the address where Net::SSLeays openssl_threadid_func _used_ to 
be is gone, and the memory cant be accessed.

Looks like at this stage, Net::SSLeay has been _unloaded_ from the apache2 
process, but openssl library has not, and openssl&#39;s callback to Net::SSLeays 
openssl_threadid_func crashes.

So: I suppose we can ask &#39;why is Net::SSLeay &#40;and maybe mod_perl&#41; being 
unloaded?&#39;. But the answer is prob irrelevant.

Realistically I guess we need to find a way to get control when it _is_ 
unloaded and remove our thread callback function.

I know this is what openssl_threads_cleanup used to do, but it was called at 
multiple  times. How do we get control &#40;once&#41; at the right time?


Cheers.



On Wednesday, March 21, 2012 08:25:23 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; first of all a new very interesting fact:
&gt; on debian squeeze 6.0.4
&gt; apache2-mpm-prefork          2.2.16-6+squeeze6
&gt; r321+debug_messages_r321.diff work well
&gt; 
&gt; # service apache2 restart
&gt; Restarting web server: apache2 ... waiting [Wed Mar 21 13:23:05 2012]
&gt; [notice] caught DEBUG: BOOT start
&gt; DEBUG: init - begin
&gt; DEBUG: setting static locking
&gt; DEBUG: setting dynamic locking
&gt; DEBUG: init - end
&gt; DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
&gt; [Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41; mod_ssl/2.2.16
&gt; OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured -- resuming normal
&gt; operations
&gt; 
&gt; I&#39;ve expected segfault too.
&gt; Are we sure segfault on wheezy is caused by net-ssleay?
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; &gt; LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; &gt; Include mods-available/ssl.conf
&gt; &gt; &gt; LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so
&gt; &gt; &gt; 
&gt; &gt; &gt; in this case is the situation is same as in
&gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div></div>&gt; &gt; 
&gt; &gt; It crahses, right?
</div>&gt; 
&gt; Yes
&gt; 
<div class="message-stanza open">&gt; &gt; What I consider strange is that I do not see any &#34;DEBUG CLONE&#34; message
&gt; &gt; in your output - it means that there is just one perl interpreter runnig
&gt; &gt; &#40;just perl&#39;s main tread tid=0&#41;; while at the same time there are
&gt; &gt; probable couple of other Apache threads within the same process.
&gt; &gt; 
&gt; &gt; In such a situation our simple implementation of openssl_threadid_func&#40;&#41;
&gt; &gt; obviously cannot not work correctly.
&gt; &gt; 
&gt; &gt; We can:
&gt; &gt; 1/ try to arrange things to make sure that mod_ssl initializes openssl
&gt; &gt; threading before mod_perl+net-ssleay is loaded &#40;which we should detect
&gt; &gt; in openssl_threads_init&#41;
&gt; &gt; 2/ try put some heavier implementation of openssl_threadid_func&#40;&#41; in
&gt; &gt; net-ssleay
&gt; &gt; 
&gt; &gt; To test idea 2/ could you please revert to rev321 + apply enclosed
&gt; &gt; debug+pthreads_self_hack_r321.diff ?
</div>&gt; 
&gt; probably you are expected any other result:
&gt; # service apache2 restart
&gt; Restarting web server: apache2DEBUG: BOOT start
&gt; DEBUG: init - begin
&gt; DEBUG: setting static locking
&gt; DEBUG: setting dynamic locking
&gt; DEBUG: init - end
&gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; Segmentation fault
&gt; Action &#39;start&#39; failed.
&gt; The Apache error log may have more information.
&gt;  failed!
&gt; 
&gt; 
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055188" href="/Public/Bug/Display.html?id=75841#txn-1055188">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;06:55:36&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Mar 2012 20:55:01 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055188/552003/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552003">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">More on this below....

On Tuesday, March 27, 2012 04:14:54 AM mikem@open.com.au via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Hi all,
&gt; 
&gt; So I now have a Wheezy/Sid test environment.
&gt; 
&gt; After following the instructions to reproduce, but using the latest
&gt; net-ssleay from svn, there is still a crash, but it is not the same crash
&gt; as was first reported &#40;and which I believe was fixed&#41;
&gt; 
&gt; This crash has the trace:
&gt; 
&gt; #0  0xb6671c70 in ?? &#40;&#41;
&gt; #1  0xb7054f59 in CRYPTO_THREADID_current &#40;&#41;
&gt;    from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
&gt; #2  0xb70cf80c in ERR_remove_thread_state &#40;&#41;
&gt;    from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
&gt; #3  0xb70cf8ab in ERR_remove_state &#40;&#41;
&gt;    from /usr/lib/i386-linux-gnu/i686/cmov/libcrypto.so.1.0.0
&gt; #4  0xb67d4531 in ?? &#40;&#41; from /usr/lib/apache2/modules/mod_ssl.so
&gt; #5  0xb7f50b6e in apr_pool_clear &#40;&#41; from /usr/lib/libapr-1.so.0
&gt; #6  0x80023445 in main &#40;&#41;
&gt; 
&gt; 
&gt; this is crashing inside openssl as called by mod_ssl.
&gt; 
&gt; however the crash does not occur with just the apache mod_ssl or just the
&gt; apache mod_perl enabled. ONly with them both enabled.
&gt; 
&gt; Now, what appears to happen is that mod_perl loads, loading Net-SSLeay,
&gt; which initialises openssl, and calls CRYPTO_THREADID_set_callback to set
&gt; the callback to Net::SSLeays openssl_threadid_func
&gt; OK so far.
&gt; 
&gt; Then openssl functions are called, CRYPTO_THREADID_current calls
&gt; openssl_threadid_func and openssl_threadid_func ruturns a sensible thread
&gt; id. OK so far.
&gt; 
&gt; Then sometime later during apache2 startup &#40;after about 20 successful calls
&gt; to openssl_threadid_func , the callback call by CRYPTO_THREADID_current
&gt; crashes. At this stage the address where Net::SSLeays openssl_threadid_func
&gt; _used_ to be is gone, and the memory cant be accessed.
&gt; 
&gt; Looks like at this stage, Net::SSLeay has been _unloaded_ from the apache2
&gt; process, but openssl library has not, and openssl&#39;s callback to Net::SSLeays
&gt; openssl_threadid_func crashes.
&gt; 
&gt; So: I suppose we can ask &#39;why is Net::SSLeay &#40;and maybe mod_perl&#41; being
&gt; unloaded?&#39;. But the answer is prob irrelevant.
&gt; 
&gt; Realistically I guess we need to find a way to get control when it _is_
&gt; unloaded and remove our thread callback function.
&gt; 
&gt; I know this is what openssl_threads_cleanup used to do, but it was called at
&gt; multiple  times. How do we get control &#40;once&#41; at the right time?
</div>

Annoyingly, I observe different behaviours in md_perl??? with different 
versions of debian/apache/perl:

eg if I add some code to print the thread id during BOOT, CLONE and END, 
during apache startup:

Debian Squeeze 6.0.4:
BOOT 0
CLONE 0 
CLONE 0 
CLONE 0 
END 0
END 0
END 0
END 0

Debian Wheezy/Sid:
BOOT 0
END 0

Sigh: how to make this work in both environments :-&#40;


Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; Cheers.
&gt; 
&gt; On Wednesday, March 21, 2012 08:25:23 AM you wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt; 
&gt; &gt; first of all a new very interesting fact:
&gt; &gt; on debian squeeze 6.0.4
&gt; &gt; apache2-mpm-prefork          2.2.16-6+squeeze6
&gt; &gt; r321+debug_messages_r321.diff work well
&gt; &gt; 
&gt; &gt; # service apache2 restart
&gt; &gt; Restarting web server: apache2 ... waiting [Wed Mar 21 13:23:05 2012]
&gt; &gt; [notice] caught DEBUG: BOOT start
&gt; &gt; DEBUG: init - begin
&gt; &gt; DEBUG: setting static locking
&gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; DEBUG: init - end
&gt; &gt; DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
&gt; &gt; [Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41;
&gt; &gt; mod_ssl/2.2.16
&gt; &gt; OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured -- resuming normal
&gt; &gt; operations
&gt; &gt; 
&gt; &gt; I&#39;ve expected segfault too.
&gt; &gt; Are we sure segfault on wheezy is caused by net-ssleay?
&gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; &gt; &gt; LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; &gt; &gt; Include mods-available/ssl.conf
&gt; &gt; &gt; &gt; LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; in this case is the situation is same as in
&gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div></div>&gt; &gt; &gt; 
&gt; &gt; &gt; It crahses, right?
</div>&gt; &gt; 
&gt; &gt; Yes
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; What I consider strange is that I do not see any &#34;DEBUG CLONE&#34;
&gt; &gt; &gt; message
&gt; &gt; &gt; in your output - it means that there is just one perl interpreter
&gt; &gt; &gt; runnig &#40;just perl&#39;s main tread tid=0&#41;; while at the same time there
&gt; &gt; &gt; are probable couple of other Apache threads within the same
&gt; &gt; &gt; process.
&gt; &gt; &gt; 
&gt; &gt; &gt; In such a situation our simple implementation of
&gt; &gt; &gt; openssl_threadid_func&#40;&#41; obviously cannot not work correctly.
&gt; &gt; &gt; 
&gt; &gt; &gt; We can:
&gt; &gt; &gt; 1/ try to arrange things to make sure that mod_ssl initializes
&gt; &gt; &gt; openssl
&gt; &gt; &gt; threading before mod_perl+net-ssleay is loaded &#40;which we should
&gt; &gt; &gt; detect
&gt; &gt; &gt; in openssl_threads_init&#41;
&gt; &gt; &gt; 2/ try put some heavier implementation of openssl_threadid_func&#40;&#41; in
&gt; &gt; &gt; net-ssleay
&gt; &gt; &gt; 
&gt; &gt; &gt; To test idea 2/ could you please revert to rev321 + apply enclosed
&gt; &gt; &gt; debug+pthreads_self_hack_r321.diff ?
</div>&gt; &gt; 
&gt; &gt; probably you are expected any other result:
&gt; &gt; # service apache2 restart
&gt; &gt; Restarting web server: apache2DEBUG: BOOT start
&gt; &gt; DEBUG: init - begin
&gt; &gt; DEBUG: setting static locking
&gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; DEBUG: init - end
&gt; &gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; &gt; Segmentation fault
&gt; &gt; Action &#39;start&#39; failed.
&gt; &gt; The Apache error log may have more information.
&gt; &gt; 
&gt; &gt;  failed!
&gt; &gt; 
&gt; &gt; palik
</div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055247" href="/Public/Bug/Display.html?id=75841#txn-1055247">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;09:29:16&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 27 Mar 2012 15:28:57 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055247/552035/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552035">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; Now, what appears to happen is that mod_perl loads, loading Net-SSLeay,
&gt;&gt; which initialises openssl, and calls CRYPTO_THREADID_set_callback to set
&gt;&gt; the callback to Net::SSLeays openssl_threadid_func
&gt;&gt; OK so far.
&gt;&gt;
&gt;&gt; Then openssl functions are called, CRYPTO_THREADID_current calls
&gt;&gt; openssl_threadid_func and openssl_threadid_func ruturns a sensible thread
&gt;&gt; id. OK so far.
&gt;&gt;
&gt;&gt; Then sometime later during apache2 startup &#40;after about 20 successful calls
&gt;&gt; to openssl_threadid_func , the callback call by CRYPTO_THREADID_current
&gt;&gt; crashes. At this stage the address where Net::SSLeays openssl_threadid_func
&gt;&gt; _used_ to be is gone, and the memory cant be accessed.
&gt;&gt;
&gt;&gt; Looks like at this stage, Net::SSLeay has been _unloaded_ from the apache2
&gt;&gt; process, but openssl library has not, and openssl&#39;s callback to Net::SSLeays
&gt;&gt; openssl_threadid_func crashes.
&gt;&gt;      
</div>
I have the same feeling, your analysis is IMHO correct &#40;or very close to 
be correct&#41;


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; So: I suppose we can ask &#39;why is Net::SSLeay &#40;and maybe mod_perl&#41; being
&gt;&gt; unloaded?&#39;. But the answer is prob irrelevant.
&gt;&gt;
&gt;&gt; Realistically I guess we need to find a way to get control when it _is_
&gt;&gt; unloaded and remove our thread callback function.
&gt;&gt;
&gt;&gt; I know this is what openssl_threads_cleanup used to do, but it was called at
&gt;&gt; multiple  times. How do we get control &#40;once&#41; at the right time?
&gt;&gt;      
</div>
It might be quite hard because as far as I have googled mod_perl does 
some dark magic with perl interprets - here is my understanding:
- mod_perl has a pool of &#34;parent&#34; perl interprets &#40;1 or more&#41; started in 
separate threads
- when a request comes the new cloned perl interpreter is derived from 
some of the parent interprets
- the lifetime of perl interprets is fully driven by mod_perl &#40;and they 
can probably be created/unloded/reloded/destroyed at any time&#41;

One thing we can do is to allow openssl_deinitialization only by perl 
interpret that has called openssl_initialization. However I am afraid 
that this will not solve our troubles completely.
Consider this scenario of continuously loading/unloading perl interprets 
&#40;again only my guess&#41;:
- mod_perl loads 1st perl interpret - which calls_openssl_initi
- mod_perl loads 2st perl interpret - no more init needed
- mod_perl unloads 1st perl interpret - as it is &#34;init-caller&#34; it will 
call openssl deinitialization !!!
- mod_perl loads 3st perl interpret - no more init needed, but it is 
likely to crash

Is it somehow possible to detect that we are the only &#40;=last&#41; running 
perl interpret?

Or maybe is it possible to detect that we are loaded by mod_perl ? &#40;and 
skip openssl threading init&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055641" href="/Public/Bug/Display.html?id=75841#txn-1055641">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;18:43:23&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 08:43:23 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055641/552282/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552282">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yet more investigations:

On Tuesday, March 27, 2012 08:55:01 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; More on this below....
&gt; 
&gt; On Tuesday, March 27, 2012 04:14:54 AM mikem@open.com.au via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt; 
&gt; &gt; Hi all,
&gt; &gt; 
&gt; &gt; So I now have a Wheezy/Sid test environment.
</div></div>....

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; 
&gt; &gt; Realistically I guess we need to find a way to get control when it _is_
&gt; &gt; unloaded and remove our thread callback function.
&gt; &gt; 
&gt; &gt; I know this is what openssl_threads_cleanup used to do, but it was
&gt; &gt; called at multiple  times. How do we get control &#40;once&#41; at the right
&gt; &gt; time?
</div>&gt; Annoyingly, I observe different behaviours in md_perl??? with different
&gt; versions of debian/apache/perl:
&gt; 
&gt; eg if I add some code to print the thread id during BOOT, CLONE and END,
&gt; during apache startup:
&gt; 
&gt; Debian Squeeze 6.0.4:
&gt; BOOT 0
&gt; CLONE 0
&gt; CLONE 0
&gt; CLONE 0
&gt; END 0
&gt; END 0
&gt; END 0
&gt; END 0
&gt; 
&gt; Debian Wheezy/Sid:
&gt; BOOT 0
&gt; END 0
&gt; 
&gt; Sigh: how to make this work in both environments :-&#40;
</div>
Apache2 in Squeeze and Wheezy appear to use mod_perl in quite different ways 
&#40;at least with the default apache config&#41;

Squeeze has libapache2-mod-perl2 2.0.4-7
it does not use dlclose to close any shared libs during apache2 startup.
The fixes we currently have in svn work fine with that.

Wheezy/Sid has ibapache2-mod-perl2 2.0.5-5
it uses dlclose to unload Net-SSLeay during startup. Since no other module has 
that .so loaded, Debian unloads that .so from the apache address space. 
Subsequent operations by mod_ssl cause the access to the now unloaded net-
ssleay addresses causing the crash.

There is even worse news:

Even if we could get control at the right time &#40;and I think there _is_ in fact 
a chance of this&#41;, it is not possible to remove a callback set with openssl 
CRYPTO_THREADID_set_callback. The code is like this:

int CRYPTO_THREADID_set_callback&#40;void &#40;*func&#41;&#40;CRYPTO_THREADID *&#41;&#41;
        {
        if &#40;threadid_callback&#41;
                return 0;
        threadid_callback = func;
        return 1;
        }

so once threadid_callback is established you _cannot_ remove it.

Perhaps that means we will have to fall back to CRYPTO_set_id_callback &#40;if it 
is available: dependent on OPENSSL_NO_DEPRECATED&#41;

Or is there some way to prevent NetSSLeay.so being unloaded? Prob not.

Or.....??????

Sigh.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; 
&gt; Cheers.
&gt; 
<div class="message-stanza open">&gt; &gt; Cheers.
&gt; &gt; 
&gt; &gt; On Wednesday, March 21, 2012 08:25:23 AM you wrote:
<div class="message-stanza open">&gt; &gt; &gt;        Queue: Net-SSLeay
&gt; &gt; &gt;  
&gt; &gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt; &gt; 
&gt; &gt; &gt; first of all a new very interesting fact:
&gt; &gt; &gt; on debian squeeze 6.0.4
&gt; &gt; &gt; apache2-mpm-prefork          2.2.16-6+squeeze6
&gt; &gt; &gt; r321+debug_messages_r321.diff work well
&gt; &gt; &gt; 
&gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; Restarting web server: apache2 ... waiting [Wed Mar 21 13:23:05
&gt; &gt; &gt; 2012]
&gt; &gt; &gt; [notice] caught DEBUG: BOOT start
&gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
&gt; &gt; &gt; [Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41;
&gt; &gt; &gt; mod_ssl/2.2.16
&gt; &gt; &gt; OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured -- resuming
&gt; &gt; &gt; normal operations
&gt; &gt; &gt; 
&gt; &gt; &gt; I&#39;ve expected segfault too.
&gt; &gt; &gt; Are we sure segfault on wheezy is caused by net-ssleay?
&gt; &gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; &gt; &gt; &gt; LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; &gt; &gt; &gt; Include mods-available/ssl.conf
&gt; &gt; &gt; &gt; &gt; LoadModule perl_module /usr/lib/apache2/modules/mod_perl.so
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; in this case is the situation is same as in
&gt; &gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div></div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; It crahses, right?
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Yes
&gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; What I consider strange is that I do not see any &#34;DEBUG CLONE&#34;
&gt; &gt; &gt; &gt; message
&gt; &gt; &gt; &gt; in your output - it means that there is just one perl
&gt; &gt; &gt; &gt; interpreter
&gt; &gt; &gt; &gt; runnig &#40;just perl&#39;s main tread tid=0&#41;; while at the same time
&gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; are probable couple of other Apache threads within the same
&gt; &gt; &gt; &gt; process.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; In such a situation our simple implementation of
&gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; obviously cannot not work correctly.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; We can:
&gt; &gt; &gt; &gt; 1/ try to arrange things to make sure that mod_ssl initializes
&gt; &gt; &gt; &gt; openssl
&gt; &gt; &gt; &gt; threading before mod_perl+net-ssleay is loaded &#40;which we should
&gt; &gt; &gt; &gt; detect
&gt; &gt; &gt; &gt; in openssl_threads_init&#41;
&gt; &gt; &gt; &gt; 2/ try put some heavier implementation of
&gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; in
&gt; &gt; &gt; &gt; net-ssleay
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; To test idea 2/ could you please revert to rev321 + apply
&gt; &gt; &gt; &gt; enclosed
&gt; &gt; &gt; &gt; debug+pthreads_self_hack_r321.diff ?
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; probably you are expected any other result:
&gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; Restarting web server: apache2DEBUG: BOOT start
&gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; &gt; &gt; Segmentation fault
&gt; &gt; &gt; Action &#39;start&#39; failed.
&gt; &gt; &gt; The Apache error log may have more information.
&gt; &gt; &gt; 
&gt; &gt; &gt;  failed!
&gt; &gt; &gt; 
&gt; &gt; &gt; palik
</div></div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055708" href="/Public/Bug/Display.html?id=75841#txn-1055708">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;27&nbsp;21:22:39&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 11:22:38 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055708/552318/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552318">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">And more, after much looking inside mod_perl, mod_ssl, perl DynaLoader etc


On Wednesday, March 28, 2012 08:43:23 AM Mike McCauley wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yet more investigations:
&gt; 
&gt; On Tuesday, March 27, 2012 08:55:01 PM you wrote:
<div class="message-stanza open">&gt; &gt; More on this below....
&gt; &gt; 
&gt; &gt; On Tuesday, March 27, 2012 04:14:54 AM mikem@open.com.au via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt;        Queue: Net-SSLeay
&gt; &gt; &gt;  
&gt; &gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt; &gt; 
&gt; &gt; &gt; Hi all,
&gt; &gt; &gt; 
&gt; &gt; &gt; So I now have a Wheezy/Sid test environment.
</div></div>&gt; 
&gt; ....
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Realistically I guess we need to find a way to get control when it
&gt; &gt; &gt; _is_
&gt; &gt; &gt; unloaded and remove our thread callback function.
&gt; &gt; &gt; 
&gt; &gt; &gt; I know this is what openssl_threads_cleanup used to do, but it was
&gt; &gt; &gt; called at multiple  times. How do we get control &#40;once&#41; at the right
&gt; &gt; &gt; time?
</div>&gt; &gt; 
&gt; &gt; Annoyingly, I observe different behaviours in md_perl??? with different
&gt; &gt; versions of debian/apache/perl:
&gt; &gt; 
&gt; &gt; eg if I add some code to print the thread id during BOOT, CLONE and END,
&gt; &gt; during apache startup:
&gt; &gt; 
&gt; &gt; Debian Squeeze 6.0.4:
&gt; &gt; BOOT 0
&gt; &gt; CLONE 0
&gt; &gt; CLONE 0
&gt; &gt; CLONE 0
&gt; &gt; END 0
&gt; &gt; END 0
&gt; &gt; END 0
&gt; &gt; END 0
&gt; &gt; 
&gt; &gt; Debian Wheezy/Sid:
&gt; &gt; BOOT 0
&gt; &gt; END 0
&gt; &gt; 
&gt; &gt; Sigh: how to make this work in both environments :-&#40;
</div>&gt; 
&gt; Apache2 in Squeeze and Wheezy appear to use mod_perl in quite different ways
&gt; &#40;at least with the default apache config&#41;
&gt; 
&gt; Squeeze has libapache2-mod-perl2 2.0.4-7
&gt; it does not use dlclose to close any shared libs during apache2 startup.
&gt; The fixes we currently have in svn work fine with that.
&gt; 
&gt; Wheezy/Sid has ibapache2-mod-perl2 2.0.5-5
&gt; it uses dlclose to unload Net-SSLeay during startup. Since no other module
&gt; has that .so loaded, Debian unloads that .so from the apache address space.
&gt; Subsequent operations by mod_ssl cause the access to the now unloaded net-
&gt; ssleay addresses causing the crash.
&gt; 
&gt; There is even worse news:
&gt; 
&gt; Even if we could get control at the right time &#40;and I think there _is_ in
&gt; fact a chance of this&#41;, it is not possible to remove a callback set with
&gt; openssl CRYPTO_THREADID_set_callback. The code is like this:
&gt; 
&gt; int CRYPTO_THREADID_set_callback&#40;void &#40;*func&#41;&#40;CRYPTO_THREADID *&#41;&#41;
&gt;       {
&gt;       if &#40;threadid_callback&#41;
&gt;               return 0;
&gt;       threadid_callback = func;
&gt;       return 1;
&gt;       }
&gt; 
&gt; so once threadid_callback is established you _cannot_ remove it.
&gt; 
&gt; Perhaps that means we will have to fall back to CRYPTO_set_id_callback &#40;if
&gt; it is available: dependent on OPENSSL_NO_DEPRECATED&#41;
</div>


Hmmm, Apache 2.2 as used in Wheezy/Sid mod_ssl registers an id callback with 
the old  CRYPTO_set_id_callback&#40;ssl_util_thr_id&#41;;

The thread id returned by ssl_util_thr_id is the apache thread, as returned by 
apr_os_thread_current&#40;&#41;. Conclusion: apache+mod-ssl uses apache threads and 
thread IDs.

Now if apache2 with mod_ssl loaded &#40;a common case&#41; loads mod_perl and 
Net::SSLeay and a perl app that wnats to use threading, perl will want to use 
its own threading model, which is utterly different to the threading in 
apache.

So if Net::SSLeay changes or overrides the thread id callback that mod_ssl 
sets up. Is it not likely to break apache+mod_ssl threading?

Perhaps there is a fundamental incompatibility between 
apache+mod-perl+perl+net-ssleay+threads 
and
apache+mod-ssl

Surely their different threading systems cannot co-exist within one process?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Or is there some way to prevent NetSSLeay.so being unloaded? Prob not.
&gt; 
&gt; Or.....??????
&gt; 
&gt; Sigh.
&gt; 
<div class="message-stanza open">&gt; &gt; Cheers.
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; Cheers.
&gt; &gt; &gt; 
&gt; &gt; &gt; On Wednesday, March 21, 2012 08:25:23 AM you wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt;        Queue: Net-SSLeay
&gt; &gt; &gt; &gt;  
&gt; &gt; &gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span>
<div class="message-stanza open">&gt; &gt; &gt; &gt;  &gt;
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; first of all a new very interesting fact:
&gt; &gt; &gt; &gt; on debian squeeze 6.0.4
&gt; &gt; &gt; &gt; apache2-mpm-prefork          2.2.16-6+squeeze6
&gt; &gt; &gt; &gt; r321+debug_messages_r321.diff work well
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; &gt; Restarting web server: apache2 ... waiting [Wed Mar 21 13:23:05
&gt; &gt; &gt; &gt; 2012]
&gt; &gt; &gt; &gt; [notice] caught DEBUG: BOOT start
&gt; &gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
&gt; &gt; &gt; &gt; [Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41;
&gt; &gt; &gt; &gt; mod_ssl/2.2.16
&gt; &gt; &gt; &gt; OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured --
&gt; &gt; &gt; &gt; resuming
&gt; &gt; &gt; &gt; normal operations
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I&#39;ve expected segfault too.
&gt; &gt; &gt; &gt; Are we sure segfault on wheezy is caused by net-ssleay?
&gt; &gt; &gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; &gt; &gt; &gt; &gt; LoadModule ssl_module
&gt; &gt; &gt; &gt; &gt; &gt; /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; &gt; &gt; &gt; &gt; Include mods-available/ssl.conf
&gt; &gt; &gt; &gt; &gt; &gt; LoadModule perl_module
&gt; &gt; &gt; &gt; &gt; &gt; /usr/lib/apache2/modules/mod_perl.so
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; in this case is the situation is same as in
&gt; &gt; &gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div></div>&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; It crahses, right?
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Yes
&gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; What I consider strange is that I do not see any &#34;DEBUG
&gt; &gt; &gt; &gt; &gt; CLONE&#34;
&gt; &gt; &gt; &gt; &gt; message
&gt; &gt; &gt; &gt; &gt; in your output - it means that there is just one perl
&gt; &gt; &gt; &gt; &gt; interpreter
&gt; &gt; &gt; &gt; &gt; runnig &#40;just perl&#39;s main tread tid=0&#41;; while at the same
&gt; &gt; &gt; &gt; &gt; time
&gt; &gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; &gt; are probable couple of other Apache threads within the same
&gt; &gt; &gt; &gt; &gt; process.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; In such a situation our simple implementation of
&gt; &gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; obviously cannot not work correctly.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; We can:
&gt; &gt; &gt; &gt; &gt; 1/ try to arrange things to make sure that mod_ssl
&gt; &gt; &gt; &gt; &gt; initializes
&gt; &gt; &gt; &gt; &gt; openssl
&gt; &gt; &gt; &gt; &gt; threading before mod_perl+net-ssleay is loaded &#40;which we
&gt; &gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; &gt; detect
&gt; &gt; &gt; &gt; &gt; in openssl_threads_init&#41;
&gt; &gt; &gt; &gt; &gt; 2/ try put some heavier implementation of
&gt; &gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; in
&gt; &gt; &gt; &gt; &gt; net-ssleay
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; To test idea 2/ could you please revert to rev321 + apply
&gt; &gt; &gt; &gt; &gt; enclosed
&gt; &gt; &gt; &gt; &gt; debug+pthreads_self_hack_r321.diff ?
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; probably you are expected any other result:
&gt; &gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; &gt; Restarting web server: apache2DEBUG: BOOT start
&gt; &gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; &gt; &gt; &gt; Segmentation fault
&gt; &gt; &gt; &gt; Action &#39;start&#39; failed.
&gt; &gt; &gt; &gt; The Apache error log may have more information.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt;  failed!
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; palik
</div></div></div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055794" href="/Public/Bug/Display.html?id=75841#txn-1055794">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;03:59:22&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 17:59:19 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055794/552372/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552372">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 8.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tuesday, March 27, 2012 09:22:40 PM mikem@open.com.au via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; And more, after much looking inside mod_perl, mod_ssl, perl DynaLoader etc
&gt; 
&gt; On Wednesday, March 28, 2012 08:43:23 AM Mike McCauley wrote:
<div class="message-stanza open">&gt; &gt; Yet more investigations:
&gt; &gt; 
&gt; &gt; On Tuesday, March 27, 2012 08:55:01 PM you wrote:
<div class="message-stanza open">&gt; &gt; &gt; More on this below....
&gt; &gt; &gt; 
&gt; &gt; &gt; On Tuesday, March 27, 2012 04:14:54 AM mikem@open.com.au via RT wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt;        Queue: Net-SSLeay
&gt; &gt; &gt; &gt;  
&gt; &gt; &gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span>
<div class="message-stanza open">&gt; &gt; &gt; &gt;  &gt;
</div>&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; Hi all,
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; So I now have a Wheezy/Sid test environment.
</div></div>&gt; &gt; 
&gt; &gt; ....
&gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; Realistically I guess we need to find a way to get control when
&gt; &gt; &gt; &gt; it
&gt; &gt; &gt; &gt; _is_
&gt; &gt; &gt; &gt; unloaded and remove our thread callback function.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; I know this is what openssl_threads_cleanup used to do, but it
&gt; &gt; &gt; &gt; was
&gt; &gt; &gt; &gt; called at multiple  times. How do we get control &#40;once&#41; at the
&gt; &gt; &gt; &gt; right
&gt; &gt; &gt; &gt; time?
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; Annoyingly, I observe different behaviours in md_perl??? with
&gt; &gt; &gt; different
&gt; &gt; &gt; versions of debian/apache/perl:
&gt; &gt; &gt; 
&gt; &gt; &gt; eg if I add some code to print the thread id during BOOT, CLONE and
&gt; &gt; &gt; END, during apache startup:
&gt; &gt; &gt; 
&gt; &gt; &gt; Debian Squeeze 6.0.4:
&gt; &gt; &gt; BOOT 0
&gt; &gt; &gt; CLONE 0
&gt; &gt; &gt; CLONE 0
&gt; &gt; &gt; CLONE 0
&gt; &gt; &gt; END 0
&gt; &gt; &gt; END 0
&gt; &gt; &gt; END 0
&gt; &gt; &gt; END 0
&gt; &gt; &gt; 
&gt; &gt; &gt; Debian Wheezy/Sid:
&gt; &gt; &gt; BOOT 0
&gt; &gt; &gt; END 0
</div></div></div>
Those thread ids are all 0 because threads is not loaded at this time &#40;even 
though there appear to be multiple perl interpreters in the same process!

More info: Squeeze has apache built with MPM worker, but Wheezy/Sid is MPM 
prefork.

I must say I still dont really understand what happens in mod_perl during 
apache startup

However, tests have shown on Debian squeeze that any attempt to create a perl 
thread in a mod-perl+ModPerl::PerlRun script will cause a nasty apache crash, 
even if Net::SSLeay or mod-ssl is not loaded or used. Ive not seen any 
discussion of using perl threads in a mod-perl script, so perhaps its not 
supported? And if one is using apache MPM, its not even necessary?

So, maybe given that this does not work:

apache2+mod-ssl+mod-perl+perlthreads
nor this:
apache2+mod-perl+perlthreads

then we should not be trying to make it work with

apache2+mod-ssl+mod-perl+NetSSLeay+perlthreads

and only try to make it work under 

apache2+mod-ssl+mod-perl+NetSSLeay
and
perl+NetSSLeay+perlthreads

&#40;there may be some hope of that :-&#41;&#41;

Ive had enough for one day......

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; 
&gt; &gt; &gt; Sigh: how to make this work in both environments :-&#40;
</div>&gt; &gt; 
&gt; &gt; Apache2 in Squeeze and Wheezy appear to use mod_perl in quite different
&gt; &gt; ways &#40;at least with the default apache config&#41;
&gt; &gt; 
&gt; &gt; Squeeze has libapache2-mod-perl2 2.0.4-7
&gt; &gt; it does not use dlclose to close any shared libs during apache2 startup.
&gt; &gt; The fixes we currently have in svn work fine with that.
&gt; &gt; 
&gt; &gt; Wheezy/Sid has ibapache2-mod-perl2 2.0.5-5
&gt; &gt; it uses dlclose to unload Net-SSLeay during startup. Since no other
&gt; &gt; module has that .so loaded, Debian unloads that .so from the apache
&gt; &gt; address space. Subsequent operations by mod_ssl cause the access to the
&gt; &gt; now unloaded net- ssleay addresses causing the crash.
&gt; &gt; 
&gt; &gt; There is even worse news:
&gt; &gt; 
&gt; &gt; Even if we could get control at the right time &#40;and I think there _is_
&gt; &gt; in
&gt; &gt; fact a chance of this&#41;, it is not possible to remove a callback set with
&gt; &gt; openssl CRYPTO_THREADID_set_callback. The code is like this:
&gt; &gt; 
&gt; &gt; int CRYPTO_THREADID_set_callback&#40;void &#40;*func&#41;&#40;CRYPTO_THREADID *&#41;&#41;
&gt; &gt; 
&gt; &gt;     {
&gt; &gt;     if &#40;threadid_callback&#41;
&gt; &gt;     
&gt; &gt;             return 0;
&gt; &gt;     
&gt; &gt;     threadid_callback = func;
&gt; &gt;     return 1;
&gt; &gt;     }
&gt; &gt; 
&gt; &gt; so once threadid_callback is established you _cannot_ remove it.
&gt; &gt; 
&gt; &gt; Perhaps that means we will have to fall back to CRYPTO_set_id_callback
&gt; &gt; &#40;if it is available: dependent on OPENSSL_NO_DEPRECATED&#41;
</div>&gt; 
&gt; Hmmm, Apache 2.2 as used in Wheezy/Sid mod_ssl registers an id callback with
&gt; the old  CRYPTO_set_id_callback&#40;ssl_util_thr_id&#41;;
&gt; 
&gt; The thread id returned by ssl_util_thr_id is the apache thread, as returned
&gt; by apr_os_thread_current&#40;&#41;. Conclusion: apache+mod-ssl uses apache threads
&gt; and thread IDs.
&gt; 
&gt; Now if apache2 with mod_ssl loaded &#40;a common case&#41; loads mod_perl and
&gt; Net::SSLeay and a perl app that wnats to use threading, perl will want to
&gt; use its own threading model, which is utterly different to the threading in
&gt; apache.
&gt; 
&gt; So if Net::SSLeay changes or overrides the thread id callback that mod_ssl
&gt; sets up. Is it not likely to break apache+mod_ssl threading?
&gt; 
&gt; Perhaps there is a fundamental incompatibility between
&gt; apache+mod-perl+perl+net-ssleay+threads
&gt; and
&gt; apache+mod-ssl
&gt; 
&gt; Surely their different threading systems cannot co-exist within one process?
<div class="message-stanza open">&gt; &gt; Or is there some way to prevent NetSSLeay.so being unloaded? Prob not.
&gt; &gt; 
&gt; &gt; Or.....??????
&gt; &gt; 
&gt; &gt; Sigh.
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; Cheers.
&gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; Cheers.
&gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; On Wednesday, March 21, 2012 08:25:23 AM you wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt;        Queue: Net-SSLeay
&gt; &gt; &gt; &gt; &gt;  
&gt; &gt; &gt; &gt; &gt;  Ticket &lt;URL:
&gt; &gt; &gt; &gt; &gt;  <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span>
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; first of all a new very interesting fact:
&gt; &gt; &gt; &gt; &gt; on debian squeeze 6.0.4
&gt; &gt; &gt; &gt; &gt; apache2-mpm-prefork          2.2.16-6+squeeze6
&gt; &gt; &gt; &gt; &gt; r321+debug_messages_r321.diff work well
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; &gt; &gt; Restarting web server: apache2 ... waiting [Wed Mar 21
&gt; &gt; &gt; &gt; &gt; 13:23:05
&gt; &gt; &gt; &gt; &gt; 2012]
&gt; &gt; &gt; &gt; &gt; [notice] caught DEBUG: BOOT start
&gt; &gt; &gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=7fbe6e600b30
&gt; &gt; &gt; &gt; &gt; [Wed Mar 21 13:23:06 2012] [notice] Apache/2.2.16 &#40;Debian&#41;
&gt; &gt; &gt; &gt; &gt; mod_ssl/2.2.16
&gt; &gt; &gt; &gt; &gt; OpenSSL/0.9.8o mod_perl/2.0.4 Perl/v5.10.1 configured --
&gt; &gt; &gt; &gt; &gt; resuming
&gt; &gt; &gt; &gt; &gt; normal operations
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; I&#39;ve expected segfault too.
&gt; &gt; &gt; &gt; &gt; Are we sure segfault on wheezy is caused by net-ssleay?
&gt; &gt; &gt; &gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt; I&#39;ve tried to change the order and set it as follow:
&gt; &gt; &gt; &gt; &gt; &gt; &gt; LoadModule ssl_module
&gt; &gt; &gt; &gt; &gt; &gt; &gt; /usr/lib/apache2/modules/mod_ssl.so
&gt; &gt; &gt; &gt; &gt; &gt; &gt; Include mods-available/ssl.conf
&gt; &gt; &gt; &gt; &gt; &gt; &gt; LoadModule perl_module
&gt; &gt; &gt; &gt; &gt; &gt; &gt; /usr/lib/apache2/modules/mod_perl.so
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; &gt; in this case is the situation is same as in
&gt; &gt; &gt; &gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; &gt;&gt; 1/ put back all 3 lines:  CRYPTO_set_dynlock_*
</div></div>&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; It crahses, right?
</div>&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; Yes
&gt; &gt; &gt; &gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; &gt; &gt; &gt; What I consider strange is that I do not see any &#34;DEBUG
&gt; &gt; &gt; &gt; &gt; &gt; CLONE&#34;
&gt; &gt; &gt; &gt; &gt; &gt; message
&gt; &gt; &gt; &gt; &gt; &gt; in your output - it means that there is just one perl
&gt; &gt; &gt; &gt; &gt; &gt; interpreter
&gt; &gt; &gt; &gt; &gt; &gt; runnig &#40;just perl&#39;s main tread tid=0&#41;; while at the same
&gt; &gt; &gt; &gt; &gt; &gt; time
&gt; &gt; &gt; &gt; &gt; &gt; there
&gt; &gt; &gt; &gt; &gt; &gt; are probable couple of other Apache threads within the
&gt; &gt; &gt; &gt; &gt; &gt; same
&gt; &gt; &gt; &gt; &gt; &gt; process.
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; In such a situation our simple implementation of
&gt; &gt; &gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; obviously cannot not work
&gt; &gt; &gt; &gt; &gt; &gt; correctly.
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; We can:
&gt; &gt; &gt; &gt; &gt; &gt; 1/ try to arrange things to make sure that mod_ssl
&gt; &gt; &gt; &gt; &gt; &gt; initializes
&gt; &gt; &gt; &gt; &gt; &gt; openssl
&gt; &gt; &gt; &gt; &gt; &gt; threading before mod_perl+net-ssleay is loaded &#40;which we
&gt; &gt; &gt; &gt; &gt; &gt; should
&gt; &gt; &gt; &gt; &gt; &gt; detect
&gt; &gt; &gt; &gt; &gt; &gt; in openssl_threads_init&#41;
&gt; &gt; &gt; &gt; &gt; &gt; 2/ try put some heavier implementation of
&gt; &gt; &gt; &gt; &gt; &gt; openssl_threadid_func&#40;&#41; in
&gt; &gt; &gt; &gt; &gt; &gt; net-ssleay
&gt; &gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; &gt; To test idea 2/ could you please revert to rev321 +
&gt; &gt; &gt; &gt; &gt; &gt; apply
&gt; &gt; &gt; &gt; &gt; &gt; enclosed
&gt; &gt; &gt; &gt; &gt; &gt; debug+pthreads_self_hack_r321.diff ?
</div>&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; probably you are expected any other result:
&gt; &gt; &gt; &gt; &gt; # service apache2 restart
&gt; &gt; &gt; &gt; &gt; Restarting web server: apache2DEBUG: BOOT start
&gt; &gt; &gt; &gt; &gt; DEBUG: init - begin
&gt; &gt; &gt; &gt; &gt; DEBUG: setting static locking
&gt; &gt; &gt; &gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; &gt; &gt; &gt; DEBUG: init - end
&gt; &gt; &gt; &gt; &gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; &gt; &gt; &gt; &gt; Segmentation fault
&gt; &gt; &gt; &gt; &gt; Action &#39;start&#39; failed.
&gt; &gt; &gt; &gt; &gt; The Apache error log may have more information.
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt;  failed!
&gt; &gt; &gt; &gt; &gt; 
&gt; &gt; &gt; &gt; &gt; palik
</div></div></div></div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055824" href="/Public/Bug/Display.html?id=75841#txn-1055824">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;04:54:41&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 10:54:29 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055824/552397/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552397">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">With more info about this issue I thing that the only way to make it 
work is to simply somehow skip openssl thread locking initialization in 
Net::SSleay when running under Apache+mod_perl+mod_ssl

1/ If we can assure that mod_ssl loads + initializes thread locking 
&#34;reliably-before&#34; Net::SSley is loaded then I hope our 
openssl_threads_init&#40;&#41; will detect such a situation and will not 
initialize openssl thread locking again

2/ If we can detect &#40;inside SSLeay.xs&#39;s BOOT: section&#41; that we are 
running under mod_perl then we can completely skip the call to 
openssl_threads_init&#40;&#41;

Anyway:
- Net::SSLeay is able to work 100% correctly with openssl thread locking 
setup by mod_ssl
- mod_ssl is IMHO sooner or later gonna crash with openssl thread 
locking setup by Net::SSLeay &#40;as Net::SSLeay is not aware of other 
threads than perl-ithreads&#41;

Ad mod_perl detection  I have found:
<span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/9668392/how-can-my-perl-program-tell-if-is-running-under-mod-perl">http://stackoverflow.com/questions/9668392/how-can-my-perl-program-tell-if-is-running-under-mod-perl</a></span>

So what about a simple patch in BOOT section like:
- openssl_threads_init&#40;&#41;;
+ if &#40;!PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;&#41; openssl_threads_init&#40;&#41;;

can anyone test this?

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055895" href="/Public/Bug/Display.html?id=75841#txn-1055895">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;07:28:20&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 21:28:17 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055895/552436/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552436">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Wednesday, March 28, 2012 04:54:41 AM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; With more info about this issue I thing that the only way to make it
&gt; work is to simply somehow skip openssl thread locking initialization in
&gt; Net::SSleay when running under Apache+mod_perl+mod_ssl
&gt; 
&gt; 1/ If we can assure that mod_ssl loads + initializes thread locking
&gt; &#34;reliably-before&#34; Net::SSley is loaded then I hope our
&gt; openssl_threads_init&#40;&#41; will detect such a situation and will not
&gt; initialize openssl thread locking again
&gt; 
&gt; 2/ If we can detect &#40;inside SSLeay.xs&#39;s BOOT: section&#41; that we are
&gt; running under mod_perl then we can completely skip the call to
&gt; openssl_threads_init&#40;&#41;
&gt; 
&gt; Anyway:
&gt; - Net::SSLeay is able to work 100% correctly with openssl thread locking
&gt; setup by mod_ssl
&gt; - mod_ssl is IMHO sooner or later gonna crash with openssl thread
&gt; locking setup by Net::SSLeay &#40;as Net::SSLeay is not aware of other
&gt; threads than perl-ithreads&#41;
&gt; 
&gt; Ad mod_perl detection  I have found:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://stackoverflow.com/questions/9668392/how-can-my-perl-program-tell-if-i">http://stackoverflow.com/questions/9668392/how-can-my-perl-program-tell-if-i</a></span>
&gt; s-running-under-mod-perl
&gt; 
&gt; So what about a simple patch in BOOT section like:
&gt; - openssl_threads_init&#40;&#41;;
&gt; + if &#40;!PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;&#41; openssl_threads_init&#40;&#41;;
&gt; 
&gt; can anyone test this?
</div>
Yes, it works fine in almost every case

Fine on linux and windows &#40;not under apache&#41;

On Wheezy/Sid apache
PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
does not detect that we are running under mod-perl, therfore 
openssl_threads_init&#40;&#41; stil runs therefore crash.

Strangely, on Squeeze apache, it works fine and openssl_threads_init&#40;&#41; does 
not run.

Who sets the env var MOD_PERL? When?

Nearly There!!!!!

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055898" href="/Public/Bug/Display.html?id=75841#txn-1055898">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;07:37:21&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 13:37:10 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055898/552439/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552439">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 554b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Wheezy/Sid apache
&gt; PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
&gt; does not detect that we are running under mod-perl, therfore
&gt; openssl_threads_init&#40;&#41; stil runs therefore crash.
&gt;
&gt; Strangely, on Squeeze apache, it works fine and openssl_threads_init&#40;&#41; does
&gt; not run.
&gt;
&gt; Who sets the env var MOD_PERL? When?
&gt;    
</div>
More info here: 
<span class="clickylink"><a target="new" rel="nofollow" href="http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Variables">http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Variables</a></span>

Quote: &#34;If $ENV{MOD_PERL} doesn&#39;t exist, most likely you are not running 
under mod_perl.&#34;

Maybe try MOD_PERL_API_VERSION instead of MOD_PERL

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055901" href="/Public/Bug/Display.html?id=75841#txn-1055901">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;08:02:16&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 22:02:14 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055901/552442/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552442">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


On Wednesday, March 28, 2012 07:37:25 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; On Wheezy/Sid apache
&gt; &gt; PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
&gt; &gt; does not detect that we are running under mod-perl, therfore
&gt; &gt; openssl_threads_init&#40;&#41; stil runs therefore crash.
&gt; &gt; 
&gt; &gt; Strangely, on Squeeze apache, it works fine and openssl_threads_init&#40;&#41;
&gt; &gt; does not run.
&gt; &gt; 
&gt; &gt; Who sets the env var MOD_PERL? When?
</div>&gt; 
&gt; More info here:
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Variable">http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Variable</a></span>
&gt; s
&gt; 
&gt; Quote: &#34;If $ENV{MOD_PERL} doesn&#39;t exist, most likely you are not running
&gt; under mod_perl.&#34;
</div>
Yes, I read that, but both 

PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
and
PerlEnv_getenv&#40;&#34;MOD_PERL_API_VERSION&#34;&#41;

both return NULL inside BOOT on both Wheezy and Squeeze.

I incorrectly stated it was OK on Squeeze before. My mistake. Forgot I had 
disabled Net::SSLeay in mod_perl.

I dont know why the env vars are not detected. Perhaps they are set after the 
PerlModule modules are loaded?

Are you sure PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41; will get them it?

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Maybe try MOD_PERL_API_VERSION instead of MOD_PERL
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055904" href="/Public/Bug/Display.html?id=75841#txn-1055904">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;08:02:22&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 14:02:12 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055904/552446/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552446">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 247b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Mike,

maybe slightly OT - I propose adding &#40;permanently&#41; more diagnostics into 
SSLeay.xs - see a simple patch more_xs_debug_diagnostics_r331.diff

it is normally turned off, it can be enabled by: perl Makefile.PL 
DEFINE=-DSHOW_XS_DEBUG

--
kmx
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055904/552447/more_xs_debug_diagnostics_r331.diff">Download more_xs_debug_diagnostics_r331.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055907" href="/Public/Bug/Display.html?id=75841#txn-1055907">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;08:08:06&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 22:08:08 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055907/552450/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552450">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi again,

more on this:


On Wednesday, March 28, 2012 10:02:14 PM Mike McCauley wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; On Wednesday, March 28, 2012 07:37:25 AM you wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt;  
<div class="message-stanza open">&gt; &gt; &gt; On Wheezy/Sid apache
&gt; &gt; &gt; PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
&gt; &gt; &gt; does not detect that we are running under mod-perl, therfore
&gt; &gt; &gt; openssl_threads_init&#40;&#41; stil runs therefore crash.
&gt; &gt; &gt; 
&gt; &gt; &gt; Strangely, on Squeeze apache, it works fine and
&gt; &gt; &gt; openssl_threads_init&#40;&#41;
&gt; &gt; &gt; does not run.
&gt; &gt; &gt; 
&gt; &gt; &gt; Who sets the env var MOD_PERL? When?
</div>&gt; &gt; 
&gt; &gt; More info here:
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Vari">http://perl.apache.org/docs/2.0/user/coding/coding.html#Environment_Vari</a></span>
&gt; &gt; able s
&gt; &gt; 
&gt; &gt; Quote: &#34;If $ENV{MOD_PERL} doesn&#39;t exist, most likely you are not running
&gt; &gt; under mod_perl.&#34;
</div>&gt; 
&gt; Yes, I read that, but both
&gt; 
&gt; PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;
&gt; and
&gt; PerlEnv_getenv&#40;&#34;MOD_PERL_API_VERSION&#34;&#41;
&gt; 
&gt; both return NULL inside BOOT on both Wheezy and Squeeze.
&gt; 
&gt; I incorrectly stated it was OK on Squeeze before. My mistake. Forgot I had
&gt; disabled Net::SSLeay in mod_perl.
&gt; 
&gt; I dont know why the env vars are not detected. Perhaps they are set after
&gt; the PerlModule modules are loaded?
&gt; 
&gt; Are you sure PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41; will get them it?
</div>

Hmm perl code 
print &#34;HERE $ENV{MOD_PERL}\n&#34;;
at the top of Net::SSLeay.pm sees MOD_PERL set, but 
printf&#40;&#34;HERE %s\n&#34;, PerlEnv_getenv&#40;&#34;MOD_PERL&#34;&#41;&#41;;
in BOOT does not, even though it runs AFTER the perl code.

I note that mod_perl adds MOD_PERL direct to the ENV hash, and not to the 
actual process environment. Is that relevant? Where does PerlEnv_getenv get it 
from?



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Cheers.
&gt; 
<div class="message-stanza open">&gt; &gt; Maybe try MOD_PERL_API_VERSION instead of MOD_PERL
&gt; &gt; 
&gt; &gt; --
&gt; &gt; kmx
</div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055910" href="/Public/Bug/Display.html?id=75841#txn-1055910">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;08:10:59&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 22:11:02 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055910/552453/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552453">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

yes, that looks fine. Ill apply it tomorrow... I think we are very close on 
the apache segfault thing, so lets sort that first.

Cheers.

On Wednesday, March 28, 2012 08:02:23 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Mike,
&gt; 
&gt; maybe slightly OT - I propose adding &#40;permanently&#41; more diagnostics into
&gt; SSLeay.xs - see a simple patch more_xs_debug_diagnostics_r331.diff
&gt; 
&gt; it is normally turned off, it can be enabled by: perl Makefile.PL
&gt; DEFINE=-DSHOW_XS_DEBUG
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055925" href="/Public/Bug/Display.html?id=75841#txn-1055925">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;09:00:32&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 15:00:21 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055925/552463/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552463">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 274b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I note that mod_perl adds MOD_PERL direct to the ENV hash, and not to the
&gt; actual process environment. Is that relevant? Where does PerlEnv_getenv get it
&gt; from?
&gt;    
</div>
In that case try:

if &#40;hv_fetch&#40;get_hv&#40;&#34;ENV&#34;, 1&#41;, &#34;MOD_PERL&#34;, 8, 0&#41;&#41; openssl_threads_init&#40;&#41;;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1055928" href="/Public/Bug/Display.html?id=75841#txn-1055928">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;09:02:05&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 28 Mar 2012 15:01:55 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1055928/552466/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552466">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 91b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry I meant:

if &#40;!hv_fetch&#40;get_hv&#40;&#34;ENV&#34;, 1&#41;, &#34;MOD_PERL&#34;, 8, 0&#41;&#41; openssl_threads_init&#40;&#41;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1056099" href="/Public/Bug/Display.html?id=75841#txn-1056099">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;16:56:18&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 Mar 2012 06:56:22 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1056099/552544/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552544">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 903b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Yes that works fine everywhere.
Great Work!

Cheers.

On Wednesday, March 28, 2012 09:02:06 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Sorry I meant:
&gt; 
&gt; if &#40;!hv_fetch&#40;get_hv&#40;&#34;ENV&#34;, 1&#41;, &#34;MOD_PERL&#34;, 8, 0&#41;&#41; openssl_threads_init&#40;&#41;;
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1056102" href="/Public/Bug/Display.html?id=75841#txn-1056102">#</a>      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;28&nbsp;17:02:40&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 29 Mar 2012 07:02:44 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1056102/552547/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552547">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">HI,

Thanks.
Most of this is now in commit 332, along with the Debian segfault fix.

On Wednesday, March 28, 2012 08:02:23 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Mike,
&gt; 
&gt; maybe slightly OT - I propose adding &#40;permanently&#41; more diagnostics into
&gt; SSLeay.xs - see a simple patch more_xs_debug_diagnostics_r331.diff
&gt; 
&gt; it is normally turned off, it can be enabled by: perl Makefile.PL
&gt; DEFINE=-DSHOW_XS_DEBUG
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1056917" href="/Public/Bug/Display.html?id=75841#txn-1056917">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;31&nbsp;03:19:02&nbsp;2012</span>
    <span class="description">carnil [...] debian.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de, kmx [...] cpan.org, 661566-submitter [...] bugs.debian.org, 661566 [...] bugs.debian.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 31 Mar 2012 09:18:50 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;mikem [...] open.com.au via RT&#34; &lt;bug-Net-SSLeay [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Salvatore Bonaccorso &lt;carnil [...] debian.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1056917/552957/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/552957">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 571b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all

On Wed, Mar 28, 2012 at 04:56:20PM -0400, mikem@open.com.au via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; Yes that works fine everywhere.
&gt; Great Work!
</div>
Sorry for the late answer, I was quite busy.

I tried the patch from [1] applied to the Debian package.

 [1] <span class="clickylink"><a target="new" rel="nofollow" href="http://anonscm.debian.org/viewvc/net-ssleay/trunk/SSLeay.xs?r1=331&#38;r2=332">http://anonscm.debian.org/viewvc/net-ssleay/trunk/SSLeay.xs?r1=331&#38;r2=332</a></span>

Apache2 at least does not segfault now anymore. I applied the patch to
our git repository, but haven&#39;t uploaded yet.

Many thanks for your work on this issue!

Best regards,
Salvatore
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1056917/552958/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 836b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1057685" href="/Public/Bug/Display.html?id=75841#txn-1057685">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;04:40:28&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #75841] libnet-ssleay-perl: Segfault when lniked into an Apache/mod_ssl/mod_perl process</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 02 Apr 2012 18:40:35 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1057685/553364/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553364">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks for testing.
We expect to make a new full release very soon.

Cheers.

On Saturday, March 31, 2012 03:19:04 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; 
&gt; Hi all
&gt; 
&gt; On Wed, Mar 28, 2012 at 04:56:20PM -0400, mikem@open.com.au via RT wrote:
<div class="message-stanza open">&gt; &gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=75841">https://rt.cpan.org/Ticket/Display.html?id=75841</a></span> &gt;
&gt; &gt; 
&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; Yes that works fine everywhere.
&gt; &gt; Great Work!
</div>&gt; 
&gt; Sorry for the late answer, I was quite busy.
&gt; 
&gt; I tried the patch from [1] applied to the Debian package.
&gt; 
&gt;  [1]
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://anonscm.debian.org/viewvc/net-ssleay/trunk/SSLeay.xs?r1=331&#38;r2=332">http://anonscm.debian.org/viewvc/net-ssleay/trunk/SSLeay.xs?r1=331&#38;r2=332</a></span>
&gt; 
&gt; Apache2 at least does not segfault now anymore. I applied the patch to
&gt; our git repository, but haven&#39;t uploaded yet.
&gt; 
&gt; Many thanks for your work on this issue!
&gt; 
&gt; Best regards,
&gt; Salvatore
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058026" href="/Public/Bug/Display.html?id=75841#txn-1058026">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;17:11:14&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">600 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1058026/553551/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/553551">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 44b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">New release 1.46 today will include this fix
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1058029" href="/Public/Bug/Display.html?id=75841#txn-1058029">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;02&nbsp;17:11:15&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.487146</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
