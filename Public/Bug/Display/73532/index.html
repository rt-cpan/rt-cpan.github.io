<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #73532 for Net-SSLeay: using Net::SSLeay in threads</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #73532 for Net-SSLeay: using Net::SSLeay in threads</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSLeay/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSLeay/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSLeay">Net-SSLeay CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">73532</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">10 hours (600 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSLeay/Active/">Net-SSLeay</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">MIKEM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
info [...] maximka.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
kmx [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44414-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-44415-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;28&nbsp;04:06:18&nbsp;2011</span>
    <span class="description">info [...] maximka.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> using Net::SSLeay in threads</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

unfortunately is using of Net::SSLeay for HTTPS requests in perl-threads impossible. The on 
ticket attached script produce in all test environments, such as debian lenny and squeeze or 
ubuntu 10.4, following exception:

*** glibc detected *** perl: double free or corruption &#40;fasttop&#41;: 0xb58d0f80 ***
======= Backtrace: =========
/lib/tls/i686/cmov/libc.so.6&#40;+0x6b591&#41;[0xe5b591]
/lib/tls/i686/cmov/libc.so.6&#40;+0x6cde8&#41;[0xe5cde8]
/lib/tls/i686/cmov/libc.so.6&#40;cfree+0x6d&#41;[0xe5fecd]
/lib/i686/cmov/libcrypto.so.0.9.8&#40;CRYPTO_free+0x3a&#41;[0x31a03a]
/lib/i686/cmov/libcrypto.so.0.9.8&#40;OBJ_NAME_add+0x9d&#41;[0x31d7cd]
/lib/i686/cmov/libcrypto.so.0.9.8&#40;EVP_add_cipher+0x5a&#41;[0x38f71a]
/lib/i686/cmov/libssl.so.0.9.8&#40;SSL_library_init+0x26&#41;[0x14d0c6]
/usr/lib/perl5/auto/Net/SSLeay/SSLeay.so&#40;XS_Net__SSLeay_library_init+0xe0&#41;[0x1fe070]
perl&#40;Perl_pp_entersub+0x533&#41;[0x80d5af3]
perl&#40;Perl_runops_standard+0x18&#41;[0x80d3ee8]
perl&#40;Perl_call_sv+0x42a&#41;[0x807beaa]
/usr/lib/perl/5.10/auto/threads/threads.so&#40;+0x60b2&#41;[0xb130b2]
/lib/tls/i686/cmov/libpthread.so.0&#40;+0x596e&#41;[0x18e96e]
/lib/tls/i686/cmov/libc.so.6&#40;clone+0x5e&#41;[0xebda4e]

Best regards,
palik
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> threads_net_ssleay-2.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl 

use v5.10;
use strict;
use warnings;

use Net::SSLeay;
use threads;

#$Net::SSLeay::trace = 2;

my $i = 1;

while &#40;1&#41; {
    threads-&gt;new&#40;&#39;create_thread&#39;&#41; for &#40;1 .. 3&#41;;

    foreach &#40;threads-&gt;list&#41; {
        $_-&gt;join;
    }

    say &#34;loop&#40;&#34;, $i++, &#34;&#41; &#34;, &#39;-&#39; x 20;
} ## end while &#40;1&#41;

sub create_thread {
    my $tid = threads-&gt;tid;

    threads-&gt;set_thread_exit_only&#40;1&#41;;

    print &#34;\tcreate_thread&#40;$tid&#41;&#34;;

    sleep&#40;rand&#40;3&#41;&#41;;

    my &#40;$page, $response, %reply_headers&#41;
        = Net::SSLeay::get_https&#40;&#39;localhost&#39;, 443, &#39;/&#39;&#41;;

    say join &#34; &#34;, &#34;\tresp-code:&#34;, $response, &#34;length:&#34;, length&#40;$page&#41;;

    threads-&gt;exit&#40;0&#41;;
} ## end sub create_thread

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;13&nbsp;16:42:30&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
initial tests here show this working OK, so prob some dependency on 
perl or os version.

Can you please tell me exact versions of:
os
perl
openssl
net-ssleay

that you test with?

Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;13&nbsp;16:42:32&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Give even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;13&nbsp;16:42:32&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Given to MIKEM</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;16&nbsp;12:26:34&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for your response. It takes sometimes the hours before the script produce the 
execution. But as I said in all fallowing environments the script died:
Debian GNU/Linux 6.0
perl 5.10.1
openssl 0.9.8o-4squeeze4
Net::SSLeay 1.36
--
Debian GNU/Linux 5.0
perl 5.10.1
openssl 0.9.8g-15+lenny14
Net::SSLeay 1.35
--
Ubuntu 10.04.3 LTS
perl 5.10.1
openssl 0.9.8k-7ubuntu8.6
Net::SSLeay 1.35

regards,
palik

On Fri Jan 13 16:42:30 2012, MIKEM wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; initial tests here show this working OK, so prob some dependency on 
&gt; perl or os version.
&gt; 
&gt; Can you please tell me exact versions of:
&gt; os
&gt; perl
&gt; openssl
&gt; net-ssleay
&gt; 
&gt; that you test with?
&gt; 
&gt; Cheers.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;17&nbsp;03:36:07&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza">According to <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span> to be using openssl in thread-safe manners we need to define some special locking related functions.<br>

<br>

See enclosed patch with my idea how to implement it - BEWARE: it is just an idea which still crashed couple of times during my testing - unfortunately not easily reproducible.<br>

<br>

Another issue might be related to static data in XS code. According <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlxs.html">http://perldoc.perl.org/perlxs.html</a></span> it might be a good idea to armour them with MY_CXT* macros (see <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlxs.html&#41;">http://perldoc.perl.org/perlxs.html&#41;</a></span>.<br>

<br>

--<br>

kmx<br>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-ssleay-thead-safety-idea.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 282&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -85,6 +85,92 @@
 
 typedef int perl_filehandle_t;
 
+/* ============= thread-safely calling openssl lib ============== */
+/* more info: <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>     */
+
+#ifdef USE_ITHREADS
+
+#if defined&#40;WIN32&#41;
+
+static HANDLE *lock_cs;
+static DWORD creator_thread_id;
+
+static void openssl_locking_function&#40;int mode, int type, const char *file, int line&#41;
+{
+    if &#40;mode &#38; CRYPTO_LOCK&#41;
+        WaitForSingleObject&#40;lock_cs[type],INFINITE&#41;;
+    else
+        ReleaseMutex&#40;lock_cs[type]&#41;;
+}
+
+static void openssl_threads_init&#40;&#41;
+{
+    int i;
+    lock_cs=malloc&#40;CRYPTO_num_locks&#40;&#41; * sizeof&#40;HANDLE&#41;&#41;;
+    creator_thread_id = GetCurrentThreadId&#40;&#41;;
+    for &#40;i=0; i&lt;CRYPTO_num_locks&#40;&#41;; i++&#41; lock_cs[i]=CreateMutex&#40;NULL,FALSE,NULL&#41;;
+    CRYPTO_set_locking_callback&#40;&#40;void &#40;*&#41;&#40;int,int,const char *,int&#41;&#41;openssl_locking_function&#41;;
+    /* no need for threadid_func&#40;&#41; on Win32 - see openssl docuemtation */
+}
+
+static void openssl_threads_cleanup&#40;&#41;
+{
+    int i;
+    CRYPTO_set_locking_callback&#40;NULL&#41;;
+    if &#40;lock_cs &#38;&#38; creator_thread_id == GetCurrentThreadId&#40;&#41;&#41; {
+        for &#40;i=0; i&lt;CRYPTO_num_locks&#40;&#41;; i++&#41; CloseHandle&#40;lock_cs[i]&#41;;
+        free&#40;lock_cs&#41;;
+    }
+}
+
+#elif defined&#40;PTHREADS&#41;
+
+static void openssl_locking_function&#40;int mode, int type, const char *file, int line&#41;
+{
+    if &#40;mode &#38; CRYPTO_LOCK&#41;
+        pthread_mutex_lock&#40;&#38;&#40;lock_cs[type]&#41;&#41;;
+    else
+        pthread_mutex_unlock&#40;&#38;&#40;lock_cs[type]&#41;&#41;;
+}
+
+static unsigned long openssl_threadid_func&#40;&#41;
+{
+    return &#40;unsigned long&#41;pthread_self&#40;&#41;;
+}
+
+static void openssl_threads_init&#40;&#41;
+{
+    int i;
+    lock_cs=malloc&#40;CRYPTO_num_locks&#40;&#41; * sizeof&#40;pthread_mutex_t&#41;&#41;;    
+    for &#40;i=0; i&lt;CRYPTO_num_locks&#40;&#41;; i++&#41; pthread_mutex_init&#40;&#38;&#40;lock_cs[i]&#41;,NULL&#41;;
+    CRYPTO_set_locking_callback&#40;&#40;void &#40;*&#41;&#40;int,int,const char *,int&#41;&#41;openssl_locking_function&#41;;
+    CRYPTO_set_id_callback&#40;&#40;unsigned long &#40;*&#41;&#40;&#41;&#41;openssl_threadid_func&#41;;
+}
+
+static void openssl_threads_cleanup&#40;&#41;
+{
+    int i;
+    CRYPTO_set_locking_callback&#40;NULL&#41;;
+    CRYPTO_set_id_callback&#40;NULL&#41;;
+    for &#40;i=0; i&lt;CRYPTO_num_locks&#40;&#41;; i++&#41;  pthread_mutex_destroy&#40;&#38;&#40;dMY_CXTlock_cs[i]&#41;&#41;;
+    free&#40;lock_cs&#41;;
+}
+
+#else
+
+static void openssl_threads_init&#40;&#41;
+{
+    /* &#34;Warning: unknown threads framework, Net::SSLeay cannot be used thread-safely!\n&#34; */
+}
+
+static void openssl_threads_cleanup&#40;&#41;
+{
+}
+
+#endif
+
+#endif
+
 /* ============= callback stuff ============== */
 
 static HV* ssleay_ctx_verify_callbacks = &#40;HV*&#41;NULL;
@@ -649,6 +735,22 @@
 
 PROTOTYPES: ENABLE
 
+BOOT:
+{
+#ifdef USE_ITHREADS
+    openssl_threads_init&#40;&#41;;
+#endif
+}
+
+void
+END&#40;...&#41;
+CODE:
+{
+#ifdef USE_ITHREADS
+    openssl_threads_cleanup&#40;&#41;;
+#endif
+}
+
 double
 constant&#40;name&#41;
      char *		name
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;17&nbsp;03:37:01&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Cc KMX added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;17&nbsp;11:27:56&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza">I have prepared more intensive crash-test. See enclosed tarball (instructions in readme.txt).<br>

<br>

Should crash within no more than 1 minute.<br>

<br>

--<br>

kmx<br>

<br>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-ssleay-thread-crash.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;17&nbsp;22:26:59&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Jan 2012 13:26:31 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for that.
I can reproduce this bug now.
Working.....

Cheers.

On Tuesday, January 17, 2012 11:27:58 AM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; I have prepared more intensive crash-test. See enclosed tarball
&gt; &#40;instructions in readme.txt&#41;.
&gt; 
&gt; Should crash within no more than 1 minute.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;18&nbsp;01:31:36&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Jan 2012 16:31:05 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

thanks for the crash-test.
It appears this problem is due to the SSL library being reinitilised multiple 
times in the threads.

Net::SSLeay::get_https  reinitialises the library by calling 
SSLeay_add_ssl_algorithms &#40;which is really SSL_library_init&#41;, however, 
SSL_library_init is not reentrant, according to 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/ssl/SSL_library_init.html">http://www.openssl.org/docs/ssl/SSL_library_init.html</a></span>
and its seems that overlapping calls cause the double free.

If I arrange for the library to be initiliased exactly once, your crash-test 
runs forever &#40;or at least until the server side runs out of memory: it leaks 
badly&#41;

Seems that get_https was written long ago before threading was an issue, and 
making substantial changes to it now would break existing code.

Its not clear to me what is the best way to fix this, though: each thread cant 
see the perl variables in the other threads, so we cant use a perl flag to 
indicate that a thread has already initilised the SSL library.

Seems that the SSL library would have to be initialised once in the _calling_ 
code before threading starts, but this is going to need a change to calling 
code, as well as get_https. I cant see a way to contain the fix within 
SSLeay.pm :-&#40;

Cheers.


On Tuesday, January 17, 2012 10:27:00 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; thanks for that.
&gt; I can reproduce this bug now.
&gt; Working.....
&gt; 
&gt; Cheers.
&gt; 
&gt; On Tuesday, January 17, 2012 11:27:58 AM kmx via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt; 
&gt; &gt; I have prepared more intensive crash-test. See enclosed tarball
&gt; &gt; &#40;instructions in readme.txt&#41;.
&gt; &gt; 
&gt; &gt; Should crash within no more than 1 minute.
&gt; &gt; 
&gt; &gt; --
&gt; &gt; kmx
</div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;18&nbsp;05:02:06&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems that get_https was written long ago before threading was
</div>
My script use get_https to simplify testing. But the sslcat and post_https methods produce same 
exception. 

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;18&nbsp;06:27:17&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Jan 2012 21:26:36 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wednesday, January 18, 2012 05:02:07 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
<div class="message-stanza open">&gt; &gt; Seems that get_https was written long ago before threading was
</div>&gt; 
&gt; My script use get_https to simplify testing. But the sslcat and post_https
&gt; methods produce same exception.
</div>
Yes, both of those have the same problem for the same reason.

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; regards,
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;18&nbsp;13:46:24&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 18 Jan 2012 19:46:10 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::SSLeay::get_https  reinitialises the library by calling
&gt; SSLeay_add_ssl_algorithms &#40;which is really SSL_library_init&#41;, however,
&gt; SSL_library_init is not reentrant, according to
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/ssl/SSL_library_init.html">http://www.openssl.org/docs/ssl/SSL_library_init.html</a></span>
&gt; and its seems that overlapping calls cause the double free.
&gt;
&gt; If I arrange for the library to be initiliased exactly once, your crash-test
&gt; runs forever &#40;or at least until the server side runs out of memory: it leaks
&gt; badly&#41;
&gt;    
</div>
Do you have a guess whether it is my code or Net::SSLeay leaking? The 
thing is that I am more interested in multi-threaded use of Net::SSLeay 
on server side.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems that get_https was written long ago before threading was an issue, and
&gt; making substantial changes to it now would break existing code.
&gt;
&gt; Its not clear to me what is the best way to fix this, though: each thread cant
&gt; see the perl variables in the other threads, so we cant use a perl flag to
&gt; indicate that a thread has already initilised the SSL library.
&gt;    
</div>To share a variable between threads perhaps SvSHARE might come handy 
&#40;see <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;">http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;</a></span> but it will 
probably also require some kind of locking.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Seems that the SSL library would have to be initialised once in the _calling_
&gt; code before threading starts, but this is going to need a change to calling
&gt; code, as well as get_https. I cant see a way to contain the fix within
&gt; SSLeay.pm :-&#40;
&gt;    
</div>
What about to use BOOT: section of SSLeay.xs like this:

1/ put into BOOT:
load_error_strings&#40;&#41;;
SSLeay_add_ssl_algorithms&#40;&#41;;
&#40;which - I hope - means that this initialization will done exactly once 
when you &#34;use Net::SSLeay&#34;&#41;

2/ remove all usage of SSLeay_add_ssl_algorithms and load_error_strings 
from *.pm

3/ in SSLeay.xs replace SSL_library_init and load_error_strings with 
empty subs or deprecation warning

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;18&nbsp;17:52:24&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 08:51:52 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Wednesday, January 18, 2012 01:46:26 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Net::SSLeay::get_https  reinitialises the library by calling
&gt; &gt; SSLeay_add_ssl_algorithms &#40;which is really SSL_library_init&#41;, however,
&gt; &gt; SSL_library_init is not reentrant, according to
&gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/ssl/SSL_library_init.html">http://www.openssl.org/docs/ssl/SSL_library_init.html</a></span>
&gt; &gt; and its seems that overlapping calls cause the double free.
&gt; &gt; 
&gt; &gt; If I arrange for the library to be initiliased exactly once, your
&gt; &gt; crash-test runs forever &#40;or at least until the server side runs out of
&gt; &gt; memory: it leaks badly&#41;
</div>&gt; 
&gt; Do you have a guess whether it is my code or Net::SSLeay leaking? The
&gt; thing is that I am more interested in multi-threaded use of Net::SSLeay
&gt; on server side.
</div>
I have not looked. But I can tell you that I use net-ssleay a lot as a server 
without leaks. However I dont use the Net::SSLeay::set_fd interface.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; Seems that get_https was written long ago before threading was an issue,
&gt; &gt; and making substantial changes to it now would break existing code.
&gt; &gt; 
&gt; &gt; Its not clear to me what is the best way to fix this, though: each
&gt; &gt; thread cant see the perl variables in the other threads, so we cant use
&gt; &gt; a perl flag to indicate that a thread has already initilised the SSL
&gt; &gt; library.
</div>&gt; 
&gt; To share a variable between threads perhaps SvSHARE might come handy
&gt; &#40;see <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;">http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;</a></span> but it will
&gt; probably also require some kind of locking.
&gt; 
<div class="message-stanza open">&gt; &gt; Seems that the SSL library would have to be initialised once in the
&gt; &gt; _calling_ code before threading starts, but this is going to need a
&gt; &gt; change to calling code, as well as get_https. I cant see a way to
&gt; &gt; contain the fix within SSLeay.pm :-&#40;
</div>&gt; 
&gt; What about to use BOOT: section of SSLeay.xs like this:
&gt; 
&gt; 1/ put into BOOT:
&gt; load_error_strings&#40;&#41;;
&gt; SSLeay_add_ssl_algorithms&#40;&#41;;
&gt; &#40;which - I hope - means that this initialization will done exactly once
&gt; when you &#34;use Net::SSLeay&#34;&#41;
&gt; 
&gt; 2/ remove all usage of SSLeay_add_ssl_algorithms and load_error_strings
&gt; from *.pm
&gt; 
&gt; 3/ in SSLeay.xs replace SSL_library_init and load_error_strings with
&gt; empty subs or deprecation warning
</div>
Except that some people need to initialise in a different way, and at 
different times.


My preferred option now is to change SSLeay.pm so:

1. The initilaisation code that the SSLeay.pm functions use is moved to a sub, 
and the sub uses a flag to only initialise once. This will allow existing non-
threaded code that uses https_cat and sslcat to continue to run unchanged

2. Require code that uses  https_cat and sslcat in multiple threads to call 
that initialisation function before threading starts.

Code that does not use https_cat and sslcat would continue to initialise the 
library in their current way unchanged, but they could use the new init 
function if they wanted.

I think this means that existing code will continue to run, and the only code 
that would have to change is threaded code that uses https_cat and sslcat 
&#40;like yours&#41; which does not work correctly anyway.

Views?

Cheers.



<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;04:41:48&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 10:41:32 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; Do you have a guess whether it is my code or Net::SSLeay leaking? The
&gt;&gt; thing is that I am more interested in multi-threaded use of Net::SSLeay
&gt;&gt; on server side.
&gt;&gt;      
</div>&gt; I have not looked. But I can tell you that I use net-ssleay a lot as a server
&gt; without leaks. However I dont use the Net::SSLeay::set_fd interface.
&gt;    
</div>
As I have a tcp dispatcher in a separate thread I have to pass somehow 
the accepted socket between threads. As far as I have googled it is not 
completely safe to pass IO::Socket::INET object, therefore I am passing 
fileno and need to call set_fd.

If we manage to make Net::SSLeay thread-safe enough I can polish a bit 
my crash test scripts and turn them into &lt;Net-SSLeay 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">tarball&gt;/examples/ssl-http-server-multi-threaded.pl + &lt;Net-SSLeay 
tarball&gt;/examples/ssl-http-client-multi-threaded.pl
</div>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My preferred option now is to change SSLeay.pm so:
&gt;
&gt; 1. The initilaisation code that the SSLeay.pm functions use is moved to a sub,
&gt; and the sub uses a flag to only initialise once. This will allow existing non-
&gt; threaded code that uses https_cat and sslcat to continue to run unchanged
&gt;
&gt; 2. Require code that uses  https_cat and sslcat in multiple threads to call
&gt; that initialisation function before threading starts.
&gt;
&gt; Code that does not use https_cat and sslcat would continue to initialise the
&gt; library in their current way unchanged, but they could use the new init
&gt; function if they wanted.
&gt;
&gt; I think this means that existing code will continue to run, and the only code
&gt; that would have to change is threaded code that uses https_cat and sslcat
&gt; &#40;like yours&#41; which does not work correctly anyway.
&gt;
&gt; Views?
&gt;    
</div>
I agree, your suggestion is more back-compat-friendly. As mentioned 
before I prefer to do proper locking to make it as thread-safe as 
possible - which means something like this:

[... near the start of SSLeay.xs ...]
/* ============= thread-safety related stuff ============== */
#define MY_CXT_KEY &#34;Net::SSLeay::_guts&#34; XS_VERSION

typedef struct {
     int initialized;
#ifdef USE_ITHREADS
     perl_mutex init_mutex;
#endif
} my_cxt_t;
START_MY_CXT;

[... later ...]

BOOT:
     MY_CXT_INIT;
     MY_CXT.initialized = 0;
#ifdef USE_ITHREADS
     MUTEX_INIT&#40;&#38;MY_CXT.init_mutex&#41;;
#endif

void
END&#40;...&#41;
CODE:
     dMY_CXT;
#ifdef USE_ITHREADS
     MUTEX_DESTROY&#40;&#38;MY_CXT.init_mutex&#41;;
#endif

void
CLONE&#40;...&#41;
CODE:
     MY_CXT_CLONE;

[... new SSL_library_init&#40;&#41; ...]

int
SSL_library_init&#40;&#41;
     ALIAS:
         SSLeay_add_ssl_algorithms = 1
         OpenSSL_add_ssl_algorithms = 2
         add_ssl_algorithms = 3
     CODE:
         dMY_CXT;
#ifdef USE_ITHREADS
         MUTEX_LOCK&#40;&#38;MY_CXT.init_mutex&#41;;
#endif
         if &#40;!MY_CXT.initialized&#41; {
             SSL_library_init&#40;&#41;;
#ifdef USE_ITHREADS
             /* maybe do also some other thread-safety init things here: 
CRYPTO_set_locking_callback &#38; co. */
#endif
             MY_CXT.initialized = 1;
         }
#ifdef USE_ITHREADS
         MUTEX_UNLOCK&#40;&#38;MY_CXT.init_mutex&#41;;
#endif


TODO:
1/ I am not sure what exactly should be done in CLONE&#40;&#41; and END&#40;&#41; functions
1/ might it be good for something/someone to have a function like 
SSL_libraty_init_status&#40;&#41; - returning current MY_CXT.initialized value ?
3/ would you agree to add also things related to 
CRYPTO_set_locking_callback ?
         see <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
         or multi-threaded example 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.opensource.apple.com/source/OpenSSL/OpenSSL-10/openssl/crypto/threads/mttest.c">http://www.opensource.apple.com/source/OpenSSL/OpenSSL-10/openssl/crypto/threads/mttest.c</a></span> 
&#40;or check mttest.c from original openssl tarball&#41;

--
kmx
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;05:16:43&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; As far as I have googled it is not
&gt; completely safe to pass IO::Socket::INET object, therefore I am
&gt; passing
</div>
I&#39;m tried to use IO::SOCKET::SSL, wich ist inherits von IO::Socket::INET. It&#39;s not thread safe.
But Socket::Class::SSL works well with threads.

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;05:45:33&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 11:45:24 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m tried to use IO::SOCKET::SSL, wich ist inherits von IO::Socket::INET. It&#39;s not thread safe.
&gt; But Socket::Class::SSL works well with threads.
&gt;    
</div>
Thanks a lot for pointig to Socket::Class::SSL

Which makes me think about a scenario when we have two different modules 
using openssl loaded in the same multithreaded perl application.

e.g.
1/ NetSSLeay
2/ Socket::Class::SSL

Both of them will at some point call non-reentrant SSL_library_init&#40;&#41; 
function &#40;either from the main or another thread&#41; - I have a feeling 
that some strange things can happen.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;08:24:21&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Which makes me think about a scenario when we have two different
&gt; modules
&gt; using openssl loaded in the same multithreaded perl application.
&gt; 
&gt; e.g.
&gt; 1/ NetSSLeay
&gt; 2/ Socket::Class::SSL
</div>
I couldn&#39;t see any reason to use both of them in a same application at all, but it&#39;s probable.

There are many ifdef USE_ITHREADS blocks in
--
Socket-Class-2.256$ grep  -r USE_ITHREADS *
Class.c:#ifdef USE_ITHREADS
...
--

I added &#34;use Net::SSLeay;&#34; in a Socket::Class::SSL based test applikation. It works.

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;10:07:10&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> kmx [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 16:07:00 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I couldn&#39;t see any reason to use both of them in a same application at all, but it&#39;s probable.
&gt;    
</div>
For example I not only need SSLized sockets but also to do some X509 
related things &#40;but yes, in the end there will be some workaround&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are many ifdef USE_ITHREADS blocks in
&gt; --
&gt; Socket-Class-2.256$ grep  -r USE_ITHREADS *
&gt; Class.c:#ifdef USE_ITHREADS
&gt; ...
&gt; --
&gt;
&gt; I added &#34;use Net::SSLeay;&#34; in a Socket::Class::SSL based test applikation. It works.
&gt;    
</div>
You are right Socket::Class&#40;::SSL&#41; is definitely written with threads in 
mind but I have tried to rewrite the server side of my crash-test to 
Socket::Class::SSL and I am able to crash it as well &#40;well, it is much 
harder, but it crashes&#41;.

Things are maybe worse due to the fact that I am testing primarily on 
perl+Win32 platform.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;10:21:14&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 19 Jan 2012 16:21:04 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have not looked. But I can tell you that I use net-ssleay a lot as a server
&gt; without leaks. However I dont use the Net::SSLeay::set_fd interface.
&gt;    
</div>
my fault, there is missing Net::SSLeay::CTX_free in sub thread_worker 
&#40;httpd-multithreaded.pl&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;10:35:08&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">My today's Net::SSLeay hacking ended up with enclosed net-ssleay-thead-safety-proposal1.diff&nbsp; (diff against current SVN trunk).<br>

<br>

Crash test seems to be running fine for a very long time - testing on more-trouble-making-platform Win32.<br>

<br>

I am still not sure whether to completely  ignore openssl locking described in <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span><br>

<br>

--<br>

kmx<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;10:35:55&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza">now the attachment<br>

<br>
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-ssleay-thead-safety-proposal1.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: SSLeay.xs
===================================================================
--- SSLeay.xs	&#40;revision 282&#41;
+++ SSLeay.xs	&#40;working copy&#41;
@@ -74,6 +74,18 @@
 
 #include &#34;constants.c&#34;
 
+/* ============= thread-safety related stuff ============== */
+
+#define MY_CXT_KEY &#34;Net::SSLeay::_guts&#34; XS_VERSION
+
+typedef struct {
+    int initialized;
+#ifdef USE_ITHREADS
+    perl_mutex init_mutex;
+#endif
+} my_cxt_t;
+START_MY_CXT;
+
 /* ============= typedefs to agument TYPEMAP ============== */
 
 typedef void callback_no_ret&#40;void&#41;;
@@ -649,6 +661,28 @@
 
 PROTOTYPES: ENABLE
 
+BOOT:
+    MY_CXT_INIT;
+    MY_CXT.initialized = 0;
+#ifdef USE_ITHREADS
+    MUTEX_INIT&#40;&#38;MY_CXT.init_mutex&#41;;
+#endif
+
+void
+END&#40;...&#41;
+CODE:
+#ifdef USE_ITHREADS
+    dMY_CXT;
+    MUTEX_DESTROY&#40;&#38;MY_CXT.init_mutex&#41;;
+#endif
+
+void
+CLONE&#40;...&#41;
+CODE:
+#ifdef USE_ITHREADS
+	MY_CXT_CLONE;
+#endif
+
 double
 constant&#40;name&#41;
      char *		name
@@ -1332,10 +1366,22 @@
 
 int
 SSL_library_init&#40;&#41;
-	ALIAS:
-		SSLeay_add_ssl_algorithms  = 1
-		OpenSSL_add_ssl_algorithms = 2
-		add_ssl_algorithms         = 3
+    ALIAS:
+        SSLeay_add_ssl_algorithms = 1
+        OpenSSL_add_ssl_algorithms = 2
+        add_ssl_algorithms = 3
+    CODE:
+        dMY_CXT;
+#ifdef USE_ITHREADS
+        MUTEX_LOCK&#40;&#38;MY_CXT.init_mutex&#41;;
+#endif       
+        if &#40;!MY_CXT.initialized&#41; {
+            SSL_library_init&#40;&#41;;           
+            MY_CXT.initialized = 1;
+        }
+#ifdef USE_ITHREADS
+        MUTEX_UNLOCK&#40;&#38;MY_CXT.init_mutex&#41;;
+#endif
 
 void
 ENGINE_load_builtin_engines&#40;&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;19&nbsp;11:14:06&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Jan 19 10:35:08 2012, KMX wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My today&#39;s Net::SSLeay hacking ended up with enclosed
&gt; net-ssleay-thead-safety-proposal1.diff &#40;diff against current SVN
&gt; trunk&#41;.
</div>
after applying your patch to SSLeay.xs from cpan tarball 
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/CPAN/authors/id/M/MI/MIKEM/Net-SSLeay-1.42.tar.gz">http://search.cpan.org/CPAN/authors/id/M/MI/MIKEM/Net-SSLeay-1.42.tar.gz</a></span>
your net-ssleay-thread-crash scripts work well on Ubuntu 10.04.3 LTS too.

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;20&nbsp;11:26:16&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Crash test seems to be running fine for a very long time - testing on
&gt; more-trouble-making-platform Win32.
</div>
It works debian-squeeze without crashing too. An other test script, each thread execute two 
https requests first with Net::SSLeay::sslcat and second with Socket::Class::SSL::write/read didn&#39;t 
crashed too.

But there is a bad thing: memory usage growth continuous and fast.

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;21&nbsp;18:34:23&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Jan 2012 09:33:59 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi all,

I have now implemented the preferred solution as described below.

It is now available in CVS.

In order to use this fix in a multi threaded environment that uses get_https 
and friends &#40;such as net-ssleay-thread-crash suite posted here recently&#41;, you 
need to initialise the SSL library before threading starts:

# NO:
#Net::SSLeay::load_error_strings&#40;&#41;;
#Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
#Net::SSLeay::randomize&#40;&#41;;

Net::SSLeay::initialize&#40;&#41;;       # Do this instead

Please let me know how you go.

Cheers.


On Thursday, January 19, 2012 08:51:52 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; On Wednesday, January 18, 2012 01:46:26 PM you wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt;  
<div class="message-stanza open">&gt; &gt; &gt; Net::SSLeay::get_https  reinitialises the library by calling
&gt; &gt; &gt; SSLeay_add_ssl_algorithms &#40;which is really SSL_library_init&#41;,
&gt; &gt; &gt; however,
&gt; &gt; &gt; SSL_library_init is not reentrant, according to
&gt; &gt; &gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/ssl/SSL_library_init.html">http://www.openssl.org/docs/ssl/SSL_library_init.html</a></span>
&gt; &gt; &gt; and its seems that overlapping calls cause the double free.
&gt; &gt; &gt; 
&gt; &gt; &gt; If I arrange for the library to be initiliased exactly once, your
&gt; &gt; &gt; crash-test runs forever &#40;or at least until the server side runs out
&gt; &gt; &gt; of
&gt; &gt; &gt; memory: it leaks badly&#41;
</div>&gt; &gt; 
&gt; &gt; Do you have a guess whether it is my code or Net::SSLeay leaking? The
&gt; &gt; thing is that I am more interested in multi-threaded use of Net::SSLeay
&gt; &gt; on server side.
</div>&gt; 
&gt; I have not looked. But I can tell you that I use net-ssleay a lot as a
&gt; server without leaks. However I dont use the Net::SSLeay::set_fd interface.
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; Seems that get_https was written long ago before threading was an
&gt; &gt; &gt; issue, and making substantial changes to it now would break
&gt; &gt; &gt; existing code.
&gt; &gt; &gt; 
&gt; &gt; &gt; Its not clear to me what is the best way to fix this, though: each
&gt; &gt; &gt; thread cant see the perl variables in the other threads, so we cant
&gt; &gt; &gt; use
&gt; &gt; &gt; a perl flag to indicate that a thread has already initilised the SSL
&gt; &gt; &gt; library.
</div>&gt; &gt; 
&gt; &gt; To share a variable between threads perhaps SvSHARE might come handy
&gt; &gt; &#40;see <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;">http://perldoc.perl.org/perlapi.html#Magical-Functions&#41;</a></span> but it will
&gt; &gt; probably also require some kind of locking.
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; Seems that the SSL library would have to be initialised once in the
&gt; &gt; &gt; _calling_ code before threading starts, but this is going to need a
&gt; &gt; &gt; change to calling code, as well as get_https. I cant see a way to
&gt; &gt; &gt; contain the fix within SSLeay.pm :-&#40;
</div>&gt; &gt; 
&gt; &gt; What about to use BOOT: section of SSLeay.xs like this:
&gt; &gt; 
&gt; &gt; 1/ put into BOOT:
&gt; &gt; load_error_strings&#40;&#41;;
&gt; &gt; SSLeay_add_ssl_algorithms&#40;&#41;;
&gt; &gt; &#40;which - I hope - means that this initialization will done exactly once
&gt; &gt; when you &#34;use Net::SSLeay&#34;&#41;
&gt; &gt; 
&gt; &gt; 2/ remove all usage of SSLeay_add_ssl_algorithms and load_error_strings
&gt; &gt; from *.pm
&gt; &gt; 
&gt; &gt; 3/ in SSLeay.xs replace SSL_library_init and load_error_strings with
&gt; &gt; empty subs or deprecation warning
</div>&gt; 
&gt; Except that some people need to initialise in a different way, and at
&gt; different times.
&gt; 
&gt; 
&gt; My preferred option now is to change SSLeay.pm so:
&gt; 
&gt; 1. The initilaisation code that the SSLeay.pm functions use is moved to a
&gt; sub, and the sub uses a flag to only initialise once. This will allow
&gt; existing non- threaded code that uses https_cat and sslcat to continue to
&gt; run unchanged
&gt; 
&gt; 2. Require code that uses  https_cat and sslcat in multiple threads to call
&gt; that initialisation function before threading starts.
&gt; 
&gt; Code that does not use https_cat and sslcat would continue to initialise the
&gt; library in their current way unchanged, but they could use the new init
&gt; function if they wanted.
&gt; 
&gt; I think this means that existing code will continue to run, and the only
&gt; code that would have to change is threaded code that uses https_cat and
&gt; sslcat &#40;like yours&#41; which does not work correctly anyway.
&gt; 
&gt; Views?
&gt; 
&gt; Cheers.
&gt; 
<div class="message-stanza open">&gt; &gt; --
&gt; &gt; kmx
</div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;15:00:17&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 22 Jan 2012 21:00:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The disadvantage of your approach is that it will not handle a situation 
when you wanna use Net::SSLeay together with some other Net::SSLeay 
based perl module like IO::Socket::SSL which is very likely to call 
Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41; at some point and therefore 
will make troubles in threaded app.

I would prefer to make SSLeay_add_ssl_algorithms&#40;&#41; thread-safe on its 
own without an extra wrapper function &#40;like in my patch - 
net-ssleay-thead-safety-proposal1.diff  - suggested a couple of post 
above&#41; - by this we can make &#34;to-some-extent-thread-safe&#34; also other 
modules based on Net::SSLeay - without the need to switch to the newly 
created initialize&#40;&#41; function.

--
kmx
</div></div>

<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;18:03:19&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 23 Jan 2012 09:03:01 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

On Sunday, January 22, 2012 03:00:18 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; The disadvantage of your approach is that it will not handle a situation
&gt; when you wanna use Net::SSLeay together with some other Net::SSLeay
&gt; based perl module like IO::Socket::SSL which is very likely to call
&gt; Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41; at some point and therefore
&gt; will make troubles in threaded app.
</div>
I dont think thats right.
IO::Socket::SSL 1.53 and earlier versions calls the Net::SSLeay initialization 
once in a BEGIN block, and not repeatedly, so the non-reentrancy of 
SSLeay_add_ssl_algorithms would not affect it.

Provides code that uses both libraries in a threaded environment calls 
Net::SSLeay::initialize&#40;&#41; before threading starts, I would not expect to see a 
problem. And in a non-threaded environment, even without calling 
Net::SSLeay::initialize&#40;&#41; explicitly, I would expect it to work.

Please correct me if I am wrong.

AFAICT, the low level Net::SSLeay API is already thread safe.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I would prefer to make SSLeay_add_ssl_algorithms&#40;&#41; thread-safe on its
&gt; own without an extra wrapper function &#40;like in my patch -
&gt; net-ssleay-thead-safety-proposal1.diff  - suggested a couple of post
&gt; above&#41; - by this we can make &#34;to-some-extent-thread-safe&#34; also other
&gt; modules based on Net::SSLeay - without the need to switch to the newly
&gt; created initialize&#40;&#41; function.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;24&nbsp;10:41:08&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 24 Jan 2012 16:40:54 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; The disadvantage of your approach is that it will not handle a situation
&gt;&gt; when you wanna use Net::SSLeay together with some other Net::SSLeay
&gt;&gt; based perl module like IO::Socket::SSL which is very likely to call
&gt;&gt; Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41; at some point and therefore
&gt;&gt; will make troubles in threaded app.
&gt;&gt;      
</div>&gt; I dont think thats right.
&gt; IO::Socket::SSL 1.53 and earlier versions calls the Net::SSLeay initialization
&gt; once in a BEGIN block, and not repeatedly, so the non-reentrancy of
&gt; SSLeay_add_ssl_algorithms would not affect it.
&gt;
&gt; Provides code that uses both libraries in a threaded environment calls
&gt; Net::SSLeay::initialize&#40;&#41; before threading starts, I would not expect to see a
&gt; problem. And in a non-threaded environment, even without calling
&gt; Net::SSLeay::initialize&#40;&#41; explicitly, I would expect it to work.
&gt;
&gt; Please correct me if I am wrong.
&gt;    
</div>
Yes, it seems that you are right as for the IO::Socket::SSL, but keep in 
mind that there are many others using Net::SSLeay, for example 
<span class="clickylink"><a target="new" rel="nofollow" href="http://grep.cpan.me/?q=Net%3A%3ASSLeay%3A%3ASSLeay_add_ssl_algorithms">http://grep.cpan.me/?q=Net%3A%3ASSLeay%3A%3ASSLeay_add_ssl_algorithms</a></span>

Let us have a scenario:

[myapp.pl]
use IO::Socket::SSL;  #based on Net::SSLeay
use Something::Else::SSL;   #also based on Net::SSLeay
...
[end]

if both IO::Socket::SSL and Something::Else::SSL do in their BEGIN block:
   Net::SSLeay::load_error_strings&#40;&#41;;
   Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
   Net::SSLeay::randomize&#40;&#41;;
or if there is Something::Else::SSL-&gt;get_https calling  
Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;

Then we have double call of Net::SSLeay::SSLeay_add_ssl_algorithms which 
should be avoided.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; AFAICT, the low level Net::SSLeay API is already thread safe.
&gt;    
</div>
1/ I am not sure about re-entrance of 
OPENSSL_add_all_algorithms_noconf&#40;&#41; used inside CTX_use_PKCS12_file&#40;&#41;

2/ We are still not following 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
&#34;OpenSSL can safely be used in multi-threaded applications provided that 
at least two callback functions are set, locking_function and 
threadid_func. &#34;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;24&nbsp;20:55:10&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Jan 2012 11:54:46 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tuesday, January 24, 2012 10:41:10 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; The disadvantage of your approach is that it will not handle a
&gt; &gt;&gt; situation
&gt; &gt;&gt; when you wanna use Net::SSLeay together with some other Net::SSLeay
&gt; &gt;&gt; based perl module like IO::Socket::SSL which is very likely to call
&gt; &gt;&gt; Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41; at some point and therefore
&gt; &gt;&gt; will make troubles in threaded app.
</div>&gt; &gt; 
&gt; &gt; I dont think thats right.
&gt; &gt; IO::Socket::SSL 1.53 and earlier versions calls the Net::SSLeay
&gt; &gt; initialization once in a BEGIN block, and not repeatedly, so the
&gt; &gt; non-reentrancy of SSLeay_add_ssl_algorithms would not affect it.
&gt; &gt; 
&gt; &gt; Provides code that uses both libraries in a threaded environment calls
&gt; &gt; Net::SSLeay::initialize&#40;&#41; before threading starts, I would not expect to
&gt; &gt; see a problem. And in a non-threaded environment, even without calling
&gt; &gt; Net::SSLeay::initialize&#40;&#41; explicitly, I would expect it to work.
&gt; &gt; 
&gt; &gt; Please correct me if I am wrong.
</div>&gt; 
&gt; Yes, it seems that you are right as for the IO::Socket::SSL, but keep in
&gt; mind that there are many others using Net::SSLeay, for example
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://grep.cpan.me/?q=Net%3A%3ASSLeay%3A%3ASSLeay_add_ssl_algorithms">http://grep.cpan.me/?q=Net%3A%3ASSLeay%3A%3ASSLeay_add_ssl_algorithms</a></span>
</div>
That is precisely why I am reluctant to make changes to the way it currently 
does its default initialisation: for fear of breaking other existing libraries 
and implementations. I have tried to be very conservative with the change I 
have made, with the expectation that currently working applications will not 
be affected, and that only currently non-working or buggy apps will have to 
change.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Let us have a scenario:
&gt; 
&gt; [myapp.pl]
&gt; use IO::Socket::SSL;  #based on Net::SSLeay
&gt; use Something::Else::SSL;   #also based on Net::SSLeay
&gt; ...
&gt; [end]
&gt; 
&gt; if both IO::Socket::SSL and Something::Else::SSL do in their BEGIN block:
&gt;    Net::SSLeay::load_error_strings&#40;&#41;;
&gt;    Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;;
&gt;    Net::SSLeay::randomize&#40;&#41;;
&gt; or if there is Something::Else::SSL-&gt;get_https calling
&gt; Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;
&gt; 
&gt; Then we have double call of Net::SSLeay::SSLeay_add_ssl_algorithms which
&gt; should be avoided.
</div>
Perhaps, but if IO::Socket::SSL or some other library initialises openssl 
while Net::SSLeay is not looking, there not much to be done. Net::SSLeay is 
unable to tell if some other library has already &#40;or will sometime later&#41; 
initialise the openssl library.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; AFAICT, the low level Net::SSLeay API is already thread safe.
</div>&gt; 
&gt; 1/ I am not sure about re-entrance of
&gt; OPENSSL_add_all_algorithms_noconf&#40;&#41; used inside CTX_use_PKCS12_file&#40;&#41;
&gt; 
&gt; 2/ We are still not following
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
&gt; &#34;OpenSSL can safely be used in multi-threaded applications provided that
&gt; at least two callback functions are set, locking_function and
&gt; threadid_func. &#34;
</div>
AFAICS, there is no locking used by the relevant functions within 
SSLeay_add_ssl_algorithms so adding this type of locking support would have no 
impact on the problem originally reported, which would still have to be solved 
&#40;and , AFAICS, has been solved at least for Net::SSLeay using the preferred 
method previously discussed&#41;

Crypt::SSLeay, like Net::SSLeay does not set up any locking function either.

Im thinking that it is not necessary to provide these lock functions when 
openssl is embedded in perl, because perl&#39;s so-called threading is cooperative 
rather than preemptive, and therefore threads can only switch when perl is in 
control &#40;and not inside the ssl functions, where locking is used&#41;.






<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;25&nbsp;16:36:29&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 25 Jan 2012 22:36:16 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps, but if IO::Socket::SSL or some other library initialises openssl
&gt; while Net::SSLeay is not looking, there not much to be done. Net::SSLeay is
&gt; unable to tell if some other library has already &#40;or will sometime later&#41;
&gt; initialise the openssl library.
&gt;    
</div>
I think Net::SSLeay is able to allow exactly one call of 
SSL_library_init per process &#40;even multithreaded&#41; if we do &#40;in 
SSLeay.xs&#41; something like this:

int
SSL_library_init&#40;&#41;
     ALIAS:
         SSLeay_add_ssl_algorithms = 1
         OpenSSL_add_ssl_algorithms = 2
         add_ssl_algorithms = 3
     CODE:
         dMY_CXT;
#ifdef USE_ITHREADS
         MUTEX_LOCK&#40;&#38;MY_CXT.init_mutex&#41;;
#endif
         if &#40;!MY_CXT.initialized&#41; {
             SSL_library_init&#40;&#41;;
             MY_CXT.initialized = 1;
         }
#ifdef USE_ITHREADS
         MUTEX_UNLOCK&#40;&#38;MY_CXT.init_mutex&#41;;
#endif


Then we will handle 100% of situations when any other Net::SSLeay based 
modules repeatedly call Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt; AFAICT, the low level Net::SSLeay API is already thread safe.
&gt;&gt;&gt;        
</div>&gt;&gt; 1/ I am not sure about re-entrance of
&gt;&gt; OPENSSL_add_all_algorithms_noconf&#40;&#41; used inside CTX_use_PKCS12_file&#40;&#41;
&gt;&gt;
&gt;&gt; 2/ We are still not following
&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
&gt;&gt; &#34;OpenSSL can safely be used in multi-threaded applications provided that
&gt;&gt; at least two callback functions are set, locking_function and
&gt;&gt; threadid_func. &#34;
&gt;&gt;      
</div>&gt; AFAICS, there is no locking used by the relevant functions within
&gt; SSLeay_add_ssl_algorithms so adding this type of locking support would have no
&gt; impact on the problem originally reported, which would still have to be solved
&gt; &#40;and , AFAICS, has been solved at least for Net::SSLeay using the preferred
&gt; method previously discussed&#41;
&gt;
&gt; Crypt::SSLeay, like Net::SSLeay does not set up any locking function either.
&gt;    
</div>
Yes but there is at least a discussion to this topic in Crypt::SSLeay&#39;s 
RT <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=41007">https://rt.cpan.org/Public/Bug/Display.html?id=41007</a></span>

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Im thinking that it is not necessary to provide these lock functions when
&gt; openssl is embedded in perl, because perl&#39;s so-called threading is cooperative
&gt; rather than preemptive, and therefore threads can only switch when perl is in
&gt; control &#40;and not inside the ssl functions, where locking is used&#41;.
&gt;    
</div>
Maybe, I am not an expert on threads-related perl guts. I am slightly in 
doubts whether your assumptions are also valid for multi core CPUs.

To be honest I am not able to demonstrate a crash due to missing 
locking_function. I am just saying that we are not following openssl&#39;s 
thread-safety best practice. I agree to leave 
&#34;missing-locking_function-issue&#34; until somebody is able to create a 
proof of concept crash test.

However, another source of thread-unsafety troubles might be static 
variables in SSLeay.xs used for various callbacks. See chapter 
recommended best practice &#40;which we do not follow&#41; at 
<span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlxs.html#Safely-Storing-Static-Data-in-XS">http://perldoc.perl.org/perlxs.html#Safely-Storing-Static-Data-in-XS</a></span>

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jan&nbsp;25&nbsp;17:40:07&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 Jan 2012 08:39:46 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Wednesday, January 25, 2012 04:36:30 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Perhaps, but if IO::Socket::SSL or some other library initialises
&gt; &gt; openssl
&gt; &gt; while Net::SSLeay is not looking, there not much to be done. Net::SSLeay
&gt; &gt; is unable to tell if some other library has already &#40;or will sometime
&gt; &gt; later&#41; initialise the openssl library.
</div>&gt; 
&gt; I think Net::SSLeay is able to allow exactly one call of
&gt; SSL_library_init per process &#40;even multithreaded&#41; if we do &#40;in
&gt; SSLeay.xs&#41; something like this:
</div>
interesting idea. Have you tested it? Can you send a unified diff?


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; int
&gt; SSL_library_init&#40;&#41;
&gt;      ALIAS:
&gt;          SSLeay_add_ssl_algorithms = 1
&gt;          OpenSSL_add_ssl_algorithms = 2
&gt;          add_ssl_algorithms = 3
&gt;      CODE:
&gt;          dMY_CXT;
&gt; #ifdef USE_ITHREADS
&gt;          MUTEX_LOCK&#40;&#38;MY_CXT.init_mutex&#41;;
&gt; #endif
&gt;          if &#40;!MY_CXT.initialized&#41; {
&gt;              SSL_library_init&#40;&#41;;
&gt;              MY_CXT.initialized = 1;
&gt;          }
&gt; #ifdef USE_ITHREADS
&gt;          MUTEX_UNLOCK&#40;&#38;MY_CXT.init_mutex&#41;;
&gt; #endif
&gt; 
&gt; 
&gt; Then we will handle 100% of situations when any other Net::SSLeay based
&gt; modules repeatedly call Net::SSLeay::SSLeay_add_ssl_algorithms&#40;&#41;
&gt; 
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt;&gt; AFAICT, the low level Net::SSLeay API is already thread safe.
</div>&gt; &gt;&gt; 
&gt; &gt;&gt; 1/ I am not sure about re-entrance of
&gt; &gt;&gt; OPENSSL_add_all_algorithms_noconf&#40;&#41; used inside CTX_use_PKCS12_file&#40;&#41;
&gt; &gt;&gt; 
&gt; &gt;&gt; 2/ We are still not following
&gt; &gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
&gt; &gt;&gt; &#34;OpenSSL can safely be used in multi-threaded applications provided
&gt; &gt;&gt; that
&gt; &gt;&gt; at least two callback functions are set, locking_function and
&gt; &gt;&gt; threadid_func. &#34;
</div>&gt; &gt; 
&gt; &gt; AFAICS, there is no locking used by the relevant functions within
&gt; &gt; SSLeay_add_ssl_algorithms so adding this type of locking support would
&gt; &gt; have no impact on the problem originally reported, which would still
&gt; &gt; have to be solved &#40;and , AFAICS, has been solved at least for
&gt; &gt; Net::SSLeay using the preferred method previously discussed&#41;
&gt; &gt; 
&gt; &gt; Crypt::SSLeay, like Net::SSLeay does not set up any locking function
&gt; &gt; either.
</div>&gt; Yes but there is at least a discussion to this topic in Crypt::SSLeay&#39;s
&gt; RT <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=41007">https://rt.cpan.org/Public/Bug/Display.html?id=41007</a></span>
&gt; 
<div class="message-stanza open">&gt; &gt; Im thinking that it is not necessary to provide these lock functions
&gt; &gt; when
&gt; &gt; openssl is embedded in perl, because perl&#39;s so-called threading is
&gt; &gt; cooperative rather than preemptive, and therefore threads can only
&gt; &gt; switch when perl is in control &#40;and not inside the ssl functions, where
&gt; &gt; locking is used&#41;.
</div>&gt; Maybe, I am not an expert on threads-related perl guts. I am slightly in
&gt; doubts whether your assumptions are also valid for multi core CPUs.
&gt; 
&gt; To be honest I am not able to demonstrate a crash due to missing
&gt; locking_function. I am just saying that we are not following openssl&#39;s
&gt; thread-safety best practice. I agree to leave
&gt; &#34;missing-locking_function-issue&#34; until somebody is able to create a
&gt; proof of concept crash test.
&gt; 
&gt; However, another source of thread-unsafety troubles might be static
&gt; variables in SSLeay.xs used for various callbacks. See chapter
&gt; recommended best practice &#40;which we do not follow&#41; at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://perldoc.perl.org/perlxs.html#Safely-Storing-Static-Data-in-XS">http://perldoc.perl.org/perlxs.html#Safely-Storing-Static-Data-in-XS</a></span>
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;02:25:53&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 Jan 2012 08:25:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; interesting idea. Have you tested it? Can you send a unified diff?
&gt;    
</div>
See attached net-ssleay-thead-safety-proposal2.diff

I have tested it but only on perl 5.14-with-ithreads &#40;but it should work 
also on older perls and perl without ithreads&#41;.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;14:14:57&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 26 Jan 2012 20:14:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sorry, my previous patch was not working as I have expected, please 
check enclosed net-ssleay-thead-safety-proposal3.diff

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;26&nbsp;17:39:06&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 08:38:44 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

Thanks for t hat.
I have tested your mutex patch on several platforms here including windows, 
and also against the net-ssleay-thread-crash suite, with and without calling 
Net::SSLeay::initialize in main. Works with all my tests so far, so I have 
committed your patch to SVN.

Please test in as many environments as you can and let me know how you go.

Cheers.


On Thursday, January 26, 2012 02:14:59 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Sorry, my previous patch was not working as I have expected, please
&gt; check enclosed net-ssleay-thead-safety-proposal3.diff
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;08:13:46&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 14:13:35 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please test in as many environments as you can and let me know how you go.
&gt;    
</div>
Will do.

Meantime please consider attached documentation patch.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;08:38:06&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 14:37:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bad news: another multi-threading related crash test - this one is 
related to callbacks.

Check enclosed net-ssleay-callback-crash.tar.gz

Crashes nearly immediately &#40;tested with current svn trunk version&#41;.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;09:22:54&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 15:22:42 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good news: I have the first proposal for fixing crashing callbacks in 
multi-threaded Net::SSLeay application.

Check callback-threading-patch1.diff

It seems to work, I am only not sure whether CLONE&#40;&#41; implementation does 
what we really need &#40;to be honest it my first CLONE&#40;&#41; routine 
implemented in XS - feel free to correct me&#41;.

It definitely deserves more testing.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;10:00:14&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 16:00:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The last multi-threading related test suite for this week regards CTX_new&#40;&#41;

In net-ssleay-ctx_new-timing.tar.gz you will find 2 nearly the same 
scripts ctx-test1.pl ctx-test2.pl

On my Windows &#40;32bit/perl 5.14.2&#41; box:
- ctx-test1.pl runs approx 3 seconds
- ctx-test2.pl runs couple of minutes
&#40;I have not tested on other platforms&#41;

Both scripts start 50 threads doing SSLeay::CTX_new&#40;&#41; + 
Net::SSLeay::CTX_free&#40;&#41; the only difference is that ctx-test1.pl calls 
also once SSLeay::CTX_new&#40;&#41; in the main thread before threading actually 
starts.

The workaround is &#34;call at least once SSLeay::CTX_new&#40;&#41; in the main 
thread before creating any child thread&#34; &#40;which is fine for me&#41; - but it 
is strange.

Any idea?

--
kmx
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;13:50:50&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 27 Jan 2012 19:50:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 27.1.2012 16:00, kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span>&gt;
&gt;
&gt; The last multi-threading related test suite for this week regards CTX_new&#40;&#41;
&gt;
&gt; In net-ssleay-ctx_new-timing.tar.gz you will find 2 nearly the same
&gt; scripts ctx-test1.pl ctx-test2.pl
&gt;
&gt; On my Windows &#40;32bit/perl 5.14.2&#41; box:
&gt; - ctx-test1.pl runs approx 3 seconds
&gt; - ctx-test2.pl runs couple of minutes
&gt; &#40;I have not tested on other platforms&#41;
&gt;
&gt; Both scripts start 50 threads doing SSLeay::CTX_new&#40;&#41; +
&gt; Net::SSLeay::CTX_free&#40;&#41; the only difference is that ctx-test1.pl calls
&gt; also once SSLeay::CTX_new&#40;&#41; in the main thread before threading actually
&gt; starts.
&gt;    
</div>
Further investigation revealed that cxt-test2.pl gets stuck inside 
openssl&#39;s function SSL_CTX *SSL_CTX_new&#40;const SSL_METHOD *method&#41; - 
perhaps a kind of a deadlock inside openssl library.

And by quick and dirty implementation &#40;I have to polish it a bit&#41; of 
locking described at:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
I was able to fix the deadlock in ctx-test2.pl

So this is IMHO a reason why we need to implement it

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;18:23:39&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 28 Jan 2012 09:23:20 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Friday, January 27, 2012 10:00:15 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; The last multi-threading related test suite for this week regards CTX_new&#40;&#41;
&gt; 
&gt; In net-ssleay-ctx_new-timing.tar.gz you will find 2 nearly the same
&gt; scripts ctx-test1.pl ctx-test2.pl
&gt; 
&gt; On my Windows &#40;32bit/perl 5.14.2&#41; box:
&gt; - ctx-test1.pl runs approx 3 seconds
&gt; - ctx-test2.pl runs couple of minutes
&gt; &#40;I have not tested on other platforms&#41;
</div>
Strange, Quick test here on Linux shows both run to completion in about 3 secs

What is it doing during those 2 minutes?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Both scripts start 50 threads doing SSLeay::CTX_new&#40;&#41; +
&gt; Net::SSLeay::CTX_free&#40;&#41; the only difference is that ctx-test1.pl calls
&gt; also once SSLeay::CTX_new&#40;&#41; in the main thread before threading actually
&gt; starts.
&gt; 
&gt; The workaround is &#34;call at least once SSLeay::CTX_new&#40;&#41; in the main
&gt; thread before creating any child thread&#34; &#40;which is fine for me&#41; - but it
&gt; is strange.
&gt; 
&gt; Any idea?
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;18:40:07&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 28 Jan 2012 09:39:49 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Friday, January 27, 2012 08:13:48 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Please test in as many environments as you can and let me know how you
&gt; &gt; go.
</div>&gt; Will do.
&gt; 
&gt; Meantime please consider attached documentation patch.
</div>
Adopted.
Thanks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;27&nbsp;20:18:43&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 28 Jan 2012 11:18:24 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

your patch works for me on a range of platforms and perl versions. Adopted and 
posted to svn.


On Friday, January 27, 2012 09:22:55 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Good news: I have the first proposal for fixing crashing callbacks in
&gt; multi-threaded Net::SSLeay application.
&gt; 
&gt; Check callback-threading-patch1.diff
&gt; 
&gt; It seems to work, I am only not sure whether CLONE&#40;&#41; implementation does
&gt; what we really need &#40;to be honest it my first CLONE&#40;&#41; routine
&gt; implemented in XS - feel free to correct me&#41;.
&gt; 
&gt; It definitely deserves more testing.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jan&nbsp;28&nbsp;05:58:27&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 28 Jan 2012 11:58:17 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Strange, Quick test here on Linux shows both run to completion in about 3 secs
&gt;
&gt; What is it doing during those 2 minutes?
&gt;    
</div>
50 threads running, consuming 50% of my dual-core CPU &#40;~ 1 core&#41;, the 
first threads finishes after approx.  50sec, the second after another 
approx. 20sec, ... &#40;it is not 2 minutes, I meant &#34;minutes&#34; like many 
minutest - in fact I have never wait for all 50 threads to finish as I 
expect it to run for at least half an hour&#41;

My guess is
- 1 thread looping in some kind of nearly-deadlock-situation &#40;occupiing 
1 core&#41;
- 49 threads waiting &#40;for something&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;29&nbsp;16:06:22&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 29 Jan 2012 22:06:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please check enclosed tarball with 2 tests:
- 61_threads-cb-crash.t &#40;passes with the latest SVN trunk version&#41;
- 62_threads-ctx_new-deadlock.t &#40;fails on my Win32 box - as it does not 
finish within 20s timeout&#41;

Consider adding these to Net-SSLeay distribution.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;04:33:28&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jan 2012 10:33:15 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have prepared a patch fixing CTX_new&#40;&#41; deadlock I have experienced on 
my MS Windows machine.
- I have tried to implement all locking parts required and described at 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
- I did my best to keep the implementation as portable as possible &#40;I am 
using perl_mutex structure which should be portable by its own&#41;
- I have used couple of &#34;#if OPENSSL_VERSION_NUMBER ...&#34; to assure that 
we are turning on openssl locking only on versions that support it
- However I have tested &#40;successfully&#41; the implementation only on MS 
Windows 32bit and 64bit

More testing needed
- especially on Linux &#40;and/or other UNIXes&#41; box + ithreads enabled + 
multicore CPU &#40;I have mostly access to 1core/cpu virtual machines&#41;
- it would be nice to test on a box with openssl-1.0.0+ and pre-1.0.0 
&#40;as some parts of implementation differs for 0.9.x / 1.x.x&#41;
- peer review of openssl_threadid_func&#40;&#41; implementation is welcome &#40;this 
is a point where I am not sure - marked by &#34;XXX-FIXME note by KMX&#34; in 
source code&#41;
- please note that openssl_threadid_func&#40;&#41; is not used at all on MS 
Windows thus I am really not sure whether it will work as expected

If you are against applying this kind of patch for all platforms I would 
like to ask you to make it available at least for Win32 &#40;by #ifdef 
WIN32&#41; as it is really necessary to avoid CTX_new&#40;&#41; deadlock described 
in my previous post.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;06:58:17&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; More testing needed
</div>here my test result for a Linux system:
debian squeeze amd64 4 cpu-cores
openssl 0.9.8o-4squeeze7
perl v5.10.1

perl t/local/61_threads-cb-crash.t 
1..1
Unbalanced string table refcount: &#40;1&#41; for &#34;32936256&#34; during global destruction.Unbalanced 
string table refcount: &#40;1&#41; for &#34;35428992&#34; during global destruction.Unbalanced string table 
refcount: &#40;1&#41; for &#34;39702592&#34; during global destruction.
Unbalanced string table refcount: &#40;1&#41; for &#34;33308880&#34; during global destruction.
Unbalanced string table refcount: &#40;1&#41; for &#34;35549232&#34; during global destruction.
Unbalanced string table refcount: &#40;1&#41; for &#34;32933408&#34; during global destruction.
Unbalanced string table refcount: &#40;1&#41; for &#34;33274160&#34; during global destruction.
Segmentation fault

t/local/62_threads-ctx_new-deadlock.t .. ok   


regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;07:32:04&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jan 2012 13:31:54 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">palik,

have you used the latest SVN trunk version &#40;rev287&#41; ?  It should already 
contain the fix for crashing 61_threads-cb-crash.t

If you have used the latest version we probably have another 
multithreaded issue to fix.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;08:05:50&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; have you used the latest SVN trunk version &#40;rev287&#41; ? 
</div>No, I used from CPAN downloaded tarball, because I couldn&#39;t found SVN URL :-&#40; 

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;08:31:05&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jan 2012 14:30:51 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No, I used from CPAN downloaded tarball, because I couldn&#39;t found SVN URL :-&#40;
&gt;    
</div>
svn://svn.debian.org/net-ssleay/trunk
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;08:53:38&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 30 08:31:05 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; No, I used from CPAN downloaded tarball, because I couldn&#39;t found
</div>&gt; SVN URL :-&#40;
<div class="message-stanza open">&gt; &gt;
</div>&gt; 
&gt; svn://svn.debian.org/net-ssleay/trunk
</div>Hm, can&#39;t connect. I&#39;ll try again in the evening at home.

host svn.debian.org
svn.debian.org has address 217.196.43.140
svn co svn://svn.debian.org/net-ssleay/trunk net-ssleay-trunk
svn: Can&#39;t connect to host &#39;svn.debian.org&#39;: Operation timed out

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;13:14:48&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jan 30 08:31:05 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; No, I used from CPAN downloaded tarball, because I couldn&#39;t found
</div>&gt; SVN URL :-&#40;
<div class="message-stanza open">&gt; &gt;
</div>&gt; 
&gt; svn://svn.debian.org/net-ssleay/trunk
&gt; 
</div>
still can&#39;t connect:
svn: Can&#39;t connect to host &#39;svn.debian.org&#39;: Network is unreachable

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;14:01:17&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jan 2012 20:01:07 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; still can&#39;t connect:
&gt; svn: Can&#39;t connect to host &#39;svn.debian.org&#39;: Network is unreachable
&gt;    
</div>
The same here :&#40;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;14:06:49&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 30 Jan 2012 20:06:40 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; If you are against applying this kind of patch for all platforms I would
&gt; like to ask you to make it available at least for Win32 &#40;by #ifdef
&gt; WIN32&#41; as it is really necessary to avoid CTX_new&#40;&#41; deadlock described
&gt; in my previous post.
&gt;    
</div>
Or another fallback solution you might like more could be introducing a 
new function
Net::SSLeay::init_openssl_tread_safe_locking&#40;&#41;
which will enable the locking-kung-fu I have sent a couple of posts before.

It will probably need one more global mutex to avoid multiple 
initialization but it is something I know how to handle.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;16:27:26&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 07:27:11 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

On Sunday, January 29, 2012 04:06:24 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Please check enclosed tarball with 2 tests:
&gt; - 61_threads-cb-crash.t &#40;passes with the latest SVN trunk version&#41;
&gt; - 62_threads-ctx_new-deadlock.t &#40;fails on my Win32 box - as it does not
&gt; finish within 20s timeout&#41;
&gt; 
&gt; Consider adding these to Net-SSLeay distribution.
</div>
 I would like to do that except your tests do not compile on perl 5.8 and 
others because threads::running is not available as an argument to list&#40;&#41;

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;16:32:13&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 07:31:59 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

I see similar problems ONLY if I run the tests against the non-fixed net-
ssleay

On Monday, January 30, 2012 06:58:18 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
<div class="message-stanza open">&gt; &gt; More testing needed
</div>&gt; 
&gt; here my test result for a Linux system:
&gt; debian squeeze amd64 4 cpu-cores
&gt; openssl 0.9.8o-4squeeze7
&gt; perl v5.10.1
&gt; 
&gt; perl t/local/61_threads-cb-crash.t
</div>
Are you sure you are using the newly compiled net-ssleay? Maybe you need:

perl -w -I blib/lib -I blib/arch t/local/61_threads-cb-crash.

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1..1
&gt; Unbalanced string table refcount: &#40;1&#41; for &#34;32936256&#34; during global
&gt; destruction.Unbalanced string table refcount: &#40;1&#41; for &#34;35428992&#34; during
&gt; global destruction.Unbalanced string table refcount: &#40;1&#41; for &#34;39702592&#34;
&gt; during global destruction.
&gt; Unbalanced string table refcount: &#40;1&#41; for &#34;33308880&#34; during global
&gt; destruction. Unbalanced string table refcount: &#40;1&#41; for &#34;35549232&#34; during
&gt; global destruction. Unbalanced string table refcount: &#40;1&#41; for &#34;32933408&#34;
&gt; during global destruction. Unbalanced string table refcount: &#40;1&#41; for
&gt; &#34;33274160&#34; during global destruction. Segmentation fault
&gt; 
&gt; t/local/62_threads-ctx_new-deadlock.t .. ok
&gt; 
&gt; 
&gt; regards,
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;16:49:31&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

after checkout svn code &#40;Revision: 287&#41; both new tests are ok.
t/local/61_threads-cb-crash.t .......... ok   
t/local/62_threads-ctx_new-deadlock.t .. ok

But I couldn&#39;t apply your patch to SSLeay.xs

patch --dry-run SSLeay.xs ../net-ssleay/net-ssleay-thead-safety-proposal1.diff 
patching file SSLeay.xs
Hunk #1 succeeded at 92 with fuzz 2 &#40;offset 18 lines&#41;.
Hunk #2 succeeded at 715 with fuzz 2 &#40;offset 54 lines&#41;.
Hunk #3 FAILED at 1366.


think to add requires&#40;&#39;Module::Install&#39;&#41; into Makefile.PL

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;30&nbsp;19:19:43&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 10:19:26 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi.

A mixed bag of results here using your threads patch and the cb-crash.pl  you 
earlier posted &#40;but using a different certificate that 0.9.8i could 
understand&#41;:

Linux perl 5.14, openssl 1.0.0. Perfect. &#40;but, I must say, it ran perfectly 
even before your locking patch&#41;

Windows perl 5.12, openssl 0.9.8i, mostly OK, but occasional error:
Thread 925 terminated abnormally: CTX_use_PrivateKey_file failed at 
cb_crash.pl line 50

Windows perl 5.10, openssl 0.9.8i, mostly OK, but occasional error:
Attempt to free non-existent shared string &#39;KILL&#39;, Perl interpreter: 0xd24268c 
during global destruction.


Windows perl 5.8.8, openssl 0.9.8i, ran fine until thread 0602, when it 
started to block and hang. &#39;Popup Application Error&#39; messages with errors 
showing perl trying to write to 0x00000000.

Windows perl 5.6, openssl 0.9.8i, Could not test because threads.pm not 
available

So at this stage if have backed you patch out from my working copy and will 
not commit it yet.

Cheers.




On Monday, January 30, 2012 04:33:29 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; I have prepared a patch fixing CTX_new&#40;&#41; deadlock I have experienced on
&gt; my MS Windows machine.
&gt; - I have tried to implement all locking parts required and described at
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.openssl.org/docs/crypto/threads.html">http://www.openssl.org/docs/crypto/threads.html</a></span>
&gt; - I did my best to keep the implementation as portable as possible &#40;I am
&gt; using perl_mutex structure which should be portable by its own&#41;
&gt; - I have used couple of &#34;#if OPENSSL_VERSION_NUMBER ...&#34; to assure that
&gt; we are turning on openssl locking only on versions that support it
&gt; - However I have tested &#40;successfully&#41; the implementation only on MS
&gt; Windows 32bit and 64bit
&gt; 
&gt; More testing needed
&gt; - especially on Linux &#40;and/or other UNIXes&#41; box + ithreads enabled +
&gt; multicore CPU &#40;I have mostly access to 1core/cpu virtual machines&#41;
&gt; - it would be nice to test on a box with openssl-1.0.0+ and pre-1.0.0
&gt; &#40;as some parts of implementation differs for 0.9.x / 1.x.x&#41;
&gt; - peer review of openssl_threadid_func&#40;&#41; implementation is welcome &#40;this
&gt; is a point where I am not sure - marked by &#34;XXX-FIXME note by KMX&#34; in
&gt; source code&#41;
&gt; - please note that openssl_threadid_func&#40;&#41; is not used at all on MS
&gt; Windows thus I am really not sure whether it will work as expected
&gt; 
&gt; If you are against applying this kind of patch for all platforms I would
&gt; like to ask you to make it available at least for Win32 &#40;by #ifdef
&gt; WIN32&#41; as it is really necessary to avoid CTX_new&#40;&#41; deadlock described
&gt; in my previous post.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;02:59:10&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 08:58:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; But I couldn&#39;t apply your patch to SSLeay.xs
&gt;    
</div>
Try enclosed patch fix-for-ctx_new-deadlock-v2_rev288.diff which should 
work with current trunk &#40;revision 288&#41;.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;03:09:49&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Try enclosed patch fix-for-ctx_new-deadlock-v2_rev288.diff which should 
&gt; work with current trunk &#40;revision 288&#41;.
</div>It&#39;s ok now.
t/local/61_threads-cb-crash.t .......... ok   
t/local/62_threads-ctx_new-deadlock.t .. ok

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;03:21:34&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 09:21:23 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Windows perl 5.12, openssl 0.9.8i, mostly OK, but occasional error ...
&gt; Windows perl 5.10, openssl 0.9.8i, mostly OK, but occasional error ...
&gt; Windows perl 5.8.8, openssl 0.9.8i, ran fine until thread 0602 ...
&gt;    
</div>
Well, not good; however [irony]still better then unpatched v1.42[/irony]

Could you please check whether it makes a difference to run crash-test 
1/ with current trunk vs. 2/ trunk+fix-for-ctx_new-deadlock-v2_rev288.diff ?

In other words does the newly proposed openssl-locking-kung-fu make it 
worse ?

My environment is:
- perl 5.14.2
- OpenSSL 1.0.0d
- threads-1.86
- gcc compiler 4.4.7-pre + c-runtime from mingw-w64.sf.net project
- all of that for 32bit as well as 64bit MS Windows
- on both 32/64bit cb-crash.pl repeatedly runs without any crash

I will try to prepare a crashy environment - but it will take some time 
&#40;unfortunately gcc+mingw runtime from mingw-w64.sf.net I am using does 
not build 5.10.x and earlier without patching perl source code so I 
should perhaps take some MS compiler + rebuild some of the older perl as 
well as some of the older openssl lib&#41;.

Or maybe could you give more info about your perl 5.8.8 &#40;if you consider 
this to be the oldest supported perl by Net::SSLeay&#41; - compiler version, 
threads version, vendor &#40;activestate or homebrewed?&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;10:55:55&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 16:55:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">mike and palik,

could you please try to run the new attached callback-crash-suite on 
your perl boxes?

it contains 8 scripts:
- cb-crash-ng0-nossleay.pl
- cb-crash-ng1.pl
- cb-crash-ng2.pl
- cb-crash-ng2-nopasswd.pl
- cb-crash-ng3.pl
- cb-crash-ng3-nopasswd.pl
- cb-crash-ng4.pl
- cb-crash-ng4-nopassw.pl

it would be nice to have for all 8 scripts:
1/ results for current trunk &#40;rev288&#41;
2/ results for trunk+fix-for-ctx_new-deadlock-v2_rev288.diff

On my MSWin 32bit just cb-crash-ng4.pl &#40;cross-thread callback&#41; crashes 
all the other run and finish fine.

Thanks in advance for your time.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;12:43:03&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; it would be nice to have for all 8 scripts:
&gt; 1/ results for current trunk &#40;rev288&#41;
&gt; 2/ results for trunk+fix-for-ctx_new-deadlock-v2_rev288.diff
</div>
execution outputs are in attachment.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; On my MSWin 32bit just cb-crash-ng4.pl &#40;cross-thread callback&#41; crashes 
&gt; all the other run and finish fine.
&gt; 
</div>
in my case cb-crash-ng2.pl and cb-crash-ng4.pl died at CTX_use_PrivateKey_file call line 17

palik
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-ssleay-callback-crash2-result.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;14:33:11&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 31 Jan 2012 20:32:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">thanks, it is still:

debian squeeze amd64 4 cpu-cores
openssl 0.9.8o-4squeeze7
perl v5.10.1

right?

conclusion from your testing:
1/ my encrypted test key pk_1024.key.pem probably does not work with 
your openssl
2/ the new openssl-locking-kung-fu patch does not make things worse on Linux

ad 1/ could you please check the encrypted private key &#40;password is &#34;123&#34;&#41;
[testbox]$ openssl rsa -in pk_1024.key.pem -text

perhaps try to change password to something longer then 3 chars by:
[testbox]$ openssl rsa -in pk_1024.key.pem -out pk_1024-new.key.pem -des
&#40;+ patch cb-crash-ng2.pl cb-crash-ng3.pl cb-crash-ng4.pl - 
pk_1024-new.key.pem + new password&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;20:39:06&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 11:38:51 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


On Tuesday, January 31, 2012 03:21:35 AM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Windows perl 5.12, openssl 0.9.8i, mostly OK, but occasional error ...
&gt; &gt; Windows perl 5.10, openssl 0.9.8i, mostly OK, but occasional error ...
&gt; &gt; Windows perl 5.8.8, openssl 0.9.8i, ran fine until thread 0602 ...
</div>&gt; 
&gt; Well, not good; however [irony]still better then unpatched v1.42[/irony]
&gt; 
&gt; Could you please check whether it makes a difference to run crash-test
&gt; 1/ with current trunk vs. 2/ trunk+fix-for-ctx_new-deadlock-v2_rev288.diff ?
</div>

------------------With current trunk 288 &#40;btw, did you notice that, contrary 
to my earlier statement, 288 has your earlier thread locking code&#41;

Linux perl 5.14, openssl 1.0.0. gcc 4.6.2 on OpenSuSE 12.1 8 core
Perfect. Ran to completion.

Windows Server 2003 32 bit activeperl 5.12, openssl 0.9.8i, MS Visual C 6, MS 
C compiler version 12
one error:
Thread 45 terminated abnormally: CTX_use_PrivateKey_file failed at 
cb_crash.pl line 50
and then ran to completion.

Windows Server 2003 32 bit activeperl 5.10, openssl 0.9.8i,  MS Visual C 6, MS 
C compiler version 12
one error:
Unbalanced string table refcount: &#40;1&#41; for &#34;Net&#34; during global destruction
then much later
crash after thread 0816
attempt to write to 0x00000000

Windows Server 2003 32 bit activeperl 5.8.8, openssl 0.9.8i,  MS Visual C 6, 
MS C compiler version 12
Had to modify cb_crash test not to use threads::running
Crashed after thread 274
occasional error:
Thread 925 terminated abnormally: CTX_use_PrivateKey_file failed at 
cb_crash.pl line 50
and then hung later after:
[thread:9996] do_check finished &#40;prob because of ::running change above&#41;

Windows Server 2003 32 bit activeperl 5.6, openssl 0.9.8i,  MS Visual C 6, MS 
C compiler version 12
Could not test because threads.pm not 
available

-------------------With your fix-for-ctx_new-deadlock-v2_rev288.diff applied 
to trunk 288:

Linux perl 5.14, openssl 1.0.0. gcc 4.6.2 on OpenSuSE 12.1 8 core
Perfect. Ran to completion

Windows Server 2003 32 bit activeperl 5.12, openssl 0.9.8i, MS Visual C 6, MS 
C compiler version 12
error:
Thread 833 terminated abnormally: CTX_use_PrivateKey_file failed at 
cb_crash.pl line 50
then ran to completion

Windows Server 2003 32 bit activeperl 5.10, openssl 0.9.8i,  MS Visual C 6, MS 
C compiler version 12
2 error messages:
Attempt to free unreferenced glob pointers
unbalanced string table refcount: &#40;1&#41; for &#34;c:/perl-5.10/lib/Exporter.pm&#34; 
during global destruction
Crashed later after thread 1488 with write to 0x000000

Windows Server 2003 32 bit activeperl 5.8.8, openssl 0.9.8i,  MS Visual C 6, 
MS C compiler version 12
Had to modify cb_crash test not to use threads::running
Crashed after thread 274

Windows Server 2003 32 bit activeperl 5.6, openssl 0.9.8i,  MS Visual C 6, MS 
C compiler version 12
Could not test because threads.pm not 
available


So, I think this patch has not materially improved things on these platforms.
I have not adopted it yet.

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; In other words does the newly proposed openssl-locking-kung-fu make it
&gt; worse ?
&gt; 
&gt; My environment is:
&gt; - perl 5.14.2
&gt; - OpenSSL 1.0.0d
&gt; - threads-1.86
&gt; - gcc compiler 4.4.7-pre + c-runtime from mingw-w64.sf.net project
&gt; - all of that for 32bit as well as 64bit MS Windows
&gt; - on both 32/64bit cb-crash.pl repeatedly runs without any crash
&gt; 
&gt; I will try to prepare a crashy environment - but it will take some time
&gt; &#40;unfortunately gcc+mingw runtime from mingw-w64.sf.net I am using does
&gt; not build 5.10.x and earlier without patching perl source code so I
&gt; should perhaps take some MS compiler + rebuild some of the older perl as
&gt; well as some of the older openssl lib&#41;.
&gt; 
&gt; Or maybe could you give more info about your perl 5.8.8 &#40;if you consider
&gt; this to be the oldest supported perl by Net::SSLeay&#41; - compiler version,
&gt; threads version, vendor &#40;activestate or homebrewed?&#41;
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;31&nbsp;21:21:47&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 12:21:31 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, 
I have a similar problem with cb-crash-ng2.pl and cb-crash-ng4.pl died at 
CTX_use_PrivateKey_file call line 17

Problem is unknown algorithms.

How did you generate the key files?
I wish to regenerate them here using algorithms that 0.9.8i understands.

Cheers.


On Tuesday, January 31, 2012 02:33:13 PM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; thanks, it is still:
&gt; 
&gt; debian squeeze amd64 4 cpu-cores
&gt; openssl 0.9.8o-4squeeze7
&gt; perl v5.10.1
&gt; 
&gt; right?
&gt; 
&gt; conclusion from your testing:
&gt; 1/ my encrypted test key pk_1024.key.pem probably does not work with
&gt; your openssl
&gt; 2/ the new openssl-locking-kung-fu patch does not make things worse on Linux
&gt; 
&gt; ad 1/ could you please check the encrypted private key &#40;password is &#34;123&#34;&#41;
&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -text
&gt; 
&gt; perhaps try to change password to something longer then 3 chars by:
&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -out pk_1024-new.key.pem -des
&gt; &#40;+ patch cb-crash-ng2.pl cb-crash-ng3.pl cb-crash-ng4.pl -
&gt; pk_1024-new.key.pem + new password&#41;
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;02:07:36&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; debian squeeze amd64 4 cpu-cores
&gt; openssl 0.9.8o-4squeeze7
&gt; perl v5.10.1
&gt; 
&gt; right?
</div>
yes

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ad 1/ could you please check the encrypted private key &#40;password is &#34;123&#34;&#41;
&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -text
</div>on squeeze:
openssl rsa -in pk_1024.key.pem -text
Enter pass phrase for pk_1024.key.pem:
32373:error:28069065:lib&#40;40&#41;:UI_set_result:result too small:ui_lib.c:850:You must type in 4 
to 8191 characters

on mac os 10.6.8 &#40;OpenSSL 1.0.0g 18 Jan 2012&#41;:

Enter pass phrase for pk_1024.key.pem:
140735079038236:error:28069065:lib&#40;40&#41;:UI_set_result:result too small:ui_lib.c:869:You 
must type in 4 to 1023 characters

on both OS &#34;Enter pass phrase for pk_1024.key.pem:&#34; came prompt repeatedly end endless.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; perhaps try to change password to something longer then 3 chars by:
&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -out pk_1024-new.key.pem -des
</div>
here I got same prompt bug.

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;02:28:11&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 08:27:58 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; ad 1/ could you please check the encrypted private key &#40;password is &#34;123&#34;&#41;
&gt;&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -text
&gt;&gt;      
</div>&gt; on squeeze:
&gt; openssl rsa -in pk_1024.key.pem -text
&gt; Enter pass phrase for pk_1024.key.pem:
&gt; 32373:error:28069065:lib&#40;40&#41;:UI_set_result:result too small:ui_lib.c:850:You must type in 4
&gt; to 8191 characters
&gt;
&gt; on mac os 10.6.8 &#40;OpenSSL 1.0.0g 18 Jan 2012&#41;:
&gt;
&gt; Enter pass phrase for pk_1024.key.pem:
&gt; 140735079038236:error:28069065:lib&#40;40&#41;:UI_set_result:result too small:ui_lib.c:869:You
&gt; must type in 4 to 1023 characters
&gt;    
</div>
Hmm, for some reason default_passwd_cb seems to follow some openssl.conf 
option saying that minimum password len is 4 and does not allow the 
callback function to return password &#34;123&#34;

I willl generate a new key with longer password + new tarball with 
cb-crash-test

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;02:33:19&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 08:33:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">FYI: I am trying to setup an old active perl - on 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/activeperl/downloads">http://www.activestate.com/activeperl/downloads</a></span>
&#34;Access to older versions &#40;such as Perl Perl 5.6, 5.8, or 5.10&#41; is 
available in Business Edition 
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/business-edition">http://www.activestate.com/business-edition</a></span>&gt; and Enterprise Edition 
&lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/enterprise-edition">http://www.activestate.com/enterprise-edition</a></span>&gt;.&#34;

Perhaps I&#39;ll find some in my archive.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;04:49:15&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 19:48:57 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I have in my archive:

ActivePerl-5.10.0.1002-MSWin32-x86-283697.msi
ActivePerl-5.10.0.1004-MSWin32-x86-287188.msi
ActivePerl-5.10.1.1007-MSWin32-x64-291969.msi
ActivePerl-5.10.1.1007-MSWin32-x86-291969.msi
ActivePerl-5.12.0.1200-MSWin32-x64-292396.msi
ActivePerl-5.12.0.1200-MSWin32-x86-292396.msi
ActivePerl-5.6.1.638-MSWin32-x86.msi
ActivePerl-5.8.4.810-MSWin32-x86.msi
ActivePerl-5.8.7.813-MSWin32-x86-148120.msi
ActivePerl-5.8.8.817-MSWin32-x86-257965.msi
ActivePerl-5.8.8.819-MSWin32-x86-267479.msi
ActivePerl-5.8.8.820-MSWin32-x86-274739.msi
ActivePerl-5.8.9.825-MSWin32-x86-288577.msi
ActivePerl-5.8.9.827-MSWin32-x64-291969.msi

all 15 to 20M each. Can email some if you want.

On Wednesday, February 01, 2012 02:33:19 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; FYI: I am trying to setup an old active perl - on
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/activeperl/downloads">http://www.activestate.com/activeperl/downloads</a></span>
&gt; &#34;Access to older versions &#40;such as Perl Perl 5.6, 5.8, or 5.10&#41; is
&gt; available in Business Edition
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/business-edition">http://www.activestate.com/business-edition</a></span>&gt; and Enterprise Edition
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.activestate.com/enterprise-edition">http://www.activestate.com/enterprise-edition</a></span>&gt;.&#34;
&gt; 
&gt; Perhaps I&#39;ll find some in my archive.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;04:54:54&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 01 02:28:11 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; ad 1/ could you please check the encrypted private key &#40;password is
</div></div>&gt; &#34;123&#34;&#41;
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt;&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -text
&gt; &gt;&gt;
</div>&gt; &gt; on squeeze:
&gt; &gt; openssl rsa -in pk_1024.key.pem -text
&gt; &gt; Enter pass phrase for pk_1024.key.pem:
&gt; &gt; 32373:error:28069065:lib&#40;40&#41;:UI_set_result:result too
</div>&gt; small:ui_lib.c:850:You must type in 4
<div class="message-stanza open">&gt; &gt; to 8191 characters
&gt; &gt;
&gt; &gt; on mac os 10.6.8 &#40;OpenSSL 1.0.0g 18 Jan 2012&#41;:
&gt; &gt;
&gt; &gt; Enter pass phrase for pk_1024.key.pem:
&gt; &gt; 140735079038236:error:28069065:lib&#40;40&#41;:UI_set_result:result too
</div>&gt; small:ui_lib.c:869:You
<div class="message-stanza open">&gt; &gt; must type in 4 to 1023 characters
&gt; &gt;
</div>&gt; 
&gt; Hmm, for some reason default_passwd_cb seems to follow some
&gt; openssl.conf
&gt; option saying that minimum password len is 4 and does not allow the
&gt; callback function to return password &#34;123&#34;
</div>I&#39;ve created pk_1024-new.key.pem by using pk_1024-nopasswd.key.pem
$ openssl rsa -in pk_1024-nopasswd.key.pem -out pk_1024-new.key.pem -des
password: 1234

Both cb-crash-ng&#40;2|4&#41;.pl died again by calling CTX_use_PrivateKey_file &#39;pk_1024-
new.key.pem&#39; failed


palik
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> pk_1024-new.key.pem</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;05:08:29&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de, kmx [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 11:08:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a similar problem with cb-crash-ng2.pl and cb-crash-ng4.pl died at
&gt; CTX_use_PrivateKey_file call line 17
&gt;
&gt; Problem is unknown algorithms.
&gt;
&gt; How did you generate the key files?
&gt;    
</div>
Via my home made function based on calling:
PEM_write_bio_PrivateKey&#40;bp,pk,EVP_des_ede3_cbc&#40;&#41;,passwd,passwd_len,cb,u&#41;;
which is not working well.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wish to regenerate them here using algorithms that 0.9.8i understands.
&gt;    
</div>
Sorry, I will change the keys.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;05:19:15&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 11:19:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

I have installed AFAIK the latest available ActivePerls from 
5.8/5.10/5.12/5.14 series &#40;I have used clean install&#41; + made a fresh 
built of openssl 0.9.8e and 1.0.0g. To make test complete I have also 
used StrawberryPerl 5.14.2.1/32bit.

I took updated the crash-test suite &#40;see attached 
net-ssleay-callback-crash3.tar.gz&#41; and run all tests with current svn 
trunk &#40;rev288&#41;.

The results are quite consistent:

ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-0.9.8e + 
vc6/cl 12.00.8804
- CRASH during cb-crash-ng4.pl ~ around thread:1248
- all the rest went fine

ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-1.0.0g + 
vc6/cl 12.00.8804
- CRASH during cb-crash-ng4.pl ~ around thread:6110
- all the rest went fine

ActivePerl-5.12.4.1205-MSWin32-x86 + threads-1.82 + openssl-0.9.8e + 
vc6/cl 12.00.8804
- CRASH during cb-crash-ng4.pl ~ around thread:0245
- all the rest went fine

ActivePerl-5.10.1.1007-MSWin32-x86 + threads-1.75 + openssl-0.9.8e + 
vc6/cl 12.00.8804
- CRASH during cb-crash-ng4.pl ~ around thread:0064
- all the rest went fine

ActivePerl-5.8.9.827-MSWin32-x86 + threads-1.75 + openssl-0.9.8e + 
vc6/cl 12.00.8804
- CRASH during cb-crash-ng4.pl ~ around thread:2037
- all the rest went fine

StrawberryPerl 5.14.2.1/32bit + threads-1.86 + openssl-1.0.0d + 
gcc-4.4.7-pre
- cb-crash-ng3.pl RUNS VEEEEEERY LONG &#40;this is CTX_new nearly-deadlock I 
have already reported&#41;
- cb-crash-ng3-nopasswd.pl RUNS VEEEEEERY LONG &#40;dtto&#41;
- CRASH during cb-crash-ng4.pl ~ around thread:1702
- all the rest went fine

Could you please run net-ssleay-callback-crash3.tar.gz on your UNIX-like 
boxes? &#40;current svn trunk version&#41;

My conclusion - we have basically 2 remaining troubles:
1/ cross-thread callbacks are terribly broken &#40;can be demonstrated by 
cb-crash-ng4.pl&#41;
2/ CTX_new nearly-deadlock - which seems to be an issue only on Win32/gcc :&#40;

ad 1/ Making cross-thread callbacks possible would require quite huge 
changes, but with some effort it could be feasible - do we want to 
support cross-thread callbacks? &#40;for me it is nearly-zero-priority&#41;

ad 2/ My openssl-locking-kung-fu patch fixes this issue but I understand 
that I was not able to bring a better crash case &#40;&#34;working&#34; on more then 
1 platform&#41; to convince you. On the other hand openssl documentation 
says that thread-safe use of openssl lib requires to utilize locking 
functions and as far as I understand openssl-locking-kung-fu patch does 
not seem to have an adverse effect on any platform we have tested. &#40;this 
is much higher priority for me&#41;

--
kmx
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;05:19:16&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 20:19:02 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

My experience was that I could not read  pk_1024.key.pem with 0.9.8, &#40;though 
1.0.0 was OK&#41;. Apprently due to teh encryption algorithm.

Instead for those tests I use a Radiator test certificate &#40;attached&#41; it has 
the password &#39;whatever&#39;

Cheers.

On Wednesday, February 01, 2012 04:54:54 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; On Wed Feb 01 02:28:11 2012, kmx@volny.cz wrote:
<div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;&gt; ad 1/ could you please check the encrypted private key &#40;password
&gt; &gt; &gt;&gt; is
</div></div>&gt; &gt; 
&gt; &gt; &#34;123&#34;&#41;
&gt; &gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt;&gt; [testbox]$ openssl rsa -in pk_1024.key.pem -text
</div>&gt; &gt; &gt; 
&gt; &gt; &gt; on squeeze:
&gt; &gt; &gt; openssl rsa -in pk_1024.key.pem -text
&gt; &gt; &gt; Enter pass phrase for pk_1024.key.pem:
&gt; &gt; &gt; 32373:error:28069065:lib&#40;40&#41;:UI_set_result:result too
</div>&gt; &gt; 
&gt; &gt; small:ui_lib.c:850:You must type in 4
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; to 8191 characters
&gt; &gt; &gt; 
&gt; &gt; &gt; on mac os 10.6.8 &#40;OpenSSL 1.0.0g 18 Jan 2012&#41;:
&gt; &gt; &gt; 
&gt; &gt; &gt; Enter pass phrase for pk_1024.key.pem:
&gt; &gt; &gt; 140735079038236:error:28069065:lib&#40;40&#41;:UI_set_result:result too
</div>&gt; &gt; 
&gt; &gt; small:ui_lib.c:869:You
&gt; &gt; 
<div class="message-stanza open">&gt; &gt; &gt; must type in 4 to 1023 characters
</div>&gt; &gt; 
&gt; &gt; Hmm, for some reason default_passwd_cb seems to follow some
&gt; &gt; openssl.conf
&gt; &gt; option saying that minimum password len is 4 and does not allow the
&gt; &gt; callback function to return password &#34;123&#34;
</div>&gt; 
&gt; I&#39;ve created pk_1024-new.key.pem by using pk_1024-nopasswd.key.pem
&gt; $ openssl rsa -in pk_1024-nopasswd.key.pem -out pk_1024-new.key.pem -des
&gt; password: 1234
&gt; 
&gt; Both cb-crash-ng&#40;2|4&#41;.pl died again by calling CTX_use_PrivateKey_file
&gt; &#39;pk_1024- new.key.pem&#39; failed
&gt; 
&gt; 
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;05:29:58&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 11:29:48 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; all 15 to 20M each. Can email some if you want.
&gt;    
</div>
5.6.1 please &#40;if I understand correctly, we want to support Net::SSleay 
on this version&#41;

Related question - what is the oldest openssl version we want to 
support? in other words how old openssl makes sense to test with 
Net::SSLeay?

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;05:34:12&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Instead for those tests I use a Radiator test certificate &#40;attached&#41;
&gt; it has
&gt; the password &#39;whatever&#39;
</div>
I got again errors:

perl cb-crash-ng2.pl --file cert-srv.pem 
Gonna start main thread part
[thread:0000] Inside callback
CTX_use_PrivateKey_file &#39;cert-srv.pem&#39; failed at cb-crash-ng2.pl line 18.
perl cb-crash-ng4.pl --file cert-srv.pem 
Gonna start main thread part
[thread:0000] Inside callback
CTX_use_PrivateKey_file &#39;cert-srv.pem&#39; failed at cb-crash-ng4.pl line 20.

openssl rsa -in cert-srv.pem -text | head
Enter pass phrase for cert-srv.pem:
writing RSA key
Private-Key: &#40;1024 bit&#41;
modulus:
    00:d5:7c:35:95:fc:37:aa:a4:08:88:77:06:e5:2c:
    b4:83:1c:51:f9:69:6f:36:fa:35:ae:83:7d:59:fc:
    50:85:ae:4d:6c:6c:c5:38:bd:46:c5:3e:12:34:aa:
    dd:4a:84:30:6a:a0:ee:49:d6:08:50:b4:63:6c:a7:
    ee:05:c4:aa:8e:fd:40:64:3b:6b:a3:a4:ea:92:10:
    03:18:d4:e4:f5:0e:84:9a:be:d4:3a:78:26:37:ab:
    d4:f7:15:6b:d7:7a:28:68:0a:fc:cf:47:eb:80:98:
    11:4c:65:89:82:27:c4:b6:d6:12:b4:52:22:16:53:


palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:00:43&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 20:57:32 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wednesday, February 01, 2012 05:34:13 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Instead for those tests I use a Radiator test certificate &#40;attached&#41;
&gt; &gt; it has
&gt; &gt; the password &#39;whatever&#39;
</div>&gt; 
&gt; I got again errors:
&gt; 
&gt; perl cb-crash-ng2.pl --file cert-srv.pem
</div>
Hmm, I dont think that syntax will work. I edited the file and made 2 changes:

my $file = &#34;$FindBin::Bin/cert-srv.pem&#34;;

and 
  return &#34;whatever&#34;; # password


Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Gonna start main thread part
&gt; [thread:0000] Inside callback
&gt; CTX_use_PrivateKey_file &#39;cert-srv.pem&#39; failed at cb-crash-ng2.pl line 18.
&gt; perl cb-crash-ng4.pl --file cert-srv.pem
&gt; Gonna start main thread part
&gt; [thread:0000] Inside callback
&gt; CTX_use_PrivateKey_file &#39;cert-srv.pem&#39; failed at cb-crash-ng4.pl line 20.
&gt; 
&gt; openssl rsa -in cert-srv.pem -text | head
&gt; Enter pass phrase for cert-srv.pem:
&gt; writing RSA key
&gt; Private-Key: &#40;1024 bit&#41;
&gt; modulus:
&gt;     00:d5:7c:35:95:fc:37:aa:a4:08:88:77:06:e5:2c:
&gt;     b4:83:1c:51:f9:69:6f:36:fa:35:ae:83:7d:59:fc:
&gt;     50:85:ae:4d:6c:6c:c5:38:bd:46:c5:3e:12:34:aa:
&gt;     dd:4a:84:30:6a:a0:ee:49:d6:08:50:b4:63:6c:a7:
&gt;     ee:05:c4:aa:8e:fd:40:64:3b:6b:a3:a4:ea:92:10:
&gt;     03:18:d4:e4:f5:0e:84:9a:be:d4:3a:78:26:37:ab:
&gt;     d4:f7:15:6b:d7:7a:28:68:0a:fc:cf:47:eb:80:98:
&gt;     11:4c:65:89:82:27:c4:b6:d6:12:b4:52:22:16:53:
&gt; 
&gt; 
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:10:07&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; perl cb-crash-ng2.pl --file cert-srv.pem
</div>&gt; 
&gt; Hmm, I dont think that syntax will work. I edited the file and made 2
&gt; changes:
</div>
pardon. I&#39;ve forgotten to annotate my changes at both scripts:

diff cb-crash-ng2.pl net-ssleay-callback-crash2/cb-crash-ng2.pl 
7c7
&lt; use Getopt::Long;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
</div>13,14c13
&lt; GetOptions&#40;&#39;file=s&#39; =&gt; \$file&#41;;
&lt; -e $file || die &#34;no file &#39;$file&#39;\n&#34;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
</div>18c17
&lt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file, &#38;Net::SSLeay::FILETYPE_PEM&#41; or die 
&#34;CTX_use_PrivateKey_file &#39;$file&#39; failed&#34;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file, &#38;Net::SSLeay::FILETYPE_PEM&#41; or die 
</div>&#34;CTX_use_PrivateKey_file failed&#34;;




diff cb-crash-ng4.pl net-ssleay-callback-crash2/cb-crash-ng4.pl 
7d6
&lt; use Getopt::Long;
14,15d12
&lt; GetOptions&#40;&#39;file=s&#39; =&gt; \$file&#41;;
&lt; -e $file || die &#34;no file &#39;$file&#39;\n&#34;;
20c17
&lt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file, &#38;Net::SSLeay::FILETYPE_PEM&#41; or die 
&#34;CTX_use_PrivateKey_file &#39;$file&#39; failed&#34;;
---
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file, &#38;Net::SSLeay::FILETYPE_PEM&#41; or die 
</div>&#34;CTX_use_PrivateKey_file failed&#34;;

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:20:11&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 20:52:58 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wednesday, February 01, 2012 05:29:59 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; all 15 to 20M each. Can email some if you want.
</div>&gt; 
&gt; 5.6.1 please 
</div>
Attached


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;if I understand correctly, we want to support Net::SSleay
&gt; on this version&#41;
</div>
Yes, I do.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Related question - what is the oldest openssl version we want to
&gt; support? in other words how old openssl makes sense to test with
&gt; Net::SSLeay?
</div>
There appears to be ifdefs relating to as far back as 9.5. So it might be fair 
to suggest that?

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:20:25&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other SystemError even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:20:29&nbsp;2012</span>
    <span class="description">The RT System itself -  System error</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Sending the previous mail has failed.  Please contact your admin, they can find more details in the logs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:36:06&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 21:24:34 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


On Wednesday, February 01, 2012 06:10:08 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; perl cb-crash-ng2.pl --file cert-srv.pem
</div>&gt; &gt; 
&gt; &gt; Hmm, I dont think that syntax will work. I edited the file and made 2
</div>&gt; 
<div class="message-stanza open">&gt; &gt; changes:
</div>&gt; pardon. I&#39;ve forgotten to annotate my changes at both scripts:
</div>

Oh, OK. You also need to change the decryption password to &#39;whatever&#39; which is 
what was used for that certificate.

Cheers.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; diff cb-crash-ng2.pl net-ssleay-callback-crash2/cb-crash-ng2.pl
&gt; 7c7
&gt; &lt; use Getopt::Long;
&gt; ---
&gt; 
&gt; 13,14c13
&gt; &lt; GetOptions&#40;&#39;file=s&#39; =&gt; \$file&#41;;
&gt; &lt; -e $file || die &#34;no file &#39;$file&#39;\n&#34;;
&gt; ---
&gt; 
&gt; 18c17
&gt; &lt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file,
&gt; &#38;Net::SSLeay::FILETYPE_PEM&#41; or die &#34;CTX_use_PrivateKey_file &#39;$file&#39;
&gt; failed&#34;;
&gt; ---
&gt; 
<div class="message-stanza open">&gt; &gt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file,
&gt; &gt; &#38;Net::SSLeay::FILETYPE_PEM&#41; or die
</div>&gt; &#34;CTX_use_PrivateKey_file failed&#34;;
&gt; 
&gt; 
&gt; 
&gt; 
&gt; diff cb-crash-ng4.pl net-ssleay-callback-crash2/cb-crash-ng4.pl
&gt; 7d6
&gt; &lt; use Getopt::Long;
&gt; 14,15d12
&gt; &lt; GetOptions&#40;&#39;file=s&#39; =&gt; \$file&#41;;
&gt; &lt; -e $file || die &#34;no file &#39;$file&#39;\n&#34;;
&gt; 20c17
&gt; &lt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file,
&gt; &#38;Net::SSLeay::FILETYPE_PEM&#41; or die &#34;CTX_use_PrivateKey_file &#39;$file&#39;
&gt; failed&#34;;
&gt; ---
&gt; 
<div class="message-stanza open">&gt; &gt; Net::SSLeay::CTX_use_PrivateKey_file&#40;$ctx, $file,
&gt; &gt; &#38;Net::SSLeay::FILETYPE_PEM&#41; or die
</div>&gt; &#34;CTX_use_PrivateKey_file failed&#34;;
&gt; 
&gt; palik
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;06:55:24&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Oh, OK. You also need to change the decryption password to &#39;whatever&#39;
&gt; which is
&gt; what was used for that certificate.
</div>
You are right. My bad. Now it&#39;s work.

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;07:00:27&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve tested net-ssleay-callback-crash3 again at squeeze
perl v5.10.1
openssl 0.9.8o-4squeeze7

cb-crash-ng4.pl died by using svn-r288:
perl cb-crash-ng4.pl  2&#38;&gt; net-ssleay-callback-crash3-result/svn-r288/cb-crash-ng4.log
Segmentation fault

palik

On Wed Feb 01 05:19:15 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; I have installed AFAIK the latest available ActivePerls from 
&gt; 5.8/5.10/5.12/5.14 series &#40;I have used clean install&#41; + made a fresh 
&gt; built of openssl 0.9.8e and 1.0.0g. To make test complete I have also 
&gt; used StrawberryPerl 5.14.2.1/32bit.
&gt; 
&gt; I took updated the crash-test suite &#40;see attached 
&gt; net-ssleay-callback-crash3.tar.gz&#41; and run all tests with current svn 
&gt; trunk &#40;rev288&#41;.
&gt; 
&gt; The results are quite consistent:
&gt; 
&gt; ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-0.9.8e + 
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:1248
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-1.0.0g + 
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:6110
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.12.4.1205-MSWin32-x86 + threads-1.82 + openssl-0.9.8e + 
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:0245
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.10.1.1007-MSWin32-x86 + threads-1.75 + openssl-0.9.8e + 
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:0064
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.8.9.827-MSWin32-x86 + threads-1.75 + openssl-0.9.8e + 
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:2037
&gt; - all the rest went fine
&gt; 
&gt; StrawberryPerl 5.14.2.1/32bit + threads-1.86 + openssl-1.0.0d + 
&gt; gcc-4.4.7-pre
&gt; - cb-crash-ng3.pl RUNS VEEEEEERY LONG &#40;this is CTX_new nearly-deadlock I 
&gt; have already reported&#41;
&gt; - cb-crash-ng3-nopasswd.pl RUNS VEEEEEERY LONG &#40;dtto&#41;
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:1702
&gt; - all the rest went fine
&gt; 
&gt; Could you please run net-ssleay-callback-crash3.tar.gz on your UNIX-like 
&gt; boxes? &#40;current svn trunk version&#41;
&gt; 
&gt; My conclusion - we have basically 2 remaining troubles:
&gt; 1/ cross-thread callbacks are terribly broken &#40;can be demonstrated by 
&gt; cb-crash-ng4.pl&#41;
&gt; 2/ CTX_new nearly-deadlock - which seems to be an issue only on Win32/gcc :&#40;
&gt; 
&gt; ad 1/ Making cross-thread callbacks possible would require quite huge 
&gt; changes, but with some effort it could be feasible - do we want to 
&gt; support cross-thread callbacks? &#40;for me it is nearly-zero-priority&#41;
&gt; 
&gt; ad 2/ My openssl-locking-kung-fu patch fixes this issue but I understand 
&gt; that I was not able to bring a better crash case &#40;&#34;working&#34; on more then 
&gt; 1 platform&#41; to convince you. On the other hand openssl documentation 
&gt; says that thread-safe use of openssl lib requires to utilize locking 
&gt; functions and as far as I understand openssl-locking-kung-fu patch does 
&gt; not seem to have an adverse effect on any platform we have tested. &#40;this 
&gt; is much higher priority for me&#41;
&gt; 
&gt; --
&gt; kmx
</div></div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> net-ssleay-callback-crash3-result.tar.gz</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;07:25:53&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 22:17:38 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Im seeing similar results on a range of platforms, though my tests are not 
complete. 

On Wednesday, February 01, 2012 05:19:17 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; I have installed AFAIK the latest available ActivePerls from
&gt; 5.8/5.10/5.12/5.14 series &#40;I have used clean install&#41; + made a fresh
&gt; built of openssl 0.9.8e and 1.0.0g. To make test complete I have also
&gt; used StrawberryPerl 5.14.2.1/32bit.
&gt; 
&gt; I took updated the crash-test suite &#40;see attached
&gt; net-ssleay-callback-crash3.tar.gz&#41; and run all tests with current svn
&gt; trunk &#40;rev288&#41;.
&gt; 
&gt; The results are quite consistent:
&gt; 
&gt; ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-0.9.8e +
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:1248
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.14.2.1402-MSWin32-x86 + threads-1.85 + openssl-1.0.0g +
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:6110
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.12.4.1205-MSWin32-x86 + threads-1.82 + openssl-0.9.8e +
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:0245
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.10.1.1007-MSWin32-x86 + threads-1.75 + openssl-0.9.8e +
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:0064
&gt; - all the rest went fine
&gt; 
&gt; ActivePerl-5.8.9.827-MSWin32-x86 + threads-1.75 + openssl-0.9.8e +
&gt; vc6/cl 12.00.8804
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:2037
&gt; - all the rest went fine
&gt; 
&gt; StrawberryPerl 5.14.2.1/32bit + threads-1.86 + openssl-1.0.0d +
&gt; gcc-4.4.7-pre
&gt; - cb-crash-ng3.pl RUNS VEEEEEERY LONG &#40;this is CTX_new nearly-deadlock I
&gt; have already reported&#41;
&gt; - cb-crash-ng3-nopasswd.pl RUNS VEEEEEERY LONG &#40;dtto&#41;
&gt; - CRASH during cb-crash-ng4.pl ~ around thread:1702
&gt; - all the rest went fine
&gt; 
&gt; Could you please run net-ssleay-callback-crash3.tar.gz on your UNIX-like
&gt; boxes? &#40;current svn trunk version&#41;
&gt; 
&gt; My conclusion - we have basically 2 remaining troubles:
&gt; 1/ cross-thread callbacks are terribly broken &#40;can be demonstrated by
&gt; cb-crash-ng4.pl&#41;
&gt; 2/ CTX_new nearly-deadlock - which seems to be an issue only on Win32/gcc :&#40;
&gt; 
&gt; ad 1/ Making cross-thread callbacks possible would require quite huge
&gt; changes, but with some effort it could be feasible - do we want to
&gt; support cross-thread callbacks? &#40;for me it is nearly-zero-priority&#41;
</div>
Do you mean: the callback occurs in another thread, not the one that 
established the callback?

No I would not expect cross thread callbacks to be available in any case. This 
sort of thing is not likely to be well supported in perl either. Dont do it!

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; ad 2/ My openssl-locking-kung-fu patch fixes this issue but I understand
&gt; that I was not able to bring a better crash case &#40;&#34;working&#34; on more then
&gt; 1 platform&#41; to convince you. On the other hand openssl documentation
&gt; says that thread-safe use of openssl lib requires to utilize locking
&gt; functions and as far as I understand openssl-locking-kung-fu patch does
&gt; not seem to have an adverse effect on any platform we have tested. &#40;this
&gt; is much higher priority for me&#41;
</div>
Confusion: I dont think I have seen a patch called openssl-locking-kung-fu, or 
are you being facetious? I have been testing with fix-for-ctx_new-deadlock-
v2_rev288.diff applied to 288. Correct? Is that what you would like to become 
the mainline?

However, I dont think that on the platforms I have tested, that fix-for-
ctx_new-deadlock-v2_rev288.diff makes any difference to the outcomes. So: are 
you convinced it really is necessary?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;07:25:56&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 22:17:29 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;07:44:13&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> info [...] maximka.de, kmx [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 13:44:04 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Conclusion: all tests on all may easy platforms &#40;with and without fix-for-
&gt; ctx_new-deadlock-v2_rev288.diff&#41; worked fine except for cb-crash-ng4.pl which
&gt; failed on all platforms.
&gt;    
</div>
Which means &#34;cross-threaded&#34; callbacks do not work, the rest is fine - 
for now it would be fine just to declare in documentation that it is not 
thread-safe practice to use cross-threads callbacks.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Corollary: fix-for-ctx_new-deadlock-v2_rev288.diff made no difference on these
&gt; tests in these platforms. Does it really fix something thats broken? Evidence?
&gt;    
</div>
The only broken thing I am able to demonstrate is nearly-deadlock when 
starting concurrently more threads trying to call CTX_new&#40;&#41; - which is 
the test case cb-crash-ng3.pl &#40;it nearly-hangs-up only on MSWin 
32bit/gcc-compiled perl&#41;. Extra locking patch fixes this issue.

We can:
1/ ignore it completely and mention potential CTX_new&#40;&#41; deadlock in 
documentation
2/ try to find more crashy testcase
3/ make openssl locking initialization optional - e.g. 
Net::SSLeay::init_openssl_thread_safe_locking&#40;&#41;
4/ turn on openssl locking automatically always when USE_ITHREADS &#40;this 
does my patch&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;08:29:43&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 14:29:34 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; all 15 to 20M each. Can email some if you want.
&gt;&gt;      
</div>&gt; 5.6.1 please &#40;if I understand correctly, we want to support Net::SSleay
&gt; on this version&#41;
&gt;    
</div>
Do not send it, I have already found it on rapidshare

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;12:40:12&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 18:40:00 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ... call CTX_new&#40;&#41; - which is the test case cb-crash-ng3.pl &#40;it
&gt; nearly-hangs-up only on MSWin 32bit/gcc-compiled perl&#41;.
</div>
You can grab a testing environment from 
<span class="clickylink"><a target="new" rel="nofollow" href="http://strawberryperl.com/package/kmx/p5.14.2.1-RC/strawberry-perl-5.14.2.1-32bit-portable.zip">http://strawberryperl.com/package/kmx/p5.14.2.1-RC/strawberry-perl-5.14.2.1-32bit-portable.zip</a></span> 
&#40;gcc and openssl are included; just use dmake instead of make the rest 
works like in any other perl environment&#41;

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;14:41:28&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 20:41:17 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">see updated 61_threads-cb-crash.t &#40;should work with older perls&#41;, IMHO 
ready to be included into test suite
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;15:05:38&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 01 Feb 2012 21:05:27 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">mike,

ad openssl locking - to prove that it is not a virtual reality
- untar openssl tarball
- grep source codes for string CRYPTO_LOCK_

They really use it, not extensively but they do &#40;I guess in 20-30 
functions - just few of them we use from Net::SSleay&#41;.

another  deadlock/crash candidates:
SSL_CTX_flush_sessions
SSL_set_session
SSL_SESSION_free
SSL_CTX_add_session
SSL_get1_session
SSL_copy_session_id
SSL_get_peer_certificate
SSL_new


--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;15:47:11&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Feb 01 14:41:28 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; see updated 61_threads-cb-crash.t &#40;should work with older perls&#41;, IMHO 
&gt; ready to be included into test suite
</div>
on squeeze svn-r288+fix-for-ctx_new-deadlock-v2_rev288
t/local/61_threads-cb-crash.t .. ok 

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;15:50:00&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 06:49:47 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wednesday, February 01, 2012 07:44:15 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Conclusion: all tests on all may easy platforms &#40;with and without
&gt; &gt; fix-for- ctx_new-deadlock-v2_rev288.diff&#41; worked fine except for
&gt; &gt; cb-crash-ng4.pl which failed on all platforms.
</div>&gt; 
&gt; Which means &#34;cross-threaded&#34; callbacks do not work, the rest is fine -
&gt; for now it would be fine just to declare in documentation that it is not
&gt; thread-safe practice to use cross-threads callbacks.
</div>
Agree.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; Corollary: fix-for-ctx_new-deadlock-v2_rev288.diff made no difference on
&gt; &gt; these tests in these platforms. Does it really fix something thats
&gt; &gt; broken? Evidence?
</div>&gt; The only broken thing I am able to demonstrate is nearly-deadlock when
&gt; starting concurrently more threads trying to call CTX_new&#40;&#41; - which is
&gt; the test case cb-crash-ng3.pl &#40;it nearly-hangs-up only on MSWin
&gt; 32bit/gcc-compiled perl&#41;. Extra locking patch fixes this issue.
&gt; 
&gt; We can:
&gt; 1/ ignore it completely and mention potential CTX_new&#40;&#41; deadlock in
&gt; documentation
&gt; 2/ try to find more crashy testcase
&gt; 3/ make openssl locking initialization optional - e.g.
&gt; Net::SSLeay::init_openssl_thread_safe_locking&#40;&#41;
&gt; 4/ turn on openssl locking automatically always when USE_ITHREADS &#40;this
&gt; does my patch&#41;
</div>
I think 4 is the preferred option.

I you will send a final patch against 289 with updated doc and perhaps some 
portable test, I will apply it.

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;01&nbsp;16:00:43&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 07:00:27 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

On Wednesday, February 01, 2012 02:41:29 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; see updated 61_threads-cb-crash.t &#40;should work with older perls&#41;, IMHO
&gt; ready to be included into test suite
</div>
Not quite.

Linux perl 5.14, openssl 1.0.0. gcc 4.6.2 on OpenSuSE 12.1 8 core
Runs fine

Windows Server 2003 32 bit activeperl 5.12, openssl 0.9.8i, MS Visual C 6, MS 
C compiler version 12
Takes about 30 secs to run, but OK.

Windows Server 2003 32 bit activeperl 5.10, openssl 0.9.8i,  MS Visual C 6, MS 
C compiler version 12
Takes about 30 secs to run, but OK.

Windows Server 2003 32 bit activeperl 5.8.8, openssl 0.9.8i,  MS Visual C 6, 
MS C compiler version 12
Takes about 30 secs, then message:
A thread exited while 2 threads were running

-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;01:18:12&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 07:17:59 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Windows Server 2003 32 bit activeperl 5.8.8, openssl 0.9.8i,  MS Visual C 6,
&gt; MS C compiler version 12
&gt; Takes about 30 secs, then message:
&gt; A thread exited while 2 threads were running
&gt;    
</div>
It is not as big trouble as it might seem. This happened due to my 
deadlock-detection-timer that simply does &#34;hard exit&#34; of the whole test 
after 30s.

I have made this test less demanding - see attachment &#40;it still reliably 
crashes on unpatched Net::SSLeay-1.42&#41;.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;01:19:45&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 07:19:36 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I you will send a final patch against 289 with updated doc and perhaps some
&gt; portable test, I will apply it.
&gt;    
</div>
Thanks. I&#39;ll prepare patch+doc+test in release quality.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;01:32:28&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 16:32:15 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Sorry, but the new version makes the same complaint on 5.8

Cheers.

On Thursday, February 02, 2012 01:18:14 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Windows Server 2003 32 bit activeperl 5.8.8, openssl 0.9.8i,  MS Visual
&gt; &gt; C 6, MS C compiler version 12
&gt; &gt; Takes about 30 secs, then message:
&gt; &gt; A thread exited while 2 threads were running
</div>&gt; 
&gt; It is not as big trouble as it might seem. This happened due to my
&gt; deadlock-detection-timer that simply does &#34;hard exit&#34; of the whole test
&gt; after 30s.
&gt; 
&gt; I have made this test less demanding - see attachment &#40;it still reliably
&gt; crashes on unpatched Net::SSLeay-1.42&#41;.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Feb&nbsp;02&nbsp;03:05:01&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Feb 2012 09:04:51 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; Which means &#34;cross-threaded&#34; callbacks do not work, the rest is fine -
&gt;&gt; for now it would be fine just to declare in documentation that it is not
&gt;&gt; thread-safe practice to use cross-threads callbacks.
&gt;&gt;      
</div>&gt; Agree.
&gt;    
</div>
I have a way how to quite simply detect cross-thread callbacks &#40;the 
action will be: throw a warning + do not call it&#41;.

I will include this into my 
&#34;hopefully-the-final-multi-threading-related-dark-magic-hack&#34; I am 
working on.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;07:07:00&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 03 Feb 2012 13:06:46 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

please find my last-thread-safety-fix_r289.diff &#40;xs code + doc&#41; + 2 test 
files &#40;*.t&#41;.

It runs fine on all my platforms.

The only troubles seems to be with pure 5.8.8 at it includes very old 
version of threads module &#40;1.07&#41; which quite hard to be sanely used.

My test ends up like this:

$ prove -bv t/local/61_threads-cb-crash.t
t/local/61_threads-cb-crash....1..1
ok 1 - successfully finished, duration=0
A thread exited while 2 threads were running.
ok
All tests successful.
Files=1, Tests=1,  0 wallclock secs &#40; 0.16 cusr +  0.00 csys =  0.16 CPU&#41;

Which is OK &#40;the warning is caused by one detached thread that I 
intentionally do not want to finish, later versions of threads module 
does not warn about this&#41;.

If you do not like the warning on 5.8.8 I propose skipping thread 
related tests if treads 1.71 &#40;which corresponds to version released 
together with perl-5.8.9&#41; or newer is not available.

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;07:51:15&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Mac OS X 10.6.8
perl v5.14.1

t/local/02_pod_coverage.t .............. skipped: currently disabled
t/local/20_autoload.t .................. skipped: Some tests need Test::Exception
t/local/30_error.t ..................... skipped: Requires Test::Exception, Test::Warn and 
Test::NoWarnings
t/local/31_rsa_generate_key.t .......... skipped: Test::Exception required

t/local/61_threads-cb-crash.t .......... ok   
t/local/62_threads-ctx_new-deadlock.t .. ok
the rest ok too.

What&#39;s wrong here?

perl Makefile.PL said
...
*** Found OpenSSL-0.9.8r installed in /usr

but openssl version said
OpenSSL 1.0.0g 18 Jan 2012

------------------------

Ubuntu 10.04.3
perl v5.10.1
OpenSSL 0.9.8k 25 Mar 2009

t/local/02_pod_coverage.t .............. skipped: currently disabled
t/local/30_error.t ..................... skipped: Requires Test::Exception, Test::Warn and 
Test::NoWarnings
t/local/kwalitee.t ..................... skipped: Needs Test::Kwalitee

t/local/61_threads-cb-crash.t .......... ok   
t/local/62_threads-ctx_new-deadlock.t .. ok   
the rest ok too

------------------------
Debian GNU/Linux 6.0 squeeze
perl v5.10.1
OpenSSL 0.9.8o 01 Jun 2010

t/local/01_pod.t ....................... skipped: Test::Pod 1.00 required for testing POD
t/local/02_pod_coverage.t .............. skipped: currently disabled
t/local/20_autoload.t .................. ok   t/local/30_error.t ..................... skipped: Requires 
Test::Exception, Test::Warn and Test::NoWarnings
t/local/kwalitee.t ..................... skipped: Needs Test::Kwalitee

t/local/61_threads-cb-crash.t .......... ok   
t/local/62_threads-ctx_new-deadlock.t .. ok   
the rest ok too

palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;18:01:57&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 04 Feb 2012 09:01:46 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Thanks, I have rolled your patch in, but looks like svn is down at present. 
Will commit later today.


On Friday, February 03, 2012 07:07:03 AM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Hi,
&gt; 
&gt; please find my last-thread-safety-fix_r289.diff &#40;xs code + doc&#41; + 2 test
&gt; files &#40;*.t&#41;.
&gt; 
&gt; It runs fine on all my platforms.
&gt; 
&gt; The only troubles seems to be with pure 5.8.8 at it includes very old
&gt; version of threads module &#40;1.07&#41; which quite hard to be sanely used.
&gt; 
&gt; My test ends up like this:
&gt; 
&gt; $ prove -bv t/local/61_threads-cb-crash.t
&gt; t/local/61_threads-cb-crash....1..1
&gt; ok 1 - successfully finished, duration=0
&gt; A thread exited while 2 threads were running.
&gt; ok
&gt; All tests successful.
&gt; Files=1, Tests=1,  0 wallclock secs &#40; 0.16 cusr +  0.00 csys =  0.16 CPU&#41;
&gt; 
&gt; Which is OK &#40;the warning is caused by one detached thread that I
&gt; intentionally do not want to finish, later versions of threads module
&gt; does not warn about this&#41;.
&gt; 
&gt; If you do not like the warning on 5.8.8 I propose skipping thread
&gt; related tests if treads 1.71 &#40;which corresponds to version released
&gt; together with perl-5.8.9&#41; or newer is not available.
&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;03&nbsp;19:13:23&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 04 Feb 2012 10:13:13 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">OK, Committed 290
Cheers.

On Saturday, February 04, 2012 09:01:46 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; Thanks, I have rolled your patch in, but looks like svn is down at present.
&gt; Will commit later today.
&gt; 
&gt; On Friday, February 03, 2012 07:07:03 AM kmx via RT wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt; 
&gt; &gt; Hi,
&gt; &gt; 
&gt; &gt; please find my last-thread-safety-fix_r289.diff &#40;xs code + doc&#41; + 2 test
&gt; &gt; files &#40;*.t&#41;.
&gt; &gt; 
&gt; &gt; It runs fine on all my platforms.
&gt; &gt; 
&gt; &gt; The only troubles seems to be with pure 5.8.8 at it includes very old
&gt; &gt; version of threads module &#40;1.07&#41; which quite hard to be sanely used.
&gt; &gt; 
&gt; &gt; My test ends up like this:
&gt; &gt; 
&gt; &gt; $ prove -bv t/local/61_threads-cb-crash.t
&gt; &gt; t/local/61_threads-cb-crash....1..1
&gt; &gt; ok 1 - successfully finished, duration=0
&gt; &gt; A thread exited while 2 threads were running.
&gt; &gt; ok
&gt; &gt; All tests successful.
&gt; &gt; Files=1, Tests=1,  0 wallclock secs &#40; 0.16 cusr +  0.00 csys =  0.16
&gt; &gt; CPU&#41;
&gt; &gt; 
&gt; &gt; Which is OK &#40;the warning is caused by one detached thread that I
&gt; &gt; intentionally do not want to finish, later versions of threads module
&gt; &gt; does not warn about this&#41;.
&gt; &gt; 
&gt; &gt; If you do not like the warning on 5.8.8 I propose skipping thread
&gt; &gt; related tests if treads 1.71 &#40;which corresponds to version released
&gt; &gt; together with perl-5.8.9&#41; or newer is not available.
&gt; &gt; 
&gt; &gt; --
&gt; &gt; kmx
</div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;05&nbsp;16:01:22&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; OK, Committed 290 <br>
</div><br>

Cool, thanks men.<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;05&nbsp;17:49:22&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  TimeWorked changed from &#40;no value&#41; to &#39;600&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Feb&nbsp;05&nbsp;17:49:22&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;04:10:46&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">thank you guys for fast bug solving.

regards,
palik
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;04:10:52&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Mar&nbsp;18&nbsp;19:25:52&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">kmx, have you seen subsequent discussion of this patch and resulting
segfault at:

<span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Public/Bug/Display.html?id=75841">https://rt.cpan.org/Public/Bug/Display.html?id=75841</a></span>

I would value your input on that.

Cheers.

On Mon Feb 06 04:10:46 2012, palik wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; thank you guys for fast bug solving.
&gt; 
&gt; regards,
&gt; palik
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;02:22:46&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 07:22:32 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am sending a cosmetic changes related to threads.

It turned out that OPENSSL_THREADS we use in #ifdefs is defined only in 
openssl-0.9.7 and newer.

Therefore I have simplified related #ifdefs and officially declare 
threading support since 0.9.7

--
kmx
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;03:19:10&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 17:19:03 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


On Thursday, March 22, 2012 02:22:48 AM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; I am sending a cosmetic changes related to threads.
&gt; 
&gt; It turned out that OPENSSL_THREADS we use in #ifdefs is defined only in
&gt; openssl-0.9.7 and newer.
&gt; 
&gt; Therefore I have simplified related #ifdefs and officially declare
&gt; threading support since 0.9.7
</div>
Thanks. tests fine here.

Committed at 324
Cheers.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; --
&gt; kmx
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;06:35:00&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

no idea if you expect test on my part. How ever I&#39;ve tested r324 too.
1. wheezy, openssl 1.0.0h-1, perl v5.14.2
...
t/local/07_sslecho.t ................... DEBUG: BOOT start
DEBUG: init - begin
DEBUG: setting static locking
DEBUG: setting dynamic locking
DEBUG: init - end
DEBUG: BOOT done: tid=0 my_perl=0
Not enough arguments for Net::SSLeay::get_shared_ciphers at t/local/07_sslecho.t line 64, 
near &#34;$ssl&#41;&#34;
Execution of t/local/07_sslecho.t aborted due to compilation errors.
# Looks like your test exited with 255 before it could output anything.
t/local/07_sslecho.t ................... Dubious, test returned 255 &#40;wstat 65280, 0xff00&#41;
Failed 78/78 subtests 
...
Test Summary Report
-------------------
t/local/07_sslecho.t                 &#40;Wstat: 65280 Tests: 0 Failed: 0&#41;
  Non-zero exit status: 255
  Parse errors: Bad plan.  You planned 78 tests but ran 0.
Files=24, Tests=1617,  4 wallclock secs &#40; 0.14 usr  0.41 sys +  1.53 cusr  1.44 csys =  3.52 
CPU&#41;
Result: FAIL

2. MAC OS X 10.6.8, opensslL 1.0.0g, perl v5.14.1

t/local/33_x509_create_cert.t .......... 1/124 
#   Failed test &#39;ASN1_INTEGER_get&#39;
#   at t/local/33_x509_create_cert.t line 52.
#          got: &#39;123456789123456789&#39;
#     expected: &#39;-1&#39;
t/local/33_x509_create_cert.t .......... 46/124 # Looks like you failed 1 test of 124.
t/local/33_x509_create_cert.t .......... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
Failed 1/124 subtests 
t/local/34_x509_crl.t ....
...
Test Summary Report
-------------------
t/local/33_x509_create_cert.t        &#40;Wstat: 256 Tests: 124 Failed: 1&#41;
  Failed test:  21
  Non-zero exit status: 1
Files=24, Tests=2130,  5 wallclock secs &#40; 0.32 usr  0.10 sys +  2.69 cusr  0.30 csys =  3.41 
CPU&#41;
Result: FAIL

palik

On Thu Mar 22 03:19:10 2012, mikem@open.com.au wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
&gt; 
&gt; 
&gt; On Thursday, March 22, 2012 02:22:48 AM you wrote:
<div class="message-stanza open">&gt; &gt;        Queue: Net-SSLeay
&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt; 
&gt; &gt; I am sending a cosmetic changes related to threads.
&gt; &gt; 
&gt; &gt; It turned out that OPENSSL_THREADS we use in #ifdefs is defined only in
&gt; &gt; openssl-0.9.7 and newer.
&gt; &gt; 
&gt; &gt; Therefore I have simplified related #ifdefs and officially declare
&gt; &gt; threading support since 0.9.7
</div>&gt; 
&gt; Thanks. tests fine here.
&gt; 
&gt; Committed at 324
&gt; Cheers.
&gt;  
<div class="message-stanza open">&gt; &gt; 
&gt; &gt; --
&gt; &gt; kmx
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;07:28:15&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 12:28:05 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; no idea if you expect test on my part. How ever I&#39;ve tested r324 too.
&gt; 1. wheezy, openssl 1.0.0h-1, perl v5.14.2
&gt; ...
&gt; t/local/07_sslecho.t ................... DEBUG: BOOT start
&gt; DEBUG: init - begin
&gt; DEBUG: setting static locking
&gt; DEBUG: setting dynamic locking
&gt; DEBUG: init - end
&gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; Not enough arguments for Net::SSLeay::get_shared_ciphers at t/local/07_sslecho.t line 64,
&gt; near &#34;$ssl&#41;&#34;
&gt;    
</div>
Please try to test on a clean svn checkout - this should not be failing


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. MAC OS X 10.6.8, opensslL 1.0.0g, perl v5.14.1
&gt;
&gt; t/local/33_x509_create_cert.t .......... 1/124
&gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt; #   at t/local/33_x509_create_cert.t line 52.
&gt; #          got: &#39;123456789123456789&#39;
&gt; #     expected: &#39;-1&#39;
&gt; t/local/33_x509_create_cert.t .......... 46/124 # Looks like you failed 1 test of 124.
&gt; t/local/33_x509_create_cert.t .......... Dubious, test returned 1 &#40;wstat 256, 0x100&#41;
&gt;    
</div>
This is a bug in test suite - your MacOSX has probably &#39;long int&#39; that 
is longer than usual :&#41;

&#39;123456789123456789&#39; is correct serial number; however the test expects 
-1 as the serial number is longer than 32bit integer

Could you please create a separate RT for this test failure.

--
kmx
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;07:56:14&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 12:56:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/local/33_x509_create_cert.t .......... 1/124
&gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt; #   at t/local/33_x509_create_cert.t line 52.
&gt; #          got: &#39;123456789123456789&#39;
&gt; #     expected: &#39;-1&#39;
&gt;    
</div>
Try enclosed serial_number_fix.diff
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;08:23:03&nbsp;2012</span>
    <span class="description">info [...] maximka.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; t/local/07_sslecho.t line 64,
<div class="message-stanza open">&gt; &gt; near &#34;$ssl&#41;&#34;
</div>&gt; Please try to test on a clean svn checkout - this should not be
&gt; failing
</div>
r327
prove t/local/
...
t/local/07_sslecho.t ................... ok
...
All tests successful.
Files=25, Tests=1714,  4 wallclock secs &#40; 0.14 usr  0.42 sys +  1.56 cusr  1.60 csys =  3.72 
CPU&#41;
Result: PASS

palik

On Thu Mar 22 07:28:15 2012, kmx@volny.cz wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; no idea if you expect test on my part. How ever I&#39;ve tested r324
</div>&gt; too.
<div class="message-stanza open">&gt; &gt; 1. wheezy, openssl 1.0.0h-1, perl v5.14.2
&gt; &gt; ...
&gt; &gt; t/local/07_sslecho.t ................... DEBUG: BOOT start
&gt; &gt; DEBUG: init - begin
&gt; &gt; DEBUG: setting static locking
&gt; &gt; DEBUG: setting dynamic locking
&gt; &gt; DEBUG: init - end
&gt; &gt; DEBUG: BOOT done: tid=0 my_perl=0
&gt; &gt; Not enough arguments for Net::SSLeay::get_shared_ciphers at
</div>&gt; t/local/07_sslecho.t line 64,
<div class="message-stanza open">&gt; &gt; near &#34;$ssl&#41;&#34;
&gt; &gt;
</div>&gt; 
&gt; Please try to test on a clean svn checkout - this should not be
&gt; failing
&gt; 
&gt; 
<div class="message-stanza open">&gt; &gt; 2. MAC OS X 10.6.8, opensslL 1.0.0g, perl v5.14.1
&gt; &gt;
&gt; &gt; t/local/33_x509_create_cert.t .......... 1/124
&gt; &gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt; &gt; #   at t/local/33_x509_create_cert.t line 52.
&gt; &gt; #          got: &#39;123456789123456789&#39;
&gt; &gt; #     expected: &#39;-1&#39;
&gt; &gt; t/local/33_x509_create_cert.t .......... 46/124 # Looks like you
</div>&gt; failed 1 test of 124.
<div class="message-stanza open">&gt; &gt; t/local/33_x509_create_cert.t .......... Dubious, test returned 1
</div>&gt; &#40;wstat 256, 0x100&#41;
<div class="message-stanza open">&gt; &gt;
</div>&gt; 
&gt; This is a bug in test suite - your MacOSX has probably &#39;long int&#39; that
&gt; is longer than usual :&#41;
&gt; 
&gt; &#39;123456789123456789&#39; is correct serial number; however the test
&gt; expects
&gt; -1 as the serial number is longer than 32bit integer
&gt; 
&gt; Could you please create a separate RT for this test failure.
&gt; 
&gt; --
&gt; kmx
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;16:51:54&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 23 Mar 2012 06:51:51 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

Tests OK here.
Do you want me to commit?

Cheers.

On Thursday, March 22, 2012 07:56:16 AM kmx via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; t/local/33_x509_create_cert.t .......... 1/124
&gt; &gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt; &gt; #   at t/local/33_x509_create_cert.t line 52.
&gt; &gt; #          got: &#39;123456789123456789&#39;
&gt; &gt; #     expected: &#39;-1&#39;
</div>&gt; 
&gt; Try enclosed serial_number_fix.diff
</div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;17:48:42&nbsp;2012</span>
    <span class="description">kmx [...] volny.cz -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 22 Mar 2012 22:48:19 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Kmx &lt;kmx [...] volny.cz&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Yes please, commit 

&#34;mikem@open.com.au via RT&#34; &lt;bug-Net-SSLeay@rt.cpan.org&gt;napsal/a:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt;
&gt;Hi,
&gt;
&gt;Tests OK here.
&gt;Do you want me to commit?
&gt;
&gt;Cheers.
&gt;
&gt;On Thursday, March 22, 2012 07:56:16 AM kmx via RT wrote:
<div class="message-stanza open">&gt;&gt;        Queue: Net-SSLeay
&gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt;&gt; 
<div class="message-stanza open">&gt;&gt; &gt; t/local/33_x509_create_cert.t .......... 1/124
&gt;&gt; &gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt;&gt; &gt; #   at t/local/33_x509_create_cert.t line 52.
&gt;&gt; &gt; #          got: &#39;123456789123456789&#39;
&gt;&gt; &gt; #     expected: &#39;-1&#39;
</div>&gt;&gt; 
&gt;&gt; Try enclosed serial_number_fix.diff
</div>&gt;-- 
&gt;Mike McCauley                               mikem@open.com.au
&gt;Open System Consultants Pty. Ltd
&gt;9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
&gt;Phone +61 7 5598-7474                       Fax   +61 7 5598-7070
&gt;
&gt;Radiator: the most portable, flexible and configurable RADIUS server 
&gt;anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
&gt;Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
&gt;TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
&gt;DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
&gt;
&gt;
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;18:31:09&nbsp;2012</span>
    <span class="description">kmx [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">On Thu Mar 22 17:48:42 2012, kmx@volny.cz wrote: <br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Yes please, commit <br>
</div><br>

and close this RT<br>

<br>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;19:15:46&nbsp;2012</span>
    <span class="description">mikem [...] open.com.au -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #73532] using Net::SSLeay in threads</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 23 Mar 2012 09:15:40 +1000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SSLeay [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Mike McCauley &lt;mikem [...] open.com.au&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,


On Thursday, March 22, 2012 05:48:43 PM you wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;        Queue: Net-SSLeay
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; 
&gt; Yes please, commit
</div>
Done at 328

Cheers.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; &#34;mikem@open.com.au via RT&#34; &lt;bug-Net-SSLeay@rt.cpan.org&gt;napsal/a:
<div class="message-stanza open">&gt; &gt;&lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt;
&gt; &gt;Hi,
&gt; &gt;
&gt; &gt;Tests OK here.
&gt; &gt;Do you want me to commit?
&gt; &gt;
&gt; &gt;Cheers.
&gt; &gt;
&gt; &gt;On Thursday, March 22, 2012 07:56:16 AM kmx via RT wrote:
<div class="message-stanza open">&gt; &gt;&gt;        Queue: Net-SSLeay
&gt; &gt;&gt;  
&gt; &gt;&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=73532">https://rt.cpan.org/Ticket/Display.html?id=73532</a></span> &gt;
&gt; &gt;&gt;  
<div class="message-stanza open">&gt; &gt;&gt; &gt; t/local/33_x509_create_cert.t .......... 1/124
&gt; &gt;&gt; &gt; #   Failed test &#39;ASN1_INTEGER_get&#39;
&gt; &gt;&gt; &gt; #   at t/local/33_x509_create_cert.t line 52.
&gt; &gt;&gt; &gt; #          got: &#39;123456789123456789&#39;
&gt; &gt;&gt; &gt; #     expected: &#39;-1&#39;
</div>&gt; &gt;&gt; 
&gt; &gt;&gt; Try enclosed serial_number_fix.diff
</div></div></div>-- 
Mike McCauley                               mikem@open.com.au
Open System Consultants Pty. Ltd
9 Bulbul Place Currumbin Waters QLD 4223 Australia   <span class="clickylink"><a target="new" rel="nofollow" href="http://www.open.com.au">http://www.open.com.au</a></span>
Phone +61 7 5598-7474                       Fax   +61 7 5598-7070

Radiator: the most portable, flexible and configurable RADIUS server 
anywhere. SQL, proxy, DBM, files, LDAP, NIS+, password, NT, Emerald, 
Platypus, Freeside, TACACS+, PAM, external, Active Directory, EAP, TLS, 
TTLS, PEAP, TNC, WiMAX, RSA, Vasco, Yubikey, MOTP, HOTP, TOTP,
DIAMETER etc. Full source on Unix, Windows, MacOSX, Solaris, VMS, NetWare etc.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;22&nbsp;19:23:31&nbsp;2012</span>
    <span class="description">MIKEM [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
