<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #13063 for Devel-SimpleTrace: Failing tests for Error-&gt;throw &#40;object or structure&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #13063 for Devel-SimpleTrace: Failing tests for Error-&gt;throw &#40;object or structure&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Devel-SimpleTrace/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Devel-SimpleTrace/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Devel-SimpleTrace/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Devel-SimpleTrace/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Devel-SimpleTrace">Devel-SimpleTrace CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">13063</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Devel-SimpleTrace/Active/">Devel-SimpleTrace</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
martin [...] hybyte.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Normal    </td>
  </tr>
  <tr id="CF-11196-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.04    </td>
  </tr>
  <tr id="CF-11197-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;16:01:49&nbsp;2005</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Failing tests for Error-&gt;throw &#40;object or structure&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">using Devel::SimpleTrace stops some tests from working.

If your test expects an exception thrown, and test for the result it will likely fail with Devel::SimpleTrace.

This is as $@ is replaced by a text including the callstack.


The problem arises for test like

eval { die &#34;text&#34; };
ok $@ eq &#39;text&#39;;

or for object or perl data structures beeing thrown.

also watch the following command line scripts


perl -MDevel::SimpleTrace -we &#39; eval { die { a=&gt;1 }; }; print ref $@; &#39;

perl  -we &#39; eval { die { a=&gt;1 }; }; print ref $@; &#39;
HASH



Not sure how to Fix, I dont know, why the code is doing anything if die occurs in_eval

from sub _do_die :

    if&#40;$in_eval&#41; {
        $@ = $stderr;
        $stderr = &#39;&#39;;
        $in_eval = 0;
        CORE::die $@
     }

Possible Solutions:
- do nothing if in_eval
- do nothing by default, and allow to enable this feature, by passing an arg to import:
  use Devel::SimpleTrace &#39;eval&#39;
allow several switches, for $@ is plain text, or structure/object
- do it by default &#40;maybe only for text&#41;, and allow to switch on/off the rest

Also a nice Idea &#40;or has someone a better solution&#41; allow switching via $ENV.

if you do &#34;perl -MDevel::SimpleTrace &#34;  you cant pass arguments to import. So 

TRACE_EVAL=0 perl -MDevel::SimpleTrace
could do the trick.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;21&nbsp;20:12:04&nbsp;2005</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 22 Jun 2005 02:11:49 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [cpan #13063] Failing tests for Error-&gt;throw &#40;object or structure&#41; </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sébastien Aperghis-Tramoni &lt;saper [...] cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Devel-SimpleTrace [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-Cc:</td>
    <td class="message-header-value"> </td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

Apologies for answering only now, but I&#39;ll take the organisation of 
FPW2005 as an excuse :-&#41;

You wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; using Devel::SimpleTrace stops some tests from working.
&gt;
&gt; If your test expects an exception thrown, and test for the result it 
&gt; will likely fail with Devel::SimpleTrace.
&gt;
&gt; This is as $@ is replaced by a text including the callstack.
&gt;
&gt; The problem arises for test like
&gt;
&gt; eval { die &#34;text&#34; };
&gt; ok $@ eq &#39;text&#39;;
</div>
Hmm.. That code looks like a red flag to me. I think you should not try 
to compare the error message with eq but with a m// to match the 
beginning of the string because the actual text may vary from what you 
can expect.

And if you are doing this for tests, Test::Warn and Test::Exception are 
most certainly better suited for this task.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; or for object or perl data structures beeing thrown.
&gt;
&gt; also watch the following command line scripts
&gt;
&gt; perl -MDevel::SimpleTrace -we &#39; eval { die { a=&gt;1 }; }; print ref $@; &#39;
&gt;
&gt; perl  -we &#39; eval { die { a=&gt;1 }; }; print ref $@; &#39;
&gt; HASH
</div>
I didn&#39;t know you could give die&#40;&#41; a ref and expect it to actually work.
perldoc confirms me this is a valid and documented usage so I take that 
as a bug or caveat of Devel::SimpleTrace.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Not sure how to Fix, I dont know, why the code is doing anything if 
&gt; die occurs in_eval
&gt;
&gt; from sub _do_die :
&gt;
&gt;     if&#40;$in_eval&#41; {
&gt;         $@ = $stderr;
&gt;         $stderr = &#39;&#39;;
&gt;         $in_eval = 0;
&gt;         CORE::die $@
&gt;      }
</div>
IIRC this code is here to avoid some forms of eval&#40;&#41; that were causing 
Devel::SimpleTrace to produce incorrect traces &#40;I can&#39;t remember the 
exact details&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Possible Solutions:
&gt; - do nothing if in_eval
</div>
No. The aim of Devel::SimpleTrace is to allow for an easier mean to 
trace warnings and errors, even those that are inside eval&#40;&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; - do nothing by default, and allow to enable this feature, by passing 
&gt; an arg to import:
&gt;   use Devel::SimpleTrace &#39;eval&#39;
&gt; allow several switches, for $@ is plain text, or structure/object
&gt; - do it by default &#40;maybe only for text&#41;, and allow to switch on/off 
&gt; the rest
</div>
Hmm.. I can print the traces as usual when it&#39;s plain text and just 
return the thing unchanged when it&#39;s an object or reference.

But I&#39;d say that I primarily wrote Devel::SimpleTrace in order to ease 
interactive debugging sessions, by just adding it to perl switches:

     perl -WMDevel::SimpleTrace program_with_hairy_warnings.pl

Of course you can use it permanently with a &#34;use Devel::SimpleTrace&#34;, 
it&#39;s just that I didn&#39;t think it would be its typical usage :-&#41;

So I understand the need to preserve the references when seeing them, 
but I also see that a mode where Devel::SimpleTrace stringify them 
would be very useful. This is what should be the option: stringify 
references.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Also a nice Idea &#40;or has someone a better solution&#41; allow switching 
&gt; via $ENV.
&gt;
&gt; if you do &#34;perl -MDevel::SimpleTrace &#34;  you cant pass arguments to 
&gt; import. So
&gt;
&gt; TRACE_EVAL=0 perl -MDevel::SimpleTrace
&gt; could do the trick.
</div>
In fact, you can; for example:

     perl -MO=Deparse -le &#39;print &#34;hello&#34;&#39;

will load the O module, giving it the &#34;Deparse&#34; argument, which will 
instruct it to load the B::Deparse module. The generic form is:

     perl -MModule=arg1,arg2,arg3

Check perlrun&#40;1&#41; for the details. So no need for environment variable, 
although I could also recognize one.


Sébastien Aperghis-Tramoni
  -- - --- -- - -- - --- -- - --- -- - --[ <span class="clickylink"><a target="new" rel="nofollow" href="http://maddingue.org">http://maddingue.org</a></span> ]
Close the world, txEn eht nepO
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;22&nbsp;05:20:07&nbsp;2005</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Another option, to handle a die with data structure in eval, is to print
the trace directly to STDOUT or STDERR, and leave the sructure untouched.

This will even increase the amount of output compared against what there
is now, because you have no warranty that the modified $@ ever is
printed &#40;or warned&#41;.

That is if you want that as default, as I would still say that an object
in $@ clearly means, the code was ecpected to die, and handle that.

More complexwould be, to keep quiet in the case above, but to remember,
ther callstack in a variable. If you have a pragramm like

eval { .....; die $exception_object; ...};
if &#40;$@-&gt;isa&#40;&#39;xxx&#39;&#41; {} # catch expected stuff
else {die $@}

you could detect, that thi object was died earlier, and append the info.
same for a: warn $@
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;03&nbsp;13:53:34&nbsp;2005</span>
    <span class="description">SAPER [...] cpan.org -  Fixed in 0.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;03&nbsp;13:53:34&nbsp;2005</span>
    <span class="description">SAPER [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
