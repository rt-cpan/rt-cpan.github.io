<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #60172 for Test-Harness: Re: File protection on create</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #60172 for Test-Harness: Re: File protection on create</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Harness/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Harness/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Harness">Test-Harness CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">60172</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">deleted</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Harness/Active/">Test-Harness</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
craigberry [...] mac.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31430-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-31431-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;07&nbsp;17:40:29&nbsp;2010</span>
    <span class="description">craigberry [...] mac.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> Mark Berryman &lt;mark [...] theberrymans.com&gt;, vmsperl [...] perl.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: File protection on create</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 07 Aug 2010 16:39:51 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Craig A. Berry&#34; &lt;craigberry [...] mac.com&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Craig A. Berry&#34; &lt;craigberry [...] mac.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
On Jul 16, 2010, at 6:43 PM, Craig A. Berry wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;
&gt; On Jul 10, 2010, at 2:05 PM, Mark Berryman wrote:
&gt;
<div class="message-stanza open">&gt;&gt; Is the following expected behavior?
&gt;&gt;
&gt;&gt; With normal default protections set:
&gt;&gt;
&gt;&gt; $ say := write sys$output
&gt;&gt; $ say f$env&#40;&#34;protection&#34;&#41;
&gt;&gt; SYSTEM=RWED, OWNER=RWED, GROUP=RE, WORLD
&gt;&gt; $ perl -e &#34;open&#40;F,&#39;&gt;1.1&#39;&#41;; print F 1; close F;&#34;
&gt;&gt; $ dir/sec 1.1
&gt;&gt;
&gt;&gt; Directory USERS:[BERRYMAN]
&gt;&gt;
&gt;&gt; 1.1;1                [BERRYMAN]                       &#40;RWD,RWD,R,&#41;
&gt;&gt;
&gt;&gt; However, change the owner default to read-only and:
&gt;&gt;
&gt;&gt; $ set prot=ow:re/def
&gt;&gt; $ say f$env&#40;&#34;protection&#34;&#41;
&gt;&gt; SYSTEM=RWED, OWNER=RE, GROUP=RE, WORLD
&gt;&gt; $ perl -e &#34;open&#40;F,&#39;&gt;1.1&#39;&#41;; print F 1; close F;&#34;
&gt;&gt; $ dir/sec 1.1
&gt;&gt;
&gt;&gt; Directory USERS:[BERRYMAN]
&gt;&gt;
&gt;&gt; 1.1;1                [BERRYMAN]                       &#40;R,R,R,&#41;
&gt;&gt;
&gt;&gt; Why is the file being created with system only having Read access  
&gt;&gt; when the owner default is set to read?
&gt;&gt;
</div>&gt;
&gt; Good question.  And the other weird thing is it gives you only read  
&gt; protection when you asked for execute as well.  I have a feeling  
&gt; that it&#39;s line 2601 of perlio.c, but I need to read up and remind  
&gt; myself how Unix protection masks interact with VMS default  
&gt; protections.  The current perlio.c is at:
&gt;
&gt; &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://perl5.git.perl.org/perl.git/blob/HEAD:/perlio.c">http://perl5.git.perl.org/perl.git/blob/HEAD:/perlio.c</a></span>&gt;
&gt;
&gt; and the lines I&#39;m suspecting look like:
&gt;
&gt; 2600             imode = PerlIOUnix_oflags&#40;mode&#41;;
&gt; 2601             perm = 0666;
&gt;
&gt; Should that be 0777 or something in order to assume VMS defaults?
</div>

I did a bit more digging, and yes, I think the 0666 permissions on the  
open&#40;&#41; call are where things go wrong.  The CRTL docs on umask at &lt;<span class="clickylink"><a target="new" rel="nofollow" href="http://h71000.www7.hp.com/doc/732final/5763/5763pro_060.html#umask_routine">http://h71000.www7.hp.com/doc/732final/5763/5763pro_060.html#umask_routine</a></span> 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"> &gt; state clearly that you should use 0777 without ever calling umask  
</div>if you want to inherit default VMS permissions, including ACLs and  
inherited permissions from previous versions of the file.

The most obvious damage apparent from using 0666 is that it turns off  
execute permission even if it&#39;s turned on in your default  
permissions.  I suspect this is intentional and is considered a  
security feature in a Unix environment where the execute bit is more  
than just a permission bit.

Testing shows that even with 0666 we still inherit permissions from a  
previous version of the file.  So that&#39;s one thing that&#39;s not broken.   
But other important things are broken by using 0666:

1.&#41; The execute bit is lost regardless of whether it&#39;s in the default  
permissions.

2.&#41; Delete permission &#40;which doesn&#39;t exist in the Unix permission  
mask&#41; is copied from write permission, so granting write permission  
also grants delete even if it&#39;s not in the default permission mask.

3.&#41; System permissions &#40;which don&#39;t exist in the Unix permission mask&#41;  
are copied from owner permissions, so any distinction between system  
and owner is lost.

4.&#41; ACLs are not inherited.  For example, setting a default_protection  
ACE on a directory such that all world access is disallowed will be  
ignored; world will have the intersection of RWD &#40;the final 6 in 0666&#41;  
and whatever the default permissions are regardless of what the ACL  
says.

Luckily, I think the fix will be easy:

$ gdiff -pu perlio.c;-0 perlio.c
--- perlio.c;-0 2010-05-21 14:34:10 -0500
+++ perlio.c    2010-08-07 16:09:12 -0500
@@ -2598,7 +2598,11 @@ PerlIOUnix_open&#40;pTHX_ PerlIO_funcs *self
             mode++;
         else {
             imode = PerlIOUnix_oflags&#40;mode&#41;;
+#ifdef VMS
+           perm = 0777; /* preserve RMS defaults, ACL inheritance,  
etc. */
+#else
             perm = 0666;
+#endif
         }
         if &#40;imode != -1&#41; {
             const char *path = SvPV_nolen_const&#40;*args&#41;;
[end]

I&#39;m going to test this now.  Anyone else who can, please do the same,  
and please point out any downside you can think of to  switching us so  
we always create files with 0777.


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">________________________________________
Craig A. Berry
mailto:craigberry@mac.com

&#34;... getting out of a sonnet is much more
  difficult than getting in.&#34;
                  Brad Leithauser
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;08&nbsp;01:05:12&nbsp;2010</span>
    <span class="description">ANDK [...] cpan.org -  Ticket deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
