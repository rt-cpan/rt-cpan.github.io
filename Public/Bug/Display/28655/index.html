<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #28655 for DBD-DB2: memory corruption in dbd_preparse</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #28655 for DBD-DB2: memory corruption in dbd_preparse</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-DB2">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-DB2">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-DB2">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-DB2">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-DB2">DBD-DB2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">28655</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-DB2">DBD-DB2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">opendev [...] us.ibm.com
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jrockway [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
aff [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10084-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
1.61</li>
<li>
1.0</li>
<li>
1.1</li>
</ul>
    </td>
  </tr>
  <tr id="CF-10085-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




bug.28655.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/575700/290781/bug.28655.pl">
Tue Mar 10 09:05:58 2009 (384b) by aff [...] cpan.org
</a>
</font></li>
</ul>


DBD-DB2-1.0-fix28655.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/351796/158229/DBD-DB2-1.0-fix28655.patch">
Wed Aug 08 02:49:20 2007 (2.4k) by jrockway [...] cpan.org
</a>
</font></li>
</ul>


dbdimp.c<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/621338/316050/dbdimp.c">
Fri Jun 19 07:27:10 2009 (93.6k) by opendev [...] us.ibm.com
</a>
</font></li>
</ul>


file<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/350876/157760/file">
Fri Aug 03 16:57:44 2007 (2.2k) by jrockway [...] cpan.org
</a>
</font></li>
</ul>


p23723t-638693872.cli<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/575700/290778/p23723t-638693872.cli">
Tue Mar 10 09:05:58 2009 (67.9k) by aff [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=28655">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-350876" href="/Public/Bug/Display.html?id=28655#txn-350876">#</a>      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;03&nbsp;16:57:44&nbsp;2007</span>
    <span class="description">jrockway [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> memory corruption in dbd_preparse</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/350876/157757/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/157757">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 441b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi IBM,

dbd_preparse doesn&#39;t allocate enough memory to account for expansion of
? into :p1234.  The attached patch fixes the issue &#40;although you can
just change the multiplier from 4 to 7 or so if you want to punt on the
issue.  I doubt anyone has more than 1,000,000 bindvars in their query :&#41;

The patch is against 1.0 since 1.1 won&#39;t compile on my machine.  A patch
for that will follow shortly.

-- 
Jonathan Rockway &lt;jrockway@cpan.org&gt;
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> file</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/350876/157760/file">Download file</a><br />
<span class="downloadcontenttype">application/octet-stream 2.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351796" href="/Public/Bug/Display.html?id=28655#txn-351796">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;08&nbsp;02:49:19&nbsp;2007</span>
    <span class="description">jrockway [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/351796/158226/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/158226">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 118b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Turns out that my patch had an off-by-one error :&#41;  This version fixes that.

-- 
Jonathan Rockway &lt;jrockway@cpan.org&gt;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/351796/158229/DBD-DB2-1.0-fix28655.patch">Download DBD-DB2-1.0-fix28655.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Common subdirectories: DBD-DB2-1.0/Constants and DBD-DB2-1.0-fix28655/Constants
diff -u DBD-DB2-1.0/dbdimp.c DBD-DB2-1.0-fix28655/dbdimp.c
--- DBD-DB2-1.0/dbdimp.c	2006-11-09 12:13:42.000000000 -0600
+++ DBD-DB2-1.0-fix28655/dbdimp.c	2007-08-08 00:44:52.000000000 -0500
@@ -1396,6 +1396,56 @@
     return TRUE;
 }
 
+int _bytes_required&#40;int statement_length, int placeholders&#41;
+{
+  int bytes = statement_length;
+
+  /* each placeholder requires at least two additional bytes:
+     ? -&gt; :p1
+  */
+  bytes += 2 * placeholders;
+  
+  /* calculate number of bytes needed to represent all numbers
+     from 1 to 10**&#40;digits-1&#41;
+     the pattern here is:
+     1 digit : 9
+     2 digits: 9 * 21
+     3 digits: 9 * 321
+     4 digits: 9 * 4321
+     etc.
+     
+     we need this because ? -&gt; :p1, ? -&gt; :p2, ..., ? -&gt; :p100000
+  */
+  
+  /* get number of digits */
+  int digits = 0;
+  double d = &#40;double&#41; placeholders;
+  while&#40;d &gt;= 1&#41;
+    {
+      d /= 10.0;
+      digits++;
+    }
+  
+  /* calculate the corresponding 54321 &#40;etc.&#41; for these digits */
+  int digit_bytes = 0;
+  int i;
+  int pos = 0;
+  for&#40;i = digits-1; i &gt; 0; i--&#41;
+    {
+      if &#40;pos == 0&#41; pos = 1;
+      pos *= 10; /* also calculate 10**&#40;digits-1&#41; */
+      digit_bytes *= 10;
+      digit_bytes += i;
+    }
+  
+  /* add space for 1 -&gt; 10**&#40;d-1&#41; */
+  bytes += 9 * digit_bytes;
+  
+  /* add the rest from 10**&#40;d-1&#41; to #placeholders */
+  bytes += digits * &#40;placeholders - pos&#41;;
+  
+  return bytes;
+}
 
 static void dbd_preparse&#40; imp_sth_t *imp_sth,
                           char *statement &#41;
@@ -1406,11 +1456,11 @@
     SV *phs_sv;
     int idx=0, style=0, laststyle=0;
 
-    /* allocate room for copy of statement with spare capacity    */
-    /* for editing &#39;:1&#39; into &#39;:p1&#39; so we can use obndrv.    */
-    imp_sth-&gt;statement = &#40;SQLCHAR *&#41;safemalloc&#40;strlen&#40;statement&#41; +
-                            &#40;DBIc_NUM_PARAMS&#40;imp_sth&#41;*4&#41;&#41;;
-
+    /* allocate &#34;bytes&#34; room for copy of statement with spare capacity  */
+    /* for expanding ? to :p1, ..., p1000, ... and :1 to :p1 &#40;etc.&#41; */
+    int bytes = _bytes_required&#40;strlen&#40;statement&#41;, DBIc_NUM_PARAMS&#40;imp_sth&#41;&#41;;
+    imp_sth-&gt;statement = &#40;SQLCHAR *&#41; safemalloc&#40;bytes&#41;;
+    
     /* initialise phs ready to be cloned per placeholder    */
     memset&#40;&#38;phs_tpl, &#39;\0&#39;,sizeof&#40;phs_tpl&#41;&#41;;
     phs_tpl.sv = NULL;                                           
Common subdirectories: DBD-DB2-1.0/lib and DBD-DB2-1.0-fix28655/lib
Common subdirectories: DBD-DB2-1.0/t and DBD-DB2-1.0-fix28655/t
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-351798" href="/Public/Bug/Display.html?id=28655#txn-351798">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;08&nbsp;02:49:23&nbsp;2007</span>
    <span class="description">jrockway [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-574437" href="/Public/Bug/Display.html?id=28655#txn-574437">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;07&nbsp;11:16:11&nbsp;2009</span>
    <span class="description">opendev [...] us.ibm.com -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-574458" href="/Public/Bug/Display.html?id=28655#txn-574458">#</a>      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;07&nbsp;11:43:44&nbsp;2009</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/574458/290082/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/290082">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 400b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi

We have recently taken over the DBD:DB2 driver. However, due to legal
issues we cannot look at the patch since we do not have a CLA in place
to accept the patch. However, I would look into the problem and try to
solve the issue. If you have a repro of the problem, that would be helpful.

-- 
Thanks
Tarun Pasrija
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575569" href="/Public/Bug/Display.html?id=28655#txn-575569">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;01:29:05&nbsp;2009</span>
    <span class="description">jon [...] jrock.us -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> jrockway [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #28655] memory corruption in dbd_preparse</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 10 Mar 2009 00:28:34 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-DB2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonathan Rockway &lt;jon [...] jrock.us&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/575569/290704/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/290704">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">* On Sat, Mar 07 2009, IBM OpenDev via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=28655">https://rt.cpan.org/Ticket/Display.html?id=28655</a></span> &gt;
&gt;
&gt; Hi
&gt;
&gt; We have recently taken over the DBD:DB2 driver. However, due to legal
&gt; issues we cannot look at the patch since we do not have a CLA in place
&gt; to accept the patch. However, I would look into the problem and try to
&gt; solve the issue. If you have a repro of the problem, that would be helpful.
</div>
I don&#39;t have a simple script to reproduce the problem, but I can explain
it for you.  &#40;It&#39;s been a year or so since I&#39;ve used DB2, so my memory
might be incorrect.  But this is the basic idea.&#41;

Basically, when expanding placeholders, DBD::DB2 converts &#34;?&#34; to &#34;:1&#34;,
&#34;:2&#34;, and so on.  It allocates one extra byte of memory for each
question mark before doing the replacing.  This is fine when you only
have nine placeholders, but as you venture into the range of &#34;:10&#34;,
&#34;:100&#34;, and &#34;:1000&#34;, there isn&#39;t enough memory allocated to store all
the data.  I noticed this causing segmentation faults in queries that
had around 2000 placeholders.  The fix is to allocate the correct amount
of memory, 1 extra byte for 1-9, 2 extra bytes for 10-99, 3 extra bytes
for 100-999, and so on.

Regards,
Jonathan Rockway

--
print just =&gt; another =&gt; perl =&gt; hacker =&gt; if $,=$&#34;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575616" href="/Public/Bug/Display.html?id=28655#txn-575616">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;04:45:16&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Cc AFF added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575700" href="/Public/Bug/Display.html?id=28655#txn-575700">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:05:57&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/575700/290775/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/290775">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Mar 07 11:43:44 2009, IBMTORDB2 wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;  If you have a repro of the problem, that would be helpful.
</div>
ENV: DBD::DB2 version 1.61, perl v5.10.0 built for x86_64-linux, DB2
v9.5.0.0: 

The problem is reproducible using the attached perl script, which 
segfaults on my system when the number of bind variables is above 1000:

$ perl -swl bug.28655.pl -N=1 -P=1
select foo from bar where id&gt;?
$ perl -swl bug.28655.pl -N=2 -P=1
select foo from bar where id&gt;? and id&gt;?
$ perl -swl bug.28655.pl -N=3 -P=1
select foo from bar where id&gt;? and id&gt;? and id&gt;?
$ perl -swl bug.28655.pl -N=10
$ perl -swl bug.28655.pl -N=100
$ perl -swl bug.28655.pl -N=1000
$ perl -swl bug.28655.pl -N=10000
Segmentation fault
$ 

See also attached cli trace file.  The trace is run for the query that
segfaults only.

For values on N between ~1100 and ~1500 I get the following glibc error:

$ perl -swl bug.28655.pl -N=1200 
*** glibc detected *** perl: double free or corruption &#40;!prev&#41;:
0x00000000103120c0 ***
======= Backtrace: =========
/lib64/libc.so.6[0x33e7e71834]
/lib64/libc.so.6&#40;cfree+0x8c&#41;[0x33e7e74e7c]
/opt/perl/lib/site_perl/5.10.0/x86_64-linux/auto/DBD/DB2/DB2.so&#40;db2_st_destroy+0x7a&#41;[0x2b94979ed3da]
/opt/perl/lib/site_perl/5.10.0/x86_64-linux/auto/DBD/DB2/DB2.so&#40;XS_DBD__DB2__st_DESTROY+0x12e&#41;[0x2b94979e8cae]
/opt/perl/lib/site_perl/5.10.0/x86_64-linux/auto/DBI/DBI.so&#40;XS_DBI_dispatch+0x1b06&#41;[0x2b94973bfd26]


Best regards,
Andreas
-- 
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/575700/290778/p23723t-638693872.cli">Download p23723t-638693872.cli</a><br />
<span class="downloadcontenttype">application/octet-stream 67.9k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/575700/290781/bug.28655.pl">Download bug.28655.pl</a><br />
<span class="downloadcontenttype">text/x-perl 384b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">use strict;
use warnings;
use DBD::DB2;

our $N ||= 1; 
our $P ||= 0;   # print flag

my $DATABASE = &#34;foo&#34;;
my $USERID   = &#34;bar&#34;;
my $PASSWORD = &#34;*********&#34;;
my $dbh = DBI-&gt;connect&#40;&#34;dbi:DB2:$DATABASE&#34;, &#34;$USERID&#34;, &#34;$PASSWORD&#34;, {PrintError =&gt; 0}&#41;;
my $query =  q{select foo from bar where } . join&#40;q{ and }, &#40;&#39;id&gt;?&#39;&#41; x $N&#41;;
print $query if $P;
my $sth = $dbh-&gt;prepare&#40;$query&#41;;

__END__
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575703" href="/Public/Bug/Display.html?id=28655#txn-575703">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:07:26&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Broken in 1.61 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575704" href="/Public/Bug/Display.html?id=28655#txn-575704">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:07:26&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Broken in 1.0 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575705" href="/Public/Bug/Display.html?id=28655#txn-575705">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:07:26&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Broken in 1.1 deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575706" href="/Public/Bug/Display.html?id=28655#txn-575706">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:07:43&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Broken in 1.0 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575707" href="/Public/Bug/Display.html?id=28655#txn-575707">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:07:43&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Broken in 1.1 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-575728" href="/Public/Bug/Display.html?id=28655#txn-575728">#</a>      
    </span>
    <span class="date">Tue&nbsp;Mar&nbsp;10&nbsp;09:37:47&nbsp;2009</span>
    <span class="description">aff [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/575728/290794/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/290794">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 672b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I can confirm that Jonathan&#39;s patch above seems to work for DBD-DB2-1.61
also.  I can no longer get DBD-DB2 to crash even with _very_ large
number N, after applying the patch. 

$ time perl -swl bug.28655.pl -N=100000

real    0m0.580s
user    0m0.265s
sys     0m0.018s
$ time perl -swl bug.28655.pl -N=1000000

real    0m2.254s
user    0m2.201s
sys     0m0.051s
$ time perl -swl bug.28655.pl -N=10000000

real    0m22.169s
user    0m21.759s
sys     0m0.381s
$ time perl -swl bug.28655.pl -N=100000000

real    5m21.801s
user    3m40.420s
sys     0m7.539s

The last sample makes my machine swap like crazy, but it does finish
without crashing.

Best regards,
Andreas
-- 
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-621338" href="/Public/Bug/Display.html?id=28655#txn-621338">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;19&nbsp;07:27:10&nbsp;2009</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> opendev [...] us.ibm.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/621338/316047/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/316047">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attaching the patch I created for the issue. Had been busy with some
work so it took time to look into this one. Would request you to please
test with your scenarios and send in your comments on this. I would thus
include this in the next release. 

Thanks and Regards
Tarun Pasrija

On Tue Mar 10 09:37:47 2009, AFF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can confirm that Jonathan&#39;s patch above seems to work for DBD-DB2-1.61
&gt; also.  I can no longer get DBD-DB2 to crash even with _very_ large
&gt; number N, after applying the patch. 
&gt; 
&gt; $ time perl -swl bug.28655.pl -N=100000
&gt; 
&gt; real    0m0.580s
&gt; user    0m0.265s
&gt; sys     0m0.018s
&gt; $ time perl -swl bug.28655.pl -N=1000000
&gt; 
&gt; real    0m2.254s
&gt; user    0m2.201s
&gt; sys     0m0.051s
&gt; $ time perl -swl bug.28655.pl -N=10000000
&gt; 
&gt; real    0m22.169s
&gt; user    0m21.759s
&gt; sys     0m0.381s
&gt; $ time perl -swl bug.28655.pl -N=100000000
&gt; 
&gt; real    5m21.801s
&gt; user    3m40.420s
&gt; sys     0m7.539s
&gt; 
&gt; The last sample makes my machine swap like crazy, but it does finish
&gt; without crashing.
&gt; 
&gt; Best regards,
&gt; Andreas
</div>

-- 
Thanks
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/621338/316050/dbdimp.c">Download dbdimp.c</a><br />
<span class="downloadcontenttype">text/x-csrc 93.6k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-646350" href="/Public/Bug/Display.html?id=28655#txn-646350">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;11&nbsp;08:13:38&nbsp;2009</span>
    <span class="description">opendev [...] us.ibm.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/646350/330698/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/330698">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 197b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Resolved in version 1.74. Released and update would be available by end
of day tomorrow.

-- 
Thanks
Tarun Pasrija
IBM OpenSource Application Development Team
India Software Labs, Bangalore &#40;India&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-646352" href="/Public/Bug/Display.html?id=28655#txn-646352">#</a>      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;11&nbsp;08:13:40&nbsp;2009</span>
    <span class="description">opendev [...] us.ibm.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.95524</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
