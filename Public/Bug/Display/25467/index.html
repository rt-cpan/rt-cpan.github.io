<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #25467 for SVN-Dump: Cannot process cvs2svn-created dumpfile</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #25467 for SVN-Dump: Cannot process cvs2svn-created dumpfile</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/SVN-Dump/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/SVN-Dump/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/SVN-Dump/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/SVN-Dump/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/SVN-Dump">SVN-Dump CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">25467</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/SVN-Dump/Active/">SVN-Dump</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
jpeacock [...] cpan.org

<br />
RSCHUPP [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-41278-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41279-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.05    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




cvs2svn-example.tgz<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/298750/135344/cvs2svn-example.tgz">
Fri Mar 16 20:05:42 2007 (15.5k) by jpeacock [...] rowman.com
</a>
</font></li>
</ul>


svn-dump-reader-empty-lines.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/500266/247921/svn-dump-reader-empty-lines.patch">
Fri Aug 22 16:32:12 2008 (587b) by kaffeetisch [...] gmx.de
</a>
</font></li>
</ul>


SVN-Dump.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/298302/135090/SVN-Dump.patch">
Thu Mar 15 12:46:14 2007 (1.1k) by jpeacock [...] rowman.com
</a>
</font></li>
</ul>


svn-dump.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/509575/253637/svn-dump.patch">
Thu Sep 18 04:17:54 2008 (2.3k) by RSCHUPP [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;11:12:30&nbsp;2007</span>
    <span class="description">jpeacock [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cannot process cvs2svn-created dumpfile</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While trying to use the supplied svndump_replace_author.pl script on a
CVS repository converted with cvs2svn, I discovered that
SVN::Dump::Reader::read_record is chopping lines that are not empty from
an otherwise legitimate dumpfile.

I have a proposed patch which makes SVN::Dump::Reader a subclass of
IO::File &#40;instead of IO::Handle&#41;, then uses getpos&#40;&#41; and setpos&#40;&#41; to
rewind the filehandle if the &#34;blank&#34; line isn&#39;t actually blank, e.g.

@@ -65,10 +65,18 @@

     # chop empty line after the record
     my $type = $headers-&gt;type&#40;&#41;;
-    &lt;$fh&gt; if $type !~ /\A&#40;?:format|uuid&#41;\z/;
+    if &#40; $type !~ /\A&#40;?:format|uuid&#41;\z/ &#41; {
+       my $pos = $fh-&gt;getpos;
+       my $line = &lt;$fh&gt;;
+       $fh-&gt;setpos&#40;$pos&#41; unless $line =~ /^$/;
+    }

It is a much larger patch than would otherwise be necessary, because it
changes the interface &#40;the {fh} object is no longer a filehandle&#41;, so it
has to update the test files as well.

I think a much better fix would be to make read_record&#40;&#41; leading blank
line agnostic &#40;i.e. an unknown number of blank lines will be consumed at
the start of read_record&#40;&#41;, rather than trying to chop trailing blank
lines.  I can produce a patch to do this instead if you would like.

John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;11:30:02&nbsp;2007</span>
    <span class="description">book [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> BOOK [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 15 11:12:30 2007, JPEACOCK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; While trying to use the supplied svndump_replace_author.pl script on a
&gt; CVS repository converted with cvs2svn, I discovered that
&gt; SVN::Dump::Reader::read_record is chopping lines that are not empty from
&gt; an otherwise legitimate dumpfile.
</div>
Can you send me your dump &#40;or an extract of it that show the problem&#41;?
I&#39;d like to add it to the test suite.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I have a proposed patch which makes SVN::Dump::Reader a subclass of
&gt; IO::File &#40;instead of IO::Handle&#41;, then uses getpos&#40;&#41; and setpos&#40;&#41; to
&gt; rewind the filehandle if the &#34;blank&#34; line isn&#39;t actually blank, e.g.
</div>
I want SVN::Dump to be able to read dumps from STDIN, to allow it to
receive dumps from &#39;svnadmin dump&#39;. Wouldn&#39;t its being a subclass
of IO::File prevent this?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I think a much better fix would be to make read_record&#40;&#41; leading blank
&gt; line agnostic &#40;i.e. an unknown number of blank lines will be consumed at
&gt; the start of read_record&#40;&#41;, rather than trying to chop trailing blank
&gt; lines.  I can produce a patch to do this instead if you would like.
</div>
When I first wrote SVN::Dump, my first test was to be able to produce
dumps that were identical to the one I was reading &#40;see t/25dump.t
for example&#41;. In my opinion, being able to create the &#34;identity&#34;
function would demonstrate I correctly reversed-engineered the dump
format.

Is the number of blank lines really not significant?

Thanks for your report and patch proposal.

-- BooK
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;11:30:03&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;12:28:33&nbsp;2007</span>
    <span class="description">jpeacock [...] rowman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #25467] Cannot process cvs2svn-created dumpfile</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Mar 2007 12:28:03 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-SVN-Dump [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;jpeacock [...] rowman.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Philippe Bruhat via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=25467">http://rt.cpan.org/Ticket/Display.html?id=25467</a></span> &gt;
&gt; 
&gt; On Thu Mar 15 11:12:30 2007, JPEACOCK wrote:
<div class="message-stanza open">&gt;&gt; While trying to use the supplied svndump_replace_author.pl script on a
&gt;&gt; CVS repository converted with cvs2svn, I discovered that
&gt;&gt; SVN::Dump::Reader::read_record is chopping lines that are not empty from
&gt;&gt; an otherwise legitimate dumpfile.
</div>&gt; 
&gt; Can you send me your dump &#40;or an extract of it that show the problem&#41;?
&gt; I&#39;d like to add it to the test suite.
</div>
Let me manufacture one - not that my data is necessarily secure, but I&#39;d 
rather have a very straightforward reconstruction recipe &#40;which makes 
for better tests&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; I have a proposed patch which makes SVN::Dump::Reader a subclass of
&gt;&gt; IO::File &#40;instead of IO::Handle&#41;, then uses getpos&#40;&#41; and setpos&#40;&#41; to
&gt;&gt; rewind the filehandle if the &#34;blank&#34; line isn&#39;t actually blank, e.g.
</div>&gt; 
&gt; I want SVN::Dump to be able to read dumps from STDIN, to allow it to
&gt; receive dumps from &#39;svnadmin dump&#39;. Wouldn&#39;t its being a subclass
&gt; of IO::File prevent this?
</div>
I&#39;m not sure if it is possible to use IO::File to seek on a non-seekable 
handle &#40;like STDIN&#41; outside of using IO::Block &#40;which uses layers to 
cache IO&#41;.  This is the best argument for just ignoring leading blank 
lines at the beginning of read_header_block, etc., rather than trying to 
figure out when you can safely chop.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt; I think a much better fix would be to make read_record&#40;&#41; leading blank
&gt;&gt; line agnostic &#40;i.e. an unknown number of blank lines will be consumed at
&gt;&gt; the start of read_record&#40;&#41;, rather than trying to chop trailing blank
&gt;&gt; lines.  I can produce a patch to do this instead if you would like.
</div>&gt; 
&gt; When I first wrote SVN::Dump, my first test was to be able to produce
&gt; dumps that were identical to the one I was reading &#40;see t/25dump.t
&gt; for example&#41;. In my opinion, being able to create the &#34;identity&#34;
&gt; function would demonstrate I correctly reversed-engineered the dump
&gt; format.
&gt; 
&gt; Is the number of blank lines really not significant?
</div>
Not as far as I can tell &#40;short of pulling up svndmin/load.c&#41;.  It 
appears that the places where your code assumes that there will be *two* 
blank lines may not be required by the underlying dump format.  I have 
to assume that cvs2svn is going to produce 100% compatible dumpfiles 
&#40;and indeed I can load up either with or without the doubled blank lines&#41;.

John

-- 
John Peacock
Director of Information Research and Technology
Rowman &#38; Littlefield Publishing Group
4501 Forbes Boulevard
Suite H
Lanham, MD  20706
301-459-3366 x.5010
fax 301-429-5748
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;15&nbsp;12:46:14&nbsp;2007</span>
    <span class="description">jpeacock [...] rowman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #25467] Cannot process cvs2svn-created dumpfile</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 15 Mar 2007 12:45:45 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-SVN-Dump [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;jpeacock [...] rowman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">John Peacock via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This is the best argument for just ignoring leading blank 
&gt; lines at the beginning of read_header_block, etc., rather than trying to 
&gt; figure out when you can safely chop.
</div>
Attached is a proof of concept patch which correctly reads a cvs2svn 
dumpfile &#40;and let me correctly filter my svn:author names&#41;.  It suffers 
from two immediate problems:

1&#41; It misjudges the end of file test &#40;either by reading off the end of 
the file or by throwing the wrong error when it does&#41;;

2&#41; It fails tests:

Failed Test  Stat Wstat Total Fail  List of Failed
-------------------------------------------------------------------------------
t/23record.t    8  2048    20    8  4 6 8 10 12 14 16 18
t/24reader.t  255 65280    14   28  1-14
t/25dump.t    255 65280    14   28  1-14
t/29fail.t      1   256    20    1  2

mostly due to fallout from #1, AFAICT.

It does show that it should be possible to skip blank lines at the start 
of read_header_block instead of blinding chopping lines after some 
blocks.  I think that saving some state information &#40;so you know when to 
throw an actual EOF error as opposed to just ceasing the read&#41; should 
make this work again.

John

-- 
John Peacock
Director of Information Research and Technology
Rowman &#38; Littlefield Publishing Group
4501 Forbes Boulevard
Suite H
Lanham, MD  20706
301-459-3366 x.5010
fax 301-429-5748
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ru SVN-Dump-0.03/lib/SVN/Dump/Reader.pm SVN-Dump-0.03.blanklines/lib/SVN/Dump/Reader.pm
--- SVN-Dump-0.03/lib/SVN/Dump/Reader.pm        2006-11-20 19:15:21.000000000 -0500
+++ SVN-Dump-0.03.blanklines/lib/SVN/Dump/Reader.pm     2007-03-15 12:32:01.000000000 -0400
@@ -60,16 +60,8 @@
     {
         my $included = $fh-&gt;read_record&#40;&#41;;
         $record-&gt;set_included_record&#40; $included &#41;;
-        &lt;$fh&gt;; # chop the empty line that follows
     }

-    # chop empty line after the record
-    my $type = $headers-&gt;type&#40;&#41;;
-    &lt;$fh&gt; if $type !~ /\A&#40;?:format|uuid&#41;\z/;
-
-    # chop another one after a node with only a prop block
-    &lt;$fh&gt; if $type eq &#39;node&#39; &#38;&#38; $record-&gt;has_prop_only&#40;&#41;;
-
     # uuid and format record only contain headers
     return $record;
 }
@@ -83,7 +75,8 @@
         my $line = &lt;$fh&gt;;
         croak _eof&#40;&#41; if !defined $line;
         chop $line;
-        last if $line eq &#39;&#39;; # stop on empty line
+        next if $line eq &#39;&#39; &#38;&#38; ! keys %$headers; # ignore leading empty line
+        last if $line eq &#39;&#39; &#38;&#38;   keys %$headers; # stop on trailing empty line

         my &#40;$key, $value&#41; = split /: /, $line, 2;
         $headers-&gt;{$key} = $value;

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;16&nbsp;20:05:26&nbsp;2007</span>
    <span class="description">jpeacock [...] rowman.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #25467] Cannot process cvs2svn-created dumpfile</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 16 Mar 2007 14:38:07 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-SVN-Dump [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> John Peacock &lt;jpeacock [...] rowman.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is an example CVS repository &#40;based on the test Subversion file 
dump/full/test123-r0-r10.svn&#41;.  I included the cvs2svn optionfile and 
both the dump it created and the dump I created by using your 
svndump_rename_author.pl script to change my username to studly caps... ;-&#41;

If I use the svndump_identity.pl script, it is obvious that the extra 
line after a copy is not required by the Subversion dumpfile format:

--- cvs2svn-dump        2007-03-16 14:23:44.000000000 -0400
+++ cvs2svn-dump.identity       2007-03-16 14:35:36.000000000 -0400
@@ -283,26 +283,31 @@
  Node-copyfrom-rev: 3
  Node-copyfrom-path: /project/trunk/crunchle.txt

+
  Node-path: project/branches/initial/latin.txt
  Node-action: add
  Node-copyfrom-rev: 3
  Node-copyfrom-path: /project/trunk/latin.txt

+
  Node-path: project/branches/initial/loremipsum.txt
  Node-action: add
  Node-copyfrom-rev: 3
  Node-copyfrom-path: /project/trunk/loremipsum.txt

+

...

HTH

John
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/298750/135344/cvs2svn-example.tgz">Download cvs2svn-example.tgz</a><br />
<span class="downloadcontenttype">application/octet-stream 15.5k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Aug&nbsp;22&nbsp;16:32:10&nbsp;2008</span>
    <span class="description">kaffeetisch [...] gmx.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Mar 15 11:12:30 2007, JPEACOCK wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; While trying to use the supplied svndump_replace_author.pl script on a
&gt; CVS repository converted with cvs2svn, I discovered that
&gt; SVN::Dump::Reader::read_record is chopping lines that are not empty from
&gt; an otherwise legitimate dumpfile.
</div>
I&#39;ve hit the same problem, and wrote my own patch to overcome it, before
finding this ticket.  The attached patch is against 0.04 and doesn&#39;t
seem to cause any test failures.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- lib/SVN/Dump/Reader.pm 
+++ lib/SVN/Dump/Reader.pm 
@@ -62,12 +62,10 @@
         &lt;$fh&gt;; # chop the empty line that follows
     }
 
-    # chop empty line after the record
-    my $type = $headers-&gt;type&#40;&#41;;
-    &lt;$fh&gt; if $type !~ /\A&#40;?:format|uuid&#41;\z/;
-
-    # chop another one after a node with only a prop block
-    &lt;$fh&gt; if $type eq &#39;node&#39; &#38;&#38; $record-&gt;has_prop_only&#40;&#41;;
+    # chop off empty lines
+    my $old_pos = tell $fh;
+    while &#40;&lt;$fh&gt; eq $NL&#41; { $old_pos = tell $fh };
+    seek $fh, $old_pos, 0;
 
     # uuid and format record only contain headers
     return $record;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;18&nbsp;04:17:54&nbsp;2008</span>
    <span class="description">RSCHUPP [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have the same problem as described in the ticket.
The SVN dump in question was produced by svndumpfilter.

Attached my fix for the problem.
The patches proposed so far tackle the problem in the wrong
place, by diddling when to drop trailing empty lines.
Instead, I ignore leading empty lines when looking for headers.
Note that the patch also patches t/23record.t:
now you must actually read the EOF record &#40;i.e. read_record&#40;&#41; 
returns undef&#41; to make sure that the input is fully processed.
Also t/dump/fail/h_blank.svn and t/dump/fail/h_empty.svn
should be deleted: an empty file or a file containing only empty lines
doesn&#39;t throw an exception, it simple produces no records.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -ubr SVN-Dump-0.04.orig/lib/SVN/Dump/Reader.pm SVN-Dump-0.04/lib/SVN/Dump/Reader.pm
--- SVN-Dump-0.04.orig/lib/SVN/Dump/Reader.pm	2008-06-12 16:52:27.000000000 +0200
+++ SVN-Dump-0.04/lib/SVN/Dump/Reader.pm	2008-09-17 17:46:46.870185000 +0200
@@ -27,13 +27,10 @@
 sub read_record {
     my &#40;$fh&#41; = @_;
 
-    # no more records?
-    return if eof&#40;$fh&#41;;
-
     my $record = SVN::Dump::Record-&gt;new&#40;&#41;;
 
     # first get the headers
-    my $headers = $fh-&gt;read_header_block&#40;&#41;;
+    my $headers = $fh-&gt;read_header_block&#40;&#41; or return;
     $record-&gt;set_headers_block&#40; $headers &#41;;
     
     # get the property block
@@ -59,16 +56,8 @@
     {
         my $included = $fh-&gt;read_record&#40;&#41;;
         $record-&gt;set_included_record&#40; $included &#41;;
-        &lt;$fh&gt;; # chop the empty line that follows
     }
 
-    # chop empty line after the record
-    my $type = $headers-&gt;type&#40;&#41;;
-    &lt;$fh&gt; if $type !~ /\A&#40;?:format|uuid&#41;\z/;
-
-    # chop another one after a node with only a prop block
-    &lt;$fh&gt; if $type eq &#39;node&#39; &#38;&#38; $record-&gt;has_prop_only&#40;&#41;;
-
     # uuid and format record only contain headers
     return $record;
 }
@@ -77,15 +66,25 @@
     my &#40;$fh&#41; = @_;
 
     local $/ = $NL;
-    my $headers = SVN::Dump::Headers-&gt;new&#40;&#41;;
+
+    # skip empty lines
+    my $line;
     while&#40;1&#41; {
-        my $line = &lt;$fh&gt;;
-        croak _eof&#40;&#41; if !defined $line;
+        $line = &lt;$fh&gt;;
+        return if !defined $line;
         chop $line;
-        last if $line eq &#39;&#39;; # stop on empty line
+        last unless $line eq &#39;&#39;;
+    }
 
+    my $headers = SVN::Dump::Headers-&gt;new&#40;&#41;;
+    while&#40;1&#41; {
         my &#40;$key, $value&#41; = split /: /, $line, 2;
         $headers-&gt;{$key} = $value;
+
+        $line = &lt;$fh&gt;;
+        croak _eof&#40;&#41; if !defined $line;
+        chop $line;
+        last if $line eq &#39;&#39;; # stop on empty line
     }
 
     croak &#34;Empty line found instead of a header block line $.&#34;
diff -ubr SVN-Dump-0.04.orig/t/23record.t SVN-Dump-0.04/t/23record.t
--- SVN-Dump-0.04.orig/t/23record.t	2008-06-12 16:52:27.000000000 +0200
+++ SVN-Dump-0.04/t/23record.t	2008-09-18 09:15:31.435651000 +0200
@@ -19,6 +19,7 @@
     my $dump = SVN::Dump::Reader-&gt;new&#40;$fh&#41;;
     my $r    = $dump-&gt;read_record&#40;&#41;;
     is_same_string&#40; $r-&gt;as_string&#40;&#41;, $expected, &#34;Read $f record&#34; &#41;;
-    is&#40; tell&#40;$fh&#41;, -s $f, &#34;Read all of $f&#34; &#41;;
+    $r = $dump-&gt;read_record&#40;&#41;;
+    ok&#40; !$r &#38;&#38; tell&#40;$fh&#41; == -s $f, &#34;Read all of $f&#34; &#41;;
 }
 
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;18&nbsp;04:22:43&nbsp;2008</span>
    <span class="description">RSCHUPP [...] cpan.org -  Requestor RSCHUPP added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;19&nbsp;04:51:30&nbsp;2011</span>
    <span class="description">book [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sat&nbsp;Feb&nbsp;19&nbsp;04:51:30&nbsp;2011</span>
    <span class="description">book [...] cpan.org -  Fixed in 0.05 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
