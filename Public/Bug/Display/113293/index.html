<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #113293 for PDF-API2: Corrupted PDF produced by importPageIntoForm</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #113293 for PDF-API2: Corrupted PDF produced by importPageIntoForm</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/PDF-API2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/PDF-API2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/PDF-API2">PDF-API2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">113293</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/PDF-API2/Active/">PDF-API2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
melmothx [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-24958-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
2.026    </td>
  </tr>
  <tr id="CF-24959-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
2.029    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




luatex.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1610731/861788/luatex.pdf">
Wed Mar 23 11:09:38 2016 (26.9k) by melmothx [...] gmail.com
</a>
</font></li>
</ul>


xetex.pdf<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1610731/861787/xetex.pdf">
Wed Mar 23 11:09:38 2016 (26.2k) by melmothx [...] gmail.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Mar&nbsp;23&nbsp;11:09:38&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 23 Mar 2016 16:09:15 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Hi there!

It looks like I&#39;ve hit a bug, but honestly I don&#39;t know where to start
looking.

Attached you can find two &#40;apparently&#41; identical PDFs, one produced by
xetex and one by luatex. When I import the one produced by luatex, the
second page get lost.

Evince just displays an empty page, while mupdf says:

error: stack overflow
warning: Ignoring errors during rendering
mupdf: warning: Errors found on page

Code to reproduce:

#!perl
use strict;
use warnings;
use PDF::API2;

for my $file &#40;qw/xetex luatex/&#41; {
    my $in = PDF::API2-&gt;open&#40;&#34;t/resources/$file.pdf&#34;&#41;;
    my $out = PDF::API2-&gt;new;
    my $page = $out-&gt;page;
    my $gfx = $page-&gt;gfx;
    for my $p &#40;1, 2&#41; {
        if &#40;my $included = $out-&gt;importPageIntoForm&#40;$in, $p&#41;&#41; {
            print &#34;Including $p\n&#34;;
            $gfx-&gt;formimage&#40;$included, 100 * $p, 0&#41;
        }
    }
    $out-&gt;saveas&#40;&#34;t/resources/$file.out.pdf&#34;&#41;;
    $out-&gt;end;
    $in-&gt;end;
}
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1610731/861787/xetex.pdf">Download xetex.pdf</a><br />
<span class="downloadcontenttype">application/pdf 26.2k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1610731/861788/luatex.pdf">Download luatex.pdf</a><br />
<span class="downloadcontenttype">application/pdf 26.9k</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Please let know if I can be of any help here.

Best wishes

-- 
Marco
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;10:47:50&nbsp;2016</span>
    <span class="description">philperry [...] hvc.rr.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #113293]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2016 10:48:00 -0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Phil M Perry &lt;philperry [...] hvc.rr.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Do you happen to know what PDF version is being output by XeTeX and 
LuaTeX? If they&#39;re greater than 1.3 &#40;or maybe 1.4&#41;, they may have 
content that breaks PDF::API2. If you can throw a switch somewhere to 
output PDF 1.3 on these programs, could you see if the problem persists? 
One thing PDF::API2 needs is work to bring it up to PDF 1.7 
compatibility, so it can safely import/load PDFs produced by other programs.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;10:47:50&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Mar&nbsp;24&nbsp;11:12:31&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293]</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 24 Mar 2016 16:12:17 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;philperry@hvc.rr.com via RT&#34; &lt;bug-PDF-API2@rt.cpan.org&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113293">https://rt.cpan.org/Ticket/Display.html?id=113293</a></span> &gt;
&gt;
&gt; Do you happen to know what PDF version is being output by XeTeX and 
&gt; LuaTeX? If they&#39;re greater than 1.3 &#40;or maybe 1.4&#41;, they may have 
&gt; content that breaks PDF::API2. If you can throw a switch somewhere to 
&gt; output PDF 1.3 on these programs, could you see if the problem persists? 
&gt; One thing PDF::API2 needs is work to bring it up to PDF 1.7 
&gt; compatibility, so it can safely import/load PDFs produced by other programs.
</div>
XeTeX and LuaTeX usually give 1.5 output. With 1.4 output, things are
fine. The files I sent are 1.5. The puzzling thing is that 1.5 produced
by XeTeX is fine as well &#40;as you can see from the tests&#41;, so yes,
apparently luatex is including some content &#40;which one is a good
question&#41; the module doesn&#39;t like &#40;but doesn&#39;t throw an exception
either&#41;.

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Mar&nbsp;26&nbsp;10:45:57&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s what I&#39;ve found so far:

Using Perl 5.8.5 &#40;the minimum supported version&#41;, your test script seg faults while trying to create luatex.out.pdf.  It works fine with Perl 5.14.2 &#40;my system Perl&#41;.

Looking through both PDFs using contrib/pdf-debug.pl, they&#39;re both basically identical until we get to the XObject &#40;form image&#41; on page 2.  For luatex.out.pdf, instead of including object 13 &#40;/Contents of page 2&#41;, it&#39;s including object 2 &#40;an /ObjStm&#41;.  That explains why the resulting PDF is broken.

Looking at luatex.pdf, object 13 is the second object in the file, so I&#39;m wondering if the object stream contents are getting saved in the wrong slot and overwriting the page contents.  It could just be coincidence, but it&#39;s where I&#39;ll be looking next.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;09:55:08&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s a brief update on this ticket: I spent a large chunk of yesterday trying to isolate the problem, but haven&#39;t gotten there yet.

Observations:

- The Page content stream in the source PDF is getting replaced by an object stream during an unrelated operation &#40;copying a different object from the source PDF to the target PDF&#41;.

- With the provided luatex.pdf, the problem always happens on the second page to be included &#40;reversing the order from 1, 2 to 2, 1 causes page 1 to be corrupt&#41;.

- importPageIntoForm calls walk_obj &#40;see the $ssk foreach loop&#41; which calls itself recursively.  It calls the realise method on the source object if it&#39;s an indirect object.  On the second page to be included, inside the first time importPageIntoForm calls walk_obj, but not necessarily the outer walk_obj call, this realise call is the one that causes the object stream to get embedded in the wrong place in the source PDF.

- The realise method just calls read_obj from .../Basic/PDF/FIle.pm

- read_obj calls read_objnum and merge.  The merge function doesn&#39;t appear to be the problem, and it would make sense for read_objnum to have the bug since it&#39;s dealing with object streams.

That&#39;s as far as I got before running out of time yesterday.  It&#39;s possible I&#39;ll be able to work on it some more next week, but after that I&#39;ll be away until July.  There will be another PDF::API2 release as soon as this issue gets fixed, so if anyone reading this wants to take the above and run with it, I&#39;ll happily give you full credit for a patch fixing the bug.  :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;02&nbsp;11:33:06&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293] Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 02 Jun 2016 17:32:54 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That&#39;s as far as I got before running out of time yesterday. It&#39;s
&gt; possible I&#39;ll be able to work on it some more next week, but after
&gt; that I&#39;ll be away until July. There will be another PDF::API2 release
&gt; as soon as this issue gets fixed, so if anyone reading this wants to
&gt; take the above and run with it, I&#39;ll happily give you full credit for
&gt; a patch fixing the bug. :-&#41;
</div>
Hello Steve,

I&#39;ll try to give a shoot at it as well when I&#39;ll grab some brain-fresh
time &#40;probably over the weekend&#41;.

Best wishes

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;03&nbsp;15:08:04&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293] Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 03 Jun 2016 21:07:53 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
Some notes, hoping it will ring any bell:

In the $ssk loop, it looks like the contents of the page changes, even
if it&#39;s not directly passed to the function:

                print &#34;Including resource &lt;$s_pdf $k $sk $ssk&gt; $xo-&gt;resource&#40;$sk,$ssk,walk_obj&#40;$self-&gt;{apiimportcache}-&gt;{$s_pdf},$s_pdf-&gt;{pdf},$self-&gt;{pdf},$s_page-&gt;{$k}-&gt;{$sk}-&gt;{$ssk}&#41;\n&#34;;
                {
                    my  &#40;$content&#41; = $s_page-&gt;{Contents}-&gt;elementsof;
                    print &#34;Page content &#40;before embedding $ssk $s_page-&gt;{$k}-&gt;{$sk}-&gt;{$ssk}&#41; is &#34; . ref&#40;$content&#41; . &#34;\n&#34;;
                }

                my $walked = walk_obj&#40;$self-&gt;{apiimportcache}-&gt;{$s_pdf},
                                      $s_pdf-&gt;{pdf},
                                      $self-&gt;{pdf},
                                      $s_page-&gt;{$k}-&gt;{$sk}-&gt;{$ssk}&#41;;
                {
                    my  &#40;$content&#41; = $s_page-&gt;{Contents}-&gt;elementsof;
                    print &#34;Page content &#40;embedding $ssk&#41; is &#34; . ref&#40;$content&#41; . &#34;\n&#34;;
                }
                $xo-&gt;resource&#40;$sk,$ssk,$walked&#41;;


And yields:

Page content &#40;before embedding Im1 PDF::API2::Basic::PDF::Objind=HASH&#40;0x192e8b0&#41;&#41; is PDF::API2::Content
Realising objind 10
Realising objind 16
Realising objind 15
Page content &#40;embedding Im1&#41; is PDF::API2::Content

Page content &#40;before embedding F25 PDF::API2::Basic::PDF::Objind=HASH&#40;0x192df50&#41;&#41; is PDF::API2::Content
Realising objind 8
Realising objind 17
Realising objind 20
Realising objind 18
Realising objind 19
Realising objind 21
Page content &#40;embedding F25&#41; is PDF::API2::Basic::PDF::Dict

Swapping the pages:

Page content &#40;before embedding F25 PDF::API2::Basic::PDF::Objind=HASH&#40;0x36407e8&#41;&#41; is PDF::API2::Content
Realising objind 8
Realising objind 21
Realising objind 17
Realising objind 20
Realising objind 19
Realising objind 18
Page content &#40;embedding F25&#41; is PDF::API2::Content

Page content &#40;before embedding Im1 PDF::API2::Basic::PDF::Objind=HASH&#40;0x3601a80&#41;&#41; is PDF::API2::Content
Realising objind 10
Realising objind 15
Realising objind 16
Page content &#40;embedding Im1&#41; is PDF::API2::Basic::PDF::Dict


With the xetex file, the page contents is always a Content object. That
Dict is the object stream which causes the corruption.

So much for today

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;07&nbsp;13:31:25&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293] Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Jun 2016 19:31:08 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;Steve Simms via RT&#34; &lt;bug-PDF-API2@rt.cpan.org&gt; writes:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=113293">https://rt.cpan.org/Ticket/Display.html?id=113293</a></span> &gt;
&gt;
&gt; Here&#39;s a brief update on this ticket: I spent a large chunk of
&gt; yesterday trying to isolate the problem, but haven&#39;t gotten there yet.
&gt;
&gt; Observations:
&gt;
&gt; - The Page content stream in the source PDF is getting replaced by an
&gt; object stream during an unrelated operation &#40;copying a different
&gt; object from the source PDF to the target PDF&#41;.
&gt;
&gt; - With the provided luatex.pdf, the problem always happens on the
&gt; second page to be included &#40;reversing the order from 1, 2 to 2, 1
&gt; causes page 1 to be corrupt&#41;.
&gt;
&gt; - importPageIntoForm calls walk_obj &#40;see the $ssk foreach loop&#41; which
&gt; calls itself recursively. It calls the realise method on the source
&gt; object if it&#39;s an indirect object. On the second page to be included,
&gt; inside the first time importPageIntoForm calls walk_obj, but not
&gt; necessarily the outer walk_obj call, this realise call is the one that
&gt; causes the object stream to get embedded in the wrong place in the
&gt; source PDF.
&gt;
&gt; - The realise method just calls read_obj from .../Basic/PDF/FIle.pm
&gt;
&gt; - read_obj calls read_objnum and merge. The merge function doesn&#39;t
&gt; appear to be the problem, and it would make sense for read_objnum to
&gt; have the bug since it&#39;s dealing with object streams.
&gt;
&gt; That&#39;s as far as I got before running out of time yesterday. It&#39;s
&gt; possible I&#39;ll be able to work on it some more next week, but after
&gt; that I&#39;ll be away until July. There will be another PDF::API2 release
&gt; as soon as this issue gets fixed, so if anyone reading this wants to
&gt; take the above and run with it, I&#39;ll happily give you full credit for
&gt; a patch fixing the bug. :-&#41;
</div>
Ok, I think at least I found where the problem is:

diff --git a/lib/PDF/API2/Basic/PDF/File.pm b/lib/PDF/API2/Basic/PDF/File.pm
index 0544aca..bd9fca7 100644
--- a/lib/PDF/API2/Basic/PDF/File.pm
+++ b/lib/PDF/API2/Basic/PDF/File.pm
@@ -545,14 +545,9 @@ sub readval {
         $value = $2;
         $str =~ s/^&#40;[0-9]+&#41;$ws_char+&#40;[0-9]+&#41;$ws_char+obj//s;
         &#40;$obj, $str&#41; = $self-&gt;readval&#40;$str, %opts, &#39;objnum&#39; =&gt; $num, &#39;objgen&#39; =&gt; $value&#41;;
-        if &#40;$result = $self-&gt;test_obj&#40;$num, $value&#41;&#41; {
-            $result-&gt;merge&#40;$obj&#41;;
-        }
-        else {
             $result = $obj;
             $self-&gt;add_obj&#40;$result, $num, $value&#41;;
             $result-&gt;{&#39; realised&#39;} = 1;
-        }
         $str = update&#40;$fh, $str&#41; if $update;       # thanks to kundrat@kundrat.sk
         $str =~ s/^endobj//;
     }


This patch appear to fix the issue in the testfile, but it&#39;s totally
unclear if it has side effects or if it&#39;s doing the right thing.

Let&#39;s consider this a starting point.

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;07&nbsp;13:41:59&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293] Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Jun 2016 19:41:44 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
And some notes about the readval method, which is called recursively.

1. From read_objnum we pass these options:

 &#40;$object&#41; = $self-&gt;readval&#40;$stream, %opts, objnum =&gt; $num, objgen =&gt; $gen, update =&gt; 0&#41;;

However, in the readval code, I can&#39;t find an usage for objnum and
objgen, so it seems to me they are ignored, but could be mistaken.

I suspect those values not obeyed is what lead to the caching problem.


2. From read_objnum

  my $stream = &#34;$num 0 obj&#34; . substr&#40;$objects, $start, $length&#41;;
  &#40;$object&#41; = $self-&gt;readval&#40;$stream, %opts, objnum =&gt; $num, objgen =&gt; $gen, update =&gt; 0&#41;;

Unclear if that &#34;$num 0 obj&#34; should be &#34;$num $gen obj&#34; instead. I don&#39;t
have a PDF with some object revisions, so dunno, just submitted to the
attentions.

3. In readval

  my $update = defined&#40;$opts{update}&#41; ? $opts{update} : 1;
  $str = update&#40;$fh, $str&#41;;

While elsewere we have  $str = update&#40;$fh, $str&#41; if $update;
So at the begin of the method, update is called even if update =&gt; 0 is
passed.

Point 2. and 3. are unrelated to the issue in the ticket, and are
probably worth a comment in the code or in the doc to clarify it for the
next souls wondering in this area of the code.

I&#39;ll continue digging on the issue over the next days, assuming I&#39;ll
have some spare time to throw at this.

Cheers

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;08&nbsp;11:16:06&nbsp;2016</span>
    <span class="description">melmothx [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #113293] Corrupted PDF produced by importPageIntoForm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 08 Jun 2016 17:15:53 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-PDF-API2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marco Pessotto &lt;melmothx [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
It looks like the patch is making the pdf.t going into very-very deep
recursion, so no, definitively it&#39;s not doing the right thing. Kind of
stuck here.

-- 
Marco
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:05:54&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Found it.  The problem actually got introduced when the cross-reference stream was originally read, due to this gotcha in readxrtr:

for $xmin &#40;$start...$last&#41; {
    # ...
}
# ...
$self-&gt;{&#39; maxobj&#39;} = $xmin;

The problem is that the &#34;$xmin&#34; in the for loop is an implicit local variable, so the $xmin outside the loop was still the default &#40;1&#41; instead of $last &#40;27 in your file&#41;.  When new_obj gets called later on, it increments maxobj to 2, then clobbers what was in that spot, which happened to be the object stream in your file.  Everything we saw after that followed from that mistake.

The repo has the fix, and it&#39;ll be in the next release.  And I&#39;ll be very happy to stop banging my head on this problem.  :-&#41;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:06:05&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:19:59&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 1. From read_objnum we pass these options:
&gt; 
&gt; &#40;$object&#41; = $self-&gt;readval&#40;$stream, %opts, objnum =&gt; $num, objgen =&gt;
&gt; $gen, update =&gt; 0&#41;;
&gt; 
&gt; However, in the readval code, I can&#39;t find an usage for objnum and
&gt; objgen, so it seems to me they are ignored, but could be mistaken.
&gt; 
&gt; I suspect those values not obeyed is what lead to the caching problem.
</div>
They do indeed seem to be ignored.  This ended up being unrelated, though.

There doesn&#39;t seem to be anywhere else in the codebase that uses them either, so I&#39;m removing them to avoid confusion later.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 2. From read_objnum
&gt; 
&gt; my $stream = &#34;$num 0 obj&#34; . substr&#40;$objects, $start, $length&#41;;
&gt; &#40;$object&#41; = $self-&gt;readval&#40;$stream, %opts, objnum =&gt; $num, objgen =&gt;
&gt; $gen, update =&gt; 0&#41;;
&gt; 
&gt; Unclear if that &#34;$num 0 obj&#34; should be &#34;$num $gen obj&#34; instead.
</div>
The generation number in object streams is always going to be zero, so even if objgen weren&#39;t being ignored, $gen would always be zero.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 3. In readval
&gt; 
&gt; my $update = defined&#40;$opts{update}&#41; ? $opts{update} : 1;
&gt; $str = update&#40;$fh, $str&#41;;
&gt; 
&gt; While elsewere we have  $str = update&#40;$fh, $str&#41; if $update;
&gt; So at the begin of the method, update is called even if update =&gt; 0 is
&gt; passed.
</div>
Hmm, good catch.  It didn&#39;t end up mattering for this bug because we&#39;re passing the whole stream, so it was just adding garbage to the end of it, which is probably going to be the case any time we set $update to 0 anyway, but I&#39;ve added the &#34;if $update&#34; to that line as well.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;06&nbsp;23:23:58&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;resolved&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;10&nbsp;09:23:41&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;10&nbsp;09:23:42&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Broken in 2.026 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;10&nbsp;09:23:42&nbsp;2016</span>
    <span class="description">steve [...] deefs.net -  Fixed in 2.029 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
