<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #39644 for local-lib: PATCH: add &#34;--self-contained&#34; option for generating self-contained dependency chains</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #39644 for local-lib: PATCH: add &#34;--self-contained&#34; option for generating self-contained dependency chains</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=local-lib">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=local-lib">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=local-lib">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=local-lib">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/local-lib">local-lib CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">39644</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=local-lib">local-lib</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">apeiron [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
MARKSTOS [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-45322-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-45323-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.002000    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




local_lib.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/540335/271422/local_lib.patch">
Thu Dec 04 20:43:25 2008 (2.4k) by MARKSTOS [...] cpan.org
</a>
</font></li>
</ul>


self-contained-docs.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/732945/378672/self-contained-docs.diff">
Fri Feb 12 13:30:43 2010 (1.2k) by MARKSTOS [...] cpan.org
</a>
</font></li>
</ul>


self_contained_local_lib.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/513314/255676/self_contained_local_lib.patch">
Sat Sep 27 17:11:41 2008 (1.7k) by MARKSTOS [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=39644">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-513314" href="/Public/Bug/Display.html?id=39644#txn-513314">#</a>      
    </span>
    <span class="date">Sat&nbsp;Sep&nbsp;27&nbsp;17:11:41&nbsp;2008</span>
    <span class="description">MARKSTOS [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH: add &#34;--self-contained&#34; option for generating
 self-contained dependency chains</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/513314/255673/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/255673">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 585b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matt,

Thanks for &#39;local::lib&#39;. I&#39;ve found it rather useful. 

I wanted to use it to generate a self-contained folder of a module with
all of it&#39;s dependencies. 

&#39;local::lib&#39; is great for helping with this, but because it keeps the
global &#34;INC&#34; paths, it wasn&#39;t quit working for me-- dependencies already
installed locally weren&#39;t added to my local directory. 

To solve this I created the attached patch to add a &#34;--self-contained&#34;
option. When this flag is used, only the path to core modules and the
&#39;local&#39; directories are preserved. 

It worked well for me in testing. 

    Mark
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> self_contained_local_lib.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/513314/255676/self_contained_local_lib.patch">Download self_contained_local_lib.patch</a><br />
<span class="downloadcontenttype">text/x-diff 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/local/share/perl/5.8.8/local/lib.pm	2008-08-06 06:52:36.000000000 -0400
+++ local/lib.pm	2008-09-27 16:38:58.000000000 -0400
@@ -14,9 +14,24 @@
 our $VERSION = &#39;1.002000&#39;; # 1.2.0
 
 sub import {
-  my &#40;$class, $path&#41; = @_;
+  my &#40;$class, @args&#41; = @_;
+
+  # The path is required, but last in the list, so we pop, not shift here. 
+  my $path = pop @args;
   $path = $class-&gt;resolve_path&#40;$path&#41;;
   $class-&gt;setup_local_lib_for&#40;$path&#41;;
+
+  # Handle the &#39;--self-contained&#39; option
+  my $flag = shift @args;  
+  no warnings &#39;uninitialized&#39;; # the flag is optional 
+  if &#40;$flag eq &#39;--self-contained&#39;&#41; {
+    # The only directories that remain are those that we just defined and those where core modules are stored. 
+    @INC = &#40;$Config::Config{privlibexp}, $Config::Config{archlibexp}, split &#39;:&#39;, $ENV{PERL5LIB}&#41;;
+  }
+  elsif &#40;defined $flag&#41; {
+      die &#34;unrecognized import argument: $flag&#34;;
+  }
+
 }
 
 sub pipeline;
@@ -306,6 +321,13 @@
 
 From the shell -
 
+  # Install LWP and it&#39;s missing dependencies to the &#39;my_lwp&#39; directory
+  perl -MCPAN -Mlocal::lib=my_lwp  -e &#39;install LWP&#39;
+
+  # Install LWP and *all non-core* dependencies to the &#39;my_lwp&#39; directory 
+  perl -MCPAN -Mlocal::lib=--self-contained,my_lwp  -e &#39;install LWP&#39;
+
+  # Just print out useful shell commands
   $ perl -Mlocal::lib
   export MODULEBUILDRC=/home/username/perl/.modulebuildrc
   export PERL_MM_OPT=&#39;INSTALL_BASE=/home/username/perl&#39;
@@ -403,6 +425,8 @@
 Patches to correctly output commands for csh style shells, as well as some
 documentation additions, contributed by Christopher Nehren &lt;apeiron@cpan.org&gt;.
 
+&#39;--self-contained&#39; feature contributed by Mark Stosberg &lt;mark@summersault.com&gt;.
+
 =head1 LICENSE
 
 This library is free software under the same license as perl itself
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-513503" href="/Public/Bug/Display.html?id=39644#txn-513503">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;28&nbsp;10:00:17&nbsp;2008</span>
    <span class="description">mst [...] shadowcat.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39644] PATCH: add &#34;--self-contained&#34; option for generating self-contained dependency chains</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 28 Sep 2008 14:59:55 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> MARKSTOS via RT &lt;bug-local-lib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt S Trout &lt;mst [...] shadowcat.co.uk&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/513503/255794/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/255794">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat, Sep 27, 2008 at 05:11:43PM -0400, MARKSTOS via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Sat Sep 27 17:11:41 2008: Request 39644 was acted upon.
&gt; Transaction: Ticket created by MARKSTOS
&gt;        Queue: local-lib
&gt;      Subject: PATCH: add &#34;--self-contained&#34; option for generating
&gt;  self-contained dependency chains
&gt;    Broken in: &#40;no value&#41;
&gt;     Severity: Wishlist
&gt;        Owner: Nobody
&gt;   Requestors: MARKSTOS@cpan.org
&gt;       Status: new
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=39644">http://rt.cpan.org/Ticket/Display.html?id=39644</a></span> &gt;
&gt; 
&gt; 
&gt; Matt,
&gt; 
&gt; Thanks for &#39;local::lib&#39;. I&#39;ve found it rather useful. 
&gt; 
&gt; I wanted to use it to generate a self-contained folder of a module with
&gt; all of it&#39;s dependencies. 
&gt; 
&gt; &#39;local::lib&#39; is great for helping with this, but because it keeps the
&gt; global &#34;INC&#34; paths, it wasn&#39;t quit working for me-- dependencies already
&gt; installed locally weren&#39;t added to my local directory. 
</div>
Yeah, I tend to use a clean build system for that.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To solve this I created the attached patch to add a &#34;--self-contained&#34;
&gt; option. When this flag is used, only the path to core modules and the
&gt; &#39;local&#39; directories are preserved. 
</div>
Looks nice, but could you expand the documentation to note that if 
anybody&#39;s upgraded a dual-life module with UNINST=1 then this will explode?

I considered adding the feature but found that particular problem hit me
rather often on machines that had been in use for a while - I don&#39;t mind
having the feature but the caveats need to be clearly and explicitly
documented.

-- 
      Matt S Trout       Need help with your Catalyst or DBIx::Class project?
   Technical Director                    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/catalyst/">http://www.shadowcat.co.uk/catalyst/</a></span>
 Shadowcat Systems Ltd.  Want a managed development or deployment platform?
<span class="clickylink"><a target="new" rel="nofollow" href="http://chainsawblues.vox.com/">http://chainsawblues.vox.com/</a></span>            <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/servers/">http://www.shadowcat.co.uk/servers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-513504" href="/Public/Bug/Display.html?id=39644#txn-513504">#</a>      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;28&nbsp;10:00:19&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-522256" href="/Public/Bug/Display.html?id=39644#txn-522256">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;21&nbsp;11:03:12&nbsp;2008</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/522256/260836/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/260836">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=39644">http://rt.cpan.org/Ticket/Display.html?id=39644</a></span> &gt;
&gt; &gt; 
&gt; &gt; Matt,
&gt; &gt; 
&gt; &gt; Thanks for &#39;local::lib&#39;. I&#39;ve found it rather useful. 
&gt; &gt; 
&gt; &gt; I wanted to use it to generate a self-contained folder of a module
&gt; &gt; with all of it&#39;s dependencies. 
&gt; &gt; 
&gt; &gt; &#39;local::lib&#39; is great for helping with this, but because it keeps
&gt; &gt; the global &#34;INC&#34; paths, it wasn&#39;t quit working for me-- dependencies
&gt; &gt; already installed locally weren&#39;t added to my local directory. 
</div>&gt; 
&gt; Yeah, I tend to use a clean build system for that.
&gt;  
<div class="message-stanza open">&gt; &gt; To solve this I created the attached patch to add a
&gt; &gt; &#34;--self-contained&#34; option. When this flag is used, only the path to
&gt; &gt; core modules and the &#39;local&#39; directories are preserved. 
</div>&gt; 
&gt; Looks nice, but could you expand the documentation to note that if
&gt; anybody&#39;s upgraded a dual-life module with UNINST=1 then this will
&gt; explode?
</div>
I want to make sure I understand this problem. Let&#39;s the module involved
is CGI.pm. As understand the effect of &#34;UNINST=1&#34; in this case, it would
cause the core version to be removed, correct? With that assumption,
here a couple of cases spelled out.

Let&#39;s say that you&#39;ve installed a newer version of CGI.pm in location
&#34;a&#34; and removed the version in the core. 

You now want to create a bundle of CGI.pm and all it&#39;s dependencies, in
directory &#34;b&#34;. 

There should be no conflict here, because &#34;--self-contained&#34; would only
look in &#34;b&#34; and the core. It would find CGI.pm was missing completely,
and bring down it, and it&#39;s dependencies. 

###

What&#39;s an example of a case where things &#34;blow up&#34;... what goes wrong? 

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-532081" href="/Public/Bug/Display.html?id=39644#txn-532081">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;12&nbsp;14:24:13&nbsp;2008</span>
    <span class="description">mst [...] shadowcat.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> undisclosed-recipients: ;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39644] PATCH: add &#34;--self-contained&#34; option for generating self-contained dependency chains</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 12 Nov 2008 19:23:29 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> MARKSTOS via RT &lt;bug-local-lib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Matt S Trout &lt;mst [...] shadowcat.co.uk&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/532081/266680/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/266680">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue, Oct 21, 2008 at 11:03:16AM -0400, MARKSTOS via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I want to make sure I understand this problem. Let&#39;s the module involved
&gt; is CGI.pm. As understand the effect of &#34;UNINST=1&#34; in this case, it would
&gt; cause the core version to be removed, correct? With that assumption,
&gt; here a couple of cases spelled out.
&gt; 
&gt; Let&#39;s say that you&#39;ve installed a newer version of CGI.pm in location
&gt; &#34;a&#34; and removed the version in the core. 
&gt; 
&gt; You now want to create a bundle of CGI.pm and all it&#39;s dependencies, in
&gt; directory &#34;b&#34;. 
&gt; 
&gt; There should be no conflict here, because &#34;--self-contained&#34; would only
&gt; look in &#34;b&#34; and the core. It would find CGI.pm was missing completely,
&gt; and bring down it, and it&#39;s dependencies. 
&gt; 
&gt; ###
&gt; 
&gt; What&#39;s an example of a case where things &#34;blow up&#34;... what goes wrong? 
</div>
Now what happens when code on the same system that uses CGI.pm tries to run?

*BOOM*

This is especially upsetting when the module that UNINST=1 removed is something
that CPAN.pm needs to run ...

-- 
      Matt S Trout       Need help with your Catalyst or DBIx::Class project?
   Technical Director                    <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/catalyst/">http://www.shadowcat.co.uk/catalyst/</a></span>
 Shadowcat Systems Ltd.  Want a managed development or deployment platform?
<span class="clickylink"><a target="new" rel="nofollow" href="http://chainsawblues.vox.com/">http://chainsawblues.vox.com/</a></span>            <span class="clickylink"><a target="new" rel="nofollow" href="http://www.shadowcat.co.uk/servers/">http://www.shadowcat.co.uk/servers/</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-535641" href="/Public/Bug/Display.html?id=39644#txn-535641">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;20&nbsp;21:30:41&nbsp;2008</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/535641/268807/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/268807">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 12 14:24:13 2008, mst@shadowcat.co.uk wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue, Oct 21, 2008 at 11:03:16AM -0400, MARKSTOS via RT wrote:
<div class="message-stanza open">&gt; &gt; I want to make sure I understand this problem. Let&#39;s say the module
</div></div>involved
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; is CGI.pm. As I understand the effect of &#34;UNINST=1&#34; in this case, it
</div></div>would
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; cause the core version to be removed, correct? With that assumption,
&gt; &gt; here a couple of cases spelled out.
&gt; &gt;
&gt; &gt; Let&#39;s say that you&#39;ve installed a newer version of CGI.pm in location
&gt; &gt; &#34;a&#34; and removed the version in the core.
&gt; &gt;
&gt; &gt; You now want to create a bundle of CGI.pm and all it&#39;s dependencies, in
&gt; &gt; directory &#34;b&#34;.
&gt; &gt;
&gt; &gt; There should be no conflict here, because &#34;--self-contained&#34; would only
&gt; &gt; look in &#34;b&#34; and the core. It would find CGI.pm was missing completely,
&gt; &gt; and bring down it, and it&#39;s dependencies.
&gt; &gt;
&gt; &gt; ###
&gt; &gt;
&gt; &gt; What&#39;s an example of a case where things &#34;blow up&#34;... what goes wrong?
</div>&gt; 
&gt; Now what happens when code on the same system that uses CGI.pm tries
&gt; to run?
&gt; 
&gt; *BOOM*
&gt; 
&gt; This is especially upsetting when the module that UNINST=1 removed is
&gt; something
&gt; that CPAN.pm needs to run ...
</div>
Thanks for the reply, Matt.

Here&#39;s my refined understanding of the problem:

- A user users &#34;local::lib&#34; in conjunction with &#34;make UNINST=1&#34; to
  try to do a &#34;clean install&#34; of a module in a private directory.

- Unintuitively and without prompting, UNINST now deletes
  modules from the core, although this is different than the
  installation target.

- Now a user tries a module that depends on one that was deleted
  from the core, but now the old version is missing from there
  and the new version is installed in some local place.

Is this the *BOOM* scenerio that concerns you?

If &#34;UNINST=1&#34; does indeed delete modules in a place other than the one
it is going to install into, I consider that a bug with the system
executiing that logic &#40;ExtUtils::MakeMaker?&#41;. It should not allow that,
or at least it should have a warning or confirmation before proceeding.

&#34;local::lib&#34; works on INC path manipulation. It does not deal in
deletion policies. I don&#39;t see that a possible bug with UNINST=1
diminishes the usefulness of &#34;--self-contained&#34; patch for reasonable
users. If it remains a concern a note can be added to the local::lib
documentation:

 &#34;Note that using local::lib in combination with &#39;make UNINST=1&#39; can
 produce unexpected results, like deleting modules in one directory and
 recreating them in another. Use them together with caution.&#34;.

    Mark
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-540335" href="/Public/Bug/Display.html?id=39644#txn-540335">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;04&nbsp;20:43:25&nbsp;2008</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/540335/271419/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/271419">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 75b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s a revised patch that adds a warning clause refactor as you see fit. 
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/540335/271422/local_lib.patch">Download local_lib.patch</a><br />
<span class="downloadcontenttype">text/x-diff 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/local/share/perl/5.8.8/local/lib.pm	2008-08-06 06:52:36.000000000 -0400
+++ lib.pm	2008-12-04 20:40:41.000000000 -0500
@@ -14,9 +14,24 @@
 our $VERSION = &#39;1.002000&#39;; # 1.2.0
 
 sub import {
-  my &#40;$class, $path&#41; = @_;
+  my &#40;$class, @args&#41; = @_;
+
+  # The path is required, but last in the list, so we pop, not shift here. 
+  my $path = pop @args;
   $path = $class-&gt;resolve_path&#40;$path&#41;;
   $class-&gt;setup_local_lib_for&#40;$path&#41;;
+
+  # Handle the &#39;--self-contained&#39; option
+  my $flag = shift @args;  
+  no warnings &#39;uninitialized&#39;; # the flag is optional 
+  if &#40;$flag eq &#39;--self-contained&#39;&#41; {
+    # The only directories that remain are those that we just defined and those where core modules are stored. 
+    @INC = &#40;$Config::Config{privlibexp}, $Config::Config{archlibexp}, split &#39;:&#39;, $ENV{PERL5LIB}&#41;;
+  }
+  elsif &#40;defined $flag&#41; {
+      die &#34;unrecognized import argument: $flag&#34;;
+  }
+
 }
 
 sub pipeline;
@@ -306,6 +321,13 @@
 
 From the shell -
 
+  # Install LWP and it&#39;s missing dependencies to the &#39;my_lwp&#39; directory
+  perl -MCPAN -Mlocal::lib=my_lwp  -e &#39;install LWP&#39;
+
+  # Install LWP and *all non-core* dependencies to the &#39;my_lwp&#39; directory 
+  perl -MCPAN -Mlocal::lib=--self-contained,my_lwp  -e &#39;install LWP&#39;
+
+  # Just print out useful shell commands
   $ perl -Mlocal::lib
   export MODULEBUILDRC=/home/username/perl/.modulebuildrc
   export PERL_MM_OPT=&#39;INSTALL_BASE=/home/username/perl&#39;
@@ -365,6 +387,16 @@
 
 These values are then available for reference by any code after import.
 
+=head1 A WARNING ABOUT UNINST=1
+
+Be careful about using local::lib in combination with &#34;make install UNINST=1&#34;.
+The idea of this feature is that will uninstall an old version of a module
+before installing a new one. However it lacks a safety check that the old
+version and the new version will go in the same directory. Used in combination
+with local::lib, you can potentially delete a globally accessible version of a
+module while installing the new version in a local place. Only combine if &#34;make
+install UNINST=1&#34; and local::lib if you understand these possible consequences.
+
 =head1 LIMITATIONS
 
 Rather basic shell detection. Right now anything with csh in its name is
@@ -403,6 +435,8 @@
 Patches to correctly output commands for csh style shells, as well as some
 documentation additions, contributed by Christopher Nehren &lt;apeiron@cpan.org&gt;.
 
+&#39;--self-contained&#39; feature contributed by Mark Stosberg &lt;mark@summersault.com&gt;.
+
 =head1 LICENSE
 
 This library is free software under the same license as perl itself
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-553618" href="/Public/Bug/Display.html?id=39644#txn-553618">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;13&nbsp;22:51:06&nbsp;2009</span>
    <span class="description">apeiron [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-553619" href="/Public/Bug/Display.html?id=39644#txn-553619">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;13&nbsp;22:51:38&nbsp;2009</span>
    <span class="description">apeiron [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/553619/279034/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/279034">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 47b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This has been applied in version 1.3.0. Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-553622" href="/Public/Bug/Display.html?id=39644#txn-553622">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;13&nbsp;22:51:40&nbsp;2009</span>
    <span class="description">apeiron [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732945" href="/Public/Bug/Display.html?id=39644#txn-732945">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;13:30:43&nbsp;2010</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> PATCH: more docs for &#34;--self-contained&#34;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/732945/378671/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/378671">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 175b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Matt Trout provided me a gentle reminder that the docs for --self-
contained could more comprehensive. 

Attached is a doc-patch to extend the documentation for that feature. 
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> self-contained-docs.diff</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/732945/378672/self-contained-docs.diff">Download self-contained-docs.diff</a><br />
<span class="downloadcontenttype">text/x-diff 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/local/share/perl/5.10.0/local/lib.pm	2009-11-07 20:27:23.000000000 -0500
+++ lib.pm	2010-02-12 13:25:27.276990466 -0500
@@ -585,6 +585,26 @@
 
 These values are then available for reference by any code after import.
 
+=head1 CREATING A SELF-CONTAINED SET OF MODULES
+
+You can use local::lib to prepare a directory which contains a module and all
+of its non-core dependencies.  The C&lt;--self-contained&gt; option ignores any
+globally installed modules when resolving dependencies, only considering
+modules installed in a &#34;local::lib&#34; directory or provided by core Perl.
+
+A use-case for this feature would be to prepare to deploy a whole &#34;stack&#34; of
+module dependencies on a new machine, even if you have copies of the same
+dependencies installed globally already.
+
+The C&lt;--self-contained&gt; option should be used like this: 
+
+  # Install LWP and *all non-core* dependencies to the &#39;my_lwp&#39; directory 
+  perl -MCPAN -Mlocal::lib=--self-contained,my_lwp -e &#39;CPAN::install&#40;LWP&#41;&#39;
+
+Note that some dependencies may involve C-based &#34;XS&#34; code even if your target
+module doesn&#39;t. The issue of dealing with XS vs Pure Perl code is beyond the scope
+of what local::lib provides. 
+
 =head1 METHODS
 
 =head2 ensure_directory_structure_for
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-732947" href="/Public/Bug/Display.html?id=39644#txn-732947">#</a>      
    </span>
    <span class="date">Fri&nbsp;Feb&nbsp;12&nbsp;13:30:48&nbsp;2010</span>
    <span class="description">The RT System itself -  Status changed from &#39;resolved&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-735249" href="/Public/Bug/Display.html?id=39644#txn-735249">#</a>      
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;17&nbsp;10:17:54&nbsp;2010</span>
    <span class="description">apeiron [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/735249/379923/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/379923">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 44b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Applied in svn as of a few days ago. Thanks!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-735250" href="/Public/Bug/Display.html?id=39644#txn-735250">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Feb&nbsp;17&nbsp;10:17:59&nbsp;2010</span>
    <span class="description">apeiron [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.735883</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
