<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #81536 for DBD-SQLite: primary_key_info returns the wrong KEY_SEQ</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #81536 for DBD-SQLite: primary_key_info returns the wrong KEY_SEQ</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/DBD-SQLite/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/DBD-SQLite/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">81536</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/DBD-SQLite/Active/">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">ishigaki [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
VLYON [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.38_01    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;07:04:10&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> primary_key_info returns the wrong KEY_SEQ</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">primary_key_info&#40;&#41; returns primary keys in the sequence the columns have 
in the table rather than the sequence they have in the PRIMARY_KEY 
index!

This is a critical bug.

perl -MDBI -MData::Dumper -wle &#39;my $dbh = DBI-&gt;connect&#40;&#34;DBI:SQLite:&#34;&#41;; 
$dbh-&gt;do&#40;&#34;CREATE TABLE t &#40;id INT, type TEXT, PRIMARY KEY &#40;type, id&#41;&#41;&#34;&#41;; 
my $pk = $dbh-&gt;primary_key_info&#40;undef, undef, &#34;t&#34;&#41;-
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;fetchall_arrayref&#40;{}&#41;; print Dumper&#40;$pk&#41;&#39;
</div>
The key sequence returned is: id, type
But should have been: type, id

I&#39;ll look into a patch for this, including tests.

Regards,
Vernon
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;09:03:56&nbsp;2012</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for your report. Fixed in the trunk.

On Thu Nov 29 21:04:10 2012, VLYON wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; primary_key_info&#40;&#41; returns primary keys in the sequence the columns 
</div>have 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; in the table rather than the sequence they have in the PRIMARY_KEY 
&gt; index!
&gt; 
&gt; This is a critical bug.
&gt; 
&gt; perl -MDBI -MData::Dumper -wle &#39;my $dbh = DBI-&gt;connect
</div>&#40;&#34;DBI:SQLite:&#34;&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; $dbh-&gt;do&#40;&#34;CREATE TABLE t &#40;id INT, type TEXT, PRIMARY KEY &#40;type, 
</div>id&#41;&#41;&#34;&#41;; 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; my $pk = $dbh-&gt;primary_key_info&#40;undef, undef, &#34;t&#34;&#41;-
<div class="message-stanza open">&gt; &gt;fetchall_arrayref&#40;{}&#41;; print Dumper&#40;$pk&#41;&#39;
</div>&gt; 
&gt; The key sequence returned is: id, type
&gt; But should have been: type, id
&gt; 
&gt; I&#39;ll look into a patch for this, including tests.
&gt; 
&gt; Regards,
&gt; Vernon
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;09:03:57&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;09:03:58&nbsp;2012</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;11:15:33&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;11:22:04&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This is almost what I was working on, but it still has a few problems.

If there is another index in a table covering the same columns as the 
primary key, they may have a different order, which could be returned 
instead of the primary key&#39;s order. &#40;Very unlikely, but ...&#41;

CREATE TABLE t &#40;a INT, b TEXT, UNIQUE &#40;a, b&#41;, PRIMARY KEY &#40;b, a&#41;&#41;;

Also, the primary key sequence when listing more than 1 table is wrong.
It keeps increasing instead of starting at 1 for each table.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;11:37:39&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Given to ISHIGAKI</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;11:38:18&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">This patch shows the issue in a test:

Index: t/42_primary_key_info.t
===================================================================
--- t/42_primary_key_info.t     &#40;revision 15675&#41;
+++ t/42_primary_key_info.t     &#40;working copy&#41;
@@ -10,7 +10,7 @@
 use Test::More;
 use Test::NoWarnings;

-plan tests =&gt; &#40;5 * 5&#41; + &#40;3 * 6 + 1&#41; + 1;
+plan tests =&gt; &#40;5 * 5&#41; + &#40;3 * 7 + 1&#41; + 1;

 for my $quote &#40;&#39;&#39;, qw/&#39; &#34; ` []/&#41; {
        my &#40;$begin_quote, $end_quote&#41; = &#40;substr&#40;$quote, 0, 1&#41;, 
substr&#40;$quote, -1, 1&#41;&#41;;
@@ -33,6 +33,8 @@
        $dbh-&gt;do&#40;&#34;attach database &#39;:memory:&#39; as remote&#34;&#41;;
        $dbh-&gt;do&#40;&#34;create table remote.bar &#40;name text, primary 
key&#40;name&#41;&#41;&#34;&#41;;
        $dbh-&gt;do&#40;&#34;create temporary table baz &#40;tmp primary key&#41;&#34;&#41;;
+       $dbh-&gt;do&#40;&#34;attach database &#39;:memory:&#39; as multi&#34;&#41;;
+       $dbh-&gt;do&#40;&#34;create table multi.keys &#40;a text, b integer, unique&#40;a, 
b&#41;, primary key&#40;b, a&#41;&#41;&#34;&#41;;

        {
                my $sth = $dbh-&gt;primary_key_info&#40;undef, undef, &#39;foo&#39;&#41;;
@@ -87,4 +89,14 @@
                is $pk_info[0]{TABLE_SCHEM} =&gt; &#39;temp&#39;, &#34;scheme is 
correct&#34;;
                is $pk_info[0]{COLUMN_NAME} =&gt; &#39;tmp&#39;, &#34;pk name is 
correct&#34;;
        }
+
+       {
+               my $sth = $dbh-&gt;primary_key_info&#40;undef, &#39;multi&#39;, 
&#39;keys&#39;&#41;;
+               my @pk_info;
+               while&#40;my $row = $sth-&gt;fetchrow_hashref&#41; { push @pk_info, 
$row };
+               is @pk_info =&gt; 2, &#34;found 2 pks in an attached table&#34;;
+        my @pk = map $_-&gt;{COLUMN_NAME}, sort {$a-&gt;{KEY_SEQ} &lt;=&gt; $b-&gt;
{KEY_SEQ}} @pk_info;
+        is join&#40;&#39; &#39;, sort @pk&#41; =&gt; &#39;a b&#39;, &#39;pks are correct&#39;;
+        is join&#40;&#39; &#39;, @pk&#41; =&gt; &#39;b a&#39;, &#39;pk order is correct&#39;;
+       }
 }
\ No newline at end of file
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;14:03:46&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ishigaki [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I&#39;ve worked on a fix for this, but you&#39;re not gonna like it, :&#41;

Previously primary_key_info&#40;&#41; used a very quick regex to find the primary 
keys in the CREATE TABLE sql, which did not handle quoted identifiers 
correctly!

Since there is no reliable way to find the primary key sequence without 
parsing the sql, I&#39;ve add a patch that parses the identifiers correctly.

But, it thankfully only does this when there are multiple keys.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: lib/DBD/SQLite.pm
===================================================================
--- lib/DBD/SQLite.pm   &#40;revision 15676&#41;
+++ lib/DBD/SQLite.pm   &#40;working copy&#41;
@@ -392,7 +392,7 @@
             &#40;$dbname eq &#39;temp&#39;&#41; ? &#39;sqlite_temp_master&#39; :
             $quoted_dbname.&#39;.sqlite_master&#39;;

-        my $sth = $dbh-&gt;prepare&#40;&#34;SELECT name FROM $master_table WHERE type = ?&#34;&#41;;
+        my $sth = $dbh-&gt;prepare&#40;&#34;SELECT name, sql FROM $master_table WHERE type = ?&#34;&#41;;
         $sth-&gt;execute&#40;&#34;table&#34;&#41;;
         while&#40;my $row = $sth-&gt;fetchrow_hashref&#41; {
             my $tbname = $row-&gt;{name};
@@ -403,40 +403,33 @@
             $t_sth-&gt;execute;
             my @pk;
             while&#40;my $col = $t_sth-&gt;fetchrow_hashref&#41; {
-                next unless $col-&gt;{pk};
-                push @pk, $col-&gt;{name};
+                push @pk, $col-&gt;{name} if $col-&gt;{pk};
             }

             # If there&#39;re multiple primary key columns, we need to
             # find their order from one of the auto-generated unique
             # indices &#40;note that single column integer primary key
             # doesn&#39;t create an index&#41;.
-            if &#40;@pk &gt; 1&#41; {
-                my $indices = $dbh-&gt;selectall_arrayref&#40;&#34;PRAGMA $quoted_dbname.index_list&#40;$quoted_tbname&#41;&#34;, {Slice =&gt; +{}}&#41;;
-                for my $index &#40;@$indices&#41; {
-                    next unless $index-&gt;{unique};
-                    my $quoted_idxname = $dbh-&gt;quote_identifier&#40;$index-&gt;{name}&#41;;
-                    my $cols = $dbh-&gt;selectall_arrayref&#40;&#34;PRAGMA $quoted_dbname.index_info&#40;$quoted_idxname&#41;&#34;, {Slice =&gt; +{}}&#41;;
-                    my %seen;
-                    if &#40;@pk == grep { !$seen{$_}++ } &#40;@pk, map { $_-&gt;{name} } @$cols&#41;&#41; {
-                        for &#40;@$cols&#41; {
-                            push @pk_info, {
-                                TABLE_SCHEM =&gt; $dbname,
-                                TABLE_NAME  =&gt; $tbname,
-                                COLUMN_NAME =&gt; $_-&gt;{name},
-                                KEY_SEQ     =&gt; scalar @pk_info + 1,
-                                PK_NAME     =&gt; &#39;PRIMARY KEY&#39;,
-                            };
-                        }
+            if &#40;@pk &gt; 1 and $row-&gt;{sql} =~ /\bPRIMARY\s+KEY\s*\&#40;&#40;&#40;?:\s*&#40;&#40;[&#34;&#39;`]&#41;&#40;?:\3\3|&#40;?!\3&#41;.&#41;+?\3&#40;?!\3&#41;|[a-z_][a-z0-9_]*?|\[[^\]]+\]&#41;\s*,\s*&#41;+&#40;&#40;[&#34;&#39;`]&#41;&#40;?:\5\5|&#40;?!\5&#41;.&#41;+?\5&#40;?!\5&#41;|[a-z_][a-z0-9_]*?|\[[^\]]+\]&#41;&#41;\s*\&#41;/si&#41; {
+                my $pk_sql = $1;
+                @pk = &#40;&#41;;
+                while&#40;$pk_sql =~ /&#40;&#40;[&#34;&#39;`]&#41;&#40;?:\2\2|&#40;?!\2&#41;.&#41;+?\2&#40;?!\2&#41;|[a-z_][a-z0-9_]*?|\[[^\]]+\]&#41;&#40;?:\s*,\s*|$&#41;/sig&#41; {
+                    my&#40;$col, $quote&#41; = &#40;$1, $2&#41;;
+                    if &#40;defined $quote&#41; {
+                        $col = substr $col, 1, -1;
+                        $col =~ s/$quote$quote/$quote/g;
                     }
+                    push @pk, $col;
                 }
             }
-            else {
+
+            my $key_seq = 0;
+            foreach my $pk_field &#40;@pk&#41; {
                 push @pk_info, {
                     TABLE_SCHEM =&gt; $dbname,
                     TABLE_NAME  =&gt; $tbname,
-                    COLUMN_NAME =&gt; $pk[0],
-                    KEY_SEQ     =&gt; scalar @pk_info + 1,
+                    COLUMN_NAME =&gt; $pk_field,
+                    KEY_SEQ     =&gt; ++$key_seq,
                     PK_NAME     =&gt; &#39;PRIMARY KEY&#39;,
                 };
             }</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;18:39:26&nbsp;2012</span>
    <span class="description">VLYON [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> ishigaki [...] cpan.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Kenichi,

I&#39;ve created a better patch.
This one contains a bit better spacing to be clearer and patches the 
correct test.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> patch2.txt</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Index: t/rt_81536_multi_column_primary_key_info.t
===================================================================
--- t/rt_81536_multi_column_primary_key_info.t	&#40;revision 15676&#41;
+++ t/rt_81536_multi_column_primary_key_info.t	&#40;working copy&#41;
@@ -10,7 +10,7 @@
 use Test::More;
 use Test::NoWarnings;
 
-plan tests =&gt; 10 + 1;
+plan tests =&gt; 15 + 1;
 
 # single column integer primary key
 {
@@ -44,7 +44,23 @@
 	my $sth = $dbh-&gt;primary_key_info&#40;undef, undef, &#39;foo&#39;&#41;;
 	my @pk_info;
 	while&#40;my $row = $sth-&gt;fetchrow_hashref&#41; { push @pk_info, $row };
-	is @pk_info =&gt; 2, &#34;found 1 pks&#34;;
+	is @pk_info =&gt; 2, &#34;found 2 pks&#34;;
 	is $pk_info[0]{COLUMN_NAME} =&gt; &#39;type&#39;, &#34;first pk name is type&#34;;
 	is $pk_info[1]{COLUMN_NAME} =&gt; &#39;id&#39;, &#34;second pk name is id&#34;;
 }
+
+# multi-column primary key with quotes
+{
+	my $dbh = connect_ok&#40;&#41;;
+	$dbh-&gt;do&#40;&#39;create table foo &#40;a, b, &#34;c&#34;&#34;d&#34;, unique&#40;a, b, &#34;c&#34;&#34;d&#34;&#41;, primary key&#40; &#34;c&#34;&#34;d&#34;, [b], `a` &#41;&#41;&#39;&#41;;
+
+	my $sth = $dbh-&gt;primary_key_info&#40;undef, undef, &#39;foo&#39;&#41;;
+	my @pk_info;
+	while&#40;my $row = $sth-&gt;fetchrow_hashref&#41; { push @pk_info, $row };
+	is @pk_info =&gt; 3, &#34;found 3 pks&#34;;
+	my @pk = map $_-&gt;{COLUMN_NAME}, @pk_info;
+	is join&#40;&#39; &#39;, sort @pk&#41; =&gt; &#39;a b c&#34;d&#39;, &#39;all pks are correct&#39;;
+	is join&#40;&#39; &#39;, @pk&#41; =&gt; &#39;c&#34;d b a&#39;, &#39;pk order is correct&#39;;
+	@pk = map $_-&gt;{COLUMN_NAME}, sort {$a-&gt;{KEY_SEQ} &lt;=&gt; $b-&gt;{KEY_SEQ}} @pk_info;
+	is join&#40;&#39; &#39;, @pk&#41; =&gt; &#39;c&#34;d b a&#39;, &#39;pk KEY_SEQ is correct&#39;;
+}
Index: lib/DBD/SQLite.pm
===================================================================
--- lib/DBD/SQLite.pm	&#40;revision 15676&#41;
+++ lib/DBD/SQLite.pm	&#40;working copy&#41;
@@ -392,7 +392,7 @@
             &#40;$dbname eq &#39;temp&#39;&#41; ? &#39;sqlite_temp_master&#39; :
             $quoted_dbname.&#39;.sqlite_master&#39;;
 
-        my $sth = $dbh-&gt;prepare&#40;&#34;SELECT name FROM $master_table WHERE type = ?&#34;&#41;;
+        my $sth = $dbh-&gt;prepare&#40;&#34;SELECT name, sql FROM $master_table WHERE type = ?&#34;&#41;;
         $sth-&gt;execute&#40;&#34;table&#34;&#41;;
         while&#40;my $row = $sth-&gt;fetchrow_hashref&#41; {
             my $tbname = $row-&gt;{name};
@@ -403,40 +403,60 @@
             $t_sth-&gt;execute;
             my @pk;
             while&#40;my $col = $t_sth-&gt;fetchrow_hashref&#41; {
-                next unless $col-&gt;{pk};
-                push @pk, $col-&gt;{name};
+                push @pk, $col-&gt;{name} if $col-&gt;{pk};
             }
 
             # If there&#39;re multiple primary key columns, we need to
             # find their order from one of the auto-generated unique
             # indices &#40;note that single column integer primary key
             # doesn&#39;t create an index&#41;.
-            if &#40;@pk &gt; 1&#41; {
-                my $indices = $dbh-&gt;selectall_arrayref&#40;&#34;PRAGMA $quoted_dbname.index_list&#40;$quoted_tbname&#41;&#34;, {Slice =&gt; +{}}&#41;;
-                for my $index &#40;@$indices&#41; {
-                    next unless $index-&gt;{unique};
-                    my $quoted_idxname = $dbh-&gt;quote_identifier&#40;$index-&gt;{name}&#41;;
-                    my $cols = $dbh-&gt;selectall_arrayref&#40;&#34;PRAGMA $quoted_dbname.index_info&#40;$quoted_idxname&#41;&#34;, {Slice =&gt; +{}}&#41;;
-                    my %seen;
-                    if &#40;@pk == grep { !$seen{$_}++ } &#40;@pk, map { $_-&gt;{name} } @$cols&#41;&#41; {
-                        for &#40;@$cols&#41; {
-                            push @pk_info, {
-                                TABLE_SCHEM =&gt; $dbname,
-                                TABLE_NAME  =&gt; $tbname,
-                                COLUMN_NAME =&gt; $_-&gt;{name},
-                                KEY_SEQ     =&gt; scalar @pk_info + 1,
-                                PK_NAME     =&gt; &#39;PRIMARY KEY&#39;,
-                            };
-                        }
+            if &#40;@pk &gt; 1 and $row-&gt;{sql} =~ /\bPRIMARY\s+KEY\s*\&#40;\s*
+                &#40;
+                    &#40;?:
+                        &#40;
+                            [a-z_][a-z0-9_]*
+                          | &#40;[&#34;&#39;`]&#41;&#40;?:\3\3|&#40;?!\3&#41;.&#41;+?\3&#40;?!\3&#41;
+                          | \[[^\]]+\]
+                        &#41;
+                        \s*,\s*
+                    &#41;+
+                    &#40;
+                        [a-z_][a-z0-9_]*
+                      | &#40;[&#34;&#39;`]&#41;&#40;?:\5\5|&#40;?!\5&#41;.&#41;+?\5&#40;?!\5&#41;
+                      | \[[^\]]+\]
+                    &#41;
+                &#41;
+                    \s*\&#41;/six&#41; {
+                my $pk_sql = $1;
+                @pk = &#40;&#41;;
+                while&#40;$pk_sql =~ /
+                    &#40;
+                        [a-z_][a-z0-9_]*
+                      | &#40;[&#34;&#39;`]&#41;&#40;?:\2\2|&#40;?!\2&#41;.&#41;+?\2&#40;?!\2&#41;
+                      | \[&#40;[^\]]+&#41;\]
+                    &#41;
+                    &#40;?:\s*,\s*|$&#41;
+                        /sixg&#41; {
+                    my&#40;$col, $quote, $brack&#41; = &#40;$1, $2, $3&#41;;
+                    if &#40; defined $quote &#41; {
+                        # Dequote &#34;&#39;`
+                        $col = substr $col, 1, -1;
+                        $col =~ s/$quote$quote/$quote/g;
+                    } elsif &#40; defined $brack &#41; {
+                        # Dequote []
+                        $col = $brack;
                     }
+                    push @pk, $col;
                 }
             }
-            else {
+
+            my $key_seq = 0;
+            foreach my $pk_field &#40;@pk&#41; {
                 push @pk_info, {
                     TABLE_SCHEM =&gt; $dbname,
                     TABLE_NAME  =&gt; $tbname,
-                    COLUMN_NAME =&gt; $pk[0],
-                    KEY_SEQ     =&gt; scalar @pk_info + 1,
+                    COLUMN_NAME =&gt; $pk_field,
+                    KEY_SEQ     =&gt; ++$key_seq,
                     PK_NAME     =&gt; &#39;PRIMARY KEY&#39;,
                 };
             }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;21:37:38&nbsp;2012</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s completely acceptable with a test that describes the issue properly 
:&#41; Thanks for your patches. Applied to the trunk.

On Fri Nov 30 08:39:26 2012, VLYON wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Kenichi,
&gt; 
&gt; I&#39;ve created a better patch.
&gt; This one contains a bit better spacing to be clearer and patches the 
&gt; correct test.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;29&nbsp;21:37:42&nbsp;2012</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;29&nbsp;11:57:07&nbsp;2013</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closed as DBD::SQLite 1.38_02 was out. Thanks.

On Fri Nov 30 11:37:38 2012, ISHIGAKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s completely acceptable with a test that describes the issue properly 
&gt; :&#41; Thanks for your patches. Applied to the trunk.
&gt; 
&gt; On Fri Nov 30 08:39:26 2012, VLYON wrote:
<div class="message-stanza open">&gt; &gt; Hi Kenichi,
&gt; &gt; 
&gt; &gt; I&#39;ve created a better patch.
&gt; &gt; This one contains a bit better spacing to be clearer and patches the 
&gt; &gt; correct test.
</div>&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;May&nbsp;29&nbsp;11:57:08&nbsp;2013</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
