<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #99583 for DBD-SQLite: Bug in DBD::SQLite-1.43_08 - Legacy DOS 8.3 filename support incompatible with SQLITE WAL journal mode</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #99583 for DBD-SQLite: Bug in DBD::SQLite-1.43_08 - Legacy DOS 8.3 filename support incompatible with SQLITE WAL journal mode</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBD-SQLite">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBD-SQLite">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBD-SQLite">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBD-SQLite">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBD-SQLite">DBD-SQLite CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">99583</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBD-SQLite">DBD-SQLite</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
phorton2 [...] gmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10248-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10249-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=99583">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1422252" href="/Public/Bug/Display.html?id=99583#txn-1422252">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;19&nbsp;10:40:09&nbsp;2014</span>
    <span class="description">phorton2 [...] gmail.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Bug in DBD::SQLite-1.43_08 - Legacy DOS 8.3 filename support incompatible with SQLITE WAL journal mode</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 19 Oct 2014 09:38:37 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-DBD-SQLite [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Pat Horton &lt;phorton2 [...] gmail.com&gt;</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1422252/755231/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/755231">with headers</a>
<br />
<span class="downloadcontenttype">text/html 10.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza">  

    
  
  
    Hey there,<br>

    <br>

    Pardon me in advance if the format of this bug report is
    non-compliant.&nbsp; This is the first time I've reported a bug in a CPAN
    Perl Module.&nbsp; I hope I get it right, because it's a fairly simple
    bug with a definite negative impact for clients of DBD::SQLite going
    forward.&nbsp; The fix is probably a spot modification to a single line
    of Perl code, or a few lines, depending on the approach.<br>

    <br>

    <b>DESCRIPTION:</b><br>

    <br>

    On current <b>Windows platforms</b>, using DBD::SQLite 1.43_08 with
    databases that specify<b> WAL (Write Ahead Logging) journaling</b>
    does not work correctly.<br>

    <br>

    Changes made by a client that is using WAL journaling are not
    visible to clients of DBD::SQLite until some other client
    checkpoints the database.&nbsp; Checkpointing via DBD::SQLite does not
    work correctly.&nbsp; Changes to databases using WAL journaling made by
    clients using windows DBD::SQLite are not visible to other clients
    on the same machine, and the other clients cannot 'checkpoint' the
    changes made by clients usind DBD::SQLite.<br>

    <br>

    <b>SEVERITY:</b><br>

    <br>

    <b>Moderate to severe.&nbsp;</b> At a minimum bug results in incorrect
    SQL results being returned.&nbsp; I suspect that there are orders of
    operations that, as a result of this bug, could lead to incorrect or
    inconsistent data in the database itself, possibly even corruption
    of databases.<br>

    <br>

    <b>SYMPTOMS:</b><br>

    <br>

    <i>On Windows platforms, with databases using WAL journaling,
      queries made to a database that is being modified by another,
      possibly non-perl, process return inconsistent results.</i><br>

    <br>

    I noticed the bug when writing an application to interface to the
    SQLite database provided by a program called 'Plex'.&nbsp; Plex is
    windows specific media server that provides a web client to allow
    users to make changes to the database.&nbsp;&nbsp; Specifically, there is a
    field in a record in a table in an sqlite3 database that captures
    the 'watched' status of a movie or video.&nbsp; Plex marks an item as
    'watched' when it serves it to a client, and the user can explicitly
    modify the 'watched' status of a particular movie or tv show via an
    explicit Web UI and/or API.<br>

    <br>

    My application is a backup program that copies files from an
    internal system disk to external hard disk, and specifically
    attempts to detect if a video file has been 'watched' or not.&nbsp; If a
    movie has been watched, after it is backed up to the external hare
    disk, it can be removed from the system disk.<br>

    <br>

    It was moderately difficult, for me, to track this problem down.&nbsp;
    Most of the time, my DBD::SQLite queries were returning the correct
    watched status, but sometimes the Plex Web UI would tell me that a
    movie was 'watched' but the DBD::SQLite query would return an
    'unwatched' status, or vice-versa.&nbsp; Other programs, notably an
    SQLite browser, were showing the correct results, but DBD::SQLite
    kept giving me 'stale' information, which would occasionally, and
    somewhat mysteriously, correct itself.<br>

    <br>

    <b>ANALYSIS</b><br>

    <br>

    What I learned was that Plex is using WAL journaling.&nbsp;&nbsp; As I would
    make changes in the Plex Web UI, they would be written to the
    journal database files.&nbsp; The journal is only checkpointed
    occasionally under conditions determined by the Plex server.&nbsp;
    DBD::SQLite was only returning the results from the static database
    files, and would not 'checkpoint' the database correctly to combine
    the journaled data in to the static database, and so DBD::SQLite
    could not 'see' the&nbsp; changes made by Plex until Plex decided to
    checkpoint the database. <br>

    <br>

    Attempts to checkpoint the database using DBD::SQLite failed.&nbsp; Note
    that DBD::SQLite does not support the sqlite3_checkpoint_wal or
    sqlite3_checkpoint_wal_v2 methods, so I was forced to use a SQL
    PRAGMA to communicate between my Perl application and the sqlite
    binaries in order to (attempt to) effect a WAL checkpoint.<br>

    <br>

    In tracking down the bug I inserted printf's into the sqlite3.c file
    to first ensure that the pragma was correctly calling the
    appropriate C routines to do the wal checkpoints, which it was.&nbsp; So
    it was not the version of DBD::SQLite that was the problem, and
    sqlite3.c appears to have sufficient code to correctly handle the
    wal checkpointing.<br>

    <br>

    I had perused the perl code in /Perl/site/lib/DBD/SQLite.pm and had
    seen a snippet relating to DOS 8.3 filenames.<br>

    <br>

    I was looking at the database directory during modifications by Plex
    and saw the WAL journals being written to .wal and .shm files.<br>

    <br>

    I noticed that when I booted my perl program, a SEPARATE SET of .wal
    and .shm files were created in DOS 8.3 filename format. <br>

    <br>

    A lightbulb went off in my head, I added a "0 &amp;&amp;" to disable
    the DOS 8.3 filename snippet in SQLite.pm, and my application
    started working.<br>

    <br>

    <br>

    <b>DETAILS</b><br>

    <br>

    My name is 'Pat'.&nbsp;&nbsp; Plex stores it's database on my machine in the
    following directory:<br>

    <br>

    &nbsp;&nbsp;&nbsp; /Users/Pat/AppData/Local/Plex Media Server/Plug-in
    Support/Databases<br>

    <br>

    The database name, and the corresponding WAL journal files, as
    written by Plex are:<br>

    <b><br>

    </b><b>&nbsp;&nbsp;&nbsp; com.plexapp.plugins.library.db</b><b><br>

    </b><b>&nbsp;&nbsp;&nbsp; com.plexapp.plugins.library.shm</b><b><br>

    </b><b>
      &nbsp;&nbsp;&nbsp; com.plexapp.plugins.library.wal</b><br>

    <br>

    Booting a program that uses DBD::SQLite against said database
    results in the creation of the following, incorrect, WAL journal
    files.<br>

    <b><br>

    </b><b>&nbsp;&nbsp;&nbsp; COMPLE~1.shm</b><b><br>

    </b><b>&nbsp;&nbsp;&nbsp; COMPLE</b><b>~1.wal</b><br>

    <br>

    Adding the <b>"0 &amp;&amp;"</b> to line 116 in SQLite.pm caused
    DBD::SQLite to use the correct long filenames:<br>

    <br>

    &nbsp;&nbsp;&nbsp; # PRH 2014-10-19 - Force Save to comment out this code (0
      &amp;&amp;)<br>

    &nbsp;&nbsp;&nbsp; # which was passing old 8.3 DOS filenames to sqlite3
      and screwing<br>

    &nbsp;&nbsp;&nbsp; # up the wal_checkpointing<br>

    &nbsp;&nbsp;&nbsp; <br>

    &nbsp;&nbsp;&nbsp; 116: &nbsp;&nbsp; if (
<font><b>0 &amp;&amp;&nbsp;</b></font>

      $^O =~ /MSWin32/ and $real ne ':memory:' and $real ne '' and $real
      !~ /^<a>file:/</a>) {<br>

    &nbsp;&nbsp;&nbsp; 117: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require Win32;<br>

    &nbsp;&nbsp;&nbsp; 118: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require File::Basename;<br>

    &nbsp;&nbsp;&nbsp; 119: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my ($file, $dir, $suffix) =
      File::Basename::fileparse($real);<br>

    &nbsp;&nbsp;&nbsp; 120: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; my $short = Win32::GetShortPathName($real);<br>

    &nbsp;&nbsp;&nbsp; 121: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( $short &amp;&amp; -f $short ) {<br>

    &nbsp;&nbsp;&nbsp; 122: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Existing files will work directly.<br>

    &nbsp;&nbsp;&nbsp; 123: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $real = $short;<br>

    &nbsp;&nbsp;&nbsp; 124: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } elsif ( -d $dir ) {<br>

    &nbsp;&nbsp;&nbsp; 125&nbsp; ....<br>

    <br>

    <b>COMMENTARY:</b><br>

    <br>

    I am reporting this bug because it stymied me for a full day and
    perhaps other users will benefit from attention to it.<br>

    <br>

    You may wish to consider a "legacy filename support' flag that can
    be passed into the connect() method to allow clients to use the
    legacy code.<br>

    <br>

    This issue could be thorny, as the validity of the 8.3 filename
    depends on who created the database.&nbsp; If created by DBD::SQLite,
    then the database itself, as &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; well as the journals, will have
    8.3 filenames, and so the system *should* work ok.&nbsp; But when
    interfacing to other programs via sqlite databases, it is necessary
    to use the correct long filenames.<br>

    <br>

    IMHO, providing transparent correct behavior to new clients is
    important, as 'newbies' will often make design decisions based on
    early results, and if they can't get it to work the first time, if
    they can't understand what is wrong, then they will likely not use
    DBD::SQLite and/or Perl for their application, which would be a
    shame, since it is a wonderful, really, cool, combination.&nbsp; Existing
    clients that update to the newest version of DBD::SQLite could be
    made aware that they need to include the legacy filename support
    flag, going forward, if they so desire.<br>

    <br>

    Alternatively, the fix could be couched in terms of 'enable long
    filenames', and you could allow (knowledgable) users to provide the
    connect flag.<br>

    <br>

    Either way is ok with me.&nbsp; I just don't like having local Perl mods,
    as they can easily get lost and are difficult to manage. I have had
    to poke quite a few /site/lib modules in my day, and today I decided
    that the better approach would be to try to get the change into the
    trunk so I'm not holding the bag :-)<br>

    <br>

    <b>CLOSING</b><br>

    <br>

    I just want to say<b> thank you to&nbsp; ADAMK, DUNCAND, ISHIGAKI,
      MSERGEANT</b> et al for providing DBD::SQLIte.&nbsp;&nbsp; I not only use it
    in this application, but in a number of other applications, and it's
    a really great thing you guys have done and are doing, bug
    notwithstanding.&nbsp; Kudos!<br>

    <br>

    <b>- Patrick</b><br>

    <br>

    <br>

    <br>

    <br>

    <br>

    The bug results in clients being unable to do WAL checkpoints to
    synchronize database changes,&nbsp; getting stale information and
    possibly committing inconsistent or incorrect data to the
    database.&nbsp;&nbsp; <br>

  


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1422408" href="/Public/Bug/Display.html?id=99583#txn-1422408">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;03:52:14&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1422408/755316/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/755316">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 8.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the report. Fixed with <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/DBD-SQLite/DBD-SQLite/commit/12509a78555a45586ef0a626afb95a9c492dfbf6">https://github.com/DBD-SQLite/DBD-SQLite/commit/12509a78555a45586ef0a626afb95a9c492dfbf6</a></span> and shipped as 1.43_09. 

On Sun Oct 19 23:40:09 2014, phorton2@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hey there,
&gt; 
&gt; Pardon me in advance if the format of this bug report is non-
&gt; compliant. This is
&gt; the first time I&#39;ve reported a bug in a CPAN Perl Module. I hope I get
&gt; it
&gt; right, because it&#39;s a fairly simple bug with a definite negative
&gt; impact for
&gt; clients of DBD::SQLite going forward. The fix is probably a spot
&gt; modification
&gt; to a single line of Perl code, or a few lines, depending on the
&gt; approach.
&gt; 
&gt; DESCRIPTION:
&gt; 
&gt; On current Windows platforms, using DBD::SQLite 1.43_08 with databases
&gt; that
&gt; specify WAL &#40;Write Ahead Logging&#41; journaling does not work correctly.
&gt; 
&gt; Changes made by a client that is using WAL journaling are not visible
&gt; to
&gt; clients of DBD::SQLite until some other client checkpoints the
&gt; database.
&gt; Checkpointing via DBD::SQLite does not work correctly. Changes to
&gt; databases
&gt; using WAL journaling made by clients using windows DBD::SQLite are not
&gt; visible
&gt; to other clients on the same machine, and the other clients cannot
&gt; &#39;checkpoint&#39;
&gt; the changes made by clients usind DBD::SQLite.
&gt; 
&gt; SEVERITY:
&gt; 
&gt; Moderate to severe. At a minimum bug results in incorrect SQL results
&gt; being
&gt; returned. I suspect that there are orders of operations that, as a
&gt; result of
&gt; this bug, could lead to incorrect or inconsistent data in the database
&gt; itself,
&gt; possibly even corruption of databases.
&gt; 
&gt; SYMPTOMS:
&gt; 
&gt; On Windows platforms, with databases using WAL journaling, queries
&gt; made to a
&gt; database that is being modified by another, possibly non-perl, process
&gt; return
&gt; inconsistent results.
&gt; 
&gt; I noticed the bug when writing an application to interface to the
&gt; SQLite
&gt; database provided by a program called &#39;Plex&#39;. Plex is windows specific
&gt; media
&gt; server that provides a web client to allow users to make changes to
&gt; the
&gt; database. Specifically, there is a field in a record in a table in an
&gt; sqlite3
&gt; database that captures the &#39;watched&#39; status of a movie or video. Plex
&gt; marks an
&gt; item as &#39;watched&#39; when it serves it to a client, and the user can
&gt; explicitly
&gt; modify the &#39;watched&#39; status of a particular movie or tv show via an
&gt; explicit
&gt; Web UI and/or API.
&gt; 
&gt; My application is a backup program that copies files from an internal
&gt; system
&gt; disk to external hard disk, and specifically attempts to detect if a
&gt; video file
&gt; has been &#39;watched&#39; or not. If a movie has been watched, after it is
&gt; backed up
&gt; to the external hare disk, it can be removed from the system disk.
&gt; 
&gt; It was moderately difficult, for me, to track this problem down. Most
&gt; of the
&gt; time, my DBD::SQLite queries were returning the correct watched
&gt; status, but
&gt; sometimes the Plex Web UI would tell me that a movie was &#39;watched&#39; but
&gt; the
&gt; DBD::SQLite query would return an &#39;unwatched&#39; status, or vice-versa.
&gt; Other
&gt; programs, notably an SQLite browser, were showing the correct results,
&gt; but
&gt; DBD::SQLite kept giving me &#39;stale&#39; information, which would
&gt; occasionally, and
&gt; somewhat mysteriously, correct itself.
&gt; 
&gt; ANALYSIS
&gt; 
&gt; What I learned was that Plex is using WAL journaling. As I would make
&gt; changes
&gt; in the Plex Web UI, they would be written to the journal database
&gt; files. The
&gt; journal is only checkpointed occasionally under conditions determined
&gt; by the
&gt; Plex server. DBD::SQLite was only returning the results from the
&gt; static
&gt; database files, and would not &#39;checkpoint&#39; the database correctly to
&gt; combine
&gt; the journaled data in to the static database, and so DBD::SQLite could
&gt; not
&gt; &#39;see&#39; the changes made by Plex until Plex decided to checkpoint the
&gt; database.
&gt; 
&gt; Attempts to checkpoint the database using DBD::SQLite failed. Note
&gt; that
&gt; DBD::SQLite does not support the sqlite3_checkpoint_wal or
&gt; sqlite3_checkpoint_wal_v2 methods, so I was forced to use a SQL PRAGMA
&gt; to
&gt; communicate between my Perl application and the sqlite binaries in
&gt; order to
&gt; &#40;attempt to&#41; effect a WAL checkpoint.
&gt; 
&gt; In tracking down the bug I inserted printf&#39;s into the sqlite3.c file
&gt; to first
&gt; ensure that the pragma was correctly calling the appropriate C
&gt; routines to do
&gt; the wal checkpoints, which it was. So it was not the version of
&gt; DBD::SQLite
&gt; that was the problem, and sqlite3.c appears to have sufficient code to
&gt; correctly handle the wal checkpointing.
&gt; 
&gt; I had perused the perl code in /Perl/site/lib/DBD/SQLite.pm and had
&gt; seen a
&gt; snippet relating to DOS 8.3 filenames.
&gt; 
&gt; I was looking at the database directory during modifications by Plex
&gt; and saw
&gt; the WAL journals being written to .wal and .shm files.
&gt; 
&gt; I noticed that when I booted my perl program, a SEPARATE SET of .wal
&gt; and .shm
&gt; files were created in DOS 8.3 filename format.
&gt; 
&gt; A lightbulb went off in my head, I added a &#34;0 &#38;&#38;&#34; to disable the DOS
&gt; 8.3
&gt; filename snippet in SQLite.pm, and my application started working.
&gt; 
&gt; 
&gt; DETAILS
&gt; 
&gt; My name is &#39;Pat&#39;. Plex stores it&#39;s database on my machine in the
&gt; following
&gt; directory:
&gt; 
&gt; /Users/Pat/AppData/Local/Plex Media Server/Plug-in Support/Databases
&gt; 
&gt; The database name, and the corresponding WAL journal files, as written
&gt; by Plex
&gt; are:
&gt; 
&gt; com.plexapp.plugins.library.db
&gt; com.plexapp.plugins.library.shm
&gt; com.plexapp.plugins.library.wal
&gt; 
&gt; Booting a program that uses DBD::SQLite against said database results
&gt; in the
&gt; creation of the following, incorrect, WAL journal files.
&gt; 
&gt; COMPLE~1.shm
&gt; COMPLE~1.wal
&gt; 
&gt; Adding the &#34;0 &#38;&#38;&#34; to line 116 in SQLite.pm caused DBD::SQLite to use
&gt; the
&gt; correct long filenames:
&gt; 
&gt; # PRH 2014-10-19 - Force Save to comment out this code &#40;0 &#38;&#38;&#41;
&gt; # which was passing old 8.3 DOS filenames to sqlite3 and screwing
&gt; # up the wal_checkpointing
&gt; 
&gt; 116: if &#40;0 &#38;&#38; $^O =~ /MSWin32/ and $real ne &#39;:memory:&#39; and $real ne &#39;&#39;
&gt; and
&gt; $real !~ /^file:/&#41; {
&gt; 117: require Win32;
&gt; 118: require File::Basename;
&gt; 119: my &#40;$file, $dir, $suffix&#41; = File::Basename::fileparse&#40;$real&#41;;
&gt; 120: my $short = Win32::GetShortPathName&#40;$real&#41;;
&gt; 121: if &#40; $short &#38;&#38; -f $short &#41; {
&gt; 122: # Existing files will work directly.
&gt; 123: $real = $short;
&gt; 124: } elsif &#40; -d $dir &#41; {
&gt; 125 ....
&gt; 
&gt; COMMENTARY:
&gt; 
&gt; I am reporting this bug because it stymied me for a full day and
&gt; perhaps other
&gt; users will benefit from attention to it.
&gt; 
&gt; You may wish to consider a &#34;legacy filename support&#39; flag that can be
&gt; passed
&gt; into the connect&#40;&#41; method to allow clients to use the legacy code.
&gt; 
&gt; This issue could be thorny, as the validity of the 8.3 filename
&gt; depends on who
&gt; created the database. If created by DBD::SQLite, then the database
&gt; itself, as
&gt; well as the journals, will have 8.3 filenames, and so the system
&gt; *should* work
&gt; ok. But when interfacing to other programs via sqlite databases, it is
&gt; necessary to use the correct long filenames.
&gt; 
&gt; IMHO, providing transparent correct behavior to new clients is
&gt; important, as
&gt; &#39;newbies&#39; will often make design decisions based on early results, and
&gt; if they
&gt; can&#39;t get it to work the first time, if they can&#39;t understand what is
&gt; wrong,
&gt; then they will likely not use DBD::SQLite and/or Perl for their
&gt; application,
&gt; which would be a shame, since it is a wonderful, really, cool,
&gt; combination.
&gt; Existing clients that update to the newest version of DBD::SQLite
&gt; could be made
&gt; aware that they need to include the legacy filename support flag,
&gt; going
&gt; forward, if they so desire.
&gt; 
&gt; Alternatively, the fix could be couched in terms of &#39;enable long
&gt; filenames&#39;,
&gt; and you could allow &#40;knowledgable&#41; users to provide the connect flag.
&gt; 
&gt; Either way is ok with me. I just don&#39;t like having local Perl mods, as
&gt; they can
&gt; easily get lost and are difficult to manage. I have had to poke quite
&gt; a few
&gt; /site/lib modules in my day, and today I decided that the better
&gt; approach would
&gt; be to try to get the change into the trunk so I&#39;m not holding the bag
&gt; :-&#41;
&gt; 
&gt; CLOSING
&gt; 
&gt; I just want to say thank you to ADAMK, DUNCAND, ISHIGAKI, MSERGEANT et
&gt; al for
&gt; providing DBD::SQLIte. I not only use it in this application, but in a
&gt; number
&gt; of other applications, and it&#39;s a really great thing you guys have
&gt; done and are
&gt; doing, bug notwithstanding. Kudos!
&gt; 
&gt; - Patrick
&gt; 
&gt; 
&gt; 
&gt; 
&gt; 
&gt; The bug results in clients being unable to do WAL checkpoints to
&gt; synchronize
&gt; database changes, getting stale information and possibly committing
&gt; inconsistent or incorrect data to the database.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1422409" href="/Public/Bug/Display.html?id=99583#txn-1422409">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;03:52:15&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1422412" href="/Public/Bug/Display.html?id=99583#txn-1422412">#</a>      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;20&nbsp;03:52:15&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1424071" href="/Public/Bug/Display.html?id=99583#txn-1424071">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;22&nbsp;11:37:35&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1424071/756462/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/756462">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 36b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Closed as 1.44 was released. Thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1424074" href="/Public/Bug/Display.html?id=99583#txn-1424074">#</a>      
    </span>
    <span class="date">Wed&nbsp;Oct&nbsp;22&nbsp;11:37:37&nbsp;2014</span>
    <span class="description">ishigaki [...] cpan.org -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.355497</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
