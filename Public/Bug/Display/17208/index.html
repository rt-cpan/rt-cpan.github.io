<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17208 for libwww-perl: max_size is broken</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17208 for libwww-perl: max_size is broken</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/libwww-perl/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/libwww-perl/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/libwww-perl">libwww-perl CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17208</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/libwww-perl/Active/">libwww-perl</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zyzstar [...] uid0.sk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-18330-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.805    </td>
  </tr>
  <tr id="CF-18331-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jan&nbsp;22&nbsp;13:51:03&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> max_size is broken</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;max_size&#34; feature in LWP::UserAgent class is broken. It&#39;s because 
UserAgent sets a &#34;Range&#34; header to 0-&#40;$max_size-1&#41; which causes that 
HTTP server always just sends the first chunk of data with size &lt;= 
max_size and a response code &#34;206 Partial Content&#34;. Then there is no way 
to distinguish from the response code whether the received data are 
complete or partial, because server sends &#34;206&#34; even if the first range 
contained a complete response. &#40;Also a &#34;Client-Aborted&#34; header is never 
set if the server was able to send the partial content&#41;.

Example:
----------------------------------------
  HTTP/1.1 206 Partial Content..Date: Sun, 22 Jan 2006 18:47:24 GMT..
Server:
  Apache/1.3.33 &#40;Unix&#41; PHP/5.1.0 mod_ssl/2.8.22 OpenSSL/0.9.7e..Last-
Modified
  : Wed, 21 May 2003 15:35:25 GMT..ETag: &#34;53c09a-47aa0-3ecb9cbd&#34;..
Accept-Rang
  es: bytes..Content-Length: 293536..Content-Range: bytes 0-293535/
293536..Co
  nnection: close..Content-Type: image/jpeg
----------------------------------------

Another problem is, that &#34;max_size&#34; check in LWP::Protocol is missing 
for reading a data into callback.

Regards,
Jozef
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;19&nbsp;15:24:28&nbsp;2009</span>
    <span class="description">MARKSTOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> max_size is broken &#40;and a suggestion for improvement&#41;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I agree &#34;max_size&#34; could be improved. Here&#39;s another complaint about it,
and a recommended alternative implementation:

<span class="clickylink"><a target="new" rel="nofollow" href="http://osdir.com/ml/lang.perl.modules.lwp/2006-04/msg00056.html">http://osdir.com/ml/lang.perl.modules.lwp/2006-04/msg00056.html</a></span>

In case that link quits working, here&#39;s the posting it contains:

###

Hello,

I have a problem with the &#34;$ua-&gt;max_size&#40;&#41;&#34;. This can really choke you
in some cases. It seems when LWP makes this type of request it is
sending a Range request. Some servers are super slow at responding to
this type of request and often return a 206 Partial Content response.
This is sometimes replied with a &#34;Content-Type: multipart/mixed&#34; and a
boundary=&#34;--bla,bla,bla&#34;. This now makes it really difficult to figure
out what the content is &#40;ie, text/html, image/gif and so on&#41; so a lot
more processing is required to figure out what the content is and
whether or not it is acceptable. For example;

&lt;--snip--&gt;
my $url = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/&#39;">http://search.cpan.org/&#39;</a></span>;
my $max_content = 500;

require LWP::UserAgent;
my $ua = LWP::UserAgent-&gt;new;
$ua-&gt;timeout&#40;10&#41;;
$ua-&gt;max_size&#40;$max_content&#41;;

my $response = $ua-&gt;get&#40;$url&#41;;

&lt;--snip--&gt;

I&#39;m sorry I have not included a URL where all this trouble is found, but
that&#39;s because I stopped using the $ua-&gt;max_size&#40;&#41;; some time ago, but
now I have a need for it. The problem is that some servers will take
forever to respond to this request and will often cause the above
problems mentioned. My solution to this was to create a callback instead:

&lt;--snip--&gt;
my $result = &#39;&#39;;
my $url = &#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/&#39;">http://search.cpan.org/&#39;</a></span>;
my $max_content = 500;

require LWP::UserAgent;
my $ua = LWP::UserAgent-&gt;new;
$ua-&gt;timeout&#40;10&#41;;

my $response = $ua-&gt;get&#40;$url, &#39;:content_cb&#39; =&gt; \&#38;http_callback,
$max_content+1&#41;;

sub http_callback {
my &#40;$data, $response, $protocol&#41; = @_;
$result .= $data;
die if length&#40;$result &gt; $max_content&#41;;
return&#40;&#41;;
}
&lt;--snip--&gt;

While this is not prefect, it did solve all the above issues. Servers
respond super fast and the content-type headers are untouched &#40;ie,
text/html&#41;.

My request to you is to change the way &#34;$ua-&gt;max_size&#40;$max_content&#41;;&#34;
works. It would benefit me and I&#39;m sure many others if it worked more
like the callback shown above &#40;just stop download at &#40;x&#41;bytes&#41;. This
would then act more like a browser acts when you click the Stop button.
Requests would be fast and the server will reply with all header
information as expected. And this will allow us to use
&#34;LWP::Parallel::RobotUA&#34; which my above example will not.

So why is &#34;$ua-&gt;max_size&#40;$max_content&#41;;&#34; so useful? Well some people
like to create terabyte files and feed it to the robot just to see if
they can crash the server. Using the current
&#34;$ua-&gt;max_size&#40;$max_content&#41;;&#34; slows everything way down and comes with
the extra baggage of a 206 response header and a multipart/mixed
content-type. The callback solves all these issues, but will not work
with &#34;LWP::Parallel&#34;.

Thanks for listening,
John
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;19&nbsp;15:24:29&nbsp;2009</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;15&nbsp;09:02:43&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ok, max_size no longer sets the Range header.

<span class="clickylink"><a target="new" rel="nofollow" href="http://github.com/gisle/libwww-perl/commit/266c5692d0fc24b9e5d4afcf0a4cfd886d8effdb">http://github.com/gisle/libwww-perl/commit/266c5692d0fc24b9e5d4afcf0a4cfd886d8effdb</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Jun&nbsp;15&nbsp;09:02:44&nbsp;2009</span>
    <span class="description">GAAS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
