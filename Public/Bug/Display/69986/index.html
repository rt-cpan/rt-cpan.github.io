<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69986 for Sys-Syslog: setlogsock&#40;&#41; doesn&#39;t return undef on failure</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69986 for Sys-Syslog: setlogsock&#40;&#41; doesn&#39;t return undef on failure</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Sys-Syslog/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Sys-Syslog/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Sys-Syslog">Sys-Syslog CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69986</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Sys-Syslog/Active/">Sys-Syslog</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ntyni [...] iki.fi

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Unimportant    </td>
  </tr>
  <tr id="CF-30616-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.29    </td>
  </tr>
  <tr id="CF-30617-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.31    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;03&nbsp;12:34:36&nbsp;2011</span>
    <span class="description">ntyni [...] iki.fi -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> setlogsock&#40;&#41; doesn&#39;t return undef on failure</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

contrary to the documentation, since 0.28 setlogsock&#40;&#41; returns true even
when the requested socket type could not be used.

Please see the attached proposed patch with test cases and a fix.

Thanks for your work on Sys-Syslog,
-- 
Niko Tyni
ntyni@debian.org
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> 0001-Make-setlogsock-return-value-meaningful-on-failures-.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">From 4e79d8a2cb732dbe28f5759b0f3e896fd4fff3f2 Mon Sep 17 00:00:00 2001
From: Niko Tyni &lt;ntyni@debian.org&gt;
Date: Wed, 3 Aug 2011 19:11:43 +0300
Subject: [PATCH] Make setlogsock&#40;&#41; return value meaningful on failures again

Changes to setlogsock&#40;&#41; in 0.28 made the function return
true even when the requested socket type could not be used.

This includes cases where _PATH_LOG doesn&#39;t exist, the requested stream
path can&#39;t be opened or the requested network service &#40;syslog/udp,
syslog/tcp, syslog-ng/tcp&#41; can&#39;t be resolved.

Restore the return value behaviour to the documented one and include
test cases for the easily simulated or detected situations.

The syslog tcp services are not defined by default on at least Debian
and FreeBSD, so the relevant tests should give moderate coverage.
---
 Syslog.pm  |    4 +++-
 t/syslog.t |   13 +++++++++++++
 2 files changed, 16 insertions&#40;+&#41;, 1 deletions&#40;-&#41;

diff --git a/Syslog.pm b/Syslog.pm
index a68f817..4fcedd7 100644
--- a/Syslog.pm
+++ b/Syslog.pm
@@ -310,10 +310,12 @@ sub setlogsock {
     $transmit_ok = 0;
     @fallbackMethods = &#40;&#41;;
     @connectMethods = @defaultMethods;
+    my $found = 0;
 
     for my $sock_type &#40;@sock_types&#41; {
         if &#40; $mechanism{$sock_type}{check}-&gt;&#40;&#41; &#41; {
             unshift @connectMethods, $sock_type;
+            $found = 1;
         }
         else {
             warnings::warnif &#34;setlogsock&#40;&#41;: type=&#39;$sock_type&#39;: &#34;
@@ -321,7 +323,7 @@ sub setlogsock {
         }
     }
 
-    return 1;
+    return $found;
 }
 
 sub syslog {
diff --git a/t/syslog.t b/t/syslog.t
index c2bc7ff..2eabb00 100644
--- a/t/syslog.t
+++ b/t/syslog.t
@@ -283,3 +283,16 @@ BEGIN { $tests += 3 + 4 * 3 }
         setlogmask&#40;$oldmask&#41;;
     }
 }
+
+BEGIN { $tests += 4 }
+eval { $r = setlogsock&#40;&#34;stream&#34;, &#34;foo/bar&#34;&#41; };
+ok&#40; !$r, &#34;setlogsock failed correctly with a nonexistent stream path&#34;&#41;;
+is&#40; $@, &#39;&#39;, &#34;setlogsock didn&#39;t croak&#34;&#41;;
+
+SKIP: {
+    my $service = getservbyname&#40;&#34;syslog&#34;, &#34;tcp&#34;&#41; || getservbyname&#40;&#34;syslog-ng&#34;, &#34;tcp&#34;&#41;;
+    skip &#34;can&#39;t test setlogsock&#40;&#41; tcp failure&#34;, 2 if $service;
+    eval { $r = setlogsock&#40;&#34;tcp&#34;&#41; };
+    ok&#40; !$r, &#34;setlogsock failed correctly when tcp services can&#39;t be resolved&#34;&#41;;
+    is&#40; $@, &#39;&#39;, &#34;setlogsock didn&#39;t croak&#34;&#41;;
+}
-- 
1.7.5.4

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;03&nbsp;12:50:40&nbsp;2011</span>
    <span class="description">ntyni [...] iki.fi -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69986] AutoReply: setlogsock&#40;&#41; doesn&#39;t return undef on failure</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 3 Aug 2011 19:50:26 +0300</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Bugs in Sys-Syslog via RT &lt;bug-Sys-Syslog [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Niko Tyni &lt;ntyni [...] iki.fi&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Aug 03, 2011 at 12:34:36PM -0400, Bugs in Sys-Syslog via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; contrary to the documentation, since 0.28 setlogsock&#40;&#41; returns true even
&gt; when the requested socket type could not be used.
&gt; 
&gt; Please see the attached proposed patch with test cases and a fix.
</div>
Oops, the patch had a one character typo that could cause test failures
on a system with syslogng/tcp &#40;but not syslog/tcp&#41; in /etc/services.

Revised patch attached for your convenience.
-- 
Niko Tyni   ntyni@debian.org
</div></div>

<div class="messagebody">
<p>Message body is not shown because sender requested not to inline it.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;10:44:18&nbsp;2012</span>
    <span class="description">SAPER [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #69986] setlogsock&#40;&#41; doesn&#39;t return undef on failure </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Wed, 15 Aug 2012 16:44:02 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Sys-Syslog [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Sébastien Aperghis-Tramoni &lt;saper [...] cpan.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Niko Tyni wrote via RT:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi,
</div>
Hello,

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; contrary to the documentation, since 0.28 setlogsock&#40;&#41; returns true even
&gt; when the requested socket type could not be used.
&gt; 
&gt; Please see the attached proposed patch with test cases and a fix.
</div>
Thanks, applied. This will be included in Sys::Syslog version 0.31.

-- 
Sébastien Aperghis-Tramoni

Close the world, txEn eht nepO.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;15&nbsp;10:44:18&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;26&nbsp;08:19:26&nbsp;2012</span>
    <span class="description">SAPER [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Aug&nbsp;26&nbsp;08:19:27&nbsp;2012</span>
    <span class="description">SAPER [...] cpan.org -  Fixed in 0.31 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
