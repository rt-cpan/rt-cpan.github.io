<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69096 for XML-LibXML: findvalue from XML::LibXML 1.74 is very slow &#40;regression&#41;</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69096 for XML-LibXML: findvalue from XML::LibXML 1.74 is very slow &#40;regression&#41;</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-LibXML/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-LibXML/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-LibXML">XML-LibXML CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69096</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-LibXML/Active/">XML-LibXML</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
vincent [...] vinc17.net

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37350-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.74    </td>
  </tr>
  <tr id="CF-37351-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;26&nbsp;12:18:51&nbsp;2011</span>
    <span class="description">vincent [...] vinc17.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> findvalue from XML::LibXML 1.74 is very slow &#40;regression&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">With XML::LibXML 1.74, findvalue is very slow, at least on large files.
See the attached testcase. Here are the timings on my Mac OS X 10.4.11
PowerPC machine, with XML::LibXML from MacPorts:
  * 0.51s user time with XML::LibXML 1.70
  * 6.04s user time with XML::LibXML 1.74

Perl version:
This is perl 5, version 12, subversion 3 &#40;v5.12.3&#41; built for
darwin-multi-2level
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxml-findvalue.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/env perl

use strict;
use XML::LibXML;

my $file = &#39;test-huge.xml&#39;;
-e $file and die;

open FILE, &#39;&gt;&#39;, $file or die;
print FILE &#34;&lt;?xml version=\&#34;1.0\&#34;?&gt;\n&lt;root&gt;\n&#34; or die;
foreach &#40;1..6000&#41;
  { print FILE &#34;&lt;a attr=\&#34;test\&#34;/&gt;\n&#34; or die; }
print FILE &#34;&lt;/root&gt;\n&#34; or die;
close FILE or die;

my $parser = XML::LibXML-&gt;new&#40;&#41;;
my $doc = $parser-&gt;parse_file&#40;$file&#41;;
my $n = 0;
foreach my $node &#40;$doc-&gt;findnodes&#40;&#39;//a&#39;&#41;&#41;
  {
    my $v = $node-&gt;findvalue&#40;&#39;@attr&#39;&#41;;
    $v eq &#39;test&#39; or die;
    $n++;
  }
print &#34;$n\n&#34;;

unlink $file;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;26&nbsp;12:38:36&nbsp;2011</span>
    <span class="description">vincent [...] vinc17.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vincent [...] vinc17.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I didn&#39;t see XML::LibXML 1.75 was available, but this version is also
affected.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;26&nbsp;12:38:37&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;16:10:07&nbsp;2011</span>
    <span class="description">stolen-from-bitcard [...] l2g.to -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> stolen-from-bitcard [...] l2g.to</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I checked this out from Bitbucket and ran the sample script against the
code, using Mercurial&#39;s bisect to narrow it down and re-running the
script each time.

It looks like this change is the culprit:

<span class="clickylink"><a target="new" rel="nofollow" href="https://bitbucket.org/shlomif/perl-xml-libxml/changeset/3c6332236d00">https://bitbucket.org/shlomif/perl-xml-libxml/changeset/3c6332236d00</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;17:51:06&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 29 16:10:07 2011, l2g wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I checked this out from Bitbucket and ran the sample script against the
&gt; code, using Mercurial&#39;s bisect to narrow it down and re-running the
&gt; script each time.
&gt; 
&gt; It looks like this change is the culprit:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://bitbucket.org/shlomif/perl-xml-libxml/changeset/3c6332236d00">https://bitbucket.org/shlomif/perl-xml-libxml/changeset/3c6332236d00</a></span>
</div>
I would guess that findvalue is triggering node normalization, before the patch node 
normalization would quit processing after encountering the first &lt;a&gt; node and ignore 
normalization of the rest of the document which would explain the speed difference.

I&#39;m not completely sure if findvalue needs to normalize the document or not, but xpath can 
be an expensive operation to run on each loop iteration, you might want to look into utilizing 
getAttribute if you are just looking for an attribute value on the nodes being processed.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;19:35:22&nbsp;2011</span>
    <span class="description">vincent [...] vinc17.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vincent [...] vinc17.net</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Mer 29 Juin 2011 17:51:06, dfrett a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I&#39;m not completely sure if findvalue needs to normalize the document
&gt; or not,
</div>
I don&#39;t know, but it seems to do a lot of unnecessary work &#40;or it is
very inefficient&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; but xpath can be an expensive operation to run on each loop iteration,
</div>
It can be expensive with some expressions, but here it shouldn&#39;t &#40;there
can be just some overhead, that shouldn&#39;t be noticeable&#41;. The following
XSLT stylesheet does something more or less equivalent as far as XML
processing is concerned:

&lt;xsl:stylesheet version=&#34;1.0&#34;
                xmlns:xsl=&#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/1999/XSL/Transform">http://www.w3.org/1999/XSL/Transform</a></span>&#34;&gt;

&lt;xsl:output method=&#34;text&#34; indent=&#34;no&#34;/&gt;

&lt;xsl:template match=&#34;/&#34;&gt;
  &lt;xsl:for-each select=&#34;//a&#34;&gt;
    &lt;xsl:variable name=&#34;v&#34;&gt;
      &lt;xsl:value-of select=&#34;@attr&#34;/&gt;
    &lt;/xsl:variable&gt;
    &lt;xsl:if test=&#34;$v != &#39;test&#39;&#34;&gt;
      &lt;xsl:message terminate=&#34;yes&#34;&gt;Error!&lt;/xsl:message&gt;
    &lt;/xsl:if&gt;
  &lt;/xsl:for-each&gt;
&lt;/xsl:template&gt;

&lt;/xsl:stylesheet&gt;

and with xsltproc, it is very fast. This shows that the XPath expression
should not be a problem.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; you might want to look into utilizing getAttribute if you are just
&gt; looking for an attribute value on the nodes being processed.
</div>
Sometimes it can be used without much drawback, but sometimes it can
render the code less maintainable. For instance, if I change an
attribute &#34;foo&#34; by a child &#34;foo&#34; in the XML document, I can just change
the XPath expression &#34;@foo&#34; by &#34;foo&#34;. Saying not to use XPath is like
saying not to use high-level programming languages.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;20:46:54&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I did a bit more digging after my last reply, it appears that the node normalization is 
something specific to the perl implementation only. It was implemented when the underlying 
_find function was first added to the perl implementation with 
<span class="clickylink"><a target="new" rel="nofollow" href="https://bitbucket.org/shlomif/perl-xml-libxml/changeset/25f7f6f782cc">https://bitbucket.org/shlomif/perl-xml-libxml/changeset/25f7f6f782cc</a></span>

What it currently does is examine the entire DOM and look for adjacent text nodes it can 
merge together &#40;which is slow on large documents for obvious reasons&#41;. it&#39;s definitely 
something that doesn&#39;t need to be run for every XPath operation. The only possible reason I 
could see for needing to run this is if the XPath expression interacts with text nodes and a 
targeted text node has adjacent nodes that changes the evaluation of the XPath expression.

I attached a script that doesn&#39;t work in XML::LibXML 1.70, but works in XML::LibXML &gt;1.73 
that illustrates this potential issue.

an alternative solution would be to run the node normalization code when nodes are added to 
the DOM, I&#39;m not completely sure what overhead this would add.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> libxmlNormalizeXpath.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use XML::LibXML;

my $dom = XML::LibXML::Document-&gt;createDocument&#40;&#39;1.0&#39;, &#39;utf-8&#39;&#41;;
my $root = $dom-&gt;createElement&#40;&#39;root&#39;&#41;;
$dom-&gt;setDocumentElement&#40;$root&#41;;
my $e  = $dom-&gt;createElement&#40;&#34;child&#34;&#41;;
my $e2 = $dom-&gt;createElement&#40;&#34;child&#34;&#41;;
my $t1 = $dom-&gt;createTextNode&#40; &#34;te&#34; &#41;;
my $t2 = $dom-&gt;createTextNode&#40; &#34;st&#34; &#41;;
$root-&gt;appendChild&#40;$e&#41;;
$root-&gt;appendChild&#40;$e2&#41;;
$e2-&gt;appendChild&#40;$t1&#41;;
$e2-&gt;appendChild&#40;$t2&#41;;

#print $t1-&gt;toString&#40;&#41;, &#34;\n&#34;;
#print $t2-&gt;toString&#40;&#41;, &#34;\n&#34;;
foreach &#40;$dom-&gt;findnodes&#40;&#39;//child[text&#40;&#41;=&#34;test&#34;]&#39;&#41;&#41; {
	print $_-&gt;toString&#40;&#41;, &#34;\n&#34;;
}
#print $t1-&gt;toString&#40;&#41;, &#34;\n&#34;;
#print $t2-&gt;toString&#40;&#41;, &#34;\n&#34;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;21:18:07&nbsp;2011</span>
    <span class="description">vincent [...] vinc17.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vincent [...] vinc17.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Mer 29 Juin 2011 20:46:54, dfrett a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I did a bit more digging after my last reply, it appears that the node
&gt; normalization is something specific to the perl implementation only.
</div>[...]

By node normalization, you mean adjacent text node merging? Or does the
implementation do something else?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; What it currently does is examine the entire DOM and look for adjacent
&gt; text nodes it can merge together &#40;which is slow on large documents
&gt; for obvious reasons&#41;. it&#39;s definitely something that doesn&#39;t need to
&gt; be run for every XPath operation.
</div>
Yes, that&#39;s a waste of time.

[...]
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; an alternative solution would be to run the node normalization code
&gt; when nodes are added to
&gt; the DOM, I&#39;m not completely sure what overhead this would add.
</div>
I don&#39;t know the internals, but I would say that there would be two
solutions:

1. Make sure that the document is always normalized by running the node
normalization code each time it is needed &#40;e.g. when a text node is added&#41;.

2. Do lazy node normalization by having a flag attached to the owner
document that tells whether the document needs normalization, and run
the node normalization code when the operation needs a normalized document.

Perhaps see what solution has been chosen by other implementations.
But I suppose that this is now already handled by the libxml2 library
itself[*]. So, why isn&#39;t it used?

[*] There was a thread about that:
<span class="clickylink"><a target="new" rel="nofollow" href="http://veillard.com/XML/messages/1020.html">http://veillard.com/XML/messages/1020.html</a></span>
<span class="clickylink"><a target="new" rel="nofollow" href="http://veillard.com/XML/messages/1023.html">http://veillard.com/XML/messages/1023.html</a></span>
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;29&nbsp;21:39:56&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 29 21:18:07 2011, vincent@vinc17.org wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; By node normalization, you mean adjacent text node merging? Or does the
&gt; implementation do something else?
</div>
it only does adjacent text node merging

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t know the internals, but I would say that there would be two
&gt; solutions:
&gt; 
&gt; 1. Make sure that the document is always normalized by running the node
&gt; normalization code each time it is needed &#40;e.g. when a text node is added&#41;.
&gt; 
&gt; 2. Do lazy node normalization by having a flag attached to the owner
&gt; document that tells whether the document needs normalization, and run
&gt; the node normalization code when the operation needs a normalized document.
&gt; 
</div>
I&#39;m thinking #1 is the way to go, I would assume less parts of the code need to be touched in 
that scenario. It looks like all the operations that attach new nodes pass through a few 
common functions.

I haven&#39;t checked yet, but I&#39;m hoping that the xml parsing code normalizes text nodes before 
passing the DOM back to the perl glue layer.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Perhaps see what solution has been chosen by other implementations.
&gt; But I suppose that this is now already handled by the libxml2 library
&gt; itself[*]. So, why isn&#39;t it used?
&gt; 
</div>
according to the documentation it isn&#39;t as strict and doesn&#39;t free the original text nodes 
because they could still be referenced in perl &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/~shlomif/XML-LibXML-">http://search.cpan.org/~shlomif/XML-LibXML-</a></span>
1.75/lib/XML/LibXML/Node.pod#normalize&#41;

I&#39;m going to try and get a patch written up to address this issue by normalizing text nodes 
when they are added.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;00:03:05&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">While glancing over the normalize tests I noticed that it explicitly expects text nodes to not 
be merged until normalize is called, so i decided to do a bit of reading of the DOM spec.

normalize is actually a DOM method for the purpose of merging adjacent text nodes &#40;which 
implies that there can be adjacent text nodes that aren&#39;t merged&#41;

From the DOM level 3 spec &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/DOM-Level-3-Core/core.html#ID-">http://www.w3.org/TR/DOM-Level-3-Core/core.html#ID-</a></span>
C74D1578&#41; Section 1.2.1

&#34;Note that, with the exceptions of Document.normalizeDocument&#40;&#41; and Node.normalize&#40;&#41;, 
manipulating characters using DOM methods does not guarantee to preserve a fully-
normalized text.&#34;

with that in mind and the fact that performing text node normalization changes the actual 
DOM which may have other side effects for applications, I think the responsibility to 
normalize a document before performing XPath queries should fall on the application. Plus 
moving the responsibility to the application layer guarantees that normalization won&#39;t be accidentally omitted if the application is switched to another DOM compliant parser that 
doesn&#39;t automatically normalize the text nodes.

This change could potentially break existing code, but that code was probably already broken 
due to the normalize method only working in very specific scenarios before 1.73

-Daniel Frett
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jun&nbsp;30&nbsp;03:50:05&nbsp;2011</span>
    <span class="description">vincent [...] vinc17.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> vincent [...] vinc17.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Le Jeu 30 Juin 2011 00:03:05, dfrett a écrit :
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; normalize is actually a DOM method for the purpose of merging adjacent
&gt; text nodes &#40;which
&gt; implies that there can be adjacent text nodes that aren&#39;t merged&#41;
</div>
OK, and in fact this DOM method is already supported by XML::LibXML, as
documented in the XML::LibXML::Node&#40;3pm&#41; man page:

   normalize
         $node-&gt;normalize;

     This function normalizes adjacent text nodes. This function is not
     as strict as libxml2&#39;s xmlTextMerge&#40;&#41; function, since it will not
     free a node that is still referenced by the perl layer.

So, a DOM-compliant application should already use it when needed.
$doc-&gt;normalizeDocument is missing, though.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; This change could potentially break existing code, but that code was
&gt; probably already broken
&gt; due to the normalize method only working in very specific scenarios
&gt; before 1.73
</div>
Yes. And existing code based on implicit normalization is not DOM compliant.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;09&nbsp;12:18:07&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Daniel,

On Thu Jun 30 00:03:05 2011, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; While glancing over the normalize tests I noticed that it explicitly
&gt; expects text nodes to not
&gt; be merged until normalize is called, so i decided to do a bit of
&gt; reading of the DOM spec.
&gt; 
&gt; normalize is actually a DOM method for the purpose of merging adjacent
&gt; text nodes &#40;which
&gt; implies that there can be adjacent text nodes that aren&#39;t merged&#41;
&gt; 
&gt; From the DOM level 3 spec &#40;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.w3.org/TR/DOM-Level-3-">http://www.w3.org/TR/DOM-Level-3-</a></span>
&gt; Core/core.html#ID-
&gt; C74D1578&#41; Section 1.2.1
&gt; 
&gt; &#34;Note that, with the exceptions of Document.normalizeDocument&#40;&#41; and
&gt; Node.normalize&#40;&#41;,
&gt; manipulating characters using DOM methods does not guarantee to
&gt; preserve a fully-
&gt; normalized text.&#34;
&gt; 
&gt; with that in mind and the fact that performing text node normalization
&gt; changes the actual
&gt; DOM which may have other side effects for applications, I think the
&gt; responsibility to
&gt; normalize a document before performing XPath queries should fall on
&gt; the application. Plus
&gt; moving the responsibility to the application layer guarantees that
&gt; normalization won&#39;t be accidentally omitted if the application is
&gt; switched to another DOM compliant parser that
&gt; doesn&#39;t automatically normalize the text nodes.
&gt; 
&gt; This change could potentially break existing code, but that code was
&gt; probably already broken
&gt; due to the normalize method only working in very specific scenarios
&gt; before 1.73
&gt; 
&gt; -Daniel Frett
</div>
Can you prepare that modification for release, and send me a BitBucket
pull request? I&#39;d like to close this bug.

Regards,

-- Shlomi Fish
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;12&nbsp;09:18:24&nbsp;2011</span>
    <span class="description">daniel.frett [...] ccci.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> daniel.frett [...] ccci.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat Jul 09 12:18:07 2011, SHLOMIF wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Can you prepare that modification for release, and send me a BitBucket
&gt; pull request? I&#39;d like to close this bug.
&gt; 
&gt; Regards,
&gt; 
&gt; -- Shlomi Fish
</div>
Just sent a pull request, I had gotten sidetracked with my day-to-day job ;&#41;

-Daniel
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;12&nbsp;16:01:32&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jul 12 09:18:24 2011, dfrett wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sat Jul 09 12:18:07 2011, SHLOMIF wrote:
<div class="message-stanza open">&gt; &gt; Can you prepare that modification for release, and send me a BitBucket
&gt; &gt; pull request? I&#39;d like to close this bug.
&gt; &gt; 
&gt; &gt; Regards,
&gt; &gt; 
&gt; &gt; -- Shlomi Fish
</div>&gt; 
&gt; Just sent a pull request, I had gotten sidetracked with my day-to-day
</div>job ;&#41;
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
</div>
Thanks! I applied it and added a Changes entry. Will make a new release
soon.

Regards,

-- Shlomi Fish
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; -Daniel
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;12&nbsp;16:01:33&nbsp;2011</span>
    <span class="description">SHLOMIF [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
