<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #32397 for Test-Deep: undef for expected causes crash</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #32397 for Test-Deep: undef for expected causes crash</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Test-Deep/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Test-Deep/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Test-Deep/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Test-Deep/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>




<div id="external_bugtracker">
<h3>Preferred bug tracker</h3>
<p>
<div>Please visit the <a href="http://github.com/rjbs/Test-Deep/issues">preferred bug tracker</a> to report your issue.</div>
</p>
</div>

<p>This queue is for tickets about the <a href="https://metacpan.org/release/Test-Deep">Test-Deep CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">32397</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Test-Deep/Active/">Test-Deep</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zeta [...] tcscs.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-31370-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.099    </td>
  </tr>
  <tr id="CF-31371-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;17&nbsp;16:11:23&nbsp;2008</span>
    <span class="description">zeta [...] tcscs.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> undef for expected causes crash</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The following test causes Test::Deep to crash and results in unfinished
test script.

#!/usr/bin/perl

use strict;
use warnings;
use Test::More tests =&gt; 2;
use Test::Deep;

sub test { return [ shift ] || undef; }

my $expected = [ &#39;test&#39; ];
cmp_bag&#40;test&#40;&#39;test&#39;&#41;, $expected, &#34;Test array for data&#34;&#41;;

$expected = undef;
cmp_bag&#40;test&#40;&#41;, $expected, &#34;Test array for no data &#40;undef&#41;&#34;&#41;;


When run, the following happens:

1..2
ok 1 - Test array for data
Can&#39;t use an undefined value as an ARRAY reference at
/usr/local/share/perl/5.8.8/Test/Deep.pm line 459.
# Looks like you planned 2 tests but only ran 1.
# Looks like your test died just after 1.

I think the correct behavior should be to check if the expected field is
undefined and return ok if actual is also undefined. For example, for
this particular test, the output should be:

1..2
ok 1 - Test array for data
ok 2 - Test array for no data &#40;undef&#41;

At the very least, the undefined expected value should be caught and the
crash prevented, something like the output below, which shows the test
script completing and noting the failure due to the undefined expected
value.

1..2
ok 1 - Test array for datar
# expect : undef
# Looks like you failed 1 test of 2.

I should point out that changing the test script to use
    cmp_deeply&#40;test&#40;&#41;, bag&#40;undef&#41;, &#34;text&#34;&#41;;
instead of cmp_bag... works.

In quick testing, changing Test::Deep::cmp_bag &#40;~ line 457&#41; to:
sub cmp_bag
{
        local $Test::Builder::Level = $Test::Builder::Level + 1;
        my $got = shift;
        my $exp = shift;
        $exp = bag&#40;&#40;defined $exp ? @{$exp} : undef&#41;&#41;;
        return cmp_deeply&#40;$got, $exp, shift&#41;;
}

allows cmp_bag to function as expected. The problem was an uncaught
undef value being used in @{} to get an array, as with bag&#40;@{shift&#40;&#41;}&#41;.

I also recognize that this type of test should not use cmp_bag to begin
with, though I think this still should be caught and handled more
gracefully.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;17&nbsp;18:25:48&nbsp;2008</span>
    <span class="description">FDALY [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> FDALY [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks for the report.

The docs are quite explicit about the arguments to cmp_bag

---
       $ok = cmp_bag&#40;\@got, \@bag, $name&#41;

       Is shorthand for cmp_deeply&#40;\@got, bag&#40;@bag&#41;, $name&#41;
---

cmp_bag expects 2 array refs. Passing undef is an error and if you do
that, you should expect an unhappy result - just the same as doing

$x = undef;
print @$x;

[] is a reference to an empty array, undef is not.

I could check that all arguments to all functions are of the correct
form but in this case that would also result in the script dieing
prematurely, just with a more useful error message.

If you&#39;d like to send me a patch for that &#40;with tests&#41; I will review it.
In the meantime I&#39;m closing the bug,

F

On Thu Jan 17 16:11:23 2008, ZETA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The following test causes Test::Deep to crash and results in unfinished
&gt; test script.
&gt; 
&gt; #!/usr/bin/perl
&gt; 
&gt; use strict;
&gt; use warnings;
&gt; use Test::More tests =&gt; 2;
&gt; use Test::Deep;
&gt; 
&gt; sub test { return [ shift ] || undef; }
&gt; 
&gt; my $expected = [ &#39;test&#39; ];
&gt; cmp_bag&#40;test&#40;&#39;test&#39;&#41;, $expected, &#34;Test array for data&#34;&#41;;
&gt; 
&gt; $expected = undef;
&gt; cmp_bag&#40;test&#40;&#41;, $expected, &#34;Test array for no data &#40;undef&#41;&#34;&#41;;
&gt; 
&gt; 
&gt; When run, the following happens:
&gt; 
&gt; 1..2
&gt; ok 1 - Test array for data
&gt; Can&#39;t use an undefined value as an ARRAY reference at
&gt; /usr/local/share/perl/5.8.8/Test/Deep.pm line 459.
&gt; # Looks like you planned 2 tests but only ran 1.
&gt; # Looks like your test died just after 1.
&gt; 
&gt; I think the correct behavior should be to check if the expected field is
&gt; undefined and return ok if actual is also undefined. For example, for
&gt; this particular test, the output should be:
&gt; 
&gt; 1..2
&gt; ok 1 - Test array for data
&gt; ok 2 - Test array for no data &#40;undef&#41;
&gt; 
&gt; At the very least, the undefined expected value should be caught and the
&gt; crash prevented, something like the output below, which shows the test
&gt; script completing and noting the failure due to the undefined expected
&gt; value.
&gt; 
&gt; 1..2
&gt; ok 1 - Test array for datar
&gt; # expect : undef
&gt; # Looks like you failed 1 test of 2.
&gt; 
&gt; I should point out that changing the test script to use
&gt;     cmp_deeply&#40;test&#40;&#41;, bag&#40;undef&#41;, &#34;text&#34;&#41;;
&gt; instead of cmp_bag... works.
&gt; 
&gt; In quick testing, changing Test::Deep::cmp_bag &#40;~ line 457&#41; to:
&gt; sub cmp_bag
&gt; {
&gt;         local $Test::Builder::Level = $Test::Builder::Level + 1;
&gt;         my $got = shift;
&gt;         my $exp = shift;
&gt;         $exp = bag&#40;&#40;defined $exp ? @{$exp} : undef&#41;&#41;;
&gt;         return cmp_deeply&#40;$got, $exp, shift&#41;;
&gt; }
&gt; 
&gt; allows cmp_bag to function as expected. The problem was an uncaught
&gt; undef value being used in @{} to get an array, as with bag&#40;@{shift&#40;&#41;}&#41;.
&gt; 
&gt; I also recognize that this type of test should not use cmp_bag to begin
&gt; with, though I think this still should be caught and handled more
&gt; gracefully.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;17&nbsp;18:25:49&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;17&nbsp;19:14:26&nbsp;2008</span>
    <span class="description">FDALY [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Thu&nbsp;Jan&nbsp;17&nbsp;19:14:27&nbsp;2008</span>
    <span class="description">FDALY [...] cpan.org -  Severity Important changed to Wishlist</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
