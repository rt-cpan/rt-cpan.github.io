<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #22684 for MIME-tools: [PATCH] MIME/Decoder.pm &#40;filter&#41;: use select&#40;&#41; for IO multiplexing</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #22684 for MIME-tools: [PATCH] MIME/Decoder.pm &#40;filter&#41;: use select&#40;&#41; for IO multiplexing</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/MIME-tools/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/MIME-tools/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/MIME-tools">MIME-tools CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">22684</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/MIME-tools/Active/">MIME-tools</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">dmo+pause [...] dmo.ca
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
at [...] altlinux.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21368-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-21369-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Oct&nbsp;28&nbsp;16:33:12&nbsp;2006</span>
    <span class="description">at [...] altlinux.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] MIME/Decoder.pm &#40;filter&#41;: use select&#40;&#41; for IO multiplexing</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sun, 29 Oct 2006 00:32:16 +0400</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-mime-tools [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Alexey Tourbin &lt;at [...] altlinux.ru&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Before now, the filter&#40;&#41; code was crap.  The problem is that open2&#40;&#41; does
only one half of the work, i.e. creating pipes and connecting descriptors.
Another half, which is doing reads and writes, cannot be done in a dumb
&#34;first write all, then read all&#34; manner.  It works only in simplest cases,
when buffers are large enough to hold the stuff.  Actually it is
deadlock-prone.

The following script, which I call &#34;filtertest.pl&#34;, can demonstrate the
deadlock.

require MIME::Decoder;
require MIME::Decoder::Gzip64;
install MIME::Decoder::Gzip64 &#39;x-gzip64&#39;;
my $decoder = MIME::Decoder-&gt;new&#40;&#39;x-gzip64&#39;&#41;;
$decoder-&gt;encode&#40;\*STDIN, \*STDOUT&#41;;

In a simple case, it works:

$ echo 123 |perl filtertest.pl
H4sIAN6AQ0UAAzM0MuYCAAj9gloEAAAA
$

However, it blocks under heavy load:

$ cat /usr/lib/perl5/pod/*.pod |perl -d:Trace filtertest.pl
...
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:68:     my $self = shift;
&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:69:     return read&#40;$$self, $_[0], $_[1]&#41;;
&gt;&gt; /usr/lib/perl5/vendor_perl/MIME/Decoder.pm:438:     while &#40;$in-&gt;read&#40;$buf, 2048&#41;&#41; { print CHILDIN $buf }
&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:68:     my $self = shift;
&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:69:     return read&#40;$$self, $_[0], $_[1]&#41;;
&gt;&gt; /usr/lib/perl5/vendor_perl/MIME/Decoder.pm:438:     while &#40;$in-&gt;read&#40;$buf, 2048&#41;&#41; { print CHILDIN $buf }
&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:68:     my $self = shift;
&gt;&gt; /usr/lib/perl5/vendor_perl/IO/Wrap.pm:69:     return read&#40;$$self, $_[0], $_[1]&#41;;
&gt;&gt; /usr/lib/perl5/vendor_perl/MIME/Decoder.pm:438:     while &#40;$in-&gt;read&#40;$buf, 2048&#41;&#41; { print CHILDIN $buf }
</div>&#40;deadlock&#41;
...

What happens here is that gzip has cooked up its stuff and tries to flush
it.  Before gzip does that, it is not going to read its input any further.
However, we are not going to check gzip output, too, because we are doing
&#34;first write all&#34; thing.  That&#39;s deadlock.

The right thing to do is to use select&#40;&#41; for IO multiplexing, i.e. to
intermix reads and writes as needed.  This is all mentioned in IPC::Open2
and IPC::Open3 documentation.

This patch does the right thing.  After CHILDIN and CHOULDOUT descriptors
are connected, I set up read/write descriptor sets and excercise select&#40;&#41;
loop.  When writing to CHILDIN, I also install SIGPIPE handler so as to
protect me from being killed if the child exits prematurely.  But SIGPIPE
handler only issues a warning.  Ultimately I check $? exit status, and when
it is non-zero, it&#39;s then I die.

The above test case now works.
---
 lib/MIME/Decoder.pm |   59 ++++++++++++++++++++++++++++++++++++++++++--------
 1 files changed, 49 insertions&#40;+&#41;, 10 deletions&#40;-&#41;

diff --git a/lib/MIME/Decoder.pm b/lib/MIME/Decoder.pm
index 0ea35f2..4899ee7 100644
--- a/lib/MIME/Decoder.pm
+++ b/lib/MIME/Decoder.pm
@@ -436,18 +436,57 @@ sub filter {
 
     ### Open pipe:
     STDOUT-&gt;flush;       ### very important, or else we get duplicate output!
-    my $kidpid = open2&#40;\*CHILDOUT, \*CHILDIN, @cmd&#41; || die &#34;open2 failed: $!&#34;;
-
-    ### Write all:
-    while &#40;$in-&gt;read&#40;$buf, 2048&#41;&#41; { print CHILDIN $buf }
-    close \*CHILDIN;
-
-    ### Read all:
-    while &#40;read&#40;\*CHILDOUT, $buf, 2048&#41;&#41; { $out-&gt;print&#40;$buf&#41; }
-    close \*CHILDOUT;
+    local &#40;*CHILDOUT, *CHILDIN&#41;;
+    my $kidpid = open2&#40;\*CHILDOUT, \*CHILDIN, @cmd&#41; || die &#34;@cmd: open2 failed: $!&#34;;
+
+    ### We have to use select&#40;&#41; for doing both reading and writing.
+    my $rno = fileno&#40;CHILDOUT&#41;;
+    my $wno = fileno&#40;CHILDIN&#41;;
+    vec&#40;my $rfds=&#39;&#39;, $rno, 1&#41; = 1;
+    vec&#40;my $wfds=&#39;&#39;, $wno, 1&#41; = 1;
+
+    while &#40;1&#41; {
+       ### Wait for one hour; if that fails, it&#39;s too bad.
+       my $n = select&#40;my $rout=$rfds, my $wout=$wfds, undef, 3600&#41;;
+       if &#40;$n &lt;= 0&#41; {
+           kill 1, $kidpid;
+           waitpid $kidpid, 0;
+           die &#34;@cmd: select failed: $!&#34; if $n &lt; 0;
+           die &#34;@cmd: select timeout&#34; if $n == 0;
+       }
+       ### If can read from child:
+       if &#40;$rout &#38;&#38; vec&#40;$rout, $rno, 1&#41;&#41; {
+           if &#40;sysread&#40;CHILDOUT, my $buf, 1024&#41;&#41; {
+               $out-&gt;print&#40;$buf&#41;;
+           }
+           else {
+               close CHILDOUT;
+               undef $rfds;
+           }
+       }
+       ### If can write to child:
+       if &#40;$wout &#38;&#38; vec&#40;$wout, $wno, 1&#41;&#41; {
+           if &#40;$in-&gt;read&#40;my $buf, 1024&#41;&#41; {
+               local $SIG{PIPE} = sub {
+                   warn &#34;got SIGPIPE from @cmd&#34;;
+                   close CHILDIN;
+                   undef $wfds;
+               };
+               syswrite&#40;CHILDIN, $buf&#41;;
+           }
+           else {
+               close CHILDIN;
+               undef $wfds;
+           }
+       }
+       ### If both CHILDOUT and CHILDIN are done:
+       last unless $rfds || $wfds;
+    }
 
     ### Wait for it:
-    waitpid&#40;$kidpid,0&#41; or die &#34;couldn&#39;t reap child $kidpid&#34;;
+    waitpid&#40;$kidpid,0&#41; == $kidpid or die &#34;@cmd: couldn&#39;t reap child $kidpid&#34;;
+    ### Check if it failed:
+    $? == 0 or die &#34;@cmd: bad exit status: \$? = $?&#34;;
     1;
 }
 
-- 
1.4.3.GIT
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Take even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Apr&nbsp;29&nbsp;17:09:10&nbsp;2010</span>
    <span class="description">dmo+pause [...] dmo.ca -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;07&nbsp;11:11:43&nbsp;2011</span>
    <span class="description">dmo+pause [...] dmo.ca -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Fixed in 5.500
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;07&nbsp;11:11:45&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jan&nbsp;07&nbsp;11:11:46&nbsp;2011</span>
    <span class="description">dmo+pause [...] dmo.ca -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
