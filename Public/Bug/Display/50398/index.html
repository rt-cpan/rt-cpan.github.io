<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #50398 for IPC-Cmd:  IPC::Cmd timeout issue</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #50398 for IPC-Cmd:  IPC::Cmd timeout issue</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=IPC-Cmd">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=IPC-Cmd">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=IPC-Cmd">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=IPC-Cmd">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/IPC-Cmd">IPC-Cmd CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">50398</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="time worked">
    <td class="label">Worked:</td>
    <td class="value">1 hour (60 min)

</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=IPC-Cmd">IPC-Cmd</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">BINGOS [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
petya [...] nigilist.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">
adamk [...] cpan.org

<br />
chris [...] bingosnet.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17338-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-17339-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




kohts-cmd-termination.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/794254/411753/kohts-cmd-termination.patch">
Tue Jun 22 10:37:30 2010 (6.5k) by http://lj.rossia.org/~nit/
</a>
</font></li>
</ul>


kohts-ipc-cmd-0.56-terminate_on_parent.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/761867/394104/kohts-ipc-cmd-0.56-terminate_on_parent.diff">
Mon Apr 12 04:06:13 2010 (2.6k) by http://lj.rossia.org/users/nit/
</a>
</font></li>
</ul>


run_forked.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/685611/352976/run_forked.diff">
Wed Nov 04 06:42:26 2009 (12.2k) by http://lj.rossia.org/users/nit/
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=50398">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675157" href="/Public/Bug/Display.html?id=50398#txn-675157">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:39:25&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> IPC::Cmd timeout issue</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/675157/347300/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347300">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.4k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello, Jos.

I&#39;ve ran into an issue with IPC::Cmd
when using timeout feature combined with
_open3_run or _system_run calls.

When timeout happens IPC::Cmd
returns control to my program,
but does not kill running child.

If using _cmd_run call -- child is killed
&#40;which is done by Cmd::Run internally
upon receiving SIGALRM&#41;.

I&#39;ve implemented killing functionality
for open3 and system codepaths.

For_open3_run -- by signaling $pid
returned by open3 with -9.

For _system_run -- by signaling myself with -15,
masking it before so the caller does not die --
not sure that this is quite clean but anyway
_system_run is used as a last resort so
we might think it will not be used
in serious programs.

Here&#39;s the patch against IPC::Cmd 0.46:


--- Cmd.pm.orig 2009-06-12 17:40:03.000000000 +0400
+++ Cmd.pm      2009-08-21 11:48:09.000000000 +0400
@@ -426,6 +426,8 @@

         ### if we are allowed to run verbose, just dispatch the system command
         } else {
+           $self-&gt;{&#39;need_term&#39;} = 1;
+
             $self-&gt;_debug&#40; &#34;# Using system&#40;&#41;. Have buffer: $have_buffer&#34; &#41;
                 if $DEBUG;
             $ok = $self-&gt;_system_run&#40; $cmd, $verbose &#41;;
@@ -443,7 +445,16 @@
         ### alarm happened
         if &#40; $@ and ref $@ and $@-&gt;isa&#40; ALARM_CLASS &#41; &#41; {
             $err = $@-&gt;&#40;&#41;;  # the error code is an expired alarm
+
+           kill -9, $self-&gt;{&#39;child_pid&#39;} if $self-&gt;{&#39;child_pid&#39;};

+           if &#40;$self-&gt;{&#39;need_term&#39;}&#41; {
+               my $old_term = $SIG{TERM};
+               local $SIG{TERM} = sub { return 1; };
+               kill -15, $$ if $self-&gt;{&#39;need_term&#39;};
+               local $SIG{TERM} = $old_term;
+           }
+
         ### another error happened, set by the dispatchub
         } else {
             $err = $self-&gt;error;
@@ -517,6 +528,8 @@
         return;
     };

+    $self-&gt;{&#39;child_pid&#39;} = $pid;
+
     ### use OUR stdin, not $kidin. Somehow,
     ### we never get the input.. so jump through
     ### some hoops to do it :&#40;


If you think that the patch is ok, it would be really nice
if you could release the next version of IPC::Cmd in near future,
because the program which uses it is going to be installed
on several thousands of servers so it would be handy
to have the new version in CPAN rather than distributing
the patched version by other means.

Thanks for attention and for the module too.


Regards,
Petya.

ps: not sure about your emails, sending the letter both to
cpan.org and your personal e-mail.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675160" href="/Public/Bug/Display.html?id=50398#txn-675160">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:39:37&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675160/347303/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347303">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jos,

there&#39;s another smaller issue with IPC::Cmd.

When used on CPU intensive long-running tasks
current open3 implementation begins to eat up CPU
because of the read loop.

To solve the problem we could use a small sleep
in each read cycle.

Here&#39;s the patch combined with previous patch:

--- Cmd.pm.orig 2009-06-12 17:40:03.000000000 +0400
+++ Cmd.pm      2009-08-23 01:59:43.000000000 +0400
@@ -33,6 +33,7 @@
 use Text::ParseWords            &#40;&#41;;             # import ONLY if needed!
 use Module::Load::Conditional   qw[can_load];
 use Locale::Maketext::Simple    Style =&gt; &#39;gettext&#39;;
+use Time::HiRes                qw[usleep];

 =pod

@@ -426,6 +427,8 @@

         ### if we are allowed to run verbose, just dispatch the system command
         } else {
+           $self-&gt;{&#39;need_term&#39;} = 1;
+
             $self-&gt;_debug&#40; &#34;# Using system&#40;&#41;. Have buffer: $have_buffer&#34; &#41;
                 if $DEBUG;
             $ok = $self-&gt;_system_run&#40; $cmd, $verbose &#41;;
@@ -443,7 +446,16 @@
         ### alarm happened
         if &#40; $@ and ref $@ and $@-&gt;isa&#40; ALARM_CLASS &#41; &#41; {
             $err = $@-&gt;&#40;&#41;;  # the error code is an expired alarm
+
+           kill -9, $self-&gt;{&#39;child_pid&#39;} if $self-&gt;{&#39;child_pid&#39;};

+           if &#40;$self-&gt;{&#39;need_term&#39;}&#41; {
+          my $old_term = $SIG{TERM};
+                   local $SIG{TERM} = sub { return 1; };
+               kill -15, $$ if $self-&gt;{&#39;need_term&#39;};
+               local $SIG{TERM} = $old_term;
+           }
+
         ### another error happened, set by the dispatchub
         } else {
             $err = $self-&gt;error;
@@ -517,6 +529,8 @@
         return;
     };

+    $self-&gt;{&#39;child_pid&#39;} = $pid;
+
     ### use OUR stdin, not $kidin. Somehow,
     ### we never get the input.. so jump through
     ### some hoops to do it :&#40;
@@ -535,7 +549,7 @@
     my $stdout_done = 0;
     my $stderr_done = 0;
     OUTER: while &#40; my @ready = $selector-&gt;can_read &#41; {
-
+        usleep&#40;1&#41;;
         for my $h &#40; @ready &#41; {
             my $buf;


Regards,
Petya.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675162" href="/Public/Bug/Display.html?id=50398#txn-675162">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:39:38&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675163" href="/Public/Bug/Display.html?id=50398#txn-675163">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:39:56&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675163/347305/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347305">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jos,

there is an error in my previous patch
when killing timeouted processes.

Actually I&#39;ve thought about the problem
and understood that we can&#39;t kill process group
&#40;what I was trying to do&#41; because people run 
the function in their process.

On the other hand it&#39;s obviously not enough
to kill just the child process &#40;pid that we&#39;ve got
from open3 call&#41;, because it might spawn other children.

So I see two solutions here.

First one is find all the children spawned by pid
return by open3 call &#40;using Proc::ProcessTable&#41;
which is quite simple but adds another requirement
for your module.

Second one is rewrite function logic: do fork
in run_open3 and run open3 in child creating
separate process group. Parent will wait for the child
and terminate child process group in case of timeout.

Parent also should get open3 stdout and stderr buffers
from child &#40;sockets, for example&#41;.

Second solution seems to be more complex.


As you seem to be busy at the moment and
I can&#39;t wait that long -- in my application
I&#39;ve dropped use of IPC::Cmd and almost
copied your code from open3_run
and implemented 1st child killing solution
&#40;using ProcessTable&#41;.

I&#39;m not sure how well this works under Windows,
but I&#39;ll have to make it work under Linux and FreeBSD.

If you need the code -- let me know,
I will do the patch for you.


Regards,
Petya.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675165" href="/Public/Bug/Display.html?id=50398#txn-675165">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:40:07&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675165/347307/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347307">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello, colleagues.

Several months ago I needed a function in perl
to execute program, get the output and optionally
kill the program if it runs too long.

I&#39;ve tried IPC::Run, IPC::Cmd and some other modules,
but could not find any modules where timeouts
&#40;if implemented&#41; work in case the called program
spawns some children.

So I&#39;ve implememented the described functionality
&#40;in a few words: fork, set up new process session in child,
run needed program capturing output, terminate whole session
from parent in case of timeout&#41;.


I&#39;ve talked about the situation to kane@cpan.org
but couldn&#39;t get his opinion &#40;last response from him
came about a month and a half ago&#41;.

I want my code to be available so people could use it,
so I&#39;m thinking of uploading new module, naming it
IPC::Exec for example since other names are used.

I&#39;m open to including the code into some other module
&#40;kane@cpan.org has my code but no the last version&#41;
but I&#39;m not sure if authors of other modules
can use it because it uses fork which might not work well
for different people who might be using IPC::Run, IPC::Cmd
and other.

Current version of my code is here:
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.nigilist.ru/nit/temp/Exec.pm">http://www.nigilist.ru/nit/temp/Exec.pm</a></span>


Question to the gurus: would you create a new module
in such situation?


Regards,
Petya.

ps: here&#39;s the list of run/exec modules, I&#39;ve checked:
IPC-Capture-0.06.tar.gz
IPC-Cmd-0.50.tar.gz            
IPC-Open3-Simple-0.04.tar.gz   
IPC-Open3-Utils-0.5.tar.gz     
IPC-Run-0.84.tar.gz            
IPC-Run-SafeHandles-0.02.tar.gz
IPC-Run3-0.043.tar.gz          
IPC-System-Simple-1.18.tar.gz  
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people DelWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675167" href="/Public/Bug/Display.html?id=50398#txn-675167">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:40:46&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Requestor KANE deleted</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675170" href="/Public/Bug/Display.html?id=50398#txn-675170">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:40:50&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Requestor petya@nigilist.ru added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675171" href="/Public/Bug/Display.html?id=50398#txn-675171">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:42:02&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Cc ADAMK added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people AddWatcher odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675172" href="/Public/Bug/Display.html?id=50398#txn-675172">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:42:02&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Cc chris@bingosnet.co.uk added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675173" href="/Public/Bug/Display.html?id=50398#txn-675173">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;10:44:36&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675173/347309/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347309">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 601b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Petya,

I do appologize; I completel forgot about this email you sent.

I&#39;ve added it to the rt.cpan.org bug tracker so we don&#39;t lose track of it.

Chris &#38; I maintain the IPC::Cmd module and I&#39;m quite open to adding your patch in.

Big points are that it must be able to run cross platform, and shouldn&#39;t break any
existing functionality; IPC::Cmd&#39;s a core module now and backwards compatibility
and portability are very important.

Sorry again for being flaky on this; I should have directed you to the bug tracker
right away so things don&#39;t fall between the cracks.

Let me know what you think.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-675243" href="/Public/Bug/Display.html?id=50398#txn-675243">#</a>      
    </span>
    <span class="date">Sun&nbsp;Oct&nbsp;11&nbsp;17:33:05&nbsp;2009</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/675243/347345/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/347345">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 628b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Jos, no problems. Sorry for being a bit strict,
I really didn&#39;t know how to share my idea.

Down to the problem.

My program works well on linux and freebsd
&#40;tested on bunch of different versions&#41;.
I haven&#39;t tested it on other platforms.
I could probably make tests on SunOS
&#40;Open Solaris&#41;.

Reading the code of IPC::Cmd I&#39;ve made a conclusion
that we do not need it to run on Windows and VMS
since there&#39;re no working open3 and fork there
&#40;which are essential for my program&#41;.

I see no problems regarding backward compatibility
since you could keep all the old interfaces.

Ready to help you with the integration of the code.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-679754" href="/Public/Bug/Display.html?id=50398#txn-679754">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;20&nbsp;05:40:42&nbsp;2009</span>
    <span class="description">kane [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/679754/349899/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/349899">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 948b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun Oct 11 17:33:05 2009, <span class="clickylink"><a target="new" rel="nofollow" href="http://lj.rossia.org/users/nit/">http://lj.rossia.org/users/nit/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Jos, no problems. Sorry for being a bit strict,
&gt; I really didn&#39;t know how to share my idea.
&gt; 
&gt; Down to the problem.
&gt; 
&gt; My program works well on linux and freebsd
&gt; &#40;tested on bunch of different versions&#41;.
&gt; I haven&#39;t tested it on other platforms.
&gt; I could probably make tests on SunOS
&gt; &#40;Open Solaris&#41;.
&gt; 
&gt; Reading the code of IPC::Cmd I&#39;ve made a conclusion
&gt; that we do not need it to run on Windows and VMS
&gt; since there&#39;re no working open3 and fork there
&gt; &#40;which are essential for my program&#41;.
&gt; 
&gt; I see no problems regarding backward compatibility
&gt; since you could keep all the old interfaces.
&gt; 
&gt; Ready to help you with the integration of the code.
</div>
Ok, well let&#39;s start with the most recent version of the patch; important is that the code 
paths can&#39;t be triggered from Win32 and then we can feed it to CPAN testers to see if it&#39;s 
stable across platforms.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-685611" href="/Public/Bug/Display.html?id=50398#txn-685611">#</a>      
    </span>
    <span class="date">Wed&nbsp;Nov&nbsp;04&nbsp;06:42:26&nbsp;2009</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Petya Kohts</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/685611/352973/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/352973">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ok, well let&#39;s start with the most recent version of the patch;
&gt; important is that the code paths can&#39;t be triggered
&gt; from Win32 and then we can feed it to CPAN testers
&gt; to see if it&#39;s stable across platforms.
</div>
Attaching most recent version of patch
done against IPC::Cmd 0.50.

I&#39;ve created two different calls which
were not defined by IPC::Cmd before:
run_forked and can_use_run_forked.

The plan is to include run_forked into your module
but leave current functionality unmodified --
and allow people to choose which interface to use.

NB: i&#39;ve totally disabled function on VMS and Windows,
test suite returns ok&#40;1, &#34;platform not supported&#34;&#41; for these.


Here&#39;s usage example:

use IPC::Cmd;

my $r = IPC::Cmd::run_forked&#40;&#34;sleep 4&#34;, {&#39;timeout&#39; =&gt; 1}&#41;;
if &#40;$r-&gt;{&#39;timeout&#39;}&#41; {
  print &#34;command timed out\n&#34;;
}
print $r-&gt;{&#39;stdout&#39;} . &#34;\n&#34;;
print $r-&gt;{&#39;stderr&#39;} . &#34;\n&#34;;

Syntax is a bit different from your calls
but you could easily adapt it if you need
&#40;though I suggest you leave it as it is,
as it saves typing&#41;.


Here&#39;s test suite for the function
&#40;should be altered to use blib/:
#!/usr/bin/perl

use strict;
use warnings;

use Test::More &#39;no_plan&#39;;

#use lib &#34;/root/i&#34;;
use IPC::Cmd;

if &#40;!IPC::Cmd::can_use_run_forked&#40;&#41;&#41; {
  ok&#40;1, &#34;run_forked not available on this platform&#34;&#41;;
  exit;
}

my $cmd = &#34;echo out ; echo err &gt;&#38;2 ; sleep 4&#34;;
my $r = IPC::Cmd::run_forked&#40;$cmd, {&#39;timeout&#39; =&gt; 1}&#41;;

ok&#40;ref&#40;$r&#41; eq &#39;HASH&#39;, &#34;executed: $cmd&#34;&#41;;
ok&#40;$r-&gt;{&#39;timeout&#39;} eq 1, &#34;timed out&#34;&#41;;
ok&#40;$r-&gt;{&#39;stdout&#39;}, &#34;stdout: &#34; . $r-&gt;{&#39;stdout&#39;}&#41;;
ok&#40;$r-&gt;{&#39;stderr&#39;}, &#34;stderr: &#34; . $r-&gt;{&#39;stderr&#39;}&#41;;
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/685611/352976/run_forked.diff">Download run_forked.diff</a><br />
<span class="downloadcontenttype">text/x-diff 12.2k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-686184" href="/Public/Bug/Display.html?id=50398#txn-686184">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;05&nbsp;18:17:34&nbsp;2009</span>
    <span class="description">BINGOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">30 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/686184/353236/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/353236">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Nov 04 06:42:26 2009, <span class="clickylink"><a target="new" rel="nofollow" href="http://lj.rossia.org/users/nit/">http://lj.rossia.org/users/nit/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Ok, well let&#39;s start with the most recent version of the patch;
&gt; &gt; important is that the code paths can&#39;t be triggered
&gt; &gt; from Win32 and then we can feed it to CPAN testers
&gt; &gt; to see if it&#39;s stable across platforms.
</div>&gt; 
&gt; Attaching most recent version of patch
&gt; done against IPC::Cmd 0.50.
&gt; 
&gt; I&#39;ve created two different calls which
&gt; were not defined by IPC::Cmd before:
&gt; run_forked and can_use_run_forked.
&gt; 
&gt; The plan is to include run_forked into your module
&gt; but leave current functionality unmodified --
&gt; and allow people to choose which interface to use.
&gt; 
&gt; NB: i&#39;ve totally disabled function on VMS and Windows,
&gt; test suite returns ok&#40;1, &#34;platform not supported&#34;&#41; for these.
&gt; 
</div>
Hey thanks, Petya.

There&#39;s a lot of code to review there, but the testcase passes, and I&#39;ll
look tomorrow at integrating into the existing testsuite.

I have the code in my git clone of the svn repository and I&#39;ll push
a development release to CPAN when I have tests and the documentation
done.

Cheers.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Give odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-686185" href="/Public/Bug/Display.html?id=50398#txn-686185">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;05&nbsp;18:17:42&nbsp;2009</span>
    <span class="description">BINGOS [...] cpan.org -  Given to BINGOS</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-687229" href="/Public/Bug/Display.html?id=50398#txn-687229">#</a>      
    </span>
    <span class="date">Mon&nbsp;Nov&nbsp;09&nbsp;08:07:41&nbsp;2009</span>
    <span class="description">chris [...] bingosnet.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">CC:</td>
    <td class="message-header-value"> petya [...] nigilist.ru</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #50398] IPC::Cmd timeout issue</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Nov 2009 13:07:11 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://lj.rossia.org/users/nit/">http://lj.rossia.org/users/nit/</a></span> via RT&#34; &lt;bug-IPC-Cmd [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> &#34;Chris &#39;BinGOs&#39; Williams&#34; &lt;chris [...] bingosnet.co.uk&gt;</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/687229/353751/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/353751">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed, Nov 04, 2009 at 06:42:29AM -0500, <span class="clickylink"><a target="new" rel="nofollow" href="http://lj.rossia.org/users/nit/">http://lj.rossia.org/users/nit/</a></span> via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=50398">https://rt.cpan.org/Ticket/Display.html?id=50398</a></span> &gt;
&gt; 
<div class="message-stanza open">&gt; &gt; Ok, well let&#39;s start with the most recent version of the patch;
&gt; &gt; important is that the code paths can&#39;t be triggered
&gt; &gt; from Win32 and then we can feed it to CPAN testers
&gt; &gt; to see if it&#39;s stable across platforms.
</div>&gt; 
&gt; Attaching most recent version of patch
&gt; done against IPC::Cmd 0.50.
&gt; 
&gt; I&#39;ve created two different calls which
&gt; were not defined by IPC::Cmd before:
&gt; run_forked and can_use_run_forked.
&gt; 
&gt; The plan is to include run_forked into your module
&gt; but leave current functionality unmodified --
&gt; and allow people to choose which interface to use.
&gt; 
&gt; NB: i&#39;ve totally disabled function on VMS and Windows,
&gt; test suite returns ok&#40;1, &#34;platform not supported&#34;&#41; for these.
</div>
Hi,

Right, I have applied the patch, integrated the tests into the existing
testsuite and released IPC-Cmd-0.51_01 to CPAN.

I have also updated the IPC-Cmd that is in perl core to be 0.51_01

Before I go further and release a stable version, I need some documentation
on how people would use run_forked&#40;&#41;.

Many thanks,

-- 
Chris Williams
aka BinGOs
PGP ID 0x4658671F
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.gumbynet.org.uk">http://www.gumbynet.org.uk</a></span>
==========================
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/687229/353752/">Download &#40;untitled&#41;</a><br />
<span class="downloadcontenttype">application/pgp-signature 189b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-689928" href="/Public/Bug/Display.html?id=50398#txn-689928">#</a>      
    </span>
    <span class="date">Thu&nbsp;Nov&nbsp;12&nbsp;16:05:11&nbsp;2009</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/689928/355092/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/355092">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Before I go further and release a stable version, I need some
&gt; documentation on how people would use run_forked&#40;&#41;.
</div>
Here is the documentation; if it&#39;s too long --
just take the parts you like best of all.

&#40;I feel it&#39;s a bit too long, though it explains
in details how people could use the function
and why they should do this.&#41;


General info.
-------------

IPC::Cmd::run_forked is used to execute some program,
optionally feed it with some input, get its return code
and output &#40;both stdout and stderr into seperate buffers&#41;.
In addition it allows to terminate the program
which take too long to finish.

The important and distinguishing feature of run_forked
is execution timeout which at first seems to be
quite a simple task but if you think
that the program which you&#39;re spawning
might spawn some children itself &#40;which
in their turn could do the same and so on&#41;
it turns out to be not a simple issue.

IPC::Cmd::run_forked is designed to survive and
successfully terminate almost any long running task,
even a fork bomb in case your system has the resources
to survive during given timeout.

This is achieved by creating separate watchdog process
which spawns the specified program in a separate
process session and supervises it: optionally
feeds it with input, stores its exit code,
stdout and stderr, terminates it in case
it runs longer than specified.

Calling syntax.
---------------

The full syntax of run_forked is:

my $result = IPC::Cmd::run_forked&#40;&#34;/path/command parameters&#34;, {
  &#34;child_stdin&#34; =&gt; &#34;some buffer with text&#34;,
  &#34;timeout&#34; =&gt; 300, # seconds
  &#34;stdout_handler&#34; =&gt; sub {print $_},
  &#34;stderr_handler&#34; =&gt; sub {print $_},
  }&#41;;

The $result is the hashref with the following keys:
* exit_code
* stdout
* stderr
* timeout &#40;0 if no timeout occured&#41;
* err_msg &#40;something you could propagate to the user&#41;

You can use run_forked with any combination
of the above options or without any options.

Find below specific examples with explanations.


1.1&#41; run without timeout &#40;simple run&#41;:

my $result = IPC::Cmd::run_forked&#40;&#34;/path/command parameters&#34;&#41;;

After function returns you get hashref
with the following keys:

* exit_code -- holds the exit code of the executed command

* stdout -- holds the standard output of the executed command
&#40;or empty string if there were no stdout output; it&#39;s always defined!&#41;

* stderr -- holds the standard error of the executed command
&#40;or empty string if there were no stderr output; it&#39;s always defined!&#41;

* err_msg -- holds some explanation of the results of the execution


1.2&#41; run with timeout:

my $result = IPC::Cmd::run_forked&#40;&#34;/path/command parameters&#34;, {&#39;timeout&#39; 
=&gt; 300}&#41;;

Timeout could be specified as a hashref key/value pair
with key being equal to &#39;timeout&#39; and value measured in seconds.

If the executed program does not return for more
than this number of seconds its process session
is killed with SIG_KILL &#40;9&#41; which effectively
terminates it and all of its children
&#40;direct or indirect&#41;.


1.3&#41; synchronous processing of stdout and stderr

In case you need to synchronously process stdout and stderr
while run_forked is being executed you could define
stdout_handler and stderr_handler callbacks, for example:

sub stdout_handler {
  my &#40;$buffer&#41; = @_;
}

sub stderr_handler {
  my &#40;$buffer&#41; = @_;
}

my $result = IPC::Cmd::run_forked&#40;&#34;/path/command params&#34;, {
  &#39;stdout_handler&#39; =&gt; \&#38;stdout_handler,
  &#39;stderr_handler&#39; =&gt; \&#38;stderr_handler,
  }&#41;

Now for each portion of data from stdout and stderr
of executed program your functions will be called
and you will get new data in $buffer.

Each callback can be defined separately.

Doesn&#39;t matter if you use callbacks or not
you will get stdout and stderr
in the corresponding key/value pairs
of $result hash.


1.4&#41; feeding input to the program

To feed some input to the stdin of the executed program
you use child_stdin key in the options hashref:

my $result = IPC::Cmd::run_forked&#40;&#34;cat &gt; /tmp/message&#34;, {
  &#39;child_stdin&#39; =&gt; &#39;hello buddy&#39;
  }&#41;;

Which will be the same as running the following command
in the shell:

echo &#34;hello buddy&#34; | cat &gt; /tmp/message
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-710930" href="/Public/Bug/Display.html?id=50398#txn-710930">#</a>      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;24&nbsp;17:10:28&nbsp;2009</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/710930/366926/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/366926">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Chris and people,
hope you&#39;re doing well and wish you
Merry Christmas and Happy New Year.


Chris, thanks for integrating run_forked!

I&#39;ve created a patch for it with which
it can run not only external commands
but also internal perl code. Could you
take it in please?

Could we also include run_forked into
SYNOPSIS part of the docs otherwise
it would be hard for people to find it
&#40;I could rearrange and send you diff,
if you&#39;d like me to&#41;?

Ah! There&#39;s a small typo in the docs,
run_forked&#40;command =&gt; COMMAND, ...&#41; should read as
run_forked&#40;COMMAND, ...&#41; because first argument is scalar,
not array/hash.


Here&#39;s the patch to run internal perl code:

--- Cmd.pm.orig 2009-11-16 00:43:23.000000000 +0300
+++ Cmd.pm      2009-12-25 00:59:38.000000000 +0300
@@ -810,12 +810,31 @@
       close&#40;$child_stderr_socket&#41;;
       close&#40;$child_info_socket&#41;;

-      my $child_exit_code = open3_run&#40;$cmd, {
-        &#39;parent_info&#39; =&gt; $parent_info_socket,
-        &#39;parent_stdout&#39; =&gt; $parent_stdout_socket,
-        &#39;parent_stderr&#39; =&gt; $parent_stderr_socket,
-        &#39;child_stdin&#39; =&gt; $opts-&gt;{&#39;child_stdin&#39;},
-        }&#41;;
+      my $child_exit_code;
+
+      # allow both external programs
+      # and internal perl calls
+      if &#40;!ref&#40;$cmd&#41;&#41; {
+        $child_exit_code = open3_run&#40;$cmd, {
+          &#39;parent_info&#39; =&gt; $parent_info_socket,
+          &#39;parent_stdout&#39; =&gt; $parent_stdout_socket,
+          &#39;parent_stderr&#39; =&gt; $parent_stderr_socket,
+          &#39;child_stdin&#39; =&gt; $opts-&gt;{&#39;child_stdin&#39;},
+          }&#41;;
+      }
+      elsif &#40;ref&#40;$cmd&#41; eq &#39;CODE&#39;&#41; {
+        $child_exit_code = $cmd-&gt;&#40;{
+          &#39;opts&#39; =&gt; $opts,
+          &#39;parent_info&#39; =&gt; $parent_info_socket,
+          &#39;parent_stdout&#39; =&gt; $parent_stdout_socket,
+          &#39;parent_stderr&#39; =&gt; $parent_stderr_socket,
+          &#39;child_stdin&#39; =&gt; $opts-&gt;{&#39;child_stdin&#39;},
+          }&#41;;
+      }
+      else {
+        print $parent_stderr_socket &#34;Invalid command reference: &#34; .
ref&#40;$cmd&#41; . &#34;\n&#34;;
+        $child_exit_code = 1;
+      }

       close&#40;$parent_stdout_socket&#41;;
       close&#40;$parent_stderr_socket&#41;;


Regards,
Petya.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-761864" href="/Public/Bug/Display.html?id=50398#txn-761864">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;04:04:23&nbsp;2010</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/761864/394099/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/394099">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Chris,

thanks for integrating previous patch,
hope this is not too opften but here&#39;s another one.

It fixes obvious typo in previous patch
and adds another very useful feature
which allows user to specify
that he wants the run_forked code
&#40;together with the executed prog&#41;
to be automatically killed if parent
&#40;the one which started run_forked&#41;
is killed or dies without waiting for child code.

To use this feature user should specify
paremeter terminate_on_parent_sudden_death f.e.:

my $r = IPC::Cmd::run_forked&#40;&#34;some prog here&#34;, {
  &#39;terminate_on_parent_sudden_death&#39; =&gt; 1}
  &#41;;


Here is diff -u with IPC::Cmd version 0.56:

--- Cmd.pm.orig 2010-02-03 17:16:47.000000000 +0300
+++ Cmd.pm      2010-04-12 11:59:41.000000000 +0400
@@ -360,6 +360,10 @@
     $wait_cycles = $wait_cycles + 1;
     Time::HiRes::usleep&#40;250000&#41;; # half a second
   }
+
+  if &#40;!$child_finished&#41; {
+    kill&#40;9, $pid&#41;;
+  }
 }

 sub open3_run {
@@ -651,7 +655,6 @@
       close&#40;$parent_stderr_socket&#41;;
       close&#40;$parent_info_socket&#41;;

-      my $child_timedout = 0;
       my $flags;

       # prepare sockets to read from child
@@ -673,11 +676,13 @@

   #    print &#34;child $pid started\n&#34;;

+      my $child_timedout = 0;
       my $child_finished = 0;
       my $child_stdout = &#39;&#39;;
       my $child_stderr = &#39;&#39;;
       my $child_merged = &#39;&#39;;
       my $child_exit_code = 0;
+      my $parent_died = 0;

       my $got_sig_child = 0;
       $SIG{&#39;CHLD&#39;} = sub { $got_sig_child = time&#40;&#41;; };
@@ -685,9 +690,26 @@
       my $child_child_pid;

       while &#40;!$child_finished&#41; {
+        my $now = time&#40;&#41;;
+
+        if &#40;$opts-&gt;{&#39;terminate_on_parent_sudden_death&#39;}&#41; {
+          $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} = 0
+            unless defined&#40;$opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;}&#41;;
+
+          # check for parent once each five seconds
+          if &#40;$now - $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} &gt; 5&#41; {
+            if &#40;getppid&#40;&#41; eq &#34;1&#34;&#41; {
+              kill &#40;-9, $pid&#41;;
+              $parent_died = 1;
+            }
+
+            $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} = $now;
+          }
+        }
+
         # user specified timeout
         if &#40;$opts-&gt;{&#39;timeout&#39;}&#41; {
-          if &#40;time&#40;&#41; - $start_time &gt; $opts-&gt;{&#39;timeout&#39;}&#41; {
+          if &#40;$now - $start_time &gt; $opts-&gt;{&#39;timeout&#39;}&#41; {
             kill &#40;-9, $pid&#41;;
             $child_timedout = 1;
           }
@@ -697,7 +719,7 @@
         # kill process after that and finish wait loop;
         # shouldn&#39;t ever happen -- remove this code?
         if &#40;$got_sig_child&#41; {
-          if &#40;time&#40;&#41; - $got_sig_child &gt; 10&#41; {
+          if &#40;$now - $got_sig_child &gt; 10&#41; {
             print STDERR &#34;waitpid did not return -1 for 10 seconds after SIG_CHLD, killing [$pid]\n&#34;;
             kill &#40;-9, $pid&#41;;
             $child_finished = 1;
@@ -776,6 +798,7 @@
         &#39;merged&#39; =&gt; $child_merged,
         &#39;timeout&#39; =&gt; $child_timedout ? $opts-&gt;{&#39;timeout&#39;} : 0,
         &#39;exit_code&#39; =&gt; $child_exit_code,
+             &#39;parent_died&#39; =&gt; $parent_died,
         };

       my $err_msg = &#39;&#39;;
@@ -785,6 +808,9 @@
       if &#40;$o-&gt;{&#39;timeout&#39;}&#41; {
         $err_msg .= &#34;ran more than [$o-&gt;{&#39;timeout&#39;}] seconds\n&#34;;
       }
+      if &#40;$o-&gt;{&#39;parent_died&#39;}&#41; {
+        $err_msg .= &#34;parent died\n&#34;;
+      }
       if &#40;$o-&gt;{&#39;stdout&#39;}&#41; {
         $err_msg .= &#34;stdout:\n&#34; . $o-&gt;{&#39;stdout&#39;} . &#34;\n&#34;;
       }
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-761867" href="/Public/Bug/Display.html?id=50398#txn-761867">#</a>      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;12&nbsp;04:06:13&nbsp;2010</span>
    <span class="description">http://lj.rossia.org/users/nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/761867/394103/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/394103">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 248b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space"><span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; thanks for integrating previous patch,
&gt; hope this is not too opften but here&#39;s another one.
&gt; 
&gt; It fixes obvious typo in previous patch
&gt; and adds another very useful feature
</div>
Attaching patch as a file
as it is not quite readable as a comment.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> kohts-ipc-cmd-0.56-terminate_on_parent.diff</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/761867/394104/kohts-ipc-cmd-0.56-terminate_on_parent.diff">Download kohts-ipc-cmd-0.56-terminate_on_parent.diff</a><br />
<span class="downloadcontenttype">text/x-diff 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Cmd.pm.orig	2010-02-03 17:16:47.000000000 +0300
+++ Cmd.pm	2010-04-12 11:59:41.000000000 +0400
@@ -360,6 +360,10 @@
     $wait_cycles = $wait_cycles + 1;
     Time::HiRes::usleep&#40;250000&#41;; # half a second
   }
+
+  if &#40;!$child_finished&#41; {
+    kill&#40;9, $pid&#41;;
+  }
 }
 
 sub open3_run {
@@ -651,7 +655,6 @@
       close&#40;$parent_stderr_socket&#41;;
       close&#40;$parent_info_socket&#41;;
 
-      my $child_timedout = 0;
       my $flags;
 
       # prepare sockets to read from child
@@ -673,11 +676,13 @@
 
   #    print &#34;child $pid started\n&#34;;
 
+      my $child_timedout = 0;
       my $child_finished = 0;
       my $child_stdout = &#39;&#39;;
       my $child_stderr = &#39;&#39;;
       my $child_merged = &#39;&#39;;
       my $child_exit_code = 0;
+      my $parent_died = 0;
 
       my $got_sig_child = 0;
       $SIG{&#39;CHLD&#39;} = sub { $got_sig_child = time&#40;&#41;; };
@@ -685,9 +690,26 @@
       my $child_child_pid;
 
       while &#40;!$child_finished&#41; {
+        my $now = time&#40;&#41;;
+
+        if &#40;$opts-&gt;{&#39;terminate_on_parent_sudden_death&#39;}&#41; {
+          $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} = 0
+            unless defined&#40;$opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;}&#41;;
+
+          # check for parent once each five seconds
+          if &#40;$now - $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} &gt; 5&#41; {
+            if &#40;getppid&#40;&#41; eq &#34;1&#34;&#41; {
+              kill &#40;-9, $pid&#41;;
+              $parent_died = 1;
+            }
+
+            $opts-&gt;{&#39;runtime&#39;}-&gt;{&#39;last_parent_check&#39;} = $now;
+          }
+        }
+
         # user specified timeout
         if &#40;$opts-&gt;{&#39;timeout&#39;}&#41; {
-          if &#40;time&#40;&#41; - $start_time &gt; $opts-&gt;{&#39;timeout&#39;}&#41; {
+          if &#40;$now - $start_time &gt; $opts-&gt;{&#39;timeout&#39;}&#41; {
             kill &#40;-9, $pid&#41;;
             $child_timedout = 1;
           }
@@ -697,7 +719,7 @@
         # kill process after that and finish wait loop;
         # shouldn&#39;t ever happen -- remove this code?
         if &#40;$got_sig_child&#41; {
-          if &#40;time&#40;&#41; - $got_sig_child &gt; 10&#41; {
+          if &#40;$now - $got_sig_child &gt; 10&#41; {
             print STDERR &#34;waitpid did not return -1 for 10 seconds after SIG_CHLD, killing [$pid]\n&#34;;
             kill &#40;-9, $pid&#41;;
             $child_finished = 1;
@@ -776,6 +798,7 @@
         &#39;merged&#39; =&gt; $child_merged,
         &#39;timeout&#39; =&gt; $child_timedout ? $opts-&gt;{&#39;timeout&#39;} : 0,
         &#39;exit_code&#39; =&gt; $child_exit_code,
+	      &#39;parent_died&#39; =&gt; $parent_died,
         };
 
       my $err_msg = &#39;&#39;;
@@ -785,6 +808,9 @@
       if &#40;$o-&gt;{&#39;timeout&#39;}&#41; {
         $err_msg .= &#34;ran more than [$o-&gt;{&#39;timeout&#39;}] seconds\n&#34;;
       }
+      if &#40;$o-&gt;{&#39;parent_died&#39;}&#41; {
+        $err_msg .= &#34;parent died\n&#34;;
+      }
       if &#40;$o-&gt;{&#39;stdout&#39;}&#41; {
         $err_msg .= &#34;stdout:\n&#34; . $o-&gt;{&#39;stdout&#39;} . &#34;\n&#34;;
       }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-794254" href="/Public/Bug/Display.html?id=50398#txn-794254">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;22&nbsp;10:37:30&nbsp;2010</span>
    <span class="description">http://lj.rossia.org/~nit/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/794254/411752/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/411752">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 729b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Chris,

thanks again for handling patches.

I&#39;ve got a bit of new stuff which allows
more flebixle configuration of termination
of run_forked and its children.

These are three parameters:

1&#41; terminate_on_signal -- specifies
that run_forked should stop child
if it receives specified signal
&#40;not compatible with POSIX::SigAction,
which doesn&#39;t update %SIG&#41;

2&#41; terminate_wait_time -- specifies
how long run_forked waits after sending
TERM to its children before sending KILL

3&#41; clean_up_children -- specifies than run_forked
should end all the &#40;possible&#41; children processes
which were spawned by child, sending KILL signal
to whole child process group after child is stopped.


Please find attached patch.


Luck,
Petya.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> kohts-cmd-termination.patch</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/794254/411753/kohts-cmd-termination.patch">Download kohts-cmd-termination.patch</a><br />
<span class="downloadcontenttype">text/x-diff 6.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- Cmd.pm.orig	2010-04-29 23:47:00.000000000 +0400
+++ Cmd.pm	2010-06-22 17:36:21.000000000 +0400
@@ -340,29 +340,89 @@
     return $CAN_USE_RUN_FORKED eq &#34;1&#34;;
 }
 
+# incompatible with POSIX::SigAction
+#
+sub install_layered_signal {
+  my &#40;$s, $handler_code&#41; = @_;
+
+  my %available_signals = map {$_ =&gt; 1} keys %SIG;
+
+  die&#40;&#34;install_layered_signal got nonexistent signal name [$s]&#34;&#41;
+    unless defined&#40;$available_signals{$s}&#41;;
+  die&#40;&#34;install_layered_signal expects coderef&#34;&#41;
+    if !ref&#40;$handler_code&#41; || ref&#40;$handler_code&#41; ne &#39;CODE&#39;;
+
+  my $previous_handler = $SIG{$s};
+
+  my $sig_handler = sub {
+    my &#40;$called_sig_name, @sig_param&#41; = @_;
+    
+    # $s is a closure refering to real signal name
+    # for which this handler is being installed.
+    # it is used to distinguish between
+    # real signal handlers and aliased signal handlers
+    my $signal_name = $s;
+
+    # $called_sig_name is a signal name which
+    # was passed to this signal handler;
+    # it doesn&#39;t equal $signal_name in case
+    # some signal handlers in %SIG point
+    # to other signal handler &#40;CHLD and CLD,
+    # ABRT and IOT&#41;
+    #
+    # initial signal handler for aliased signal
+    # calles some other signal handler which
+    # should not execute the same handler_code again
+    if &#40;$called_sig_name eq $signal_name&#41; {
+      $handler_code-&gt;&#40;$signal_name&#41;;
+    }
+
+    # run original signal handler if any &#40;including aliased&#41;
+    #
+    if &#40;ref&#40;$previous_handler&#41;&#41; {
+      $previous_handler-&gt;&#40;$called_sig_name, @sig_param&#41;;
+    }
+  };
+
+  $SIG{$s} = $sig_handler;
+}
+
 # give process a chance sending TERM,
 # waiting for a while &#40;2 seconds&#41;
 # and killing it with KILL
 sub kill_gently {
-  my &#40;$pid&#41; = @_;
+  my &#40;$pid, $opts&#41; = @_;
+  
+  $opts = {} unless $opts;
+  $opts-&gt;{&#39;wait_time&#39;} = 2 unless defined&#40;$opts-&gt;{&#39;wait_time&#39;}&#41;;
+  $opts-&gt;{&#39;first_kill_type&#39;} = &#39;just_process&#39; unless $opts-&gt;{&#39;first_kill_type&#39;};
+  $opts-&gt;{&#39;final_kill_type&#39;} = &#39;just_process&#39; unless $opts-&gt;{&#39;final_kill_type&#39;};
   
-  kill&#40;15, $pid&#41;;
+  if &#40;$opts-&gt;{&#39;first_kill_type&#39;} eq &#39;just_process&#39;&#41; {
+    kill&#40;15, $pid&#41;;
+  }
+  elsif &#40;$opts-&gt;{&#39;first_kill_type&#39;} eq &#39;process_group&#39;&#41; {
+    kill&#40;-15, $pid&#41;;
+  }
   
-  my $wait_cycles = 0;
   my $child_finished = 0;
+  my $wait_start_time = time&#40;&#41;;
 
-  while &#40;!$child_finished &#38;&#38; $wait_cycles &lt; 8&#41; {
+  while &#40;!$child_finished &#38;&#38; $wait_start_time + $opts-&gt;{&#39;wait_time&#39;} &gt; time&#40;&#41;&#41; {
     my $waitpid = waitpid&#40;$pid, WNOHANG&#41;;
     if &#40;$waitpid eq -1&#41; {
       $child_finished = 1;
     }
-
-    $wait_cycles = $wait_cycles + 1;
-    Time::HiRes::usleep&#40;250000&#41;; # half a second
+    Time::HiRes::usleep&#40;250000&#41;; # quarter of a second
   }
 
   if &#40;!$child_finished&#41; {
-    kill&#40;9, $pid&#41;;
+    if &#40;$opts-&gt;{&#39;final_kill_type&#39;} eq &#39;just_process&#39;&#41; {
+      kill&#40;9, $pid&#41;;
+    }
+    elsif &#40;$opts-&gt;{&#39;final_kill_type&#39;} eq &#39;process_group&#39;&#41; {
+      kill&#40;-9, $pid&#41;;
+    }
   }
 }
 
@@ -454,9 +514,16 @@
     }
 
     if &#40;$got_sig_child&#41; {
-      if &#40;time&#40;&#41; - $got_sig_child &gt; 10&#41; {
-        print STDERR &#34;select-&gt;can_read did not return 0 for 10 seconds after SIG_CHLD, killing [$pid]\n&#34;;
-        kill &#40;-9, $pid&#41;;
+      if &#40;time&#40;&#41; - $got_sig_child &gt; 1&#41; {
+        # select-&gt;can_read doesn&#39;t return 0 after SIG_CHLD
+        #
+        # &#34;On POSIX-compliant platforms, SIGCHLD is the signal
+        # sent to a process when a child process terminates.&#34;
+        # <span class="clickylink"><a target="new" rel="nofollow" href="http://en.wikipedia.org/wiki/SIGCHLD">http://en.wikipedia.org/wiki/SIGCHLD</a></span>
+        #
+        # nevertheless kill KILL wouldn&#39;t break anything here
+        #
+        kill &#40;9, $pid&#41;;
         $child_finished = 1;
       }
     }
@@ -491,8 +558,9 @@
 
   waitpid&#40;$pid, 0&#41;;
 
-  # i&#39;ve successfully reaped my child,
-  # let my parent know this
+  # since we&#39;ve successfully reaped the child,
+  # let our parent know about this.
+  #
   if &#40;$opts-&gt;{&#39;parent_info&#39;}&#41; {
     my $ps = $opts-&gt;{&#39;parent_info&#39;};
     print $ps &#34;reaped $pid\n&#34;;
@@ -629,6 +697,7 @@
 
     $opts = {} unless $opts;
     $opts-&gt;{&#39;timeout&#39;} = 0 unless $opts-&gt;{&#39;timeout&#39;};
+    $opts-&gt;{&#39;terminate_wait_time&#39;} = 2 unless defined&#40;$opts-&gt;{&#39;terminate_wait_time&#39;}&#41;;
 
     # sockets to pass child stdout to parent
     my $child_stdout_socket;
@@ -696,8 +765,13 @@
       my $parent_died = 0;
 
       my $got_sig_child = 0;
+      my $got_sig_quit = 0;
       $SIG{&#39;CHLD&#39;} = sub { $got_sig_child = time&#40;&#41;; };
 
+      if &#40;$opts-&gt;{&#39;terminate_on_signal&#39;}&#41; {
+        install_layered_signal&#40;$opts-&gt;{&#39;terminate_on_signal&#39;}, sub { $got_sig_quit = time&#40;&#41;; }&#41;;
+      }
+
       my $child_child_pid;
 
       while &#40;!$child_finished&#41; {
@@ -737,6 +811,15 @@
           }
         }
 
+        if &#40;$got_sig_quit&#41; {
+          kill_gently &#40;$pid, {
+            &#39;first_kill_type&#39; =&gt; &#39;process_group&#39;,
+            &#39;final_kill_type&#39; =&gt; &#39;process_group&#39;,
+            &#39;wait_time&#39; =&gt; $opts-&gt;{&#39;terminate_wait_time&#39;}
+            }&#41;;
+          $child_finished = 1;
+        }
+
         my $waitpid = waitpid&#40;$pid, WNOHANG&#41;;
 
         # child finished, catch it&#39;s exit status
@@ -762,7 +845,7 @@
         }
 
         while &#40;my $l = &lt;$child_stdout_socket&gt;&#41; {
-          if &#40;!$opts-&gt;{discard_output}&#41; {
+          if &#40;!$opts-&gt;{&#39;discard_output&#39;}&#41; {
             $child_stdout .= $l;
             $child_merged .= $l;
           }
@@ -772,7 +855,7 @@
           }
         }
         while &#40;my $l = &lt;$child_stderr_socket&gt;&#41; {
-          if &#40;!$opts-&gt;{discard_output}&#41; {
+          if &#40;!$opts-&gt;{&#39;discard_output&#39;}&#41; {
             $child_stderr .= $l;
             $child_merged .= $l;
           }
@@ -800,6 +883,23 @@
         kill_gently&#40;$child_child_pid&#41;;
       }
 
+      # in case there are forks in child which
+      # do not forward or process signals &#40;TERM&#41; correctly
+      # kill whole child process group, effectively trying
+      # not to return with some children or their parts still running
+      #
+      # to be more accurate -- we need to be sure
+      # that this is process group created by our child
+      # &#40;and not some other process group with the same pgid,
+      # created just after death of our child&#41; -- fortunately
+      # this might happen only when process group ids
+      # are reused quickly &#40;there are lots of processes
+      # spawning new process groups for example&#41;
+      #
+      if &#40;$opts-&gt;{&#39;clean_up_children&#39;}&#41; {
+        kill&#40;-9, $pid&#41;;
+      }
+
   #    print &#34;child $pid finished\n&#34;;
 
       close&#40;$child_stdout_socket&#41;;
@@ -812,7 +912,8 @@
         &#39;merged&#39; =&gt; $child_merged,
         &#39;timeout&#39; =&gt; $child_timedout ? $opts-&gt;{&#39;timeout&#39;} : 0,
         &#39;exit_code&#39; =&gt; $child_exit_code,
-       &#39;parent_died&#39; =&gt; $parent_died,
+        &#39;parent_died&#39; =&gt; $parent_died,
+        &#39;child_pgid&#39; =&gt; $pid,
         };
 
       my $err_msg = &#39;&#39;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-844918" href="/Public/Bug/Display.html?id=50398#txn-844918">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;19&nbsp;10:30:05&nbsp;2010</span>
    <span class="description">BINGOS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken">30 min</span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/844918/437438/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/437438">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1009b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thanks, patches have been applied and released.

Changes for 0.60    Mon Jul  5 09:04:54 BST 2010
=================================================
* Corrected spelling mistakes in POD, spotted by H.Merijn Brand
* Apply a patch from Burak Gursoy RT #58886, which fixes paths
  on MSWin32
* Apply patch from Petya Kohts, RT #50398, which allows more
  flexible configuration of run_forked and its children

Changes for 0.58    Thu Apr 29 20:49:07 BST 2010
=================================================
* Applied patch from Petya Kohts, RT #50398, which
  adds &#39;terminate_on_parent_sudden_death&#39; option to
  run_forked&#40;&#41;.
* Applied patches from David Morel RT #56973, which
  add &#39;discard_output&#39; option to run_forked&#40;&#41;.
* Added documentation as suggested by Rafa&lt;C3&gt;&lt;AB&gt;l Garcia-Suarez
  in RT #56973

Changes for 0.56    Wed Feb  3 14:17:00 GMT 2010
=================================================
* Applied patch from Petya Kohts, RT #50398, which
  updates run_forked&#40;&#41; to allow coderefs

Many thanks.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-844921" href="/Public/Bug/Display.html?id=50398#txn-844921">#</a>      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;19&nbsp;10:30:06&nbsp;2010</span>
    <span class="description">BINGOS [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1348688" href="/Public/Bug/Display.html?id=50398#txn-1348688">#</a>      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;09&nbsp;18:48:11&nbsp;2014</span>
    <span class="description">avar [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1348688/715682/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/715682">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.8k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2009-11-04T06:42:26-05:00, <span class="clickylink"><a target="new" rel="nofollow" href="http://lj.rossia.org/users/nit/">http://lj.rossia.org/users/nit/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Ok, well let&#39;s start with the most recent version of the patch;
&gt; &gt; important is that the code paths can&#39;t be triggered
&gt; &gt; from Win32 and then we can feed it to CPAN testers
&gt; &gt; to see if it&#39;s stable across platforms.
</div>&gt; 
&gt; Attaching most recent version of patch
&gt; done against IPC::Cmd 0.50.
&gt; 
&gt; I&#39;ve created two different calls which
&gt; were not defined by IPC::Cmd before:
&gt; run_forked and can_use_run_forked.
&gt; 
&gt; The plan is to include run_forked into your module
&gt; but leave current functionality unmodified --
&gt; and allow people to choose which interface to use.
&gt; 
&gt; NB: i&#39;ve totally disabled function on VMS and Windows,
&gt; test suite returns ok&#40;1, &#34;platform not supported&#34;&#41; for these.
&gt; 
&gt; 
&gt; Here&#39;s usage example:
&gt; 
&gt; use IPC::Cmd;
&gt; 
&gt; my $r = IPC::Cmd::run_forked&#40;&#34;sleep 4&#34;, {&#39;timeout&#39; =&gt; 1}&#41;;
&gt; if &#40;$r-&gt;{&#39;timeout&#39;}&#41; {
&gt;   print &#34;command timed out\n&#34;;
&gt; }
&gt; print $r-&gt;{&#39;stdout&#39;} . &#34;\n&#34;;
&gt; print $r-&gt;{&#39;stderr&#39;} . &#34;\n&#34;;
&gt; 
&gt; Syntax is a bit different from your calls
&gt; but you could easily adapt it if you need
&gt; &#40;though I suggest you leave it as it is,
&gt; as it saves typing&#41;.
&gt; 
&gt; 
&gt; Here&#39;s test suite for the function
&gt; &#40;should be altered to use blib/:
&gt; #!/usr/bin/perl
&gt; 
&gt; use strict;
&gt; use warnings;
&gt; 
&gt; use Test::More &#39;no_plan&#39;;
&gt; 
&gt; #use lib &#34;/root/i&#34;;
&gt; use IPC::Cmd;
&gt; 
&gt; if &#40;!IPC::Cmd::can_use_run_forked&#40;&#41;&#41; {
&gt;   ok&#40;1, &#34;run_forked not available on this platform&#34;&#41;;
&gt;   exit;
&gt; }
&gt; 
&gt; my $cmd = &#34;echo out ; echo err &gt;&#38;2 ; sleep 4&#34;;
&gt; my $r = IPC::Cmd::run_forked&#40;$cmd, {&#39;timeout&#39; =&gt; 1}&#41;;
&gt; 
&gt; ok&#40;ref&#40;$r&#41; eq &#39;HASH&#39;, &#34;executed: $cmd&#34;&#41;;
&gt; ok&#40;$r-&gt;{&#39;timeout&#39;} eq 1, &#34;timed out&#34;&#41;;
&gt; ok&#40;$r-&gt;{&#39;stdout&#39;}, &#34;stdout: &#34; . $r-&gt;{&#39;stdout&#39;}&#41;;
&gt; ok&#40;$r-&gt;{&#39;stderr&#39;}, &#34;stderr: &#34; . $r-&gt;{&#39;stderr&#39;}&#41;;
</div>
This code had a bad bug related to signal clobbering that I fixed in <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/jib/ipc-cmd/pull/13">https://github.com/jib/ipc-cmd/pull/13</a></span>
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 1.053666</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
