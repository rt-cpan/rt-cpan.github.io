<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #118899 for B-Hooks-OP-Check: Check.xs Segfault In mod_perl</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #118899 for B-Hooks-OP-Check: Check.xs Segfault In mod_perl</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=B-Hooks-OP-Check">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=B-Hooks-OP-Check">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=B-Hooks-OP-Check">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=B-Hooks-OP-Check">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/B-Hooks-OP-Check">B-Hooks-OP-Check CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">118899</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=B-Hooks-OP-Check">B-Hooks-OP-Check</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">ZEFRAM [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
WBRASWELL [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Critical    </td>
  </tr>
  <tr id="CF-223998-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
0.17</li>
<li>
0.18</li>
<li>
0.19</li>
</ul>
    </td>
  </tr>
  <tr id="CF-223999-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




segfault_gdb.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1685257/904799/segfault_gdb.txt">
Tue Nov 22 04:47:11 2016 (14.8k) by WBRASWELL [...] cpan.org
</a>
</font></li>
</ul>


segfault_versions.txt<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1685257/904800/segfault_versions.txt">
Tue Nov 22 04:47:11 2016 (551b) by WBRASWELL [...] cpan.org
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=118899">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1685257" href="/Public/Bug/Display.html?id=118899#txn-1685257">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;22&nbsp;04:47:11&nbsp;2016</span>
    <span class="description">WBRASWELL [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Check.xs Segfault In mod_perl</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1685257/904798/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/904798">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 7.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello Everyone,

I am attempting to run an already-bug-free Catalyst application under mod_perl, which should work just fine but instead gives a segfault in the Check.xs file.

The name of the Catalyst application is ShinyCMS, it works just fine using the PSGI stand-alone testing web server as well as fastcgi, and mod_perl is the only option which causes a segfault.  Unfortunately, I must have mod_perl support for my specific use of ShinyCMS, so I really really need to fix this segfault and get Shiny working under mod_perl.  Yes, Shiny is specifically designed to work with mod_perl, as are most Catalyst apps.  In fact, my simple &#34;&lt;&lt;&lt; DEBUG &gt;&gt;&gt;&#34; print statements in ShinyCMS.pm show that Shiny is totally loading and returning control back to Apache &#40;or mod_perl?&#41; before the actual segfault occurs.

My system info:

$ apache2 -v
Server version: Apache/2.4.18 &#40;Ubuntu&#41;
Server built:   2016-07-14T12:32:26

$ perl -v
This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64-linux-gnu-thread-multi
&#40;with 58 registered patches, see perl -V for more detail&#41;

$ pm_version.pl mod_perl2
$mod_perl2::VERSION = 2.000009

$ pm_version.pl B::Hooks::OP::Check
$B::Hooks::OP::Check::VERSION = 0.19

$ cat /etc/issue
Ubuntu 16.04.1 LTS

I have spent the last week trying all of the following and more, but the segfault persists:

1.  manually-compiled perl v5.22.1 &#38; mod_perl2 v2.000009 w/out threads
2.  mod_perl2 back to v2.000005
3.  B::Hooks::OP::Check back to v0.17 &#40;maybe earlier&#41;
4.  move all possible &#39;use&#39; statements to be called as early as possible in Shiny_dependencies.pm

I also tried Apache v2.2 &#38; mod_perl2 v2.000008 &#38; Perl v5.18.2 in Ubuntu v14.04, it did not segfault but instead it served up totally blank pages with 0 bytes of data.  I have not dug deeper because I use Ubuntu v16.04 in production and I figure it is harder to debug w/out an actual segfault to start from.

I have set up SSH access on a cloud server so you can see and debug the segfault directly, all 3 of the usernames below are set as sudoers so please wield your root powers with caution:

HOSTNAME: cloud-comp0-00.autoparallel.com
HOST IP:  64.137.255.53
USERNAME: zefram OR flora OR bhooks_team
PASSWORD: check your CPAN e-mail address

Pertinent paths:

/home/wbraswell/public_html/cloud-comp0-00.autoparallel.com-latest
/etc/apache2/sites-available/cloud-comp0-00.autoparallel.com.conf

Here is an example gdb showing Check.xs as the likely culprit, starting with `sudo` and then `source` to load Apache env vars:

[[[ BEGIN GDB SESSION ]]]

zefram@cloud-comp0-00:/$ sudo -i
...
root@cloud-comp0-00:~# source /etc/apache2/envvars
root@cloud-comp0-00:~# gdb /usr/sbin/apache2
...
Reading symbols from /usr/sbin/apache2...&#40;no debugging symbols found&#41;...done.

&#40;gdb&#41; run -k start -X
Starting program: /usr/sbin/apache2 -k start -X
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: top of ShinyCMS.pm
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Moose
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Catalyst::Runtime
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Catalyst
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use CatalystX::RoleApplicator
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Method::Signatures::Simple
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to call config&#40;&#41;
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, have __PACKAGE__ = ShinyCMS
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to call setup&#40;&#41;...
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, returned from setup&#40;&#41;
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to return 1

Program received signal SIGSEGV, Segmentation fault.
0x00007fffebabcb10 in ?? &#40;&#41;
&#40;gdb&#41; bt
#0  0x00007fffebabcb10 in ?? &#40;&#41;
#1  0x00007ffff3e5302b in Perl_newUNOP &#40;my_perl=my_perl@entry=0x5555577ddde0, type=type@entry=17, flags=&lt;optimized out&gt;, flags@entry=8192, first=0x5555562141b8&#41; at op.c:4811
#2  0x00007ffff3e54a1d in Perl_newCVREF &#40;my_perl=my_perl@entry=0x5555577ddde0, flags=flags@entry=8192, o=&lt;optimized out&gt;&#41; at op.c:9367
#3  0x00007ffff3e8b686 in Perl_yylex &#40;my_perl=my_perl@entry=0x5555577ddde0&#41; at toke.c:6693
#4  0x00007ffff3e97228 in Perl_yyparse &#40;my_perl=my_perl@entry=0x5555577ddde0, gramtype=gramtype@entry=258&#41; at perly.c:322
...
#44 0x000055555558709f in main &#40;&#41;

&#40;gdb&#41; start
The program being debugged has been started already.
Start it from the beginning? &#40;y or n&#41; y
Temporary breakpoint 1 at 0x5555555867b0
Starting program: /usr/sbin/apache2 -k start -X
[Thread debugging using libthread_db enabled]
Using host libthread_db library &#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;.

Temporary breakpoint 1, 0x00005555555867b0 in main &#40;&#41;

&#40;gdb&#41; break perl_parse
Function &#34;perl_parse&#34; not defined.
Make breakpoint pending on future shared library load? &#40;y or [n]&#41; y
Breakpoint 2 &#40;perl_parse&#41; pending.

&#40;gdb&#41; continue
Continuing.

Breakpoint 2, perl_parse &#40;my_perl=0x55555581ae50, xsinit=0x7ffff420a280, argc=2, argv=0x7ffff7f88070, env=0x0&#41; at perl.c:1473
1473    perl.c: No such file or directory.

&#40;gdb&#41; watch -l PL_check[17]
Hardware watchpoint 3: -location PL_check[17]

&#40;gdb&#41; continue
Continuing.

Hardware watchpoint 3: -location PL_check[17]

Old value = &#40;OP *&#40;*&#41;&#40;PerlInterpreter *, OP *&#41;&#41; 0x7ffff3e4d9e0 &lt;Perl_ck_rvconst&gt;
New value = &#40;OP *&#40;*&#41;&#40;PerlInterpreter *, OP *&#41;&#41; 0x7fffebabcb10 &lt;check_cb&gt;
0x00007fffebabcd0e in hook_op_check &#40;type=type@entry=OP_RV2CV, cb=cb@entry=0x7fffeb8b6d30 &lt;dd_ck_rv2cv&gt;, user_data=user_data@entry=0x0&#41; at Check.xs:66
66                      PL_check[type] = check_cb;

&#40;gdb&#41; info threads
  Id   Target Id         Frame 
* 1    Thread 0x7ffff7fe2780 &#40;LWP 6196&#41; &#34;/usr/sbin/apach&#34; 0x00007fffebabcd0e in hook_op_check &#40;type=type@entry=OP_RV2CV, cb=cb@entry=0x7fffeb8b6d30 &lt;dd_ck_rv2cv&gt;, user_data=user_data@entry=0x0&#41;
    at Check.xs:66

&#40;gdb&#41; info source
Current source file is Check.xs
Compilation directory is /home/wbraswell/.cpanm/work/1479735542.24787/B-Hooks-OP-Check-0.19
Located in /home/wbraswell/.cpanm/work/1479735542.24787/B-Hooks-OP-Check-0.19/Check.xs
Contains 106 lines.
Source language is c.
Producer is GNU C11 5.4.0 20160609 -mtune=generic -march=x86-64 -g -O2 -fwrapv -fno-strict-aliasing -fPIC -fstack-protector-strong.
Compiled with DWARF 2 debugging format.
Does not include preprocessor macro info.

&#40;gdb&#41; continue
Continuing.
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: top of ShinyCMS.pm
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Moose
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Catalyst::Runtime
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Catalyst
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use CatalystX::RoleApplicator
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to use Method::Signatures::Simple
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to call config&#40;&#41;
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, have __PACKAGE__ = ShinyCMS
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to call setup&#40;&#41;...
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, returned from setup&#40;&#41;
&lt;&lt;&lt; DEBUG &gt;&gt;&gt;: in ShinyCMS.pm, about to return 1

...

Program received signal SIGSEGV, Segmentation fault.
0x00007fffebabcb10 in ?? &#40;&#41;
&#40;gdb&#41; bt
#0  0x00007fffebabcb10 in ?? &#40;&#41;
#1  0x00007ffff3e5302b in Perl_newUNOP &#40;my_perl=my_perl@entry=0x555559dd8ed0, type=type@entry=17, flags=&lt;optimized out&gt;, flags@entry=8192, first=0x55555824eb98&#41; at op.c:4811
#2  0x00007ffff3e54a1d in Perl_newCVREF &#40;my_perl=my_perl@entry=0x555559dd8ed0, flags=flags@entry=8192, o=&lt;optimized out&gt;&#41; at op.c:9367
...
#44 0x000055555558709f in main &#40;&#41;

&#40;gdb&#41; print PL_check[17]
$1 = &#40;Perl_check_t&#41; 0x7fffebabcb10

&#40;gdb&#41; quit

[[[ END GDB SESSION ]]]

I have attached the unabbreviated gdb session and the system info in text files, for your reference.

I am anxious &#40;near desperate&#41; to get this bug fixed so that I can move forward with my work.  I will eagerly assist in any way I can, please just let me know what I should do and I will do it!

Thanks so much for your help.

Perling,
~ Will
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfault_gdb.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1685257/904799/segfault_gdb.txt">Download segfault_gdb.txt</a><br />
<span class="downloadcontenttype">text/plain 14.8k</span>
</div>
<div class="messagebody">
<p>Message body is not shown because it is too large.</p></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> segfault_versions.txt</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1685257/904800/segfault_versions.txt">Download segfault_versions.txt</a><br />
<span class="downloadcontenttype">text/plain 551b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">wbraswell@cloud-comp0-00:~$ apache2 -v
Server version: Apache/2.4.18 &#40;Ubuntu&#41;
Server built:   2016-07-14T12:32:26


wbraswell@cloud-comp0-00:~$ perl -v
This is perl 5, version 22, subversion 1 &#40;v5.22.1&#41; built for x86_64-linux-gnu-thread-multi
&#40;with 58 registered patches, see perl -V for more detail&#41;


wbraswell@cloud-comp0-00:~$ pm_version.pl mod_perl2
$mod_perl2::VERSION = 2.000009


wbraswell@cloud-comp0-00:~$ pm_version.pl B::Hooks::OP::Check
$B::Hooks::OP::Check::VERSION = 0.19


wbraswell@cloud-comp0-00:~$ cat /etc/issue
Ubuntu 16.04.1 LTS
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1685293" href="/Public/Bug/Display.html?id=118899#txn-1685293">#</a>      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;22&nbsp;09:18:20&nbsp;2016</span>
    <span class="description">WBRASWELL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1685293/904827/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/904827">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 468b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">I forgot to mention I also have already tried mod_perl v2.0.10 on my personal &#40;non-cloud&#41; testing system and I was still getting the segfault.

I have now updated mod_perl on the cloud server from v2.0.9 to v2.0.10, and again we are still getting the same segfault as before.

So now you can log into the cloud server and use gdb to see the segfault in action, you should have a private e-mail with the SSH login credentials, if not please let me know.

Thanks,
~ Will
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1690226" href="/Public/Bug/Display.html?id=118899#txn-1690226">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;13&nbsp;06:45:03&nbsp;2016</span>
    <span class="description">HJANSEN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1690226/907596/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/907596">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.7k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">WeÂ´re using a custom multithreaded C++ application in which the original developers embedded a perl interpreter as a means to extend the functionality implemented in C++.
Most of the time executing the perl code works just fine. But sometimes we see a segfault and in these cases when walking from the lowest stack entry upwards it seems that &#34;check_cb&#34; in Check.xs from B::Hooks::OP::Check is the first common element.

Some abbreviated stacks to illustrate this:


#0  S_mg_findext_flags &#40;my_perl=0x2b1e8e0fd480, flags=0, vtbl=0x0, type=type@entry=126, sv=sv@entry=0x6d702e65636e6174&#41; at mg.c:400
#1  Perl_mg_find &#40;my_perl=0x2b1e8e0fd480, sv=sv@entry=0x6d702e65636e6174, type=type@entry=126&#41; at mg.c:421
#2  0x00002b1ee98cdc92 in get_mg_ptr &#40;sv=0x6d702e65636e6174&#41; at Check.xs:20
#3  0x00002b1ee98cdd77 in check_cb &#40;my_perl=&lt;optimized out&gt;, op=&lt;optimized out&gt;&#41; at Check.xs:46


#0  0x00002b1e82642d59 in S_av_top_index &#40;av=av@entry=0x2b1e8e2411b0, my_perl=0x2b1e8dc72aa0&#41; at inline.h:23
#1  Perl_av_len &#40;my_perl=0x2b1e8dc72aa0, av=av@entry=0x2b1e8e2411b0&#41; at av.c:764
#2  0x00002b1ee98cdd46 in check_cb &#40;my_perl=&lt;optimized out&gt;, op=&lt;optimized out&gt;&#41; at Check.xs:37


#0  0x00002b1e826423a3 in Perl_av_fetch &#40;my_perl=0x2b1eadcccf30, av=av@entry=0x2b1eae2410f0, key=key@entry=0, lval=lval@entry=0&#41; at av.c:253
#1  0x00002b1ee98cdd62 in check_cb &#40;my_perl=&lt;optimized out&gt;, op=&lt;optimized out&gt;&#41; at Check.xs:40


WeÂ´re using B::Hooks::OP::Check 0.19.
Perl is &#34;perl 5, version 18, subversion 2 &#40;v5.18.2&#41; built for x86_64-linux-thread-multi&#34; as provided by &#34;SUSE Linux Enterprise Server 12&#34;.

So it might be that we see the same error as reported here. Unfortunately my C++ and XS knowledge is rather limited. Please let me know if can do anything else to help finding out what is going on and if our issue is really related to this bug report.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1690227" href="/Public/Bug/Display.html?id=118899#txn-1690227">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;13&nbsp;06:45:04&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1691482" href="/Public/Bug/Display.html?id=118899#txn-1691482">#</a>      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;19&nbsp;06:59:50&nbsp;2016</span>
    <span class="description">HJANSEN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1691482/908267/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/908267">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 617b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">So in our case we found that B::Hooks::Check::OP was included only fairly recently as a dependency of TryCatch.

Commenting all &#34;try { ... } catch { ... }&#34; statements did not help unless we also commented all &#34;use TryCatch;&#34; statements. But once weÂ´d done that, the app stopped dumping SEGV cores!!

IÂ´m not sure if the error lies with how TryCatch uses B::Hooks::Check::OP or in B::Hooks::Check::OP itself; since I havenÂ´t seen SEGVs in a Mojolicious app which makes use of TryCatch, executing the perl code through an interpreter embedded in a &#40;multithreaded?&#41; C/C++ software might be the distinguishing factor.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1694062" href="/Public/Bug/Display.html?id=118899#txn-1694062">#</a>      
    </span>
    <span class="date">Tue&nbsp;Dec&nbsp;27&nbsp;16:11:08&nbsp;2016</span>
    <span class="description">WBRASWELL [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1694062/909765/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/909765">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 1.1k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Heiko,

I appreciate your response &#38; possible solution!

Yes, your problem sounds very very similar.

For the time being, I have stopped trying to get mod_perl to work; however, this bug remains active and I may have to revisit it at some point in the future if I ever need to get my application working in mod_perl for some reason.

I hope Zefram and/or the other admins will look into this for the sake of anyone else who may suffer from this bug down the road.

Thanks everyone!

Perling,
~ Will the Chill



On Mon Dec 19 06:59:50 2016, HJANSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; So in our case we found that B::Hooks::Check::OP was included only
&gt; fairly recently as a dependency of TryCatch.
&gt; 
&gt; Commenting all &#34;try { ... } catch { ... }&#34; statements did not help
&gt; unless we also commented all &#34;use TryCatch;&#34; statements. But once weÂ´d
&gt; done that, the app stopped dumping SEGV cores!!
&gt; 
&gt; IÂ´m not sure if the error lies with how TryCatch uses
&gt; B::Hooks::Check::OP or in B::Hooks::Check::OP itself; since I havenÂ´t
&gt; seen SEGVs in a Mojolicious app which makes use of TryCatch, executing
&gt; the perl code through an interpreter embedded in a &#40;multithreaded?&#41;
&gt; C/C++ software might be the distinguishing factor.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1695780" href="/Public/Bug/Display.html?id=118899#txn-1695780">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;02&nbsp;06:40:32&nbsp;2017</span>
    <span class="description">HJANSEN [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1695780/910683/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/910683">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 506b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Di 27. Dez 2016, 16:11:08, WBRASWELL schrieb:
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For the time being, I have stopped trying to get mod_perl to work;
&gt; however, this bug remains active and I may have to revisit it at some
&gt; point in the future if I ever need to get my application working in
&gt; mod_perl for some reason.
</div>
IÂ´m considering switching to <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Syntax::Feature::Try">https://metacpan.org/pod/Syntax::Feature::Try</a></span> as its feature set is quite similar to TryCatch while it is implemented using the perl keyword API instead of Devel::Declare.

Best
- Heiko
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1695813" href="/Public/Bug/Display.html?id=118899#txn-1695813">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;02&nbsp;09:17:13&nbsp;2017</span>
    <span class="description">wbraswell_cpan [...] nym.hush.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #118899] Check.xs Segfault In mod_perl</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 02 Jan 2017 08:17:02 -0600</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-b-hooks-op-check [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> wbraswell_cpan [...] nym.hush.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/1695813/910706/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/910706">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 586b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Good info, thanks!
~ Will

On 1/2/2017 at 5:40 AM, &#34;Heiko Jansen via RT&#34;  wrote:

Am Di 27. Dez 2016, 16:11:08, WBRASWELL schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For the time being, I have stopped trying to get mod_perl to work;
&gt; however, this bug remains active and I may have to revisit it at
</div>some
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; point in the future if I ever need to get my application working in
&gt; mod_perl for some reason.
</div>
IÂ´m considering switching to
<span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Syntax::Feature::Try">https://metacpan.org/pod/Syntax::Feature::Try</a></span> as its feature set is
quite similar to TryCatch while it is implemented using the perl
keyword API instead of Devel::Declare.

Best
- Heiko
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1695813/910707/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/910707">with headers</a>
<br />
<span class="downloadcontenttype">text/html 1k</span>
</div>
<div class="messagebody">
</div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1695851" href="/Public/Bug/Display.html?id=118899#txn-1695851">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jan&nbsp;02&nbsp;13:59:08&nbsp;2017</span>
    <span class="description">ether [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1695851/910735/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/910735">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 706b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2017-01-02 03:40:32, HJANSEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Am Di 27. Dez 2016, 16:11:08, WBRASWELL schrieb:
&gt; 
<div class="message-stanza open">&gt; &gt; For the time being, I have stopped trying to get mod_perl to work;
&gt; &gt; however, this bug remains active and I may have to revisit it at some
&gt; &gt; point in the future if I ever need to get my application working in
&gt; &gt; mod_perl for some reason.
</div>&gt; 
&gt; IÂ´m considering switching to
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="https://metacpan.org/pod/Syntax::Feature::Try">https://metacpan.org/pod/Syntax::Feature::Try</a></span> as its feature set is
&gt; quite similar to TryCatch while it is implemented using the perl
&gt; keyword API instead of Devel::Declare.
</div>
Have you considered Try::Tiny? &#40;I&#39;m not the author.&#41;

Nevertheless, it&#39;s certainly a good idea to move off of anything implemented using Devel::Declare.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-1742052" href="/Public/Bug/Display.html?id=118899#txn-1742052">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;31&nbsp;06:30:04&nbsp;2017</span>
    <span class="description">ZEFRAM [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/1742052/937034/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/937034">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 156b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">B::Hooks::OP::Check has never been thread-safe, and you&#39;re running into
the problem that arises from that.  This might change in a future version.

-zefram
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.616919</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
