<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #72880 for App-cpanoutdated: bad results from case-insensitive comparision</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #72880 for App-cpanoutdated: bad results from case-insensitive comparision</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/App-cpanoutdated/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/App-cpanoutdated/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/App-cpanoutdated/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/App-cpanoutdated/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/App-cpanoutdated">App-cpanoutdated CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">72880</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/App-cpanoutdated/Active/">App-cpanoutdated</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
rr [...] yopmail.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-231770-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-231771-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;01&nbsp;23:59:27&nbsp;2011</span>
    <span class="description">http://rickroller.myopenid.com/ -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> bad results from case-insensitive comparision</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">for some reason i&#39;m now being told that i should update distributions
modules which aren&#39;t even installed on my system. i think this is a
result of a case-insensitive comparison somewhere. my filesystem is
case-insensitive &#40;HFS&#41;, but this wasn&#39;t an issue in the past, so not
sure where the problem lies.

$ perl -E &#39;say $^V&#39;
v5.14.2

$ cpan-outdated  --verbose
Attributes                     0.14    2.60   
P/PE/PERRAD/CORBA-IDL-2.60.tar.gz
DB                             1.03    19970614
D/DM/DMR/DProf-19970614.tar.gz
INTEGER                        1.00    1.93   
S/SH/SHERZODR/Class-PObject-2.17.tar.gz
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;05:02:33&nbsp;2011</span>
    <span class="description">http://rickroller.myopenid.com/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Thu Dec 01 23:59:27 2011, <span class="clickylink"><a target="new" rel="nofollow" href="http://rickroller.myopenid.com/">http://rickroller.myopenid.com/</a></span> wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; for some reason i&#39;m now being told that i should update distributions
&gt; modules which aren&#39;t even installed on my system. i think this is a
&gt; result of a case-insensitive comparison somewhere. my filesystem is
&gt; case-insensitive &#40;HFS&#41;, but this wasn&#39;t an issue in the past, so not
&gt; sure where the problem lies.
</div>
it looks like cpan-outdated is just testing for the file existence using
-f. one solution would instead be to test the package name against the
list of filenames returned from readdir for the directory.

another would be to find all installed package files using File::Find
and suck them into a hash, then test each package against the hash.

the first solution would require the least amount of changes to your
existing code. the second solution would probably speed up the entire
program.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;04&nbsp;05:02:34&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;01:31:17&nbsp;2011</span>
    <span class="description">tokuhirom [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #72880] bad results from case-insensitive comparision</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 5 Dec 2011 15:31:06 +0900</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-App-cpanoutdated [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Tokuhiro Matsuno &lt;tokuhirom [...] gmail.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">hmm... patches welcome.

On Sun, Dec 4, 2011 at 7:02 PM, <span class="clickylink"><a target="new" rel="nofollow" href="http://rickroller.myopenid.com/">http://rickroller.myopenid.com/</a></span> via RT
&lt;bug-App-cpanoutdated@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt;       Queue: App-cpanoutdated
&gt;  Ticket &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=72880">https://rt.cpan.org/Ticket/Display.html?id=72880</a></span> &gt;
&gt;
&gt; On Thu Dec 01 23:59:27 2011, <span class="clickylink"><a target="new" rel="nofollow" href="http://rickroller.myopenid.com/">http://rickroller.myopenid.com/</a></span> wrote:
<div class="message-stanza open">&gt;&gt; for some reason i&#39;m now being told that i should update distributions
&gt;&gt; modules which aren&#39;t even installed on my system. i think this is a
&gt;&gt; result of a case-insensitive comparison somewhere. my filesystem is
&gt;&gt; case-insensitive &#40;HFS&#41;, but this wasn&#39;t an issue in the past, so not
&gt;&gt; sure where the problem lies.
</div>&gt;
&gt; it looks like cpan-outdated is just testing for the file existence using
&gt; -f. one solution would instead be to test the package name against the
&gt; list of filenames returned from readdir for the directory.
&gt;
&gt; another would be to find all installed package files using File::Find
&gt; and suck them into a hash, then test each package against the hash.
&gt;
&gt; the first solution would require the least amount of changes to your
&gt; existing code. the second solution would probably speed up the entire
&gt; program.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;05&nbsp;09:35:17&nbsp;2011</span>
    <span class="description">http://rickroller.myopenid.com/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 05 01:31:17 2011, tokuhirom@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; hmm... patches welcome.
</div>
since you didn&#39;t weigh in on which approach you preferred, i&#39;ve attached
the easiest one.

DB from DProf is still a different issue that might not to be special-cased.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> case.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/bin/cpan-outdated b/bin/cpan-outdated
index f9954af..4abb8d8 100644
--- a/bin/cpan-outdated
+++ b/bin/cpan-outdated
@@ -70,6 +70,14 @@ sub main {
             my $path = &#34;$dir/$file&#34;;
             next SCAN_INC unless -f $path;
 
+            # Testing file existence isn&#39;t enough for for case-insensitive
+            # file systems.
+            my &#40;$vol, $pkg_dir, $pkg_file&#41; = File::Spec-&gt;splitpath&#40;$path&#41;;
+            opendir my $dh, $pkg_dir or die &#34;$pkg_dir: $!&#34;;
+            my $found = grep { $_ eq $pkg_file } readdir $dh;
+            closedir $dh;
+            next unless $found;
+
             # ignore old distribution.
             #   This is a heuristic approach. It is not a strict.
             #   If you want a strict check, cpan-outdated looks 02packages.details.txt.gz twice.
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Dec&nbsp;08&nbsp;11:56:23&nbsp;2011</span>
    <span class="description">http://rickroller.myopenid.com/ -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Dec 05 01:31:17 2011, tokuhirom@gmail.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; hmm... patches welcome.
</div>
here&#39;s the other approach. it&#39;s 20% faster for me, but the larger the
@INC, the larger the savings.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> suck.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff --git a/bin/cpan-outdated b/bin/cpan-outdated
index f9954af..a198a87 100644
--- a/bin/cpan-outdated
+++ b/bin/cpan-outdated
@@ -4,6 +4,7 @@ use warnings;
 use Getopt::Long;
 use Pod::Usage;
 use ExtUtils::MakeMaker;
+use File::Find;
 use File::Temp;
 use File::Spec;
 use Config;
@@ -57,6 +58,24 @@ sub main {
     while &#40;my $line = &lt;$fh&gt;&#41; {
         last if $line eq &#34;\n&#34;;
     }
+
+    # Find the list of installed modules.
+    my %paths;
+    for my $dir &#40;@libpath&#41; {
+        next if $dir eq &#39;.&#39;;
+        my $len = length $dir;
+        find {
+            wanted =&gt; sub {
+                return unless substr $_, -3, 3, &#39;&#39; eq &#39;.pm&#39;;
+                return unless -f _;
+                substr $_, 0, 1 + $len, &#39;&#39;;
+                s{[\\/]}{::}g;
+                push @{ $paths{$_} }, $File::Find::name;
+            },
+            no_chdir =&gt; 1
+        }, $dir;
+    }
+
     # body part
     my %seen;
     my %dist_latest_version;
@@ -64,12 +83,10 @@ sub main {
         my &#40;$pkg, $version, $dist&#41; = split /\s+/, $line;
         next if $version eq &#39;undef&#39;;
         next if $dist =~ m{/perl-[0-9._]+\.tar\.&#40;gz|bz2&#41;$};
-        &#40;my $file = $pkg&#41; =~ s!::!/!g;
-        $file = &#34;${file}.pm&#34;;
-        SCAN_INC: for my $dir &#40;@libpath&#41; {
-            my $path = &#34;$dir/$file&#34;;
-            next SCAN_INC unless -f $path;
+        next unless exists $paths{$pkg};
+        my @paths = @{ $paths{$pkg} };
 
+        SCAN_INC: for my $path &#40;@paths&#41; {
             # ignore old distribution.
             #   This is a heuristic approach. It is not a strict.
             #   If you want a strict check, cpan-outdated looks 02packages.details.txt.gz twice.
@@ -80,6 +97,7 @@ sub main {
             #   This strategy works well for now.
             # ref <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/tokuhirom/cpan-outdated/issues#issue/4">https://github.com/tokuhirom/cpan-outdated/issues#issue/4</a></span>
             my $info = CPAN::DistnameInfo-&gt;new&#40;$dist&#41;;
+            next unless $info;
             if &#40;my $latest = $dist_latest_version{$info-&gt;dist}&#41; {
                 # $info-&gt;version &lt; $latest
                 if &#40;compare_version&#40;$info-&gt;version, $latest&#41;&#41; {
@@ -90,7 +108,7 @@ sub main {
             $dist_latest_version{$info-&gt;dist} = $info-&gt;version;
 
             my $inst_version = parse_version&#40;$path&#41;;
-               $inst_version  =~ s/\s+//; # workaround for Attribute::Params::Validate
+            $inst_version  =~ s/\s+//; # workaround for Attribute::Params::Validate
             next if $inst_version eq &#39;undef&#39;;
             if &#40;compare_version&#40;$inst_version, $version&#41;&#41; {
                 next if $seen{$dist}++;
</div></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
