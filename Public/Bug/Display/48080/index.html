<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #48080 for Math-Random: Better Default Seeding</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #48080 for Math-Random: Better Default Seeding</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Math-Random/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Math-Random/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Math-Random/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Math-Random/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Math-Random">Math-Random CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">48080</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Math-Random/Active/">Math-Random</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
frequency [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-20886-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.71    </td>
  </tr>
  <tr id="CF-20887-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;22&nbsp;10:36:58&nbsp;2009</span>
    <span class="description">frequency [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Better Default Seeding</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi:

By default, you seed the module using localtime. In the modules I&#39;ve
written &#40;currently on CPAN&#41; dealing with random stuff, that&#39;s what I&#39;ve
done too.

I just learned today that there is a Perl_seed variable we can use,
which gets the seed of the currently executing thread, which is used
internally &#40;I guess&#41; for seeding hashes and stuff. Ultimately it should
prove to be a better default seed.

I&#39;m working on preparing a patch for Debian. There is a bug report on
this, <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952</a></span> -- but I
think the patch could be better, so I&#39;ll send the updated one after I&#39;m
done.

Notably, the patch submitted by Don Armstrong does not ensure that we&#39;re
running on Perl 5.8+, which is when these seeds were introduced.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;22&nbsp;11:49:32&nbsp;2009</span>
    <span class="description">frequency [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi:

I&#39;ve written the following patch which seems to resolve the issue.
Please consider applying it in your module:

Description: Update seeding algorithm
 By default, this algorithm uses localtime to seed the random number
 generator, which provides poor randomness when Perl is executed many
 times sequentially. This patch replaces that with Don Armstrong&#39;s
 proposed solution, Perl_seed. See BTS#537952 for details.
Origin: vendor
Author: Jonathan Yu &lt;frequency@cpan.org&gt;
Bug: <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952</a></span>
Bug-CPAN: <span class="clickylink"><a target="new" rel="nofollow" href="https://rt.cpan.org/Ticket/Display.html?id=48080">https://rt.cpan.org/Ticket/Display.html?id=48080</a></span>
Forwarded: yes
--- a/Random.pm
+++ b/Random.pm
@@ -73,7 +73,7 @@
 
 
 ### set seeds by default
-salfph&#40;scalar&#40;localtime&#40;&#41;&#41;&#41;;
+salfph&#40;get_seed&#40;&#41; || scalar&#40;localtime&#41;&#41;;
 
 #####################################################################
 #                    RANDOM DEVIATE GENERATORS                     #
--- a/Random.xs
+++ b/Random.xs
@@ -11,6 +11,28 @@
 #include &#34;randlib.h&#34;
 #include &#34;helper.h&#34;
 
+#define PERL_VERSION_ATLEAST&#40;a,b,c&#41;                            \
+  &#40;PERL_REVISION &gt; &#40;a&#41;                                         \
+   || &#40;PERL_REVISION == &#40;a&#41;                                    \
+       &#38;&#38; &#40;PERL_VERSION &gt; &#40;b&#41;                                  \
+           || &#40;PERL_VERSION == &#40;b&#41; &#38;&#38; PERL_SUBVERSION &gt;= &#40;c&#41;&#41;&#41;&#41;&#41;
+
+#if PERL_VERSION_ATLEAST &#40;5,8,1&#41;
+/* For whatever reason, the random seeds need to be in 1..2^30; the
below will
+ * be uniformly distributed assuming the seed value is uniformly
distributed.
+ *
+ * This approach isn&#39;t cryptographically secure. Consider using /dev/random
+ * or Math::TrulyRandom to get some real entropy.
+ */
+#define Perl_get_seed &#40;long&#41;&#40;Perl_seed&#40;aTHX&#41; % 1073741824L&#41;
+#else
+/* If we don&#39;t support seeds, return 0 so we can fall back to localtime for
+ * default seeding. There&#39;s a chance Perl_seed will return 0 and mask this,
+ * but in that case the data should still be &#34;random enough&#34; anyway.
+ */
+#define Perl_get_seed 0L
+#endif /* Perl_seed */
+
 static int
 not_here&#40;s&#41;
 char *s;
@@ -38,6 +60,12 @@
 
 MODULE = Math::Random          PACKAGE = Math::Random
 
+long
+get_seed&#40;&#41;
+       CODE:
+       RETVAL = Perl_get_seed;
+       OUTPUT:
+       RETVAL
 
 double
 genbet &#40;aa,bb&#41;

On Wed Jul 22 10:36:58 2009, FREQUENCY wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi:
&gt; 
&gt; By default, you seed the module using localtime. In the modules I&#39;ve
&gt; written &#40;currently on CPAN&#41; dealing with random stuff, that&#39;s what I&#39;ve
&gt; done too.
&gt; 
&gt; I just learned today that there is a Perl_seed variable we can use,
&gt; which gets the seed of the currently executing thread, which is used
&gt; internally &#40;I guess&#41; for seeding hashes and stuff. Ultimately it should
&gt; prove to be a better default seed.
&gt; 
&gt; I&#39;m working on preparing a patch for Debian. There is a bug report on
&gt; this, <span class="clickylink"><a target="new" rel="nofollow" href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952">http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=537952</a></span> -- but I
&gt; think the patch could be better, so I&#39;ll send the updated one after I&#39;m
&gt; done.
&gt; 
&gt; Notably, the patch submitted by Don Armstrong does not ensure that we&#39;re
&gt; running on Perl 5.8+, which is when these seeds were introduced.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jul&nbsp;22&nbsp;11:49:33&nbsp;2009</span>
    <span class="description">frequency [...] cpan.org -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;26&nbsp;14:51:55&nbsp;2013</span>
    <span class="description">DANAJ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">An alternate approach would be to use one of the good Perl random modules to get a seed in Random.pm and pass it to salfph&#40;&#41; or setall&#40;&#41;.  That would mean no changes in Random.xs, and small changes in Random.pm.  The downside is that you have to choose a module and that adds a dependency &#40;and its chain&#41;.

I would strongly recommend not mentioning or using Math::TrulyRandom.

I&#39;m biased, but I think Crypt::Random::Seed would work well, and I&#39;ve tested it in the module using:

  use Crypt::Random::Seed;
  my $source = Crypt::Random::Seed-&gt;new&#40;NonBlocking =&gt; 1&#41;;
  setall&#40; map { $_ % 0x3FFFFFFF } $source-&gt;random_values&#40;2&#41; &#41;;

The entire point of the module is to provide a lightweight and flexible solution to this exact problem.  It will use Win32, /dev/random, EDG, /dev/urandom as available, as well as a userspace fallback similar in concept to Math::TrulyRandom but without its critical errors.  Total of 2 non-core modules &#40;including itself&#41;.

Since Math::Random isn&#39;t targeting strong crypto, Crypt::URandom is another good choice.  It&#39;s very lightweight -- just the one module with no chain, and it supports Win32.  Shouldn&#39;t be too hard to use calling setall&#40;&#41;.  Not as flexible as Crypt::Random::Seed, but you may not need the flexibility.

Going up a layer, Bytes::Random::Secure would also work well.  It offers some methods for generating nice null-terminated strings that would play well with salfph&#40;&#41;:

  use Bytes::Random::Secure qw/random_bytes_base64/;
  salfph&#40;random_bytes_base64&#40;32&#41;&#41;;

or via setall like:

  use Bytes::Random::Secure;
  my $rnd = Bytes::Random::Secure-&gt;new&#40;NonBlocking=&gt;1&#41;;
  setall&#40; $rnd-&gt;irand&#40;&#41; % 0x3FFFFFFF, $rnd-&gt;irand&#40;&#41; % 0x3FFFFFFF&#41;;

Fairly light dependency chain -- total of 4 non-core modules.

Math::Random::Secure and Crypt::Random::Secure are nice, but they have huge dependency chains &#40;over 20 modules plus Moose&#41;.  I made Crypt::Random::Seed just because I couldn&#39;t stand the dependency and runtime overheads.

Some people like Data::Entropy, but I&#39;m not a big fan.  It does require some setup or it&#39;ll just use rand&#40;&#41; by default.  About 6 dependencies.  I&#39;m not seeing anything that uses the Win32 interfaces.

You could also give thought to indicating non-blocking is acceptable, which would help on servers.  I&#39;ll leave the /dev/random vs. /dev/urandom battle aside for now, but many of the modules support some mechanism for this: e.g. my $source = Crypt::Random::Seed-&gt;new&#40;NonBlocking =&gt; 1&#41;;  I suspect this is preferable for this module which is not targeted to strong crypto anyway.
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
