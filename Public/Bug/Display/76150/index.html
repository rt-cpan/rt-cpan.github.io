<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #76150 for Scalar-List-Utils: Detecting dualvars</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #76150 for Scalar-List-Utils: Detecting dualvars</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Scalar-List-Utils/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Scalar-List-Utils">Scalar-List-Utils CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">76150</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Scalar-List-Utils/Active/">Scalar-List-Utils</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
brianski [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Wishlist    </td>
  </tr>
  <tr id="CF-28278-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.25    </td>
  </tr>
  <tr id="CF-28279-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.26    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;03:04:23&nbsp;2012</span>
    <span class="description">brianski [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Detecting dualvars</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Is there a nice way to detect dualvars? Seems like a whole in the API 
&#40;compare weaken and isweak&#41;.

Right now I&#39;m using the following mess, which I&#39;m quite sure is subtly 
wrong or at least not optimal:
  sub is_dualvar { my &#40;$x&#41; = @_; return &#34;$x&#34; ne 0+$x; };

... it sure seems like there should be an XS-tastic way to do the job in 
Scalar::Util itself faster and hidden under the covers...
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;12:08:26&nbsp;2012</span>
    <span class="description">gbarr [...] pobox.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #76150] Detecting dualvars </td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 30 Mar 2012 11:08:13 -0500</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Scalar-List-Utils [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Graham Barr &lt;gbarr [...] pobox.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Every scalar in perl is a dualvar as perl caches the numeric and string forms when it calculates them.

dualvar&#40;&#41; just abuses that feature in the same way that $! does

for example

$ perl -le &#39;$x=&#34;123 &#34;;  print &#34;is_dualvar&#34; if &#34;$x&#34; ne 0+$x&#39;
is_dualvar

there is no way to detect any difference between this $x and one created with dualvar&#40;&#41;

Graham.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;12:08:28&nbsp;2012</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Mar&nbsp;30&nbsp;14:33:52&nbsp;2012</span>
    <span class="description">brianski [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Right, but the condition I am interested in testing isn&#39;t &#34;was it 
created with Scalar::Util::dualvar&#40;&#41;&#34;, but rather: if I dump the string 
version of this variable to a text file / DB / whatever, will I lose any 
information?

On Fri Mar 30 12:08:26 2012, gbarr@pobox.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Every scalar in perl is a dualvar as perl caches the numeric and
&gt; string forms when it calculates them.
&gt; 
&gt; dualvar&#40;&#41; just abuses that feature in the same way that $! does
&gt; 
&gt; for example
&gt; 
&gt; $ perl -le &#39;$x=&#34;123 &#34;;  print &#34;is_dualvar&#34; if &#34;$x&#34; ne 0+$x&#39;
&gt; is_dualvar
&gt; 
&gt; there is no way to detect any difference between this $x and one
&gt; created with dualvar&#40;&#41;
&gt; 
&gt; Graham.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;08&nbsp;15:53:23&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Mar 30 14:33:52 2012, BRIANSKI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Right, but the condition I am interested in testing isn&#39;t &#34;was it 
&gt; created with Scalar::Util::dualvar&#40;&#41;&#34;, but rather: if I dump the string 
&gt; version of this variable to a text file / DB / whatever, will I lose any 
&gt; information?
</div>
Ultimately then, this comes down to a question of whether the variable has 
both numeric and stringy parts to it, that represent different values. You 
can likely come up with some pureperl to detect that, something like

  do {
    no warnings;
    sprintf&#40;&#34;%s&#34;, $var&#41; eq sprintf&#40;&#34;%f&#34;, $var&#41;;
  }

Some XS could optimise that by noting that only a dualvar has both 
SvIOK/SvNOK and SvPOK set at once, so if it only has one it never has to 
test this. Then the test merely has to distinguish &#34;normal&#34; SVs with both 
slots precached, vs. genuine dualvars containing different data.

Of course you&#39;ll never distinguish such cases as

  dualvar&#40;10, &#34;10&#34;&#41;

Since your original condition only cares about numeric vs. stringy data, 
perhaps you&#39;d be best to test that using some sprintf tests, rather than 
XS-level hacks.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;01&nbsp;11:23:11&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Detecting dualvars</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Attached is a patch that adds an &#39;isdual&#40;&#41;&#39; boolean function to 
Scalar::Util.  Documentation has been added to the POD, and tests have 
been added to t/dualvar.t.

I have generated this patch so that the threads::shared module can use 
this new function to test for dual-valued variables, and handle them 
appropriately with cloning them.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> isdual.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN Scalar-List-Utils-1.25/ListUtil.xs Scalar-List-Utils-patched/ListUtil.xs
--- Scalar-List-Utils-1.25/ListUtil.xs	2012-03-24 09:08:41.000000000 -0400
+++ Scalar-List-Utils-patched/ListUtil.xs	2012-10-01 10:45:08.315467000 -0400
@@ -397,6 +397,14 @@
     XSRETURN&#40;1&#41;;
 }
 
+void
+isdual&#40;sv&#41;
+	SV *sv
+PROTOTYPE: $
+CODE:
+	ST&#40;0&#41; = boolSV&#40;SvPOK&#40;sv&#41; &#38;&#38; &#40;SvNOK&#40;sv&#41; || SvIOK&#40;sv&#41;&#41;&#41;;
+	XSRETURN&#40;1&#41;;
+
 char *
 blessed&#40;sv&#41;
     SV * sv
diff -urN Scalar-List-Utils-1.25/lib/Scalar/Util.pm Scalar-List-Utils-patched/lib/Scalar/Util.pm
--- Scalar-List-Utils-1.25/lib/Scalar/Util.pm	2012-03-24 09:10:46.000000000 -0400
+++ Scalar-List-Utils-patched/lib/Scalar/Util.pm	2012-10-01 11:15:08.198678200 -0400
@@ -11,7 +11,7 @@
 require List::Util; # List::Util loads the XS
 
 our @ISA       = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;blessed dualvar reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
+our @EXPORT_OK = qw&#40;blessed dualvar isdual reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
 our $VERSION    = &#34;1.25&#34;;
 $VERSION   = eval $VERSION;
 
@@ -51,8 +51,9 @@
 
 =head1 SYNOPSIS
 
-    use Scalar::Util qw&#40;blessed dualvar isweak readonly refaddr reftype tainted
-                        weaken isvstring looks_like_number set_prototype&#41;;
+    use Scalar::Util qw&#40;blessed dualvar isdual readonly refaddr reftype
+                        tainted weaken isweak isvstring looks_like_number
+                        set_prototype&#41;;
                         # and other useful utils appearing below
 
 =head1 DESCRIPTION
@@ -90,27 +91,40 @@
     $num = $foo + 2;                    # 12
     $str = $foo . &#34; world&#34;;             # Hello world
 
-=item isvstring EXPR
+=item isdual EXPR
 
-If EXPR is a scalar which was coded as a vstring the result is true.
+If EXPR is a scalar that is a dualvar, the result is true.
 
-    $vs   = v49.46.48;
-    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
-    printf&#40;$fmt,$vs&#41;;
+    $foo = dualvar 86, &#34;Nix&#34;;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-=item isweak EXPR
+Note that a scalar can be made to have both string and numeric content
+through numeric operations:
 
-If EXPR is a scalar which is a weak reference the result is true.
+    $foo = &#34;10&#34;;
+    $dual = isdual&#40;$foo&#41;;               # false
+    $bar = $foo + 0;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-    $ref  = \$foo;
-    $weak = isweak&#40;$ref&#41;;               # false
-    weaken&#40;$ref&#41;;
-    $weak = isweak&#40;$ref&#41;;               # true
+Note that although C&lt;$!&gt; appears to be dual-valued variable, it is
+actually implemented using a tied scalar:
 
-B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+    $! = 1;
+    print&#40;&#34;$!\n&#34;&#41;;                      # &#34;Operation not permitted&#34;
+    $dual = isdual&#40;$!&#41;;                 # false
 
-    $copy = $ref;
-    $weak = isweak&#40;$copy&#41;;              # false
+You can capture its numeric and string content using:
+
+    $err = dualvar $!, $!;
+    $dual = isdual&#40;$err&#41;;               # true
+
+=item isvstring EXPR
+
+If EXPR is a scalar which was coded as a vstring the result is true.
+
+    $vs   = v49.46.48;
+    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
+    printf&#40;$fmt,$vs&#41;;
 
 =item looks_like_number EXPR
 
@@ -122,11 +136,11 @@
 Returns FH if FH may be used as a filehandle and is open, or FH is a tied
 handle. Otherwise C&lt;undef&gt; is returned.
 
-    $fh = openhandle&#40;*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;\*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;*NOTOPEN&#41;;		# undef
-    $fh = openhandle&#40;&#34;scalar&#34;&#41;;		# undef
-    
+    $fh = openhandle&#40;*STDIN&#41;;           # \*STDIN
+    $fh = openhandle&#40;\*STDIN&#41;;          # \*STDIN
+    $fh = openhandle&#40;*NOTOPEN&#41;;         # undef
+    $fh = openhandle&#40;&#34;scalar&#34;&#41;;         # undef
+
 =item readonly SCALAR
 
 Returns true if SCALAR is readonly.
@@ -209,6 +223,20 @@
 be destroyed because there is now always a strong reference to them in the
 @object array.
 
+=item isweak EXPR
+
+If EXPR is a scalar which is a weak reference the result is true.
+
+    $ref  = \$foo;
+    $weak = isweak&#40;$ref&#41;;               # false
+    weaken&#40;$ref&#41;;
+    $weak = isweak&#40;$ref&#41;;               # true
+
+B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+
+    $copy = $ref;
+    $weak = isweak&#40;$copy&#41;;              # false
+
 =back
 
 =head1 DIAGNOSTICS
diff -urN Scalar-List-Utils-1.25/t/dualvar.t Scalar-List-Utils-patched/t/dualvar.t
--- Scalar-List-Utils-1.25/t/dualvar.t	2012-03-22 14:05:13.000000000 -0400
+++ Scalar-List-Utils-patched/t/dualvar.t	2012-10-01 11:01:16.256202200 -0400
@@ -16,22 +16,26 @@
 use Scalar::Util &#40;&#41;;
 use Test::More  &#40;grep { /dualvar/ } @Scalar::Util::EXPORT_FAIL&#41;
 			? &#40;skip_all =&gt; &#39;dualvar requires XS version&#39;&#41;
-			: &#40;tests =&gt; 13&#41;;
+			: &#40;tests =&gt; 21&#41;;
 
 Scalar::Util-&gt;import&#40;&#39;dualvar&#39;&#41;;
+Scalar::Util-&gt;import&#40;&#39;isdual&#39;&#41;;
 
 $var = dualvar&#40; 2.2,&#34;string&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == 2.2,	&#39;Numeric value&#39;&#41;;
 ok&#40; $var eq &#34;string&#34;,	&#39;String value&#39;&#41;;
 
 $var2 = $var;
 
+ok&#40; isdual&#40;$var2&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var2 == 2.2,	&#39;copy Numeric value&#39;&#41;;
 ok&#40; $var2 eq &#34;string&#34;,	&#39;copy String value&#39;&#41;;
 
 $var++;
 
+ok&#40; ! isdual&#40;$var&#41;,	&#39;No longer dualvar&#39;&#41;;
 ok&#40; $var == 3.2,	&#39;inc Numeric value&#39;&#41;;
 ok&#40; $var ne &#34;string&#34;,	&#39;inc String value&#39;&#41;;
 
@@ -40,15 +44,22 @@
 
 $var = dualvar&#40;$numstr, &#34;&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == $numstr,	&#39;NV&#39;&#41;;
 
 SKIP: {
   skip&#40;&#34;dualvar with UV value known to fail with $]&#34;,2&#41; if $] &lt; 5.006_001;
   $var = dualvar&#40;1&lt;&lt;31, &#34;&#34;&#41;;
+  ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
   ok&#40; $var == &#40;1&lt;&lt;31&#41;,	&#39;UV 1&#39;&#41;;
   ok&#40; $var &gt; 0,		&#39;UV 2&#39;&#41;;
 }
 
+# Create a dualvar &#34;the old fashioned way&#34;
+$var = &#34;10&#34;;
+ok&#40; ! isdual&#40;$var&#41;,	&#39;Not a dualvar&#39;&#41;;
+my $foo = $var + 0;
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 
 {
   package Tied;
@@ -59,12 +70,13 @@
 
 tie my $tied, &#39;Tied&#39;;
 $var = dualvar&#40;$tied, &#34;ok&#34;&#41;;
+ok&#40;isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40;$var == 7.5,		&#39;Tied num&#39;&#41;;
 ok&#40;$var eq &#39;ok&#39;,	&#39;Tied str&#39;&#41;;
 
 
 SKIP: {
-  skip&#40;&#34;need utf8::is_utf8&#34;,2&#41; unless defined &#38;utf8::is_utf8;
+  skip&#40;&#34;need utf8::is_utf8&#34;,3&#41; unless defined &#38;utf8::is_utf8;
   ok&#40;!!utf8::is_utf8&#40;dualvar&#40;1,chr&#40;400&#41;&#41;&#41;, &#39;utf8&#39;&#41;;
   ok&#40; !utf8::is_utf8&#40;dualvar&#40;1,&#34;abc&#34;&#41;&#41;,    &#39;not utf8&#39;&#41;;
 }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;02&nbsp;16:19:22&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Detecting dualvars &#40;revised&#41;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-10-01 11:23:11, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a patch that adds an &#39;isdual&#40;&#41;&#39; boolean function to 
&gt; Scalar::Util.  Documentation has been added to the POD, and tests have 
&gt; been added to t/dualvar.t.
</div>
The attached patch is much improved, and handles shared variables along.  
Additional tests are included.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> isdual.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN Scalar-List-Utils-1.25/ListUtil.xs Scalar-List-Utils-patched/ListUtil.xs
--- Scalar-List-Utils-1.25/ListUtil.xs	2012-03-24 09:08:41.000000000 -0400
+++ Scalar-List-Utils-patched/ListUtil.xs	2012-10-02 16:13:54.703585900 -0400
@@ -397,6 +397,16 @@
     XSRETURN&#40;1&#41;;
 }
 
+void
+isdual&#40;sv&#41;
+	SV *sv
+PROTOTYPE: $
+CODE:
+    if &#40;SvMAGICAL&#40;sv&#41;&#41;
+    mg_get&#40;sv&#41;;
+    ST&#40;0&#41; = boolSV&#40;&#40;SvPOK&#40;sv&#41; || SvPOKp&#40;sv&#41;&#41; &#38;&#38; &#40;SvNIOK&#40;sv&#41; || SvNIOKp&#40;sv&#41;&#41;&#41;;
+    XSRETURN&#40;1&#41;;
+
 char *
 blessed&#40;sv&#41;
     SV * sv
diff -urN Scalar-List-Utils-1.25/lib/Scalar/Util.pm Scalar-List-Utils-patched/lib/Scalar/Util.pm
--- Scalar-List-Utils-1.25/lib/Scalar/Util.pm	2012-03-24 09:10:46.000000000 -0400
+++ Scalar-List-Utils-patched/lib/Scalar/Util.pm	2012-10-01 11:15:08.198678200 -0400
@@ -11,7 +11,7 @@
 require List::Util; # List::Util loads the XS
 
 our @ISA       = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;blessed dualvar reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
+our @EXPORT_OK = qw&#40;blessed dualvar isdual reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
 our $VERSION    = &#34;1.25&#34;;
 $VERSION   = eval $VERSION;
 
@@ -51,8 +51,9 @@
 
 =head1 SYNOPSIS
 
-    use Scalar::Util qw&#40;blessed dualvar isweak readonly refaddr reftype tainted
-                        weaken isvstring looks_like_number set_prototype&#41;;
+    use Scalar::Util qw&#40;blessed dualvar isdual readonly refaddr reftype
+                        tainted weaken isweak isvstring looks_like_number
+                        set_prototype&#41;;
                         # and other useful utils appearing below
 
 =head1 DESCRIPTION
@@ -90,27 +91,40 @@
     $num = $foo + 2;                    # 12
     $str = $foo . &#34; world&#34;;             # Hello world
 
-=item isvstring EXPR
+=item isdual EXPR
 
-If EXPR is a scalar which was coded as a vstring the result is true.
+If EXPR is a scalar that is a dualvar, the result is true.
 
-    $vs   = v49.46.48;
-    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
-    printf&#40;$fmt,$vs&#41;;
+    $foo = dualvar 86, &#34;Nix&#34;;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-=item isweak EXPR
+Note that a scalar can be made to have both string and numeric content
+through numeric operations:
 
-If EXPR is a scalar which is a weak reference the result is true.
+    $foo = &#34;10&#34;;
+    $dual = isdual&#40;$foo&#41;;               # false
+    $bar = $foo + 0;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-    $ref  = \$foo;
-    $weak = isweak&#40;$ref&#41;;               # false
-    weaken&#40;$ref&#41;;
-    $weak = isweak&#40;$ref&#41;;               # true
+Note that although C&lt;$!&gt; appears to be dual-valued variable, it is
+actually implemented using a tied scalar:
 
-B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+    $! = 1;
+    print&#40;&#34;$!\n&#34;&#41;;                      # &#34;Operation not permitted&#34;
+    $dual = isdual&#40;$!&#41;;                 # false
 
-    $copy = $ref;
-    $weak = isweak&#40;$copy&#41;;              # false
+You can capture its numeric and string content using:
+
+    $err = dualvar $!, $!;
+    $dual = isdual&#40;$err&#41;;               # true
+
+=item isvstring EXPR
+
+If EXPR is a scalar which was coded as a vstring the result is true.
+
+    $vs   = v49.46.48;
+    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
+    printf&#40;$fmt,$vs&#41;;
 
 =item looks_like_number EXPR
 
@@ -122,11 +136,11 @@
 Returns FH if FH may be used as a filehandle and is open, or FH is a tied
 handle. Otherwise C&lt;undef&gt; is returned.
 
-    $fh = openhandle&#40;*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;\*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;*NOTOPEN&#41;;		# undef
-    $fh = openhandle&#40;&#34;scalar&#34;&#41;;		# undef
-    
+    $fh = openhandle&#40;*STDIN&#41;;           # \*STDIN
+    $fh = openhandle&#40;\*STDIN&#41;;          # \*STDIN
+    $fh = openhandle&#40;*NOTOPEN&#41;;         # undef
+    $fh = openhandle&#40;&#34;scalar&#34;&#41;;         # undef
+
 =item readonly SCALAR
 
 Returns true if SCALAR is readonly.
@@ -209,6 +223,20 @@
 be destroyed because there is now always a strong reference to them in the
 @object array.
 
+=item isweak EXPR
+
+If EXPR is a scalar which is a weak reference the result is true.
+
+    $ref  = \$foo;
+    $weak = isweak&#40;$ref&#41;;               # false
+    weaken&#40;$ref&#41;;
+    $weak = isweak&#40;$ref&#41;;               # true
+
+B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+
+    $copy = $ref;
+    $weak = isweak&#40;$copy&#41;;              # false
+
 =back
 
 =head1 DIAGNOSTICS
diff -urN Scalar-List-Utils-1.25/t/dualvar.t Scalar-List-Utils-patched/t/dualvar.t
--- Scalar-List-Utils-1.25/t/dualvar.t	2012-03-22 14:05:13.000000000 -0400
+++ Scalar-List-Utils-patched/t/dualvar.t	2012-10-02 16:14:26.578789900 -0400
@@ -16,22 +16,27 @@
 use Scalar::Util &#40;&#41;;
 use Test::More  &#40;grep { /dualvar/ } @Scalar::Util::EXPORT_FAIL&#41;
 			? &#40;skip_all =&gt; &#39;dualvar requires XS version&#39;&#41;
-			: &#40;tests =&gt; 13&#41;;
+			: &#40;tests =&gt; 41&#41;;
+use Config;
 
 Scalar::Util-&gt;import&#40;&#39;dualvar&#39;&#41;;
+Scalar::Util-&gt;import&#40;&#39;isdual&#39;&#41;;
 
 $var = dualvar&#40; 2.2,&#34;string&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == 2.2,	&#39;Numeric value&#39;&#41;;
 ok&#40; $var eq &#34;string&#34;,	&#39;String value&#39;&#41;;
 
 $var2 = $var;
 
+ok&#40; isdual&#40;$var2&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var2 == 2.2,	&#39;copy Numeric value&#39;&#41;;
 ok&#40; $var2 eq &#34;string&#34;,	&#39;copy String value&#39;&#41;;
 
 $var++;
 
+ok&#40; ! isdual&#40;$var&#41;,	&#39;No longer dualvar&#39;&#41;;
 ok&#40; $var == 3.2,	&#39;inc Numeric value&#39;&#41;;
 ok&#40; $var ne &#34;string&#34;,	&#39;inc String value&#39;&#41;;
 
@@ -40,15 +45,23 @@
 
 $var = dualvar&#40;$numstr, &#34;&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == $numstr,	&#39;NV&#39;&#41;;
 
 SKIP: {
   skip&#40;&#34;dualvar with UV value known to fail with $]&#34;,2&#41; if $] &lt; 5.006_001;
-  $var = dualvar&#40;1&lt;&lt;31, &#34;&#34;&#41;;
-  ok&#40; $var == &#40;1&lt;&lt;31&#41;,	&#39;UV 1&#39;&#41;;
-  ok&#40; $var &gt; 0,		&#39;UV 2&#39;&#41;;
+  my $bits = &#40;$Config{&#39;use64bitint&#39;}&#41; ? 63 : 31;
+  $var = dualvar&#40;1&lt;&lt;$bits, &#34;&#34;&#41;;
+  ok&#40; isdual&#40;$var&#41;,		&#39;Is a dualvar&#39;&#41;;
+  ok&#40; $var == &#40;1&lt;&lt;$bits&#41;,	&#39;UV 1&#39;&#41;;
+  ok&#40; $var &gt; 0,			&#39;UV 2&#39;&#41;;
 }
 
+# Create a dualvar &#34;the old fashioned way&#34;
+$var = &#34;10&#34;;
+ok&#40; ! isdual&#40;$var&#41;,	&#39;Not a dualvar&#39;&#41;;
+my $foo = $var + 0;
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 
 {
   package Tied;
@@ -59,12 +72,54 @@
 
 tie my $tied, &#39;Tied&#39;;
 $var = dualvar&#40;$tied, &#34;ok&#34;&#41;;
+ok&#40;isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40;$var == 7.5,		&#39;Tied num&#39;&#41;;
 ok&#40;$var eq &#39;ok&#39;,	&#39;Tied str&#39;&#41;;
 
 
 SKIP: {
-  skip&#40;&#34;need utf8::is_utf8&#34;,2&#41; unless defined &#38;utf8::is_utf8;
+  skip&#40;&#34;need utf8::is_utf8&#34;,3&#41; unless defined &#38;utf8::is_utf8;
   ok&#40;!!utf8::is_utf8&#40;dualvar&#40;1,chr&#40;400&#41;&#41;&#41;, &#39;utf8&#39;&#41;;
   ok&#40; !utf8::is_utf8&#40;dualvar&#40;1,&#34;abc&#34;&#41;&#41;,    &#39;not utf8&#39;&#41;;
 }
+
+
+SKIP: {
+  skip&#40;&#34;Perl not compiled with &#39;useithreads&#39;&#34;,7&#41; unless &#40;$Config{&#39;useithreads&#39;}&#41;;
+  require threads; import threads;
+  require threads::shared; import threads::shared;
+  skip&#40;&#34;Requires threads::shared v1.42 or later&#34;,7&#41; unless &#40;$threads::shared::VERSION &gt;= 1.42&#41;;
+
+  my $siv :shared = dualvar&#40;42, &#39;Fourty-Two&#39;&#41;;
+  my $snv :shared = dualvar&#40;3.14, &#39;PI&#39;&#41;;
+  my $bits = &#40;$Config{&#39;use64bitint&#39;}&#41; ? 63 : 31;
+  my $suv :shared = dualvar&#40;1&lt;&lt;$bits, &#39;Large unsigned int&#39;&#41;;
+
+  ok&#40;$siv == 42, &#39;Shared IV number preserved&#39;&#41;;
+  ok&#40;$siv eq &#39;Fourty-Two&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$siv&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$snv == 3.14, &#39;Shared NV number preserved&#39;&#41;;
+  ok&#40;$snv eq &#39;PI&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$snv&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$suv == &#40;1&lt;&lt;$bits&#41;, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$suv &gt; 0, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$suv eq &#39;Large unsigned int&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$suv&#41;, &#39;Is a dualvar&#39;&#41;;
+
+  my @ary :shared;
+  $ary[0] = $siv;
+  $ary[1] = $snv;
+  $ary[2] = $suv;
+
+  ok&#40;$ary[0] == 42, &#39;Shared IV number preserved&#39;&#41;;
+  ok&#40;$ary[0] eq &#39;Fourty-Two&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[0]&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$ary[1] == 3.14, &#39;Shared NV number preserved&#39;&#41;;
+  ok&#40;$ary[1] eq &#39;PI&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[1]&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$ary[2] == &#40;1&lt;&lt;$bits&#41;, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$ary[2] &gt; 0, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$ary[2] eq &#39;Large unsigned int&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[2]&#41;, &#39;Is a dualvar&#39;&#41;;
+}
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Oct&nbsp;25&nbsp;09:50:56&nbsp;2012</span>
    <span class="description">jdhedden [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Detecting dualvars &#40;revised^2&#41;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> gbarr [...] pobox.com</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On 2012-10-01 11:23:11, JDHEDDEN wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Attached is a patch that adds an &#39;isdual&#40;&#41;&#39; boolean function to
&gt; Scalar::Util.  Documentation has been added to the POD, and tests have
&gt; been added to t/dualvar.t.
</div>
The attached patch is much improved, and handles shared variables also.
Additional tests are included.  This revised^2 patch corrects the skip
count in the tests added to t/dualvar.t.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> isdual.patch</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">diff -urN Scalar-List-Utils-1.25/ListUtil.xs Scalar-List-Utils-patched/ListUtil.xs
--- Scalar-List-Utils-1.25/ListUtil.xs	2012-03-24 09:08:41.000000000 -0400
+++ Scalar-List-Utils-patched/ListUtil.xs	2012-10-02 16:13:54.703585900 -0400
@@ -397,6 +397,16 @@
     XSRETURN&#40;1&#41;;
 }
 
+void
+isdual&#40;sv&#41;
+	SV *sv
+PROTOTYPE: $
+CODE:
+    if &#40;SvMAGICAL&#40;sv&#41;&#41;
+    mg_get&#40;sv&#41;;
+    ST&#40;0&#41; = boolSV&#40;&#40;SvPOK&#40;sv&#41; || SvPOKp&#40;sv&#41;&#41; &#38;&#38; &#40;SvNIOK&#40;sv&#41; || SvNIOKp&#40;sv&#41;&#41;&#41;;
+    XSRETURN&#40;1&#41;;
+
 char *
 blessed&#40;sv&#41;
     SV * sv
diff -urN Scalar-List-Utils-1.25/lib/Scalar/Util.pm Scalar-List-Utils-patched/lib/Scalar/Util.pm
--- Scalar-List-Utils-1.25/lib/Scalar/Util.pm	2012-03-24 09:10:46.000000000 -0400
+++ Scalar-List-Utils-patched/lib/Scalar/Util.pm	2012-10-01 11:15:08.198678200 -0400
@@ -11,7 +11,7 @@
 require List::Util; # List::Util loads the XS
 
 our @ISA       = qw&#40;Exporter&#41;;
-our @EXPORT_OK = qw&#40;blessed dualvar reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
+our @EXPORT_OK = qw&#40;blessed dualvar isdual reftype weaken isweak tainted readonly openhandle refaddr isvstring looks_like_number set_prototype&#41;;
 our $VERSION    = &#34;1.25&#34;;
 $VERSION   = eval $VERSION;
 
@@ -51,8 +51,9 @@
 
 =head1 SYNOPSIS
 
-    use Scalar::Util qw&#40;blessed dualvar isweak readonly refaddr reftype tainted
-                        weaken isvstring looks_like_number set_prototype&#41;;
+    use Scalar::Util qw&#40;blessed dualvar isdual readonly refaddr reftype
+                        tainted weaken isweak isvstring looks_like_number
+                        set_prototype&#41;;
                         # and other useful utils appearing below
 
 =head1 DESCRIPTION
@@ -90,27 +91,40 @@
     $num = $foo + 2;                    # 12
     $str = $foo . &#34; world&#34;;             # Hello world
 
-=item isvstring EXPR
+=item isdual EXPR
 
-If EXPR is a scalar which was coded as a vstring the result is true.
+If EXPR is a scalar that is a dualvar, the result is true.
 
-    $vs   = v49.46.48;
-    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
-    printf&#40;$fmt,$vs&#41;;
+    $foo = dualvar 86, &#34;Nix&#34;;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-=item isweak EXPR
+Note that a scalar can be made to have both string and numeric content
+through numeric operations:
 
-If EXPR is a scalar which is a weak reference the result is true.
+    $foo = &#34;10&#34;;
+    $dual = isdual&#40;$foo&#41;;               # false
+    $bar = $foo + 0;
+    $dual = isdual&#40;$foo&#41;;               # true
 
-    $ref  = \$foo;
-    $weak = isweak&#40;$ref&#41;;               # false
-    weaken&#40;$ref&#41;;
-    $weak = isweak&#40;$ref&#41;;               # true
+Note that although C&lt;$!&gt; appears to be dual-valued variable, it is
+actually implemented using a tied scalar:
 
-B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+    $! = 1;
+    print&#40;&#34;$!\n&#34;&#41;;                      # &#34;Operation not permitted&#34;
+    $dual = isdual&#40;$!&#41;;                 # false
 
-    $copy = $ref;
-    $weak = isweak&#40;$copy&#41;;              # false
+You can capture its numeric and string content using:
+
+    $err = dualvar $!, $!;
+    $dual = isdual&#40;$err&#41;;               # true
+
+=item isvstring EXPR
+
+If EXPR is a scalar which was coded as a vstring the result is true.
+
+    $vs   = v49.46.48;
+    $fmt  = isvstring&#40;$vs&#41; ? &#34;%vd&#34; : &#34;%s&#34;; #true
+    printf&#40;$fmt,$vs&#41;;
 
 =item looks_like_number EXPR
 
@@ -122,11 +136,11 @@
 Returns FH if FH may be used as a filehandle and is open, or FH is a tied
 handle. Otherwise C&lt;undef&gt; is returned.
 
-    $fh = openhandle&#40;*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;\*STDIN&#41;;		# \*STDIN
-    $fh = openhandle&#40;*NOTOPEN&#41;;		# undef
-    $fh = openhandle&#40;&#34;scalar&#34;&#41;;		# undef
-    
+    $fh = openhandle&#40;*STDIN&#41;;           # \*STDIN
+    $fh = openhandle&#40;\*STDIN&#41;;          # \*STDIN
+    $fh = openhandle&#40;*NOTOPEN&#41;;         # undef
+    $fh = openhandle&#40;&#34;scalar&#34;&#41;;         # undef
+
 =item readonly SCALAR
 
 Returns true if SCALAR is readonly.
@@ -209,6 +223,20 @@
 be destroyed because there is now always a strong reference to them in the
 @object array.
 
+=item isweak EXPR
+
+If EXPR is a scalar which is a weak reference the result is true.
+
+    $ref  = \$foo;
+    $weak = isweak&#40;$ref&#41;;               # false
+    weaken&#40;$ref&#41;;
+    $weak = isweak&#40;$ref&#41;;               # true
+
+B&lt;NOTE&gt;: Copying a weak reference creates a normal, strong, reference.
+
+    $copy = $ref;
+    $weak = isweak&#40;$copy&#41;;              # false
+
 =back
 
 =head1 DIAGNOSTICS
diff -urN Scalar-List-Utils-1.25/t/dualvar.t Scalar-List-Utils-patched/t/dualvar.t
--- Scalar-List-Utils-1.25/t/dualvar.t	2012-03-22 14:05:13.000000000 -0400
+++ Scalar-List-Utils-patched/t/dualvar.t	2012-10-02 16:14:26.578789900 -0400
@@ -16,22 +16,27 @@
 use Scalar::Util &#40;&#41;;
 use Test::More  &#40;grep { /dualvar/ } @Scalar::Util::EXPORT_FAIL&#41;
 			? &#40;skip_all =&gt; &#39;dualvar requires XS version&#39;&#41;
-			: &#40;tests =&gt; 13&#41;;
+			: &#40;tests =&gt; 41&#41;;
+use Config;
 
 Scalar::Util-&gt;import&#40;&#39;dualvar&#39;&#41;;
+Scalar::Util-&gt;import&#40;&#39;isdual&#39;&#41;;
 
 $var = dualvar&#40; 2.2,&#34;string&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == 2.2,	&#39;Numeric value&#39;&#41;;
 ok&#40; $var eq &#34;string&#34;,	&#39;String value&#39;&#41;;
 
 $var2 = $var;
 
+ok&#40; isdual&#40;$var2&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var2 == 2.2,	&#39;copy Numeric value&#39;&#41;;
 ok&#40; $var2 eq &#34;string&#34;,	&#39;copy String value&#39;&#41;;
 
 $var++;
 
+ok&#40; ! isdual&#40;$var&#41;,	&#39;No longer dualvar&#39;&#41;;
 ok&#40; $var == 3.2,	&#39;inc Numeric value&#39;&#41;;
 ok&#40; $var ne &#34;string&#34;,	&#39;inc String value&#39;&#41;;
 
@@ -40,15 +45,23 @@
 
 $var = dualvar&#40;$numstr, &#34;&#34;&#41;;
 
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40; $var == $numstr,	&#39;NV&#39;&#41;;
 
 SKIP: {
   skip&#40;&#34;dualvar with UV value known to fail with $]&#34;,2&#41; if $] &lt; 5.006_001;
-  $var = dualvar&#40;1&lt;&lt;31, &#34;&#34;&#41;;
-  ok&#40; $var == &#40;1&lt;&lt;31&#41;,	&#39;UV 1&#39;&#41;;
-  ok&#40; $var &gt; 0,		&#39;UV 2&#39;&#41;;
+  my $bits = &#40;$Config{&#39;use64bitint&#39;}&#41; ? 63 : 31;
+  $var = dualvar&#40;1&lt;&lt;$bits, &#34;&#34;&#41;;
+  ok&#40; isdual&#40;$var&#41;,		&#39;Is a dualvar&#39;&#41;;
+  ok&#40; $var == &#40;1&lt;&lt;$bits&#41;,	&#39;UV 1&#39;&#41;;
+  ok&#40; $var &gt; 0,			&#39;UV 2&#39;&#41;;
 }
 
+# Create a dualvar &#34;the old fashioned way&#34;
+$var = &#34;10&#34;;
+ok&#40; ! isdual&#40;$var&#41;,	&#39;Not a dualvar&#39;&#41;;
+my $foo = $var + 0;
+ok&#40; isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 
 {
   package Tied;
@@ -59,12 +72,54 @@
 
 tie my $tied, &#39;Tied&#39;;
 $var = dualvar&#40;$tied, &#34;ok&#34;&#41;;
+ok&#40;isdual&#40;$var&#41;,	&#39;Is a dualvar&#39;&#41;;
 ok&#40;$var == 7.5,		&#39;Tied num&#39;&#41;;
 ok&#40;$var eq &#39;ok&#39;,	&#39;Tied str&#39;&#41;;
 
 
 SKIP: {
-  skip&#40;&#34;need utf8::is_utf8&#34;,2&#41; unless defined &#38;utf8::is_utf8;
+  skip&#40;&#34;need utf8::is_utf8&#34;,3&#41; unless defined &#38;utf8::is_utf8;
   ok&#40;!!utf8::is_utf8&#40;dualvar&#40;1,chr&#40;400&#41;&#41;&#41;, &#39;utf8&#39;&#41;;
   ok&#40; !utf8::is_utf8&#40;dualvar&#40;1,&#34;abc&#34;&#41;&#41;,    &#39;not utf8&#39;&#41;;
 }
+
+
+SKIP: {
+  skip&#40;&#34;Perl not compiled with &#39;useithreads&#39;&#34;,20&#41; unless &#40;$Config{&#39;useithreads&#39;}&#41;;
+  require threads; import threads;
+  require threads::shared; import threads::shared;
+  skip&#40;&#34;Requires threads::shared v1.42 or later&#34;,20&#41; unless &#40;$threads::shared::VERSION &gt;= 1.42&#41;;
+
+  my $siv :shared = dualvar&#40;42, &#39;Fourty-Two&#39;&#41;;
+  my $snv :shared = dualvar&#40;3.14, &#39;PI&#39;&#41;;
+  my $bits = &#40;$Config{&#39;use64bitint&#39;}&#41; ? 63 : 31;
+  my $suv :shared = dualvar&#40;1&lt;&lt;$bits, &#39;Large unsigned int&#39;&#41;;
+
+  ok&#40;$siv == 42, &#39;Shared IV number preserved&#39;&#41;;
+  ok&#40;$siv eq &#39;Fourty-Two&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$siv&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$snv == 3.14, &#39;Shared NV number preserved&#39;&#41;;
+  ok&#40;$snv eq &#39;PI&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$snv&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$suv == &#40;1&lt;&lt;$bits&#41;, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$suv &gt; 0, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$suv eq &#39;Large unsigned int&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$suv&#41;, &#39;Is a dualvar&#39;&#41;;
+
+  my @ary :shared;
+  $ary[0] = $siv;
+  $ary[1] = $snv;
+  $ary[2] = $suv;
+
+  ok&#40;$ary[0] == 42, &#39;Shared IV number preserved&#39;&#41;;
+  ok&#40;$ary[0] eq &#39;Fourty-Two&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[0]&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$ary[1] == 3.14, &#39;Shared NV number preserved&#39;&#41;;
+  ok&#40;$ary[1] eq &#39;PI&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[1]&#41;, &#39;Is a dualvar&#39;&#41;;
+  ok&#40;$ary[2] == &#40;1&lt;&lt;$bits&#41;, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$ary[2] &gt; 0, &#39;Shared UV number preserved&#39;&#41;;
+  ok&#40;$ary[2] eq &#39;Large unsigned int&#39;, &#39;Shared string preserved&#39;&#41;;
+  ok&#40;isdual&#40;$ary[2]&#41;, &#39;Is a dualvar&#39;&#41;;
+}
+
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;14:42:35&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Merged &#40;with minor spacing modifications&#41;; in next release.

-- 

Paul Evans
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Dec&nbsp;16&nbsp;14:42:39&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;open&#39; to &#39;patched&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;17&nbsp;09:54:53&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Status changed from &#39;patched&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Dec&nbsp;17&nbsp;09:54:53&nbsp;2012</span>
    <span class="description">leonerd-cpan [...] leonerd.org.uk -  Fixed in 1.26 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
