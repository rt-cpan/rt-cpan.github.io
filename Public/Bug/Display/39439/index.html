<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #39439 for Glib: SvPVutf8 and friends considered harmful</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #39439 for Glib: SvPVutf8 and friends considered harmful</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Glib/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Glib/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Glib/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Glib/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Glib">Glib CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">39439</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Glib/Active/">Glib</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
schmorp [...] schmorp.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-14786-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-14787-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;19&nbsp;23:38:41&nbsp;2008</span>
    <span class="description">schmorp [...] schmorp.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> SvPVutf8 and friends considered harmful</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Sat, 20 Sep 2008 05:37:25 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Glib [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I recently stumbled over an issue with the Perl XS API where perl destroys
values. This problem is present in Glib as well.

Consider the following function:

   log_message &#40;SV *msg&#41;
           CODE:
           const char *msg_ = SvPVutf8_nolen &#40;msg&#41;;

This looks innocent enough, but when wants to log a reference, e.g. for
debuging purposes:

   my $ref = new Object;
   log_message $ref;

Then ref is changed into a string by SvPVutf8.

I consider this an API problem, but unfortunately, it won&#39;t be fixed within
perl.

I don&#39;t know the perfect solution for this, but I suspect that a wrapper
around SvPVutf8 and friends is required that checks whether an SV is
really a string, and only then call SvPVutf8 &#40;if it isn&#39;t a string,m then
SvPV will return a valid utf-8 string because it contains only ascii
characters&#41;.

If you want me to develop such a wrapper, just prompt me.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      pcg@goof.com
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;01&nbsp;09:58:01&nbsp;2008</span>
    <span class="description">kaffeetisch [...] gmx.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 19 23:38:41 2008, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I don&#39;t know the perfect solution for this, but I suspect that a wrapper
&gt; around SvPVutf8 and friends is required that checks whether an SV is
&gt; really a string, and only then call SvPVutf8 &#40;if it isn&#39;t a string,m then
&gt; SvPV will return a valid utf-8 string because it contains only ascii
&gt; characters&#41;.
&gt; 
&gt; If you want me to develop such a wrapper, just prompt me.
</div>
As far as I can see, SvPVutf8 or its companions are only used in
gperl_filename_from_sv, right?  So I think we could just fix it there,
if it needs fixing.  If you can come up with a test case that
demonstrates the problem, that would be appreciated.

And of course, a patch to fix the problem is more than welcome too!

-Torsten
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Nov&nbsp;01&nbsp;09:58:03&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;08&nbsp;14:34:32&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Sep 19 23:38:41 2008, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I recently stumbled over an issue with the Perl XS API where perl destroys
&gt; values. This problem is present in Glib as well.
&gt; 
&gt; Consider the following function:
&gt; 
&gt;    log_message &#40;SV *msg&#41;
&gt;          CODE:
&gt;            const char *msg_ = SvPVutf8_nolen &#40;msg&#41;;
&gt; 
&gt; This looks innocent enough, but when wants to log a reference, e.g. for
&gt; debuging purposes:
&gt; 
&gt;    my $ref = new Object;
&gt;    log_message $ref;
&gt; 
&gt; Then ref is changed into a string by SvPVutf8.
&gt; 
&gt; I consider this an API problem, but unfortunately, it won&#39;t be fixed within
&gt; perl.
</div>
I’ve just noticed this ticket.  This API problem was fixed in perl commit fe46cbda82 &#40;5.15.8&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I don&#39;t know the perfect solution for this, but I suspect that a wrapper
&gt; around SvPVutf8 and friends is required that checks whether an SV is
&gt; really a string, and only then call SvPVutf8 &#40;if it isn&#39;t a string,m then
&gt; SvPV will return a valid utf-8 string because it contains only ascii
&gt; characters&#41;.
</div>
Not true, as a reference could stringify to &#34;\xFF&#34; it if thas overloading.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; If you want me to develop such a wrapper, just prompt me.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;09&nbsp;01:03:30&nbsp;2013</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39439] SvPVutf8 and friends considered harmful</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Sep 2013 07:03:09 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Father Chrysostomos via RT &lt;bug-Glib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sun, Sep 08, 2013 at 02:34:33PM -0400, Father Chrysostomos via RT &lt;bug-Glib@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I consider this an API problem, but unfortunately, it won&#39;t be fixed within
&gt; &gt; perl.
</div>&gt; 
&gt; I’ve just noticed this ticket.  This API problem was fixed in perl commit fe46cbda82 &#40;5.15.8&#41;.
</div>
Good to hear that the perl maintainers reverted their opinion. Now they
only need to fix SvPV to be compatible with existing modules - ok, it&#39;s
hopeless, but I still dream of perl maintainers actually fixing these bugs
rather than cast them into concrete :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; I don&#39;t know the perfect solution for this, but I suspect that a wrapper
&gt; &gt; around SvPVutf8 and friends is required that checks whether an SV is
&gt; &gt; really a string, and only then call SvPVutf8 &#40;if it isn&#39;t a string,m then
&gt; &gt; SvPV will return a valid utf-8 string because it contains only ascii
&gt; &gt; characters&#41;.
</div>&gt; 
&gt; Not true, as a reference could stringify to &#34;\xFF&#34; it if thas overloading.
</div>
Well, according to your patch description, the patch is susceptible to
that problem too as it uses the same logic: &#34;As of commit fe46cbda82
SvPVutf8 no longer tries to coerce its argument if it is not already a
string.&#34;, so you are contradicting yourself here somewhere.

I still think the algorithm as outlined above &#40;and supposedly now in perl&#41;
works, as the result of a stringification only contains &#34;\xFF&#34; when it is
a string, so it should work for overloaded values.

Anyway, either there is a later patch that actually fixes it, or the
algorithm as outlined by me is actually correct, or both the algorithm and
perl are buggy - but something must give.

In the former two cases, this bug has been fixed. In the latter, perl is
still causing problems for overloaded values.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;09&nbsp;01:30:34&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 09 01:03:30 2013, schmorp@schmorp.de wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Sun, Sep 08, 2013 at 02:34:33PM -0400, Father Chrysostomos via RT
&gt; &lt;bug-Glib@rt.cpan.org&gt; wrote:
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I consider this an API problem, but unfortunately, it won&#39;t be
&gt; &gt; &gt; fixed within
&gt; &gt; &gt; perl.
</div>&gt; &gt;
&gt; &gt; I’ve just noticed this ticket.  This API problem was fixed in perl
&gt; &gt; commit fe46cbda82 &#40;5.15.8&#41;.
</div>&gt; 
&gt; Good to hear that the perl maintainers reverted their opinion.
</div>
I wasn’t aware of any opinion that SvPVutf8 wasn’t broken as originally implemented.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now
&gt; they
&gt; only need to fix SvPV to be compatible with existing modules - ok,
&gt; it&#39;s
&gt; hopeless, but I still dream of perl maintainers actually fixing these
&gt; bugs
&gt; rather than cast them into concrete :&#41;
</div>
That was long before I had anything to do with perl development.  I’m afraid it’s too late to do anything about that now, specially since the majority of XS modules have updated to do things the new way &#40;or were written after the new way became The Way&#41;.

It was actually 5.10’s utter brokenness that led me to start contributing to perl, since the hundreds of bugs introduced in it didn’t seem to be getting addressed.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; I don&#39;t know the perfect solution for this, but I suspect that a
&gt; &gt; &gt; wrapper
&gt; &gt; &gt; around SvPVutf8 and friends is required that checks whether an SV
&gt; &gt; &gt; is
&gt; &gt; &gt; really a string, and only then call SvPVutf8 &#40;if it isn&#39;t a
&gt; &gt; &gt; string,m then
&gt; &gt; &gt; SvPV will return a valid utf-8 string because it contains only
&gt; &gt; &gt; ascii
&gt; &gt; &gt; characters&#41;.
</div>&gt; &gt;
&gt; &gt; Not true, as a reference could stringify to &#34;\xFF&#34; it if thas
&gt; &gt; overloading.
</div>&gt; 
&gt; Well, according to your patch description, the patch is susceptible to
&gt; that problem too as it uses the same logic: &#34;As of commit fe46cbda82
&gt; SvPVutf8 no longer tries to coerce its argument if it is not already a
&gt; string.&#34;, so you are contradicting yourself here somewhere.
</div>
I meant that your workaround described above, if you want to apply it in 5.14 and before, would be incorrect if it used SvPV for references, as SvPV&#40;ref&#41; can return bytes sequences that are not valid UTF-8.

For 5.14, you would have to use SvPV, check the utf8 flag, and then convert the buffer if the utf8 flag was off.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; I still think the algorithm as outlined above &#40;and supposedly now in
&gt; perl&#41;
&gt; works, as the result of a stringification only contains &#34;\xFF&#34; when it
&gt; is
&gt; a string, so it should work for overloaded values.
</div>
The algorithm now in perl is to copy it first if it is a glob, a reference, a read-only non-PV, or a regular expression.  &#40;Incidentally, it would also copy a pad name, but the assumption is that pad names will never get through to that code.&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; Anyway, either there is a later patch that actually fixes it, or the
&gt; algorithm as outlined by me is actually correct, or both the algorithm
&gt; and
&gt; perl are buggy - but something must give.
</div>
I don’t quite understand.  I think it is because you misunderstood me.  I think I wasn’t clear enough at first.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the former two cases, this bug has been fixed. In the latter, perl
&gt; is
&gt; still causing problems for overloaded values.
</div>
Got me really confused there!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;09&nbsp;01:37:08&nbsp;2013</span>
    <span class="description">$_ = &#39;spro^^*%*^6ut# [...] &#38;$%*c&gt;#!^!#&#38;!pan.org&#39;; y/a-z.@//cd; print -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Sep 09 01:30:34 2013, SPROUT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &#40;Incidentally, it would also copy a pad name, but the assumption is
&gt; that pad names will never get through to that code.&#41;
</div>
Ahem.  Correction: it would copy a pad name representing a closed-over lexical declared outside the sub.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Sep&nbsp;09&nbsp;17:17:47&nbsp;2013</span>
    <span class="description">schmorp [...] schmorp.de -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #39439] SvPVutf8 and friends considered harmful</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 9 Sep 2013 23:17:27 +0200</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> Father Chrysostomos via RT &lt;bug-Glib [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Marc Lehmann &lt;schmorp [...] schmorp.de&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon, Sep 09, 2013 at 01:30:34AM -0400, Father Chrysostomos via RT &lt;bug-Glib@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I wasn’t aware of any opinion that SvPVutf8 wasn’t broken as originally implemented.
</div>
AS often, when I reported it, I was told that this isn&#39;t considered a bug,
but instead the usage of SvPVutf8 would be in error. I had to implement
workarounds in quite a few places.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; That was long before I had anything to do with perl development.  I’m
&gt; afraid it’s too late to do anything about that now, specially since
&gt; the majority of XS modules have updated to do things the new way &#40;or
&gt; were written after the new way became The Way&#41;.
</div>
Well, 99% of all statistics are made up on the spot, and this smells like
one. First of all, I doubt that this is even remotely true, and second,
all these new modules would unlikely to be broken, because very few
modules use SvPV and later check the utf-8 flag, and third, new modules
will suffer from the same bugs - each time xs modules use &#34;char *&#34; or
equivalent they are almost certain to be buggy, and a greta number of new
xs modules does exactly do that.

The problem is clearly ongoing, and not fixed as you naively assume.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It was actually 5.10’s utter brokenness that led me to start
&gt; contributing to perl, since the hundreds of bugs introduced in it
&gt; didn’t seem to be getting addressed.
</div>
I thank you for it.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open"><div class="message-stanza open">&gt; &gt; &gt; &gt; SvPV will return a valid utf-8 string because it contains only
&gt; &gt; &gt; &gt; ascii
&gt; &gt; &gt; &gt; characters&#41;.
</div>&gt; &gt; &gt;
&gt; &gt; &gt; Not true, as a reference could stringify to &#34;\xFF&#34; it if thas
&gt; &gt; &gt; overloading.
</div>&gt; &gt; 
&gt; &gt; Well, according to your patch description, the patch is susceptible to
&gt; &gt; that problem too as it uses the same logic: &#34;As of commit fe46cbda82
&gt; &gt; SvPVutf8 no longer tries to coerce its argument if it is not already a
&gt; &gt; string.&#34;, so you are contradicting yourself here somewhere.
</div>&gt; 
&gt; I meant that your workaround described above, if you want to apply it in 5.14 and before, would be incorrect if it used SvPV for references, as SvPV&#40;ref&#41; can return bytes sequences that are not valid UTF-8.
</div>
That obviously wouldn&#39;t be a problem, as SvPV would only be used in the
non-string case.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; For 5.14, you would have to use SvPV, check the utf8 flag, and then convert the buffer if the utf8 flag was off.
</div>
... or use any number of other correct ways that might or might not be
faster, smaller, or worse.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt; &gt; Anyway, either there is a later patch that actually fixes it, or the
&gt; &gt; algorithm as outlined by me is actually correct, or both the algorithm
&gt; &gt; and
&gt; &gt; perl are buggy - but something must give.
</div>&gt; 
&gt; I don’t quite understand.  I think it is because you misunderstood me.  I think I wasn’t clear enough at first.
</div>
No, the point was that your own patch used basically the same algorithm,
but for some reason you either applied a dual standard &#40;when you describe
the algorithm it&#39;s ok, when others do it&#39;s &#34;not true&#34;&#41;, or, more
importantly&#40;!&#41; at the time you wrote the patch you weren&#39;t aware of that
issue and the patch was wrong.

I felt it was my duty to point this out to you, as the latter case would
have meant that the problem you attributed to my description of the
algorithm would also be in yours, and thus, still in perl.

I&#39;m glad to hear that it was just you being more picky about my words than
your own, so the result seems sane.

In any case, this discussion is too drawn out and off-topic for
rt.cpan.org, as it&#39;s unrelated to the problem at hand, and since
rt.cpan.org has this idiotic behaviour of hiding e-mail addresses &#40;and
thus making it hard to contatc people directly&#41;, I won&#39;t spam it more
here.

-- 
                The choice of a       Deliantra, the free code+content MORPG
      -----==-     _GNU_              <span class="clickylink"><a target="new" rel="nofollow" href="http://www.deliantra.net">http://www.deliantra.net</a></span>
      ----==-- _       generation
      ---==---&#40;_&#41;__  __ ____  __      Marc Lehmann
      --==---/ / _ \/ // /\ \/ /      schmorp@schmorp.de
      -=====/_/_//_/\_,_/ /_/\_\
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Sep&nbsp;22&nbsp;10:02:32&nbsp;2013</span>
    <span class="description">kaffeetisch [...] gmx.de -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
