<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #18939 for Net-SSH2: Net::SSH2::Channel objects not getting destroyed</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #18939 for Net-SSH2: Net::SSH2::Channel objects not getting destroyed</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SSH2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SSH2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SSH2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SSH2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SSH2">Net-SSH2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">18939</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SSH2/Active/">Net-SSH2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
stephenclouse@gmail.com
(no email address)

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-23280-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.05    </td>
  </tr>
  <tr id="CF-23281-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Apr&nbsp;26&nbsp;13:58:07&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Net::SSH2::Channel objects not getting destroyed</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Bug report for Net::SSH2 0.07 running under perl 5.8.6 &#40;Fedora Core 4&#41;

I am using Net::SSH2 as part of a persistent daemon.  My issue is that
::Channel objects &#40;including those that are implicitly created by
scp_get&#41; are not getting destroyed, even though they are leaving
scope.  This prevents the main Net::SSH2 object from getting destroyed
when it goes out of scope, which causes both a memory leak and a
socket descriptor leak.  After a few hours of running, our process fd
space looks like this:

total 284
lrwx------  1 64 Apr  7 13:43 0 -&gt; /dev/pts/2
lrwx------  1 64 Apr  7 13:43 1 -&gt; /dev/pts/2
lrwx------  1 64 Apr  7 13:43 10 -&gt; socket:[23023727]
lrwx------  1 64 Apr  7 13:43 100 -&gt; socket:[25941479]
lrwx------  1 64 Apr  7 13:43 101 -&gt; socket:[25942954]
lrwx------  1 64 Apr  7 13:43 102 -&gt; socket:[25943607]
lrwx------  1 64 Apr  7 13:43 103 -&gt; socket:[25945043]
lrwx------  1 64 Apr  7 13:43 104 -&gt; socket:[25945575]
lrwx------  1 64 Apr  7 13:43 105 -&gt; socket:[25946014]
lrwx------  1 64 Apr  7 13:43 106 -&gt; socket:[25947262]
lrwx------  1 64 Apr  7 13:43 107 -&gt; socket:[25947851]
lrwx------  1 64 Apr  7 13:43 108 -&gt; socket:[25949223]
lrwx------  1 64 Apr  7 13:43 109 -&gt; socket:[25950742]
lrwx------  1 64 Apr  7 13:43 11 -&gt; socket:[23024789]
lrwx------  1 64 Apr  7 13:43 110 -&gt; socket:[25951710]
lrwx------  1 64 Apr  7 13:43 111 -&gt; socket:[25952922]
lrwx------  1 64 Apr  7 13:43 112 -&gt; socket:[25953707]
lrwx------  1 64 Apr  7 13:43 113 -&gt; socket:[25955436]
lrwx------  1 64 Apr  7 13:43 114 -&gt; socket:[25957008]
lrwx------  1 64 Apr  7 13:43 115 -&gt; socket:[25957766]
lrwx------  1 64 Apr  7 13:43 116 -&gt; socket:[25958984]
lrwx------  1 64 Apr  7 13:43 117 -&gt; socket:[25993099]

...and so on.  Eventually the process either consumes all memory or
hits the system fd limit and aborts.

Here is some debug output from two different sessions.  The first one
is looking for files to copy &#40;using SFTP stat&#41; but doesn&#39;t find any.
At the end the Net::SSH2 object is destroyed.

[debug] start ssh session
libssh2_sftp_init&#40;ss-&gt;session&#41; -&gt; 0xa7cc6c0
hv_from_attrs: attrs-&gt;flags = 15
hv_from_attrs: attrs-&gt;flags = 15
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0x0
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0x0
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0x0
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0x0
Net::SSH2::SFTP::DESTROY
Net::SSH2::SFTP::DESTROY freeing session
Net::SSH2::DESTROY
[debug] end ssh session

The second session does find files it needs to pull down, and calls
scp_get to copy them.  Notice the destructor is NOT getting called at
the end.

[debug] start ssh session
libssh2_sftp_init&#40;ss-&gt;session&#41; -&gt; 0xab1d610
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0xa7cdc88
libssh2_scp_recv&#40;ss-&gt;session, path, &#38;st&#41; -&gt; 0xcc0aa88
Net::SSH2::Channel::read&#40;size = 1736739, ext = 0&#41;
- read 1736739 total
Net::SSH2::Channel::read&#40;size = 1, ext = 0&#41;
- read 1 bytes
- read 1 total
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0xc403f38
libssh2_scp_recv&#40;ss-&gt;session, path, &#38;st&#41; -&gt; 0xb50bae8
Net::SSH2::Channel::read&#40;size = 826046, ext = 0&#41;
- read 826046 total
Net::SSH2::Channel::read&#40;size = 1, ext = 0&#41;
- read 1 bytes
- read 1 total
libssh2_sftp_open_ex&#40;sf-&gt;sftp, &#40;char*&#41;pv_file, len_file, l_flags,
mode, 0&#41; -&gt; 0xa7d2b60
libssh2_scp_recv&#40;ss-&gt;session, path, &#38;st&#41; -&gt; 0xafb63c8
Net::SSH2::Channel::read&#40;size = 28231, ext = 0&#41;
- read 28231 total
Net::SSH2::Channel::read&#40;size = 1, ext = 0&#41;
- read 1 bytes
- read 1 total
[debug] end ssh session

We have another process similar to this one that opens a shell
channel, which suffers from the same problem.  Even when the channel
object goes out of scope in our program, its destructor is not called,
and so the Net::SSH2 object is not destroyed either.

The test script itself exhibits this same behavior, if the full
interactive test is run.  DESTROY is never called.

I have tried debugging this myself to no avail.  I cannot find where the
refcounts are getting erroneously incremented.

I also sent an email on this issue to the ssh-sftp-users-list on 4/7 but
never received a reply.  I&#39;m hoping this is a better way to get
someone&#39;s attention.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;May&nbsp;09&nbsp;01:21:57&nbsp;2006</span>
    <span class="description">dbrobins [...] cpan.org -  Status changed from &#39;new&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
