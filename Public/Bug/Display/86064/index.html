<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #86064 for URI: URI-&gt;as_iri can produce both bytes and characters, depending on input</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #86064 for URI: URI-&gt;as_iri can produce both bytes and characters, depending on input</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/URI/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/URI/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/URI/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/URI/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/URI">URI CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">86064</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/URI/Active/">URI</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
gwilliams [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34672-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-34673-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
1.60    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




iri_encoding.diff<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1222926/645916/iri_encoding.diff">
Tue Jun 11 16:16:19 2013 (485b) by gwilliams [...] cpan.org
</a>
</font></li>
</ul>


iri_encoding.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1222926/645917/iri_encoding.pl">
Tue Jun 11 16:16:19 2013 (222b) by gwilliams [...] cpan.org
</a>
</font></li>
</ul>


signature.asc<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/1445961/768774/signature.asc">
Wed Dec 24 18:52:15 2014 (949b) by dr [...] jones.dk
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;11&nbsp;16:16:19&nbsp;2013</span>
    <span class="description">gwilliams [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The URI-&gt;as_iri method seems to produce both character strings and byte sequences depending on the input of punycode URIs. This makes dealing with the output difficult when trying to sensibly combine it with other strings. It seems to me that the difference depends on whether the decoded punycode value only contains codepoints that can be represented in latin-1. The attached test script shows the decoding of two punycode URIs:

<span class="clickylink"><a target="new" rel="nofollow" href="http://www.hestebedg">http://www.hestebedg</a></span>ård.dk/
http://✪df.ws/

Using Devel::Peek, it can be seen that &#34;hestebedgård&#34; is represented as a byte sequence with U+00e5 being represented as the single byte 0xE5 with the SV lacking the UTF8 flag. On the other hand, &#34;✪df&#34; is represented as a UTF8-flagged character string with the first character correctly encoded as \x{272a}.

I believe the attached patch solves this problem, but I&#39;m not sure if it might break any other cases, or if there&#39;s a better way of forcing the decoded unicode string to have the UTF8 flag.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iri_encoding.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- URI/_punycode.pm.orig	2013-06-09 10:14:14.000000000 +0400
+++ URI/_punycode.pm.new	2013-06-11 11:49:19.000000000 +0400
@@ -86,7 +86,11 @@
 	warn join &#34; &#34;, map sprintf&#40;&#39;%04x&#39;, $_&#41;, @output if $DEBUG;
 	$i++;
     }
-    return join &#39;&#39;, map chr, @output;
+    my $uri	= join &#39;&#39;, map chr, @output;
+    use Encode;
+    my $octets     = encode&#40;&#39;UTF-8&#39;, $uri, Encode::FB_CROAK&#41;;
+    $uri = decode&#40;&#39;UTF-8&#39;, $octets,     Encode::FB_CROAK&#41;;
+    return $uri;
 }
 
 sub encode_punycode {
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> iri_encoding.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;
use Devel::Peek;
use URI;

my $latin1	= URI-&gt;new&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.xn--hestebedgrd-58a.dk/&#39;&#41;-">http://www.xn--hestebedgrd-58a.dk/&#39;&#41;-</a></span>&gt;as_iri;
my $utf8	= URI-&gt;new&#40;&#39;<span class="clickylink"><a target="new" rel="nofollow" href="http://xn--df-oiy.ws/&#39;&#41;-">http://xn--df-oiy.ws/&#39;&#41;-</a></span>&gt;as_iri;

Dump&#40;$latin1&#41;;
Dump&#40;$utf8&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;11&nbsp;16:20:09&nbsp;2013</span>
    <span class="description">gwilliams [...] cpan.org -  Subject changed from &#40;no value&#41; to &#39;URI-&gt;as_iri can produce both bytes and characters, depending on input&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;15:25:30&nbsp;2013</span>
    <span class="description">GAAS [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">On Tue Jun 11 16:16:19 2013, GWILLIAMS wrote:<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The URI-&gt;as_iri method seems to produce both character strings and<br>

&gt; byte sequences depending on the input of punycode URIs. This makes<br>

&gt; dealing with the output difficult when trying to sensibly combine<br>

&gt; it with other strings.<br>
</div><br>

There should not really be an semantic difference between utf8::upgraded or utf8::downgraded strings. &nbsp;If you have problems combining the result with other strings there is something else that&#39;s not quite right. &nbsp;The simplest way to upgrade is to just call:<br>

<br>

&nbsp; utf8::upgrade($iri);<br>

<br>

I don&#39;t really think $url-&gt;as_iri should change. &nbsp;At least I would like to see a stronger argument before we do.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Jun&nbsp;12&nbsp;15:25:30&nbsp;2013</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jun&nbsp;15&nbsp;09:30:57&nbsp;2013</span>
    <span class="description">gwilliams [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Wed Jun 12 15:25:30 2013, GAAS wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There should not really be an semantic difference between
&gt; utf8::upgraded or
&gt; utf8::downgraded strings. If you have problems combining the result
&gt; with other
&gt; strings there is something else that&#39;s not quite right. The simplest
&gt; way to
&gt; upgrade is to just call:
&gt; 
&gt; utf8::upgrade&#40;$iri&#41;;
&gt; 
&gt; I don&#39;t really think $url-&gt;as_iri should change. At least I would like
&gt; to see a
&gt; stronger argument before we do.
</div>
That&#39;s a fair point. The problem may be more complex than I thought. I believe the problem I&#39;m facing now &#40;related to a bug-report I received for RDF::Trine&#41; is that the string ends up being passed to a system library via XS that expects UTF8 encoded data, and has trouble with the latin-1. Moreover, the punycode spec as well as the documentation for as_iri talk explicitly about unicode strings, so I&#39;m not sure why the appropriate place to make the utf8::upgrade call wouldn&#39;t be in the as_iri implementation. Thoughts?

thanks,
.greg
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Dec&nbsp;24&nbsp;18:52:15&nbsp;2014</span>
    <span class="description">dr [...] jones.dk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [rt.cpan.org #86064] utf8::upgraded input produce utf8::downgraded output</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 25 Dec 2014 00:51:54 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-URI [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Jonas Smedegaard &lt;dr [...] jones.dk&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Gisle,

Comparing this bugreport with <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/kasei/perl-iri/issues/2">https://github.com/kasei/perl-iri/issues/2</a></span> 
&#40;understanding far better now than when I followed along a year ago&#41;, it 
occurs to me that in this conversation it is not clear that URI module 
degrades already utf8::upgraded strings.

Perhaps that is the &#34;stronger argument&#34; that you sought back then?

This demonstrates the degradation &#40;based on above IRI conversation&#41;:

use URI;
use Devel::Peek;

my $value   = &#34;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.hestebedg">http://www.hestebedg</a></span>\x{e5}rd.dk/#frag&#34;;
utf8::upgrade&#40;$value&#41;;
print STDERR &#34;Raw value: &#34;;
Dump&#40;$value&#41;;

my $uri = URI-&gt;new&#40;$value&#41;;
print STDERR &#34;URI as_iri: &#34;;
Dump&#40;$uri-&gt;as_iri&#41;;


Regards,

 - Jonas

P.S.

&#34;Hestebedgård&#34; is a farm turned into a museum, located on the island of 
Orø where I live.  I hit bugs in RDF::Trine when challenging myself to 
learn RDF by semantically modelling public facilities on my island - 
leading e.g. to <span class="clickylink"><a target="new" rel="nofollow" href="http://data.biks.dk/hours/">http://data.biks.dk/hours/</a></span>

...in case you are curious and do not grok scandinavian language &#40;as 
your name and interest in non-ASCII characters indicates&#41;.

-- 
 * Jonas Smedegaard - idealist &#38; Internet-arkitekt
 * Tlf.: +45 40843136  Website: <span class="clickylink"><a target="new" rel="nofollow" href="http://dr.jones.dk/">http://dr.jones.dk/</a></span>

 [x] quote me freely  [ ] ask before reusing  [ ] keep private
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/1445961/768774/signature.asc">Download signature.asc</a><br />
<span class="downloadcontenttype">application/pgp-signature 949b</span>
</div>
<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
