<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #98837 for Net-SAML2: POST binding verifies using cert in response</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #98837 for Net-SAML2: POST binding verifies using cert in response</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-SAML2/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-SAML2/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-SAML2/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-SAML2/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-SAML2">Net-SAML2 CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">98837</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-SAML2/Active/">Net-SAML2</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">TIMLEGGE [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
ysth [...] shiftboard.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-236562-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-236563-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
0.20    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;12&nbsp;13:20:39&nbsp;2014</span>
    <span class="description">ysth [...] shiftboard.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> POST binding verifies using cert in response</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Fri, 12 Sep 2014 10:20:23 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-Net-SAML2 [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yitzchak Scott-Thoennes &lt;ysth [...] shiftboard.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The Net::SAML2 synopsis says:

      my $post = Net::SAML2::Binding::POST-&gt;new;
      my $ret = $post-&gt;handle_response&#40;
              $saml_response
      &#41;;

This works for me, except that it is using the X509 cert embedded in
the response to verify the response signature, not the X509 cert I
have from the IdP metadata.  And there doesn&#39;t seem to be a way to
provide the metadata cert.

Trusting the response&#39;s cert makes verifying the signature meaningless
from a security standpoint.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;12&nbsp;13:26:49&nbsp;2014</span>
    <span class="description">CHRISA [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">It&#39;s true that we verify the Assertion using the embedded certificate, but there&#39;s also a check in there for a trust path from that certificate back to the configured CA certificate.

This means that only Assertions from IdPs which have certificates signed by the CA are accepted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;12&nbsp;13:26:50&nbsp;2014</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;06&nbsp;17:40:15&nbsp;2015</span>
    <span class="description">bitcard [...] 32ths.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Just wanted to +1 the need for verifying the Response against the IDP cert metadata.

handle_response does two things.

1. verify the SignedInfo XML data against the signature
2. verify that the certificate used to sign the assertion was issued by the cacert you know and trust. 

The problem is with #2. 

SAML doesn&#39;t require X509Data. In fact it doesn&#39;t require KeyInfo. This particular IDP i&#39;m working with provides KeyInfo with the signature etc, but no X509Data, therefore no signing certificate.

Without being able to verify the XML against the IDP certificate we received from the metadata, the module die&#39;s with the following:

Crypt::OpenSSL::VerifyX509::verify: x509 is not of type Crypt::OpenSSL::X509 at

This is because  of the following:

In handle_response &#40;paraphrasing&#41;:
my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41; is called. Here we would want to pass in cert =&gt; from the idp to verify. Lacking that we call

$x-&gt;verify...

If your Response does not have X509Data provided, the subsequent validation attempt of signer_cert fails &#40;signer_cert will be undef&#41;.

- Mike


On Fri Sep 12 13:26:49 2014, CHRISA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; It&#39;s true that we verify the Assertion using the embedded certificate,
&gt; but there&#39;s also a check in there for a trust path from that
&gt; certificate back to the configured CA certificate.
&gt; 
&gt; This means that only Assertions from IdPs which have certificates
&gt; signed by the CA are accepted.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;06&nbsp;17:45:19&nbsp;2015</span>
    <span class="description">bitcard [...] 32ths.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Ugh sorry end of the day:

Here is handle_response &#40;trimmed&#41;

sub handle_response {
    ...
    my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41;;
    my $ret = $x-&gt;verify&#40;$xml&#41;;
    die &#34;signature check failed&#34; unless $ret;

    # verify the signing certificate
    my $cert = $x-&gt;signer_cert;
    my $ca = Crypt::OpenSSL::VerifyX509-&gt;new&#40;$self-&gt;cacert&#41;;
    $ret = $ca-&gt;verify&#40;$cert&#41;;
    ...
}

$x-&gt;verify clears signer_cert. It only sets it after a successful verification of X509Data. Since no X509Data exists in the XML, $x-&gt;verify uses rsa to verify the signature &#40;which works, but does not set signer_cert, it cant!&#41;

The next $ca-&gt;verify&#40;$cert&#41; fails. &#40;$cert is undef&#41;.

On Tue Jan 06 17:40:15 2015, xmikew wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Just wanted to +1 the need for verifying the Response against the IDP
&gt; cert metadata.
&gt; 
&gt; handle_response does two things.
&gt; 
&gt; 1. verify the SignedInfo XML data against the signature
&gt;  2. verify that the certificate used to sign the assertion was issued
&gt; by the cacert you know and trust.
&gt; 
&gt; The problem is with #2.
&gt; 
&gt; SAML doesn&#39;t require X509Data. In fact it doesn&#39;t require KeyInfo.
&gt; This particular IDP i&#39;m working with provides KeyInfo with the
&gt; signature etc, but no X509Data, therefore no signing certificate.
&gt; 
&gt; Without being able to verify the XML against the IDP certificate we
&gt; received from the metadata, the module die&#39;s with the following:
&gt; 
&gt; Crypt::OpenSSL::VerifyX509::verify: x509 is not of type
&gt; Crypt::OpenSSL::X509 at
&gt; 
&gt; This is because  of the following:
&gt; 
&gt; In handle_response &#40;paraphrasing&#41;:
&gt; my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41; is called. Here we
&gt; would want to pass in cert =&gt; from the idp to verify. Lacking that we
&gt; call
&gt; 
&gt; $x-&gt;verify...
&gt; 
&gt; If your Response does not have X509Data provided, the subsequent
&gt; validation attempt of signer_cert fails &#40;signer_cert will be undef&#41;.
&gt; 
&gt; - Mike
&gt; 
&gt; 
&gt; On Fri Sep 12 13:26:49 2014, CHRISA wrote:
<div class="message-stanza open">&gt; &gt; It&#39;s true that we verify the Assertion using the embedded
&gt; &gt; certificate,
&gt; &gt; but there&#39;s also a check in there for a trust path from that
&gt; &gt; certificate back to the configured CA certificate.
&gt; &gt;
&gt; &gt; This means that only Assertions from IdPs which have certificates
&gt; &gt; signed by the CA are accepted.
</div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jan&nbsp;06&nbsp;18:04:52&nbsp;2015</span>
    <span class="description">bitcard [...] 32ths.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">My Quick fix is for the POST.pm module to accept a cert option that I can provide the IDP cert to. If this exists, we verify it against our cacert. Otherwise, we see if signer_cert is there, and then use that. If neither exist, die with useful error. I&#39;ll send a pull request along to github for your review.

Thanks,

- Mike

On Tue Jan 06 17:45:19 2015, xmikew wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Ugh sorry end of the day:
&gt; 
&gt; Here is handle_response &#40;trimmed&#41;
&gt; 
&gt; sub handle_response {
&gt;     ...
&gt;     my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41;;
&gt;     my $ret = $x-&gt;verify&#40;$xml&#41;;
&gt;     die &#34;signature check failed&#34; unless $ret;
&gt; 
&gt; # verify the signing certificate
&gt; my $cert = $x-&gt;signer_cert;
&gt; my $ca = Crypt::OpenSSL::VerifyX509-&gt;new&#40;$self-&gt;cacert&#41;;
&gt; $ret = $ca-&gt;verify&#40;$cert&#41;;
&gt; ...
&gt; }
&gt; 
&gt; $x-&gt;verify clears signer_cert. It only sets it after a successful
&gt; verification of X509Data. Since no X509Data exists in the XML, $x-
<div class="message-stanza open">&gt; &gt;verify uses rsa to verify the signature &#40;which works, but does not
</div>&gt; set signer_cert, it cant!&#41;
&gt; 
&gt; The next $ca-&gt;verify&#40;$cert&#41; fails. &#40;$cert is undef&#41;.
&gt; 
&gt; On Tue Jan 06 17:40:15 2015, xmikew wrote:
<div class="message-stanza open">&gt; &gt; Just wanted to +1 the need for verifying the Response against the IDP
&gt; &gt; cert metadata.
&gt; &gt;
&gt; &gt; handle_response does two things.
&gt; &gt;
&gt; &gt; 1. verify the SignedInfo XML data against the signature
&gt; &gt;  2. verify that the certificate used to sign the assertion was issued
&gt; &gt; by the cacert you know and trust.
&gt; &gt;
&gt; &gt; The problem is with #2.
&gt; &gt;
&gt; &gt; SAML doesn&#39;t require X509Data. In fact it doesn&#39;t require KeyInfo.
&gt; &gt; This particular IDP i&#39;m working with provides KeyInfo with the
&gt; &gt; signature etc, but no X509Data, therefore no signing certificate.
&gt; &gt;
&gt; &gt; Without being able to verify the XML against the IDP certificate we
&gt; &gt; received from the metadata, the module die&#39;s with the following:
&gt; &gt;
&gt; &gt; Crypt::OpenSSL::VerifyX509::verify: x509 is not of type
&gt; &gt; Crypt::OpenSSL::X509 at
&gt; &gt;
&gt; &gt; This is because  of the following:
&gt; &gt;
&gt; &gt; In handle_response &#40;paraphrasing&#41;:
&gt; &gt; my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41; is called. Here we
&gt; &gt; would want to pass in cert =&gt; from the idp to verify. Lacking that we
&gt; &gt; call
&gt; &gt;
&gt; &gt; $x-&gt;verify...
&gt; &gt;
&gt; &gt; If your Response does not have X509Data provided, the subsequent
&gt; &gt; validation attempt of signer_cert fails &#40;signer_cert will be undef&#41;.
&gt; &gt;
&gt; &gt; - Mike
&gt; &gt;
&gt; &gt;
&gt; &gt; On Fri Sep 12 13:26:49 2014, CHRISA wrote:
<div class="message-stanza open">&gt; &gt; &gt; It&#39;s true that we verify the Assertion using the embedded
&gt; &gt; &gt; certificate,
&gt; &gt; &gt; but there&#39;s also a check in there for a trust path from that
&gt; &gt; &gt; certificate back to the configured CA certificate.
&gt; &gt; &gt;
&gt; &gt; &gt; This means that only Assertions from IdPs which have certificates
&gt; &gt; &gt; signed by the CA are accepted.
</div></div></div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;21:37:32&nbsp;2020</span>
    <span class="description">TIMLEGGE [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Jan 06 18:04:52 2015, xmikew wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; My Quick fix is for the POST.pm module to accept a cert option that I
&gt; can provide the IDP cert to. If this exists, we verify it against our
&gt; cacert. Otherwise, we see if signer_cert is there, and then use that.
&gt; If neither exist, die with useful error. I&#39;ll send a pull request
&gt; along to github for your review.
&gt; 
&gt; Thanks,
&gt; 
&gt; - Mike
&gt; 
&gt; On Tue Jan 06 17:45:19 2015, xmikew wrote:
<div class="message-stanza open">&gt; &gt; Ugh sorry end of the day:
&gt; &gt;
&gt; &gt; Here is handle_response &#40;trimmed&#41;
&gt; &gt;
&gt; &gt; sub handle_response {
&gt; &gt;     ...
&gt; &gt;     my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41;;
&gt; &gt;     my $ret = $x-&gt;verify&#40;$xml&#41;;
&gt; &gt;     die &#34;signature check failed&#34; unless $ret;
&gt; &gt;
&gt; &gt; # verify the signing certificate
&gt; &gt; my $cert = $x-&gt;signer_cert;
&gt; &gt; my $ca = Crypt::OpenSSL::VerifyX509-&gt;new&#40;$self-&gt;cacert&#41;;
&gt; &gt; $ret = $ca-&gt;verify&#40;$cert&#41;;
&gt; &gt; ...
&gt; &gt; }
&gt; &gt;
&gt; &gt; $x-&gt;verify clears signer_cert. It only sets it after a successful
&gt; &gt; verification of X509Data. Since no X509Data exists in the XML, $x-
<div class="message-stanza open">&gt; &gt; &gt; verify uses rsa to verify the signature &#40;which works, but does not
</div>&gt; &gt; set signer_cert, it cant!&#41;
&gt; &gt;
&gt; &gt; The next $ca-&gt;verify&#40;$cert&#41; fails. &#40;$cert is undef&#41;.
&gt; &gt;
&gt; &gt; On Tue Jan 06 17:40:15 2015, xmikew wrote:
<div class="message-stanza open">&gt; &gt; &gt; Just wanted to +1 the need for verifying the Response against the
&gt; &gt; &gt; IDP
&gt; &gt; &gt; cert metadata.
&gt; &gt; &gt;
&gt; &gt; &gt; handle_response does two things.
&gt; &gt; &gt;
&gt; &gt; &gt; 1. verify the SignedInfo XML data against the signature
&gt; &gt; &gt;  2. verify that the certificate used to sign the assertion was
&gt; &gt; &gt; issued
&gt; &gt; &gt; by the cacert you know and trust.
&gt; &gt; &gt;
&gt; &gt; &gt; The problem is with #2.
&gt; &gt; &gt;
&gt; &gt; &gt; SAML doesn&#39;t require X509Data. In fact it doesn&#39;t require KeyInfo.
&gt; &gt; &gt; This particular IDP i&#39;m working with provides KeyInfo with the
&gt; &gt; &gt; signature etc, but no X509Data, therefore no signing certificate.
&gt; &gt; &gt;
&gt; &gt; &gt; Without being able to verify the XML against the IDP certificate we
&gt; &gt; &gt; received from the metadata, the module die&#39;s with the following:
&gt; &gt; &gt;
&gt; &gt; &gt; Crypt::OpenSSL::VerifyX509::verify: x509 is not of type
&gt; &gt; &gt; Crypt::OpenSSL::X509 at
&gt; &gt; &gt;
&gt; &gt; &gt; This is because  of the following:
&gt; &gt; &gt;
&gt; &gt; &gt; In handle_response &#40;paraphrasing&#41;:
&gt; &gt; &gt; my $x = Net::SAML2::XML::Sig-&gt;new&#40;{ x509 =&gt; 1 }&#41; is called. Here we
&gt; &gt; &gt; would want to pass in cert =&gt; from the idp to verify. Lacking that
&gt; &gt; &gt; we
&gt; &gt; &gt; call
&gt; &gt; &gt;
&gt; &gt; &gt; $x-&gt;verify...
&gt; &gt; &gt;
&gt; &gt; &gt; If your Response does not have X509Data provided, the subsequent
&gt; &gt; &gt; validation attempt of signer_cert fails &#40;signer_cert will be
&gt; &gt; &gt; undef&#41;.
&gt; &gt; &gt;
&gt; &gt; &gt; - Mike
&gt; &gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; On Fri Sep 12 13:26:49 2014, CHRISA wrote:
<div class="message-stanza open">&gt; &gt; &gt; &gt; It&#39;s true that we verify the Assertion using the embedded
&gt; &gt; &gt; &gt; certificate,
&gt; &gt; &gt; &gt; but there&#39;s also a check in there for a trust path from that
&gt; &gt; &gt; &gt; certificate back to the configured CA certificate.
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; This means that only Assertions from IdPs which have certificates
&gt; &gt; &gt; &gt; signed by the CA are accepted.
</div></div></div></div>
Logged at <span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/timlegge/perl-Net-SAML2/issues/11">https://github.com/timlegge/perl-Net-SAML2/issues/11</a></span> so it is noted in the next release.  That is a fork of xmikew repo that includes the fix
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Apr&nbsp;07&nbsp;21:37:32&nbsp;2020</span>
    <span class="description">TIMLEGGE [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;13&nbsp;22:26:45&nbsp;2020</span>
    <span class="description">TIMLEGGE [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;13&nbsp;22:26:46&nbsp;2020</span>
    <span class="description">TIMLEGGE [...] cpan.org -  Fixed in 0.20 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
