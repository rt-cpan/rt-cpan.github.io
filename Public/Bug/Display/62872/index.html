<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #62872 for Cache-Memcached: Problems when using more than one instance of C::M</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #62872 for Cache-Memcached: Problems when using more than one instance of C::M</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Cache-Memcached/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Cache-Memcached/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Cache-Memcached/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Cache-Memcached/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Cache-Memcached">Cache-Memcached CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">62872</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Cache-Memcached/Active/">Cache-Memcached</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
dst [...] heise.de

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-4860-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
1.29    </td>
  </tr>
  <tr id="CF-4861-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Nov&nbsp;09&nbsp;10:48:52&nbsp;2010</span>
    <span class="description">dst [...] heise.de -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Problems when using more than one instance of C::M</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

beginning with version 1.29 it is impossible to use more than one
instance of Cache::Memcached.  Calling &#34;disconnect_all&#34; on one
instance can leave another instance in a broken state, making it
die on subsequent calls.

I&#39;ve attached a small script that can reproduce this problem here
using Perl 5.12.1 and Cache::MemCached 1.29. The same script works 
properly on version 1.28.

I think there is some confusion around the instance variables &#34;buckets&#34;,
&#34;buck2sock&#34; and the lexical variables &#34;sock_map&#34; and &#34;cache_sock&#34;.

I have attached a patch that makes &#34;sock_map&#34; and &#34;cache_sock&#34; local
to each instance. The patch seems to fix this issue for us but it has
not gotten much testing and I&#39;m not sure whether it has any side 
effects.

Cheers,
Dennis
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> instances.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /tmp/Memcached.pm	2010-11-09 15:54:43.447990000 +0100
+++ /opt/perl/5.12.1/local/share/perl/5.12.1/Cache/Memcached.pm	2010-11-09 16:39:07.000000000 +0100
@@ -27,6 +27,8 @@
     connect_timeout cb_connect_fail
     parser_class
     buck2sock
+	cache_sock
+	sock_map
 };
 
 # flag definitions
@@ -56,7 +58,6 @@
 eval { $FLAG_NOSIGNAL = MSG_NOSIGNAL; };
 
 my %host_dead;   # host -&gt; unixtime marked dead until
-my %cache_sock;  # host -&gt; socket
 
 my $PROTO_TCP;
 
@@ -80,6 +81,9 @@
     $self-&gt;{&#39;readonly&#39;} = $args-&gt;{&#39;readonly&#39;};
     $self-&gt;{&#39;parser_class&#39;} = $args-&gt;{&#39;parser_class&#39;} || $parser_class;
 
+	$self-&gt;{&#39;cache_sock&#39;} = {};
+	$self-&gt;{&#39;sock_map&#39;} = {};
+
     # TODO: undocumented
     $self-&gt;{&#39;connect_timeout&#39;} = $args-&gt;{&#39;connect_timeout&#39;} || 0.25;
     $self-&gt;{&#39;select_timeout&#39;}  = $args-&gt;{&#39;select_timeout&#39;}  || 1.0;
@@ -104,6 +108,9 @@
     $self-&gt;init_buckets;
     $self-&gt;{&#39;buck2sock&#39;}= [];
 
+	$self-&gt;{&#39;cache_sock&#39;} = {};
+	$self-&gt;{&#39;sock_map&#39;} = {};
+
     $self-&gt;{&#39;_single_sock&#39;} = undef;
     if &#40;@{$self-&gt;{&#39;servers&#39;}} == 1&#41; {
         $self-&gt;{&#39;_single_sock&#39;} = $self-&gt;{&#39;servers&#39;}[0];
@@ -164,16 +171,14 @@
     $self-&gt;{&#39;stat_callback&#39;} = $stat_callback;
 }
 
-my %sock_map;  # stringified-$sock -&gt; &#34;$ip:$port&#34;
-
 sub _dead_sock {
     my &#40;$self, $sock, $ret, $dead_for&#41; = @_;
-    if &#40;my $ipport = $sock_map{$sock}&#41; {
+    if &#40;my $ipport = $self-&gt;{sock_map}{$sock}&#41; {
         my $now = time&#40;&#41;;
         $host_dead{$ipport} = $now + $dead_for
             if $dead_for;
-        delete $cache_sock{$ipport};
-        delete $sock_map{$sock};
+        delete $self-&gt;{cache_sock}{$ipport};
+        delete $self-&gt;{sock_map}{$sock};
     }
     $self-&gt;{&#39;buck2sock&#39;} = [] if $self;
     return $ret;  # 0 or undef, probably, depending on what caller wants
@@ -181,10 +186,10 @@
 
 sub _close_sock {
     my &#40;$self, $sock&#41; = @_;
-    if &#40;my $ipport = $sock_map{$sock}&#41; {
+    if &#40;my $ipport = $self-&gt;{sock_map}{$sock}&#41; {
         close $sock;
-        delete $cache_sock{$ipport};
-        delete $sock_map{$sock};
+        delete $self-&gt;{cache_sock}{$ipport};
+        delete $self-&gt;{sock_map}{$sock};
     }
     $self-&gt;{&#39;buck2sock&#39;} = [];
 }
@@ -231,7 +236,7 @@
 sub sock_to_host { # &#40;host&#41;  #why is this public? I wouldn&#39;t have to worry about undef $self if it weren&#39;t.
     my Cache::Memcached $self = ref $_[0] ? shift : undef;
     my $host = $_[0];
-    return $cache_sock{$host} if $cache_sock{$host};
+    return $self-&gt;{cache_sock}{$host} if $self-&gt;{cache_sock}{$host};
 
     my $now = time&#40;&#41;;
     my &#40;$ip, $port&#41; = $host =~ /&#40;.*&#41;:&#40;\d+&#41;$/;
@@ -255,12 +260,12 @@
             if &#40;$HAVE_SOCKET6 &#38;&#38; index&#40;$prefip, &#39;:&#39;&#41; != -1&#41; {
                 no strict &#39;subs&#39;;  # for PF_INET6 and AF_INET6, weirdly imported
                 socket&#40;$sock, PF_INET6, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{sock_map}{$sock} = $host;
                 $sin = Socket6::pack_sockaddr_in6&#40;$port,
                                                   Socket6::inet_pton&#40;AF_INET6, $prefip&#41;&#41;;
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{sock_map}{$sock} = $host;
                 $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$prefip&#41;&#41;;
             }
 
@@ -279,12 +284,12 @@
             if &#40;$HAVE_SOCKET6 &#38;&#38; index&#40;$ip, &#39;:&#39;&#41; != -1&#41; {
                 no strict &#39;subs&#39;;  # for PF_INET6 and AF_INET6, weirdly imported
                 socket&#40;$sock, PF_INET6, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{sock_map}{$sock} = $host;
                 $sin = Socket6::pack_sockaddr_in6&#40;$port,
                                                   Socket6::inet_pton&#40;AF_INET6, $ip&#41;&#41;;
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{sock_map}{$sock} = $host;
                 $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$ip&#41;&#41;;
             }
 
@@ -297,7 +302,7 @@
         }
     } else { # it&#39;s a unix domain/local socket
         socket&#40;$sock, PF_UNIX, SOCK_STREAM, 0&#41;;
-        $sock_map{$sock} = $host;
+        $self-&gt;{sock_map}{$sock} = $host;
         $sin = Socket::sockaddr_un&#40;$host&#41;;
         my $timeout = $self ? $self-&gt;{connect_timeout} : 0.25;
         unless &#40;_connect_sock&#40;$sock,$sin,$timeout&#41;&#41; {
@@ -312,7 +317,7 @@
     $| = 1;
     select&#40;$old&#41;;
 
-    $cache_sock{$host} = $sock;
+    $self-&gt;{cache_sock}{$host} = $sock;
 
     return $sock;
 }
@@ -353,10 +358,10 @@
 sub disconnect_all {
     my Cache::Memcached $self = shift;
     my $sock;
-    foreach $sock &#40;values %cache_sock&#41; {
+    foreach $sock &#40;values %{ $self-&gt;{cache_sock} } &#41; {
         close $sock;
     }
-    %cache_sock = &#40;&#41;;
+    $self-&gt;{cache_sock} = {};
     $self-&gt;{&#39;buck2sock&#39;} = [];
 }
 
@@ -714,8 +719,8 @@
     };
 
     foreach &#40;keys %$sock_keys&#41; {
-        my $ipport = $sock_map{$_}        or die &#34;No map found matching for $_&#34;;
-        my $sock   = $cache_sock{$ipport} or die &#34;No sock found for $ipport&#34;;
+        my $ipport = $self-&gt;{sock_map}{$_}        or die &#34;No map found matching for $_&#34;;
+        my $sock   = $self-&gt;{cache_sock}{$ipport} or die &#34;No sock found for $ipport&#34;;
         print STDERR &#34;processing socket $_\n&#34; if $self-&gt;{&#39;debug&#39;} &gt;= 2;
         $writing{$_} = $sock;
         if &#40;$self-&gt;{namespace}&#41; {
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> cache-memcached.pl</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
use strict;
use warnings;

use Cache::Memcached;

my @servers = qw&#40;host01:11211 host02:11211 host03:11211&#41;;

my $memd1 = Cache::Memcached-&gt;new&#40; { servers =&gt; \@servers } &#41;;
my $memd2 = Cache::Memcached-&gt;new&#40; { servers =&gt; \@servers } &#41;;

$memd1-&gt;get_multi&#40;&#34;foo&#34;&#41;;
$memd2-&gt;get_multi&#40;&#34;bar&#34;&#41;;

$memd2-&gt;disconnect_all;

$memd1-&gt;get_multi&#40;&#34;foo&#34;&#41;;
# dies with: &#34;No sock found for host03:11211 at /opt/perl/5.12.1/local/share/perl/5.12.1/Cache/Memcached.pm line 718&#34;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;11:29:20&nbsp;2011</span>
    <span class="description">bergner [...] cs.umu.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bergner [...] cs.umu.se</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,
To anyone using Cache::Memcached, this fix is more important than it
would seem at first. The global state being kept in Cache::Memcached
screws up modules like Cache::Memcached::Managed if you do things like:

* Create a Cache::Memcached::Managed instance $c and $c-&gt;set&#40;&#41; a value
in memcached.
* Destroy the $c object, e.g. undef $c;
* Fork N child processes
* Child processes connect using Cache::Memcached::Managed a do a get&#40;&#41;
on a value that was set by the parent.

With that scenario it is trivial to reproduce problems like sysread&#40;&#41;
failing with EWOULDBLOCK and select&#40;&#41; timing out, the end result being
that no data is returned from the get&#40;&#41; operation. The attached patch,
which is very similar to the one already provided in this issue handles
this situation without any noticable issues as far as I can tell at this
point.

It could be argued that this is a Cache::Memcached::Managed issue, since
the documentation of that module claims that &#34;Sockets are automatically
reset in forked processes, no manual reset needed&#34;. I do think that the
current setup with global caching makes it a lot more error prone, and
significantly more difficult to build non-trivial functionality on top
of Cache::Memcached.

Kind regards,

Marcus Bergner
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Cache_Memcached.diff</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- original/Cache/Memcached.pm	2011-09-14 14:53:29.000000000 +0200
+++ patched/Cache/Memcached.pm	2011-09-14 17:02:56.000000000 +0200
@@ -26,6 +26,9 @@
     bucketcount _single_sock _stime
     connect_timeout cb_connect_fail
     parser_class
+    buck2sock
+    cache_sock
+    sock_map
 };
 
 # flag definitions
@@ -55,8 +58,6 @@
 eval { $FLAG_NOSIGNAL = MSG_NOSIGNAL; };
 
 my %host_dead;   # host -&gt; unixtime marked dead until
-my %cache_sock;  # host -&gt; socket
-my @buck2sock;   # bucket number -&gt; $sock
 
 my $PROTO_TCP;
 
@@ -78,6 +79,8 @@
     $self-&gt;{&#39;stat_callback&#39;} = $args-&gt;{&#39;stat_callback&#39;} || undef;
     $self-&gt;{&#39;readonly&#39;} = $args-&gt;{&#39;readonly&#39;};
     $self-&gt;{&#39;parser_class&#39;} = $args-&gt;{&#39;parser_class&#39;} || $parser_class;
+    $self-&gt;{&#39;cache_sock&#39;} = {};
+    $self-&gt;{&#39;sock_map&#39;} = {};
 
     # TODO: undocumented
     $self-&gt;{&#39;connect_timeout&#39;} = $args-&gt;{&#39;connect_timeout&#39;} || 0.25;
@@ -101,7 +104,9 @@
     $self-&gt;{&#39;buckets&#39;} = undef;
     $self-&gt;{&#39;bucketcount&#39;} = 0;
     $self-&gt;init_buckets;
-    @buck2sock = &#40;&#41;;
+    $self-&gt;{&#39;buck2sock&#39;} = [];
+    $self-&gt;{&#39;cache_sock&#39;} = {};
+    $self-&gt;{&#39;sock_map&#39;} = {};
 
     $self-&gt;{&#39;_single_sock&#39;} = undef;
     if &#40;@{$self-&gt;{&#39;servers&#39;}} == 1&#41; {
@@ -152,8 +157,9 @@
 }
 
 sub forget_dead_hosts {
+    my &#40;$self&#41; = @_;
+    $self-&gt;{&#39;buck2sock&#39;} = [];
     %host_dead = &#40;&#41;;
-    @buck2sock = &#40;&#41;;
 }
 
 sub set_stat_callback {
@@ -162,29 +168,27 @@
     $self-&gt;{&#39;stat_callback&#39;} = $stat_callback;
 }
 
-my %sock_map;  # stringified-$sock -&gt; &#34;$ip:$port&#34;
-
 sub _dead_sock {
-    my &#40;$sock, $ret, $dead_for&#41; = @_;
-    if &#40;my $ipport = $sock_map{$sock}&#41; {
+    my &#40;$self, $sock, $ret, $dead_for&#41; = @_;
+    if &#40;my $ipport = $self-&gt;{&#39;sock_map&#39;}{$sock}&#41; {
         my $now = time&#40;&#41;;
         $host_dead{$ipport} = $now + $dead_for
             if $dead_for;
-        delete $cache_sock{$ipport};
-        delete $sock_map{$sock};
+        delete $self-&gt;{&#39;cache_sock&#39;}{$ipport};
+        delete $self-&gt;{&#39;sock_map&#39;}{$sock};
     }
-    @buck2sock = &#40;&#41;;
+    $self-&gt;{&#39;buck2sock&#39;} = [];
     return $ret;  # 0 or undef, probably, depending on what caller wants
 }
 
 sub _close_sock {
-    my &#40;$sock&#41; = @_;
-    if &#40;my $ipport = $sock_map{$sock}&#41; {
+    my &#40;$self, $sock&#41; = @_;
+    if &#40;my $ipport = $self-&gt;{&#39;sock_map&#39;}{$sock}&#41; {
         close $sock;
-        delete $cache_sock{$ipport};
-        delete $sock_map{$sock};
+        delete $self-&gt;{&#39;cache_sock&#39;}{$ipport};
+        delete $self-&gt;{&#39;sock_map&#39;}{$sock};
     }
-    @buck2sock = &#40;&#41;;
+    $self-&gt;{&#39;buck2sock&#39;} = [];
 }
 
 sub _connect_sock { # sock, sin, timeout
@@ -229,7 +233,7 @@
 sub sock_to_host { # &#40;host&#41;
     my Cache::Memcached $self = ref $_[0] ? shift : undef;
     my $host = $_[0];
-    return $cache_sock{$host} if $cache_sock{$host};
+    return $self-&gt;{&#39;cache_sock&#39;}{$host} if $self-&gt;{&#39;cache_sock&#39;}{$host};
 
     my $now = time&#40;&#41;;
     my &#40;$ip, $port&#41; = $host =~ /&#40;.*&#41;:&#40;\d+&#41;$/;
@@ -251,12 +255,12 @@
             if &#40;$HAVE_SOCKET6 &#38;&#38; index&#40;$prefip, &#39;:&#39;&#41; != -1&#41; {
                 no strict &#39;subs&#39;;  # for PF_INET6 and AF_INET6, weirdly imported
                 socket&#40;$sock, PF_INET6, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{&#39;sock_map&#39;}{$sock} = $host;
                 $sin = Socket6::pack_sockaddr_in6&#40;$port,
                                                   Socket6::inet_pton&#40;AF_INET6, $prefip&#41;&#41;;
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{&#39;sock_map&#39;}{$sock} = $host;
                 $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$prefip&#41;&#41;;
             }
 
@@ -275,12 +279,12 @@
             if &#40;$HAVE_SOCKET6 &#38;&#38; index&#40;$ip, &#39;:&#39;&#41; != -1&#41; {
                 no strict &#39;subs&#39;;  # for PF_INET6 and AF_INET6, weirdly imported
                 socket&#40;$sock, PF_INET6, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{&#39;sock_map&#39;}{$sock} = $host;
                 $sin = Socket6::pack_sockaddr_in6&#40;$port,
                                                   Socket6::inet_pton&#40;AF_INET6, $ip&#41;&#41;;
             } else {
                 socket&#40;$sock, PF_INET, SOCK_STREAM, $proto&#41;;
-                $sock_map{$sock} = $host;
+                $self-&gt;{&#39;sock_map&#39;}{$sock} = $host;
                 $sin = Socket::sockaddr_in&#40;$port, Socket::inet_aton&#40;$ip&#41;&#41;;
             }
 
@@ -288,18 +292,18 @@
             unless &#40;_connect_sock&#40;$sock, $sin, $timeout&#41;&#41; {
                 my $cb = $self ? $self-&gt;{cb_connect_fail} : undef;
                 $cb-&gt;&#40;$ip&#41; if $cb;
-                return _dead_sock&#40;$sock, undef, 20 + int&#40;rand&#40;10&#41;&#41;&#41;;
+                return $self-&gt;_dead_sock&#40;$sock, undef, 20 + int&#40;rand&#40;10&#41;&#41;&#41;;
             }
         }
     } else { # it&#39;s a unix domain/local socket
         socket&#40;$sock, PF_UNIX, SOCK_STREAM, 0&#41;;
-        $sock_map{$sock} = $host;
+        $self-&gt;{&#39;sock_map&#39;}{$sock} = $host;
         $sin = Socket::sockaddr_un&#40;$host&#41;;
         my $timeout = $self ? $self-&gt;{connect_timeout} : 0.25;
         unless &#40;_connect_sock&#40;$sock,$sin,$timeout&#41;&#41; {
             my $cb = $self ? $self-&gt;{cb_connect_fail} : undef;
             $cb-&gt;&#40;$host&#41; if $cb;
-            return _dead_sock&#40;$sock, undef, 20 + int&#40;rand&#40;10&#41;&#41;&#41;;
+            return $self-&gt;_dead_sock&#40;$sock, undef, 20 + int&#40;rand&#40;10&#41;&#41;&#41;;
         }
     }
 
@@ -308,7 +312,7 @@
     $| = 1;
     select&#40;$old&#41;;
 
-    $cache_sock{$host} = $sock;
+    $self-&gt;{&#39;cache_sock&#39;}{$host} = $sock;
 
     return $sock;
 }
@@ -347,12 +351,13 @@
 }
 
 sub disconnect_all {
+    my &#40;$self&#41; = @_;
     my $sock;
-    foreach $sock &#40;values %cache_sock&#41; {
+    foreach $sock &#40;values %{$self-&gt;{&#39;cache_sock&#39;}}&#41; {
         close $sock;
     }
-    %cache_sock = &#40;&#41;;
-    @buck2sock = &#40;&#41;;
+    $self-&gt;{&#39;cache_sock&#39;} = {};
+    $self-&gt;{&#39;buck2sock&#39;} = [];
 }
 
 # writes a line, then reads result.  by default stops reading after a
@@ -396,7 +401,7 @@
             next
                 if not defined $res and $!==EWOULDBLOCK;
             unless &#40;$res &gt; 0&#41; {
-                _close_sock&#40;$sock&#41;;
+                $self-&gt;_close_sock&#40;$sock&#41;;
                 return undef;
             }
             if &#40;$res == length&#40;$line&#41;&#41; { # all sent
@@ -411,7 +416,7 @@
             next
                 if !defined&#40;$res&#41; and $!==EWOULDBLOCK;
             if &#40;$res == 0&#41; { # catches 0=conn closed or undef=error
-                _close_sock&#40;$sock&#41;;
+                $self-&gt;_close_sock&#40;$sock&#41;;
                 return undef;
             }
             $offset += $res;
@@ -420,7 +425,7 @@
     }
 
     unless &#40;$state == 2&#41; {
-        _dead_sock&#40;$sock&#41;; # improperly finished
+        $self-&gt;_dead_sock&#40;$sock&#41;; # improperly finished
         return undef;
     }
 
@@ -614,9 +619,9 @@
                 #    and last;
 
                 # but this variant doesn&#39;t crash:
-                $sock = $buck2sock[$bucket] || $self-&gt;sock_to_host&#40;$self-&gt;{buckets}[ $bucket ]&#41;;
+                $sock = $self-&gt;{&#39;buck2sock&#39;}[$bucket] || $self-&gt;sock_to_host&#40;$self-&gt;{buckets}[ $bucket ]&#41;;
                 if &#40;$sock&#41; {
-                    $buck2sock[$bucket] = $sock;
+                    $self-&gt;{&#39;buck2sock&#39;}[$bucket] = $sock;
                     last;
                 }
 
@@ -676,7 +681,7 @@
         }
 
         close $sock;
-        _dead_sock&#40;$sock&#41;;
+        $self-&gt;_dead_sock&#40;$sock&#41;;
     };
 
     # $finalize-&gt;&#40;$key, $flags&#41;
@@ -709,8 +714,8 @@
     };
 
     foreach &#40;keys %$sock_keys&#41; {
-        my $ipport = $sock_map{$_}        or die &#34;No map found matching for $_&#34;;
-        my $sock   = $cache_sock{$ipport} or die &#34;No sock found for $ipport&#34;;
+        my $ipport = $self-&gt;{&#39;sock_map&#39;}{$_}        or die &#34;No map found matching for $_&#34;;
+        my $sock   = $self-&gt;{&#39;cache_sock&#39;}{$ipport} or die &#34;No sock found for $ipport&#34;;
         print STDERR &#34;processing socket $_\n&#34; if $self-&gt;{&#39;debug&#39;} &gt;= 2;
         $writing{$_} = $sock;
         if &#40;$self-&gt;{namespace}&#41; {
@@ -891,7 +896,7 @@
                 return $$bref =~ /^&#40;?:END|ERROR&#41;\r?\n/m;
             }&#41;;
             unless &#40;$lines&#41; {
-                _dead_sock&#40;$sock&#41;;
+                $self-&gt;_dead_sock&#40;$sock&#41;;
                 next HOST;
             }
 
@@ -938,7 +943,7 @@
         my $sock = $self-&gt;sock_to_host&#40;$host&#41;;
         my $ok = _write_and_read&#40;$self, $sock, &#34;stats reset&#34;&#41;;
         unless &#40;defined $ok &#38;&#38; $ok eq &#34;RESET\r\n&#34;&#41; {
-            _dead_sock&#40;$sock&#41;;
+            $self-&gt;_dead_sock&#40;$sock&#41;;
         }
     }
     return 1;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Wed&nbsp;Sep&nbsp;14&nbsp;11:29:21&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Sep&nbsp;27&nbsp;18:39:50&nbsp;2011</span>
    <span class="description">revmischa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> bergner [...] cs.umu.se</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have been having issues with running multiple memcached clients in the 
same process, which may be related to this. If one of the servers is 
restarted, I get this error over and over:

No map found matching for GLOB&#40;0x130170d0&#41; at 
/mnt/db/perl5/lib/perl5/Cache/Memcached.pm line 717.

Which seems to reference sock_map. Related issue?
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;30&nbsp;16:34:13&nbsp;2011</span>
    <span class="description">bergner [...] cs.umu.se -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> bergner [...] cs.umu.se</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Tue Sep 27 18:39:50 2011, REVMISCHA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; No map found matching for GLOB&#40;0x130170d0&#41; at 
&gt; /mnt/db/perl5/lib/perl5/Cache/Memcached.pm line 717.
&gt; 
&gt; Which seems to reference sock_map. Related issue?
</div>
May be related yes. Do you have a version of Cache/Memcached.pm that
uses a global @buck2sock array? If so I think that could be the culprit
in this case. The newest CPAN version uses an object local buck2sock
property, which feels much safer. 

get_multi&#40;&#41; will use $buck2sock[$bucket] as the key in the %sock_keys
hash which is later used in _load_multi&#40;&#41; to index into the sock_map
hash. If buck2sock is global you would need to call disconnect_all&#40;&#41; at
various places to avoid having old useless data in the buck2sock array
if multiple instances of Cache::Memcached are created and destroyed.

Still, having sock_map and cache_sock also as local properties are a
good thing if you ask me &#40;it certainly worked much better for us in our
setup&#41;, even though I don&#39;t think it is directly relevant to your issue.
On the other hand I&#39;m not sure I get all the ins and outs of the buckets
and local caching going on in Cache::Memcached so take my advice with
the usual healthy degree of scepticism.

Kind regards, 

Marcus Bergner
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Oct&nbsp;10&nbsp;15:23:11&nbsp;2011</span>
    <span class="description">revmischa [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I am using the latest version from CPAN, and on occasion when I restart my webapp process 
or restart memcacheds, it surfaces and refuses to go away until I restart everything. 

On Fri Sep 30 16:34:13 2011, bergner wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Tue Sep 27 18:39:50 2011, REVMISCHA wrote:
<div class="message-stanza open">&gt; &gt; No map found matching for GLOB&#40;0x130170d0&#41; at 
&gt; &gt; /mnt/db/perl5/lib/perl5/Cache/Memcached.pm line 717.
&gt; &gt; 
&gt; &gt; Which seems to reference sock_map. Related issue?
</div>&gt; 
&gt; May be related yes. Do you have a version of Cache/Memcached.pm that
&gt; uses a global @buck2sock array? If so I think that could be the culprit
&gt; in this case. The newest CPAN version uses an object local buck2sock
&gt; property, which feels much safer. 
&gt; 
&gt; get_multi&#40;&#41; will use $buck2sock[$bucket] as the key in the %sock_keys
&gt; hash which is later used in _load_multi&#40;&#41; to index into the sock_map
&gt; hash. If buck2sock is global you would need to call disconnect_all&#40;&#41; at
&gt; various places to avoid having old useless data in the buck2sock array
&gt; if multiple instances of Cache::Memcached are created and destroyed.
&gt; 
&gt; Still, having sock_map and cache_sock also as local properties are a
&gt; good thing if you ask me &#40;it certainly worked much better for us in our
&gt; setup&#41;, even though I don&#39;t think it is directly relevant to your issue.
&gt; On the other hand I&#39;m not sure I get all the ins and outs of the buckets
&gt; and local caching going on in Cache::Memcached so take my advice with
&gt; the usual healthy degree of scepticism.
&gt; 
&gt; Kind regards, 
&gt; 
&gt; Marcus Bergner
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Oct&nbsp;11&nbsp;07:14:43&nbsp;2011</span>
    <span class="description">terjekr [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> terjekr [...] gmail.com</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">I have the same problem, getting the &#34;No map found matching for GLOB&#34; 
error message. I have also a setup with several memcached servers. This 
is a 1.29 issue, as downgrading to 1.28 solved the problem.

Regards
Terje Kristensen

On Mon Oct 10 15:23:11 2011, REVMISCHA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I am using the latest version from CPAN, and on occasion when I
&gt; restart my webapp process
&gt; or restart memcacheds, it surfaces and refuses to go away until I
&gt; restart everything.
&gt; 
&gt; On Fri Sep 30 16:34:13 2011, bergner wrote:
<div class="message-stanza open">&gt; &gt; On Tue Sep 27 18:39:50 2011, REVMISCHA wrote:
<div class="message-stanza open">&gt; &gt; &gt; No map found matching for GLOB&#40;0x130170d0&#41; at
&gt; &gt; &gt; /mnt/db/perl5/lib/perl5/Cache/Memcached.pm line 717.
&gt; &gt; &gt;
&gt; &gt; &gt; Which seems to reference sock_map. Related issue?
</div>&gt; &gt;
&gt; &gt; May be related yes. Do you have a version of Cache/Memcached.pm that
&gt; &gt; uses a global @buck2sock array? If so I think that could be the
</div>&gt; culprit
<div class="message-stanza open">&gt; &gt; in this case. The newest CPAN version uses an object local buck2sock
&gt; &gt; property, which feels much safer.
&gt; &gt;
&gt; &gt; get_multi&#40;&#41; will use $buck2sock[$bucket] as the key in the
</div>&gt; %sock_keys
<div class="message-stanza open">&gt; &gt; hash which is later used in _load_multi&#40;&#41; to index into the sock_map
&gt; &gt; hash. If buck2sock is global you would need to call disconnect_all&#40;&#41;
</div>&gt; at
<div class="message-stanza open">&gt; &gt; various places to avoid having old useless data in the buck2sock
</div>&gt; array
<div class="message-stanza open">&gt; &gt; if multiple instances of Cache::Memcached are created and destroyed.
&gt; &gt;
&gt; &gt; Still, having sock_map and cache_sock also as local properties are a
&gt; &gt; good thing if you ask me &#40;it certainly worked much better for us in
</div>&gt; our
<div class="message-stanza open">&gt; &gt; setup&#41;, even though I don&#39;t think it is directly relevant to your
</div>&gt; issue.
<div class="message-stanza open">&gt; &gt; On the other hand I&#39;m not sure I get all the ins and outs of the
</div>&gt; buckets
<div class="message-stanza open">&gt; &gt; and local caching going on in Cache::Memcached so take my advice
</div>&gt; with
<div class="message-stanza open">&gt; &gt; the usual healthy degree of scepticism.
&gt; &gt;
&gt; &gt; Kind regards,
&gt; &gt;
&gt; &gt; Marcus Bergner
</div>&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;May&nbsp;18&nbsp;20:10:18&nbsp;2012</span>
    <span class="description">hachi [...] cpan.org -  Severity Important added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;19&nbsp;19:15:02&nbsp;2012</span>
    <span class="description">hachi [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">RT-Send-CC:</td>
    <td class="message-header-value"> revmischa [...] cpan.org, terjekr [...] gmail.com, bergner [...] cs.umu.se</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Thank you for the submitted report and patch. This was a major issue in the client.

I&#39;ve opted to go a different route on the fix, as you can see here:

<span class="clickylink"><a target="new" rel="nofollow" href="https://github.com/memcached/perl-Cache-">https://github.com/memcached/perl-Cache-</a></span>
Memcached/commit/30392985c7e2f14924383016ddf4a95249d86333

I&#39;ve opted to have a generational counter for the socket caches so they can be resynced as 
necessary. This allows us to keep the global socket cache and also cache the buckets to sockets 
mapping in each client object.

This fix will be included in the next release, and that should be due out soon here.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;19&nbsp;19:17:18&nbsp;2012</span>
    <span class="description">DORMANDO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">patched!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;19&nbsp;19:17:19&nbsp;2012</span>
    <span class="description">DORMANDO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
