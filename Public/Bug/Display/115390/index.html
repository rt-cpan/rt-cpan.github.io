<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #115390 for Graphics-Framebuffer: [PATCH] Problem in threaded perl detection</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #115390 for Graphics-Framebuffer: [PATCH] Problem in threaded perl detection</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Graphics-Framebuffer/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Graphics-Framebuffer/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Graphics-Framebuffer/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Graphics-Framebuffer/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Graphics-Framebuffer">Graphics-Framebuffer CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">115390</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Graphics-Framebuffer/Active/">Graphics-Framebuffer</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">RKELSCH [...] cpan.org
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
SREZIC [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-253072-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
5.81    </td>
  </tr>
  <tr id="CF-253073-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
5.82    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;17&nbsp;02:12:55&nbsp;2016</span>
    <span class="description">SREZIC [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> [PATCH] Problem in threaded perl detection</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">The threaded perl check in Makefile.PL does not work if the current perl is not the system perl and not the first perl in user&#39;s $PATH. This can be fixed by using $^X instead of &#34;perl&#34; &#40;see patch below&#41;.

This explains the many test fails on CPAN Testers &#40;most smoker machines do not use the system perl for testing&#41;.


diff --git a/Makefile.PL b/Makefile.PL
index d5af65f..188ec24 100644
--- a/Makefile.PL
+++ b/Makefile.PL
@@ -40,7 +40,7 @@ if &#40;$fg =~ /\d+/ || -e &#39;/bin/fgconsole&#39;&#41; {
     print &#34;NOT FOUND\n\nWhile &#39;fgconsole&#39; is not required, it is needed for the &#39;which_console&#39; method to function.\n\n&#34;;
 }
 
-my $perl_version = `perl -v`;
+my $perl_version = `$^X -v`;
 
 if &#40;$perl_version =~ /thread/&#41; {
     print &#34;Threaded Perl detected\n&#34;;
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;17&nbsp;13:36:09&nbsp;2016</span>
    <span class="description">RKELSCH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">The next version will have a better check for this.<br>

<br>

This check ( $^V ) does not work for older Perls.&nbsp; Nevertheless, I can code for the contingency.&nbsp; What happens is this check will actually remove threading code from the source itself.&nbsp; Since threading is the default, and you said this can fail on some systems, as the check uses the default perl instead of the called one, the logical thing to do is to attempt to have non-threading as the default, and have the check modify the source to enabkle it.&nbsp; Thereby if the check failed with either the $^V or &quot;perl -v&quot; methods, it can still have a higher probability of working.&nbsp; The only thing suffering from a false check result is &quot;which_console&quot; not working.&nbsp; This is no big deal in the grand scheme of things.&nbsp; The threading usage is only a recent addition.<br>

<br>

Nevertheless, many of the CPAN test failures have either been a lack of framebuffer drivers, or the test system automation was started from X-Windows, in which case it will always fail.<br>

<br>

Usual indications of these CPAN tester failures are a MMAP error from the &quot;Sys::Mmap&quot; module.&nbsp; Which I have been receiving from CPAN long before the threading check (and usage) was added.<br>

<br>

I should make changes to the test script in the &quot;t/&quot; directory to watch for this MMAP issue and better report on its cause of failure.<br>

<br>

Working with a module so closely tied to kernel level systems is a nightmare for testing all contingencies, especially since Perl in taint mode really hates that, and taint mode is what perl tests run under.<br>

<br>

On Fri Jun 17 00:12:55 2016, SREZIC wrote:<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The threaded perl check in Makefile.PL does not work if the current<br>

&gt; perl is not the system perl and not the first perl in user&#39;s $PATH.<br>

&gt; This can be fixed by using $^X instead of &quot;perl&quot; (see patch below).<br>

&gt;<br>

&gt; This explains the many test fails on CPAN Testers (most smoker<br>

&gt; machines do not use the system perl for testing).<br>

&gt;<br>

&gt;<br>

&gt; diff --git a/Makefile.PL b/Makefile.PL<br>

&gt; index d5af65f..188ec24 100644<br>

&gt; --- a/Makefile.PL<br>

&gt; +++ b/Makefile.PL<br>

&gt; @@ -40,7 +40,7 @@ if ($fg =~ /\d+/ || -e &#39;/bin/fgconsole&#39;) {<br>

&gt; print &quot;NOT FOUND\n\nWhile &#39;fgconsole&#39; is not required, it is<br>

&gt; needed for the &#39;which_console&#39; method to function.\n\n&quot;;<br>

&gt; }<br>

&gt;<br>

&gt; -my $perl_version = `perl -v`;<br>

&gt; +my $perl_version = `$^X -v`;<br>

&gt;<br>

&gt; if ($perl_version =~ /thread/) {<br>

&gt; print &quot;Threaded Perl detected\n&quot;;<br>
</div><br>

<br>


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;17&nbsp;13:36:09&nbsp;2016</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction people Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jun&nbsp;17&nbsp;13:36:09&nbsp;2016</span>
    <span class="description">RKELSCH [...] cpan.org -  Taken</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;19&nbsp;09:09:40&nbsp;2016</span>
    <span class="description">RKELSCH [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza">The latest version has corrected this issue by using the internal $Config{useithreads} value, and completely doing away with the previous methods.<br>

<br>

Thank you so much for bringing this to my attention.<br>

<br>

On Fri Jun 17 00:12:55 2016, SREZIC wrote:<br>
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The threaded perl check in Makefile.PL does not work if the current<br>

&gt; perl is not the system perl and not the first perl in user&#39;s $PATH.<br>

&gt; This can be fixed by using $^X instead of &quot;perl&quot; (see patch below).<br>

&gt;<br>

&gt; This explains the many test fails on CPAN Testers (most smoker<br>

&gt; machines do not use the system perl for testing).<br>

&gt;<br>

&gt;<br>

&gt; diff --git a/Makefile.PL b/Makefile.PL<br>

&gt; index d5af65f..188ec24 100644<br>

&gt; --- a/Makefile.PL<br>

&gt; +++ b/Makefile.PL<br>

&gt; @@ -40,7 +40,7 @@ if ($fg =~ /\d+/ || -e &#39;/bin/fgconsole&#39;) {<br>

&gt; print &quot;NOT FOUND\n\nWhile &#39;fgconsole&#39; is not required, it is<br>

&gt; needed for the &#39;which_console&#39; method to function.\n\n&quot;;<br>

&gt; }<br>

&gt;<br>

&gt; -my $perl_version = `perl -v`;<br>

&gt; +my $perl_version = `$^X -v`;<br>

&gt;<br>

&gt; if ($perl_version =~ /thread/) {<br>

&gt; print &quot;Threaded Perl detected\n&quot;;<br>
</div><br>

<br>


</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;19&nbsp;09:09:46&nbsp;2016</span>
    <span class="description">RKELSCH [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Sun&nbsp;Jun&nbsp;19&nbsp;09:11:16&nbsp;2016</span>
    <span class="description">RKELSCH [...] cpan.org -  Fixed in 5.82 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
