<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #130192 for Net-Stomp: Encoding/UTF-8 issues</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #130192 for Net-Stomp: Encoding/UTF-8 issues</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Net-Stomp/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Net-Stomp/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Net-Stomp/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/Net-Stomp/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Net-Stomp">Net-Stomp CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">130192</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">open</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/Net-Stomp/Active/">Net-Stomp</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
mstock [...] cpan.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-41200-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.60    </td>
  </tr>
  <tr id="CF-41201-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;26&nbsp;08:10:24&nbsp;2019</span>
    <span class="description">mstock [...] cpan.org -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Encoding/UTF-8 issues</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

we recently noticed an issue when we were sending messages with JSON data in the body that contained UTF-8 encoded characters &#40;over a SSL connection and using ActiveMQ, we did not try it without SSL&#41;. These messages usually either did not arrive at the other end at all or they contained double-encoded UTF-8 characters &#40;or something that looked similar&#41; or invalid JSON. At first, I assumed that the issue was with the body, but we were actually passing a byte string &#40;as opposed to a character string with set UTF-8 flag&#41; to Net::Stomp, so that part was fine, but as it turns out, the destination header was built using a value that came from a database that had the UTF-8 flag set. So when this got concatenated in Net::Stomp::Frame &#40;in as_string&#40;&#41;&#41;, the UTF-8 flag got &#39;propagated&#39; to the $frame, and when appending the $body, the bytes get appended to this UTF-8 character string, which likely explains the observed double-encoding. Initially, we did not send the content-length header, but once I added it, I got errors in the ActiveMQ log complaining that it did not receive the trailing null byte after reading content-length bytes. I assume that there are two reasons for this:

 1. If the $frame has the UTF-8 flag set, the code in send_frame&#40;&#41; works with character counts, while the lower level code &#40;OpenSSL?&#41; that gets eventually called in syswrite&#40;&#41; might be returning byte counts, which makes the substr&#40;&#41; remove too many characters when syswrite has written a UTF-8 character &#40;which can be more than one byte long&#41;, causing &#39;data loss&#39; in the body of the frame. I&#39;m not sure if we actually triggered this though and if it really is an issue since our messages are rather short, I just noticed this potential problem when reading the send_frame&#40;&#41; code.
 2. Because of the double-encoding mentioned above, the body becomes longer than it was when the length was calculated in the calling code, so the content-length doesn&#39;t actually match the length of the body that gets sent.

I&#39;m not sure if I fully understand the problem yet, nor do I know how to best solve this, maybe it&#39;s sufficient to document that both headers and body must be byte strings &#40;with UTF-8 flag off&#41; to give others who run into this a hint what they might have to look for. In our case, I currently &#39;solved&#39; it by wrapping the send method with some code that encodes parameter keys and values as UTF-8 byte string &#40;using the Encode module&#41; if the UTF-8 flag is set, but one has to be careful since, if the caller provided a content-length header and the body was a character string with UTF-8 flag set, the actual body length might be different from the one provided by the caller.

The attached .t file tries to demonstrate a part of the issue by showing that there is a difference if a header value has or hasn&#39;t the UTF-8 flag set.

Kind regards
Manfred
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> encoding.t</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!perl
use lib &#39;t/lib&#39;;
use TestHelp;
use Net::Stomp::Frame;
use Encode;
use File::Spec;
use Devel::Peek;

my $expected_frame_data = encode&#40;&#39;UTF-8&#39;,
    &#34;SEND\ndestination:/foo/bar\n\n\N{WHITE SMILING FACE}\0&#34;&#41;;
my $body = encode&#40;&#39;UTF-8&#39;, &#34;\N{WHITE SMILING FACE}&#34;&#41;;

use Data::Dumper;
local $Data::Dumper::Useqq = 1;
local $Data::Dumper::Terse = 1;
local $Data::Dumper::Indent = 0;

subtest &#39;Non UTF-8 destination&#39; =&gt; sub {
    my $f = Net::Stomp::Frame-&gt;new&#40;{
        command =&gt; &#39;SEND&#39;,
        headers =&gt; {
            destination =&gt; &#39;/foo/bar&#39;,
        },
        body    =&gt; $body,
    }&#41;;
    my $frame_data = $f-&gt;as_string&#40;&#41;;
    is&#40;$frame_data, $expected_frame_data, &#39;frame content looks as expected&#39;&#41;;
    is&#40;utf8::is_utf8&#40;$frame_data&#41;, &#39;&#39;, &#39;content not marked as UTF-8&#39;&#41;;

    diag &#39;Frame data: &#39; . Dumper&#40;$frame_data&#41;;
    Dump $frame_data;
};

subtest &#39;UTF-8 destination&#39; =&gt; sub {
    my $f = Net::Stomp::Frame-&gt;new&#40;{
        command =&gt; &#39;SEND&#39;,
        headers =&gt; {
            destination =&gt; decode&#40;&#39;UTF-8&#39;, &#39;/foo/bar&#39;&#41;,
        },
        body    =&gt; $body,
    }&#41;;
    my $frame_data = $f-&gt;as_string&#40;&#41;;
    is&#40;$frame_data, $expected_frame_data, &#39;frame content looks as expected&#39;&#41;;
    is&#40;utf8::is_utf8&#40;$frame_data&#41;, &#39;&#39;, &#39;content not marked as UTF-8&#39;&#41;;

    diag &#39;Frame data: &#39; . Dumper&#40;$frame_data&#41;;
    Dump $frame_data;

    # The following &#39;simulates&#39; code &#40;that might be called from syswrite&#41; which
    # detects the UTF-8 flag and performs encoding to bytes, which results in
    # double-encoded UTF-8 data
    is&#40;encode&#40;&#39;UTF-8&#39;, $frame_data&#41;, $expected_frame_data, &#39;frame content looks as expected&#39;&#41;;
    utf8::encode&#40;$frame_data&#41;;
    is&#40;$frame_data, $expected_frame_data, &#39;frame content looks as expected&#39;&#41;;
};

done_testing;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;12&nbsp;08:37:06&nbsp;2019</span>
    <span class="description">dakkar [...] thenautilus.net -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #130192] Encoding/UTF-8 issues</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 12 Aug 2019 13:30:13 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> &#34;Manfred Stock via RT&#34; &lt;bug-Net-Stomp [...] rt.cpan.org&gt;</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Gianni Ceccarelli &lt;dakkar [...] thenautilus.net&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri, 26 Jul 2019 08:10:25 -0400
&#34;Manfred Stock via RT&#34; &lt;bug-Net-Stomp@rt.cpan.org&gt; wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; we recently noticed an issue when we were sending messages with JSON
&gt; data in the body that contained UTF-8 encoded characters &#40;over a SSL
&gt; connection and using ActiveMQ, we did not try it without SSL&#41;.
</div>
Thank you for the bug report!

To the best of my knowledge, there is no reliable way to detect
whether a string is going to be interpreted as characters or bytes,
especially when going through XS. I fear that the best I can do is
to document more explicitly that all strings passed to Net::Stomp must
be byte strings.

-- 
        Dakkar - &lt;Mobilis in mobile&gt;
        GPG public key fingerprint = A071 E618 DD2C 5901 9574
                                     6FE2 40EA 9883 7519 3F88
                            key id = 0x75193F88

No committee could ever come up with anything as revolutionary as a
camel -- anything as practical and as perfectly designed to perform
effectively under such difficult conditions.
                -- Laurence J. Peter
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Aug&nbsp;12&nbsp;08:37:07&nbsp;2019</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Aug&nbsp;13&nbsp;03:02:45&nbsp;2019</span>
    <span class="description">mstock [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Am Mo 12. Aug 2019, 08:37:06, dakkar@thenautilus.net schrieb:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; To the best of my knowledge, there is no reliable way to detect
&gt; whether a string is going to be interpreted as characters or bytes,
&gt; especially when going through XS. I fear that the best I can do is
&gt; to document more explicitly that all strings passed to Net::Stomp must
&gt; be byte strings.
</div>
I think that would be fine, especially if you explicitly mention that this does not only apply to the body, but also to all other parameters like eg. header fields and destination. Doing something &#39;magic&#39; behind the scenes is often a bit risky, and introducing it now might also break existing code. One thing one might consider is emitting/logging a warning on debug or trace level if some string has the UTF-8 flag set &#40;or only if the string that gets written to a socket has it set, as this would require fewer changes&#41;, but warnings tend to get ignored if things work anyhow, and it&#39;s probably not even a problem if no multi-byte characters are involved, which might be a rare use-case anyway.

Kind regards
Manfred
</div></div>
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
