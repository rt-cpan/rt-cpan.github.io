<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #69714 for DBIx-Class: ResultSet update_all updated rows not reflected in ResultSet, can &#34;lose&#34; rows</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #69714 for DBIx-Class: ResultSet update_all updated rows not reflected in ResultSet, can &#34;lose&#34; rows</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=DBIx-Class">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=DBIx-Class">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=DBIx-Class">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=DBIx-Class">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/DBIx-Class">DBIx-Class CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">69714</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">stalled</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=DBIx-Class">DBIx-Class</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
zeta [...] tcscs.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-10410-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
0.08192    </td>
  </tr>
  <tr id="CF-10411-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




dbix-bug.pl<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/959126/499098/dbix-bug.pl">
Fri Jul 22 23:31:47 2011 (3.6k) by zeta [...] tcscs.com
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=69714">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959126" href="/Public/Bug/Display.html?id=69714#txn-959126">#</a>      
    </span>
    <span class="date">Fri&nbsp;Jul&nbsp;22&nbsp;23:31:47&nbsp;2011</span>
    <span class="description">zeta [...] tcscs.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ResultSet update_all updated rows not reflected in ResultSet, can
 &#34;lose&#34; rows</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/959126/499097/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499097">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 990b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">ResultSet update_all&#40;&#41; fetches each row object and updates it. However, the row in the 
ResultSet is not updated. If one of the updated fields happens to be used in the where clause 
to create the ResultSet then attempt to read from result set either returns empty data &#40;if no 
more matching rows&#41; or different rows. In short, calling update_all causes you to lose the rows 
in the result set.

The attached file shows a test program that illustrates this, including the SQL executed and 
the output generated. The first test uses update_all and loses all the rows. The second test 
does the same thing manually and shows the rows getting updated, but the result set loses 
them after the update.

The update&#40;&#41; documentation kind of implies the contents of the result set are not updated. It 
also &#34;loses&#34; the rows if one of the fields in where is changed, however it implies using 
update_all will update the rows objects.

Not sure if it&#39;s a bug in code or bug &#40;or ambiguity&#41; in the docs.
</div></div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> dbix-bug.pl</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/959126/499098/dbix-bug.pl">Download dbix-bug.pl</a><br />
<span class="downloadcontenttype">text/x-perl 3.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;
use DBIx::Class;
use DBIx::Class::Schema::Loader;
use Bugtest::Schema;
$|++;

DBIx::Class::Schema::Loader-&gt;naming&#40;&#39;v7&#39;&#41;;

my $schema = Bugtest::Schema-&gt;connect&#40;
	&#39;dbi:mysql:bugtest&#39;,
	&#39;bugtest&#39;,
	&#39;passw0rd123$&#39;,
	{
		RaiseError =&gt; 1,
		PrintError =&gt; 1,
	},
&#41;;

print &#34;Test #1\n&#34;;
$resultset = $schema-&gt;resultset&#40;&#39;BugTest&#39;&#41;-&gt;search&#40;
	{
		&#39;field2&#39; =&gt; &#39;test&#39;,
		&#39;field6&#39; =&gt; undef,
		&#39;field5&#39; =&gt; 2
        },
	{
		&#39;for&#39; =&gt; &#39;update&#39;,
		&#39;order_by&#39; =&gt; {
			&#39;-asc&#39; =&gt; &#39;bug_test_id&#39;
		 }
        }
&#41;;

$update = $resultset-&gt;update_all&#40;{
	field5 =&gt; 3
}&#41;;
#		  506 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; &#40; field2 = &#39;test&#39; AND field6 IS NULL AND field5 = &#39;2&#39; &#41; &#41; ORDER BY bug_test_id ASC FOR UPDATE
#		  506 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;1&#39; &#41;
#		  506 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;2&#39; &#41;
#		  506 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;3&#39; &#41;

# doesn&#39;t make a difference if this is commented or not
#$resultset-&gt;reset&#40;&#41;;

while &#40;my $row = $resultset-&gt;next&#41; {
	printf&#40;&#34;Id: %s; Field5: %s\n&#34;, $row-&gt;bug_test_id, $row-&gt;field5&#41;;
}
#		  506 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; &#40; field2 = &#39;test&#39; AND field6 IS NULL AND field5 = &#39;2&#39; &#41; &#41; ORDER BY bug_test_id ASC FOR UPDATE

print &#34;reset data\n&#34;;
sleep 15; # allow me time to reset the data

print &#34;Test #2\n&#34;;

$resultset = $schema-&gt;resultset&#40;&#39;BugTest&#39;&#41;-&gt;search&#40;
	{
		&#39;field2&#39; =&gt; &#39;test&#39;,
		&#39;field6&#39; =&gt; undef,
		&#39;field5&#39; =&gt; 2
        },
	{
		&#39;for&#39; =&gt; &#39;update&#39;,
		&#39;order_by&#39; =&gt; {
			&#39;-asc&#39; =&gt; &#39;bug_test_id&#39;
		 }
        }
&#41;;

while &#40;my $row = $resultset-&gt;next&#41; {
	printf&#40;&#34;Id: %s; Field5: %s\n&#34;, $row-&gt;bug_test_id, $row-&gt;field5&#41;;
	my $ok = $row-&gt;update&#40;{ field5 =&gt; 3 }&#41;;
	printf&#40;&#34;Id: %s; Field5: %s; OK: %s\n&#34;, $row-&gt;bug_test_id, $row-&gt;field5, $ok&#41;;
	print &#34;Refreshing\n&#34;;
	$row-&gt;discard_changes&#40;&#41;;
	printf&#40;&#34;Id: %s; Field5: %s\n&#34;, $row-&gt;bug_test_id, $row-&gt;field5&#41;;
}
#110722 19:41:16	  508 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; &#40; field2 = &#39;test&#39; AND field6 IS NULL AND field5 = &#39;2&#39; &#41; &#41; ORDER BY bug_test_id ASC FOR UPDATE
#		  508 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;1&#39; &#41;
#		  508 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; me.bug_test_id = &#39;1&#39; &#41;
#		  508 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;2&#39; &#41;
#		  508 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; me.bug_test_id = &#39;2&#39; &#41;
#		  508 Query	UPDATE bug_test SET field5 = &#39;3&#39; WHERE &#40; bug_test_id = &#39;3&#39; &#41;
#		  508 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; me.bug_test_id = &#39;3&#39; &#41;


$resultset-&gt;reset&#40;&#41;;

while &#40;my $row = $resultset-&gt;next&#41; {
	printf&#40;&#34;Id: %s; Field5: %s\n&#34;, $row-&gt;bug_test_id, $row-&gt;field5&#41;;
}
#		  508 Query	SELECT me.bug_test_id, me.field2, me.field3, me.field4, me.field5, me.field6 FROM bug_test me WHERE &#40; &#40; field2 = &#39;test&#39; AND field6 IS NULL AND field5 = &#39;2&#39; &#41; &#41; ORDER BY bug_test_id ASC FOR UPDATE




#### output
#Test #1
#reset data
#Test #2
#Id: 1; Field5: 2
#Id: 1; Field5: 3; OK: Bugtest::Schema::Result::BugTest=HASH&#40;0x10207e0d0&#41;
#Refreshing
#Id: 1; Field5: 3
#Id: 2; Field5: 2
#Id: 2; Field5: 3; OK: Bugtest::Schema::Result::BugTest=HASH&#40;0x10207f2c0&#41;
#Refreshing
#Id: 2; Field5: 3
#Id: 3; Field5: 2
#Id: 3; Field5: 3; OK: Bugtest::Schema::Result::BugTest=HASH&#40;0x10207b178&#41;
#Refreshing
#Id: 3; Field5: 3

</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959877" href="/Public/Bug/Display.html?id=69714#txn-959877">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;03:16:53&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/959877/499443/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499443">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.2k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Fri Jul 22 23:31:47 2011, ZETA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; ResultSet update_all&#40;&#41; fetches each row object and updates it.
&gt; However, the row in the
&gt; ResultSet is not updated. If one of the updated fields happens to be
&gt; used in the where clause
&gt; to create the ResultSet then attempt to read from result set either
&gt; returns empty data &#40;if no
&gt; more matching rows&#41; or different rows. In short, calling update_all
&gt; causes you to lose the rows
&gt; in the result set.
</div>
There are a couple misconceptions in the statement above, however I fail
to see what in the docs confused you. 

A resultset does not contain neither rows nor objects. A resultset is a
&#34;query plan&#34; representation, the stuff between SELECT and the end of the
statement. When &#34;executed&#34; &#40;via -&gt;next/-&gt;all&#41; a cursor object is
attached to the resultset object which &#40;cursor&#41; is a thin wrapper around
DBI&#39;s $sth. -&gt;reset merely serves to destroy the cursor and re-query on
the next access again. At no point does the resultset itself collect
objects &#40;unless you use cache =&gt; 1, but that&#39;s not relevant here&#41;.
In addition a central design decision is that resultsets are immutable.
As such changing the query plan by a mere -&gt;update&#40;&#41; statement, would
violate all kinds of API contracts.

So to sum it up - an update/update_all operation is carried out on rows
matching the condition set forth by a specific resultset. A resultset&#39;s
pre-existing condition is never altered. It can only be added
to/constrained further, by creating a new resultset object via -&gt;search.

I will keep this ticked open for some days in case you have further
questions, but all in all everything in your test behaves as intended.

Cheers


<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The attached file shows a test program that illustrates this,
&gt; including the SQL executed and
&gt; the output generated. The first test uses update_all and loses all the
&gt; rows. The second test
&gt; does the same thing manually and shows the rows getting updated, but
&gt; the result set loses
&gt; them after the update.
&gt; 
&gt; The update&#40;&#41; documentation kind of implies the contents of the result
&gt; set are not updated. It
&gt; also &#34;loses&#34; the rows if one of the fields in where is changed,
&gt; however it implies using
&gt; update_all will update the rows objects.
&gt; 
&gt; Not sure if it&#39;s a bug in code or bug &#40;or ambiguity&#41; in the docs.
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-959880" href="/Public/Bug/Display.html?id=69714#txn-959880">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;03:16:56&nbsp;2011</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-960087" href="/Public/Bug/Display.html?id=69714#txn-960087">#</a>      
    </span>
    <span class="date">Mon&nbsp;Jul&nbsp;25&nbsp;12:43:58&nbsp;2011</span>
    <span class="description">zeta [...] tcscs.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/960087/499557/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499557">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.6k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 25 03:16:53 2011, RIBASUSHI wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; There are a couple misconceptions in the statement above, however I fail
&gt; to see what in the docs confused you. 
</div>
I read this, under Update:

Note that this will not run any accessor/set_column/update triggers, nor will it update any 
row object instances derived from this resultset &#40;this includes the contents of the resultset 
cache if any&#41;. See &#34;update_all&#34; if you need to execute any on-update triggers or cascades 
defined either by you or a result component.

and interpreted the &#34;See &#39;update_all&#39;&#34; to apply to the previous sentence&#39;s &#34;nor will it update 
any row object&#34; as means to achieve what I was hoping to do.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
&gt; A resultset does not contain neither rows nor objects. A resultset is a
&gt; &#34;query plan&#34; representation, the stuff between SELECT and the end of the
&gt; statement. When &#34;executed&#34; &#40;via -&gt;next/-&gt;all&#41; a cursor object is
&gt; attached to the resultset object which &#40;cursor&#41; is a thin wrapper around
&gt; DBI&#39;s $sth. -&gt;reset merely serves to destroy the cursor and re-query on
&gt; the next access again. 
</div>
I can see I misinterpreted what a result set was as well. I was thinking a ResultSet was more 
stable, and that once I had a result set I could work on it and trust that it would not change. 
As it stands, it&#39;s only stable for one iteration. As soon as you walk it, if you try to use reset to 
walk it again you are getting a new result set that may or may not contain the same rows as 
the previous iteration.

I can certainly understand how reset would reapply the criteria and create a new result set, 
resetting the result set with new data. However, is there an alternate way to restart at the 
beginning? So that you could walk a result set more than once without it rerunning the query 
and creating a new result set, at least short of storing the rows from the result set in 
memory?

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At no point does the resultset itself collect
&gt; objects &#40;unless you use cache =&gt; 1, but that&#39;s not relevant here&#41;.
&gt; In addition a central design decision is that resultsets are immutable.
&gt; As such changing the query plan by a mere -&gt;update&#40;&#41; statement, would
&gt; violate all kinds of API contracts.
&gt; 
&gt; So to sum it up - an update/update_all operation is carried out on rows
&gt; matching the condition set forth by a specific resultset. A resultset&#39;s
&gt; pre-existing condition is never altered. It can only be added
&gt; to/constrained further, by creating a new resultset object via -&gt;search.
&gt; 
&gt; I will keep this ticked open for some days in case you have further
&gt; questions, but all in all everything in your test behaves as intended.
&gt; 
</div>
Thanks for the detailed answers. Might as well close this since it&#39;s a not an issue.

Thanks,
Greg
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-960404" href="/Public/Bug/Display.html?id=69714#txn-960404">#</a>      
    </span>
    <span class="date">Tue&nbsp;Jul&nbsp;26&nbsp;02:50:16&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/960404/499745/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/499745">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 5.9k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Mon Jul 25 12:43:58 2011, ZETA wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; On Mon Jul 25 03:16:53 2011, RIBASUSHI wrote:
<div class="message-stanza open">&gt; &gt; There are a couple misconceptions in the statement above, however I
</div>&gt; fail
<div class="message-stanza open">&gt; &gt; to see what in the docs confused you.
</div></div>
Ok, there are still some misconceptions in your answer, therefore I will
explain more. However please please please consider contributing clearer
documentation on the subject matter. People who just &#34;clicked&#34; about a
specific set of issues are the best ones to write documentation, since
for the authors everything that I write below is &#34;bloody obvious&#34; and
not worthy of passing mention. It is easy too - all you need to do is go
to github, clone our repo, and click &#39;edit&#39; on any file you want to
change, entering your doc-changes DIRECTLY IN THE BROWSER. No fussing
with git or checkouts or pull requests - couple clicks and you write
some POD. So thanks in advance for that and read below for the rest of
the answer :&#41;

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I read this, under Update:
&gt; 
&gt; Note that this will not run any accessor/set_column/update triggers,
&gt; nor will it update any
&gt; row object instances derived from this resultset &#40;this includes the
&gt; contents of the resultset
&gt; cache if any&#41;. See &#34;update_all&#34; if you need to execute any on-update
&gt; triggers or cascades
&gt; defined either by you or a result component.
</div>
Right. Consider you using some sort of &#34;on update trigger&#34; role, e.g.
DBIx::Class::TimeStamp. If you do a $rs-&gt;update&#40;{ foo =&gt; &#39;bar&#39; }&#41;, then
the set_on_update triggers will never fire. Only update_all &#40;which
involves fetching the row, inflating an object and then calling -&gt;update
on the *row object*&#41; will invoke the role hooks as you expect. This is
due to the fact that the role is only capable of overriding
&#38;{$result_class}::update&#40;&#41;, it has no way of also hooking
&#38;{$resultset_class}::update&#40;&#41;. This is what the blurb above is about.
 
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; and interpreted the &#34;See &#39;update_all&#39;&#34; to apply to the previous
&gt; sentence&#39;s &#34;nor will it update
&gt; any row object&#34; as means to achieve what I was hoping to do.
&gt; 
<div class="message-stanza open">&gt; &gt;
&gt; &gt; A resultset does not contain neither rows nor objects. A resultset
</div>&gt; is a
<div class="message-stanza open">&gt; &gt; &#34;query plan&#34; representation, the stuff between SELECT and the end of
</div>&gt; the
<div class="message-stanza open">&gt; &gt; statement. When &#34;executed&#34; &#40;via -&gt;next/-&gt;all&#41; a cursor object is
&gt; &gt; attached to the resultset object which &#40;cursor&#41; is a thin wrapper
</div>&gt; around
<div class="message-stanza open">&gt; &gt; DBI&#39;s $sth. -&gt;reset merely serves to destroy the cursor and re-query
</div>&gt; on
<div class="message-stanza open">&gt; &gt; the next access again.
</div>&gt; 
&gt; I can see I misinterpreted what a result set was as well. I was
&gt; thinking a ResultSet was more
&gt; stable, and that once I had a result set I could work on it and trust
&gt; that it would not change.
&gt; As it stands, it&#39;s only stable for one iteration. As soon as you walk
&gt; it, if you try to use reset to
&gt; walk it again you are getting a new result set that may or may not
&gt; contain the same rows as
&gt; the previous iteration.
</div>
Well, yes and no. If you re-query the resultset in a transaction &#40;with
the proper transaction isolation set, i.e. REPEATABLE READ&#41; you will get
the same set of rows every time until you are out of the txn. Of course
this *does* involve querying the storage every time.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I can certainly understand how reset would reapply the criteria and
&gt; create a new result set,
&gt; resetting the result set with new data. However, is there an alternate
&gt; way to restart at the
&gt; beginning? So that you could walk a result set more than once without
&gt; it rerunning the query
&gt; and creating a new result set, at least short of storing the rows from
&gt; the result set in
&gt; memory?
</div>
Yes, there are 2 caching levels available to you. One is
<span class="clickylink"><a target="new" rel="nofollow" href="http://search.cpan.org/dist/DBIx-Class/lib/DBIx/Class/ResultSet.pm#cache">http://search.cpan.org/dist/DBIx-Class/lib/DBIx/Class/ResultSet.pm#cache</a></span>
which simply stores final inflated row objects in the &#34;cache&#34; slot of a
resultset instance &#40;$rs&#41;. Then -&gt;reset/-&gt;next and -&gt;all will dtrt and
will retrieve the same objects you just saw the loop before.
Incidentally this is also the mechanism used by prefetch - dbic creates
related resultsets with the related row-objects alredy pre-stuffed in
the cache&#39;s of these resultsets. So when you do $artist-&gt;cds-&gt;all all
you do is reach down the cache of $artist-&gt;related_resultset&#40;&#39;cds&#39;&#41;.

The second type of caching is lower down on the cursor level via
DBIx::Class::Cursor::Cached. Unlike the resultset caching mechanism, it
does not offer a ready made &#34;storage slot&#34; - you need to provide it a
storage on your own &#40;memcached being the most popular&#41;. What it does is
derive a hash from the query parameters &#40;sqlt + bind values&#41; and then
caches the result coming from the database under this
query-parameter-key. Once you hit -&gt;rest/-&gt;next or -&gt;all, dbic does a
requery as usual, but the cursor derives its raw data from the cache,
and passes it down to dbic for the same round of result parsing/row
object inflation.

The chief difference is that with the resultset cache you get the same
physical objects back every time &#40;same blessed hash ref, same address&#41;,
while with the cached cursor you only cache the data, but get new
objects every time you iterate over the resultset &#40;this is closer to
general dbic semantics&#41;.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt; &gt; At no point does the resultset itself collect
&gt; &gt; objects &#40;unless you use cache =&gt; 1, but that&#39;s not relevant here&#41;.
&gt; &gt; In addition a central design decision is that resultsets are
</div>&gt; immutable.
<div class="message-stanza open">&gt; &gt; As such changing the query plan by a mere -&gt;update&#40;&#41; statement,
</div>&gt; would
<div class="message-stanza open">&gt; &gt; violate all kinds of API contracts.
&gt; &gt;
&gt; &gt; So to sum it up - an update/update_all operation is carried out on
</div>&gt; rows
<div class="message-stanza open">&gt; &gt; matching the condition set forth by a specific resultset. A
</div>&gt; resultset&#39;s
<div class="message-stanza open">&gt; &gt; pre-existing condition is never altered. It can only be added
&gt; &gt; to/constrained further, by creating a new resultset object via
</div>&gt; -&gt;search.
<div class="message-stanza open">&gt; &gt;
&gt; &gt; I will keep this ticked open for some days in case you have further
&gt; &gt; questions, but all in all everything in your test behaves as
</div>&gt; intended.
<div class="message-stanza open">&gt; &gt;
</div>&gt; 
&gt; Thanks for the detailed answers. Might as well close this since it&#39;s a
&gt; not an issue.
</div>
Well, clearly we do have a documentation issue, hence I will keep the
ticket open a while longer, hoping you will answer the plea in the
beginning :&#41;

Cheers
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-972814" href="/Public/Bug/Display.html?id=69714#txn-972814">#</a>      
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;31&nbsp;23:03:41&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/972814/506237/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/506237">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 50b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Stalling in anticipation of documentation patches.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-972817" href="/Public/Bug/Display.html?id=69714#txn-972817">#</a>      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Wed&nbsp;Aug&nbsp;31&nbsp;23:03:42&nbsp;2011</span>
    <span class="description">ribasushi [...] leporine.io -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.478647</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
