<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #17500 for XML-Twig: *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #17500 for XML-Twig: *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/XML-Twig/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/XML-Twig/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/XML-Twig">XML-Twig CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">17500</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/XML-Twig/Active/">XML-Twig</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
Nikolaus [...] rath.org

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-37682-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
3.17    </td>
  </tr>
  <tr id="CF-37683-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.24    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;02:06:31&nbsp;2006</span>
    <span class="description">Guest -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> *** glibc detected *** double free or corruption &#40;!prev&#41;:
 0x08d2b4d0 ***</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hello,

It seems that XML::Twig causes some sort of segfault for the attached file:

main::update&#40;./verify.pl:86&#41;:       eval {
  DB&lt;2&gt; n
main::update&#40;./verify.pl:87&#41;:           my&#40;$fh,$parser&#41;;
  DB&lt;2&gt; n
main::update&#40;./verify.pl:88&#41;:           open&#40;$fh, &#34;-|&#34;, &#34;bzcat&#34;,
&#34;$fullfile.xml.bz2&#34;&#41;
main::update&#40;./verify.pl:89&#41;:               or die &#34;Can&#39;t fork bzcat: $!\n&#34;;
  DB&lt;2&gt; n
main::update&#40;./verify.pl:90&#41;:           my $data = {};
main::update&#40;./verify.pl:91&#41;:           $parser = new XML::Twig
main::update&#40;./verify.pl:92&#41;:               &#40; twig_roots =&gt; {
  DB&lt;2&gt; n
main::update&#40;./verify.pl:108&#41;:                              }&#41;;
  DB&lt;2&gt; n
main::update&#40;./verify.pl:109&#41;:          $parser-&gt;parse&#40;$fh&#41;;
  DB&lt;2&gt; n
*** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> ct-usb-audio-test.xml.bz2</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;02:08:36&nbsp;2006</span>
    <span class="description">Guest -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Here&#39;s the full invocation code:


       $parser = new XML::Twig
            &#40; twig_roots =&gt; {
                             &#34;title&#34; =&gt; sub { $oldval-&gt;{title} =
$_[1]-&gt;text&#40;&#41;;
                                              shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;expires&#34; =&gt; sub { $oldval-&gt;{expiry} =
$_[1]-&gt;text&#40;&#41;;
                                                shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;timestamp&#34; =&gt; sub { $oldval-&gt;{timestamp} =
$_[1]-&gt;text&#40;&#41;;
                                                  shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;keywords&#34; =&gt; sub { $oldval-&gt;{keywords} =
$_[1]-&gt;text&#40;&#41;;
                                                 shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;hardcopy&#34; =&gt; sub { $oldval-&gt;{hardcopy} =
$_[1]-&gt;text&#40;&#41;;
                                                 shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;tag&#34; =&gt; sub { push @{$oldval-&gt;{tags}},
$_[1]-&gt;text&#40;&#41;;
                                            shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;file&#34; =&gt; sub {
$oldval-&gt;{indexfile}-&gt;{$_[1]-&gt;att&#40;&#34;name&#34;&#41;} =
                                                 $_[1]-&gt;att&#40;&#34;index&#34;&#41; ?
&#39;y&#39; : &#39;n&#39;;
                                             shift&#40;&#41;-&gt;purge&#40;&#41;; },
                            }&#41;;

After the &#34;***glib ...&#34; message, the complete perl process &#40;including
the debugger&#41; is aborted.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;02:08:37&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;06:12:20&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Feb 2006 12:10:45 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">You are not giving me enough information here. The XML you are working 
with is missing.

Could you send me a complete test case that includes sample data? 
Something along the lines of the attached file, that reproduces the bug 
would be fine.

The output of perl -v and of the t/zz_config.t file would also be useful.

Thanks

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl
use strict;
use warnings;

use XML::Twig;
use YAML;

my $xml=&#34;rt_17500.xml&#34;;

open&#40; my $xml_fh, &#39;&gt;&#39;, $xml&#41; or die &#34;can&#39;t create $xml: $!&#34;;
while&#40;&lt;DATA&gt;&#41; { print {$xml_fh} $_; }
close $xml_fh;
system &#34;/usr/bin/bzip2 -f $xml&#34;;

my $oldval;

eval { my&#40;$fh,$parser&#41;;
       open&#40;$fh, &#34;-|&#34;, &#34;bzcat&#34;, &#34;$xml.bz2&#34;&#41;, or die &#34;Can&#39;t fork bzcat: $!\n&#34;;
       $oldval = {};
       $parser = new XML::Twig
            &#40; twig_roots =&gt; { &#34;title&#34; =&gt; sub { $oldval-&gt;{title} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;expires&#34; =&gt; sub { $oldval-&gt;{expiry} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;timestamp&#34; =&gt; sub { $oldval-&gt;{timestamp} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;keywords&#34; =&gt; sub { $oldval-&gt;{keywords} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;hardcopy&#34; =&gt; sub { $oldval-&gt;{hardcopy} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;tag&#34; =&gt; sub { push @{$oldval-&gt;{tags}}, $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;file&#34; =&gt; sub { $oldval-&gt;{indexfile}-&gt;{$_[1]-&gt;att&#40;&#34;name&#34;&#41;} = $_[1]-&gt;att&#40;&#34;index&#34;&#41; ?  &#39;y&#39; : &#39;n&#39;; 
                                             shift&#40;&#41;-&gt;purge&#40;&#41;;
                                           },
                            }
            &#41;;
       $parser-&gt;parse&#40;$fh&#41;;
  };

if&#40; $@&#41; { die &#34;error parsing: $@&#34;; }

print Dump $oldval;


__DATA__
&lt;doc&gt;
    &lt;item&gt;
        &lt;title&gt;title&lt;/title&gt;
        &lt;expires&gt;2006-12-31&lt;/expires&gt;
        &lt;timestamp&gt;2005-04-01&lt;/timestamp&gt;
        &lt;hardcopy&gt;yes&lt;/hardcopy&gt;
        &lt;tag&gt;big&lt;/tag&gt;
        &lt;tag&gt;bigger&lt;/tag&gt;
        &lt;file name=&#34;file1&#34; index=&#34;1&#34;/&gt;
        &lt;keywords&gt;k1 k2&lt;/keywords&gt;
    &lt;/item&gt;
    &lt;item&gt;
        &lt;title&gt;title 2&lt;/title&gt;
        &lt;expires&gt;2007-12-31&lt;/expires&gt;
        &lt;timestamp&gt;2004-04-01&lt;/timestamp&gt;
        &lt;hardcopy&gt;no&lt;/hardcopy&gt;
        &lt;tag&gt;small&lt;/tag&gt;
        &lt;tag&gt;smaller&lt;/tag&gt;
        &lt;file name=&#34;file2&#34; index=&#34;0&#34;/&gt;
        &lt;keywords&gt;k1 k2&lt;/keywords&gt;
    &lt;/item&gt;
&lt;/doc&gt;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;10:58:36&nbsp;2006</span>
    <span class="description">Nikolaus [...] rath.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Feb 2006 16:57:12 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nikolaus Rath &lt;Nikolaus [...] rath.org&gt;</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;mirod@xmltwig.com via RT&#34; &lt;bug-XML-Twig@rt.cpan.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You are not giving me enough information here. The XML you are working 
&gt; with is missing.
&gt;
&gt; Could you send me a complete test case that includes sample data? 
&gt; Something along the lines of the attached file, that reproduces the bug 
&gt; would be fine.
</div>
I thought I attached the data to the bug report... Anyway, I&#39;ve
attached a testcase.
</div></div>

<div class="messagebody">
<p>Message body not shown because it is not plain text.</p></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">#!/usr/bin/perl

use strict;
use warnings;

use XML::Twig;
use YAML;

my $xml=&#34;ct-usb-audio-test.xml.bz2&#34;;

my $oldval;

eval { my&#40;$fh,$parser&#41;;
       open&#40;$fh, &#34;-|&#34;, &#34;bzcat&#34;, &#34;$xml&#34;&#41;, or die &#34;Can&#39;t fork bzcat: $!\n&#34;;
       $oldval = {};
       $parser = new XML::Twig
            &#40; twig_roots =&gt; { &#34;title&#34; =&gt; sub { $oldval-&gt;{title} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;expires&#34; =&gt; sub { $oldval-&gt;{expiry} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;timestamp&#34; =&gt; sub { $oldval-&gt;{timestamp} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;keywords&#34; =&gt; sub { $oldval-&gt;{keywords} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;hardcopy&#34; =&gt; sub { $oldval-&gt;{hardcopy} = $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;tag&#34; =&gt; sub { push @{$oldval-&gt;{tags}}, $_[1]-&gt;text&#40;&#41;; shift&#40;&#41;-&gt;purge&#40;&#41;; },
                             &#34;file&#34; =&gt; sub { $oldval-&gt;{indexfile}-&gt;{$_[1]-&gt;att&#40;&#34;name&#34;&#41;} = $_[1]-&gt;att&#40;&#34;index&#34;&#41; ?  &#39;y&#39; : &#39;n&#39;; 
                                             shift&#40;&#41;-&gt;purge&#40;&#41;;
                                           },
                            }
            &#41;;
       $parser-&gt;parse&#40;$fh&#41;;
  };

if&#40; $@&#41; { die &#34;error parsing: $@&#34;; }

print Dump $oldval;

</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; The output of perl -v and of the t/zz_config.t file would also be useful.
</div>
[134] nokile:~/Work/perlbug$ perl -v

This is perl, v5.8.7 built for i486-linux-gnu-thread-multi
&#40;with 1 registered patch, see perl -V for more detail&#41;

Copyright 1987-2005, Larry Wall

Perl may be copied only under the terms of either the Artistic License or the
GNU General Public License, which may be found in the Perl 5 source kit.

Complete documentation for Perl, including FAQ lists, should be found on
this system using `man perl&#39; or `perldoc perl&#39;.  If you have access to the
Internet, point your browser at <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.org/">http://www.perl.org/</a></span>, the Perl Home Page.

[0] nokile:~/Work/perlbug$ locate zz_config.t
[1] nokile:~/Work/perlbug$

I&#39;ve got no zz_config.t. Where does it belong to? Perl or your module?
I&#39;m using Ubuntu packages.


   --Nikolaus

-- 
Der Vorteil der Klugheit liegt darin, dass man sich dumm stellen
kann. Das Gegenteil ist schon schwieriger. &#40;Kurt Tucholsky&#41;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;11:23:03&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Feb 2006 17:21:43 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nikolaus Rath via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; [134] nokile:~/Work/perlbug$ perl -v
&gt; 
&gt; This is perl, v5.8.7 built for i486-linux-gnu-thread-multi
&gt; &#40;with 1 registered patch, see perl -V for more detail&#41;
&gt; [...]
&gt; I&#39;ve got no zz_config.t. Where does it belong to? Perl or your module?
&gt; I&#39;m using Ubuntu packages.
</div>
zz_config.t is in the t directory for the module.

I ran your test here and did not get an arror &#40;perl 5.8.7 on linux too, 
unthreaded though&#41;.

Could you:

  - try with the latest version of XML::Twig, which can be found at
    <span class="clickylink"><a target="new" rel="nofollow" href="http://xmltwig.com/xmltwig/">http://xmltwig.com/xmltwig/</a></span> &#40;&#39;make test&#39; should give you
    configuration information&#41;

  - try without the fork to bzcat

Thanks

In the meantime I&#39;ll compile a threaded version of Perl and see if I can 
reproduce the problem.

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;13:07:52&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Feb 2006 19:07:03 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">mirod@xmltwig.com via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; In the meantime I&#39;ll compile a threaded version of Perl and see if I can 
&gt; reproduce the problem.
</div>
The threaded version &#40;v5.8.7 built for i686-linux-thread-multi&#41; still 
doesn&#39;t show the problem.

At this point, if the latest version does not solve your problem, I 
would try to rewrite the code by having the twig_roots on a single, 
englobing, element, and avoiding the many calls to purge.


-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;06&nbsp;14:58:57&nbsp;2006</span>
    <span class="description">Nikolaus [...] rath.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Mon, 06 Feb 2006 20:57:50 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nikolaus Rath &lt;Nikolaus [...] rath.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;mirod@xmltwig.com via RT&#34; &lt;bug-XML-Twig@rt.cpan.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open">&gt;&gt; [134] nokile:~/Work/perlbug$ perl -v
&gt;&gt; 
&gt;&gt; This is perl, v5.8.7 built for i486-linux-gnu-thread-multi
&gt;&gt; &#40;with 1 registered patch, see perl -V for more detail&#41;
&gt;&gt; [...]
&gt;&gt; I&#39;ve got no zz_config.t. Where does it belong to? Perl or your module?
&gt;&gt; I&#39;m using Ubuntu packages.
</div>&gt;
&gt; zz_config.t is in the t directory for the module.
&gt;
&gt; I ran your test here and did not get an arror &#40;perl 5.8.7 on linux too, 
&gt; unthreaded though&#41;.
&gt;
&gt; Could you:
&gt;
&gt;   - try with the latest version of XML::Twig, which can be found at
&gt;     <span class="clickylink"><a target="new" rel="nofollow" href="http://xmltwig.com/xmltwig/">http://xmltwig.com/xmltwig/</a></span> &#40;&#39;make test&#39; should give you
&gt;     configuration information&#41;
</div>

I tried to reinstall, but:

Failed Test         Stat Wstat Total Fail  Failed  List of Failed
--------------------------------------------------------------------------------------------------------
t/test_additional.t              647    2   0.31%  346 348
t/test_bugs_3.18.t               157   13   8.28%  11-23
t/test_bugs_3.19.t                26    6  23.08%  5-6 20-23
Failed 3/82 test scripts, 96.34% okay. 21/3795 subtests failed, 99.45% okay.
make: *** [test_dynamic] Error 255


Before that, I got a lot of UTF-8 encoding warnings, which allowed me
to narrow the problem: Both &#39;make test&#39; and my testcase work if I
unset PERL_UNICODE &#40;which is set to SDAL here, because it&#39;s a pure
UTF-8 system&#41;.

I hope this helps to pin down the problem.

Regards,

   --Nikolaus

-- 
Übermorgen bekommen sie mein endgültiges Vielleicht!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;02:04:48&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 08:03:38 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nikolaus Rath via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; I tried to reinstall, but:
&gt; 
&gt; Failed Test         Stat Wstat Total Fail  Failed  List of Failed
&gt; --------------------------------------------------------------------------------------------------------
&gt; t/test_additional.t              647    2   0.31%  346 348
&gt; t/test_bugs_3.18.t               157   13   8.28%  11-23
&gt; t/test_bugs_3.19.t                26    6  23.08%  5-6 20-23
&gt; Failed 3/82 test scripts, 96.34% okay. 21/3795 subtests failed, 99.45% okay.
&gt; make: *** [test_dynamic] Error 255
&gt; 
&gt; 
&gt; Before that, I got a lot of UTF-8 encoding warnings, which allowed me
&gt; to narrow the problem: Both &#39;make test&#39; and my testcase work if I
&gt; unset PERL_UNICODE &#40;which is set to SDAL here, because it&#39;s a pure
&gt; UTF-8 system&#41;.
&gt; 
&gt; I hope this helps to pin down the problem.
</div>
It does, nice job,

With PERL_UNICODE set to SDAL, I was able to reproduce the bug, and 
indeed to get the same error message you got.

It goes away if, instead of parsing a pipe from bzcat, I parse a regular 
XML file. It also works fine if you do the bzcat and pipe it to the 
code:  PERL_UNICODE=SDAL bzcat -c rt_17500.xml.bz2 | perl bug.pl
and parse \*STDIN in the code.

Stepping through the code with debugger it looks like actually the 
problem occurs before even reaching any XML::Twig specific code. It 
looks like it&#39;s a problem with IO::File ignoring PERL_UNICODE &#40;or -C&#41;. 
XML::Parser, on which XML::Twig is based, uses IO::File.

This is confirmed by this thread: 
<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html">http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html</a></span>

As the problem is due to the &#39;D&#39; option, telling perl to use the perlIO 
layer, the easiest workaround is to use the -CSAL option on the shebang 
line &#40;or on the command line&#41;.

As for the test failures: you end telling the system to read as unicode, 
files that are in iso-8859-1. I will have to take this case into account 
in the test &#40;baring in mind that XML::Twig should still work with very 
old versions of perl!&#41;.

So I will fix the tests and add a note about the PERL_UNICODE/-CD option 
in the docs &#40;and in the FAQ&#41;.

Does this solve the problem?

Thanks

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;04:10:01&nbsp;2006</span>
    <span class="description">Nikolaus [...] rath.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 10:01:04 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nikolaus Rath &lt;Nikolaus [...] rath.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;mirod@xmltwig.com via RT&#34; &lt;bug-XML-Twig@rt.cpan.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Stepping through the code with debugger it looks like actually the 
&gt; problem occurs before even reaching any XML::Twig specific code. It 
&gt; looks like it&#39;s a problem with IO::File ignoring PERL_UNICODE &#40;or -C&#41;. 
&gt; XML::Parser, on which XML::Twig is based, uses IO::File.
&gt;
&gt; This is confirmed by this thread: 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html">http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html</a></span>
</div>
You&#39;re absolutely right. Actually, I already stumbled over this bug
some time ago:

<span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Ticket/Display.html?id=38181">http://rt.perl.org/rt3/Ticket/Display.html?id=38181</a></span>

But in this case I somehow missed to see the connection. Thanks for
your help.

Regards,

   --Nikolaus

-- 
*Catholism*: If shit happend I deserve it. *Voodoo*: Shit will hapen to you.
*Ateism*: Shit happens, but I don&#39;t care anyway. *Judaism*: Why does shit
always happen to us? *Mormonism*: If shit happens we still got enough
women to clean it up. *Moslemism*: If shit happens take a hostage.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;05:25:14&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 11:24:08 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nikolaus Rath via RT wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; &lt;URL: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Ticket/Display.html?id=17500">http://rt.cpan.org/Ticket/Display.html?id=17500</a></span> &gt;
&gt; 
&gt; &#34;mirod@xmltwig.com via RT&#34; &lt;bug-XML-Twig@rt.cpan.org&gt; writes:
&gt; 
<div class="message-stanza open">&gt;&gt;Stepping through the code with debugger it looks like actually the 
&gt;&gt;problem occurs before even reaching any XML::Twig specific code. It 
&gt;&gt;looks like it&#39;s a problem with IO::File ignoring PERL_UNICODE &#40;or -C&#41;. 
&gt;&gt;XML::Parser, on which XML::Twig is based, uses IO::File.
&gt;&gt;
&gt;&gt;This is confirmed by this thread: 
&gt;&gt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html">http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html</a></span>
</div>&gt; 
&gt; 
&gt; You&#39;re absolutely right. Actually, I already stumbled over this bug
&gt; some time ago:
&gt; 
&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Ticket/Display.html?id=38181">http://rt.perl.org/rt3/Ticket/Display.html?id=38181</a></span>
&gt; 
&gt; But in this case I somehow missed to see the connection. Thanks for
&gt; your help.
</div>
I have a version of XML::Twig that traps this error and issues a nicer 
error message.

Now the problem remains that tests fail. More important, whether tests 
pass or fail, PERL_UNICODE and -C are user-level options, and once set, 
there doesn&#39;t seem to be anything I can do at XML::Twig level to reset 
the unicode flags to a value that would work.

At runtime, I think all I can do is raise an error if {^UNICODE} tells 
me that the UTF8 perIO layer is used and the XML encoding is not utf8.

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;06:28:54&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 12:27:39 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi,

OK, the development version should now trap this error, and pass the 
tests with PERL_UNICODE set to SDAL &#40;or to any other value hopefully!&#41;.

Let me know if it actually does ;--&#41;

Thanks

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;07:10:16&nbsp;2006</span>
    <span class="description">Nikolaus [...] rath.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 13:09:11 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Nikolaus Rath &lt;Nikolaus [...] rath.org&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">&#34;mirod@xmltwig.com via RT&#34; &lt;bug-XML-Twig@rt.cpan.org&gt; writes:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed"><div class="message-stanza open"><div class="message-stanza open">&gt;&gt;&gt;Stepping through the code with debugger it looks like actually the 
&gt;&gt;&gt;problem occurs before even reaching any XML::Twig specific code. It 
&gt;&gt;&gt;looks like it&#39;s a problem with IO::File ignoring PERL_UNICODE &#40;or -C&#41;. 
&gt;&gt;&gt;XML::Parser, on which XML::Twig is based, uses IO::File.
&gt;&gt;&gt;
&gt;&gt;&gt;This is confirmed by this thread: 
&gt;&gt;&gt;<span class="clickylink"><a target="new" rel="nofollow" href="http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html">http://www.mhonarc.org/archive/html/perl-unicode/2004-04/msg00004.html</a></span>
</div>&gt;&gt; 
&gt;&gt; 
&gt;&gt; You&#39;re absolutely right. Actually, I already stumbled over this bug
&gt;&gt; some time ago:
&gt;&gt; 
&gt;&gt; <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.perl.org/rt3/Ticket/Display.html?id=38181">http://rt.perl.org/rt3/Ticket/Display.html?id=38181</a></span>
&gt;&gt; 
&gt;&gt; But in this case I somehow missed to see the connection. Thanks for
&gt;&gt; your help.
</div>&gt;
&gt; I have a version of XML::Twig that traps this error and issues a
&gt; nicer error message.
&gt;
&gt; At runtime, I think all I can do is raise an error if {^UNICODE}
&gt; tells me that the UTF8 perIO layer is used and the XML encoding is
&gt; not utf8.
</div>
You need some quite sophisticated tests to do that properly, because:

[0] nokile:~$ locale
LANG=en_US.UTF-8
LC_CTYPE=de_DE.UTF-8
LC_NUMERIC=en_US.UTF-8
LC_TIME=de_DE.UTF-8
LC_COLLATE=de_DE.UTF-8
LC_MONETARY=de_DE.UTF-8
LC_MESSAGES=en_US.UTF-8
LC_PAPER=de_DE.UTF-8
LC_NAME=de_DE.UTF-8
LC_ADDRESS=de_DE.UTF-8
LC_TELEPHONE=de_DE.UTF-8
LC_MEASUREMENT=de_DE.UTF-8
LC_IDENTIFICATION=en_US.UTF-8
LC_ALL=
[0] nokile:~$ perl -e &#39;print &#34;${^UNICODE}\n&#34;;&#39;
127

and

[0] nokile:~$ unset LC_NUMERIC LC_COLLATE LC_MONETARY LC_MESSAGES LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT LC_IDENTIFICATION
[0] nokile:~$ locale
LANG=
LC_CTYPE=&#34;POSIX&#34;
LC_NUMERIC=&#34;POSIX&#34;
LC_TIME=&#34;POSIX&#34;
LC_COLLATE=&#34;POSIX&#34;
LC_MONETARY=&#34;POSIX&#34;
LC_MESSAGES=&#34;POSIX&#34;
LC_PAPER=&#34;POSIX&#34;
LC_NAME=&#34;POSIX&#34;
LC_ADDRESS=&#34;POSIX&#34;
LC_TELEPHONE=&#34;POSIX&#34;
LC_MEASUREMENT=&#34;POSIX&#34;
LC_IDENTIFICATION=&#34;POSIX&#34;
LC_ALL=
[0] nokile:~$ perl -e &#39;print &#34;${^UNICODE}\n&#34;;&#39;
127

so you have the check the locale yourself. Honestly, if I were you I
wouldn&#39;t try to implement any workarounds for this perl bug. It&#39;s hard
to do properly and the problem is already fixed in newer versions.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Now the problem remains that tests fail.
</div>
IMO this isn&#39;t a problem at all. I&#39;d just make the output nicer by
checking $^UNICODE and the perl version and aborting the test with a
warning if there&#39;s a problematic combination. The user will stumble
over other problems sooner or later anyway, so you&#39;re doing him a
favor by telling him that &#40;and what&#41; is wrong on his system.

Regards,


   --Nikolaus

-- 
Man gewöhnt sich an allem - sogar am Dativ.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Feb&nbsp;07&nbsp;07:34:11&nbsp;2006</span>
    <span class="description">mirod [...] xmltwig.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Re: [rt.cpan.org #17500] *** glibc detected *** double free or corruption &#40;!prev&#41;: 0x08d2b4d0 ***</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Tue, 07 Feb 2006 13:32:37 +0100</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> bug-XML-Twig [...] rt.cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Michel Rodriguez &lt;mirod [...] xmltwig.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nikolaus Rath via RT wrote:

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; You need some quite sophisticated tests to do that properly, because:
&gt; [...]
&gt; so you have the check the locale yourself. Honestly, if I were you I
&gt; wouldn&#39;t try to implement any workarounds for this perl bug. It&#39;s hard
&gt; to do properly and the problem is already fixed in newer versions.
</div>
Ok, it makes sense, and I don&#39;t know enough about the subject to get it 
right anyway.

<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; 
<div class="message-stanza open">&gt;&gt;Now the problem remains that tests fail.
</div>&gt; 
&gt; IMO this isn&#39;t a problem at all. I&#39;d just make the output nicer by
&gt; checking $^UNICODE and the perl version and aborting the test with a
&gt; warning if there&#39;s a problematic combination. The user will stumble
&gt; over other problems sooner or later anyway, so you&#39;re doing him a
&gt; favor by telling him that &#40;and what&#41; is wrong on his system.
</div>
That&#39;s what I did, I just skip the tests. In any case the problems are 
triggered by a runtime configuration for the user. Which cannot be 
tested at install time.

I&#39;ll stop here then.

Thanks for the help

-- 
Michel Rodriguez
Perl &#38;amp; XML
xmltwig.com
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;May&nbsp;15&nbsp;07:15:20&nbsp;2006</span>
    <span class="description">MIROD [...] cpan.org -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction other CustomField even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;May&nbsp;15&nbsp;07:15:21&nbsp;2006</span>
    <span class="description">MIROD [...] cpan.org -  Fixed in 3.24 added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
