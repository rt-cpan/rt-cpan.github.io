<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #20623 for Image-Size: &#34;substr outside of string&#34; under persistent environment</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="https://rt.cpan.org/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #20623 for Image-Size: &#34;substr outside of string&#34; under persistent environment</h1></div>


<div id="main-navigation"><ul id="app-nav" class="toplevel">
 <li id="li-search_dist"><a id="search_dist" class="menu-item " href="/Public/">Search Distributions</a></li>
 <li id="li-browse_dist"><a id="browse_dist" class="menu-item " href="/Public/Dist/Browse.html">Browse Distributions</a></li>
 <li id="li-about" class="has-children"><a id="about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About rt.cpan.org</a>
 <ul>
  <li id="li-about-usage"><a id="about-usage" class="menu-item " href="/NoAuth/RT/CPAN/Usage.html">How do Iâ€¦?</a></li>
  <li id="li-about-about"><a id="about-about" class="menu-item " href="/NoAuth/RT/CPAN/About.html">About</a></li>
 </ul>
 </li>
 <li id="li-preferences"><a id="preferences" class="menu-item ">Welcome <span class="current-user">anonymous guest</span>.</a></li>
 <li id="li-login"><a id="login" class="menu-item " href="/NoAuth/Logout.html">Login as another user</a></li>
</ul></div>
<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Active;Name=Image-Size">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Resolved;Name=Image-Size">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/Display.html?Status=Rejected;Name=Image-Size">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Bug/Report.html?Queue=Image-Size">Report a new bug</a></li>
</ul></div>
<div id="topactions"><form action="/Public/Search/Simple.html" id="simple-search">
  <input size="12" name="q" accesskey="0" class="field" value="" placeholder="Search..." />
</form>

<form action="/Public/Bug/Report.html" name="CreateTicketInQueue" id="CreateTicketInQueue" >
<input type="submit" class="button" value="New ticket in" />&nbsp;<label accesskey="9">
  <input name="Queue" size="25" placeholder="Module or distribution" value="" class="select-queue" data-autocomplete="Queues" data-autocomplete-autosubmit=1 data-autocomplete-params="right=CreateTicket" />

</label>

</form>

</div>
<div id="body">
<div id="announcement" style="padding: 1em; margin: 1em; border: solid black 1px; background: #eee">
<a href="https://log.perl.org/2020/12/rtcpanorg-sunset.html">rt.cpan.org will be shut down on March 1st, 2021.</a>
</div>

<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/Image-Size">Image-Size CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">20623</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Dist/Display.html?Queue=Image-Size">Image-Size</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
aver [...] pvk.org.ru

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
Important    </td>
  </tr>
  <tr id="CF-16738-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<ul>
<li>
2.992</li>
<li>
3.0</li>
</ul>
    </td>
  </tr>
  <tr id="CF-16739-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
3.0    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-attachments">
  <div class="titlebox ticket-info-attachments " id="">
  <div class="titlebox-title inverse">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dattachments\x2D\x2D\x2D\x2DQXR0YWNobWVudHM\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Attachments</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-attachments----QXR0YWNobWVudHM_---0">




all.t.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/239318/101192/all.t.patch">
Fri Sep 08 10:06:28 2006 (487b) by gerryster [...] gmail.com
</a>
</font></li>


<li><font size="-2">
<a href="/Ticket/Attachment/238986/100967/all.t.patch">
Thu Sep 07 15:27:24 2006 (487b) by gerryster [...] gmail.com
</a>
</font></li>
</ul>


Image-Size-3.0-swfmx.patch<br />
<ul>


<li><font size="-2">
<a href="/Ticket/Attachment/226208/93926/Image-Size-3.0-swfmx.patch">
Sat Jul 22 05:55:25 2006 (629b) by aver [...] pvk.org.ru
</a>
</font></li>
</ul>

    <hr class="clear" />
  </div>
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> &mdash; <a href="/Public/Bug/Display.html?ShowHeaders=1;id=20623">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-226208" href="/Public/Bug/Display.html?id=20623#txn-226208">#</a>      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;22&nbsp;05:55:25&nbsp;2006</span>
    <span class="description">aver [...] pvk.org.ru -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> &#34;substr outside of string&#34; under persistent environment</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/226208/93923/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/93923">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 760b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Use of Image::Size under persistent environment &#40;e.g. mod_perl&#41; causes
error &#34;substr outside of string at blib/lib/Image/Size.pm &#40;autosplit
into blib/lib/auto/Image/Size/swfmxsize.al&#41; line 1135.&#34;

This bug can be reproduced by running next command on many CWS files:

imgsize /dir/with/many/CWS/files/*.swf

But while all files processed separately - everything is ok &#40;but slow&#41;:

ls -1 /dir/with/many/CWS/files/*.swf | xargs -n1 imgsize

Attached patch solves this problem.

Details:

$ uname -mrs 
FreeBSD 6.1-PRERELEASE i386
$ perl -v
This is perl, v5.8.8 built for i386-freebsd-64int

and

$ uname -mrs
Linux 2.6.16c3-reiser4 i686
$ perl -v
This is perl, v5.8.4 built for i386-linux-thread-multi

$ perl -MImage::Size -e &#39;print $Image::Size::VERSION&#39;
3.0
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Image-Size-3.0-swfmx.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/226208/93926/Image-Size-3.0-swfmx.patch">Download Image-Size-3.0-swfmx.patch</a><br />
<span class="downloadcontenttype">text/x-diff 629b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">--- /usr/local/lib/perl5/site_perl/5.8.8/Image/Size.pm.orig	Fri Jul 21 19:16:39 2006
+++ /usr/local/lib/perl5/site_perl/5.8.8/Image/Size.pm	Fri Jul 21 23:27:22 2006
@@ -1128,7 +1128,9 @@
     my $ver = _bin2int&#40;unpack &#39;B8&#39;, substr&#40;$header, 3, 1&#41;&#41;;
 
     my &#40;$d, $status&#41; = Compress::Zlib::inflateInit&#40;&#41;;
-    $header = $d-&gt;inflate&#40;substr&#40;$header, 8, 1024&#41;&#41;;
+	my $buffer = substr&#40;$header, 8, 1024&#41;;
+    &#40;$header, $status&#41; = $d-&gt;inflate&#40;$buffer&#41;;
+	return &#40;undef, undef, &#39;SWC&#39;&#41; unless $status == Z_OK or $status == Z_STREAM_END;
 
     my $bs = unpack &#39;B133&#39;, substr&#40;$header, 0, 9&#41;;
     my $bits = _bin2int&#40;substr&#40;$bs, 0, 5&#41;&#41;;
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-238986" href="/Public/Bug/Display.html?id=20623#txn-238986">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;15:27:23&nbsp;2006</span>
    <span class="description">gerryster [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gerryster [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/238986/100964/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/100964">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 2.5k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem can be reproduced by issuing a second call to imgzise with a
compressed &#40;CWS&#41; file.  The &#34;under persistent environment&#34; part of this
bug can be explained by this fact.  Attached is a patch to t/all.t which
demonstrates this problem.  Note, I disabled caching because the problem
code is never executed for files when caching is set.  To get around the
problem in my environment I created my own version of sub swfmxsize. 
Here is my version:

# adapted from Image::Size::my_swfmxsize&#40;&#41; to work in isolation and solve
# bug: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=20623">http://rt.cpan.org/Public/Bug/Display.html?id=20623</a></span>
sub _my_swfmxsize
{
    my &#40;$image&#41; = @_;
    my $header = substr&#40;$$image, 0, 1058&#41;;

    my $ver = Image::Size::_bin2int&#40;unpack &#39;B8&#39;, substr&#40;$header, 3, 1&#41;&#41;;

    my &#40;$d, $status&#41; = Compress::Zlib::inflateInit&#40;&#41;;
    my $buffer = substr&#40;$header, 8, 1024&#41;;  # cannot pass substr to
inflate!!!
    &#40;$header, $status&#41; = $d-&gt;inflate&#40;$buffer&#41;;

    # we know this is a CWS, but zlib had a problem
    if &#40;$status != Z_OK &#38;&#38; $status != Z_STREAM_END&#41; {
            return &#40;undef, undef,
                &#39;Corrupt CWS, unable to decompress header: &#39; . $d-&gt;msg&#40;&#41;&#41;
    }

    my $bs = unpack &#39;B133&#39;, substr&#40;$header, 0, 9&#41;;
    my $bits = Image::Size::_bin2int&#40;substr&#40;$bs, 0, 5&#41;&#41;;
    my $x = int&#40;Image::Size::_bin2int&#40;substr&#40;$bs, 5+$bits, $bits&#41;&#41;/20&#41;;
    my $y = int&#40;Image::Size::_bin2int&#40;substr&#40;$bs, 5+$bits*3, $bits&#41;&#41;/20&#41;;

    return &#40;$x, $y, &#39;CWS&#39;&#41;;
}

Note that this version does not pass the substr call directly to
d-&gt;inflate.  This line causes the error:
substr outside of string at blib/lib/Image/Size.pm &#40;autosplit into
blib/lib/auto/Image/Size/swfmxsize.al&#41; line 1135.
Reading the substring perldoc page it says towards the end: 

    If the lvalue returned by substr is used after the EXPR is
    changed in any way, the behaviour may not be as expected and is
    subject to change.  This caveat includes code such as
    &#34;print&#40;substr&#40;$foo,$a,$b&#41;=$bar&#41;&#34; or &#34;&#40;sub-
    str&#40;$foo,$a,$b&#41;=$bar&#41;=$fud&#34; &#40;where $foo is changed via the sub-
    string assignment, and then the substr is used again&#41;, or where
    a substr&#40;&#41; is aliased via a &#34;foreach&#34; loop or passed as a
    parameter or a reference to it is taken and then the alias,
    parameter, or deref&#39;d reference either is used after the origi-
    nal EXPR has been changed or is assigned to and then used a
    second time.

So in this case since substr is being passed to a method it is being
used as an lvalue since arguments are passed into subroutines by
aliasing.   Since the behavior is unexpected your Perl version/OS
combination may produce different results.  I am using Perl &#34; v5.8.5
built for i686-linux&#34;.
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/238986/100967/all.t.patch">Download all.t.patch</a><br />
<span class="downloadcontenttype">text/x-diff 487b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">7c7
&lt; use Test::More tests =&gt; 17;
---
&gt; use Test::More tests =&gt; 20;
58,59c58,66
&lt; &#40;$x, $y, $id&#41; = imgsize&#40;&#34;${dir}8.swf&#34;&#41;;
&lt; ok&#40;&#40;$x == 280 &#38;&#38; $y == 140 &#38;&#38; $id eq &#39;CWS&#39;&#41;, &#39;Basic CWS format test&#39;&#41;;
---
&gt; # Tests two consecutive calls, first with cache on then with cache off
&gt; for&#40;1..2&#41; {
&gt;   for&#40;1..2&#41; {
&gt;     &#40;$x, $y, $id&#41; = imgsize&#40;&#34;${dir}8.swf&#34;&#41;;
&gt;     ok&#40;&#40;$x == 280 &#38;&#38; $y == 140 &#38;&#38; $id eq &#39;CWS&#39;&#41;, 
&gt;        &#39;Basic CWS format test, $NO_CACH = &#39; . $NO_CACHE&#41;;
&gt;   }
&gt;   $NO_CACHE=1;
&gt; }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-238987" href="/Public/Bug/Display.html?id=20623#txn-238987">#</a>      
    </span>
    <span class="date">Thu&nbsp;Sep&nbsp;07&nbsp;15:27:26&nbsp;2006</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-239318" href="/Public/Bug/Display.html?id=20623#txn-239318">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;10:06:27&nbsp;2006</span>
    <span class="description">gerryster [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gerryster [...] gmail.com</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="/Ticket/Attachment/239318/101189/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/101189">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 3.3k</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">The problem can be reproduced by issuing a second call to imgsize with a
compressed &#40;CWS&#41; file.  The &#34;under persistent environment&#34; part of this
bug can be explained by this fact.  Attached is a patch to t/all.t which
demonstrates this problem.  Note, I disabled caching because the problem
code is never executed for files when caching is set.  To get around the
problem in my environment I created my own version of sub swfmxsize. 
Here is my version:

# adapted from Image::Size::my_swfmxsize&#40;&#41; to work in isolation and solve
# bug: <span class="clickylink"><a target="new" rel="nofollow" href="http://rt.cpan.org/Public/Bug/Display.html?id=20623">http://rt.cpan.org/Public/Bug/Display.html?id=20623</a></span>
sub _my_swfmxsize
{
    my &#40;$image&#41; = @_;
    my $header = substr&#40;$$image, 0, 1058&#41;;

    my $ver = Image::Size::_bin2int&#40;unpack &#39;B8&#39;, substr&#40;$header, 3, 1&#41;&#41;;

    my &#40;$d, $status&#41; = Compress::Zlib::inflateInit&#40;&#41;;
    my $buffer = substr&#40;$header, 8, 1024&#41;;  # cannot pass substr to
inflate!!!
    &#40;$header, $status&#41; = $d-&gt;inflate&#40;$buffer&#41;;

    # we know this is a CWS, but zlib had a problem
    if &#40;$status != Z_OK &#38;&#38; $status != Z_STREAM_END&#41; {
            return &#40;undef, undef,
                &#39;Corrupt CWS, unable to decompress header: &#39; . $d-&gt;msg&#40;&#41;&#41;
    }

    my $bs = unpack &#39;B133&#39;, substr&#40;$header, 0, 9&#41;;
    my $bits = Image::Size::_bin2int&#40;substr&#40;$bs, 0, 5&#41;&#41;;
    my $x = int&#40;Image::Size::_bin2int&#40;substr&#40;$bs, 5+$bits, $bits&#41;&#41;/20&#41;;
    my $y = int&#40;Image::Size::_bin2int&#40;substr&#40;$bs, 5+$bits*3, $bits&#41;&#41;/20&#41;;

    return &#40;$x, $y, &#39;CWS&#39;&#41;;
}

Note that this version does not pass the substr call directly to
d-&gt;inflate&#40;&#41;.  This line causes the error:
substr outside of string at blib/lib/Image/Size.pm &#40;autosplit into
blib/lib/auto/Image/Size/swfmxsize.al&#41; line 1135.
Toward the end of the substr perldoc page it states:

    If the lvalue returned by substr is used after the EXPR is
    changed in any way, the behaviour may not be as expected and is
    subject to change.  This caveat includes code such as
    &#34;print&#40;substr&#40;$foo,$a,$b&#41;=$bar&#41;&#34; or &#34;&#40;sub-
    str&#40;$foo,$a,$b&#41;=$bar&#41;=$fud&#34; &#40;where $foo is changed via the sub-
    string assignment, and then the substr is used again&#41;, or where
    a substr&#40;&#41; is aliased via a &#34;foreach&#34; loop or passed as a
    parameter or a reference to it is taken and then the alias,
    parameter, or deref&#39;d reference either is used after the origi-
    nal EXPR has been changed or is assigned to and then used a
    second time.

So in this case since substr is being passed to a method it is being
used as an lvalue since arguments are passed into subroutines by
aliasing.  Since the behavior is unexpected your Perl version/OS
combination may produce different results.  I am using Perl &#34; v5.8.5
built for i686-linux&#34;.

Also, to illustrate the sub string issue in a more controlled
environment try running:

perl -e&#39;sub problem{}; problem&#40;substr&#40;&#34;asdf&#34;,5,6&#41;&#41;&#39;

On my system this dies &#40;has a return code of 255&#41; with the message
&#34;substr outside of string at -e line 1.&#34;  When I run this on a different
Perl &#40;version 5.005_03 built for sun4-solaris&#41; I get the same message
but only as a warning &#40;Perl returns with a 0&#41;.  Also the die or warning
only occurs when the offset is outside the bounds of the string.  This
example executes cleanly:

perl -e&#39;sub problem{}; problem&#40;substr&#40;&#34;asdf&#34;,4,5&#41;&#41;&#39;

And to demonstrate the point about the problem occurring only in the
context of a subroutine call, this also executes cleanly:
perl -e&#39;substr&#40;&#34;asdf&#34;,5,6&#41;&#39;

I hope this helps!
</div></div>
</div>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>
<div class="downloadattachment">
<a href="/Ticket/Attachment/239318/101192/all.t.patch">Download all.t.patch</a><br />
<span class="downloadcontenttype">text/x-diff 487b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">7c7
&lt; use Test::More tests =&gt; 17;
---
&gt; use Test::More tests =&gt; 20;
58,59c58,66
&lt; &#40;$x, $y, $id&#41; = imgsize&#40;&#34;${dir}8.swf&#34;&#41;;
&lt; ok&#40;&#40;$x == 280 &#38;&#38; $y == 140 &#38;&#38; $id eq &#39;CWS&#39;&#41;, &#39;Basic CWS format test&#39;&#41;;
---
&gt; # Tests two consecutive calls, first with cache on then with cache off
&gt; for&#40;1..2&#41; {
&gt;   for&#40;1..2&#41; {
&gt;     &#40;$x, $y, $id&#41; = imgsize&#40;&#34;${dir}8.swf&#34;&#41;;
&gt;     ok&#40;&#40;$x == 280 &#38;&#38; $y == 140 &#38;&#38; $id eq &#39;CWS&#39;&#41;, 
&gt;        &#39;Basic CWS format test, $NO_CACH = &#39; . $NO_CACHE&#41;;
&gt;   }
&gt;   $NO_CACHE=1;
&gt; }
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-239321" href="/Public/Bug/Display.html?id=20623#txn-239321">#</a>      
    </span>
    <span class="date">Fri&nbsp;Sep&nbsp;08&nbsp;10:08:56&nbsp;2006</span>
    <span class="description">gerryster [...] gmail.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> gerryster [...] gmail.com</td>
  </tr>
</table>
<div class="downloadattachment">
<a href="/Ticket/Attachment/239321/101195/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/101195">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 71b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">Oops!  Sorry about the double post, the bottom one is the complete one!
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-423614" href="/Public/Bug/Display.html?id=20623#txn-423614">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;18&nbsp;01:19:43&nbsp;2008</span>
    <span class="description">rjray [...] blackperl.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<div class="downloadattachment">
<a href="/Ticket/Attachment/423614/206989/">Download &#40;untitled&#41;</a> / <a href="/Ticket/Attachment/WithHeaders/206989">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 50b</span>
</div>
<div class="messagebody">
<div class="message-stanza plain-text-white-space">This was fixed in 3.1, forgot to close the ticket.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      <a name="txn-423616" href="/Public/Bug/Display.html?id=20623#txn-423616">#</a>      
    </span>
    <span class="date">Mon&nbsp;Feb&nbsp;18&nbsp;01:19:45&nbsp;2008</span>
    <span class="description">rjray [...] blackperl.com -  Status changed from &#39;open&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
<p id="sponsors">
  This service is sponsored and maintained by
  <a href="http://bestpractical.com">Best Practical Solutions</a> and runs on
  <a href="http://noc.perl.org">Perl.org</a> infrastructure.
</p>

<p id="contact-info">
  Please report any issues with rt.cpan.org to <a href="mailto:rt-cpan-admin@bestpractical.com">rt-cpan-admin@bestpractical.com</a>.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA\x2D937849\x2D12');
  ga('send', 'pageview');
</script>

<div id="footer">
  <p id="time"><span>Time to display: 0.623666</span></p>
  <p id="bpscredits"><span>&#187;&#124;&#171; RT 4.0.18 Copyright 1996-2013 <a href="http://www.bestpractical.com?rt=4.0.18">Best Practical Solutions, LLC</a>.
</span></p>
</div>
  </body>
</html>
