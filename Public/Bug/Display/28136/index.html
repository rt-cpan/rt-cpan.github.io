<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #28136 for POE: suggestion and patch: track filehandles by numeric address</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #28136 for POE: suggestion and patch: track filehandles by numeric address</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/POE/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/POE/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/POE/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/POE/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/POE">POE CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">28136</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">rejected</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/POE/Active/">POE</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
yshtil [...] cisco.com

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26342-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-26343-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    




  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Thu&nbsp;Jul&nbsp;12&nbsp;16:23:53&nbsp;2007</span>
    <span class="description">yshtil [...] cisco.com -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Suggested change in POE/Resource/FileHandles.pm</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value"> Thu, 12 Jul 2007 10:59:21 -0700</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value"> rcaputo [...] cpan.org</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> Yuri Shtil &lt;yshtil [...] cisco.com&gt;</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi Rocco,

I attached a suggested change to the file.
The reason is that the existing code keeps track of the file handles  
in hash keyed by  the  globs . The resultant key is a stringified  
reference like GLOB&#40;0x91615e4&#41;.
In my case I used POE::Component::Server::TCP to hook HTTP::Daemon on  
a connection. I blessed  the socket from the client wheel to  
HTTP::Daemon which is a subclass of Socket so everything worked fine.  
However when the connection and the session was gone, the socket was  
stuck because the object reference changed.

My change consists of using the object address as the key since it  
will not change when the object is re-blessed.

Please let me know if my solution is acceptable.

-- 
Yuri Shtil

--- POE/Resource/FileHandles.pm Thu Jul 12 10:40:13 2007
+++ POE_PATCHED/Resource/FileHandles.pm Thu Jul 12 10:37:57 2007
@@ -272,8 +272,17 @@ sub _data_handle_is_good {

  ### Add a select to the session, and possibly begin a watcher.

+sub _deglob {
+  my &#40;$h&#41; = @_;
+
+  $h =~ m!GLOB\&#40;&#40;[^&#41;]+&#41;!;
+  $1;
+}
+
  sub _data_handle_add {
    my &#40;$self, $handle, $mode, $session, $event&#41; = @_;
+  my $handleref = _deglob&#40;$handle&#41;;
+
    my $fd = fileno&#40;$handle&#41;;

    # First time watching the file descriptor.  Do some heavy setup.
@@ -366,7 +375,7 @@ sub _data_handle_add {
      # The session is also watching it by the same handle.  Treat this
      # as a &#34;resume&#34; in this mode.

-    if &#40;exists $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handle}&#41; {
+    if &#40;exists $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handleref}&#41; {
        if &#40;TRACE_FILES&#41; {
          _warn&#40;
            &#34;&lt;fh&gt; running fileno&#40;$fd&#41; mode&#40;$mode&#41; &#34; .
@@ -415,7 +424,7 @@ sub _data_handle_add {
    # the session/handle pair.

    else {
-    $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handle} =
+    $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handleref} =
        [ $handle,   # HSS_HANDLE
          $session,  # HSS_SESSION
          $event,    # HSS_STATE
@@ -438,8 +447,8 @@ sub _data_handle_add {
    # If the session hasn&#39;t already been watching the filehandle, then
    # register the filehandle in the session&#39;s structure.

-  unless &#40;exists $kr_ses_to_handle{$session}-&gt;{$handle}&#41; {
-    $kr_ses_to_handle{$session}-&gt;{$handle} =
+  unless &#40;exists $kr_ses_to_handle{$session}-&gt;{$handleref}&#41; {
+    $kr_ses_to_handle{$session}-&gt;{$handleref} =
        [ $handle,  # SH_HANDLE
          0,        # SH_REFCOUNT
          [ 0,      # SH_MODECOUNT / MODE_RD
@@ -453,7 +462,7 @@ sub _data_handle_add {
    # Modify the session&#39;s handle structure&#39;s reference counts, so the
    # session knows it has a reason to live.

-  my $ss_handle = $kr_ses_to_handle{$session}-&gt;{$handle};
+  my $ss_handle = $kr_ses_to_handle{$session}-&gt;{$handleref};
    unless &#40;$ss_handle-&gt;[SH_MODECOUNT]-&gt;[$mode]&#41; {
      $ss_handle-&gt;[SH_MODECOUNT]-&gt;[$mode]++;
      $ss_handle-&gt;[SH_REFCOUNT]++;
@@ -465,6 +474,8 @@ sub _data_handle_add {

  sub _data_handle_remove {
    my &#40;$self, $handle, $mode, $session&#41; = @_;
+  my $handleref = _deglob&#40;$handle&#41;;
+
    my $fd = fileno&#40;$handle&#41;;

    # Make sure the handle is deregistered with the kernel.
@@ -477,7 +488,7 @@ sub _data_handle_remove {

      if &#40;
        exists&#40;$kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}&#41; and
-      exists&#40;$kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handle}&#41;
+      exists&#40;$kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handleref}&#41;
      &#41; {

        TRACE_FILES and
@@ -486,7 +497,7 @@ sub _data_handle_remove {
        # Remove the handle from the kernel&#39;s session record.

        my $handle_rec =
-        delete $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handle};
+        delete $kr_fno_rec-&gt;[FMO_SESSIONS]-&gt;{$session}-&gt;{$handleref};

        my $kill_session = $handle_rec-&gt;[HSS_SESSION];
        my $kill_event   = $handle_rec-&gt;[HSS_STATE];
@@ -584,12 +595,12 @@ sub _data_handle_remove {

    if &#40;
      exists&#40;$kr_ses_to_handle{$session}&#41; and
-    exists&#40;$kr_ses_to_handle{$session}-&gt;{$handle}&#41;
+    exists&#40;$kr_ses_to_handle{$session}-&gt;{$handleref}&#41;
    &#41; {

      # Remove it from the session&#39;s read, write or expedite mode.

-    my $ss_handle = $kr_ses_to_handle{$session}-&gt;{$handle};
+    my $ss_handle = $kr_ses_to_handle{$session}-&gt;{$handleref};
      if &#40;$ss_handle-&gt;[SH_MODECOUNT]-&gt;[$mode]&#41; {

        # Hmm... what is this?  Was POE going to support multiple  
selects?
@@ -606,7 +617,7 @@ sub _data_handle_remove {
        }

        unless &#40;$ss_handle-&gt;[SH_REFCOUNT]&#41; {
-        delete $kr_ses_to_handle{$session}-&gt;{$handle};
+        delete $kr_ses_to_handle{$session}-&gt;{$handleref};
          $self-&gt;_data_ses_refcount_dec&#40;$session&#41;;
          delete $kr_ses_to_handle{$session}
            unless keys %{$kr_ses_to_handle{$session}};
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Set even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Jul&nbsp;21&nbsp;03:30:40&nbsp;2007</span>
    <span class="description">RCAPUTO [...] cpan.org -  Subject changed from &#39;Suggested change in POE/Resource/FileHandles.pm&#39; to &#39;suggestion and patch: track filehandles by numeric address&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;22&nbsp;01:51:23&nbsp;2007</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Hi, Yuri.  It just occurred to me that we might want to track
filehandles by fileno&#40;&#41; internally rather than GLOB string or object
address.  The object could change entirely, address and all, but the
fileno&#40;&#41; should remain constant.

What do you think?

-- Rocco

On Thu Jul 12 16:23:53 2007, yshtil@cisco.com wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Hi Rocco,
&gt; 
&gt; I attached a suggested change to the file.
&gt; The reason is that the existing code keeps track of the file handles  
&gt; in hash keyed by  the  globs . The resultant key is a stringified  
&gt; reference like GLOB&#40;0x91615e4&#41;.
&gt; In my case I used POE::Component::Server::TCP to hook HTTP::Daemon on  
&gt; a connection. I blessed  the socket from the client wheel to  
&gt; HTTP::Daemon which is a subclass of Socket so everything worked fine.  
&gt; However when the connection and the session was gone, the socket was  
&gt; stuck because the object reference changed.
&gt; 
&gt; My change consists of using the object address as the key since it  
&gt; will not change when the object is re-blessed.
&gt; 
&gt; Please let me know if my solution is acceptable.
&gt; 
</div></div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;22&nbsp;01:51:25&nbsp;2007</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sun&nbsp;Jul&nbsp;22&nbsp;13:45:06&nbsp;2007</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;10&nbsp;04:15:58&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">No followup from reporter.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;10&nbsp;04:15:59&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;stalled&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      <a id="lasttrans" name="lasttrans"></a>
    </span>
    <span class="date">Mon&nbsp;Mar&nbsp;10&nbsp;04:16:00&nbsp;2008</span>
    <span class="description">RCAPUTO [...] cpan.org -  Status changed from &#39;open&#39; to &#39;rejected&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
