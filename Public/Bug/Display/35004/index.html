<!DOCTYPE html>

<html lang="en">
  <head>
    <title>Bug #35004 for NTLM: Fails to authenticate against some IIS 6.x servers</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- The X-UA-Compatible <meta> tag above must be very early in <head> -->

    <script>
if (window.top !== window.self) {
    document.write = "";

    window.top.location = window.self.location;

    setTimeout(function(){
        document.body.innerHTML = "";
    }, 1);

    window.self.onload = function(){
        document.body.innerHTML = "";
    };
}
</script>



<link rel="shortcut icon" href="/NoAuth/images/favicon.png" type="image/png" />
<link rel="stylesheet" href="/NoAuth/css/aileron-squished-00f758259152f8b6670ee485f462e6b8.css" type="text/css" media="all" />
<link rel="stylesheet" href="/NoAuth/css/print.css" type="text/css" media="print" />




<script type="text/javascript" src="/NoAuth/js/squished-42167f2409ce368da2d31038e5cb2a57.js"></script>

<script type="text/javascript"><!--
	jQuery( loadTitleBoxStates );

--></script>


<!--[if lt IE 8]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie.css" type="text/css" media="all" />
<![endif]-->
<!--[if lt IE 7]>
<link rel="stylesheet" href="/NoAuth/css/aileron/msie6.css" type="text/css" media="all" />
<![endif]-->
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery.fn.supersubs.defaults = {
        maxWidth: 30,
        extraWidth: 2
    };

    jQuery("#app-nav.toplevel").addClass('sf-menu sf-js-enabled sf-shadow').supersubs().superfish({ speed: 'fast' });
    jQuery("#page-menu.toplevel").addClass('sf-menu sf-js-enabled').supersubs().superfish({ dropShadows: false, speed: 'fast' }).supposition();
});
</script>


<!-- Site CSS from theme editor -->
<style type="text/css" media="all" id="sitecss">
</style>

<meta name="google-site-verification" content="kD3-uEJK1AkTqaC-rckcSt_HPkAj674DPPuEN6i-y0g" />

</head>
  <body class="aileron sidebyside" id="comp-Public-Bug-Display">

<div id="logo">
<a href="/"><img
    src="/NoAuth/images/cpan.png"
    alt="CPAN"
    width="181"
    height="38" /></a>
    <span class="rtname">RT for rt.cpan.org</span>
</div>


<div id="quickbar">
  <div id="quick-personal">
    <span class="hide"><a href="#skipnav">Skip Menu</a> | </span>
</div>

</div>
<div id="header"><h1>Bug #35004 for NTLM: Fails to authenticate against some IIS 6.x servers</h1></div>



<div id="page-navigation"><ul id="page-menu" class="toplevel">
 <li id="li-page-active_bugs"><a id="page-active_bugs" class="menu-item " href="/Public/Dist/NTLM/Active/">Active bugs</a></li>
 <li id="li-page-resolved_bugs"><a id="page-resolved_bugs" class="menu-item " href="/Public/Dist/NTLM/Resolved/">Resolved bugs</a></li>
 <li id="li-page-rejected_bugs"><a id="page-rejected_bugs" class="menu-item " href="/Public/Dist/NTLM/Rejected/">Rejected bugs</a></li>
 <li id="li-page-report"><a id="page-report" class="menu-item " href="/Public/Dist/NTLM/Active/"></a></li>
</ul></div>
<div id="topactions">



</div>
<div id="body">


<a name="skipnav" id="skipnav" accesskey="8"></a>





<p>This queue is for tickets about the <a href="https://metacpan.org/release/NTLM">NTLM CPAN distribution</a>.</p>





<div class="">
  <div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DUmVwb3J0IGluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Report information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------UmVwb3J0IGluZm9ybWF0aW9u---0">


<table width="100%" class="ticket-summary">
<tr>
  <td valign="top" class="boxcontainer">
    <div class="ticket-info-basics">
  <div class="titlebox ticket-info-basics " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dbasics\x2D\x2D\x2D\x2DVGhlIEJhc2ljcw\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">The Basics</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-basics----VGhlIEJhc2ljcw__---0">


        <table>
  <tr class="id">
    <td class="label">Id:</td>
    <td class="value">35004</td>
  </tr>
  <tr class="status">
    <td class="label">Status:</td>
    <td class="value">resolved</td>
  </tr>
  <tr class="priority">
    <td class="label">Priority:</td>
    <td class="value">0/
</td>
  </tr>
  <tr class="queue">
    <td class="label">Queue:</td>
    <td class="value"><a href="/Public/Dist/NTLM/Active/">NTLM</a>
</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>


    <div class="ticket-info-people">
  <div class="titlebox ticket-info-people " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dpeople\x2D\x2D\x2D\x2DUGVvcGxl\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">People</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-people----UGVvcGxl---0">


        <table>
  <tr>
    <td class="label">Owner:</td>
    <td class="value">Nobody in particular
    
    </td>
  </tr>
  <tr>
    <td class="labeltop">Requestors:</td>
    <td class="value">
nigel.metheringham [...] Dev.intechnology.co.uk

<br />

</td>
  </tr>
  <tr>
    <td class="labeltop">Cc:</td>
    <td class="value">

</td>
  </tr>
  <tr>
    <td class="labeltop">AdminCc:</td>
    <td class="value">

</td>
  </tr>
</table>

        <hr class="clear" />
  </div>
</div>




</div>



  </td>
  <td valign="top" class="boxcontainer">
    
    <div class="ticket-info-cfs">
  <div class="titlebox ticket-info-cfs " id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2Dticket\x2Dinfo\x2Dcfs\x2D\x2D\x2D\x2DQnVnIEluZm9ybWF0aW9u\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">Bug Information</span>
    <span class="right-empty">		    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html--ticket-info-cfs----QnVnIEluZm9ybWF0aW9u---0">

 
        <table>
  <tr id="CF-1-ShowRow">
    <td class="label">Severity:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23754-ShowRow">
    <td class="label">Broken in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
  <tr id="CF-23755-ShowRow">
    <td class="label">Fixed in:</td>
    <td class="value">
<i>(no value)</i>
    </td>
  </tr>
</table>


        <hr class="clear" />
  </div>
</div>




</div>


    
</div>




</div>







  </td>
</tr>
</table>

    <hr class="clear" />
  </div>
</div>




</div>


<br />


<div class="history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FPublic\x5FBug\x5FDisplay\x5Fhtml\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">		<a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Public_Bug_Display_html------SGlzdG9yeQ__---0">


<div id="ticket-history">
<div class="ticket-transaction message Create odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Mon&nbsp;Apr&nbsp;14&nbsp;08:29:52&nbsp;2008</span>
    <span class="description">nigel.metheringham [...] Dev.intechnology.co.uk -  Ticket created</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Fails to authenticate against some IIS 6.x servers</td>
  </tr>
</table>
<div class="messageattachments">

<div class="messagebody">
<div class="message-stanza plain-text-white-space">As per bug #9521 the NTLM authentication mechanism can fail to work
against some IIS servers.

Although changes were made in version 1.03 authentication fails to
work against the servers I can test against here.  However the alternative
fix suggested in that ticket does work.

I have attached a patch which fixes the problem for me, although I cannot
tests against servers which did work with the previous mechanism.
</div></div>
</div>
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> NTLM-1.03-domain.patch</td>
  </tr>
</table>
<div class="messageattachments">
<div class="messagebody">
<div class="message-stanza plain-text-white-space">
</div></div>

<div class="messagebody">
<div class="message-stanza plain-text-white-space"># This is a patch for NTLM-1.03.orig to update it to NTLM-1.03
# 
# To apply this patch:
# STEP 1: Chdir to the source directory.
# STEP 2: Run the &#39;applypatch&#39; program with this patch file as input.
#
# If you do not have &#39;applypatch&#39;, it is part of the &#39;makepatch&#39; package
# that you can fetch from the Comprehensive Perl Archive Network:
# <span class="clickylink"><a target="new" rel="nofollow" href="http://www.perl.com/CPAN/authors/Johan_Vromans/makepatch-x.y.tar.gz">http://www.perl.com/CPAN/authors/Johan_Vromans/makepatch-x.y.tar.gz</a></span>
# In the above URL, &#39;x&#39; should be 2 or higher.
#
# To apply this patch without the use of &#39;applypatch&#39;:
# STEP 1: Chdir to the source directory.
# STEP 2: Run the &#39;patch&#39; program with this file as input.
#
#### End of Preamble ####

#### Patch data follows ####
diff -u &#39;NTLM-1.03.orig/NTLM.pm&#39; &#39;NTLM-1.03/NTLM.pm&#39;
Index: ./NTLM.pm
--- ./NTLM.pm	Mon Apr 14 11:58:47 2008
+++ ./NTLM.pm	Mon Apr 14 12:01:25 2008
@@ -174,7 +174,7 @@
     $challenge = decode_base64&#40;$challenge&#41;;
     $c_info = &#38;decode_challenge&#40;$challenge&#41;;
     $u_user = &#38;unicode&#40;$user&#41;;
-    $domain = substr&#40;$challenge, $c_info-&gt;{domain}{offset}, $c_info-&gt;{domain}{len}&#41;; 
+    $domain = &#38;unicode&#40;$domain&#41;; 
     $response = pack&#40;$msg3, $ident, 3&#41;;
     $lmResp = &#38;lmEncrypt&#40;$c_info-&gt;{data}&#41;;
     $ntResp = &#38;ntEncrypt&#40;$c_info-&gt;{data}&#41;;
diff -u &#39;NTLM-1.03.orig/t/ntlm.t&#39; &#39;NTLM-1.03/t/ntlm.t&#39;
Index: ./t/ntlm.t
--- ./t/ntlm.t	Mon Apr 14 11:58:47 2008
+++ ./t/ntlm.t	Mon Apr 14 12:29:02 2008
@@ -23,7 +23,7 @@
 my $passwd = &#34;test&#34;;
 my $msg1 = &#34;TlRMTVNTUAABAAAAB7IAAAQABAAgAAAABAAEACQAAAB0ZXN0dGVzdA==&#34;;
 my $challenge = &#34;TlRMTVNTUAACAAAABAAEADAAAAAFggEAQUJDREVGR0gAAAAAAAAAAAAAAAAAAAAAdGVzdA==&#34;;
-my $msg2 = &#34;TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAQABABwAAAACAAIAHQAAAAIAAgAfAAAAAAAAABEAAAABYIBAJ7/TlMo4HLg0gOk6iKq4bv2vk35ozHEKKoqG8nTkQ5S82zyqpJzxPDJHUMynnKsBHRlc3R0AGUAcwB0AHQAZQBzAHQA&#34;;
+my $msg2 = &#34;TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAgACABwAAAACAAIAHgAAAAIAAgAgAAAAAAAAABIAAAABYIBAJ7/TlMo4HLg0gOk6iKq4bv2vk35ozHEKKoqG8nTkQ5S82zyqpJzxPDJHUMynnKsBHQAZQBzAHQAdABlAHMAdAB0AGUAcwB0AA==&#34;;
 
 # 2: username
 
#### End of Patch data ####

#### ApplyPatch data follows ####
# Data version        : 1.0
# Date generated      : Mon Apr 14 12:29:27 2008
# Generated by        : makepatch 2.03
# Recurse directories : Yes
# Excluded files      : &#40;\A|/&#41;.*\~\Z
#                       &#40;\A|/&#41;.*\.a\Z
#                       &#40;\A|/&#41;.*\.bak\Z
#                       &#40;\A|/&#41;.*\.BAK\Z
#                       &#40;\A|/&#41;.*\.elc\Z
#                       &#40;\A|/&#41;.*\.exe\Z
#                       &#40;\A|/&#41;.*\.gz\Z
#                       &#40;\A|/&#41;.*\.ln\Z
#                       &#40;\A|/&#41;.*\.o\Z
#                       &#40;\A|/&#41;.*\.obj\Z
#                       &#40;\A|/&#41;.*\.olb\Z
#                       &#40;\A|/&#41;.*\.old\Z
#                       &#40;\A|/&#41;.*\.orig\Z
#                       &#40;\A|/&#41;.*\.rej\Z
#                       &#40;\A|/&#41;.*\.so\Z
#                       &#40;\A|/&#41;.*\.Z\Z
#                       &#40;\A|/&#41;\.del\-.*\Z
#                       &#40;\A|/&#41;\.make\.state\Z
#                       &#40;\A|/&#41;\.nse_depinfo\Z
#                       &#40;\A|/&#41;core\Z
#                       &#40;\A|/&#41;tags\Z
#                       &#40;\A|/&#41;TAGS\Z
# p &#39;NTLM.pm&#39; 7320 1208170885 0100744
# p &#39;t/ntlm.t&#39; 1973 1208172542 0100644
#### End of ApplyPatch data ####

#### End of Patch kit [created: Mon Apr 14 12:29:27 2008] ####
#### Patch checksum: 61 2595 36004 ####
#### Checksum: 79 3279 26798 ####
</div></div>
</div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;31&nbsp;11:40:22&nbsp;2008</span>
    <span class="description">BUZZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> BUZZ [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Please re-test this bug agains NTLM 1.04 &#40;as it adds NTLMv2 support&#41;,
and report it this is still a problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;May&nbsp;31&nbsp;11:40:25&nbsp;2008</span>
    <span class="description">The RT System itself -  Status changed from &#39;new&#39; to &#39;open&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;04:52:03&nbsp;2008</span>
    <span class="description">matt [...] bodgit-n-scarper.com -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat May 31 11:40:22 2008, BUZZ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please re-test this bug agains NTLM 1.04 &#40;as it adds NTLMv2 support&#41;,
&gt; and report it this is still a problem.
</div>
I was having issues authenticating against a sole IIS server and adding
this patch to 1.04 &#40;adjusted slightly for the new code&#41; fixed the issue
for me.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;05:52:23&nbsp;2008</span>
    <span class="description">nigel.metheringham [...] Dev.intechnology.co.uk -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value"> Unable to reproduce bug with 1.04 or 1.03</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> nigel.metheringham [...] Dev.intechnology.co.uk</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">On Sat May 31 11:40:22 2008, BUZZ wrote:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; Please re-test this bug agains NTLM 1.04 &#40;as it adds NTLMv2 support&#41;,
&gt; and report it this is still a problem.
</div>
I can&#39;t reproduce the problem against our IIS 6.0 server at present
when using NTLM 1.04.
However, when I downgraded to standard NTLM 1.03 &#40;ie not with the
patch I previously used&#41; it also authenticated correctly - which 
previously did not work.

Our MIS people say there have been no patches to the IIS server or
configuration changes to it in the meantime, although part of our
AD structure has changed.

At present I can&#39;t confirm or reject that the 1.04 changes have
addressed the problem.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;08:30:09&nbsp;2008</span>
    <span class="description">BUZZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      
<table>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value"> BUZZ [...] cpan.org</td>
  </tr>
</table>

<div class="messagebody">
<div class="message-stanza plain-text-white-space">MAT,
Can you please advise what version of IIS server you are using, and
please give details of the &#34;adjustment/s&#34; you made &#40;or supply the
modified .pm code so we can diff against it&#41;. 
Ta, Buzz.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction message Correspond odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;08:34:13&nbsp;2008</span>
    <span class="description">BUZZ [...] cpan.org -  Correspondence added</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
      

<div class="messagebody">
<div class="message-stanza plain-text-white-space">Nigel, thanks for the feedback... 

Re:
<span
    class="message-stanza-folder closed"
    onclick="fold_message_stanza(this, 'Show\x20quoted\x20text', 'Hide\x20quoted\x20text');">Show quoted text</span><br /><div class="message-stanza closed">&gt; At present I can&#39;t confirm or reject that the 1.04 changes have
&gt; addressed the problem.
</div>
As the original opener of this ticket, and since you can&#39;t currently
recreate the original reason for this proposed patch,  are you happy for
it to be closed off until such time as the problem re-occurs?

Buzz.
</div></div>
    </div>
</div>
</div>
<div class="ticket-transaction basics Status even">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Tue&nbsp;Jun&nbsp;03&nbsp;08:34:15&nbsp;2008</span>
    <span class="description">BUZZ [...] cpan.org -  Status changed from &#39;open&#39; to &#39;stalled&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
<div class="ticket-transaction basics Status odd">
<div class="ticket-transaction">
  <div class="metadata">
    <span class="type">
      &nbsp;      
    </span>
    <span class="date">Sat&nbsp;Aug&nbsp;30&nbsp;03:01:27&nbsp;2008</span>
    <span class="description">BUZZ [...] cpan.org -  Status changed from &#39;stalled&#39; to &#39;resolved&#39;</span>
    <span class="time-taken"></span>    <span class="actions hidden"></span>
  </div>
    <div class="content">
    </div>
</div>
</div>
</div>
    <hr class="clear" />
  </div>
</div>




</div>
 


  <hr class="clear" />
</div>
</body>
</html>
